Use case Name,Description,Log Source,MITRE Tactics,MITRE Technique,SPL
Windows TOR Client Execution,"The following analytic detects the execution of the TOR Browser and related TOR components on Windows endpoints by monitoring process creation activity. Adversaries and insider threats leverage TOR to anonymize command-and-control traffic, facilitate data exfiltration, and evade network monitoring and policy enforcement. While TOR can be used for legitimate research and privacy purposes, its presence on enterprise endpoints is often unusual and should be investigated to determine intent, scope, and any associated malicious behavior.",Windows Events,"Command And Control, Execution, Exfiltration","T1090, T1090.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes where
(
Processes.process_name = ""tor.exe""
OR
(
Processes.process_path = ""*\\BraveSoftware\\Brave-Browser*""
Processes.process_path = ""*\\tor-*""
)
)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_tor_client_execution_filter`"
Set Default PowerShell Execution Policy To Unrestricted or Bypass,"The following analytic detects changes to the PowerShell ExecutionPolicy in the registry to &quot;Unrestricted&quot; or &quot;Bypass.&quot; It leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry modifications under the path Software\Microsoft\Powershell\1\ShellIds\Microsoft.PowerShell. This activity is significant because setting the ExecutionPolicy to these values can allow the execution of potentially malicious scripts without restriction.",Windows Events,Execution,T1059.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=*Software\\Microsoft\\Powershell\\1\\ShellIds\\Microsoft.PowerShell* Registry.registry_value_name=ExecutionPolicy (Registry.registry_value_data=Unrestricted OR Registry.registry_value_data=Bypass)) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `set_default_powershell_execution_policy_to_unrestricted_or_bypass_filter`"
Headless Browser Usage,"The following analytic detects the usage of headless browsers within an organization. It identifies processes containing the &quot;--headless&quot; and &quot;--disable-gpu&quot; command line arguments, which are indicative of headless browsing. This detection leverages data from the Endpoint.Processes datamodel to identify such processes. Monitoring headless browser usage is significant as these tools can be exploited by adversaries for malicious activities like web scraping, automated testing, and undetected web interactions.",Windows Events,"Execution, Discovery, Defense Evasion","T1564.003, T1497","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"") (Processes.process=""*--headless*"" AND Processes.process=""*--disable-gpu*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `headless_browser_usage_filter`"
Linux Telnet Authentication Bypass,"Detects an authentication bypass in telnet tracked as CVE-2026-24061. An attacker can supply a specifically crafted USER environment variable (-f root) that is passed to /usr/bin/login. Because this input isn't sanitized an attacker can force the system to skip authentication and login directly as root.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.",Linux,"Execution, Defense Evasion",T1548,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""login"" Processes.parent_process_name = ""telnetd"" Processes.process = ""* -p *"" Processes.process = ""* -f root*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_telnet_authentication_bypass_filter`"
Windows Chromium Process Loaded Extension via Command-Line,"The following analytic detects instances where Google Chrome is started with the --load-extension command-line flag, which allows loading unpacked or non-standard extensions. This behavior can indicate attempts to bypass enterprise extension policies, install malicious extensions, or load potentially harmful browser components. Monitoring such activity helps identify unauthorized extension usage, potential malware persistence mechanisms, or policy violations that could compromise browser security.",Windows Events,"Collection, Persistence",T1185,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where
Processes.process_name = ""Chrome.exe""
Processes.process= ""*--load-extension*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_chromium_process_loaded_extension_via_command_line_filter`"
Internal Horizontal Port Scan NMAP Top 20,"This analytic identifies instances where an internal host has attempted to communicate with 250 or more destination IP addresses using on of the NMAP top 20 ports. Horizontal port scans from internal hosts can indicate reconnaissance or scanning activities, potentially signaling malicious intent or misconfiguration. By monitoring network traffic logs, this detection helps detect and respond to such behavior promptly, enhancing network security and preventing potential threats.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Discovery,T1046,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
dc(All_Traffic.dest_ip) as totalDestIPCount
values(All_Traffic.action) as action
values(All_Traffic.dest_zone) as dest_zone
values(All_Traffic.rule) as rule
values(All_Traffic.src_category) as src_category
values(All_Traffic.src_port) as src_port
values(All_Traffic.src_zone) as src_zone
from datamodel=Network_Traffic where
All_Traffic.src_ip IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4""
)
All_Traffic.dest_port IN (
21, 22, 23, 25, 53, 80, 110, 111,
135, 139, 143, 443, 445, 993, 995,
1723, 3306, 3389, 5900, 8080
)
by span=1h _time
All_Traffic.src_ip All_Traffic.dest_port
All_Traffic.transport
| `drop_dm_object_name(""All_Traffic"")`
| where totalDestIPCount>=250
| eval dest_port=transport + ""/"" + dest_port
| stats min(firstTime) as firstTime
max(lastTime) as lastTime
dc(dest_port) as num_ports_scanned
sum(totalDestIPCount) as totalDestIPCount
values(action) as action
values(dest_port) as dest_ports
values(dest_zone) as dest_zone
values(rule) as rule
values(src_category) as src_category
values(src_zone) as src_zone
by _time src_ip
| fields - _time
| `security_content_ctime(lastTime)`
| `security_content_ctime(firstTime)`
| `internal_horizontal_port_scan_nmap_top_20_filter`"
Internal Vertical Port Scan,"This analytic detects instances where an internal host attempts to communicate with over 500 ports on a single destination IP address. It includes filtering criteria to exclude applications performing scans over ephemeral port ranges, focusing on potential reconnaissance or scanning activities. Monitoring network traffic logs allows for timely detection and response to such behavior, enhancing network security by identifying and mitigating potential threats promptly.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Discovery,T1046,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
values(All_Traffic.action) as action
values(All_Traffic.src_category) as src_category
values(All_Traffic.dest_zone) as dest_zone
values(All_Traffic.src_zone) as src_zone
from datamodel=Network_Traffic where
All_Traffic.src_ip IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4""
)
by span=1s _time
All_Traffic.src_ip All_Traffic.dest_port
All_Traffic.dest_ip All_Traffic.transport
All_Traffic.rule
| `drop_dm_object_name(""All_Traffic"")`
| eval gtime=_time
| bin span=1h gtime
| stats min(_time) as _time
values(action) as action
dc(eval(if(dest_port<1024 AND transport=""tcp"",dest_port,null))) as privilegedDestTcpPortCount
dc(eval(if(transport=""tcp"",dest_port,null))) as totalDestTcpPortCount
dc(eval(if(dest_port<1024 AND transport=""udp"",dest_port,null))) as privilegedDestUdpPortCount
dc(eval(if(transport=""udp"",dest_port,null))) as totalDestUdpPortCount
values(src_category) as src_category
values(dest_zone) as dest_zone
values(src_zone) as src_zone
by src_ip dest_ip transport gtime
| eval totalDestPortCount=totalDestUdpPortCount+totalDestTcpPortCount,
privilegedDestPortCount=privilegedDestTcpPortCount+privilegedDestUdpPortCount
| where (totalDestPortCount>=500 AND privilegedDestPortCount>=20)
| fields - gtime
| `internal_vertical_port_scan_filter`"
Protocol or Port Mismatch,"The following analytic identifies network traffic where the higher layer protocol does not match the expected port, such as non-HTTP traffic on TCP port 80. It leverages data from network traffic inspection technologies like Bro or Palo Alto Networks firewalls. This activity is significant because it may indicate attempts to bypass firewall restrictions or conceal malicious communications.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Persistence, Exfiltration",T1048.003,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Network_Traffic where
(
All_Traffic.app=dns
NOT All_Traffic.dest_port IN (53)
)
OR
(
All_Traffic.app IN (web-browsing, http)
NOT All_Traffic.dest_port IN (80, 8000, 8080)
)
OR
(
All_Traffic.app=ssl
NOT All_Traffic.dest_port IN (443, 465, 993, 8443)
)
OR
(
All_Traffic.app=smtp
NOT All_Traffic.dest_port IN (25, 587, 2525)
)
by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.app,
All_Traffic.dest_port All_Traffic.transport
All_Traffic.action All_Traffic.rule
|`security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `drop_dm_object_name(""All_Traffic"")`
| `protocol_or_port_mismatch_filter`"
Windows Abused Web Services,"The following analytic detects a suspicious process making DNS queries to known, abused web services such as text-paste sites, VoIP, secure tunneling, instant messaging, and digital distribution platforms. This detection leverages Sysmon logs with Event ID 22, focusing on specific query names. This activity is significant as it may indicate an adversary attempting to download malicious files, a common initial access technique.",Windows Events,"Initial Access, Execution, Command And Control, Exfiltration",T1102,"`sysmon` EventCode=22 QueryName IN (""*pastebin*"",""*textbin*"", ""*ngrok.io*"", ""*discord*"", ""*duckdns.org*"", ""*pasteio.com*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_abused_web_services_filter`"
Detect Outlook exe writing a zip file,"The following analytic identifies the execution of outlook.exe writing a .zip file to the disk. It leverages data from the Endpoint data model, specifically monitoring process and filesystem activities. This behavior can be significant as it may indicate the use of Outlook to deliver malicious payloads or exfiltrate data via compressed files. If confirmed malicious, this activity could lead to unauthorized data access, data exfiltration, or the delivery of malware, potentially compromising the security of the affected system and network.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"| tstats `security_content_summariesonly`
min(_time) as firstTime
max(_time) as lastTime
FROM datamodel=Endpoint.Processes where
Processes.process_name=outlook.exe
by _time span=5m
Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename process_guid as malicious_id
| rename parent_process_id as outlook_id
| join malicious_id type=inner
[
| tstats `security_content_summariesonly`
count values(Filesystem.file_path) as file_path
values(Filesystem.file_name) as file_name
FROM datamodel=Endpoint.Filesystem where
Filesystem.file_path=*.zip
Filesystem.file_path IN (""*:\\Users*"", ""*\\AppData\\Local\\Temp*"")
Filesystem.action=created
by _time span=5m
Filesystem.process_guid Filesystem.process_id
Filesystem.file_hash Filesystem.dest Filesystem.dvc
Filesystem.signature Filesystem.signature_id
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename process_guid as malicious_id
| fields malicious_id outlook_id dest
file_path file_name
file_hash count file_id
]
| table firstTime lastTime user malicious_id outlook_id
process_name parent_process_name file_name file_path
dest action original_file_name parent_process
parent_process_name parent_process_exec parent_process_guid
parent_process_id parent_process_path process_exec
process_guid process_hash process_id process_integrity_level
process_name process_path user user_id vendor_product
| where file_name != """"
| `detect_outlook_exe_writing_a_zip_file_filter`"
Process Creating LNK file in Suspicious Location,The following analytic detects a process creating a .lnk file in suspicious locations such as C:\User* or *\Local\Temp\*. It leverages filesystem and process activity data from the Endpoint data model to identify this behavior. This activity can be significant because creating .lnk files in these directories is a common indicator of spear phishing tools to establish persistence or execute malicious payloads.,Windows Events,"Initial Access, Persistence","T1566, T1566.002","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
FROM datamodel=Endpoint.Filesystem where
Filesystem.action=""created""
Filesystem.file_name=""*.lnk""
Filesystem.file_path IN (
""*:\\AppData\\Local\\Temp\\*"",
""*:\\Temp\\*"",
""*:\\Users\\*"",
""*:\\Windows\\Temp\\*""
)
NOT Filesystem.file_path IN (
""*\\AppData\\Local\\Microsoft\\Windows\\WinX\\*"",
""*\\AppData\\Roaming\\Microsoft\\Excel\\*"",
""*\\AppData\\Roaming\\Microsoft\\Internet Explorer\\Quick Launch\\*"",
""*\\AppData\\Roaming\\Microsoft\\Office\\Recent\\*"",
""*\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\*"",
""*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\*"",
""*\\AppData\\Roaming\\Microsoft\\Word\\*"",
""*\\Links\\*"",
""*\\OneDrive *""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `process_creating_lnk_file_in_suspicious_location_filter`"
Windows Chromium Browser Launched with Small Window Size,"The following analytic detects instances where a Chromium-based browser process, including Chrome, Edge, Brave, Opera, or Vivaldi, is launched with an unusually small window size, typically less than 100 pixels in width or height. Such configurations render the browser effectively invisible to the user and are uncommon in normal user activity. When observed on endpoints, especially in combination with automation, off-screen positioning, or suppression flags, this behavior may indicate attempts to execute web content or automated actions stealthily, bypassing user interaction and security controls.",Windows Events,Defense Evasion,T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes 
where Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--window-size*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| rex field=Processes.process ""--window-size=(?<window_width>\d+)\s*,\s*(?<window_height>\d+)""
| eval window_width=tonumber(window_width), window_height=tonumber(window_height)
| where window_height < 100 AND window_width < 100
| `drop_dm_object_name(Processes)`
| fields * window_width window_height
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_chromium_browser_launched_with_small_window_size_filter`"
Windows Chromium process Launched with Disable Popup Blocking,"The following analytic detects instances where a Windows Chromium-based browser process is launched with the --disable-popup-blocking flag. This flag is typically used to bypass the browserâ€™s built-in pop-up protections, allowing automatic execution of pop-ups or redirects without user interaction. While legitimate in some testing or automation scenarios, its presence on endpoints, particularly when combined with other automation or concealment flags, may indicate attempts by malicious actors to execute web-based content stealthily or evade user interaction controls, representing a potential security risk that warrants investigation.",Windows Events,"Execution, Defense Evasion",T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes 
where Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--disable-popup-blocking*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_chromium_process_launched_with_disable_popup_blocking_filter`"
Windows Chromium Process Launched with Logging Disabled,"The following analytic detects instances of Chromium-based browser processes on Windows launched with logging disabled via command-line arguments such as --disable-logging and --disable-logging-redirect. The --disable-logging flag forces browser logging to be disabled, while --disable-logging-redirect disables log redirection and is commonly used for testing or debugging scenarios. Logging is enabled by default in Chromium debug builds, making these flags more likely to appear in debug or development environments.",Windows Events,"Execution, Defense Evasion",T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes 
where Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--disable-logging*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_chromium_process_launched_with_logging_disabled_filter`"
Windows Chromium Process with Disabled Extensions,"The following analytic detects instances of Chromium-based browser processes on Windows launched with extensions explicitly disabled via command-line arguments. Disabling extensions can be used by automation frameworks, testing tools, or headless browser activity, but may also indicate defense evasion or abuse of browser functionality by malicious scripts or malware. This behavior reduces browser visibility and bypasses user-installed security extensions, making it relevant for detecting non-interactive execution, suspicious automation, or living-off-the-land techniques.",Windows Events,"Execution, Defense Evasion",T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes 
where Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--disable-extensions*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_chromium_process_with_disabled_extensions_filter`"
Windows Registry Delete Task SD,"The following analytic detects a process attempting to delete a scheduled task's Security Descriptor (SD) from the registry path of that task. It leverages the Endpoint.Registry data model to identify registry actions performed by the SYSTEM user, specifically targeting deletions of the SD value. This activity is significant as it may indicate an attempt to remove evidence of a scheduled task for defense evasion.",Windows Events,"Execution, Persistence, Defense Evasion","T1053.005, T1562","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
FROM datamodel=Endpoint.Registry where
Registry.registry_path IN (""*\\Schedule\\TaskCache\\Tree\\*"")
Registry.user=""SYSTEM""
(
Registry.registry_value_name=""SD""
OR
Registry.registry_key_name=""SD""
)
Registry.action=deleted
by Registry.action Registry.dest Registry.process_guid
Registry.process_id Registry.registry_hive
Registry.registry_path Registry.registry_key_name
Registry.registry_value_data Registry.registry_value_name
Registry.registry_value_type Registry.status Registry.user
Registry.vendor_product
| `drop_dm_object_name(Registry)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_registry_delete_task_sd_filter`"
PaperCut NG Remote Web Access Attempt,"The following analytic detects potential exploitation attempts on publicly accessible PaperCut NG servers. It identifies connections from public IP addresses to the server, specifically monitoring URI paths commonly used in proof-of-concept scripts for exploiting PaperCut NG vulnerabilities. This detection leverages web traffic data from the Web datamodel, focusing on specific URI paths and excluding internal IP ranges.",Zscaler Proxy,Initial Access,"T1190, T1133","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Web WHERE
Web.url IN (
""/app?service=direct/1/PrinterDetails/printerOptionsTab.tab""
""/app?service=direct/1/PrinterList/selectPrinter&sp=*"",
""/app?service=page/PrinterList"",
""/app?service=page/SetupCompleted""
)
NOT src IN (
""10.0.0.0/8"",
""172.16.0.0/12"",
""192.168.0.0/16"",
""100.64.0.0/10"",
""127.0.0.0/8"",
""169.254.0.0/16"",
""192.0.0.0/24"",
""192.0.0.0/29"",
""192.0.0.8/32"",
""192.0.0.9/32"",
""192.0.0.10/32"",
""192.0.0.170/32"",
""192.0.0.171/32"",
""192.0.2.0/24"",
""192.31.196.0/24"",
""192.52.193.0/24"",
""192.88.99.0/24"",
""224.0.0.0/4"",
""192.175.48.0/24"",
""198.18.0.0/15"",
""198.51.100.0/24"",
""203.0.113.0/24"",
""240.0.0.0/4"",
""::1""
)
by Web.http_user_agent Web.http_method
Web.url,Web.url_length Web.src
Web.dest Web.dest_port
| `drop_dm_object_name(""Web"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `papercut_ng_remote_web_access_attempt_filter`"
Risk Rule for Dev Sec Ops by Repository,"The following analytic identifies high-risk activities within repositories by correlating repository data with risk scores. It leverages findings and intermediate findings created by detections from the Dev Sec Ops analytic stories, summing risk scores and capturing source and user information. The detection focuses on high-risk scores above 100 and sources with more than three occurrences.",Splunk Risk Rule (Multiple Sources),Execution,T1204.003,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as sum_risk_score, values(All_Risk.annotations.mitre_attack.mitre_tactic) as annotations.mitre_attack.mitre_tactic, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Dev Sec Ops"" All_Risk.risk_object_type = ""other"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count > 3 and sum_risk_score > 100 
| `risk_rule_for_dev_sec_ops_by_repository_filter`"
Detect PsExec With accepteula Flag,"The following analytic identifies the execution of PsExec.exe with the accepteula flag in the command line. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant because PsExec is commonly used by threat actors to execute code on remote systems, and the accepteula flag indicates first-time usage, which could signify initial compromise.",Windows Events,"Lateral Movement, Execution",T1021.002,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ( Processes.process_name IN (""psexec.exe"", ""psexec64.exe"") OR Processes.original_file_name=""psexec.c"" ) Processes.process=*accepteula* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_psexec_with_accepteula_flag_filter`"
Windows Event Triggered Image File Execution Options Injection,"The following analytic identifies the creation or modification of Image File Execution Options (IFEO) registry keys, detected via EventCode 3000 in the Application channel. This detection leverages Windows Event Logs to monitor for process names added to IFEO under specific registry paths. This activity is significant as it can indicate attempts to set traps for process monitoring or debugging, often used by attackers for persistence or evasion.",Windows Events,"Execution, Persistence",T1546.012,"`wineventlog_application` EventCode=3000 
| rename param1 AS ""Process"" param2 AS ""Exit_Code"" 
| stats count min(_time) as firstTime max(_time) as lastTime by Process Exit_Code dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_event_triggered_image_file_execution_options_injection_filter`"
Cisco Privileged Account Creation with HTTP Command Execution,This analytic correlates risk events between privileged account creation on Cisco IOS devices and HTTP requests to privileged execution paths such as /level/15/exec/-/*. APT actors have been observed creating privileged accounts and then running commands on routers via HTTP GET or POST requests that target privileged execution paths. These requests allow attackers to execute commands with the highest privilege level (15) on Cisco devices without requiring interactive SSH access.,Cisco IOS,"Lateral Movement, Execution, Persistence, Defense Evasion","T1136, T1078, T1021.004","| tstats `security_content_summariesonly`
min(_time) as firstTime
max(_time) as lastTime
sum(All_Risk.calculated_risk_score) as risk_score
count(All_Risk.calculated_risk_score) as risk_event_count
values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id
dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count
values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id
dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count
values(All_Risk.tag) as tag
values(source) as source
dc(source) as source_count
values(contributing_events_search)
values(All_Risk.threat_object)
from datamodel=Risk.All_Risk where
source IN (
""*Cisco IOS Suspicious Privileged Account Creation*"",
""*Cisco Secure Firewall - Privileged Command Execution via HTTP*""
)
by All_Risk.normalized_risk_object
| `drop_dm_object_name(All_Risk)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| where source_count >= 2
| `cisco_privileged_account_creation_with_http_command_execution_filter`"
Cisco Privileged Account Creation with Suspicious SSH Activity,This analytic detects a correlation between privileged account creation on Cisco IOS devices and subsequent inbound SSH connections to non-standard ports or sshd_operns by correlating risk events This correlation identifies when both &quot;Cisco IOS Suspicious Privileged Account Creation&quot; and SSH-related Snort detections (&quot;SSH Connection to sshd_operns&quot; or &quot;SSH Connection to Non-Standard Port&quot;) fire for the same network device.,Cisco IOS,"Lateral Movement, Execution, Persistence, Defense Evasion","T1136, T1078, T1021.004","| tstats `security_content_summariesonly`
min(_time) as firstTime
max(_time) as lastTime
sum(All_Risk.calculated_risk_score) as risk_score
count(All_Risk.calculated_risk_score) as risk_event_count
values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id
dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count
values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id
dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count
values(All_Risk.tag) as tag
values(source) as source
dc(source) as source_count
values(contributing_events_search)
values(All_Risk.threat_object)
from datamodel=Risk.All_Risk where
source IN (
""*Cisco IOS Suspicious Privileged Account Creation*"",
""*Cisco Secure Firewall - SSH Connection to sshd_operns*"",
""*Cisco Secure Firewall - SSH Connection to Non-Standard Port*""
)
by All_Risk.normalized_risk_object
| `drop_dm_object_name(All_Risk)`
| eval has_account_creation=if(
match(source, ""Cisco IOS Suspicious Privileged Account Creation""),
1, 0
)
| eval has_ssh_detection=if(
match(source, ""SSH Connection to sshd_operns"")
OR
match(source, ""SSH Connection to Non-Standard Port""),
1, 0
)
| where has_account_creation=1
AND
has_ssh_detection=1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_privileged_account_creation_with_suspicious_ssh_activity_filter`"
Detect hosts connecting to dynamic domain providers,"The following analytic identifies DNS queries from internal hosts to dynamic domain providers. It leverages DNS query logs from the Network_Resolution data model and cross-references them with a lookup file containing known dynamic DNS providers. This activity is significant because attackers often use dynamic DNS services to host malicious payloads or command-and-control servers, making it crucial for security teams to monitor.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Initial Access, Command And Control",T1189,"| tstats `security_content_summariesonly` count min(_time) as firstTime
from datamodel=Network_Resolution where
DNS.query=*
NOT DNS.query IN (""-"", ""unknown"")
by DNS.answer DNS.answer_count DNS.query DNS.query_count
DNS.reply_code_id DNS.src DNS.vendor_product
| `drop_dm_object_name(""DNS"")`
| `security_content_ctime(firstTime)`
| lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default
| lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local
| eval isDynDNS = coalesce(isDynDNS_local,isDynDNS_default)
|fields - isDynDNS_default, isDynDNS_local
| search isDynDNS=True
| `detect_hosts_connecting_to_dynamic_domain_providers_filter`"
DNS Query Length Outliers - MLTK,The following analytic identifies DNS requests with unusually large query lengths for the record type being requested.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration",T1071.004,"| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution by DNS.query DNS.record_type 
| search DNS.record_type=* 
|  `drop_dm_object_name(DNS)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval query_length = len(query) 
| apply dns_query_pdfmodel threshold=0.01 
| rename ""IsOutlier(query_length)"" as isOutlier 
| search isOutlier > 0 
| sort -query_length 
| table start_time end_time query record_type count src dest query_length 
| `dns_query_length_outliers___mltk_filter`"
DNS Query Length With High Standard Deviation,"The following analytic identifies DNS queries with unusually large lengths by computing the standard deviation of query lengths and filtering those exceeding two times the standard deviation. It leverages DNS query data from the Network_Resolution data model, focusing on the length of the domain names being resolved. This activity is significant as unusually long DNS queries can indicate data exfiltration or command-and-control communication attempts.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration",T1048.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution where NOT DNS.record_type IN (""Pointer"",""PTR"",""SOA"", ""SRV"") DNS.query != *. by DNS.answer DNS.answer_count DNS.query DNS.query_count DNS.reply_code_id DNS.src DNS.vendor_product DNS.dest DNS.record_type 
| `drop_dm_object_name(""DNS"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval tlds=split(query,""."") 
| eval tld=mvindex(tlds,-1) 
| eval tld_len=len(tld) 
| search tld_len<=20 
| eval query_length = len(query) 
| table firstTime lastTime src dest query query_length record_type count record_type 
| eventstats stdev(query_length) AS stdev avg(query_length) AS avg p50(query_length) AS p50 
| where query_length>(avg+stdev*2) 
| eval z_score=(query_length-avg)/stdev 
| stats count values(query) as query values(dest) as dest avg(query_length) as avg_query_length values(record_type) as record_type min(firstTime) as firstTime latest(lastTime) as lastTime by src 
| `dns_query_length_with_high_standard_deviation_filter`"
SMB Traffic Spike - MLTK,The following analytic identifies spikes in the number of Server Message Block (SMB) connections using the Machine Learning Toolkit (MLTK).,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Lateral Movement, Execution, Exfiltration",T1021.002,"| tstats `security_content_summariesonly` count values(All_Traffic.dest_ip) as dest values(All_Traffic.dest_port) as port from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src 
| eval HourOfDay=strftime(_time, ""%H"") 
| eval DayOfWeek=strftime(_time, ""%A"") 
| `drop_dm_object_name(All_Traffic)` 
| apply smb_pdfmodel threshold=0.001 
| rename ""IsOutlier(count)"" as isOutlier 
| search isOutlier > 0 
| sort -count 
| table _time src dest port count 
| `smb_traffic_spike___mltk_filter`"
Services LOLBAS Execution Process Spawn,"The following analytic identifies services.exe spawning a LOLBAS (Living Off the Land Binaries and Scripts) execution process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where services.exe is the parent process. This activity is significant because adversaries often abuse the Service Control Manager to execute malicious code via native Windows binaries, facilitating lateral movement.",Windows Events,"Lateral Movement, Execution, Persistence","T1543.003, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=services.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Dllhost.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Mmc.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Rundll32.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Explorer.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `services_lolbas_execution_process_spawn_filter`"
Cisco Secure Firewall - Binary File Type Download,"The following analytic detects file downloads involving executable, archive, or scripting-related file types that are commonly used in malware delivery. These file types include formats like PE executables, shell scripts, autorun files, installers, and known testing samples such as EICAR. This detection leverages Cisco Secure Firewall Threat Defense logs and enriches the results using a filetype lookup to provide context.",Cisco FTD,Execution,"T1059, T1203","`cisco_secure_firewall` EventType=FileEvent FileDirection=""Download"" 
FileType IN (""ISHIELD_MSI"", ""BINHEX"", ""BINARY_DATA"", ""ELF"", ""MACHO"", ""JARPACK"", ""TORRENT"", ""AUTORUN"", ""EICAR"", ""LNK"", ""SCR"", ""UNIX_SCRIPT"")
| lookup cisco_secure_firewall_filetype_lookup Name as FileType OUTPUT Description
| stats count min(_time) as firstTime max(_time) as lastTime
values(uri) as uri
values(ClientApplication) as ClientApplication
values(file_hash) as file_hash
values(SHA_Disposition) as SHA_Disposition
by FileDirection FileType src dest app file_name ThreatName dest_port Description
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table firstTime lastTime src dest dest_port FileDirection FileType Description uri file_name file_hash app ClientApplication SHA_Disposition ThreatName
| `cisco_secure_firewall___binary_file_type_download_filter`"
Cisco Secure Firewall - Bits Network Activity,"The following analytic detects the use of the Background Intelligent Transfer Service (BITS) client application in allowed outbound connections. It leverages logs from Cisco Secure Firewall Threat Defense devices and identifies instances where BITS is used to initiate downloads from non-standard or unexpected domains. While BITS is a legitimate Windows service used for downloading updates, it is also commonly abused by adversaries to stealthily retrieve payloads or tools.",Cisco FTD,Command And Control,,"`cisco_secure_firewall` EventType=ConnectionEvent action IN (""Trust"", ""Allow"", ""allowed"") ClientApplication=""BITS"" AND NOT url IN (""*://msedge.b.tlu.dl*"")
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, dest_port, transport, rule, url, EVE_Process, ClientApplication, ClientApplicationVersion, action
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_secure_firewall___bits_network_activity_filter`"
Cisco Secure Firewall - Blacklisted SSL Certificate Fingerprint,"The following analytic detects the use of known suspicious SSL certificates in any observed event where the SSL_CertFingerprint field is present. It leverages Cisco Secure Firewall logs and compares the SSL certificate SHA1 fingerprint against a blacklist of certificates associated with malware distribution, command and control (C2) infrastructure, or phishing campaigns. This activity is significant as adversaries often reuse or self-sign certificates across malicious infrastructure, allowing defenders to track and detect encrypted sessions even when domains or IPs change.",Cisco FTD,"Command And Control, Exfiltration","T1071.001, T1588.004, T1573.002, T1587.002","`cisco_secure_firewall` EventType=* SSL_CertFingerprint=*
| lookup sslbl_ssl_certificate_blacklist SHA1 as SSL_CertFingerprint OUTPUT Listingdate, Listingreason
| where isnotnull(Listingreason)
| stats min(_time) as firstTime max(_time) as lastTime
values(dest) as dest
values(dest_port) as dest_port
values(rule) as rule
values(url) as url
values(Listingreason) as Reasons
values(Listingdate) as ""SSL Cert Listing Dates""
count by SSL_CertFingerprint src transport action
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___blacklisted_ssl_certificate_fingerprint_filter`"
Cisco Secure Firewall - Blocked Connection,"The following analytic detects a blocked connection event by identifying a &quot;Block&quot; value in the action field. It leverages logs from Cisco Secure Firewall Threat Defense devices. This activity is significant as it can identify attempts from users or applications initiating network connection to explicitly or implicitly blocked range or zones. If confirmed malicious, attackers could be attempting to perform a forbidden action on the network such as data exfiltration, lateral movement, or network disruption.",Cisco FTD,"Execution, Credential Access, Lateral Movement, Discovery, Exfiltration","T1046, T1110, T1018, T1595.002, T1203","`cisco_secure_firewall` EventType=ConnectionEvent action IN (""Block with reset"", ""Block"", ""blocked"")
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, dest_port, transport, rule, url, EVE_Process, action
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_secure_firewall___blocked_connection_filter`"
Cisco Secure Firewall - Citrix NetScaler Memory Overread Attempt,"This analytic detects exploitation activity of CVE-2025-5777 using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where Snort signature 65118 (Citrix NetScaler memory overread attempt) is triggered If confirmed malicious, this behavior is highly indicative of a potential exploitation of CVE-2025-5777.",Cisco FTD,"Execution, Discovery","T1059, T1203","`cisco_secure_firewall` 
EventType=IntrusionEvent 
signature_id = 65118
| fillnull
| stats min(_time) as firstTime
max(_time) as lastTime
values(signature_id) as signature_id
values(signature) as signature
values(class_desc) as class_desc
values(MitreAttackGroups) as MitreAttackGroups
values(InlineResult) as InlineResult
values(InlineResultReason) as InlineResultReason
values(src) as src
values(dest_port) as dest_port
values(rule) as rule
values(transport) as transport
values(app) as app
by dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___citrix_netscaler_memory_overread_attempt_filter`"
Cisco Secure Firewall - Communication Over Suspicious Ports,"The following analytic detects potential reverse shell activity by identifying connections involving ports commonly associated with remote access tools, shell listeners, or tunneling utilities. It leverages Cisco Secure Firewall Threat Defense logs and monitors destination ports against a list of non-standard, high-risk port values often used in post-exploitation scenarios. Adversaries frequently configure tools like netcat, Meterpreter, or other backdoors to listen or connect over uncommon ports such as 4444, 2222, or 51820 to bypass standard monitoring and firewall rules.",Cisco FTD,"Command And Control, Execution, Lateral Movement, Privilege Escalation, Defense Evasion","T1059.001, T1105, T1571, T1219, T1021, T1055","`cisco_secure_firewall` EventType=ConnectionEvent dest_port IN (""888"", ""999"", ""2200"", ""2222"", ""4000"", ""4444"", ""6789"", ""8531"", ""50501"", ""51820"") 
| fillnull value=""unknown"" url
| stats min(_time) as firstTime max(_time) as lastTime 
values(src_port) as src_port
values(url) as url
values(rule) as rule
count by src, dest, dest_port, transport, action
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___communication_over_suspicious_ports_filter`"
Cisco Secure Firewall - Connection to File Sharing Domain,"The following analytic detects outbound connections to commonly abused file sharing and pastebin-style hosting domains. It leverages Cisco Secure Firewall Threat Defense logs and focuses on allowed connections (action=Allow) where the url field matches a list of known data hosting or temporary storage services. While many of these platforms serve legitimate purposes, they are frequently leveraged by adversaries for malware delivery, data exfiltration, command and control (C2) beacons, or staging of encoded payloads.",Cisco FTD,"Command And Control, Exfiltration","T1071.001, T1567.002, T1105, T1090.002, T1588.002","`cisco_secure_firewall` action IN (""Trust"", ""Allow"", ""allowed"") EventType=ConnectionEvent url IN (""*//objects.githubusercontent.com*"", ""*anonfiles.com*"", ""*cdn.discordapp.com*"", ""*ddns.net*"", ""*dl.dropboxusercontent.com*"", ""*ghostbin.co*"", ""*glitch.me*"", ""*gofile.io*"", ""*hastebin.com*"", ""*mediafire.com*"", ""*mega.nz*"", ""*onrender.com*"", ""*pages.dev*"", ""*paste.ee*"", ""*pastebin.com*"", ""*pastebin.pl*"", ""*pastetext.net*"", ""*privatlab.com*"", ""*privatlab.net*"", ""*send.exploit.in*"", ""*sendspace.com*"", ""*storage.googleapis.com*"", ""*storjshare.io*"", ""*supabase.co*"", ""*temp.sh*"", ""*transfer.sh*"", ""*trycloudflare.com*"", ""*ufile.io*"", ""*w3spaces.com*"", ""*workers.dev*"")
| stats count min(_time) as firstTime max(_time) as lastTime 
Values(src_port) as src_port
Values(dest) as dest
Values(dest_port) as dest_port
Values(rule) as rule
Values(url) as url
Values(EVE_Process) as EVE_Process
by src, transport, action
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_secure_firewall___connection_to_file_sharing_domain_filter`"
Cisco Secure Firewall - File Download Over Uncommon Port,The following analytic detects file transfers flagged as malware that occurred over non-standard ports (other than 80 and 443). Adversaries may attempt to bypass protocol-based detection or use alternate ports to blend in with other traffic. This analytic identifies these non-conventional flows and surfaces potential evasion techniques. If confirmed malicious this indicate potential malware delivery or other nefarious activity.,Cisco FTD,Command And Control,"T1105, T1571","`cisco_secure_firewall` EventType=FileEvent FileDirection=""Download"" NOT dest_port IN (80, 443)
| lookup cisco_secure_firewall_filetype_lookup Name as FileType OUTPUT Description
| stats count min(_time) as firstTime max(_time) as lastTime 
values(file_name) as file_name 
values(uri) as uri 
values(ClientApplication) as ClientApplication
values(file_hash) as file_hash 
values(SHA_Disposition) as SHA_Disposition 
by FileDirection FileType app ThreatName dest_port Description src dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table firstTime lastTime src dest dest_port FileDirection FileType Description uri ClientApplication file_name file_hash SHA_Disposition ThreatName
| `cisco_secure_firewall___file_download_over_uncommon_port_filter`"
Cisco Secure Firewall - High EVE Threat Confidence,"The following analytic detects connections with a high Encrypted Visibility Engine (EVE) threat confidence score, indicating potentially malicious behavior within encrypted traffic. It leverages Cisco Secure Firewall Threat Defense logs and evaluates the EVE_ThreatConfidencePct field, which reflects the system's confidence in classifying encrypted sessions as threats based on machine learning models and behavioral analysis.",Cisco FTD,"Command And Control, Exfiltration","T1041, T1573.002, T1105, T1071.001","`cisco_secure_firewall` EventType=ConnectionEvent EVE_ThreatConfidencePct >= 80
| stats count min(_time) as firstTime max(_time) as lastTime
Values(rule) as rule
Values(url) as url
by EVE_Process, EVE_ThreatConfidencePct, src, dest, dest_port, transport, action
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___high_eve_threat_confidence_filter`"
Cisco Secure Firewall - High Priority Intrusion Classification,"This analytic identifies high-severity intrusion events based on the classification assigned to Snort rules within Cisco Secure Firewall logs. It leverages Cisco Secure Firewall Threat Defense logs and focuses on events classified as:
A Network Trojan was Detected Successful Administrator Privilege Gain Successful User Privilege Gain Attempt to Login By a Default Username and Password Known malware command and control traffic Known malicious file or file based exploit Known client side exploit attempt Large Scale Information Leak&quot; These classifications typically represent significant threats such as remote code execution, credential theft, lateral movement, or malware communication.",Cisco FTD,"Initial Access, Execution, Credential Access, Command And Control, Lateral Movement, Defense Evasion","T1071, T1190, T1203, T1003, T1078","`cisco_secure_firewall` EventType=IntrusionEvent 
class_desc IN (""A Network Trojan was Detected"", ""Successful Administrator Privilege Gain"", ""Successful User Privilege Gain"", ""Attempt to Login By a Default Username and Password"", ""Known malware command and control traffic"", ""Known malicious file or file based exploit"", ""Known client side exploit attempt"", ""Large Scale Information Leak"")
| fillnull
| stats count min(_time) as firstTime max(_time) as lastTime
values(signature_id) as signature_id 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app
by src, dest, signature, class_desc
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___high_priority_intrusion_classification_filter`"
Cisco Secure Firewall - High Volume of Intrusion Events Per Host,"The following analytic detects internal systems that generate an unusually high volume of intrusion detections within a 30-minute window. It leverages Cisco Secure Firewall Threat Defense logs, specifically focusing on the IntrusionEvent event type, to identify hosts that trigger more than 15 Snort-based signatures during that time. A sudden spike in intrusion alerts originating from a single host may indicate suspicious or malicious activity such as malware execution, command-and-control communication, vulnerability scanning, or lateral movement.",Cisco FTD,"Lateral Movement, Execution, Command And Control, Persistence","T1071, T1595.002, T1059","`cisco_secure_firewall` EventType=IntrusionEvent
| bin _time span=30m
| stats count as TotalEvents values(signature_id) as signature_id
values(signature) as signature
values(dest) as dest
values(dest_port) as dest_port
min(_time) as firstTime max(_time) as lastTime 
by src class_desc MitreAttackGroups InlineResult InlineResultReason rule transport app
| where TotalEvents >= 15
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___high_volume_of_intrusion_events_per_host_filter`"
Cisco Secure Firewall - Intrusion Events by Threat Activity,This analytic detects intrusion events from known threat activity using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where one or multiple Snort signatures associated with a known threat or threat actor activity have been triggered within a one-hour time window. The detection uses a lookup table (cisco_snort_ids_to_threat_mapping) to map Snort signature IDs to known threat actors and their techniques.,Cisco FTD,"Command And Control, Exfiltration","T1041, T1573.002","`cisco_secure_firewall` EventType=IntrusionEvent
| stats count AS total_alerts, dc(signature_id) AS sig_count, values(SnortRuleGroups) AS snort_rule_groups, values(connection_id) AS connection_id, values(rule) AS rule, values(dest_port) AS dest_port, values(transport) AS transport, values(app) AS app, values(signature) AS signature, values(src) AS src BY _time dest signature_id
| lookup cisco_snort_ids_to_threat_mapping signature_id OUTPUT threat, category, message
| where isnotnull(threat)
| bin _time span=1d
| stats count AS Total_Alerts, dc(signature_id) AS sig_count, values(signature_id) AS signature_id, values(category) AS category, values(message) AS message, values(snort_rule_groups) AS snort_rule_groups, values(connection_id) AS connection_id, values(rule) AS rule, values(dest_port) AS dest_port, values(transport) AS transport, values(app) AS app, values(signature) AS signature, values(src) AS src BY _time dest threat
| lookup threat_snort_count threat OUTPUT description, distinct_count_snort_ids
| table _time, dest, src, threat, category, message, description, signature_id, signature, snort_rule_groups, sig_count, distinct_count_snort_ids, connection_id, rule, dest_port, transport, app
| where sig_count >= distinct_count_snort_ids
| `cisco_secure_firewall___intrusion_events_by_threat_activity_filter`"
Cisco Secure Firewall - Lumma Stealer Activity,"This analytic detects Lumma Stealer activity using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where four of the following Snort signature IDs 64793, 64794, 64797, 64798, 64799, 64800, 64801, 62709, 64167, 64168, 64169, 64796, 62710, 62711, 62712, 62713, 62714, 62715, 62716, 62717, 64812, 64810, 64811 occurs in the span of 15 minutes from the same host.",Cisco FTD,"Initial Access, Execution, Lateral Movement, Defense Evasion","T1190, T1204, T1210, T1027","`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (64793, 64794, 64797, 64798, 64799, 64800, 64801, 62709, 64167, 64168, 64169, 64796, 62710, 62711, 62712, 62713, 62714, 62715, 62716, 62717, 64812, 64810, 64811)
| bin _time span=15m
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(dest) as dest 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by src
| where unique_signature_count >= 3
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___lumma_stealer_activity_filter`"
Cisco Secure Firewall - Lumma Stealer Download Attempt,"This analytic detects Lumma Stealer download attempts using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where Snort signatures with IDs 64797, 64798, 64799, 64800, 64801, 64167, 64168, 64169 have been triggered. If confirmed malicious, this behavior could indicate an active infection of Lumma Stealer.",Cisco FTD,"Command And Control, Exfiltration","T1041, T1573.002","`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (62710, 62711, 62712, 62713, 62714, 62715, 62716, 62717, 64810, 64811)
| fillnull
| stats min(_time) as firstTime max(_time) as lastTime 
by src dest dest_port transport signature_id signature class_desc MitreAttackGroups rule InlineResult InlineResultReason app
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___lumma_stealer_download_attempt_filter`"
Cisco Secure Firewall - Lumma Stealer Outbound Connection Attempt,"This analytic detects Lumma Stealer outbound connection attempts using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where Snort signatures with IDs 64797, 64798, 64799, 64800, 64801, 64167, 64168, 64169, 62709 have been triggered. If confirmed malicious, this behavior could indicate an active infection of Lumma Stealer.",Cisco FTD,"Command And Control, Exfiltration","T1041, T1573.002","`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (64797, 64798, 64799, 64800, 64801, 64167, 64168, 64169, 62709)
| fillnull
| stats min(_time) as firstTime max(_time) as lastTime 
by src dest dest_port transport signature_id signature class_desc MitreAttackGroups rule InlineResult InlineResultReason app
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___lumma_stealer_outbound_connection_attempt_filter`"
Cisco Secure Firewall - Malware File Downloaded,"The following analytic detects file downloads that were classified as malware by Cisco Secure Firewall Threat Defense. It relies on the SHA_Disposition field with a value of &quot;Malware&quot; and includes metadata such as file name, file_hash hash, and threat classification. This analytic is critical for surfacing file-based threats that are identified via Cisco's AMP or Threat Grid integrations.",Cisco FTD,"Command And Control, Execution","T1105, T1203","`cisco_secure_firewall` EventType=FileEvent SHA_Disposition=""Malware"" FileDirection=""Download""
| lookup cisco_secure_firewall_filetype_lookup Name as FileType OUTPUT Description
| stats count min(_time) as firstTime max(_time) as lastTime
values(uri) as uri
values(ClientApplication) as ClientApplication
values(file_hash) as file_hash
by FileDirection dest src dest_port FileType app file_name ThreatName Description
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table firstTime lastTime src dest dest_port FileDirection FileType Description uri file_name file_hash app ClientApplication ThreatName SHA_Disposition
| `cisco_secure_firewall___malware_file_downloaded_filter`"
Cisco Secure Firewall - Oracle E-Business Suite Correlation,This correlation rule identifies potential exploitation attempts of Oracle E-Business Suite vulnerabilities (CVE-2025-61882 and CVE-2025-61884) by correlating multiple intrusion signatures from Cisco Secure Firewall Threat Defense logs. The detection looks for specific signatures that indicate attempts to exploit the TemplatePreview functionality and vulnerable SyncServlet endpoints as well as post compromise activity involving Cl0p.,Cisco FTD,Initial Access,T1190,"`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (65454, 65455, 65377, 65378, 65413, 65414, 65415, 65456)
| bin _time span=5m
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
sum(eval(signature_id==65454)) as sig_template_preview
sum(eval(signature_id==65455)) as sig_sync_servlet
sum(eval(signature_id IN (65377,65378,65413,65414,65415,65456))) as sig_exploit_activity
by src dest
| where (
(
sig_exploit_activity >= 1 
AND 
(
sig_template_preview >= 1 
OR 
sig_sync_servlet >= 1
)
)
OR
(
sig_template_preview >= 1
AND 
sig_sync_servlet >= 1
)
OR
unique_signature_count >= 2
)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___oracle_e_business_suite_correlation_filter`"
Cisco Secure Firewall - Oracle E-Business Suite Exploitation,"This analytic detects vulnerability exploitation and post-compromise activity associated with Oracle E-Business Suite web-application vulnerabilities, CVE-2025-61882 and CVE-2025-61884. SIDs 65413-65415 detect detect Java.Backdoor.Cl0p variant payload downloads and Java.Backdoor.Cl0p outbound command-and-control connection attempts. SIDs 65456, 65377 and 65378 detect attempts to exploit these vulnerabilities. Security teams should investigate any instances of these signatures, especially if they are found in conjunction with other suspicious network activity or on systems that should not be exposed to such threats.",Cisco FTD,Initial Access,T1190,"`cisco_secure_firewall`
EventType=IntrusionEvent
signature_id IN (65377, 65378, 65413, 65414, 65415, 65456)
| fillnull
| stats values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by src dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___oracle_e_business_suite_exploitation_filter`"
Cisco Secure Firewall - Possibly Compromised Host,The following analytic highlights high-impact intrusion events assigned by Cisco Secure Firewall.,Cisco FTD,"Execution, Impact, Exfiltration","T1587.001, T1059, T1203","`cisco_secure_firewall` EventType=IntrusionEvent Impact IN (1,2)
| stats count as TotalDetections values(signature_id) as signature_id 
values(signature) as signature 
values(rule) as rule 
min(_time) as firstTime max(_time) as lastTime 
by src dest dest_port transport Impact app impact_desc class_desc MitreAttackGroups InlineResult InlineResultReason
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___possibly_compromised_host_filter`"
Cisco Secure Firewall - Potential Data Exfiltration,"The following analytic detects potentially suspicious large outbound data transfers from internal to external networks. It leverages Cisco Secure Firewall Threat Defense logs and calculates the total volume of data exchanged per connection by summing InitiatorBytes and ResponderBytes. Connections exceeding 100 MB are flagged, as these may indicate unauthorized data exfiltration, especially if initiated by unusual users, hosts, or processes.",Cisco FTD,Exfiltration,"T1041, T1567.002, T1048.003","`cisco_secure_firewall` EventType=ConnectionEvent `cisco_secure_firewall_inside_to_outside`
| eval total_bytes = InitiatorBytes + ResponderBytes
| eval total_mb = round(total_bytes / 1024 / 1024, 2)
| where total_mb >= 100
| eval Exfiltrated = total_mb + "" MB""
| stats min(_time) as firstTime max(_time) as lastTime
Values(url) as url
Values(rule) as rule
Values(dest_port) as dest_port
by src, dest, Exfiltrated, transport, action
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___potential_data_exfiltration_filter`"
Cisco Secure Firewall - Rare Snort Rule Triggered,"This analytic identifies Snort signatures that have triggered only once in the past 7 days across all Cisco Secure Firewall IntrusionEvent logs. While these rules typically do not trigger in day-to-day network activity, their sudden appearance may indicate early-stage compromise, previously unseen malware, or reconnaissance activity against less commonly exposed services. Investigating these outliers can provide valuable insight into new or low-noise adversary behaviors.",Cisco FTD,Exfiltration,"T1583.006, T1598","`cisco_secure_firewall` EventType=IntrusionEvent earliest=-7d
| stats dc(_time) as TriggerCount min(_time) as firstTime max(_time) as lastTime 
values(signature) as signature 
values(src) as src 
values(dest) as dest 
values(dest_port) as dest_port
values(transport) as transport
values(app) as app 
values(rule) as rule 
by signature_id class_desc MitreAttackGroups InlineResult InlineResultReason
| where TriggerCount = 1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___rare_snort_rule_triggered_filter`"
Cisco Secure Firewall - React Server Components RCE Attempt,"This analytic detects exploitation activity of CVE-2025-55182 using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where Snort signature 65554 (React Server Components remote code execution attempt) is triggered If confirmed malicious, this behavior could be indicative of a potential exploitation of CVE-2025-55182.",Cisco FTD,"Initial Access, Execution",T1190,"`cisco_secure_firewall` 
EventType=IntrusionEvent 
signature_id = 65554
| fillnull
| stats min(_time) as firstTime
max(_time) as lastTime
values(signature_id) as signature_id
values(signature) as signature
values(class_desc) as class_desc
values(MitreAttackGroups) as MitreAttackGroups
values(InlineResult) as InlineResult
values(InlineResultReason) as InlineResultReason
values(src) as src
values(dest_port) as dest_port
values(rule) as rule
values(transport) as transport
values(app) as app
by dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___react_server_components_rce_attempt_filter`"
Cisco Secure Firewall - Remote Access Software Usage Traffic,"The following analytic detects network traffic associated with known remote access software applications that are covered by Cisco Secure Firewall Application Detectors, such as AnyDesk, GoToMyPC, LogMeIn, and TeamViewer. It leverages Cisco Secure Firewall Threat Defense Connection Event. This activity is significant because adversaries often use remote access tools to maintain unauthorized access to compromised environments.",Cisco FTD,"Collection, Command And Control",T1219,"`cisco_secure_firewall` EventType=ConnectionEvent
| stats min(_time) as firstTime max(_time) as lastTime 
values(dest_port) as dest_port
values(dest) as dest
values(transport) as transport
values(url) as url
values(rule) as rule
count by src ClientApplication action
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup cisco_secure_firewall_appid_remote_mgmt_and_desktop_tools appName AS ClientApplication OUTPUT category, appDescription as Description
| search category IN (""remote administration"", ""remote desktop control"")
| `remote_access_software_usage_exceptions`
| `cisco_secure_firewall___remote_access_software_usage_traffic_filter`"
Cisco Secure Firewall - Repeated Blocked Connections,"The following analytic detects repeated blocked connection attempts from the same initiator to the same responder within a short time window. It leverages Cisco Secure Firewall Threat Defense logs and identifies connections where the action is set to Block, and the number of occurrences reaches or exceeds a threshold of ten within a one-minute span.",Cisco FTD,"Lateral Movement, Execution, Credential Access, Discovery","T1046, T1110, T1018, T1595.002, T1203","`cisco_secure_firewall` EventType=ConnectionEvent action IN (""Block with reset"", ""Block"", ""blocked"")
| bin _time span=1m 
| stats count min(_time) as firstTime max(_time) as lastTime
Values(dest_port) as dest_port
Values(url) as url
by src, dest, transport, rule, action
| where count >= 10
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___repeated_blocked_connections_filter`"
Cisco Secure Firewall - Repeated Malware Downloads,"The following analytic detects repeated malware file downloads initiated by the same internal host (src) within a short time window. It leverages Cisco Secure Firewall Threat Defense logs and identifies FileEvent events with a SHA_Disposition of &quot;Malware&quot; and FileDirection set to &quot;Download&quot;. If ten or more such events occur from the same host within five minutes, this analytic will trigger.",Cisco FTD,"Command And Control, Persistence, Defense Evasion","T1105, T1027","`cisco_secure_firewall` EventType=FileEvent SHA_Disposition=""Malware"" FileDirection=""Download""
| lookup cisco_secure_firewall_filetype_lookup Name as FileType OUTPUT Description
| bin _time span=5m 
| stats count min(_time) as firstTime max(_time) as lastTime
values(uri) as uri
values(ClientApplication) as ClientApplication
values(app) as app
values(file_hash) as file_hash
values(SHA_Disposition) as SHA_Disposition
values(file_name) as file_name
values(ThreatName) as ThreatName
values(dest) as dest
values(dest_port) as dest_port
by src FileDirection FileType Description
| where count >= 10
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table firstTime lastTime src dest dest_port FileDirection FileType Description uri file_name file_hash app ClientApplication ThreatName SHA_Disposition
| `cisco_secure_firewall___repeated_malware_downloads_filter`"
Cisco Secure Firewall - Snort Rule Triggered Across Multiple Hosts,"This analytic identifies Snort intrusion signatures that have been triggered by ten or more distinct internal IP addresses within a one-hour window. It leverages Cisco Secure Firewall Threat Defense logs and focuses on the IntrusionEvent event type to detect activity that may indicate broad targeting or mass exploitation attempts. This behavior is often associated with opportunistic scanning, worm propagation, or automated exploitation of known vulnerabilities across multiple systems.",Cisco FTD,"Command And Control, Defense Evasion","T1105, T1027","`cisco_secure_firewall` EventType=IntrusionEvent
| bin _time span=1h
| stats dc(src) as unique_src_ips, values(src) as src 
min(_time) as firstTime max(_time) as lastTime
Values(dest) as dest
Values(dest_port) as dest_port
Values(rule) as rule
Values(transport) as transport
Values(app) as app
by signature_id, signature class_desc MitreAttackGroups InlineResult InlineResultReason 
| where unique_src_ips >= 10
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___snort_rule_triggered_across_multiple_hosts_filter`"
Cisco Secure Firewall - Static Tundra Smart Install Abuse,"This analytic detects activity associated with &quot;Static Tundra&quot; threat actor abuse of the Cisco Smart Install (SMI) protocol using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify occurrences of Smart Install exploitation and protocol abuse, including denial-of-service and buffer overflow attempts. The detection triggers when multiple Cisco Smart Install-related Snort signatures are observed in a short period from the same source, which is indicative of active exploitation or reconnaissance against Cisco devices that expose SMI.",Cisco FTD,"Initial Access, Execution, Impact, Lateral Movement","T1190, T1210, T1499","`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (46468, 46096, 41722, 41723, 41724, 41725)
| bin _time span=15m
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(dest) as dest 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by src
| where unique_signature_count >= 2
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___static_tundra_smart_install_abuse_filter`"
Cisco Secure Firewall - Veeam CVE-2023-27532 Exploitation Activity,"This analytic detects exploitation activity of CVE-2023-27532 using Cisco Secure Firewall Intrusion Events. It leverages Cisco Secure Firewall Threat Defense IntrusionEvent logs to identify cases where Snort signature 61514 (Veeam Backup and Replication credential dump attempt) is followed within a 5-minute window by 64795 (Veeam Backup and Replication xp_cmdshell invocation attempt), which detects the use of xp_cmdshell, a common post-exploitation technique.",Cisco FTD,"Initial Access, Execution, Credential Access, Lateral Movement","T1190, T1059.001, T1003.001, T1210","`cisco_secure_firewall` EventType=IntrusionEvent signature_id IN (61514, 64795)
| bin _time span=5m
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(src) as src 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by dest
| where unique_signature_count = 2
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___veeam_cve_2023_27532_exploitation_activity_filter`"
Cisco Secure Firewall - Wget or Curl Download,"The following analytic detects outbound connections initiated by command-line tools such as curl or wget. It leverages Cisco Secure Firewall Threat Defense logs and identifies allowed connections (action=Allow) where either the EVE_Process or ClientApplication fields indicate use of these utilities. While curl and wget are legitimate tools commonly used for software updates and scripting, adversaries often abuse them to download payloads, retrieve additional tools, or establish staging infrastructure from compromised systems.",Cisco FTD,"Command And Control, Execution, Persistence, Privilege Escalation","T1071.001, T1059, T1105, T1053.003","`cisco_secure_firewall` EventType=ConnectionEvent action IN (""Trust"", ""Allow"", ""allowed"") AND
( EVE_Process IN (""*curl*"", ""*wget*"") OR ClientApplication IN (""cURL"", ""Wget"") )
| stats count min(_time) as firstTime max(_time) as lastTime
Values(rule) as rule
Values(url) as url
Values(dest_port) as dest_port
Values(ClientApplicationVersion) as ClientApplicationVersion
Values(src_port) as src_port
by src, dest, transport, EVE_Process, ClientApplication, action
| table src src_port dest dest_port transport url EVE_Process ClientApplication ClientApplicationVersion rule firstTime lastTime
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `cisco_secure_firewall___wget_or_curl_download_filter`"
Azure AD New Federated Domain Added,"The following analytic detects the addition of a new federated domain within an Azure Active Directory tenant. It leverages Azure AD AuditLogs to identify successful &quot;Set domain authentication&quot; operations. This activity is significant as it may indicate the use of the Azure AD identity federation backdoor technique, allowing an adversary to establish persistence.",Azure AD (Microsoft Entra ID),"Execution, Persistence, Defense Evasion","T1484.002, T1484","`azure_monitor_aad` operationName=""Set domain authentication"" ""properties.result""=success 
| rename properties.* as * 
| rename targetResources{}.displayName as domain 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent domain signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_new_federated_domain_added_filter`"
Azure AD Privileged Role Assigned,"The following analytic detects the assignment of privileged Azure Active Directory roles to a user. It leverages Azure AD audit logs, specifically monitoring the &quot;Add member to role&quot; operation. This activity is significant as adversaries may assign privileged roles to compromised accounts to maintain persistence within the Azure AD environment. If confirmed malicious, this could allow attackers to escalate privileges, access sensitive information, and maintain long-term control over the Azure AD infrastructure.",Azure AD (Microsoft Entra ID),Persistence,"T1098, T1098.003","`azure_monitor_aad` ""operationName""=""Add member to role"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename targetResources{}.modifiedProperties{}.newValue as roles 
| eval role=mvindex(roles,1) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy result role signature 
| lookup privileged_azure_ad_roles azureadrole AS role OUTPUT isprvilegedadrole description 
| search isprvilegedadrole = True 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_privileged_role_assigned_filter`"
Cisco Isovalent - Access To Cloud Metadata Service,"The following analytic detects workloads accessing the cloud instance metadata service at 169.254.169.254. This IP is used by AWS, GCP and Azure metadata endpoints and is frequently abused in SSRF or lateral movement scenarios to obtain credentials and sensitive environment details. Monitor unexpected access to this service from application pods or namespaces where such behavior is atypical.",Cisco Isovalent,"Lateral Movement, Credential Access","T1552.005, T1552","`cisco_isovalent_process_connect` 
| rename process_connect.parent.binary as binary 
| `excluded_cloud_binaries`
| stats count 
min(_time) as firstTime 
max(_time) as lastTime 
values(dest_port) as dest_port
values(src_ip) as src_ip
by cluster_name pod_name pod_image_name pod_namespace node_name dest_ip
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___access_to_cloud_metadata_service_filter`"
Cisco Isovalent - Kprobe Spike,"This analytic detects excessive kernel probe (kprobe) events in a Kubernetes cluster over a short period of time. Kprobes are a Linux kernel debugging and instrumentation mechanism that allows dynamic monitoring and tracing of kernel functions and system calls. In containerized or cloud-native environments, kprobes are occasionally used for legitimate low-level diagnostics; however, monitoring a spike in kprobe activity is important because malware or attackers may abuse this mechanism to gain insights into the kernel, attempt privilege escalation, or tamper with host processes.",Cisco Isovalent,"Execution, Privilege Escalation",T1068,"`cisco_isovalent` process_kprobe.action!=""""
| bin _time span=5m 
| rename process_kprobe.parent.pod.name as pod_name 
| stats count as kprobe_count 
values(process_kprobe.function_name) as functions
values(process_kprobe.process.binary) as binaries
values(process_kprobe.args{}.string_arg) as args
by pod_name _time
| where kprobe_count > 10 
| `cisco_isovalent___kprobe_spike_filter`"
Cisco Isovalent - Potential Escape to Host,"This analytic detects potential container escape or reconnaissance attempts by monitoring for the rapid execution of multiple suspicious Linux commands (nsenter, mount, ps aux, and ls) within a short time window. The search aggregates process execution logs into 5-minute buckets and identifies when two or more distinct commands occur in quick succession. This behavior is noteworthy because attackers often chain these commands together to pivot from a container into the host, enumerate processes, or browse filesystems.",Cisco Isovalent,"Execution, Privilege Escalation, Exfiltration",T1611,"`cisco_isovalent_process_exec`
(
process_name IN (""nsenter"",""mount"",""ps"",""ls"")
OR
process IN (""*nsenter*"", ""*mount*"", ""*ps aux*"", ""*ps -ef*"")
)
| bin _time span=5m
| stats 
count AS total_events
dc(process_name) AS distinct_cmds
min(_time) AS firstTime
max(_time) AS lastTime
values(process) AS process
values(process_name) AS process_name
BY cluster_name node_name pod_name _time
| eval duration_s = round(lastTime - firstTime, 0)
| where distinct_cmds >= 2 AND duration_s <= 120
| table _time cluster_name node_name pod_name total_events distinct_cmds duration_s firstTime lastTime process process_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___potential_escape_to_host_filter`"
Detect RClone Command-Line Usage,"The following analytic detects the usage of rclone.exe with specific command-line arguments indicative of file transfer activities. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as rclone.exe is often used by adversaries for data exfiltration, especially during ransomware attacks. If confirmed malicious, this behavior could lead to unauthorized data transfer, resulting in data breaches and potential loss of sensitive information.",Windows Events,"Execution, Exfiltration",T1020,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.original_file_name=""rclone.exe"" OR Processes.process_name=""rclone.exe"")
Processes.process IN (
""*copy*"", ""*mega*"", ""*pcloud*"", ""*ftp*"",
""*--config*"", ""*--progress*"", ""*--no-check-certificate*"",
""*--ignore-existing*"", ""*--auto-confirm*"", ""*--transfers*"",
""*--multi-thread-streams*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
|  `security_content_ctime(lastTime)`
| `detect_rclone_command_line_usage_filter`"
Detect Remote Access Software Usage Process,"The following analytic detects the execution of known remote access software within the environment. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent processes mapped to the Endpoint data model. We then compare with with a list of known remote access software shipped as a lookup file - remote_access_software.",Windows Events,"Collection, Execution, Command And Control",T1219,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.parent_process) as parent_process 
from datamodel=Endpoint.Processes 
where 
[
| inputlookup remote_access_software where isutility=TRUE
| rename remote_utility AS Processes.process_name 
| fields Processes.process_name] 
AND Processes.dest!=""unknown"" 
AND Processes.user!=""unknown"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| lookup remote_access_software remote_utility AS process_name OUTPUT isutility description AS signature comment_reference AS desc category
| search isutility = TRUE
| `remote_access_software_usage_exceptions`
| `detect_remote_access_software_usage_process_filter`"
Disable Windows Behavior Monitoring,"The following analytic identifies modifications in the registry to disable Windows Defender's real-time behavior monitoring. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with Windows Defender settings. This activity is significant because disabling real-time protection is a common tactic used by malware such as RATs, bots, or Trojans to evade detection.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableBehaviorMonitoring"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableOnAccessProtection"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableScanOnRealtimeEnable"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableIntrusionPreventionSystem"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableIOAVProtection"" OR Registry.registry_path= ""*\\Real-Time Protection\\DisableScriptScanning"" AND Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_windows_behavior_monitoring_filter`"
Executables Or Script Creation In Suspicious Path,"The following analytic identifies the creation of executables or scripts in suspicious file paths on Windows systems. It leverages the Endpoint.Filesystem dataset to detect files with specific extensions (e.g., .exe, .dll, .ps1) created in uncommon directories (e.g., \windows\fonts, \users\public). This activity can be significant as adversaries often use these paths to evade detection and maintain persistence.",Windows Events,"Persistence, Defense Evasion",T1036,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
Filesystem.file_name IN (
""*.bat"",
""*.cmd"",
""*.com"",
""*.dll"",
""*.exe"",
""*.js"",
""*.msc"",
""*.pif"",
""*.ps1"",
""*.sys"",
""*.vbe"",
""*.vbs""
)
Filesystem.file_path IN (
""*\\PerfLogs\\*"",
""*\\Users\\Administrator\\Music\\*"",
""*\\Users\\Default\\*"",
""*\\Users\\Public\\*"",
""*\\Windows\\debug\\*"",
""*\\Windows\\fonts\\*"",
""*\\Windows\\Media\\*"",
""*\\Windows\\repair\\*"",
""*\\Windows\\servicing\\*"",
""*Recycle.bin*"",
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `executables_or_script_creation_in_suspicious_path_filter`"
Executables Or Script Creation In Temp Path,"The following analytic identifies the creation of executables or scripts in temporary file paths on Windows systems. It leverages the Endpoint.Filesystem data set to detect files with specific extensions (e.g., .exe, .dll, .ps1) created in temporary directories (e.g., \windows\Temp, \AppData\Local\Temp). This activity can be significant as adversaries often use these paths to evade detection and maintain persistence.",Windows Events,"Lateral Movement, Persistence, Defense Evasion",T1036,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
Filesystem.action=""created""
Filesystem.file_name IN (
""*.bat"",
""*.cmd"",
""*.com"",
""*.dll"",
""*.exe"",
""*.js"",
""*.msc"",
""*.pif"",
""*.ps1"",
""*.sys"",
""*.vbe"",
""*.vbs""
)
Filesystem.file_path IN (
""*:\\Temp\\*"",
""*:\\Windows\\Temp\\*"",
""*\\AppData\\Local\\Temp\\*"",
)
NOT Filesystem.file_path IN (
""*\\__PSScriptPolicyTest_*"",
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `executables_or_script_creation_in_temp_path_filter`"
Impacket Lateral Movement Commandline Parameters,"The following analytic identifies the use of suspicious command-line parameters associated with Impacket tools, such as wmiexec.py, smbexec.py, dcomexec.py, and atexec.py, which are used for lateral movement and remote code execution. It detects these activities by analyzing process execution logs from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns. This activity is significant because Impacket tools are commonly used by adversaries and Red Teams to move laterally within a network.",Windows Events,"Lateral Movement, Execution, Persistence, Exfiltration","T1021.002, T1543.003, T1053, T1021.003, T1047, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe (Processes.process = ""*/Q /c * \\\\127.0.0.1\\*$*"" AND Processes.process IN (""*2>&1*"",""*2&gt;&amp;1*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `impacket_lateral_movement_commandline_parameters_filter`"
Impacket Lateral Movement WMIExec Commandline Parameters,"The following analytic detects the use of Impacket's wmiexec.py tool for lateral movement by identifying specific command-line parameters. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes spawned by wmiprvse.exe with command-line patterns indicative of Impacket usage. This activity is significant as Impacket tools are commonly used by adversaries for remote code execution and lateral movement within a network.",Windows Events,"Lateral Movement, Execution, Persistence, Exfiltration","T1021.002, T1543.003, T1053, T1021.003, T1047, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=wmiprvse.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| where match(process, ""(?i)cmd\.exe\s+\/Q\s+\/c"") AND match(process, ""\\\\127\.0\.0\.1\\.*"") AND match(process, ""__\\d{1,10}\\.\\d{1,10}"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `impacket_lateral_movement_wmiexec_commandline_parameters_filter`"
Linux Adding Crontab Using List Parameter,"The following analytic detects suspicious modifications to cron jobs on Linux systems using the crontab command with list parameters. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an attempt to establish persistence or execute malicious code on a schedule.",Linux,"Execution, Lateral Movement, Persistence, Impact, Privilege Escalation",T1053.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""crontab"" Processes.process= ""* -l*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_adding_crontab_using_list_parameter_filter`"
Linux Auditd Preload Hijack Via Preload File,"The following analytic detects suspicious preload hijacking via the preload file, which may indicate an attacker's attempt to intercept or manipulate library loading processes. The preload file can be used to force the loading of specific libraries before others, potentially allowing malicious code to execute or alter application behavior. By monitoring for unusual or unauthorized modifications to the preload file, this analytic helps identify attempts to hijack preload mechanisms, enabling security teams to investigate and address potential threats to system integrity and security.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1574.006,"`linux_auditd`
(type=PATH OR type=CWD)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/ld.so.preload.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_preload_hijack_via_preload_file_filter`"
Linux Ingress Tool Transfer with Curl,"The following analytic detects the use of the curl command with specific switches (-O, -sO, -ksO, --output) commonly used to download remote scripts or binaries. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as it may indicate an attempt to download and execute potentially malicious files, often used in initial stages of an attack.",Linux,"Command And Control, Execution",T1105,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.process_name=curl
Processes.process IN (""*-O*"",""*-sO*"",""*-ksO*"",""*--output*"")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id
Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| where match(process, ""(?i)(-O
|-sO
|-ksO
|--output)"")
| `linux_ingress_tool_transfer_with_curl_filter`"
Linux Install Kernel Module Using Modprobe Utility,"The following analytic detects the installation of a Linux kernel module using the modprobe utility. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because installing a kernel module can indicate an attempt to deploy a rootkit or other malicious kernel-level code, potentially leading to elevated privileges and bypassing security detections.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN(""kmod"", ""sudo"") AND Processes.process = *modprobe* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_install_kernel_module_using_modprobe_utility_filter`"
Linux Medusa Rootkit,"This detection identifies file creation events associated with the installation of the Medusa rootkit, a userland LD_PRELOAD-based rootkit known for deploying shared objects, loader binaries, and configuration files into specific system directories. These files typically facilitate process hiding, credential theft, and backdoor access. Monitoring for such file creation patterns enables early detection of rootkit deployment before full compromise.",Linux,"Execution, Defense Evasion","T1589.001, T1014","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/lib/libseconf"", ""*.backup_ld.so"", ""*.boot.sh"", ""*.logpam"", ""*sshpass.txt"", ""*sshpass2.txt"", ""*/lib/libdsx.so"", ""*rkload"", ""*/lib/libseconf/local.txt"", ""*/lib/locate/local.txt"", ""*/var/log/remote.txt"", ""*/lib/libseconf/.pts"", ""*/lib/locate /.pts"", ""*/libseconf/.ports"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_medusa_rootkit_filter`"
Linux Preload Hijack Library Calls,"The following analytic detects the use of the LD_PRELOAD environment variable to hijack or hook library functions on a Linux platform. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because adversaries, malware authors, and red teamers commonly use this technique to gain elevated privileges and establish persistence on a compromised machine.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1574.006,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*LD_PRELOAD*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_preload_hijack_library_calls_filter`"
Linux Service File Created In Systemd Directory,"The following analytic detects the creation of suspicious service files within the systemd directories on Linux platforms. It leverages logs containing file name, file path, and process GUID data from endpoints. This activity is significant for a SOC as it may indicate an adversary attempting to establish persistence on a compromised host. If confirmed malicious, this could lead to system compromise or data exfiltration, allowing attackers to maintain control over the system and execute further malicious activities.",Linux,"Execution, Exfiltration, Persistence, Privilege Escalation","T1053.003, T1053, T1053.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name = *.service Filesystem.file_path IN (""*/etc/systemd/system*"", ""*/lib/systemd/system*"", ""*/usr/lib/systemd/system*"", ""*/run/systemd/system*"", ""*~/.config/systemd/*"", ""*~/.local/share/systemd/*"",""*/etc/systemd/user*"", ""*/lib/systemd/user*"", ""*/usr/lib/systemd/user*"", ""*/run/systemd/user*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_service_file_created_in_systemd_directory_filter`"
Linux SSH Authorized Keys Modification,"The following analytic detects the modification of SSH Authorized Keys on Linux systems. It leverages process execution data from Endpoint Detection and Response (EDR) agents, specifically monitoring commands like &quot;bash&quot; and &quot;cat&quot; interacting with &quot;authorized_keys&quot; files. This activity is significant as adversaries often modify SSH Authorized Keys to establish persistent access to compromised endpoints.",Linux,"Execution, Persistence, Exfiltration",T1098.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process_name IN (""bash"",""cat"") Processes.process IN (""*/authorized_keys*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_ssh_authorized_keys_modification_filter`"
Linux SSH Remote Services Script Execute,"The following analytic detects the use of SSH to move laterally and execute a script or file on a remote host. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific SSH command-line parameters and URLs. This activity is significant as it may indicate an attacker attempting to execute remote commands or scripts, potentially leading to unauthorized access or control over additional systems.",Linux,"Lateral Movement, Execution, Privilege Escalation",T1021.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process_name=ssh Processes.process IN (""*oStrictHostKeyChecking*"", ""*oConnectTimeout*"", ""*oBatchMode*"") AND Processes.process IN (""*http:*"",""*https:*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_ssh_remote_services_script_execute_filter`"
Linux Sudo OR Su Execution,"The following analytic detects the execution of the &quot;sudo&quot; or &quot;su&quot; command on a Linux operating system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent process names. This activity is significant because &quot;sudo&quot; and &quot;su&quot; commands are commonly used by adversaries to elevate privileges, potentially leading to unauthorized access or control over the system.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery, Exfiltration","T1548.003, T1548","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""sudo"", ""su"") OR Processes.parent_process_name IN (""sudo"", ""su"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_sudo_or_su_execution_filter`"
Linux System Network Discovery,"The following analytic identifies potential enumeration of local network configuration on Linux systems. It detects this activity by monitoring processes such as &quot;arp,&quot; &quot;ifconfig,&quot; &quot;ip,&quot; &quot;netstat,&quot; &quot;firewall-cmd,&quot; &quot;ufw,&quot; &quot;iptables,&quot; &quot;ss,&quot; and &quot;route&quot; within a 30-minute window. This behavior is significant as it often indicates reconnaissance efforts by adversaries to gather network information for subsequent attacks.",Linux,"Lateral Movement, Execution, Discovery",T1016,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.dest) as dest values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product dc(Processes.process_name) as process_name_count from datamodel=Endpoint.Processes where Processes.process_name IN (""arp"", ""ifconfig"", ""ip"", ""netstat"", ""firewall-cmd"", ""ufw"", ""iptables"", ""ss"", ""route"") by _time span=30m Processes.dest Processes.user 
| where process_name_count>=4 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_system_network_discovery_filter`"
NLTest Domain Trust Discovery,"The following analytic identifies the execution of nltest.exe with command-line arguments /domain_trusts or /all_trusts to query Domain Trust information. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant as it indicates potential reconnaissance efforts by adversaries to understand domain trust relationships, which can inform their lateral movement strategies.",Windows Events,"Lateral Movement, Execution, Discovery",T1482,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=nltest.exe OR Processes.original_file_name=nltestrk.exe) (Processes.process=*/domain_trusts* OR Processes.process=*/all_trusts*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `nltest_domain_trust_discovery_filter`"
SecretDumps Offline NTDS Dumping Tool,"The following analytic detects the potential use of the secretsdump.py tool to dump NTLM hashes from a copy of ntds.dit and the SAM, SYSTEM, and SECURITY registry hives. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns and process names associated with secretsdump.py. This activity is significant because it indicates an attempt to extract sensitive credential information offline, which is a common post-exploitation technique.",Windows Events,"Execution, Credential Access, Lateral Movement, Privilege Escalation, Discovery",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""python*.exe"" Processes.process = ""*.py*"" Processes.process = ""*-ntds*"" (Processes.process = ""*-system*"" OR Processes.process = ""*-sam*"" OR Processes.process = ""*-security*"" OR Processes.process = ""*-bootkey*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `secretdumps_offline_ntds_dumping_tool_filter`"
Suspicious Linux Discovery Commands,"The following analytic detects the execution of suspicious bash commands commonly used in scripts like AutoSUID, LinEnum, and LinPeas for system discovery on a Linux host. It leverages Endpoint Detection and Response (EDR) data, specifically looking for a high number of distinct commands executed within a short time frame. This activity is significant as it often precedes privilege escalation or other malicious actions.",Windows Events,"Discovery, Execution, Privilege Escalation","T1059.004, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product dc(Processes.process) as distinct_commands dc(Processes.process_name) as distinct_process_names from datamodel=Endpoint.Processes where [
|inputlookup linux_tool_discovery_process 
| rename process as Processes.process 
|table Processes.process] by _time span=5m Processes.user Processes.dest 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where distinct_commands > 40 AND distinct_process_names > 3 
| `suspicious_linux_discovery_commands_filter`"
Suspicious wevtutil Usage,"The following analytic detects the usage of wevtutil.exe with parameters for clearing event logs such as Application, Security, Setup, Trace, or System. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because clearing event logs can be an attempt to cover tracks after malicious actions, hindering forensic investigations.",Windows Events,"Execution, Discovery, Defense Evasion",T1070.001,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wevtutil.exe Processes.process IN (""* cl *"", ""*clear-log*"") Processes.process IN (""*System*"", ""*Security*"", ""*Setup*"", ""*Application*"", ""*trace*"", ""*powershell*"", ""Sysmon"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `suspicious_wevtutil_usage_filter`"
WBAdmin Delete System Backups,"The following analytic detects the execution of wbadmin.exe with flags that delete backup files, specifically targeting catalog or system state backups. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because it is commonly used by ransomware to prevent recovery by deleting system backups.",Windows Events,"Execution, Impact",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ( Processes.process_name=wbadmin.exe OR Processes.original_file_name=WBADMIN.EXE ) Processes.process=""*delete*"" ( Processes.process=""*catalog*"" OR Processes.process=""*backup*"" ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `wbadmin_delete_system_backups_filter`"
Windows Suspicious C2 Named Pipe,"The following analytic detects the creation or connection to known suspicious C2 named pipes. It leverages Sysmon EventCodes 17 and 18 to identify known default pipe names used by C2 tools. If confirmed malicious, this could allow an attacker to abuse these to potentially gain persistence, command and control, or further system compromise.",Windows Events,"Command And Control, Execution, Lateral Movement, Persistence, Defense Evasion","T1021.002, T1559, T1218, T1055","`sysmon`
(EventCode=17 OR EventCode=18)
NOT process_path IN (
""*:\\Program Files \(x86\)\\Adobe*"",
""*:\\Program Files \(x86\)\\Google*"",
""*:\\Program Files \(x86\)\\Microsoft*"",
""*:\\Program Files\\Adobe*"",
""*:\\Program Files\\Google*"",
""*:\\Program Files\\Microsoft*"",
""*:\\Windows\\system32\\SearchIndexer.exe"",
""*:\\Windows\\System32\\svchost.exe"",
""*:\\Windows\\SystemApps\\Microsoft*"",
""*\\Amazon\\SSM\\Instance*"",
""*\\AppData\\Local\\Google*"",
""*\\AppData\\Local\\Kingsoft\\*"",
""*\\AppData\\Local\\Microsoft*"",
""System""
)
| stats  min(_time) as firstTime max(_time) as lastTime
count by dest dvc process_exec process_guid process_id process_path signature signature_id 
vendor_product pipe_name user_id Image process_name
| lookup suspicious_c2_named_pipes suspicious_pipe_name AS pipe_name OUTPUT tool, description
| where isnotnull(tool)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_suspicious_c2_named_pipe_filter`"
Detect DNS Data Exfiltration using pretrained model in DSDL,The following analytic identifies potential DNS data exfiltration using a pre-trained deep learning model.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration","T1048.003, T1048","| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.src _time DNS.query 
| `drop_dm_object_name(""DNS"")` 
| sort - _time,src, query 
| streamstats count as rank by src query 
| where rank < 10 
| table src,query,rank,_time 
| apply detect_dns_data_exfiltration_using_pretrained_model_in_dsdl 
| table src,_time,query,rank,pred_is_dns_data_exfiltration_proba,pred_is_dns_data_exfiltration 
| where rank == 1 
| rename pred_is_dns_data_exfiltration_proba as is_exfiltration_score 
| rename pred_is_dns_data_exfiltration as is_exfiltration 
| where is_exfiltration_score > 0.5 
| `security_content_ctime(_time)` 
| table src, _time,query,is_exfiltration_score,is_exfiltration 
| `detect_dns_data_exfiltration_using_pretrained_model_in_dsdl_filter`"
Detect suspicious DNS TXT records using pretrained model in DSDL,The following analytic identifies suspicious DNS TXT records using a pre-trained deep learning model.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration","T1071, T1568.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution where DNS.message_type=response AND DNS.record_type=TXT by DNS.src DNS.dest DNS.answer DNS.record_type 
| `drop_dm_object_name(""DNS"")` 
| rename answer as text 
| fields firstTime, lastTime, message_type,record_type,src,dest, text 
| apply detect_suspicious_dns_txt_records_using_pretrained_model_in_dsdl 
| rename predicted_is_unknown as is_suspicious_score 
| where is_suspicious_score > 0.5 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table src,dest,text,record_type, firstTime, lastTime,is_suspicious_score 
| `detect_suspicious_dns_txt_records_using_pretrained_model_in_dsdl_filter`"
Common Ransomware Extensions,"The following analytic detects modifications to files with extensions commonly associated with ransomware. It leverages the Endpoint.Filesystem data model to identify changes in file extensions that match known ransomware patterns. This activity is significant because it suggests an attacker is attempting to encrypt or alter files, potentially leading to severe data loss and operational disruption.",Windows Events,Impact,T1485,"| tstats `security_content_summariesonly` 
min(_time) as firstTime 
max(_time) as lastTime 
count latest(Filesystem.user) as user 
values(Filesystem.file_path) as file_path 
from datamodel=Endpoint.Filesystem
where NOT Filesystem.file_name IN (
""*.bat"",
""*.cmd"",
""*.com"",
""*.cpl"",
""*.dll"",
""*.doc"",
""*.docx"",
""*.exe"",
""*.gif"",
""*.jar"",
""*.jpeg"",
""*.jpg"",
""*.js"",
""*.lnk"",
""*.pif"",
""*.png"",
""*.ppt"",
""*.pptx"",
""*.ps1"",
""*.psm1"",
""*.scr"",
""*.sys"",
""*.txt"",
""*.vbs"",
""*.wsf"",
""*.xls"",
""*.xlsx""
)
by Filesystem.action Filesystem.dest
Filesystem.file_access_time Filesystem.file_create_time 
Filesystem.file_hash Filesystem.file_modify_time
Filesystem.file_name Filesystem.file_path 
Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id 
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)` 
| rex field=file_name ""(?<file_extension>(\.[^\.]+){1,2})$""
| lookup update=true ransomware_extensions_lookup Extensions AS file_extension OUTPUT Extensions Name 
| search Name !=False 
| stats min(firstTime) as firstTime 
max(lastTime) as lastTime 
dc(file_path) as path_count 
dc(file_name) as file_count 
values(action) as action 
values(file_access_time) as file_access_time 
values(file_create_time) as file_create_time 
values(file_hash) as file_hash 
values(file_modify_time) as file_modify_time
values(file_acl) as file_acl 
values(file_size) as file_size 
values(file_path) as file_path 
values(process_guid) as process_guid 
values(process_id) as process_id 
values(user) as user 
values(vendor_product) as vendor_product 
values(file_name) as file_name 
values(file_extension) as file_extension 
values(Name) as Name 
by dest 
| where path_count > 1 OR file_count > 20 
| `common_ransomware_extensions_filter`"
Detect Remote Access Software Usage File,"The following analytic detects the writing of files from known remote access software to disk within the environment. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on file path, file name, and user information. This activity is significant as adversaries often use remote access tools like AnyDesk, GoToMyPC, LogMeIn, and TeamViewer to maintain unauthorized access.",Windows Events,"Collection, Command And Control, Exfiltration",T1219,"| tstats `security_content_summariesonly`
count min(_time) as firstTime,
max(_time) as lastTime
values(Filesystem.file_path) as file_path
from datamodel=Endpoint.Filesystem
where Filesystem.file_name IN (
""*.app"",
""*.exe"",
""*.msi"",
""*.pkg"",
""*echoware.dll"",
""*Idrive.*"",
""*rdp2tcp.py""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `drop_dm_object_name(Filesystem)`
| lookup remote_access_software remote_utility AS file_name OUTPUT isutility, description as signature, comment_reference as desc, category
| search isutility = TRUE
| `remote_access_software_usage_exceptions`
| `detect_remote_access_software_usage_file_filter`"
Windows DotNet Binary in Non Standard Path,"The following analytic detects the execution of native .NET binaries from non-standard directories within the Windows operating system. It leverages Endpoint Detection and Response (EDR) telemetry, comparing process names and original file names against a predefined lookup &quot;is_net_windows_file&quot;. This activity is significant because adversaries may move .NET binaries to unconventional paths to evade detection and execute malicious code.",Windows Events,"Execution, Persistence, Defense Evasion","T1036.003, T1218.004, T1036","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime
FROM datamodel=Endpoint.Processes where
NOT Processes.process_path IN (
""*:\\Windows\\ADWS\\*"",
""*:\\Windows\\Microsoft.NET\\*"",
""*:\\Windows\\NetworkController\\*"",
""*:\\Windows\\System32\\*"",
""*:\\Windows\\SystemApps\\*"",
""*:\\Windows\\SysWOW64\\*"",
""*:\\Windows\\WinSxS\\*""
)
(
[ 
| inputlookup is_net_windows_file
| search netFile=true
| fields originalFileName
| rename originalFileName as Processes.original_file_name
| format
]
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(""Processes"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup update=true is_net_windows_file filename as process_name OUTPUT netFile
| lookup update=true is_net_windows_file originalFileName as original_file_name OUTPUT netFile
| search netFile=true
| `windows_dotnet_binary_in_non_standard_path_filter`"
3CX Supply Chain Attack Network Indicators,"The following analytic identifies DNS queries to domains associated with the 3CX supply chain attack. It leverages the Network_Resolution datamodel to detect these suspicious domain indicators. This activity is significant because it can indicate a potential compromise stemming from the 3CX supply chain attack, which is known for distributing malicious software through trusted updates.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Initial Access,T1195.002,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Network_Resolution where
DNS.query=*
NOT DNS.query IN (""-"", ""unknown"")
by DNS.answer DNS.answer_count DNS.query
DNS.query_count DNS.reply_code_id DNS.src
DNS.vendor_product
| `drop_dm_object_name(DNS)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup 3cx_ioc_domains domain as query OUTPUT Description isIOC
| search isIOC=true
| `3cx_supply_chain_attack_network_indicators_filter`"
Detect Remote Access Software Usage DNS,"The following analytic detects DNS queries to domains associated with known remote access software such as AnyDesk, GoToMyPC, LogMeIn, and TeamViewer. This detection is crucial as adversaries often use these tools to maintain access and control over compromised environments. Identifying such behavior is vital for a Security Operations Center (SOC) because unauthorized remote access can lead to data breaches, ransomware attacks, and other severe impacts if these threats are not mitigated promptly.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Collection, Impact, Command And Control",T1219,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Network_Resolution where
DNS.query=*
NOT DNS.query IN (""-"", ""unknown"")
by DNS.answer DNS.answer_count DNS.query
DNS.query_count DNS.reply_code_id DNS.src
DNS.vendor_product
| `drop_dm_object_name(""DNS"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup remote_access_software remote_domain AS query OUTPUT isutility, description as signature,
comment_reference as desc, category
| eval dest = query
| search isutility = True
| `remote_access_software_usage_exceptions`
| `detect_remote_access_software_usage_dns_filter`"
Detect Remote Access Software Usage Traffic,"The following analytic detects network traffic associated with known remote access software applications, such as AnyDesk, GoToMyPC, LogMeIn, and TeamViewer. It leverages Palo Alto traffic logs mapped to the Network_Traffic data model in Splunk. This activity is significant because adversaries often use remote access tools to maintain unauthorized access to compromised environments. If confirmed malicious, this activity could allow attackers to control systems remotely, exfiltrate data, or deploy additional malware, posing a severe threat to the organization's security.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Collection, Command And Control",T1219,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
values(All_Traffic.dest_port) as dest_port
latest(All_Traffic.user) as user
from datamodel=Network_Traffic where
All_Traffic.app=*
NOT All_Traffic.app IN (""-"", ""unknown"")
by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in
All_Traffic.bytes_out All_Traffic.dest All_Traffic.dest_ip
All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip
All_Traffic.src_port All_Traffic.transport All_Traffic.user
All_Traffic.vendor_product
| `drop_dm_object_name(""All_Traffic"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup remote_access_software remote_appid AS app OUTPUT isutility, description as signature, comment_reference as desc, category
| search isutility = True
| `remote_access_software_usage_exceptions`
| `detect_remote_access_software_usage_traffic_filter`"
Detect Remote Access Software Usage URL,"The following analytic detects the execution of known remote access software within the environment. It leverages network logs mapped to the Web data model, identifying specific URLs and user agents associated with remote access tools like AnyDesk, GoToMyPC, LogMeIn, and TeamViewer. This activity is significant as adversaries often use these utilities to maintain unauthorized remote access.",Zscaler Proxy,"Collection, Execution, Command And Control",T1219,"| tstats count min(_time) as firstTime
max(_time) as lastTime
latest(Web.http_method) as http_method
latest(Web.http_user_agent) as http_user_agent
latest(Web.url) as url
latest(Web.user) as user
latest(Web.dest) as dest
from datamodel=Web where
Web.url_domain=*
NOT Web.url_domain IN (""-"", ""unknown"")
by Web.action Web.src Web.category Web.url_domain Web.url_length
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `drop_dm_object_name(""Web"")`
| lookup remote_access_software remote_domain AS url_domain OUTPUT isutility, description as signature, comment_reference
as desc, category
| search isutility = True
| `remote_access_software_usage_exceptions`
| `detect_remote_access_software_usage_url_filter`"
File with Samsam Extension,"The following analytic detects file writes with extensions indicative of a SamSam ransomware attack. It leverages file-system activity data to identify file names ending in .stubbin, .berkshire, .satoshi, .sophos, or .keyxml. This activity is significant because SamSam ransomware is highly destructive, leading to file encryption and ransom demands. If confirmed malicious, the impact includes significant financial losses, operational disruptions, and reputational damage.",Windows Events,Impact,,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
values(Filesystem.user) as user
values(Filesystem.dest) as dest
values(Filesystem.file_path) as file_path
from datamodel=Endpoint.Filesystem where
Filesystem.file_name IN (
""*.berkshire"",
""*.keyxml"",
""*.satoshi"",
""*.sophos"",
""*.stubbin""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(lastTime)`
| `security_content_ctime(firstTime)`
| rex field=file_name ""(?<file_extension>\.[^\.]+)$""
| search file_extension IN ("".berkshire"", "".keyxml"", "".satoshi"", "".sophos"", "".stubbin"")
| `file_with_samsam_extension_filter`"
O365 New MFA Method Registered,"The following analytic detects the registration of a new Multi-Factor Authentication (MFA) method for a user account within Office 365. It leverages O365 audit logs to identify changes in MFA configurations. This activity is significant as it may indicate an attacker's attempt to maintain persistence on a compromised account. If confirmed malicious, the attacker could bypass existing security measures, solidify their access, and potentially escalate privileges or access sensitive data.",Office 365 (Microsoft 365),Persistence,"T1098, T1098.005","`o365_management_activity`
Workload=AzureActiveDirectory
Operation=""Update user.""
| eval propertyName = mvindex('ModifiedProperties{}.Name', 0)
| search propertyName IN (""StrongAuthenticationMethod"", ""StrongAuthenticationPhoneAppDetail"")
| eval oldvalue = mvindex('ModifiedProperties{}.OldValue',0)
| eval newvalue = mvindex('ModifiedProperties{}.NewValue',0)
| rex field=newvalue max_match=0 ""(?i)(?<new_method_type>MethodType
|DeviceName)""
| rex field=oldvalue max_match=0 ""(?i)(?<old_method_type>MethodType
|DeviceName)""
| eval count_new_method_type = coalesce(mvcount(new_method_type), 0)
| eval count_old_method_type = coalesce(mvcount(old_method_type), 0)
| where count_new_method_type > count_old_method_type
| fillnull
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(propertyName) as propertyName
by user newvalue oldvalue vendor_account
vendor_product dest signature src
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `o365_new_mfa_method_registered_filter`"
Common Ransomware Notes,"The following analytic detects the creation of files with names commonly associated with ransomware notes. It leverages file-system activity data from the Endpoint Filesystem data model, typically populated by endpoint detection and response (EDR) tools or Sysmon logs. This activity is significant because ransomware notes indicate a potential ransomware attack, which can lead to data encryption and extortion.",Windows Events,Impact,T1485,"| tstats `security_content_summariesonly`
count
min(_time) as firstTime
max(_time) as lastTime
values(Filesystem.user) as user
values(Filesystem.dest) as dest
values(Filesystem.file_path) as file_path
from datamodel=Endpoint.Filesystem
where [
| inputlookup ransomware_notes_lookup
| search status=true
| fields ransomware_notes
| dedup ransomware_notes
| rename ransomware_notes as Filesystem.file_name
]
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash
Filesystem.file_modify_time Filesystem.file_name
Filesystem.file_path Filesystem.file_acl Filesystem.file_size
Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(lastTime)`
| `security_content_ctime(firstTime)`
| `common_ransomware_notes_filter`"
Prohibited Network Traffic Allowed,"The following analytic detects instances where network traffic, identified by port and transport layer protocol as prohibited in the &quot;lookup_interesting_ports&quot; table, is allowed. It uses the Network_Traffic data model to cross-reference traffic data against predefined security policies. This activity is significant for a SOC as it highlights potential misconfigurations or policy violations that could lead to unauthorized access or data exfiltration.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration",T1048,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action IN (""allowed"", ""allow"") [
| inputlookup interesting_ports_lookup where is_prohibited=""true""Â  
| table dest_port transportÂ 
| dedup dest_port transportÂ  
| rename dest_port as All_Traffic.dest_port 
| rename transport as All_Traffic.transport] by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action All_Traffic.dvc All_Traffic.src_port All_Traffic.vendor_product All_Traffic.rule 
| lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port transport as All_Traffic.transport OUTPUT app is_prohibited note 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Traffic"")` 
| `prohibited_network_traffic_allowed_filter`"
Detect Rare Executables,"The following analytic detects the execution of rare processes that appear only once across the network within a specified timeframe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant for a SOC as it helps identify potentially malicious activities or unauthorized software, which could indicate a security breach or ongoing attack.",Windows Events,"Execution, Impact, Privilege Escalation",T1204,"| tstats `security_content_summariesonly`
dc(Processes.dest) as dc_dest
values(Processes.dest) as dest
values(Processes.user) as user
min(_time) as firstTime
max(_time) as lastTime
latest(Processes.action) as action
values(Processes.original_file_name) as original_file_name
values(Processes.parent_process) as parent_process
values(Processes.parent_process_exec) as parent_process_exec
latest(Processes.parent_process_guid) as parent_process_guid
latest(Processes.parent_process_id) as parent_process_id
values(Processes.parent_process_name) as parent_process_name
values(Processes.parent_process_path) as parent_process_path
values(Processes.process) as process
values(Processes.process_exec) as process_exec
latest(Processes.process_guid) as process_guid
values(Processes.process_hash) as process_hash
values(Processes.process_path) as process_path
latest(Processes.process_id) as process_id
latest(Processes.process_integrity_level) as process_integrity_level
latest(Processes.user_id) as user_id
latest(Processes.vendor_product) as vendor_product
from datamodel=Endpoint.Processes
by Processes.process_name
| `drop_dm_object_name(Processes)`
| search dc_dest < 10
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_rare_executables_filter`"
Cisco Duo Admin Login Unusual Browser,"The following analytic identifies instances where a Duo admin logs in using a browser other than Chrome, which is considered unusual based on typical access patterns. Please adjust as needed to your environment. The detection leverages Duo activity logs ingested via the Cisco Security Cloud App and filters for admin login actions where the browser is not Chrome.",Cisco Duo,"Impact, Credential Access, Privilege Escalation",T1556,"`cisco_duo_activity` ""action.name""=admin_login NOT access_device.browser IN (Chrome) 
| rename actor.name as user access_device.ip.address as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime by access_device.browser access_device.browser_version src_ip access_device.location.city access_device.location.country access_device.location.state access_device.os access_device.os_version actor.details actor.type outcome.result user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_admin_login_unusual_browser_filter`"
Cisco Duo Admin Login Unusual Country,"The following analytic detects instances where a Duo admin login originates from a country outside of the United States, which may indicate suspicious or unauthorized access attempts. Please adjust as needed to your environment. It works by analyzing Duo activity logs for admin login actions and filtering out events where the access device's country is not within the expected region.",Cisco Duo,"Lateral Movement, Credential Access, Impact",T1556,"`cisco_duo_activity` ""action.name""=admin_login NOT access_device.location.country IN (""United States"") 
| rename actor.name as user access_device.ip.address as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime by access_device.browser access_device.browser_version src_ip access_device.location.city access_device.location.country access_device.location.state access_device.os access_device.os_version actor.details actor.type outcome.result user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_admin_login_unusual_country_filter`"
Cisco Duo Admin Login Unusual Os,"The following analytic identifies Duo admin login attempts from operating systems that are unusual for your environment, excluding commonly used OS such as Mac OS X. Please adjust to your environment. It works by analyzing Duo activity logs for admin login actions and filtering out logins from expected operating systems. The analytic then aggregates events by browser, version, source IP, location, and OS details to highlight anomalies.",Cisco Duo,"Credential Access, Privilege Escalation",T1556,"`cisco_duo_activity` ""action.name""=admin_login NOT access_device.os IN (""Mac OS X"") 
| rename actor.name as user access_device.ip.address as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime by access_device.browser access_device.browser_version src_ip access_device.location.city access_device.location.country access_device.location.state access_device.os access_device.os_version actor.details actor.type outcome.result user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_admin_login_unusual_os_filter`"
Cisco Duo Bulk Policy Deletion,"The following analytic detects instances where a Duo administrator performs a bulk deletion of more than three policies in a single action. It identifies this behavior by searching Duo activity logs for the policy_bulk_delete action, extracting the names of deleted policies, and counting them. If the count exceeds three, the event is flagged. This behavior is significant for a Security Operations Center (SOC) because mass deletion of security policies can indicate malicious activity, such as an attacker or rogue administrator attempting to weaken or disable security controls, potentially paving the way for further compromise.",Cisco Duo,"Credential Access, Impact",T1556,"`cisco_duo_administrator` action=policy_bulk_delete 
| rename username as user 
| spath input=description 
| rex field=policies max_match=0 ""(?<policy_name>[^:,]+):\s+"" 
| eval policy_count=mvcount(policy_name) 
| where policy_count > 3 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email policy_count 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_bulk_policy_deletion_filter`"
Cisco Duo Bypass Code Generation,"The following analytic detects when a Duo user generates a bypass code, which allows them to circumvent multi-factor authentication (2FA) protections. It works by monitoring Duo activity logs for the 'bypass_create' action, renaming the affected object as the user, and aggregating events to identify instances where a bypass code is issued. This behavior is significant for a Security Operations Center (SOC) because generating a bypass code can enable attackers, malicious insiders, or unauthorized administrators to gain access to sensitive systems without the required second authentication factor.",Cisco Duo,"Lateral Movement, Credential Access",T1556,"`cisco_duo_administrator` action=bypass_create 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_bypass_code_generation_filter`"
Cisco Duo Policy Allow Devices Without Screen Lock,"The following analytic detects when a Duo policy is created or updated to allow devices without a screen lock requirement. It identifies this behavior by searching Duo administrator activity logs for policy creation or update events where the 'require_lock' setting is set to false. This action may indicate a weakening of device security controls, potentially exposing the organization to unauthorized access if devices are lost or stolen.",Cisco Duo,"Lateral Movement, Credential Access, Impact",T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search require_lock=false 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_allow_devices_without_screen_lock_filter`"
Cisco Duo Policy Allow Network Bypass 2FA,"The following analytic detects when a Duo policy is created or updated to allow network-based bypass of two-factor authentication (2FA). It identifies this behavior by searching Duo administrator logs for policy creation or update actions where the networks_allow field is present, indicating that specific networks have been permitted to bypass 2FA requirements. This is achieved by parsing the event description and filtering for relevant policy changes, then aggregating the results by user and administrator details.",Cisco Duo,"Lateral Movement, Credential Access",T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search networks_allow=* 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email networks_allow 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_allow_network_bypass_2fa_filter`"
Cisco Duo Policy Allow Old Flash,"The following analytic identifies instances where a Duo administrator creates or updates a policy to allow the use of outdated Flash components, specifically by detecting policy changes with the flash_remediation=no remediation attribute. It leverages Duo activity logs ingested via the Cisco Security Cloud App, searching for policy_update or policy_create actions and parsing the policy description for indicators of weakened security controls.",Cisco Duo,Credential Access,T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search flash_remediation=""no remediation"" 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_allow_old_flash_filter`"
Cisco Duo Policy Allow Old Java,"The following analytic detects when a Duo policy is created or updated to allow the use of outdated Java versions, which can introduce significant security risks. It works by searching Duo administrator activity logs for policy creation or update actions where the policy explicitly sets 'java_remediation' to 'no remediation', indicating that no restrictions are enforced against old Java.",Cisco Duo,Credential Access,T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search java_remediation=""no remediation"" 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_allow_old_java_filter`"
Cisco Duo Policy Allow Tampered Devices,"The following analytic detects when a Duo policy is created or updated to allow tampered or rooted devices, such as jailbroken smartphones, to access protected resources. It identifies this behavior by searching Duo administrator activity logs for policy changes where the allow_rooted_devices setting is enabled. This is accomplished by filtering for policy creation or update actions and parsing the policy description for the relevant configuration.",Cisco Duo,"Lateral Movement, Credential Access, Impact",T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search allow_rooted_devices=true 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_allow_tampered_devices_filter`"
Cisco Duo Policy Bypass 2FA,"The following analytic detects instances where a Duo policy is created or updated to allow access without two-factor authentication (2FA). It identifies this behavior by searching Duo administrator activity logs for policy changes that set the authentication status to &quot;Allow access without 2FA.&quot; By monitoring for these specific actions, the analytic highlights potential attempts to weaken authentication controls, which could be indicative of malicious activity or insider threats.",Cisco Duo,Credential Access,T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search auth_status=""Allow access without 2FA"" 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_bypass_2fa_filter`"
Cisco Duo Policy Deny Access,"The following analytic identifies instances where a Duo administrator creates or updates a policy to explicitly deny user access within the Duo environment. It detects this behavior by searching Duo administrator activity logs for policy creation or update actions where the authentication status is set to &quot;Deny access.&quot; By correlating these events with user and admin details, the analytic highlights potential misuse or malicious changes to access policies.",Cisco Duo,"Credential Access, Impact",T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search auth_status=""Deny access"" 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_deny_access_filter`"
Cisco Duo Policy Skip 2FA for Other Countries,The following analytic detects when a Duo policy is created or updated to allow access without two-factor authentication (2FA) for users in countries other than the default. It identifies this behavior by searching Duo administrator activity logs for policy creation or update actions where the policy description indicates that access is permitted without 2FA for certain user locations.,Cisco Duo,"Lateral Movement, Credential Access, Impact",T1556,"`cisco_duo_administrator` action=policy_update OR action=policy_create 
| spath input=description 
| search user_locations_default_action=""Allow access without 2FA"" 
| rename object as user 
| stats count min(_time) as firstTime max(_time) as lastTime by action actionlabel description user admin_email 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_policy_skip_2fa_for_other_countries_filter`"
Cisco Duo Set User Status to Bypass 2FA,"The following analytic detects instances where a Duo user's status is changed to &quot;Bypass&quot; for 2FA, specifically when the previous status was &quot;Active.&quot; This behavior is identified by analyzing Duo activity logs for user update actions, extracting the status transitions, and filtering for cases where a user is set to bypass multi-factor authentication. This is a critical event for a Security Operations Center (SOC) to monitor, as bypassing 2FA significantly weakens account security and may indicate malicious insider activity or account compromise.",Cisco Duo,"Credential Access, Impact",T1556,"`cisco_duo_activity` action.name=user_update 
| spath input=target.details path=status output=status 
| spath input=old_target.details path=status output=old_status 
| search status=Bypass old_status=Active 
| rename target.name as user access_device.ip.address as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime by access_device.browser access_device.browser_version src_ip access_device.location.city access_device.location.country access_device.location.state access_device.os access_device.os_version action.name actor.details actor.name actor.type old_target.details target.details status old_status user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_duo_set_user_status_to_bypass_2fa_filter`"
Detect Password Spray Attempts,"This analytic employs the 3-sigma approach to detect an unusual volume of failed authentication attempts from a single source. A password spray attack is a type of brute force attack where an attacker tries a few common passwords across many different accounts to avoid detection and account lockouts. By utilizing the Authentication Data Model, this detection is effective for all CIM-mapped authentication events, providing comprehensive coverage and enhancing security against these attacks.",Azure AD (Microsoft Entra ID),Credential Access,"T1110.003, T1110","| tstats `security_content_summariesonly` values(Authentication.user) AS unique_user_names dc(Authentication.user) AS unique_accounts values(Authentication.app) as app count(Authentication.user) as total_failures from datamodel=Authentication.Authentication where Authentication.action=""failure"" NOT Authentication.src IN (""-"",""unknown"") by Authentication.action Authentication.app Authentication.authentication_method Authentication.dest 
Authentication.signature Authentication.signature_id Authentication.src sourcetype _time span=5m  
| `drop_dm_object_name(""Authentication"")`
```fill out time buckets for 0-count events during entire search length```
| appendpipe [
| timechart limit=0 span=5m count 
| table _time] 
| fillnull value=0 unique_accounts
``` Create aggregation field & apply to all null events```
| eval counter=src+""__""+sourcetype+""__""+signature_id  
| eventstats values(counter) as fnscounter  
| eval counter=coalesce(counter,fnscounter) 
``` stats version of mvexpand ```
| stats values(app) as app values(unique_user_names) as unique_user_names values(total_failures) as total_failures values(src) as src values(signature_id) as signature_id values(sourcetype) as sourcetype count by counter unique_accounts _time
``` remove duplicate time buckets for each unique source```
| sort - _time unique_accounts 
| dedup _time counter
```Find the outliers```
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by counter 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 30 and unique_accounts >= upperBound, 1, 0) 
| replace ""::ffff:*"" with * in src  
| where isOutlier=1  
| foreach * 
[ eval <<FIELD>> = if(<<FIELD>>=""null"",null(),<<FIELD>>)] 
| table _time, src, action, app, unique_accounts, unique_user_names, total_failures, sourcetype, signature_id, counter 
| `detect_password_spray_attempts_filter`"
Email Attachments With Lots Of Spaces,"The following analytic detects email attachments with an unusually high number of spaces in their file names, which is a common tactic used by attackers to obfuscate file extensions.",Proofpoint,Execution,,"| tstats `security_content_summariesonly` count values(All_Email.recipient) as recipient_address min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name=""*"" by All_Email.src_user, All_Email.file_name All_Email.message_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Email"")` 
| eval space_ratio = (mvcount(split(file_name,"" ""))-1)/len(file_name) 
| search space_ratio >= 0.1 
|  rex field=recipient_address ""(?<recipient_user>.*)@"" 
| `email_attachments_with_lots_of_spaces_filter`"
Monitor Email For Brand Abuse,The following analytic identifies emails claiming to be sent from a domain similar to one you are monitoring for potential abuse.,Proofpoint,,,"| tstats `security_content_summariesonly` values(All_Email.recipient) as recipients, min(_time) as firstTime, max(_time) as lastTime from datamodel=Email by All_Email.src_user, All_Email.message_id 
| `drop_dm_object_name(""All_Email"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval temp=split(src_user, ""@"") 
| eval email_domain=mvindex(temp, 1) 
| lookup update=true brandMonitoring_lookup domain as email_domain OUTPUT domain_abuse 
| search domain_abuse=true 
| table message_id, src_user, email_domain, recipients, firstTime, lastTime 
| `monitor_email_for_brand_abuse_filter`"
No Windows Updates in a time frame,The following analytic identifies Windows endpoints that have not generated an event indicating a successful Windows update in the last 60 days.,Windows Events,,,"| tstats `security_content_summariesonly` max(_time) as lastTime from datamodel=Updates where Updates.status=Installed Updates.vendor_product=""Microsoft Windows"" by Updates.dest Updates.status Updates.vendor_product 
| rename Updates.dest as Host 
| rename Updates.status as ""Update Status"" 
| rename Updates.vendor_product as Product 
| eval isOutlier=if(lastTime <= relative_time(now(), ""-60d@d""), 1, 0)  
| `security_content_ctime(lastTime)`  
| search isOutlier=1 
| rename lastTime as ""Last Update Time"", 
| table Host, ""Update Status"", Product, ""Last Update Time"" 
| `no_windows_updates_in_a_time_frame_filter`"
Suspicious Email Attachment Extensions,The following analytic detects emails containing attachments with suspicious file extensions.,Proofpoint,"Initial Access, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Email.All_Email where All_Email.file_name=""*""
by All_Email.src_user All_Email.file_name All_Email.file_size All_Email.message_id
All_Email.message_info All_Email.process All_Email.process_id All_Email.orig_dest
All_Email.orig_recipient
| `drop_dm_object_name(All_Email)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup update=true is_suspicious_file_extension_lookup file_name OUTPUT suspicious
| search suspicious=true
| `suspicious_email_attachment_extensions_filter`"
Abnormally High Number Of Cloud Infrastructure API Calls,The following analytic detects a spike in the number of API calls made to your cloud infrastructure by a user. It leverages cloud infrastructure logs and compares the current API call volume against a baseline probability density function to identify anomalies. This activity is significant because an unusual increase in API calls can indicate potential misuse or compromise of cloud resources.,Windows Events,"Exfiltration, Defense Evasion",T1078.004,"| tstats count as api_calls values(All_Changes.command) as command from datamodel=Change where All_Changes.user!=unknown All_Changes.status=success by All_Changes.user _time span=1h 
| `drop_dm_object_name(""All_Changes"")` 
| eval HourOfDay=strftime(_time, ""%H"") 
| eval HourOfDay=floor(HourOfDay/4)*4 
| eval DayOfWeek=strftime(_time, ""%w"") 
| eval isWeekend=if(DayOfWeek >= 1 AND DayOfWeek <= 5, 0, 1) 
| join user HourOfDay isWeekend [ summary cloud_excessive_api_calls_v1] 
| where cardinality >=16 
| apply cloud_excessive_api_calls_v1 threshold=0.005 
| rename ""IsOutlier(api_calls)"" as isOutlier 
| where isOutlier=1 
| eval expected_upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), "":""), 0) 
| where api_calls > expected_upper_threshold 
| eval distance_from_threshold = api_calls - expected_upper_threshold 
| table _time, user, command, api_calls, expected_upper_threshold, distance_from_threshold 
| `abnormally_high_number_of_cloud_infrastructure_api_calls_filter`"
Abnormally High Number Of Cloud Security Group API Calls,"The following analytic detects a spike in the number of API calls made to cloud security groups by a user. It leverages data from the Change data model, focusing on successful firewall-related changes. This activity is significant because an abnormal increase in security group API calls can indicate potential malicious activity, such as unauthorized access or configuration changes.",Windows Events,Defense Evasion,T1078.004,"| tstats count as security_group_api_calls values(All_Changes.command) as command from datamodel=Change where All_Changes.object_category=firewall AND All_Changes.status=success by All_Changes.user _time span=1h 
| `drop_dm_object_name(""All_Changes"")` 
| eval HourOfDay=strftime(_time, ""%H"") 
| eval HourOfDay=floor(HourOfDay/4)*4 
| eval DayOfWeek=strftime(_time, ""%w"") 
| eval isWeekend=if(DayOfWeek >= 1 AND DayOfWeek <= 5, 0, 1) 
| join user HourOfDay isWeekend [ summary cloud_excessive_security_group_api_calls_v1] 
| where cardinality >=16 
| apply cloud_excessive_security_group_api_calls_v1 threshold=0.005 
| rename ""IsOutlier(security_group_api_calls)"" as isOutlier 
| where isOutlier=1 
| eval expected_upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), "":""), 0) 
| where security_group_api_calls > expected_upper_threshold 
| eval distance_from_threshold = security_group_api_calls - expected_upper_threshold 
| table _time, user, command, security_group_api_calls, expected_upper_threshold, distance_from_threshold 
| `abnormally_high_number_of_cloud_security_group_api_calls_filter`"
ASL AWS Detect Users creating keys with encrypt policy without MFA,"The following analytic detects the creation of AWS KMS keys with an encryption policy accessible to everyone, including external entities. It leverages AWS CloudTrail logs from Amazon Security Lake to identify CreateKey or PutKeyPolicy events where the kms:Encrypt action is granted to all principals. This activity is significant as it may indicate a compromised account, allowing an attacker to misuse the encryption key to target other organizations.",AWS CloudTrail,Impact,T1486,"`amazon_security_lake` api.operation=PutKeyPolicy OR api.operation=CreateKey 
| spath input=api.request.data path=policy output=policy 
| spath input=policy 
| rename Statement{}.Action as Action, Statement{}.Principal as Principal 
| eval Statement=mvzip(Action,Principal,""
|"") 
| mvexpand Statement 
| eval action=mvindex(split(Statement, ""
|""), 0) 
| eval principal=mvindex(split(Statement, ""
|""), 1) 
| search action=kms* 
| regex principal=""\*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
|`asl_aws_detect_users_creating_keys_with_encrypt_policy_without_mfa_filter`"
ASL AWS ECR Container Upload Unknown User,"The following analytic detects unauthorized container uploads to AWS Elastic Container Service (ECR) by monitoring AWS CloudTrail events. It identifies instances where a new container is uploaded by a user not previously recognized as authorized. This detection is crucial for a SOC as it can indicate a potential compromise or misuse of AWS ECR, which could lead to unauthorized access to sensitive data or the deployment of malicious containers.",AWS CloudTrail,"Execution, Impact","T1204.003, T1204","`amazon_security_lake` api.operation=PutImage NOT `aws_ecr_users_asl` 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_ecr_container_upload_unknown_user_filter`"
AWS Detect Users creating keys with encrypt policy without MFA,"The following analytic detects the creation of AWS KMS keys with an encryption policy accessible to everyone, including external entities. It leverages AWS CloudTrail logs to identify CreateKey or PutKeyPolicy events where the kms:Encrypt action is granted to all principals. This activity is significant as it may indicate a compromised account, allowing an attacker to misuse the encryption key to target other organizations.",AWS CloudTrail,Impact,T1486,"`cloudtrail` eventName=CreateKey OR eventName=PutKeyPolicy 
| spath input=requestParameters.policy output=key_policy_statements path=Statement{} 
| mvexpand key_policy_statements 
| spath input=key_policy_statements output=key_policy_action_1 path=Action 
| spath input=key_policy_statements output=key_policy_action_2 path=Action{} 
| eval key_policy_action=mvappend(key_policy_action_1,key_policy_action_2) 
| spath input=key_policy_statements output=key_policy_principal path=Principal.AWS 
| search key_policy_action=""kms:Encrypt"" AND key_policy_principal=""*"" 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product key_policy_action key_policy_principal 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
|`aws_detect_users_creating_keys_with_encrypt_policy_without_mfa_filter`"
AWS ECR Container Scanning Findings High,"The following analytic identifies high-severity findings from AWS Elastic Container Registry (ECR) image scans. It detects these activities by analyzing AWS CloudTrail logs for the DescribeImageScanFindings event, specifically filtering for findings with a high severity level. This activity is significant for a SOC because high-severity vulnerabilities in container images can lead to potential exploitation if not addressed.",AWS CloudTrail,Execution,T1204.003,"`cloudtrail` eventSource=ecr.amazonaws.com eventName=DescribeImageScanFindings 
| spath path=responseElements.imageScanFindings.findings{} output=findings 
| mvexpand findings 
| spath input=findings 
| search severity=HIGH 
| rename name as finding_name, description as finding_description, requestParameters.imageId.imageDigest as imageDigest, requestParameters.repositoryName as repository 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product finding_name finding_description imageDigest repository 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ecr_container_scanning_findings_high_filter`"
AWS ECR Container Scanning Findings Low Informational Unknown,"The following analytic identifies low, informational, or unknown severity findings from AWS Elastic Container Registry (ECR) image scans. It leverages AWS CloudTrail logs, specifically the DescribeImageScanFindings event, to detect these findings. This activity is significant for a SOC as it helps in early identification of potential vulnerabilities or misconfigurations in container images, which could be exploited if left unaddressed.",AWS CloudTrail,Execution,T1204.003,"`cloudtrail` eventSource=ecr.amazonaws.com eventName=DescribeImageScanFindings 
| spath path=responseElements.imageScanFindings.findings{} output=findings 
| mvexpand findings 
| spath input=findings 
| search severity IN (""LOW"", ""INFORMATIONAL"", ""UNKNOWN"") 
| rename name as finding_name, description as finding_description, requestParameters.imageId.imageDigest as imageDigest, requestParameters.repositoryName as repository 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product finding_name finding_description imageDigest repository 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ecr_container_scanning_findings_low_informational_unknown_filter`"
AWS ECR Container Scanning Findings Medium,"The following analytic identifies medium-severity findings from AWS Elastic Container Registry (ECR) image scans. It leverages AWS CloudTrail logs, specifically the DescribeImageScanFindings event, to detect vulnerabilities in container images. This activity is significant for a SOC as it highlights potential security risks in containerized applications, which could be exploited if not addressed. If confirmed malicious, these vulnerabilities could lead to unauthorized access, data breaches, or further exploitation within the container environment, compromising the overall security posture.",AWS CloudTrail,Execution,T1204.003,"`cloudtrail` eventSource=ecr.amazonaws.com eventName=DescribeImageScanFindings 
| spath path=responseElements.imageScanFindings.findings{} output=findings 
| mvexpand findings 
| spath input=findings 
| search severity=MEDIUM 
| rename name as finding_name, description as finding_description, requestParameters.imageId.imageDigest as imageDigest, requestParameters.repositoryName as repository 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product finding_name finding_description imageDigest repository 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ecr_container_scanning_findings_medium_filter`"
AWS ECR Container Upload Unknown User,"The following analytic detects the upload of a new container image to AWS Elastic Container Registry (ECR) by an unknown user. It leverages AWS CloudTrail logs to identify PutImage events from the ECR service, filtering out known users. This activity is significant because container uploads should typically be performed by a limited set of authorized users.",AWS CloudTrail,"Execution, Exfiltration","T1204.003, T1204","`cloudtrail` eventSource=ecr.amazonaws.com eventName=PutImage NOT `aws_ecr_users` 
| rename requestParameters.* as * 
| rename repositoryName AS image 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature user user_agent src vendor_account vendor_region vendor_product image 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ecr_container_upload_unknown_user_filter`"
Azure AD AzureHound UserAgent Detected,"This detection identifies the presence of the default AzureHound user-agent string within Microsoft Graph Activity logs and NonInteractive SignIn Logs. AzureHound is a tool used for gathering information about Azure Active Directory environments, often employed by security professionals for legitimate auditing purposes. However, it can also be leveraged by malicious actors to perform reconnaissance activities, mapping out the Azure AD infrastructure to identify potential vulnerabilities and targets for further exploitation.",Azure AD (Microsoft Entra ID),"Discovery, Privilege Escalation","T1087.004, T1526","`azure_monitor_aad` category IN (MicrosoftGraphActivityLogs, NonInteractiveUserSignInLogs) properties.userAgent=azurehound* 
| rename properties.userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent signature 
| iplocation src 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_azurehound_useragent_detected_filter`"
Azure AD Service Principal Enumeration,"This detection leverages azure graph activity logs to identify when graph APIs have been used to identify 10 or more service principals. This type of behaviour is associated with tools such as Azure enumberation tools such as AzureHound or ROADtools.
Search 1`azure_monitor_aad` category IN (MicrosoftGraphActivityLogs) TERM(servicePrincipals) 2| fillnull 3| rex field=&#34;properties.requestUri&#34; &#34;https\:\/\/graph.microsoft.com\/beta\/servicePrincipals\/(?P&lt;servicePrincipalb&gt;.*?)\/&#34; 4| rex field=&#34;properties.",Azure AD (Microsoft Entra ID),"Discovery, Privilege Escalation","T1087.004, T1526","`azure_monitor_aad` category IN (MicrosoftGraphActivityLogs) TERM(servicePrincipals) 
| fillnull 
| rex field=""properties.requestUri"" ""https\:\/\/graph.microsoft.com\/beta\/servicePrincipals\/(?P<servicePrincipalb>.*?)\/"" 
| rex field=""properties.requestUri"" ""https\:\/\/graph.microsoft.com\/v1.0\/servicePrincipals\/(?P<servicePrincipalv1>.*?)\/"" 
| eval spn=coalesce(servicePrincipalb,servicePrincipalv1) 
| fillnull 
| stats count min(_time) as _time dc(spn) as spn_count values(user_id) as user_id by dest user src vendor_account vendor_product signature 
| where spn_count>9 
| `azure_ad_service_principal_enumeration_filter`"
Azure AD Service Principal Privilege Escalation,"This detection identifies when an Azure Service Principal elevates privileges by adding themself to a new app role assignment.
Search 1`azure_monitor_aad` category=AuditLogs operationName=&#34;Add app role assignment to service principal&#34; properties.initiatedBy.app.displayName=* properties.result=Success 2| spath path=properties{}.targetResources{}.modifiedProperties{} output=targetResources 3| rename properties.* as * 4| eval user=&#34;NA&#34; 5| eval src=&#34;NA&#34; 6| stats min(_time) as firstTime max(_time) as lastTime values(eval(mvfilter(match(targetResources, &#34;AppRole.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation",T1098.003,"`azure_monitor_aad` category=AuditLogs operationName=""Add app role assignment to service principal"" properties.initiatedBy.app.displayName=* properties.result=Success 
| spath path=properties{}.targetResources{}.modifiedProperties{} output=targetResources 
| rename properties.* as * 
| eval user=""NA"" 
| eval src=""NA"" 
| stats min(_time) as firstTime max(_time) as lastTime values(eval(mvfilter(match(targetResources, ""AppRole.Value"")))) as appRole, values(eval(mvfilter(match(targetResources, ""ServicePrincipal.DisplayName"")))) as targetServicePrincipal values(eval(mvindex('properties.targetResources{}.displayName',0))) as targetAppContext values(user_agent) as user_agent values(identity) as servicePrincipal values(properties.initiatedBy.app.servicePrincipalId) as servicePrincipalId by dest user src vendor_account vendor_product signature 
| spath input=appRole path=newValue output=appRole 
| spath input=targetServicePrincipal path=newValue output=targetServicePrincipal 
| eval appRole=trim(replace(appRole, ""\"""", """")), targetServicePrincipal=trim(replace(targetServicePrincipal, ""\"""", """")) 
| where servicePrincipal=targetServicePrincipal 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_service_principal_privilege_escalation_filter`"
Circle CI Disable Security Job,"The following analytic detects the disabling of security jobs in CircleCI pipelines. It leverages CircleCI log data, renaming and extracting fields such as job names, workflow IDs, user information, commit messages, URLs, and branches. The detection identifies mandatory jobs for each workflow and checks if they were executed. This activity is significant because disabling security jobs can allow malicious code to bypass security checks, leading to potential data breaches, system downtime, and reputational damage.",CircleCI,"Execution, Persistence",T1554,"`circleci` 
| rename vcs.committer_name as user vcs.subject as commit_message vcs.url as url workflows.* as *  
| stats values(job_name) as job_names by workflow_id workflow_name user commit_message url branch 
| lookup mandatory_job_for_workflow workflow_name OUTPUTNEW job_name AS mandatory_job 
| search mandatory_job=* 
| eval mandatory_job_executed=if(like(job_names, ""%"".mandatory_job.""%""), 1, 0) 
| where mandatory_job_executed=0 
| eval phase=""build"" 
| rex field=url ""(?<repository>[^\/]*\/[^\/]*)$"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `circle_ci_disable_security_job_filter`"
Circle CI Disable Security Step,The following analytic detects the disablement of security steps in a CircleCI pipeline.,CircleCI,Persistence,T1554,"`circleci` 
| rename workflows.job_id AS job_id 
| join job_id [ 
| search `circleci` 
| stats values(name) as step_names count by job_id job_name ] 
| stats count by step_names job_id job_name vcs.committer_name vcs.subject vcs.url owners{} 
| rename vcs.* as * , owners{} as user 
| lookup mandatory_step_for_job job_name OUTPUTNEW step_name AS mandatory_step 
| search mandatory_step=* 
| eval mandatory_step_executed=if(like(step_names, ""%"".mandatory_step.""%""), 1, 0) 
| where mandatory_step_executed=0 
| rex field=url ""(?<repository>[^\/]*\/[^\/]*)$"" 
| eval phase=""build""  
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `circle_ci_disable_security_step_filter`"
Cloud API Calls From Previously Unseen User Roles,The following analytic detects cloud API calls executed by user roles that have not previously run these commands. It leverages the Change data model in Splunk to identify commands executed by users with the user_type of AssumedRole and a status of success. This activity is significant because new commands from different user roles can indicate potential malicious activity or unauthorized actions.,Windows Events,Defense Evasion,T1078,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Change where All_Changes.user_type=AssumedRole AND All_Changes.status=success by All_Changes.user, All_Changes.command All_Changes.object 
| `drop_dm_object_name(""All_Changes"")` 
| lookup previously_seen_cloud_api_calls_per_user_role user as user, command as command OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenUserApiCall=min(firstTimeSeen) 
| where isnull(firstTimeSeenUserApiCall) OR firstTimeSeenUserApiCall > relative_time(now(),""-24h@h"") 
| table firstTime, user, object, command 
|`security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `cloud_api_calls_from_previously_unseen_user_roles_filter`"
Detect Spike in AWS Security Hub Alerts for EC2 Instance,"The following analytic identifies a spike in the number of AWS Security Hub alerts for an EC2 instance within a 4-hour interval. It leverages AWS Security Hub findings data, calculating the average and standard deviation of alerts to detect anomalies. This activity is significant for a SOC as a sudden increase in alerts may indicate potential security incidents or misconfigurations requiring immediate attention.",AWS CloudTrail,Exfiltration,,"`aws_securityhub_finding` ""Resources{}.Type""=AWSEC2Instance 
| bucket span=4h _time 
| stats count AS alerts values(Title) as Title values(Types{}) as Types values(vendor_account) as vendor_account values(vendor_region) as vendor_region values(severity) as severity by _time dest 
| eventstats avg(alerts) as total_alerts_avg, stdev(alerts) as total_alerts_stdev 
| eval threshold_value = 3 
| eval isOutlier=if(alerts > total_alerts_avg+(total_alerts_stdev * threshold_value), 1, 0) 
| search isOutlier=1 
| table _time dest alerts Title Types vendor_account vendor_region severity isOutlier total_alerts_avg 
| `detect_spike_in_aws_security_hub_alerts_for_ec2_instance_filter`"
Detect Spike in AWS Security Hub Alerts for User,The following analytic identifies a spike in the number of AWS Security Hub alerts for an AWS IAM User within a 4-hour interval.,AWS CloudTrail,,,"`aws_securityhub_finding` ""findings{}.Resources{}.Type""= AwsIamUser 
| rename findings{}.Resources{}.Id as user 
| bucket span=4h _time 
| stats count AS alerts by _time user 
| eventstats avg(alerts) as total_launched_avg, stdev(alerts) as total_launched_stdev 
| eval threshold_value = 2 
| eval isOutlier=if(alerts > total_launched_avg+(total_launched_stdev * threshold_value), 1, 0) 
| search isOutlier=1 
| table _time user alerts 
|`detect_spike_in_aws_security_hub_alerts_for_user_filter`"
GitHub Enterprise Delete Branch Ruleset,"The following analytic detects when branch rules are deleted in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for branch rule deletion events by tracking actor details, repository information, and associated metadata. For a SOC, identifying deleted branch rules is critical as it could indicate attempts to bypass code review requirements and security controls.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_enterprise` action=repository_ruleset.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, action, ruleset_name 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_delete_branch_ruleset_filter`"
GitHub Enterprise Disable 2FA Requirement,"The following analytic detects when two-factor authentication (2FA) requirements are disabled in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for 2FA requirement changes by tracking actor details, organization information, and associated metadata. For a SOC, identifying disabled 2FA requirements is critical as it could indicate attempts to weaken account security controls. Two-factor authentication is a fundamental security control that helps prevent unauthorized access even if passwords are compromised.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_enterprise` action=org.disable_two_factor_requirement OR action=business.disable_two_factor_requirement 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, user_agent, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_disable_2fa_requirement_filter`"
GitHub Enterprise Disable Audit Log Event Stream,"The following analytic detects when a user disables audit log event streaming in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for configuration changes that disable the audit log streaming functionality, which is used to send audit events to security monitoring platforms. This behavior could indicate an attacker attempting to prevent their malicious activities from being logged and detected by disabling the audit trail.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1562.008, T1195","`github_enterprise` action=audit_log_streaming.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, user_agent, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_disable_audit_log_event_stream_filter`"
GitHub Enterprise Disable Classic Branch Protection Rule,"The following analytic detects when classic branch protection rules are disabled in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for branch protection removal events by tracking actor details, repository information, and associated metadata. For a SOC, identifying disabled branch protection is critical as it could indicate attempts to bypass code review requirements and security controls.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_enterprise` action=protected_branch.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, action, name 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_disable_classic_branch_protection_rule_filter`"
GitHub Enterprise Disable Dependabot,"The following analytic detects when a user disables Dependabot security features within a GitHub repository. Dependabot helps automatically identify and fix security vulnerabilities in dependencies. The detection monitors GitHub Enterprise logs for configuration changes that disable Dependabot functionality. This behavior could indicate an attacker attempting to prevent the automatic detection of vulnerable dependencies, which would allow them to exploit known vulnerabilities that would otherwise be patched.",GitHub Enterprise,"Initial Access, Execution, Impact, Defense Evasion","T1195, T1562.001","`github_enterprise` action=repository_vulnerability_alerts.disable 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user, user_agent, user_id, action 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_disable_dependabot_filter`"
GitHub Enterprise Disable IP Allow List,The following analytic identifies when an IP allow list is disabled in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for actions related to disabling IP allow lists at the organization or enterprise level. This behavior is concerning because IP allow lists are a critical security control that restricts access to GitHub Enterprise resources to only trusted IP addresses.,GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_enterprise` action=ip_allow_list.disable 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, user_agent, user_id, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_disable_ip_allow_list_filter`"
GitHub Enterprise Modify Audit Log Event Stream,"The following analytic detects when a user modifies or disables audit log event streaming in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for configuration changes that affect the audit log streaming functionality, which is used to send audit events to security monitoring platforms. This behavior could indicate an attacker attempting to prevent their malicious activities from being logged and detected by tampering with the audit trail.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1562.008, T1195","`github_enterprise` action=audit_log_streaming.update 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, user_agent, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_modify_audit_log_event_stream_filter`"
GitHub Enterprise Pause Audit Log Event Stream,"The following analytic detects when a user pauses audit log event streaming in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for configuration changes that temporarily suspend the audit log streaming functionality, which is used to send audit events to security monitoring platforms. This behavior could indicate an attacker attempting to prevent their malicious activities from being logged and detected by temporarily disabling the audit trail.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1562.008, T1195","`github_enterprise` action=audit_log_streaming.update reason=""User initiated pause"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, user_agent, action, reason 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_pause_audit_log_event_stream_filter`"
GitHub Enterprise Register Self Hosted Runner,"The following analytic identifies when a self-hosted runner is created in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for actions related to creating new self-hosted runners at the organization or enterprise level. his behavior warrants monitoring because self-hosted runners execute workflow jobs on customer-controlled infrastructure, which could be exploited by attackers to execute malicious code, access sensitive data, or pivot to other systems.",GitHub Enterprise,"Initial Access, Execution, Lateral Movement, Impact, Defense Evasion, Exfiltration","T1195, T1562.001","`github_enterprise` action=enterprise.register_self_hosted_runner 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, user_agent, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_register_self_hosted_runner_filter`"
GitHub Enterprise Remove Organization,"The following analytic detects when a user removes an organization from GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for organization deletion events, which could indicate unauthorized removal of critical business resources. For a SOC, identifying organization removals is crucial as it may signal account compromise, insider threats, or malicious attempts to disrupt business operations by deleting entire organizational structures.",GitHub Enterprise,"Initial Access, Impact","T1195, T1485","`github_enterprise` action=business.remove_organization 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, user_agent, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_remove_organization_filter`"
GitHub Enterprise Repository Archived,"The following analytic detects when a repository is archived in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for repository archival events by tracking actor details, repository information, and associated metadata. For a SOC, identifying repository archival is important as it could indicate attempts to make critical code inaccessible or preparation for repository deletion.",GitHub Enterprise,"Initial Access, Impact","T1195, T1485","`github_enterprise` action=repo.archived 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, visibility, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_repository_archived_filter`"
GitHub Enterprise Repository Deleted,"The following analytic detects when a user deletes a repository in GitHub Enterprise. The detection monitors GitHub Enterprise audit logs for repository deletion events, which could indicate unauthorized removal of critical source code and project resources. For a SOC, identifying repository deletions is crucial as it may signal account compromise, insider threats, or malicious attempts to destroy intellectual property and disrupt development operations.",GitHub Enterprise,"Initial Access, Impact","T1195, T1485","`github_enterprise` action=repo.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, visibility, action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_enterprise_repository_deleted_filter`"
GitHub Organizations Delete Branch Ruleset,"The following analytic detects when branch rulesets are deleted in GitHub Organizations. The detection monitors GitHub Organizations audit logs for branch ruleset deletion events by tracking actor details, repository information, and associated metadata. For a SOC, identifying deleted branch rulesets is critical as it could indicate attempts to bypass code review requirements and security controls.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_organizations` vendor_action=repository_ruleset.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, vendor_action, ruleset_name 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_delete_branch_ruleset_filter`"
GitHub Organizations Disable 2FA Requirement,"The following analytic detects when two-factor authentication (2FA) requirements are disabled in GitHub Organizations. The detection monitors GitHub Organizations audit logs for 2FA requirement changes by tracking actor details, organization information, and associated metadata. For a SOC, identifying disabled 2FA requirements is critical as it could indicate attempts to weaken account security controls. Two-factor authentication is a fundamental security control that helps prevent unauthorized access even if passwords are compromised.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_organizations` vendor_action=org.disable_two_factor_requirement 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, user_agent, vendor_action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_disable_2fa_requirement_filter`"
GitHub Organizations Disable Classic Branch Protection Rule,"The following analytic detects when classic branch protection rules are disabled in GitHub Organizations. The detection monitors GitHub Organizations audit logs for branch protection removal events by tracking actor details, repository information, and associated metadata. For a SOC, identifying disabled branch protection is critical as it could indicate attempts to bypass code review requirements and security controls.",GitHub Enterprise,"Initial Access, Impact, Defense Evasion","T1195, T1562.001","`github_organizations` vendor_action=protected_branch.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, vendor_action, name 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_disable_classic_branch_protection_rule_filter`"
GitHub Organizations Disable Dependabot,"The following analytic detects when a user disables Dependabot security features within a GitHub repository. Dependabot helps automatically identify and fix security vulnerabilities in dependencies. The detection monitors GitHub Enterprise logs for configuration changes that disable Dependabot functionality. This behavior could indicate an attacker attempting to prevent the automatic detection of vulnerable dependencies, which would allow them to exploit known vulnerabilities that would otherwise be patched.",GitHub Enterprise,"Initial Access, Execution, Impact, Defense Evasion","T1195, T1562.001","`github_organizations` vendor_action=repository_vulnerability_alerts.disable 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_ip, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user, user_agent, user_id, vendor_action 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_disable_dependabot_filter`"
GitHub Organizations Repository Archived,"The following analytic detects when a repository is archived in GitHub Organizations. The detection monitors GitHub Organizations audit logs for repository archival events by tracking actor details, repository information, and associated metadata. For a SOC, identifying repository archival is important as it could indicate attempts to make critical code inaccessible or preparation for repository deletion.",GitHub Enterprise,"Initial Access, Impact","T1195, T1485","`github_organizations` vendor_action=repo.archived 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, visibility, vendor_action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_repository_archived_filter`"
GitHub Organizations Repository Deleted,"The following analytic identifies when a repository is deleted within a GitHub organization. The detection monitors GitHub Organizations audit logs for repository deletion events by tracking actor details, repository information, and associated metadata. This behavior is concerning for SOC teams as malicious actors may attempt to delete repositories to destroy source code, intellectual property, or evidence of compromise.",GitHub Enterprise,"Initial Access, Impact","T1195, T1485","`github_organizations` vendor_action=repo.destroy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor, actor_id, actor_is_bot, actor_location.country_code, business, business_id, org, org_id, repo, repo_id, user_agent, visibility, vendor_action 
| eval user=actor 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `github_organizations_repository_deleted_filter`"
Kubernetes Abuse of Secret by Unusual Location,"The following analytic detects unauthorized access or misuse of Kubernetes Secrets from unusual locations. It leverages Kubernetes Audit logs to identify anomalies in access patterns by analyzing the source of requests by country. This activity is significant for a SOC as Kubernetes Secrets store sensitive information like passwords, OAuth tokens, and SSH keys, making them critical assets.",Kubernetes,Credential Access,T1552.007,"`kube_audit` objectRef.resource=secrets verb=get 
| iplocation sourceIPs{} 
| fillnull 
| search NOT `kube_allowed_locations` 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb City Country 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_abuse_of_secret_by_unusual_location_filter`"
Kubernetes Abuse of Secret by Unusual User Agent,"The following analytic detects unauthorized access or misuse of Kubernetes Secrets by unusual user agents. It leverages Kubernetes Audit logs to identify anomalies in access patterns by analyzing the source of requests based on user agents. This activity is significant for a SOC because Kubernetes Secrets store sensitive information like passwords, OAuth tokens, and SSH keys, making them critical assets.",Kubernetes,"Credential Access, Exfiltration",T1552.007,"`kube_audit` objectRef.resource=secrets verb=get 
| search NOT `kube_allowed_user_agents` 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_abuse_of_secret_by_unusual_user_agent_filter`"
Kubernetes Abuse of Secret by Unusual User Group,"The following analytic detects unauthorized access or misuse of Kubernetes Secrets by unusual user groups. It leverages Kubernetes Audit logs to identify anomalies in access patterns by analyzing the source of requests and user groups. This activity is significant for a SOC as Kubernetes Secrets store sensitive information like passwords, OAuth tokens, and SSH keys.",Kubernetes,Credential Access,T1552.007,"`kube_audit` objectRef.resource=secrets verb=get 
| search NOT `kube_allowed_user_groups` 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_abuse_of_secret_by_unusual_user_group_filter`"
Kubernetes Abuse of Secret by Unusual User Name,"The following analytic detects unauthorized access or misuse of Kubernetes Secrets by unusual user names. It leverages Kubernetes Audit logs to identify anomalies in access patterns by analyzing the source of requests based on user names. This activity is significant for a SOC as Kubernetes Secrets store sensitive information like passwords, OAuth tokens, and SSH keys, making them critical assets.",Kubernetes,"Credential Access, Exfiltration",T1552.007,"`kube_audit` objectRef.resource=secrets verb=get 
| search NOT `kube_allowed_user_names` 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_abuse_of_secret_by_unusual_user_name_filter`"
Kubernetes Access Scanning,"The following analytic detects potential scanning activities within a Kubernetes environment. It identifies unauthorized access attempts, probing of public APIs, or attempts to exploit known vulnerabilities by monitoring Kubernetes audit logs for repeated failed access attempts or unusual API requests. This activity is significant for a SOC as it may indicate an attacker's preliminary reconnaissance to gather information about the system.",Kubernetes,Discovery,T1046,"`kube_audit` ""user.groups{}""=""system:unauthenticated"" ""responseStatus.code""=403 
| iplocation sourceIPs{} 
| stats count values(userAgent) as userAgent values(user.username) as user.username values(user.groups{}) as user.groups{} values(verb) as verb values(requestURI) as requestURI values(responseStatus.code) as responseStatus.code values(responseStatus.message) as responseStatus.message values(responseStatus.reason) as responseStatus.reason values(responseStatus.status) as responseStatus.status by sourceIPs{} Country City 
| where count > 5 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_access_scanning_filter`"
Kubernetes Anomalous Inbound Network Activity from Process,The following analytic identifies anomalous inbound network traffic volumes from processes within containerized workloads.,Kubernetes,"Command And Control, Execution",T1204,"| mstats avg(tcp.*) as tcp.* avg(udp.*) as udp.* where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name dest.workload.name dest.process.name  span=10s 
| eval key='dest.workload.name' + "":"" + 'dest.process.name' 
| join type=left key [ mstats avg(tcp.*) as avg_tcp.* avg(udp.*) as avg_udp.* stdev(tcp.*) as stdev_tcp.* avg(udp.*) as stdev_udp.* where `kubernetes_metrics` AND earliest=-30d latest=-1h by dest.workload.name dest.process.name 
| eval key='dest.workload.name' + "":"" + 'dest.process.name' ] 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 3 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| fillnull 
| eval anomalies = split(replace(anomalies, "",\s$$$$"", """") ,"", "") 
| where anomalies!="""" 
| stats count(anomalies) as count values(anomalies) as anomalies by k8s.cluster.name dest.workload.name dest.process.name 
| where count > 5 
| rename k8s.cluster.name as host 
| `kubernetes_anomalous_inbound_network_activity_from_process_filter`"
Kubernetes Anomalous Inbound Outbound Network IO,The following analytic identifies high inbound or outbound network I/O anomalies in Kubernetes containers.,Kubernetes,"Command And Control, Execution, Exfiltration",T1204,"| mstats avg(k8s.pod.network.io) as io where `kubernetes_metrics` by k8s.cluster.name k8s.pod.name k8s.node.name direction span=10s 
| eval service = replace('k8s.pod.name', ""-\w{5}$$
|-[abcdef0-9]{8,10}-\w{5}$$"", """") 
| stats avg(eval(if(direction=""transmit"", io,null()))) as outbound_network_io avg(eval(if(direction=""receive"", io,null()))) as inbound_network_io by k8s.cluster.name k8s.node.name k8s.pod.name service _time 
| eval key = 'k8s.cluster.name' + "":"" + 'service' 
| lookup k8s_container_network_io_baseline key 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 4 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| eval anomalies = replace(anomalies, "",\s$$"", """") 
| where anomalies!="""" 
| stats count values(anomalies) as anomalies by k8s.cluster.name k8s.node.name k8s.pod.name service 
| rename service as k8s.service 
| where count > 5 
| rename k8s.node.name as host 
| `kubernetes_anomalous_inbound_outbound_network_io_filter`"
Kubernetes Anomalous Inbound to Outbound Network IO Ratio,The following analytic identifies significant changes in network communication behavior within Kubernetes containers by examining the inbound to outbound network IO ratios.,Kubernetes,"Command And Control, Execution, Exfiltration",T1204,"| mstats avg(k8s.pod.network.io) as io where `kubernetes_metrics` by k8s.cluster.name k8s.pod.name k8s.node.name direction span=10s 
| eval service = replace('k8s.pod.name', ""-\w{5}$
|-[abcdef0-9]{8,10}-\w{5}$"", """") 
| eval key = 'k8s.cluster.name' + "":"" + 'service' 
| stats avg(eval(if(direction=""transmit"", io,null()))) as outbound_network_io avg(eval(if(direction=""receive"", io,null()))) as inbound_network_io by key service k8s.cluster.name k8s.pod.name k8s.node.name _time 
| eval inbound:outbound = inbound_network_io/outbound_network_io 
| eval outbound:inbound = outbound_network_io/inbound_network_io 
| fields - *network_io 
| lookup k8s_container_network_io_ratio_baseline key 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 4 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> ratio higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| eval anomalies = replace(anomalies, "",\s$"", """") 
| where anomalies!="""" 
| stats count values(anomalies) as anomalies by k8s.cluster.name k8s.node.name k8s.pod.name service 
| rename service as k8s.service 
| where count > 5 
| rename k8s.node.name as host 
| `kubernetes_anomalous_inbound_to_outbound_network_io_ratio_filter`"
Kubernetes Anomalous Outbound Network Activity from Process,The following analytic identifies anomalously high outbound network activity from processes running within containerized workloads in a Kubernetes environment.,Kubernetes,"Execution, Exfiltration",T1204,"| mstats avg(tcp.*) as tcp.* avg(udp.*) as udp.* where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name source.workload.name source.process.name  span=10s 
| eval key='source.workload.name' + "":"" + 'source.process.name' 
| join type=left key [ mstats avg(tcp.*) as avg_tcp.* avg(udp.*) as avg_udp.* stdev(tcp.*) as stdev_tcp.* avg(udp.*) as stdev_udp.* where `kubernetes_metrics` AND earliest=-30d latest=-1h by source.workload.name source.process.name 
| eval key='source.workload.name' + "":"" + 'source.process.name' ] 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 3 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| fillnull 
| eval anomalies = split(replace(anomalies, "",\s$$$$"", """") ,"", "") 
| where anomalies!="""" 
| stats count(anomalies) as count values(anomalies) as anomalies by k8s.cluster.name source.workload.name source.process.name 
| where count > 5 
| rename k8s.cluster.name as host 
| `kubernetes_anomalous_outbound_network_activity_from_process_filter`"
Kubernetes Anomalous Traffic on Network Edge,The following analytic identifies anomalous network traffic volumes between Kubernetes workloads or between a workload and external sources.,Kubernetes,"Lateral Movement, Execution, Exfiltration",T1204,"| mstats avg(tcp.*) as tcp.* avg(udp.*) as udp.* where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name source.workload.name dest.workload.name span=10s 
| eval key='source.workload.name' + "":"" + 'dest.workload.name' 
| join type=left key [ mstats avg(tcp.*) as avg_tcp.* avg(udp.*) as avg_udp.* stdev(tcp.*) as stdev_tcp.* avg(udp.*) as stdev_udp.* where `kubernetes_metrics` AND earliest=-30d latest=-1h by source.workload.name dest.workload.name 
| eval key='source.workload.name' + "":"" + 'dest.workload.name' ] 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 3 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| fillnull 
| eval anomalies = split(replace(anomalies, "",\s$$$$"", """") ,"", "") 
| where anomalies!="""" 
| stats count(anomalies) as count values(anomalies) as anomalies by k8s.cluster.name source.workload.name dest.workload.name 
| rename service as k8s.service 
| where count > 5 
| rename k8s.cluster.name as host 
| `kubernetes_anomalous_traffic_on_network_edge_filter`"
Kubernetes Create or Update Privileged Pod,"The following analytic detects the creation or update of privileged pods in Kubernetes. It identifies this activity by monitoring Kubernetes Audit logs for pod configurations that include root privileges. This behavior is significant for a SOC as it could indicate an attempt to escalate privileges, exploit the kernel, and gain full access to the host's namespace and devices.",Kubernetes,Execution,T1204,"`kube_audit` objectRef.resource=pods verb=create OR verb=update requestObject.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration=*\""privileged\"":true* 
| fillnull 
| stats count values(user.groups{}) as user_groups by kind objectRef.name objectRef.namespace objectRef.resource requestObject.kind responseStatus.code sourceIPs{} stage user.username userAgent verb requestObject.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_create_or_update_privileged_pod_filter`"
Kubernetes Cron Job Creation,"The following analytic detects the creation of a Kubernetes cron job, which is a task scheduled to run automatically at specified intervals. It identifies this activity by monitoring Kubernetes Audit logs for the creation events of cron jobs. This behavior is significant for a SOC as it could allow an attacker to execute malicious tasks repeatedly and automatically, posing a threat to the Kubernetes infrastructure.",Kubernetes,Execution,T1053.007,"`kube_audit` verb=create ""objectRef.resource""=cronjobs 
| fillnull 
| stats count values(user.groups{}) as user_groups by kind objectRef.name objectRef.namespace objectRef.resource requestObject.kind requestObject.spec.schedule requestObject.spec.jobTemplate.spec.template.spec.containers{}.image responseStatus.code sourceIPs{} stage user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_cron_job_creation_filter`"
Kubernetes DaemonSet Deployed,"The following analytic detects the creation of a DaemonSet in a Kubernetes cluster. This behavior is identified by monitoring Kubernetes Audit logs for the creation event of a DaemonSet. DaemonSets ensure a specific pod runs on every node, making them a potential vector for persistent access. This activity is significant for a SOC as it could indicate an attempt to maintain persistent access to the Kubernetes infrastructure.",Kubernetes,Execution,T1204,"`kube_audit` ""objectRef.resource""=daemonsets verb=create 
| fillnull 
| stats count values(user.groups{}) as user_groups by kind objectRef.name objectRef.namespace objectRef.resource requestObject.kind responseStatus.code sourceIPs{} stage user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_daemonset_deployed_filter`"
Kubernetes Falco Shell Spawned,"The following analytic detects instances where a shell is spawned within a Kubernetes container. Leveraging Falco, a cloud-native runtime security tool, this analytic monitors system calls within the Kubernetes environment and flags when a shell is spawned. This activity is significant for a SOC as it may indicate unauthorized access, allowing an attacker to execute arbitrary commands, manipulate container processes, or escalate privileges.",Kubernetes,"Execution, Impact",T1204,"`kube_container_falco` ""A shell was spawned in a container"" 
|  fillnull 
| stats count by container_image container_image_tag container_name parent proc_exepath process user 
| `kubernetes_falco_shell_spawned_filter`"
Kubernetes newly seen TCP edge,The following analytic identifies newly seen TCP communication between source and destination workload pairs within a Kubernetes cluster.,Kubernetes,"Lateral Movement, Execution, Privilege Escalation",T1204,"| mstats count(tcp.packets) as tcp.packets_count where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name source.workload.name dest.workload.name 
| eval current=""True"" 
| append [ mstats count(tcp.packets) as tcp.packets_count where `kubernetes_metrics` AND earliest=-30d latest=-1h by source.workload.name dest.workload.name 
| eval current=""false"" ] 
| eventstats values(current) as current by source.workload.name dest.workload.name 
| search current=""true"" current!=""false"" 
| rename k8s.cluster.name as host 
| `kubernetes_newly_seen_tcp_edge_filter`"
Kubernetes newly seen UDP edge,The following analytic detects UDP communication between a newly seen source and destination workload pair within a Kubernetes cluster.,Kubernetes,"Lateral Movement, Execution, Privilege Escalation",T1204,"| mstats count(udp.packets) as udp.packets_count where `kubernetes_metrics` AND earliest=-1h by k8s.cluster.name source.workload.name dest.workload.name 
| eval current=""True"" 
| append [ mstats count(udp.packets) as udp.packets_count where `kubernetes_metrics` AND earliest=-30d latest=-1h by source.workload.name dest.workload.name 
| eval current=""false"" ] 
| eventstats values(current) as current by source.workload.name dest.workload.name 
| search current=""true"" current!=""false"" 
| rename k8s.cluster.name as host 
| `kubernetes_newly_seen_udp_edge_filter`"
Kubernetes Nginx Ingress LFI,"The following analytic detects local file inclusion (LFI) attacks targeting Kubernetes Nginx ingress controllers. It leverages Kubernetes logs, parsing fields such as request and status to identify suspicious patterns indicative of LFI attempts. This activity is significant because LFI attacks can allow attackers to read sensitive files from the server, potentially exposing critical information.",Kubernetes,Credential Access,T1212,"`kubernetes_container_controller` 
| rex field=_raw ""^(?<remote_addr>\S+)\s+-\s+-\s+\[(?<time_local>[^\]]*)\]\s\""(?<request>[^\""]*)\""\s(?<status>\S*)\s(?<body_bytes_sent>\S*)\s\""(?<http_referer>[^\""]*)\""\s\""(?<http_user_agent>[^\""]*)\""\s(?<request_length>\S*)\s(?<request_time>\S*)\s\[(?<proxy_upstream_name>[^\]]*)\]\s\[(?<proxy_alternative_upstream_name>[^\]]*)\]\s(?<upstream_addr>\S*)\s(?<upstream_response_length>\S*)\s(?<upstream_response_time>\S*)\s(?<upstream_status>\S*)\s(?<req_id>\S*)"" 
| rename remote_addr AS src_ip, upstream_status as status, proxy_upstream_name as proxy 
| rex field=request ""^(?<http_method>\S+)\s(?<url>\S+)\s"" 
| eval phase=""operate"" 
| eval severity=""high"" 
| stats count min(_time) as firstTime max(_time) as lastTime by src_ip, status, url, http_method, host, http_user_agent, proxy, phase, severity, request 
| lookup local_file_inclusion_paths local_file_inclusion_paths AS request OUTPUT lfi_path 
| search lfi_path=yes 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `kubernetes_nginx_ingress_lfi_filter`"
Kubernetes Nginx Ingress RFI,"The following analytic detects remote file inclusion (RFI) attacks targeting Kubernetes Nginx ingress controllers. It leverages Kubernetes logs from the Nginx ingress controller, parsing fields such as remote_addr, request, and url to identify suspicious activity. This activity is significant because RFI attacks can allow attackers to execute arbitrary code or access sensitive files on the server.",Kubernetes,"Credential Access, Exfiltration",T1212,"`kubernetes_container_controller` 
| rex field=_raw ""^(?<remote_addr>\S+)\s+-\s+-\s+\[(?<time_local>[^\]]*)\]\s\""(?<request>[^\""]*)\""\s(?<status>\S*)\s(?<body_bytes_sent>\S*)\s\""(?<http_referer>[^\""]*)\""\s\""(?<http_user_agent>[^\""]*)\""\s(?<request_length>\S*)\s(?<request_time>\S*)\s\[(?<proxy_upstream_name>[^\]]*)\]\s\[(?<proxy_alternative_upstream_name>[^\]]*)\]\s(?<upstream_addr>\S*)\s(?<upstream_response_length>\S*)\s(?<upstream_response_time>\S*)\s(?<upstream_status>\S*)\s(?<req_id>\S*)"" 
| rex field=request ""^(?<http_method>\S+)?\s(?<url>\S+)\s"" 
| rex field=url ""(?<dest_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"" 
| search dest_ip=* 
| rename remote_addr AS src_ip, upstream_status as status, proxy_upstream_name as proxy 
| eval phase=""operate"" 
| eval severity=""medium"" 
| stats count min(_time) as firstTime max(_time) as lastTime by src_ip, dest_ip status, url, http_method, host, http_user_agent, proxy, phase, severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `kubernetes_nginx_ingress_rfi_filter`"
Kubernetes Node Port Creation,"The following analytic detects the creation of a Kubernetes NodePort service, which exposes a service to the external network. It identifies this activity by monitoring Kubernetes Audit logs for the creation of NodePort services. This behavior is significant for a SOC as it could allow an attacker to access internal services, posing a threat to the Kubernetes infrastructure's integrity and security.",Kubernetes,Execution,T1204,"`kube_audit` ""objectRef.resource""=services verb=create requestObject.spec.type=NodePort 
| fillnull 
| stats count values(user.groups{}) as user_groups by kind objectRef.name objectRef.namespace objectRef.resource requestObject.kind requestObject.spec.type responseStatus.code sourceIPs{} stage user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_node_port_creation_filter`"
Kubernetes Pod Created in Default Namespace,"The following analytic detects the creation of Kubernetes pods in the default, kube-system, or kube-public namespaces. It leverages Kubernetes audit logs to identify pod creation events within these specific namespaces. This activity is significant for a SOC as it may indicate an attacker attempting to hide their presence or evade defenses. Unauthorized pod creation in these namespaces can suggest a successful cluster breach, potentially leading to privilege escalation, persistent access, or further malicious activities within the cluster.",Kubernetes,"Execution, Privilege Escalation",T1204,"`kube_audit` objectRef.resource=pods verb=create objectRef.namespace IN (""default"", ""kube-system"", ""kube-public"") 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_pod_created_in_default_namespace_filter`"
Kubernetes Pod With Host Network Attachment,"The following analytic detects the creation or update of a Kubernetes pod with host network attachment. It leverages Kubernetes Audit logs to identify pods configured with host network settings. This activity is significant for a SOC as it could allow an attacker to monitor all network traffic on the node, potentially capturing sensitive information and escalating privileges.",Kubernetes,"Execution, Impact",T1204,"`kube_audit` objectRef.resource=pods verb=create OR verb=update requestObject.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration=*\""hostNetwork\"":true* 
| fillnull 
| stats count values(user.groups{}) as user_groups by kind objectRef.name objectRef.namespace objectRef.resource requestObject.kind responseStatus.code sourceIPs{} stage user.username userAgent verb requestObject.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_pod_with_host_network_attachment_filter`"
Kubernetes Previously Unseen Container Image Name,The following analytic identifies the creation of containerized workloads using previously unseen images in a Kubernetes cluster.,Kubernetes,"Lateral Movement, Execution",T1204,"| mstats  count(k8s.container.ready) as k8s.container.ready_count where `kubernetes_metrics` AND earliest=-24h by host.name k8s.cluster.name k8s.node.name container.image.name 
| eval current=""True"" 
| append [mstats  count(k8s.container.ready) as k8s.container.ready_count where `kubernetes_metrics` AND earliest=-30d latest=-1h  by host.name k8s.cluster.name k8s.node.name container.image.name 
| eval current=""false"" ] 
| stats values(current) as current by host.name k8s.cluster.name k8s.node.name container.image.name 
| search current=""true"" AND current!=""false"" 
| rename host.name as host 
| `kubernetes_previously_unseen_container_image_name_filter`"
Kubernetes Previously Unseen Process,The following analytic detects previously unseen processes within the Kubernetes environment on master or worker nodes.,Kubernetes,"Execution, Privilege Escalation, Exfiltration",T1204,"| mstats  count(process.memory.utilization) as process.memory.utilization_count where `kubernetes_metrics` AND earliest=-1h by host.name k8s.cluster.name k8s.node.name process.executable.name 
| eval current=""True"" 
| append [mstats  count(process.memory.utilization) as process.memory.utilization_count where `kubernetes_metrics` AND earliest=-30d latest=-1h by host.name k8s.cluster.name k8s.node.name process.executable.name ] 
| stats count values(current) as current by host.name k8s.cluster.name k8s.node.name process.executable.name 
| where count=1 and current=""True"" 
| rename host.name as host 
| `kubernetes_previously_unseen_process_filter`"
Kubernetes Process Running From New Path,The following analytic identifies processes running from newly seen paths within a Kubernetes environment.,Kubernetes,"Execution, Privilege Escalation, Exfiltration",T1204,"| mstats count(process.memory.utilization) as process.memory.utilization_count where `kubernetes_metrics` AND earliest=-1h by host.name k8s.cluster.name k8s.node.name process.pid process.executable.path process.executable.name 
| eval current=""True"" 
| append [ mstats count(process.memory.utilization) as process.memory.utilization_count where `kubernetes_metrics` AND earliest=-30d latest=-1h by host.name k8s.cluster.name k8s.node.name process.pid process.executable.path process.executable.name ] 
| stats count values(current) as current by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name process.executable.path 
| where count=1 and current=""True"" 
| rename host.name as host 
| `kubernetes_process_running_from_new_path_filter`"
Kubernetes Process with Anomalous Resource Utilisation,The following analytic identifies high resource utilization anomalies in Kubernetes processes.,Kubernetes,"Execution, Exfiltration",T1204,"| mstats avg(process.*) as process.* where `kubernetes_metrics` by host.name k8s.cluster.name k8s.node.name process.executable.name span=10s 
| eval key = 'k8s.cluster.name' + "":"" + 'host.name' + "":"" + 'process.executable.name' 
| lookup k8s_process_resource_baseline key 
| fillnull 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 4 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| eval anomalies = replace(anomalies, "",\s$"", """") 
| where anomalies!="""" 
| stats count values(anomalies) as anomalies by host.name k8s.cluster.name k8s.node.name process.executable.name 
| sort - count 
| where count > 5 
| rename host.name as host 
| `kubernetes_process_with_anomalous_resource_utilisation_filter`"
Kubernetes Process with Resource Ratio Anomalies,The following analytic detects anomalous changes in resource utilization ratios for processes running on a Kubernetes node.,Kubernetes,"Execution, Exfiltration",T1204,"| mstats avg(process.*) as process.* where `kubernetes_metrics` by host.name k8s.cluster.name k8s.node.name process.executable.name span=10s 
| eval cpu:mem = 'process.cpu.utilization'/'process.memory.utilization' 
| eval cpu:disk = 'process.cpu.utilization'/'process.disk.operations' 
| eval mem:disk = 'process.memory.utilization'/'process.disk.operations' 
| eval cpu:threads = 'process.cpu.utilization'/'process.threads' 
| eval disk:threads = 'process.disk.operations'/'process.threads' 
| eval key = 'k8s.cluster.name' + "":"" + 'host.name' + "":"" + 'process.executable.name' 
| lookup k8s_process_resource_ratio_baseline key 
| fillnull 
| eval anomalies = """" 
| foreach stdev_* [ eval anomalies =if( '<<MATCHSTR>>' > ('avg_<<MATCHSTR>>' + 4 * 'stdev_<<MATCHSTR>>'), anomalies + ""<<MATCHSTR>> ratio higher than average by "" + tostring(round(('<<MATCHSTR>>' - 'avg_<<MATCHSTR>>')/'stdev_<<MATCHSTR>>' ,2)) + "" Standard Deviations. <<MATCHSTR>>="" + tostring('<<MATCHSTR>>') + "" avg_<<MATCHSTR>>="" + tostring('avg_<<MATCHSTR>>') + "" 'stdev_<<MATCHSTR>>'="" + tostring('stdev_<<MATCHSTR>>') + "", "" , anomalies) ] 
| eval anomalies = replace(anomalies, "",\s$"", """") 
| where anomalies!="""" 
| stats count values(anomalies) as anomalies by host.name k8s.cluster.name k8s.node.name process.executable.name 
| where count > 5 
| rename host.name as host 
| `kubernetes_process_with_resource_ratio_anomalies_filter`"
Kubernetes Scanner Image Pulling,"The following analytic detects the pulling of known Kubernetes security scanner images such as kube-hunter, kube-bench, and kube-recon. It leverages Kubernetes logs ingested through Splunk Connect for Kubernetes, specifically monitoring for messages indicating the pulling of these images. This activity is significant because the use of security scanners can indicate an attempt to identify vulnerabilities within the Kubernetes environment.",Kubernetes,Discovery,T1526,"`kube_objects_events` object.message IN (""Pulling image *kube-hunter*"", ""Pulling image *kube-bench*"", ""Pulling image *kube-recon*"", ""Pulling image *kube-recon*"") 
| rename object.* AS * 
| rename involvedObject.* AS * 
| rename source.host AS host 
| eval phase=""operate"" 
| eval severity=""high"" 
| stats min(_time) as firstTime max(_time) as lastTime count by host, name, namespace, kind, reason, message, phase, severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `kubernetes_scanner_image_pulling_filter`"
Kubernetes Scanning by Unauthenticated IP Address,"The following analytic identifies potential scanning activities within a Kubernetes environment by unauthenticated IP addresses. It leverages Kubernetes audit logs to detect multiple unauthorized access attempts (HTTP 403 responses) from the same source IP. This activity is significant as it may indicate an attacker probing for vulnerabilities or attempting to exploit known issues. If confirmed malicious, such scanning could lead to unauthorized access, data breaches, or further exploitation of the Kubernetes infrastructure, compromising the security and integrity of the environment.",Kubernetes,Discovery,T1046,"`kube_audit` ""user.groups{}""=""system:unauthenticated"" ""responseStatus.code""=403 
| iplocation sourceIPs{} 
| stats count values(userAgent) as userAgent values(user.username) as user.username values(user.groups{}) as user.groups{} values(verb) as verb values(requestURI) as requestURI values(responseStatus.code) as responseStatus.code values(responseStatus.message) as responseStatus.message values(responseStatus.reason) as responseStatus.reason values(responseStatus.status) as responseStatus.status by sourceIPs{} Country City 
| where count > 5 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_scanning_by_unauthenticated_ip_address_filter`"
Kubernetes Shell Running on Worker Node,The following analytic identifies shell activity within the Kubernetes privilege scope on a worker node.,Kubernetes,"Lateral Movement, Execution, Privilege Escalation",T1204,"| mstats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization where `kubernetes_metrics` AND process.executable.name IN (""sh"",""bash"",""csh"", ""tcsh"") by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name span=10s 
| search process.cpu.utilization>0 OR process.memory.utilization>0 
| stats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name 
| rename host.name as host 
| `kubernetes_shell_running_on_worker_node_filter`"
Kubernetes Shell Running on Worker Node with CPU Activity,"The following analytic identifies shell activity within the Kubernetes privilege scope on a worker node, specifically when shell processes are consuming CPU resources.",Kubernetes,"Execution, Privilege Escalation",T1204,"| mstats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization where `kubernetes_metrics` AND process.executable.name IN (""sh"",""bash"",""csh"", ""tcsh"") by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name span=10s 
| search process.cpu.utilization>0 
| stats avg(process.cpu.utilization) as process.cpu.utilization avg(process.memory.utilization) as process.memory.utilization by host.name k8s.cluster.name k8s.node.name process.pid process.executable.name 
| rename host.name as host 
| `kubernetes_shell_running_on_worker_node_with_cpu_activity_filter`"
Kubernetes Suspicious Image Pulling,The following analytic detects suspicious image pulling in Kubernetes environments. It identifies this activity by monitoring Kubernetes audit logs for image pull requests that do not match a predefined list of allowed images. This behavior is significant for a SOC as it may indicate an attacker attempting to deploy malicious software or infiltrate the system.,Kubernetes,"Impact, Discovery",T1526,"`kube_audit` requestObject.message=""Pulling image*"" 
| search NOT `kube_allowed_images` 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_suspicious_image_pulling_filter`"
Kubernetes Unauthorized Access,"The following analytic detects unauthorized access attempts to Kubernetes by analyzing Kubernetes audit logs. It identifies anomalies in access patterns by examining the source of requests and their response statuses. This activity is significant for a SOC as it may indicate an attacker attempting to infiltrate the Kubernetes environment. If confirmed malicious, such access could lead to unauthorized control over Kubernetes resources, potentially compromising sensitive systems or data within the cluster.",Kubernetes,Execution,T1204,"`kube_audit` verb=create responseStatus.reason=Forbidden 
| fillnull 
| stats count by objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code responseStatus.message sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
| `kubernetes_unauthorized_access_filter`"
O365 Concurrent Sessions From Different Ips,"The following analytic identifies user sessions in Office 365 accessed from multiple IP addresses, indicating potential adversary-in-the-middle (AiTM) phishing attacks. It detects this activity by analyzing Azure Active Directory logs for 'UserLoggedIn' operations and flags sessions with more than one associated IP address. This behavior is significant as it suggests unauthorized concurrent access, which is uncommon in normal usage.",Office 365 (Microsoft 365),"Collection, Impact",T1185,"`o365_management_activity` Workload=AzureActiveDirectory Operation=UserLoggedIn 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(src) as src by signature dest user vendor_account vendor_product SessionId 
| where mvcount(src) > 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_concurrent_sessions_from_different_ips_filter`"
O365 Email Password and Payroll Compromise Behavior,"The following analytic identifies when an O365 email recipient receives and then deletes emails for the combination of both password and banking/payroll changes within a short period. This behavior may indicate a compromised account where the threat actor is attempting to redirect the victims payroll to an attacker controlled bank account.
Search 1`o365_messagetrace` subject IN (&#34;*banking*&#34;,&#34;*direct deposit*&#34;,&#34;*pay-to*&#34;,&#34;*password *&#34;,&#34;*passcode *&#34;,&#34;*OTP *&#34;,&#34;*MFA *&#34;,&#34;*Account Recovery*&#34;) 2 3| eval mailtime = _time 4 5| bin _time span=4hr 6 7| eval user = lower(RecipientAddress) 8 9| eval InternetMessageId = lower(MessageId) 10 11| join InternetMessageId, user max=0 12 [ 13 14| search `o365_management_activity` Workload=Exchange Operation IN (&#34;SoftDelete&#34;,&#34;HardDelete&#34;) 15 16| spath path=AffectedItems{} output=AffectedItemSplit 17 18| fields _time,ClientIP,ClientInfoString,UserId,Operation,ResultStatus,MailboxOwnerUPN,AffectedItemSplit 19 20| mvexpand AffectedItemSplit 21| spath input=AffectedItemSplit 22 23| search Subject IN (&#34;*banking*&#34;,&#34;*direct deposit*&#34;,&#34;*pay-to*&#34;,&#34;*password *&#34;,&#34;*passcode *&#34;,&#34;*OTP *&#34;,&#34;*MFA *&#34;,&#34;*Account Recovery*&#34;) 24 25| eval deltime = _time 26 27| bin _time span=4hr 28 29| eval InternetMessageId = lower(InternetMessageId), user = lower(UserId) 30 ] 31 32| stats values(ClientInfoString) as http_user_agent, values(ClientIP) as src, values(Subject) as subject, dc(Subject) as subject_count, values(Operation) as action, values(ResultStatus) as result, count, min(mailtime) as firstTime, max(deltime) as lastTime by user,_time 33 34| search subject IN (&#34;*banking*&#34;,&#34;*direct deposit*&#34;,&#34;*pay-to*&#34;) AND subject IN (&#34;*password *&#34;,&#34;*passcode *&#34;,&#34;*OTP *&#34;,&#34;*MFA *&#34;,&#34;*Account Recovery*&#34;) 35 36| `security_content_ctime(firstTime)` 37 38| `security_content_ctime(lastTime)` 39 40| `o365_email_password_and_payroll_compromise_behavior_filter` Data Source Name Platform Sourcetype Source Office 365 Reporting Message Trace Other 'o365:reporting:messagetrace' 'o365' Office 365 Universal Audit Log Other 'o365:management:activity' 'o365' Macros Used Name Value o365_management_activity sourcetype=o365:management:activity o365_email_password_and_payroll_compromise_behavior_filter search * o365_email_password_and_payroll_compromise_behavior_filter is an empty macro by default.",Office 365 (Microsoft 365),"Collection, Impact, Defense Evasion","T1114.001, T1114, T1070.008, T1485","`o365_messagetrace` subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"")
| eval mailtime = _time
| bin _time span=4hr
| eval user = lower(RecipientAddress)
| eval InternetMessageId = lower(MessageId)
| join InternetMessageId, user max=0
[
| search `o365_management_activity` Workload=Exchange Operation IN (""SoftDelete"",""HardDelete"")
| spath path=AffectedItems{}  output=AffectedItemSplit
| fields _time,ClientIP,ClientInfoString,UserId,Operation,ResultStatus,MailboxOwnerUPN,AffectedItemSplit 
| mvexpand AffectedItemSplit 
| spath input=AffectedItemSplit
| search Subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"") 
| eval deltime = _time
| bin _time span=4hr
| eval InternetMessageId = lower(InternetMessageId), user = lower(UserId)
]
| stats values(ClientInfoString) as http_user_agent, values(ClientIP) as src, values(Subject) as subject, dc(Subject) as subject_count, values(Operation) as action, values(ResultStatus) as result, count, min(mailtime) as firstTime, max(deltime) as lastTime by user,_time
| search subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"") AND subject IN (""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_password_and_payroll_compromise_behavior_filter`"
O365 Email Reported By User Found Malicious,The following analytic detects when an email submitted to Microsoft using the built-in report button in Outlook is found to be malicious. This capability is an enhanced protection feature that can be used within o365 tenants by users to report potentially malicious emails. This correlation looks for any submission that returns a Phish or Malware verdict upon submission.,Office 365 (Microsoft 365),Initial Access,"T1566.001, T1566.002","`o365_management_activity` Workload=SecurityComplianceCenter Operation=AlertEntityGenerated Name=""Email reported by user as*"" 
| fromjson Data 
| rename _raw AS temp etps AS _raw 
| extract pairdelim="";"" kvdelim="":"" 
| rename _raw AS etps temp AS _raw 
| search RescanVerdict IN (Phish,Malware) 
| rex field=tsd ""\<(?<src_user>.+)\>"" 
| eval src_user = case(isnull(src_user),tsd,true(),src_user) 
| rename Name as signature, AlertId as signature_id, AlertEntityId as user, tsd as sender, ms as subject 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature signature_id src_user sender subject 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_reported_by_user_found_malicious_filter`"
O365 Email Suspicious Search Behavior,"The following analytic identifies when Office 365 users search for suspicious keywords or have an excessive number of queries to a mailbox within a limited timeframe. This behavior may indicate that a malicious actor has gained control of a mailbox and is conducting discovery or enumeration activities.
Search 1`o365_management_activity` Operation=SearchQueryInitiatedExchange 2 3| eval command = case(Operation==&#34;SearchQueryPerformed&#34;,SearchQueryText,true(),QueryText), UserId = lower(UserId), signature_id = CorrelationId, signature=Operation, src = ClientIP, user = lower(UserId), object_name=case(Operation==&#34;SearchQueryPerformed&#34;,&#39;EventData&#39;,true(),QuerySource), -time = _time, suspect_terms = case(match(command, `o365_suspect_search_terms_regex`),command,true(),null()) 4 5| where command !",Office 365 (Microsoft 365),"Collection, Discovery, Credential Access, Privilege Escalation","T1114, T1552, T1114.002","`o365_management_activity` Operation=SearchQueryInitiatedExchange
| eval command = case(Operation==""SearchQueryPerformed"",SearchQueryText,true(),QueryText), UserId = lower(UserId), signature_id = CorrelationId, signature=Operation, src = ClientIP, user = lower(UserId), object_name=case(Operation==""SearchQueryPerformed"",'EventData',true(),QuerySource), -time = _time, suspect_terms = case(match(command, `o365_suspect_search_terms_regex`),command,true(),null())
| where command != ""*"" AND command != ""(*)""
| bin _time span=1hr
| stats values(ScenarioName) as app, values(object_name) as object_name values(command) as command, values(suspect_terms) as suspect_terms, values(src) as src, dc(suspect_terms) as suspect_terms_count, dc(command) as count, min(-time) as firstTime, max(-time) as lastTime by user,signature,_time
| where count > 20 OR suspect_terms_count >= 2
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `o365_email_suspicious_search_behavior_filter`"
O365 Service Principal Privilege Escalation,"This detection identifies when an Azure Service Principal elevates privileges by adding themself to a new app role assignment.
Search 1`o365_management_activity` Operation=&#34;Add app role assignment to service principal.&#34; &#34;Actor{}.ID&#34;=ServicePrincipal ResultStatus=Success 2| spath path=ModifiedProperties{} output=targetResources 3| eval src=&#34;NA&#34; 4| stats min(_time) as _time values(eval(mvfilter(match(targetResources, &#34;AppRole.Value&#34;)))) as appRole, values(eval(mvfilter(match(targetResources, &#34;ServicePrincipal.DisplayName&#34;)))) as targetServicePrincipal values(object) as targetAppContext values(user_agent) as user_agent values(user) as servicePrincipal values(UserId) as servicePrincipalId by Operation InterSystemsId tenant_id user dest src vendor_account vendor_product signature 5| spath input=appRole path=NewValue output=appRole 6| spath input=targetServicePrincipal path=NewValue output=targetServicePrincipal 7| where servicePrincipal=targetServicePrincipal 8| fillnull 9| stats earliest(_time) as firstTime latest(_time) as lastTime by servicePrincipal servicePrincipalId appRole targetAppContext user_agent tenant_id InterSystemsId user dest src vendor_account vendor_product signature 10| `security_content_ctime(firstTime)` 11| `security_content_ctime(lastTime)` 12| `o365_service_principal_privilege_escalation_filter` Data Source Name Platform Sourcetype Source O365 Add app role assignment grant to user.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation",T1098.003,"`o365_management_activity` Operation=""Add app role assignment to service principal."" ""Actor{}.ID""=ServicePrincipal ResultStatus=Success  
| spath path=ModifiedProperties{} output=targetResources  
| eval src=""NA""  
| stats min(_time) as _time values(eval(mvfilter(match(targetResources, ""AppRole.Value"")))) as appRole, values(eval(mvfilter(match(targetResources, ""ServicePrincipal.DisplayName"")))) as targetServicePrincipal values(object) as targetAppContext values(user_agent) as user_agent values(user) as servicePrincipal values(UserId) as servicePrincipalId by Operation InterSystemsId tenant_id user dest src vendor_account vendor_product signature  
| spath input=appRole path=NewValue output=appRole  
| spath input=targetServicePrincipal path=NewValue output=targetServicePrincipal  
| where servicePrincipal=targetServicePrincipal  
| fillnull  
| stats earliest(_time) as firstTime latest(_time) as lastTime by servicePrincipal servicePrincipalId appRole targetAppContext user_agent tenant_id InterSystemsId user dest src vendor_account vendor_product signature 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)`  
| `o365_service_principal_privilege_escalation_filter`"
O365 SharePoint Malware Detection,The following analytic identifies when a malicious file is detected within the SharePoint Online ecosystem. Attackers may stage and execute malicious files from within the Microsoft Office 365 ecosystem. Any detections from built-in Office 365 capabilities should be monitored and responded to appropriately. Certain premium Office 365 capabilities further enhance these detection and response functions.,Office 365 (Microsoft 365),"Execution, Persistence, Privilege Escalation",T1204.002,"`o365_management_activity` Operation=FileMalwareDetected 
| rename UserId as user, Id as signature_id 
| stats values(Workload) as category, values(SourceFileName) as file_name values(ObjectId) as file_path, values(VirusInfo) as signature, count, min(_time) as firstTime, max(_time) as lastTime by signature_id, user, dest, src, vendor_account, vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_sharepoint_malware_detection_filter`"
O365 SharePoint Suspicious Search Behavior,"The following analytic identifies when Office 365 users search for suspicious keywords or have an excessive number of queries to a SharePoint site within a limited timeframe. This behavior may indicate that a malicious actor has gained control of a user account and is conducting discovery or enumeration activities.
Search 1`o365_management_activity` (Workload=SharePoint Operation=&#34;SearchQueryPerformed&#34; SearchQueryText=* EventData=*search*) OR Operation=SearchQueryInitiatedSharepoint 2 3| eval command = case(Operation==&#34;SearchQueryPerformed&#34;,SearchQueryText,true(),QueryText), UserId = lower(UserId), signature_id = CorrelationId, signature=Operation, src = ClientIP, user = lower(UserId), object_name=case(Operation==&#34;SearchQueryPerformed&#34;,&#39;EventData&#39;,true(),QuerySource), -time = _time, suspect_terms = case(match(command, `o365_suspect_search_terms_regex`),command,true(),null()) 4 5| where command !",Office 365 (Microsoft 365),"Collection, Credential Access, Discovery","T1552, T1213.002, T1213","`o365_management_activity` (Workload=SharePoint Operation=""SearchQueryPerformed"" SearchQueryText=* EventData=*search*) OR Operation=SearchQueryInitiatedSharepoint
| eval command = case(Operation==""SearchQueryPerformed"",SearchQueryText,true(),QueryText), UserId = lower(UserId), signature_id = CorrelationId, signature=Operation, src = ClientIP, user = lower(UserId), object_name=case(Operation==""SearchQueryPerformed"",'EventData',true(),QuerySource), -time = _time, suspect_terms = case(match(command, `o365_suspect_search_terms_regex`),command,true(),null())
| where command != ""*"" AND command != ""(*)""
| bin _time span=1hr
| stats values(ScenarioName) as app, values(object_name) as object_name values(command) as command, values(suspect_terms) as suspect_terms, values(src) as src, dc(suspect_terms) as suspect_terms_count, dc(command) as count, min(-time) as firstTime, max(-time) as lastTime by user,signature,_time
| where count > 20 OR suspect_terms_count >= 2
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `o365_sharepoint_suspicious_search_behavior_filter`"
O365 Threat Intelligence Suspicious Email Delivered,"The following analytic identifies when a suspicious email is detected within the Microsoft Office 365 ecosystem through the Advanced Threat Protection engine and delivered to an end user. Attackers may execute several attacks through email, any detections from built-in Office 365 capabilities should be monitored and responded to appropriately. Certain premium Office 365 capabilities such as Safe Attachment and Safe Links further enhance these detection and response functions.",Office 365 (Microsoft 365),Initial Access,"T1566.001, T1566.002","`o365_management_activity` Workload=ThreatIntelligence Operation=TIMailData DeliveryAction!=Blocked Directionality=InBound 
| rename P2Sender as src_user, P1Sender as sender, Recipients{} as user, DeliveryAction as action 
| stats values(SenderIp) as src, values(Subject) as subject, values(user) as user, values(action) as action, values(SystemOverrides{}.Details) as reason, values(LatestDeliveryLocation) as result, values(ThreatsAndDetectionTech{}) as category, values(AttachmentData{}.FileName) as file_name, values(AttachmentData{}.FileType) as file_type, values(AttachmentData{}.SHA256) as file_hash values(DetectionMethod) as signature, min(_time) as firstTime max(_time) as lastTime, count by src_user,sender,dest,vendor_account,vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_threat_intelligence_suspicious_email_delivered_filter`"
O365 Threat Intelligence Suspicious File Detected,The following analytic identifies when a malicious file is detected within the Microsoft Office 365 ecosystem through the Advanced Threat Protection engine. Attackers may stage and execute malicious files from within the Microsoft Office 365 ecosystem. Any detections from built-in Office 365 capabilities should be monitored and responded to appropriately. Certain premium Office 365 capabilities such as Safe Attachment and Safe Links further enhance these detection and response functions.,Office 365 (Microsoft 365),Execution,T1204.002,"`o365_management_activity` Workload=ThreatIntelligence Operation=AtpDetection 
| eval dest=""NA"" 
| eval src=""NA"" 
| stats values(DetectionMethod) as category values(FileData.FileName) as file_name values(FileData.FilePath) as file_path values(FileData.FileSize) as file_size values(FileData.MalwareFamily) as signature count, min(_time) as firstTime, max(_time) as lastTime by Id, UserId, dest, src, vendor_account, vendor_product 
| rename Id as signature_id, UserId as user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_threat_intelligence_suspicious_file_detected_filter`"
O365 ZAP Activity Detection,"The following analytic detects when the Microsoft Zero-hour Automatic Purge (ZAP) capability takes action against a user's mailbox. This capability is an enhanced protection feature that retro-actively removes email with known malicious content for user inboxes. Since this is a retroactive capability, there is still a window in which the user may fall victim to the malicious content.",Office 365 (Microsoft 365),Initial Access,"T1566.001, T1566.002","`o365_management_activity` Workload=SecurityComplianceCenter Operation=AlertEntityGenerated Name=""*messages containing malicious*"" 
| fromjson Data 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(zu) as url values(zfn) as file_name values(ms) as subject values(ttr) as result values(tsd) as src_user by AlertId,trc,signature,Name,dest,src,vendor_account,vendor_product 
| rename Name as signature, AlertId as signature_id, trc as user 
| eval action = CASE(match(result,""Success""), ""blocked"", true(),""allowed""), url = split(url,"";"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_zap_activity_detection_filter`"
7zip CommandLine To SMB Share Path,"The following analytic detects the execution of 7z or 7za processes with command lines pointing to SMB network shares. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as it may indicate an attempt to archive and exfiltrate sensitive files to a network share, a technique observed in CONTI LEAK tools.",Windows Events,"Collection, Execution, Exfiltration",T1560.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name =""7z.exe"" OR Processes.process_name = ""7za.exe"" OR Processes.process_name = ""7zr.exe"" OR Processes.original_file_name = ""7z.exe"" OR Processes.original_file_name =  ""7za.exe"" OR Processes.original_file_name =  ""7zr.exe"") AND (Processes.process=""*\\C$\\*"" OR Processes.process=""*\\Admin$\\*"" OR Processes.process=""*\\IPC$\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `7zip_commandline_to_smb_share_path_filter`"
Add DefaultUser And Password In Registry,"The following analytic detects suspicious registry modifications that implement auto admin logon by adding DefaultUserName and DefaultPassword values. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the &quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; registry path. This activity is significant because it is associated with BlackMatter ransomware, which uses this technique to automatically log on to compromised hosts and continue encryption after a safe mode boot.",Windows Events,"Persistence, Credential Access",T1552.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon*"" AND Registry.registry_value_name= DefaultPassword OR Registry.registry_value_name= DefaultUserName) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `add_defaultuser_and_password_in_registry_filter`"
Allow Operation with Consent Admin,"The following analytic detects a registry modification that allows the 'Consent Admin' to perform operations requiring elevation without user consent or credentials. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the 'ConsentPromptBehaviorAdmin' value within the Windows Policies System registry path. This activity is significant as it indicates a potential privilege escalation attempt, which could allow an attacker to execute high-privilege tasks without user approval.",Windows Events,"Privilege Escalation, Defense Evasion",T1548,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Microsoft\\Windows\\CurrentVersion\\Policies\\System*"" Registry.registry_value_name = ConsentPromptBehaviorAdmin Registry.registry_value_data = ""0x00000000"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name  Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `allow_operation_with_consent_admin_filter`"
Auto Admin Logon Registry Entry,"The following analytic detects a suspicious registry modification that enables auto admin logon on a host. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the &quot;AutoAdminLogon&quot; value within the &quot;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; registry path. This activity is significant because it was observed in BlackMatter ransomware attacks to maintain access after a safe mode reboot, facilitating further encryption.",Windows Events,Credential Access,T1552.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon*"" AND Registry.registry_value_name=AutoAdminLogon AND Registry.registry_value_data=1) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `auto_admin_logon_registry_entry_filter`"
Bcdedit Command Back To Normal Mode Boot,"The following analytic detects the execution of a suspicious bcdedit command that reconfigures a host from safe mode back to normal boot. This detection leverages Endpoint Detection and Response (EDR) data, focusing on command-line executions involving bcdedit.exe with specific parameters. This activity is significant as it may indicate the presence of ransomware, such as BlackMatter, which manipulates boot configurations to facilitate encryption processes.",Windows Events,"Execution, Impact, Privilege Escalation",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = bcdedit.exe Processes.process=""*/deletevalue*"" Processes.process=""*{current}*""  Processes.process=""*safeboot*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `bcdedit_command_back_to_normal_mode_boot_filter`"
Change To Safe Mode With Network Config,"The following analytic detects the execution of a suspicious bcdedit command that configures a host to boot in safe mode with network support. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving bcdedit.exe with specific parameters. This activity is significant because it is a known technique used by BlackMatter ransomware to force a compromised host into safe mode for continued encryption.",Windows Events,"Execution, Impact",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = bcdedit.exe Processes.process=""*/set*"" Processes.process=""*{current}*""  Processes.process=""*safeboot*"" Processes.process=""*network*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `change_to_safe_mode_with_network_config_filter`"
Clop Ransomware Known Service Name,"The following analytic identifies the creation of a service with a known name used by CLOP ransomware for persistence and high-privilege code execution. It detects this activity by monitoring Windows Event Logs (EventCode 7045) for specific service names (&quot;SecurityCenterIBM&quot;, &quot;WinCheckDRVs&quot;). This activity is significant because the creation of such services is a common tactic used by ransomware to maintain control over infected systems.",Windows Events,"Execution, Persistence",T1543,"`wineventlog_system` EventCode=7045 ServiceName IN (""SecurityCenterIBM"", ""WinCheckDRVs"") 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer EventCode ServiceName StartType ServiceType 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `clop_ransomware_known_service_name_filter`"
CMD Echo Pipe - Escalation,"The following analytic identifies the use of named-pipe impersonation for privilege escalation, commonly associated with Cobalt Strike and similar frameworks. It detects command-line executions where cmd.exe uses echo to write to a named pipe, such as cmd.exe /c echo 4sgryt3436 &gt; \\.\Pipe\5erg53. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry.",Windows Events,"Execution, Persistence, Privilege Escalation","T1543.003, T1059.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_cmd` OR Processes.process=*%comspec%* (Processes.process=*echo* AND Processes.process=*pipe*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cmd_echo_pipe___escalation_filter`"
Create Remote Thread In Shell Application,"The following analytic detects suspicious process injection in command shell applications, specifically targeting cmd.exe and powershell.exe. It leverages Sysmon EventCode 8 to identify the creation of remote threads within these shell processes. This activity is significant because it is a common technique used by malware, such as IcedID, to inject malicious code and execute it within legitimate processes.",Windows Events,"Execution, Persistence, Defense Evasion",T1055,"`sysmon` EventCode=8 TargetImage IN (""*\\cmd.exe"", ""*\\powershell*"", ""*\\pwsh.exe"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `create_remote_thread_in_shell_application_filter`"
Credential Dumping via Copy Command from Shadow Copy,"The following analytic detects the use of the copy command to dump credentials from a shadow copy. It leverages Endpoint Detection and Response (EDR) data to identify processes with command lines referencing critical files like &quot;sam&quot;, &quot;security&quot;, &quot;system&quot;, and &quot;ntds.dit&quot; in system directories. This activity is significant as it indicates an attempt to extract credentials, a common technique for unauthorized access and privilege escalation.",Windows Events,"Execution, Credential Access, Privilege Escalation",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_cmd` (Processes.process=*\\system32\\config\\sam* OR Processes.process=*\\system32\\config\\security* OR Processes.process=*\\system32\\config\\system* OR Processes.process=*\\windows\\ntds\\ntds.dit*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `credential_dumping_via_copy_command_from_shadow_copy_filter`"
Credential Dumping via Symlink to Shadow Copy,"The following analytic detects the creation of a symlink to a shadow copy, which may indicate credential dumping attempts. It leverages the Endpoint.Processes data model in Splunk to identify processes executing commands containing &quot;mklink&quot; and &quot;HarddiskVolumeShadowCopy&quot;. This activity is significant because attackers often use this technique to manipulate or delete shadow copies, hindering system backup and recovery efforts.",Windows Events,"Execution, Credential Access",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_cmd` Processes.process=*mklink* Processes.process=*HarddiskVolumeShadowCopy* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `credential_dumping_via_symlink_to_shadow_copy_filter`"
Crowdstrike Admin Weak Password Policy,"The following analytic detects CrowdStrike alerts for admin weak password policy violations, identifying instances where administrative passwords do not meet security standards. These alerts highlight significant vulnerabilities that could be exploited by attackers to gain unauthorized access. Promptly addressing these alerts is crucial for maintaining robust security and protecting critical systems and data from potential threats.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_identities` primaryDisplayName = ""*admin*"" 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| where risk_type = ""WEAK_PASSWORD_POLICY"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_admin_weak_password_policy_filter`"
Crowdstrike Admin With Duplicate Password,"The following analytic detects CrowdStrike alerts for admin accounts with duplicate password risk, identifying instances where administrative users share the same password. This practice significantly increases the risk of unauthorized access and potential breaches. Addressing these alerts promptly is crucial for maintaining strong security protocols, ensuring each admin account uses a unique, secure password to protect critical systems and data.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_identities` primaryDisplayName = ""*admin*"" 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| where risk_type = ""DUPLICATE_PASSWORD"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_admin_with_duplicate_password_filter`"
Crowdstrike High Identity Risk Severity,"The following analytic detects CrowdStrike alerts for High Identity Risk Severity with a risk score of 70 or higher. These alerts indicate significant vulnerabilities in user identities, such as suspicious behavior or compromised credentials. Promptly investigating and addressing these alerts is crucial to prevent potential security breaches and ensure the integrity and protection of sensitive information and systems.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_identities` riskScoreSeverity=""HIGH"" OR riskScore >= 0.70 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_high_identity_risk_severity_filter`"
Crowdstrike Medium Identity Risk Severity,"The following analytic detects CrowdStrike alerts for Medium Identity Risk Severity with a risk score of 55 or higher. These alerts indicate significant vulnerabilities in user identities, such as suspicious behavior or compromised credentials. Promptly investigating and addressing these alerts is crucial to prevent potential security breaches and ensure the integrity and protection of sensitive information and systems.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_identities` riskScoreSeverity = ""MEDIUM"" OR riskScore >= 0.55 AND riskScore < 0.70 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_medium_identity_risk_severity_filter`"
Crowdstrike Medium Severity Alert,"The following analytic detects a CrowdStrike alert with MEDIUM severity indicates a potential threat that requires prompt attention. This alert level suggests suspicious activity that may compromise security but is not immediately critical. It typically involves detectable but non-imminent risks, such as unusual behavior or attempted policy violations, which should be investigated further and mitigated quickly to prevent escalation of attacks.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_stream` 
| rename event.EndpointIp as src_ip, event.EndpointName as src_host, event.UserName as user, event.IncidentDescription as description, event.IncidentType as type, event.NumbersOfAlerts as count_alerts, event.SeverityName as severity 
| stats count min(_time) as firstTime max(_time) as lastTime by src_ip, src_host, user, description, type, count_alerts, severity 
| where LIKE (severity, ""%MEDIUM%"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_medium_severity_alert_filter`"
Crowdstrike Multiple LOW Severity Alerts,"The following analytic detects multiple CrowdStrike LOW severity alerts, indicating a series of minor suspicious activities or policy violations. These alerts are not immediately critical but should be reviewed to prevent potential threats. They often highlight unusual behavior or low-level risks that, if left unchecked, could escalate into more significant security issues. Regular monitoring and analysis of these alerts are essential for maintaining robust security.",CrowdStrike EDR,"Credential Access, Privilege Escalation",T1110,"`crowdstrike_stream` tag=alert event.SeverityName= LOW 
| rename event.EndpointIp as src_ip, event.EndpointName as src_host, event.UserName as user, event.IncidentDescription as description, event.IncidentType as type, event.NumbersOfAlerts as count_alerts, event.SeverityName as severity 
| stats dc(type) as type_count, values(user) as users, values(description) as descriptions, values(type) as types, values(severity) count min(_time) as firstTime max(_time) as lastTime by src_ip src_host 
| where type_count >= 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_multiple_low_severity_alerts_filter`"
Crowdstrike Privilege Escalation For Non-Admin User,"The following analytic detects CrowdStrike alerts for privilege escalation attempts by non-admin users. These alerts indicate unauthorized efforts by regular users to gain elevated permissions, posing a significant security risk. Detecting and addressing these attempts promptly helps prevent potential breaches and ensures that user privileges remain properly managed, maintaining the integrity of the organization's security protocols.",CrowdStrike EDR,"Credential Access, Privilege Escalation",T1110,"`crowdstrike_stream` tag=alert 
| rename event.EndpointIp as src_ip, event.EndpointName as src_host, event.UserName as user, event.IncidentDescription as description, event.IncidentType as type, event.NumbersOfAlerts as count_alerts, event.SeverityName as severity 
| stats count min(_time) as firstTime max(_time) as lastTime by src_ip, src_host, user, description, type, count_alerts, severity 
| where LIKE(type,""%Privilege escalation%"") AND NOT LIKE(user, ""%adm%"") AND NOT LIKE(user, ""%svc%"") AND NOT LIKE(user, ""%admin%"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_privilege_escalation_for_non_admin_user_filter`"
Crowdstrike User Weak Password Policy,"The following analytic detects CrowdStrike alerts for weak password policy violations, identifying instances where passwords do not meet the required security standards. These alerts highlight potential vulnerabilities that could be exploited by attackers, emphasizing the need for stronger password practices. Addressing these alerts promptly helps to enhance overall security and protect sensitive information from unauthorized access.",CrowdStrike EDR,"Credential Access, Privilege Escalation",T1110,"`crowdstrike_identities`  primaryDisplayName != ""*admin*"" 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| where risk_type = ""WEAK_PASSWORD_POLICY"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_user_weak_password_policy_filter`"
Crowdstrike User with Duplicate Password,"The following analytic detects CrowdStrike alerts for non-admin accounts with duplicate password risk, identifying instances where multiple non-admin users share the same password. This practice weakens security and increases the potential for unauthorized access. Addressing these alerts is essential to ensure each user account has a unique, strong password, thereby enhancing overall security and protecting sensitive information.",CrowdStrike EDR,Credential Access,T1110,"`crowdstrike_identities` primaryDisplayName != ""*admin*"" 
| rename riskFactors{}.severity as severity, riskFactors{}.type as risk_type, roles{}.type as role_type, accounts{}.domain as domain, accounts{}.dn as dn, accounts{}.samAccountName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by  domain dn primaryDisplayName risk_type severity riskScore riskScoreSeverity user role_type 
| where risk_type = ""DUPLICATE_PASSWORD"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crowdstrike_user_with_duplicate_password_filter`"
Delete ShadowCopy With PowerShell,"The following analytic detects the use of PowerShell to delete shadow copies via the WMIC PowerShell module. It leverages EventCode 4104 and searches for specific keywords like &quot;ShadowCopy,&quot; &quot;Delete,&quot; or &quot;Remove&quot; within the ScriptBlockText. This activity is significant because deleting shadow copies is a common tactic used by ransomware, such as DarkSide, to prevent data recovery.",Windows Events,Impact,T1490,"`powershell` EventCode=4104 ScriptBlockText= ""*ShadowCopy*"" (ScriptBlockText = ""*Delete*"" OR ScriptBlockText = ""*Remove*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `delete_shadowcopy_with_powershell_filter`"
Detect AzureHound Command-Line Arguments,"The following analytic detects the execution of the Invoke-AzureHound command-line argument, commonly used by the AzureHound tool. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because AzureHound is often used for reconnaissance in Azure environments, potentially exposing sensitive information. If confirmed malicious, this activity could allow an attacker to map out Azure Active Directory structures, aiding in further attacks and privilege escalation.",Windows Events,"Discovery, Execution, Privilege Escalation","T1069.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""*invoke-azurehound*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_azurehound_command_line_arguments_filter`"
Detect Baron Samedit CVE-2021-3156,The following analytic detects attempts to exploit the Baron Samedit vulnerability (CVE-2021-3156) by identifying the use of the &quot;sudoedit -s \&quot; command.,Linux,Privilege Escalation,T1068,"`linux_hosts` ""sudoedit -s \\"" 
| `detect_baron_samedit_cve_2021_3156_filter`"
Detect Baron Samedit CVE-2021-3156 via OSQuery,"The following analytic detects the execution of the &quot;sudoedit -s *&quot; command, which is associated with the Baron Samedit CVE-2021-3156 heap-based buffer overflow vulnerability.",Windows Events,"Execution, Privilege Escalation",T1068,"`osquery_process` 
| search ""columns.cmdline""=""sudoedit -s \\*"" 
| `detect_baron_samedit_cve_2021_3156_via_osquery_filter`"
Detect Certify Command Line Arguments,"The following analytic detects the use of Certify or Certipy tools to enumerate Active Directory Certificate Services (AD CS) environments. It leverages Endpoint Detection and Response (EDR) data, focusing on specific command-line arguments associated with these tools. This activity is significant because it indicates potential reconnaissance or exploitation attempts targeting AD CS, which could lead to unauthorized access or privilege escalation.",Windows Events,"Command And Control, Execution, Credential Access, Privilege Escalation","T1105, T1649","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""* find *"",""* auth *"",""* request *"",""* req *"",""* download *"",) AND Processes.process IN (""* /vulnerable*"",""* /enrolleeSuppliesSubject *"",""* /json /outfile*"",""* /ca*"", ""* -username *"",""* -u *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `detect_certify_command_line_arguments_filter`"
Detect Certify With PowerShell Script Block Logging,"The following analytic detects the use of the Certify tool via an in-memory PowerShell function to enumerate Active Directory Certificate Services (AD CS) environments. It leverages PowerShell Script Block Logging (EventCode 4104) to identify specific command patterns associated with Certify's enumeration and exploitation functions. This activity is significant as it indicates potential reconnaissance or exploitation attempts against AD CS, which could lead to unauthorized certificate issuance.",Windows Events,"Execution, Credential Access","T1059.001, T1649","`powershell` EventCode=4104 (ScriptBlockText IN (""*find *"") AND ScriptBlockText IN (""* /vulnerable*"",""* -vulnerable*"",""* /enrolleeSuppliesSubject *"",""* /json /outfile*"")) OR (ScriptBlockText IN (,""*auth *"",""*req *"",) AND ScriptBlockText IN (""* -ca *"",""* -username *"",""* -u *"")) OR (ScriptBlockText IN (""*request *"",""*download *"") AND ScriptBlockText IN (""* /ca:*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval file_name = case(isnotnull(file_name),file_name,true(),""unknown"") 
| eval signature = substr(command,0,256) 
| `detect_certify_with_powershell_script_block_logging_filter`"
Detect Certipy File Modifications,The following analytic detects the use of the Certipy tool to enumerate Active Directory Certificate Services (AD CS) environments by identifying unique file modifications. It leverages endpoint process and filesystem data to spot the creation of files with specific names or extensions associated with Certipy's information gathering and exfiltration activities. This activity is significant as it indicates potential reconnaissance and data exfiltration efforts by an attacker.,Windows Events,"Execution, Credential Access, Collection, Privilege Escalation, Exfiltration","T1560, T1649","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*_certipy.zip"",""*_certipy.txt"", ""*_certipy.json"", ""*.ccache"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_certipy_file_modifications_filter`"
Detect Computer Changed with Anonymous Account,The following analytic detects changes to computer accounts using an anonymous logon.,Windows Events,"Lateral Movement, Privilege Escalation",T1210,"`wineventlog_security` EventCode=4624 OR EventCode=4742 TargetUserName=""ANONYMOUS LOGON"" LogonType=3 
| stats count min(_time) as firstTime max(_time) as lastTime by action app authentication_method dest dvc process process_id process_name process_path signature signature_id src src_port status subject user user_group vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_computer_changed_with_anonymous_account_filter`"
Detect Password Spray Attack Behavior From Source,The following analytic identifies one source failing to authenticate with 10 or more unique users. This behavior could represent an adversary performing a Password Spraying attack to obtain initial access or elevate privileges. This logic can be used for real time security monitoring as well as threat hunting exercises and works well against any number of data sources ingested into the CIM datamodel.,Azure AD (Microsoft Entra ID),"Initial Access, Credential Access","T1110.003, T1110","| tstats `security_content_summariesonly` max(_time) as lastTime, min(_time) as firstTime, values(Authentication.user_category) as user_category values(Authentication.src_category) as src_category values(Authentication.app) as app count from datamodel=Authentication.Authentication by Authentication.action Authentication.app Authentication.authentication_method Authentication.dest Authentication.signature Authentication.signature_id Authentication.src Authentication.user 
| `drop_dm_object_name(""Authentication"")` 
| eval user=case((match(upper(user),""[a-zA-Z0-9]{3}"")),upper(user),true(),null), src=upper(src), success=if(action=""success"",count,0),success_user=if(action=""success"",user,null),failure=if(action=""failure"",count,0), failed_user=if(action=""failure"",user,null) 
| stats count min(firstTime) as firstTime max(lastTime) as lastTime values(app) as app values(src_category) as src_category values(success_user) as user values(failed_user) as failed_user dc(success_user) as success_dc dc(failed_user) as failed_dc dc(user) as user_dc ,sum(failure) as failure,sum(success) as success by src 
| fields - _time 
| where user_dc >= 10 AND .25 > (success/failure) AND failed_dc > success_dc 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_password_spray_attack_behavior_from_source_filter`"
Detect Password Spray Attack Behavior On User,The following analytic identifies any user failing to authenticate from 10 or more unique sources. This behavior could represent an adversary performing a Password Spraying attack to obtain initial access or elevate privileges. This logic can be used for real time security monitoring as well as threat hunting exercises. Environments can be very different depending on the organization.,Azure AD (Microsoft Entra ID),"Initial Access, Credential Access","T1110.003, T1110","| tstats `security_content_summariesonly` max(_time) as lastTime, min(_time) as firstTime, values(Authentication.user_category) as user_category values(Authentication.src_category) as src_category values(Authentication.app) as app count from datamodel=Authentication.Authentication by Authentication.action Authentication.app Authentication.authentication_method Authentication.dest Authentication.signature Authentication.signature_id Authentication.src Authentication.user 
| `drop_dm_object_name(""Authentication"")` 
| eval user=case((match(upper(user),""[a-zA-Z0-9]{3}"")),upper(user),true(),null), success=if(action=""success"",count,0), src=upper(src), success_src=if(action=""success"",src,null), failure=if(action=""failure"",count,0), failed_src=if(action=""failure"",src,null) 
| stats count min(firstTime) as firstTime max(lastTime) as lastTime values(app) as app values(src_category) as src_category values(success_src) as src values(failed_src) as failed_src dc(success_src) as success_dc dc(failed_src) as failed_dc dc(src) as src_dc, sum(failure) as failure, sum(success) as success by user 
| fields - _time 
| where src_dc >= 10 AND .25 > (success/failure) AND failed_dc > success_dc 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_password_spray_attack_behavior_on_user_filter`"
Detect Path Interception By Creation Of program exe,"The following analytic identifies the creation of a program executable in an unquoted service path, a common technique for privilege escalation. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where the parent process is 'services.exe'. This activity is significant because unquoted service paths can be exploited by attackers to execute arbitrary code with elevated privileges.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1574.009,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=services.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| rex field=process ""^.*?\\\\(?<service_process>[^\\\\]*\.(?:exe
|bat
|com
|ps1))"" 
| eval process_name = lower(process_name) 
| eval service_process = lower(service_process) 
| where process_name != service_process 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_path_interception_by_creation_of_program_exe_filter`"
Detect Renamed WinRAR,"The following analytic identifies instances where WinRAR.exe has been renamed and executed. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names within the Endpoint data model. This activity is significant because renaming executables is a common tactic used by attackers to evade detection. If confirmed malicious, this could indicate an attempt to bypass security controls, potentially leading to unauthorized data extraction or further system compromise.",Windows Events,"Collection, Execution, Exfiltration",T1560.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.original_file_name=WinRAR.exe (Processes.process_name!=rar.exe AND Processes.process_name!=winrar.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_renamed_winrar_filter`"
Disable Security Logs Using MiniNt Registry,"The following analytic detects a suspicious registry modification aimed at disabling security audit logs by adding a specific registry entry. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;Control\MiniNt&quot; registry path. This activity is significant because it can prevent Windows from logging any events to the Security Log, effectively blinding security monitoring efforts.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\Control\\MiniNt\\*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_security_logs_using_minint_registry_filter`"
Disable Show Hidden Files,"The following analytic detects modifications to the Windows registry that disable the display of hidden files. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with hidden file settings. This activity is significant because malware, such as worms and trojan spyware, often use hidden files to evade detection.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1112, T1564.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Hidden"" OR (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\HideFileExt"" Registry.registry_value_data = ""0x00000001"") OR (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ShowSuperHidden"" Registry.registry_value_data = ""0x00000000"" )) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_show_hidden_files_filter`"
Disable Windows App Hotkeys,"The following analytic detects a suspicious registry modification aimed at disabling Windows hotkeys for native applications. It leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values indicative of this behavior. This activity is significant as it can impair an analyst's ability to use essential tools like Task Manager and Command Prompt, hindering incident response efforts.",Windows Events,"Execution, Persistence, Defense Evasion","T1562.001, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\Windows NT\\CurrentVersion\\Image File Execution Options\\*"" AND Registry.registry_value_data= ""HotKey Disabled"" AND Registry.registry_value_name = ""Debugger"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_windows_app_hotkeys_filter`"
Drop IcedID License dat,"The following analytic detects the dropping of a suspicious file named &quot;license.dat&quot; in %appdata% or %programdata%. This behavior is associated with the IcedID malware, which uses this file to inject its core bot into other processes for banking credential theft. The detection leverages Sysmon EventCode 11 to monitor file creation events in these directories.",Windows Events,Execution,T1204.002,"`sysmon` EventCode= 11  TargetFilename = ""*\\license.dat"" AND (TargetFilename=""*\\appdata\\*"" OR TargetFilename=""*\\programdata\\*"") 
|stats count min(_time) as firstTime max(_time) as lastTime by TargetFilename EventCode process_id  process_name dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_icedid_license_dat_filter`"
Dump LSASS via comsvcs DLL,"The following analytic detects the behavior of dumping credentials from memory by exploiting the Local Security Authority Subsystem Service (LSASS) using the comsvcs.dll and MiniDump via rundll32. This detection leverages process information from Endpoint Detection and Response (EDR) logs, focusing on specific command-line executions. This activity is significant because it indicates potential credential theft, which can lead to broader system compromise, persistence, lateral movement, and privilege escalation.",Windows Events,"Execution, Credential Access, Lateral Movement, Persistence, Privilege Escalation",T1003.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*comsvcs.dll* Processes.process IN (""*MiniDump*"", ""*#24*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `dump_lsass_via_comsvcs_dll_filter`"
Dump LSASS via procdump,"The following analytic detects the use of procdump.exe to dump the LSASS process, specifically looking for the -mm and -ma command-line arguments. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line executions, and parent processes. This activity is significant because dumping LSASS can expose sensitive credentials, posing a severe security risk.",Windows Events,"Execution, Credential Access","T1003, T1003.001","| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime
from datamodel=Endpoint.Processes where 
(
Processes.process_name IN (
""procdump.exe"",
""procdump64.exe"",
""procdump64a.exe""
)
OR
Processes.original_file_name=procdump
)
Processes.process IN (*-ma*, *-mm*, ""*-mp*"", */ma*, */mm*, ""*/mp*"")
Processes.process IN (* ls*, ""* keyiso*"", ""* samss*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `dump_lsass_via_procdump_filter`"
Enable RDP In Other Port Number,"The following analytic detects modifications to the registry that enable RDP on a machine using a non-default port number. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; and the &quot;PortNumber&quot; value. This activity is significant as attackers often modify RDP settings to facilitate lateral movement and maintain remote access to compromised systems.",Windows Events,"Lateral Movement, Defense Evasion",T1021,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp*"" Registry.registry_value_name = ""PortNumber"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `enable_rdp_in_other_port_number_filter`"
Enable WDigest UseLogonCredential Registry,"The following analytic detects a suspicious registry modification that enables the plain text credential feature in Windows by setting the &quot;UseLogonCredential&quot; value to 1 in the WDigest registry path. This detection leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values. This activity is significant because it is commonly used by malware and tools like Mimikatz to dump plain text credentials, indicating a potential credential dumping attempt.",Windows Events,"Lateral Movement, Persistence, Defense Evasion","T1003, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\System\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\\*"" Registry.registry_value_name = ""UseLogonCredential"" Registry.registry_value_data=0x00000001) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `enable_wdigest_uselogoncredential_registry_filter`"
Enumerate Users Local Group Using Telegram,"The following analytic detects a Telegram process enumerating all network users in a local group. It leverages EventCode 4798, which is generated when a process enumerates a user's security-enabled local groups on a computer or device. This activity is significant as it may indicate an attempt to gather information on user accounts, a common precursor to further malicious actions.",Windows Events,"Lateral Movement, Discovery, Privilege Escalation",T1087,"`wineventlog_security` EventCode=4798  CallerProcessName = ""*\\telegram.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by user Computer EventCode CallerProcessName  ProcessID SubjectUserSid SubjectDomainName  SubjectLogonId 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `enumerate_users_local_group_using_telegram_filter`"
ETW Registry Disabled,"The following analytic detects a registry modification that disables the ETW for the .NET Framework. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the ETWEnabled registry value under the .NETFramework path. This activity is significant because disabling ETW can allow attackers to evade Endpoint Detection and Response (EDR) tools and hide their execution from audit logs.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1562.006, T1127","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\SOFTWARE\\Microsoft\\.NETFramework*"" Registry.registry_value_name = ETWEnabled Registry.registry_value_data=0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `etw_registry_disabled_filter`"
Excessive Attempt To Disable Services,"The following analytic identifies a suspicious series of command-line executions attempting to disable multiple services. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes where &quot;sc.exe&quot; is used with parameters like &quot;config&quot; or &quot;Disabled&quot; within a short time frame. This activity is significant as it may indicate an adversary's attempt to disable security or other critical services to further compromise the system.",Windows Events,"Execution, Impact, Persistence",T1489,"| tstats `security_content_summariesonly` values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product  count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""sc.exe"" AND Processes.process=""*config*"" OR Processes.process=""*Disabled*"" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user _time span=1m 
| where count >=4 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_attempt_to_disable_services_filter`"
Excessive Usage of NSLOOKUP App,"The following analytic detects excessive usage of the nslookup application, which may indicate potential DNS exfiltration attempts. It leverages Sysmon EventCode 1 to monitor process executions, specifically focusing on nslookup.exe. The detection identifies outliers by comparing the frequency of nslookup executions against a calculated threshold. This activity is significant as it can reveal attempts by malware or APT groups to exfiltrate data via DNS queries.",Windows Events,"Command And Control, Execution, Exfiltration",T1048,"| tstats `security_content_summariesonly` count as numNsLookup min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product values(Processes.parent_process) as parent_process values(Processes.process_name) as process_name values(Processes.parent_process_id) as parent_process_id values(Processes.user) as user from datamodel=Endpoint.Processes where Processes.process_name = ""nslookup.exe"" by Processes.dest _time span=1m 
| `drop_dm_object_name(Processes)` 
| eventstats avg(numNsLookup) as avgNsLookup, stdev(numNsLookup) as stdNsLookup, count as numSlots by dest 
| eval upperThreshold=(avgNsLookup + stdNsLookup *3) 
| eval isOutlier=if(numNsLookup > 20 and numNsLookup >= upperThreshold, 1, 0) 
| search isOutlier=1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_usage_of_nslookup_app_filter`"
Excessive Usage Of Taskkill,"The following analytic identifies excessive usage of taskkill.exe, a command-line utility used to terminate processes. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on instances where taskkill.exe is executed ten or more times within a one-minute span. This behavior is significant as adversaries often use taskkill.exe to disable security tools or other critical processes to evade detection.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.dest) as dest values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product from datamodel=Endpoint.Processes where Processes.process_name = ""taskkill.exe"" by Processes.parent_process_name Processes.process_name Processes.dest Processes.user _time span=1m 
| where count >=10 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_usage_of_taskkill_filter`"
Execute Javascript With Jscript COM CLSID,"The following analytic detects the execution of JavaScript using the JScript.Encode CLSID (COM Object) by cscript.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line executions, and parent processes. This activity is significant as it is a known technique used by ransomware, such as Reddot, to execute malicious scripts and potentially disable AMSI (Antimalware Scan Interface).",Windows Events,"Execution, Persistence",T1059.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""cscript.exe"" Processes.process=""*-e:{F414C262-6AC0-11CF-B6D1-00AA00BBBB58}*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `execute_javascript_with_jscript_com_clsid_filter`"
Execution of File with Multiple Extensions,"The following analytic detects the execution of files with multiple extensions, such as &quot;.doc.exe&quot; or &quot;.pdf.exe&quot;. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where the file name contains double extensions. This activity is significant because attackers often use double extensions to disguise malicious executables as benign documents, increasing the likelihood of user execution.",Windows Events,"Execution, Defense Evasion",T1036.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""*.doc.exe"", ""*.xls.exe"",""*.ppt.exe"", ""*.htm.exe"", ""*.html.exe"", ""*.txt.exe"", ""*.pdf.exe"", ""*.docx.exe"", ""*.xlsx.exe"", ""*.pptx.exe"",""*.one.exe"", ""*.bat.exe"", ""*.rtf.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| `execution_of_file_with_multiple_extensions_filter`"
Fsutil Zeroing File,"The following analytic detects the execution of the 'fsutil' command with the 'setzerodata' parameter, which zeros out a target file. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because it is a technique used by ransomware, such as LockBit, to evade detection by erasing its malware path after encrypting the host.",Windows Events,"Execution, Defense Evasion",T1070,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fsutil.exe Processes.process=""*setzerodata*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `fsutil_zeroing_file_filter`"
Hide User Account From Sign-In Screen,"The following analytic detects a suspicious registry modification that hides a user account from the Windows Login screen. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist&quot; with a value of &quot;0x00000000&quot;. This activity is significant as it may indicate an adversary attempting to create a hidden admin account to avoid detection and maintain persistence on the compromised machine.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\Userlist*"" AND Registry.registry_value_data = ""0x00000000"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `hide_user_account_from_sign_in_screen_filter`"
Icacls Deny Command,"The following analytic detects instances where an adversary modifies security permissions of a file or directory using commands like &quot;icacls.exe&quot;, &quot;cacls.exe&quot;, or &quot;xcacls.exe&quot; with deny options. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it is commonly used by Advanced Persistent Threats (APTs) and coinminer scripts to evade detection and impede access to critical files.",Windows Events,"Execution, Persistence, Defense Evasion",T1222,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
Processes.process_name IN ( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") AND 
Processes.process IN (""*/deny*"", ""*/d:*"", ""*/d "") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `icacls_deny_command_filter`"
ICACLS Grant Command,"The following analytic detects the use of the ICACLS command to grant additional access permissions to files or directories. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific process names and command-line arguments. This activity is significant because it is commonly used by Advanced Persistent Threats (APTs) and coinminer scripts to evade detection and maintain control over compromised systems.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1222,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
Processes.process_name IN ( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") AND 
Processes.process IN (""*/grant*"", ""*/g:*"", ""*/g *"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `icacls_grant_command_filter`"
IcedID Exfiltrated Archived File Creation,"The following analytic detects the creation of suspicious files named passff.tar and cookie.tar, which are indicative of archived stolen browser information such as history and cookies on a machine compromised with IcedID. It leverages Sysmon EventCode 11 to identify these specific filenames. This activity is significant because it suggests that sensitive browser data has been exfiltrated, which could lead to further exploitation or data breaches.",Windows Events,"Collection, Execution",T1560.001,"| tstats `security_content_summariesonly` count values(Filesystem.file_path) as file_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_path=""*\\passff.tar"" OR Filesystem.file_path=""*\\cookie.tar"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `icedid_exfiltrated_archived_file_creation_filter`"
Jscript Execution Using Cscript App,"The following analytic detects the execution of JScript using the cscript.exe process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. This behavior is significant because JScript files are typically executed by wscript.exe, making cscript.exe execution unusual and potentially indicative of malicious activity, such as the FIN7 group's tactics.",Windows Events,"Execution, Exfiltration",T1059.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name = ""cscript.exe"" AND Processes.parent_process = ""*//e:jscript*"") OR (Processes.process_name = ""cscript.exe"" AND Processes.process = ""*//e:jscript*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `jscript_execution_using_cscript_app_filter`"
Kerberos Pre-Authentication Flag Disabled in UserAccountControl,"The following analytic detects when the Kerberos Pre-Authentication flag is disabled in a user account, using Windows Security Event 4738. This event indicates a change in the UserAccountControl property of a domain user object. Disabling this flag allows adversaries to perform offline brute force attacks on the user's password using the AS-REP Roasting technique.",Windows Events,"Execution, Credential Access, Persistence",T1558.004,"`wineventlog_security` EventCode=4738 MSADChangedAttributes=""*\'Don\'t Require Preauth\' - Enabled*"" 
|rename Account_Name as user 
| table EventCode, user, dest, Security_ID, MSADChangedAttributes 
| `kerberos_pre_authentication_flag_disabled_in_useraccountcontrol_filter`"
Linux Auditd Data Destruction Command,"The following analytic detects the execution of a Unix shell command designed to wipe root directories on a Linux host. It leverages data from Linux Auditd, focusing on the 'rm' command with force recursive deletion and the '--no-preserve-root' option. This activity is significant as it indicates potential data destruction attempts, often associated with malware like Awfulshred.",Linux,"Execution, Impact",T1485,"`linux_auditd`  (proctitle = ""*rm *"" AND proctitle = ""*-rf *"" AND proctitle = ""*--no-preserve-root*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_data_destruction_command_filter`"
Linux Data Destruction Command,"The following analytic detects the execution of a Unix shell command designed to wipe root directories on a Linux host. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on the 'rm' command with force recursive deletion and the '--no-preserve-root' option. This activity is significant as it indicates potential data destruction attempts, often associated with malware like Awfulshred.",Linux,"Execution, Impact",T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""rm""  AND Processes.process IN (""* -rf*"", ""* -fr*"") AND Processes.process = ""* --no-preserve-root"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_data_destruction_command_filter`"
Linux Indicator Removal Clear Cache,"The following analytic detects processes that clear or free page cache on a Linux system. It leverages Endpoint Detection and Response (EDR) data, focusing on specific command-line executions involving the kernel system request drop_caches. This activity is significant as it may indicate an attempt to delete forensic evidence or the presence of wiper malware like Awfulshred.",Linux,"Execution, Defense Evasion",T1070,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""dash"", ""sudo"", ""bash"")  AND Processes.process  IN(""* echo 3 &gt; *"", ""* echo 2 &gt; *"",""* echo 1 &gt; *"") AND Processes.process = ""*/proc/sys/vm/drop_caches"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_indicator_removal_clear_cache_filter`"
Linux Kworker Process In Writable Process Path,"The following analytic detects the execution of a kworker process with a command line in writable directories such as /home/, /var/log, and /tmp on a Linux machine. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process paths. This activity is significant as kworker processes are typically kernel threads, and their presence in writable directories is unusual and indicative of potential malware, such as CyclopsBlink.",Linux,"Execution, Defense Evasion",T1036.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.parent_process = ""*[kworker/*"" Processes.parent_process_path IN (""/home/*"", ""/tmp/*"", ""/var/log/*"") Processes.process=""*iptables*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_kworker_process_in_writable_process_path_filter`"
Linux Stdout Redirection To Dev Null File,"The following analytic detects command-line activities that redirect stdout or stderr to the /dev/null file. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This behavior is significant as it can indicate attempts to hide command outputs, a technique observed in the CyclopsBlink malware to conceal modifications to iptables firewall settings.",Linux,"Execution, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process = ""*&amp;&gt;/dev/null*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_stdout_redirection_to_dev_null_file_filter`"
Linux System Reboot Via System Request Key,The following analytic detects the execution of the SysReq hack to reboot a Linux system host. It leverages Endpoint Detection and Response (EDR) data to identify processes executing the command to pipe 'b' to /proc/sysrq-trigger. This activity is significant as it is an uncommon method to reboot a system and was observed in the Awfulshred malware wiper.,Linux,"Execution, Impact",T1529,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""dash"", ""sudo"", ""bash"")  Processes.process =  ""* echo b &gt; *"" Processes.process = ""*/proc/sysrq-trigger"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_system_reboot_via_system_request_key_filter`"
Linux Unix Shell Enable All SysRq Functions,"The following analytic detects the execution of a command to enable all SysRq functions on a Linux system, a technique associated with the AwfulShred malware. It leverages Endpoint Detection and Response (EDR) data to identify processes executing the command to pipe bitmask '1' to /proc/sys/kernel/sysrq. This activity is significant as it can indicate an attempt to manipulate kernel system requests, which is uncommon and potentially malicious.",Linux,Execution,T1059.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""dash"", ""sudo"", ""bash"")  Processes.process =  ""* echo 1 &gt; *"" Processes.process = ""*/proc/sys/kernel/sysrq"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_unix_shell_enable_all_sysrq_functions_filter`"
Logon Script Event Trigger Execution,"The following analytic detects the modification of the UserInitMprLogonScript registry entry, which is often used by attackers to establish persistence and gain privilege escalation upon system boot. It leverages data from the Endpoint.Registry data model, focusing on changes to the specified registry path. This activity is significant because it is a common technique used by APT groups and malware to ensure their payloads execute automatically when the system starts.",Windows Events,"Execution, Persistence, Privilege Escalation","T1037.001, T1037","| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\Environment\\UserInitMprLogonScript"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `logon_script_event_trigger_execution_filter`"
MacOS AMOS Stealer - Virtual Machine Check Activity,The following analytic detects AMOS Stealer VM check activity on macOS. It leverages osquery to monitor process events and identifies the execution of the &quot;osascript&quot; command along with specific commandline strings. This activity is significant as AMOS stealer was seen using this pattern in order to check if the host is a Virtual Machine or not.,MacOS (OSQuery),Execution,T1059.002,"`osquery_macro` name=es_process_events 
columns.cmdline=""*osascript*"" AND columns.cmdline=""* -e *"" AND columns.cmdline=""*set*"" AND columns.cmdline=""*system_profiler*"" AND columns.cmdline IN (""*VMware*"", ""*QEMU*"") 
| rename columns.* as * 
| stats  min(_time) as firstTime max(_time) as lastTime 
values(cmdline) as cmdline, 
values(pid) as pid, 
values(parent) as parent, 
values(path) as path,
values(signing_id) as signing_id,  
by username host 
| rename 
username as user, 
cmdline as process, 
parent as parent_process, 
path as process_path, 
host as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `macos_amos_stealer___virtual_machine_check_activity_filter`"
MacOS LOLbin,"The following analytic detects multiple executions of Living off the Land (LOLbin) binaries on macOS within a short period. It leverages osquery to monitor process events and identifies commands such as &quot;find&quot;, &quot;crontab&quot;, &quot;screencapture&quot;, &quot;openssl&quot;, &quot;curl&quot;, &quot;wget&quot;, &quot;killall&quot;, and &quot;funzip&quot;. This activity is significant as LOLbins are often used by attackers to perform malicious actions while evading detection.",MacOS (OSQuery),Execution,T1059.004,"`osquery_macro` name=es_process_events columns.cmdline IN (""find*"", ""crontab*"", ""screencapture*"", ""openssl*"", ""curl*"", ""wget*"", ""killall*"", ""funzip*"") 
| rename columns.* as * 
| stats  min(_time) as firstTime max(_time) as lastTime values(cmdline) as cmdline, values(pid) as pid, values(parent) as parent, values(path) as path, values(signing_id) as signing_id,  dc(path) as dc_path by username host 
| rename username as user, cmdline as process, path as process_path, host as dest 
| where dc_path > 3 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `macos_lolbin_filter`"
Mailsniper Invoke functions,"The following analytic detects the execution of known MailSniper PowerShell functions on a machine. It leverages PowerShell logs (EventCode 4104) to identify specific script block text associated with MailSniper activities. This behavior is significant as MailSniper is often used by attackers to harvest sensitive emails from compromised Exchange servers. If confirmed malicious, this activity could lead to unauthorized access to sensitive email data, credential theft, and further compromise of the email infrastructure.",Office 365 (Microsoft 365),"Collection, Execution, Exfiltration",T1114.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*Invoke-GlobalO365MailSearch*"", ""*Invoke-GlobalMailSearch*"", ""*Invoke-SelfSearch*"", ""*Invoke-PasswordSprayOWA*"", ""*Invoke-PasswordSprayEWS*"",""*Invoke-DomainHarvestOWA*"", ""*Invoke-UsernameHarvestOWA*"",""*Invoke-OpenInboxFinder*"",""*Invoke-InjectGEventAPI*"",""*Invoke-InjectGEvent*"",""*Invoke-SearchGmail*"", ""*Invoke-MonitorCredSniper*"", ""*Invoke-AddGmailRule*"",""*Invoke-PasswordSprayEAS*"",""*Invoke-UsernameHarvestEAS*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `mailsniper_invoke_functions_filter`"
Malicious PowerShell Process With Obfuscation Techniques,"The following analytic detects PowerShell processes launched with command-line arguments indicative of obfuscation techniques. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and complete command-line executions. This activity is significant because obfuscated PowerShell commands are often used by attackers to evade detection and execute malicious scripts.",Windows Events,"Execution, Privilege Escalation",T1059.001,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| eval num_obfuscation = (mvcount(split(process,""`""))-1) + (mvcount(split(process, ""^""))-1) + (mvcount(split(process, ""'""))-1) 
| search num_obfuscation > 10 
| `malicious_powershell_process_with_obfuscation_techniques_filter`"
Powershell Remote Thread To Known Windows Process,"The following analytic detects suspicious PowerShell processes attempting to inject code into critical Windows processes using CreateRemoteThread. It leverages Sysmon EventCode 8 to identify instances where PowerShell spawns threads in processes like svchost.exe, csrss.exe, and others. This activity is significant as it is commonly used by malware such as TrickBot and offensive tools like Cobalt Strike to execute malicious payloads, establish reverse shells, or download additional malware.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1055,"`sysmon` EventCode = 8 parent_process_name IN (""powershell_ise.exe"", ""powershell.exe"") TargetImage IN (""*\\svchost.exe"",""*\\csrss.exe"" ""*\\gpupdate.exe"", ""*\\explorer.exe"",""*\\services.exe"",""*\\winlogon.exe"",""*\\smss.exe"",""*\\wininit.exe"",""*\\userinit.exe"",""*\\spoolsv.exe"",""*\\taskhost.exe"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_remote_thread_to_known_windows_process_filter`"
Powershell Remove Windows Defender Directory,"The following analytic detects a suspicious PowerShell command attempting to delete the Windows Defender directory. It leverages PowerShell Script Block Logging to identify commands containing &quot;rmdir&quot; and targeting the Windows Defender path. This activity is significant as it may indicate an attempt to disable or corrupt Windows Defender, a key security component. If confirmed malicious, this action could allow an attacker to bypass endpoint protection, facilitating further malicious activities without detection.",Windows Events,Defense Evasion,T1562.001,"`powershell` EventCode=4104 ScriptBlockText = ""*rmdir *"" AND ScriptBlockText = ""*\\Microsoft\\Windows Defender*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_remove_windows_defender_directory_filter`"
PowerShell Script Block With URL Chain,"The following analytic identifies suspicious PowerShell script execution via EventCode 4104 that contains multiple URLs within a function or array. It leverages PowerShell operational logs to detect script blocks with embedded URLs, often indicative of obfuscated scripts or those attempting to download secondary payloads. This activity is significant as it may signal an attempt to execute malicious code or download additional malware.",Windows Events,"Command And Control, Execution, Exfiltration","T1059.001, T1105, T1059","`powershell` EventCode=4104 ScriptBlockText IN (""*http:*"",""*https:*"") 
| regex ScriptBlockText=""(\""?(https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*))\""?(?:,
|\))?){2,}"" 
| rex max_match=20 field=ScriptBlockText ""(?<url>https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*))"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_script_block_with_url_chain_filter`"
PowerShell WebRequest Using Memory Stream,"The following analytic detects the use of .NET classes in PowerShell to download a URL payload directly into memory, a common fileless malware staging technique. It leverages PowerShell Script Block Logging (EventCode=4104) to identify suspicious PowerShell commands involving system.net.webclient, system.net.webrequest, and IO.MemoryStream. This activity is significant as it indicates potential fileless malware execution, which is harder to detect and can bypass traditional file-based defenses.",Windows Events,"Command And Control, Execution, Persistence, Defense Evasion","T1059.001, T1105, T1027.011, T1059","`powershell` EventCode=4104  ScriptBlockText IN (""*system.net.webclient*"",""*system.net.webrequest*"") AND ScriptBlockText=""*IO.MemoryStream*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_webrequest_using_memory_stream_filter`"
Print Spooler Adding A Printer Driver,"The following analytic detects the addition of new printer drivers by monitoring Windows PrintService operational logs, specifically EventCode 316. This detection leverages log data to identify messages indicating the addition or update of printer drivers, such as &quot;kernelbase.dll&quot; and &quot;UNIDRV.DLL.&quot; This activity is significant as it may indicate exploitation attempts related to vulnerabilities like CVE-2021-34527 (PrintNightmare).",Windows Events,"Execution, Persistence",T1547.012,"`printservice` EventCode=316 category = ""Adding a printer driver"" Message = ""*kernelbase.dll,*"" Message = ""*UNIDRV.DLL,*"" Message = ""*.DLL.*"" 
| stats  count min(_time) as firstTime max(_time) as lastTime by OpCode EventCode ComputerName Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `print_spooler_adding_a_printer_driver_filter`"
Process Deleting Its Process File Path,"The following analytic identifies a process attempting to delete its own file path, a behavior often associated with defense evasion techniques. This detection leverages Sysmon EventCode 1 logs, focusing on command lines executed via cmd.exe that include deletion commands. This activity is significant as it may indicate malware, such as Clop ransomware, trying to evade detection by removing its executable file if certain conditions are met.",Windows Events,"Execution, Defense Evasion",T1070,"`sysmon` EventCode=1 CommandLine = ""* /c *"" CommandLine = ""* del*"" Image = ""*\\cmd.exe"" 
| eval result = if(like(process,""%"".parent_process.""%""), ""Found"", ""Not Found"") 
| stats min(_time) as firstTime max(_time) as lastTime count by action dest original_file_name parent_process parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process process_exec process_guid process_hash process_id process_integrity_level process_name process_path user user_id vendor_product result 
| where result = ""Found"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `process_deleting_its_process_file_path_filter`"
Process Kill Base On File Path,"The following analytic detects the use of wmic.exe with the delete command to remove an executable path. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant because it often indicates the initial stages of an adversary setting up malicious activities, such as cryptocurrency mining, on an endpoint.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` values(Processes.process) as process values(Processes.process_id) as process_id count min(_time) as firstTime max(_time) as lastTime  from datamodel=Endpoint.Processes where `process_wmic` AND Processes.process=""*process*"" AND Processes.process=""*executablepath*"" AND Processes.process=""*delete*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `process_kill_base_on_file_path_filter`"
Ransomware Notes bulk creation,"The following analytic identifies the bulk creation of ransomware notes (e.g., .txt, .html, .hta files) on an infected machine. It leverages Sysmon EventCode 11 to detect multiple instances of these file types being created within a short time frame. This activity is significant as it often indicates an active ransomware attack, where the attacker is notifying the victim of the encryption.",Windows Events,Impact,T1486,"`sysmon` EventCode=11 file_name IN (""*\.txt"",""*\.html"",""*\.hta"") 
| bin _time span=10s 
| stats min(_time) as firstTime max(_time) as lastTime dc(TargetFilename) as unique_readme_path_count values(TargetFilename) as list_of_readme_path values(action) as action values(file_access_time) as file_access_time values(file_create_time) as file_create_time values(file_hash) as file_hash values(file_modify_time) as file_modify_time values(file_path) as file_path values(file_acl) as file_acl values(file_size) as file_size values(process_guid) as process_guid values(process_id) as process_id values(user) as user values(vendor_product) as vendor_product by dest file_name 
| where unique_readme_path_count >= 15 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ransomware_notes_bulk_creation_filter`"
Remcos client registry install entry,"The following analytic detects the presence of a registry key associated with the Remcos RAT agent on a host. It leverages data from the Endpoint.Processes and Endpoint.Registry data models in Splunk, focusing on instances where the &quot;license&quot; key is found in the &quot;Software\Remcos&quot; path. This behavior is significant as it indicates potential compromise by the Remcos RAT, a remote access Trojan used for unauthorized access and data exfiltration.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=*\\Software\\Remcos*) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`remcos_client_registry_install_entry_filter`"
Remcos RAT File Creation in Remcos Folder,"The following analytic detects the creation of files in the Remcos folder within the AppData directory, specifically targeting keylog and clipboard log files. It leverages the Endpoint.Filesystem data model to identify .dat files created in paths containing &quot;remcos.&quot; This activity is significant as it indicates the presence of the Remcos RAT, which performs keylogging, clipboard capturing, and audio recording.",Windows Events,"Collection, Execution, Exfiltration",T1113,"|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.dat"") Filesystem.file_path = ""*\\remcos\\*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remcos_rat_file_creation_in_remcos_folder_filter`"
Revil Registry Entry,"The following analytic identifies suspicious modifications in the registry entry, specifically targeting paths used by malware like REVIL. It detects changes in registry paths such as SOFTWARE\\WOW6432Node\\Facebook_Assistant and SOFTWARE\\WOW6432Node\\BlackLivesMatter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry modifications linked to process GUIDs. This activity is significant as it indicates potential malware persistence mechanisms, often used by advanced persistent threats (APTs) and ransomware.",Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\SOFTWARE\\WOW6432Node\\Facebook_Assistant\\*"" OR Registry.registry_path=""*\\SOFTWARE\\WOW6432Node\\BlackLivesMatter*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `revil_registry_entry_filter`"
Rundll32 Create Remote Thread To A Process,"The following analytic detects the creation of a remote thread by rundll32.exe into another process. It leverages Sysmon EventCode 8 logs, specifically monitoring SourceImage and TargetImage fields. This activity is significant as it is a common technique used by malware, such as IcedID, to execute malicious code within legitimate processes, aiding in defense evasion and data theft.",Windows Events,"Execution, Defense Evasion",T1055,"`sysmon` EventCode=8 SourceImage = ""*\\rundll32.exe"" TargetImage = ""*.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_create_remote_thread_to_a_process_filter`"
Rundll32 CreateRemoteThread In Browser,"The following analytic detects the suspicious creation of a remote thread by rundll32.exe targeting browser processes such as firefox.exe, chrome.exe, iexplore.exe, and microsoftedgecp.exe. This detection leverages Sysmon EventCode 8, focusing on SourceImage and TargetImage fields to identify the behavior. This activity is significant as it is commonly associated with malware like IcedID, which hooks browsers to steal sensitive information such as banking details.",Windows Events,"Execution, Defense Evasion",T1055,"`sysmon` EventCode=8 SourceImage = ""*\\rundll32.exe"" TargetImage IN (""*\\firefox.exe"", ""*\\chrome.exe"", ""*\\iexplore.exe"",""*\\microsoftedgecp.exe"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_createremotethread_in_browser_filter`"
Rundll32 LockWorkStation,"The following analytic detects the execution of the rundll32.exe command with the user32.dll,LockWorkStation parameter, which is used to lock the workstation via command line. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it is an uncommon method to lock a screen and has been observed in CONTI ransomware tooling for defense evasion.",Windows Events,"Execution, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=rundll32.exe Processes.process= ""*user32.dll,LockWorkStation*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_lockworkstation_filter`"
Rundll32 Process Creating Exe Dll Files,"The following analytic detects a rundll32 process creating executable (.exe) or dynamic link library (.dll) files. It leverages Sysmon EventCode 11 to identify instances where rundll32.exe generates these file types. This activity is significant because rundll32 is often exploited by malware, such as IcedID, to drop malicious payloads in directories like Temp, AppData, or ProgramData.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.011,"`sysmon` EventCode=11 Image=""*rundll32.exe"" TargetFilename IN (""*.exe"", ""*.dll"") 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path process_guid process_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_process_creating_exe_dll_files_filter`"
Rundll32 Shimcache Flush,"The following analytic detects the execution of a suspicious rundll32 command line used to clear the shim cache. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant because clearing the shim cache is an anti-forensic technique aimed at evading detection and removing forensic artifacts.",Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  `process_rundll32` AND Processes.process = ""*apphelp.dll,ShimFlushCache*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_shimcache_flush_filter`"
Schedule Task with HTTP Command Arguments,"The following analytic detects the creation of scheduled tasks on Windows systems that include HTTP command arguments, using Windows Security EventCode 4698. It identifies tasks registered via schtasks.exe or TaskService with HTTP in their command arguments. This behavior is significant as it often indicates malware activity or the use of Living off the Land binaries (lolbins) to download additional payloads.",Windows Events,"Execution, Persistence, Exfiltration",T1053,"`wineventlog_security` EventCode=4698 
| xmlkv Message
| search Arguments IN (""*http*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, Task_Name, Command, Author, Enabled, Hidden, Arguments 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `schedule_task_with_http_command_arguments_filter`"
Schedule Task with Rundll32 Command Trigger,"The following analytic detects the creation of scheduled tasks in Windows that use the rundll32 command. It leverages Windows Security EventCode 4698, which logs the creation of scheduled tasks, and filters for tasks executed via rundll32. This activity is significant as it is a common technique used by malware, such as TrickBot, to persist in an environment or deliver additional payloads.",Windows Events,"Execution, Persistence",T1053,"`wineventlog_security` EventCode=4698 
| xmlkv Message 
| search Command IN (""*rundll32*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, Task_Name, Command, Author, Enabled, Hidden, Arguments 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `schedule_task_with_rundll32_command_trigger_filter`"
Screensaver Event Trigger Execution,"The following analytic detects modifications to the SCRNSAVE.EXE registry entry, indicating potential event trigger execution via screensaver settings for persistence or privilege escalation. It leverages registry activity data from the Endpoint data model to identify changes to the specified registry path. This activity is significant as it is a known technique used by APT groups and malware to maintain persistence or escalate privileges.",Windows Events,"Execution, Persistence, Privilege Escalation","T1546.002, T1546","| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=""*\\Control Panel\\Desktop\\SCRNSAVE.EXE*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `screensaver_event_trigger_execution_filter`"
Shim Database Installation With Suspicious Parameters,"The following analytic detects the execution of sdbinst.exe with parameters indicative of silently creating a shim database. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line arguments. This activity is significant because shim databases can be used to intercept and manipulate API calls, potentially allowing attackers to bypass security controls or achieve persistence.",Windows Events,"Execution, Persistence, Privilege Escalation",T1546.011,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sdbinst.exe NOT Processes.process IN (""\""C:\\Windows\\System32\\sdbinst.exe\"""", ""C:\\Windows\\System32\\sdbinst.exe"", ""*-mm"", ""*-?"", ""*-m -bg"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `shim_database_installation_with_suspicious_parameters_filter`"
SilentCleanup UAC Bypass,"The following analytic detects suspicious modifications to the registry that may indicate a UAC (User Account Control) bypass attempt via the SilentCleanup task. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry changes in the path &quot;*\Environment\windir&quot; with executable values. This activity is significant as it can allow an attacker to gain high-privilege execution without user consent, bypassing UAC protections.",Windows Events,"Execution, Persistence, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Environment\\windir"" Registry.registry_value_data = ""*.exe*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `silentcleanup_uac_bypass_filter`"
Spoolsv Suspicious Loaded Modules,"The following analytic detects the suspicious loading of DLLs by spoolsv.exe, potentially indicating PrintNightmare exploitation. It leverages Sysmon EventCode 7 to identify instances where spoolsv.exe loads multiple DLLs from the Windows System32 spool drivers x64 directory. This activity is significant as it may signify an attacker exploiting the PrintNightmare vulnerability to execute arbitrary code.",Windows Events,"Execution, Persistence, Privilege Escalation",T1547.012,"`sysmon` EventCode=7 Image =""*\\spoolsv.exe"" ImageLoaded=""*\\Windows\\System32\\spool\\drivers\\x64\\*"" ImageLoaded = ""*.dll"" 
| stats dc(ImageLoaded) as countImgloaded values(ImageLoaded) as ImageLoaded values(loaded_file) as loaded_file values(loaded_file_path) as loaded_file_path values(original_file_name) as original_file_name values(process_exec) as process_exec values(process_guid) as process_guid values(process_hash) as process_hash values(process_name) as process_name values(service_dll_signature_exists) as service_dll_signature_exists values(service_dll_signature_verified) as service_dll_signature_verified values(signature) as signature values(signature_id) as signature_id values(user_id) as user_id values(vendor_product) as vendor_product values(Image) as Image count min(_time) as firstTime max(_time) as lastTime by process_path dest process_id 
| where countImgloaded >= 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `spoolsv_suspicious_loaded_modules_filter`"
Spoolsv Suspicious Process Access,"The following analytic detects suspicious process access by spoolsv.exe, potentially indicating exploitation of the PrintNightmare vulnerability (CVE-2021-34527). It leverages Sysmon EventCode 10 to identify when spoolsv.exe accesses critical system files or processes like rundll32.exe with elevated privileges. This activity is significant as it may signal an attempt to gain unauthorized privilege escalation on a vulnerable machine.",Windows Events,"Execution, Privilege Escalation",T1068,"`sysmon` EventCode=10 SourceImage = ""*\\spoolsv.exe"" CallTrace = ""*\\Windows\\system32\\spool\\DRIVERS\\x64\\*"" TargetImage IN (""*\\rundll32.exe"", ""*\\spoolsv.exe"") GrantedAccess = 0x1fffff 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `spoolsv_suspicious_process_access_filter`"
Spoolsv Writing a DLL,"The following analytic detects spoolsv.exe writing a .dll file, which is unusual behavior and may indicate exploitation of vulnerabilities like CVE-2021-34527 (PrintNightmare). This detection leverages the Endpoint datamodel, specifically monitoring process and filesystem events to identify .dll file creation within the \spool\drivers\x64\ path. This activity is significant as it may signify an attacker attempting to execute malicious code via the Print Spooler service.",Windows Events,"Execution, Persistence",T1547.012,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=spoolsv.exe by _time Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| join process_guid, _time [
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path=""*\\spool\\drivers\\x64\\*"" Filesystem.file_name=""*.dll"" by _time Filesystem.dest Filesystem.process_guid Filesystem.file_create_time Filesystem.file_name Filesystem.file_path 
| `drop_dm_object_name(Filesystem)` 
| fields _time dest file_create_time file_name file_path process_name process_path process_guid process] 
| dedup file_create_time 
| table  dest file_create_time, file_name, file_path, process_name process_guid 
| `spoolsv_writing_a_dll_filter`"
Sqlite Module In Temp Folder,"The following analytic detects the creation of sqlite3.dll files in the %temp% folder. It leverages Sysmon EventCode 11 to identify when these files are written to the temporary directory. This activity is significant because it is associated with IcedID malware, which uses the sqlite3 module to parse browser databases and steal sensitive information such as banking details, credit card information, and credentials.",Windows Events,"Collection, Execution",T1005,"`sysmon` EventCode=11 (TargetFilename = ""*\\sqlite32.dll"" OR TargetFilename = ""*\\sqlite64.dll"") (TargetFilename = ""*\\temp\\*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path  process_guid process_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `sqlite_module_in_temp_folder_filter`"
Sunburst Correlation DLL and Network Event,The following analytic identifies the loading of the malicious SolarWinds.,Windows Events,"Execution, Exfiltration",T1203,"(`sysmon` EventCode=7 ImageLoaded=*SolarWinds.Orion.Core.BusinessLayer.dll) OR (`sysmon` EventCode=22 QueryName=*avsvmcloud.com) 
| eventstats dc(EventCode) AS dc_events 
| where dc_events=2 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `sunburst_correlation_dll_and_network_event_filter`"
Suspicious Image Creation In Appdata Folder,"The following analytic detects the creation of image files in the AppData folder by processes that also have a file reference in the same folder. It leverages data from the Endpoint.Processes and Endpoint.Filesystem datamodels to identify this behavior. This activity is significant because it is commonly associated with malware, such as the Remcos RAT, which captures screenshots and stores them in the AppData folder before exfiltrating them to a command-and-control server.",Windows Events,"Collection, Execution, Exfiltration",T1113,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=*.exe Processes.process_path=""*\\appdata\\Roaming\\*"" by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
|rename process_guid as proc_guid 
|join proc_guid, _time [
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.png"",""*.jpg"",""*.bmp"",""*.gif"",""*.tiff"") Filesystem.file_path= ""*\\appdata\\Roaming\\*"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
|rename process_guid as proc_guid 
| fields _time dest file_create_time file_name file_path process_name process_path process proc_guid] 
| `suspicious_image_creation_in_appdata_folder_filter`"
Suspicious SQLite3 LSQuarantine Behavior,The following analytic identifies the use of SQLite3 querying the MacOS preferences to determine the original URL from which a package was downloaded.,Windows Events,"Collection, Execution",T1074,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=sqlite3 Processes.process=*LSQuarantine* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `suspicious_sqlite3_lsquarantine_behavior_filter`"
Suspicious WAV file in Appdata Folder,"The following analytic detects the creation of .wav files in the AppData folder, a behavior associated with Remcos RAT malware, which stores audio recordings in this location for data exfiltration. The detection leverages endpoint process and filesystem data to identify .wav file creation within the AppData\Roaming directory. This activity is significant as it indicates potential unauthorized data collection and exfiltration by malware.",Windows Events,"Command And Control, Execution, Collection, Persistence, Exfiltration",T1113,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=*.exe Processes.process_path=""*\\appdata\\Roaming\\*"" by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
|rename process_guid as proc_guid 
| join proc_guid, _time [ 
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.wav"") Filesystem.file_path = ""*\\appdata\\Roaming\\*"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
|rename process_guid as proc_guid 
| fields file_name file_path process_name process_path process dest file_create_time _time proc_guid] 
| `suspicious_wav_file_in_appdata_folder_filter`"
Time Provider Persistence Registry,"The following analytic detects suspicious modifications to the time provider registry for persistence and autostart. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;CurrentControlSet\Services\W32Time\TimeProviders&quot; registry path. This activity is significant because such modifications are uncommon and can indicate an attempt to establish persistence on a compromised host.",Windows Events,"Persistence, Privilege Escalation","T1547, T1547.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\CurrentControlSet\\Services\\W32Time\\TimeProviders*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `time_provider_persistence_registry_filter`"
Trickbot Named Pipe,"The following analytic detects the creation or connection to a named pipe associated with Trickbot malware. It leverages Sysmon EventCodes 17 and 18 to identify named pipes with the pattern &quot;\pipe\*lacesomepipe&quot;. This activity is significant as Trickbot uses named pipes for communication with its command and control (C2) servers, facilitating data exfiltration and command execution.",Windows Events,"Command And Control, Execution, Persistence, Defense Evasion, Exfiltration",T1055,"`sysmon` EventCode IN (17,18) PipeName=""\\pipe\\*lacesomepipe"" 
| stats  min(_time) as firstTime max(_time) as lastTime count by dest dvc pipe_name process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Image PipeName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `trickbot_named_pipe_filter`"
UAC Bypass MMC Load Unsigned Dll,"The following analytic detects the loading of an unsigned DLL by the MMC.exe application, which is indicative of a potential UAC bypass or privilege escalation attempt. It leverages Sysmon EventCode 7 to identify instances where MMC.exe loads a non-Microsoft, unsigned DLL. This activity is significant because attackers often use this technique to modify CLSID registry entries, causing MMC.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1218.014, T1548.002","`sysmon` EventCode=7  ImageLoaded = ""*.dll"" Image = ""*\\mmc.exe"" Signed=false Company != ""Microsoft Corporation"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `uac_bypass_mmc_load_unsigned_dll_filter`"
Uninstall App Using MsiExec,"The following analytic detects the uninstallation of applications using msiexec with specific command-line arguments. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it is an uncommon practice in enterprise environments and has been associated with malicious behavior, such as disabling antivirus software.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=msiexec.exe Processes.process= ""* /qn *"" Processes.process= ""*/X*"" Processes.process= ""*REBOOT=*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `uninstall_app_using_msiexec_filter`"
Unload Sysmon Filter Driver,"The following analytic detects the use of fltMC.exe to unload the Sysmon driver, which stops Sysmon from collecting data. It leverages Endpoint Detection and Response (EDR) logs, focusing on process names and command-line executions. This activity is significant because disabling Sysmon can blind security monitoring, allowing malicious actions to go undetected. If confirmed malicious, this could enable attackers to execute further attacks without being logged, leading to potential data breaches, privilege escalation, or persistent access within the environment.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fltMC.exe AND Processes.process=*unload* AND Processes.process=*SysmonDrv* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)` 
| table firstTime lastTime dest user count process_name process_id parent_process_name process 
| `unload_sysmon_filter_driver_filter`"
Unusually Long Command Line,"The following analytic detects unusually long command lines, which may indicate malicious activity.",Windows Events,Execution,,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
|  eval processlen=len(process) 
| eventstats stdev(processlen) as stdev, avg(processlen) as avg by dest 
| stats max(processlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by dest, user, process_name, process 
|eval threshold = 3 
| where maxlen > ((threshold*stdevperhost) + avgperhost) 
| `unusually_long_command_line_filter`"
USN Journal Deletion,"The following analytic detects the deletion of the USN Journal using the fsutil.exe utility. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because the USN Journal maintains a log of all changes made to files on the disk, and its deletion can be an indicator of an attempt to cover tracks or hinder forensic investigations.",Windows Events,"Execution, Defense Evasion",T1070,"| tstats `security_content_summariesonly` 
count values(Processes.process) as process 
values(Processes.parent_process) as parent_process 
min(_time) as firstTime
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
Processes.process_name=fsutil.exe
Processes.process = ""*usn*"" 
Processes.process = ""*deletejournal*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `usn_journal_deletion_filter`"
Vbscript Execution Using Wscript App,"The following analytic detects the execution of VBScript using the wscript.exe application. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. This activity is significant because wscript.exe is typically not used to execute VBScript, which is usually associated with cscript.exe. This deviation can indicate an attempt to evade traditional process monitoring and antivirus defenses.",Windows Events,"Lateral Movement, Execution, Exfiltration",T1059.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name = ""wscript.exe"" AND Processes.parent_process = ""*//e:vbscript*"") OR (Processes.process_name = ""wscript.exe"" AND Processes.process = ""*//e:vbscript*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `vbscript_execution_using_wscript_app_filter`"
Wermgr Process Create Executable File,"The following analytic detects the wermgr.exe process creating an executable file. It leverages Sysmon EventCode 11 to identify instances where wermgr.exe generates a .exe file. This behavior is unusual because wermgr.exe is typically associated with error reporting, not file creation. Such activity is significant as it may indicate TrickBot malware, which injects code into wermgr.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1027,"`sysmon` EventCode=11 process_name = ""wermgr.exe"" TargetFilename = ""*.exe"" 
| stats  min(_time) as firstTime max(_time) as lastTime count by action dest file_name file_path  process_guid process_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wermgr_process_create_executable_file_filter`"
Wermgr Process Spawned CMD Or Powershell Process,"The following analytic detects the spawning of cmd or PowerShell processes by the wermgr.exe process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process telemetry, including parent-child process relationships and command-line executions. This behavior is significant as it is commonly associated with code injection techniques used by malware like TrickBot to execute shellcode or malicious DLL modules.",Windows Events,"Execution, Persistence",T1059,"| tstats `security_content_summariesonly` values(Processes.process) as cmdline min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = ""wermgr.exe"" `process_cmd` OR `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wermgr_process_spawned_cmd_or_powershell_process_filter`"
Windows AD add Self to Group,"This analytic detects instances where a user adds themselves to an Active Directory (AD) group. This activity is a common indicator of privilege escalation, where a user attempts to gain unauthorized access to higher privileges or sensitive resources. By monitoring AD logs, this detection identifies such suspicious behavior, which could be part of a larger attack strategy aimed at compromising critical systems and data.",Windows Events,"Persistence, Privilege Escalation",T1098,"`wineventlog_security` EventCode IN (4728) 
| where user=src_user 
| stats min(_time) as _time dc(user) as usercount, values(user) as user values(user_category) as user_category values(src_user_category) as src_user_category values(dvc) as dvc by signature, Group_Name, src_user, dest 
| `windows_ad_add_self_to_group_filter`"
Windows AD Dangerous Deny ACL Modification,"This detection identifies an Active Directory access-control list (ACL) modification event, which applies permissions that deny the ability to enumerate permissions of the object.
Search 1`wineventlog_security` EventCode=5136 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace  
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$""  
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights  
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value as aceType 
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats values(aceType) as aceType values(aceFlags) as aceFlags values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(aceInheritedTypeGuid) as aceInheritedTypeGuid by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| search aceType IN (""Access denied"",D) AND aceAccessRights IN (""Full control"",""Read permissions"",RC) 
| `windows_ad_dangerous_deny_acl_modification_filter`"
Windows AD Dangerous Group ACL Modification,"This detection monitors the addition of the following ACLs to an Active Directory group object: &quot;Full control&quot;, &quot;All extended rights&quot;, &quot;All validated writes&quot;, &quot;Create all child objects&quot;, &quot;Delete all child objects&quot;, &quot;Delete subtree&quot;, &quot;Delete&quot;, &quot;Modify permissions&quot;, &quot;Modify owner&quot;, and &quot;Write all properties&quot;. Such modifications can indicate potential privilege escalation or malicious activity. Immediate investigation is recommended upon alert.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=group 
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace  
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$""  
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value as aceType 
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceInheritance=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=if((ControlAccessRights=""Write member"" OR aceObjectGuid=""bf9679c0-0de6-11d0-a285-00aa003049e2"") AND (aceAccessRights=""All validated writes"" OR AccessRights=""SW""),""Add/remove self as member"",coalesce(ControlAccessRights,aceObjectGuid)), user=coalesce(user, group, builtin_group, aceSid) 
| stats values(aceType) as aceType values(aceInheritance) as aceInheritance values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(aceInheritedTypeGuid) as aceInheritedTypeGuid by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| search NOT aceType IN (""*denied*"",""D"",""OD"",""XD"") AND aceAccessRights IN (""Full control"",""All extended rights"",""All validated writes"",""Create all child objects"",""Delete all child objects"",""Delete subtree"",""Delete"",""Modify permissions"",""Modify owner"",""Write all properties"",CC,CR,DC,DT,SD,SW,WD,WO,WP) 
| `windows_ad_dangerous_group_acl_modification_filter`"
Windows AD Dangerous User ACL Modification,"This detection monitors the addition of the following ACLs to an Active Directory user object: &quot;Full control&quot;,&quot;All extended rights&quot;,&quot;All validated writes&quot;, &quot;Create all child objects&quot;,&quot;Delete all child objects&quot;,&quot;Delete subtree&quot;,&quot;Delete&quot;,&quot;Modify permissions&quot;,&quot;Modify owner&quot;,&quot;Write all properties&quot;. Such modifications can indicate potential privilege escalation or malicious activity. Immediate investigation is recommended upon alert.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=user 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=user  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace  
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$""  
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights  
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value as aceType 
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats values(aceType) as aceType values(aceFlags) as aceFlags values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(aceInheritedTypeGuid) as aceInheritedTypeGuid by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| search NOT aceType IN (*denied*,D,OD,XD) AND aceAccessRights IN (""Full control"",""All extended rights"",""All validated writes"",""Create all child objects"",""Delete all child objects"",""Delete subtree"",""Delete"",""Modify permissions"",""Modify owner"",""Write all properties"",CC,CR,DC,DT,SD,SW,WD,WO,WP) 
| `windows_ad_dangerous_user_acl_modification_filter`"
Windows AD DCShadow Privileges ACL Addition,"This detection identifies an Active Directory access-control list (ACL) modification event, which applies the minimum required extended rights to perform the DCShadow attack.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=domainDNS 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1207, T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=domainDNS  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace 
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);;(?P<aceSid>.*?)$"" 
| search aceObjectGuid IN (""9923a32a-3607-11d2-b9be-0000f87a36b2"",""1131f6ab-9c07-11d1-f79f-00c04fc2dcd2"",""1131f6ac-9c07-11d1-f79f-00c04fc2dcd2"") 
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats min(_time) as _time values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(SubjectLogonId) as SubjectLogonId by ObjectClass ObjectDN src_user user 
| search (aceControlAccessRights=""Add/Remove Replica In Domain"" AND aceControlAccessRights=""Manage Replication Topology"" AND aceControlAccessRights=""Replication Synchronization"") OR (aceControlAccessRights=""9923a32a-3607-11d2-b9be-0000f87a36b2"" AND aceControlAccessRights=""1131f6ab-9c07-11d1-f79f-00c04fc2dcd2"" AND aceControlAccessRights=""1131f6ac-9c07-11d1-f79f-00c04fc2dcd2"") 
| `windows_ad_dcshadow_privileges_acl_addition_filter`"
Windows AD Domain Controller Audit Policy Disabled,The following analytic detects the disabling of audit policies on a domain controller. It leverages EventCode 4719 from Windows Security Event Logs to identify changes where success or failure auditing is removed. This activity is significant as it suggests an attacker may have gained access to the domain controller and is attempting to evade detection by tampering with audit policies.,Windows Events,"Privilege Escalation, Defense Evasion",T1562.001,"`wineventlog_security` EventCode=4719 (AuditPolicyChanges IN (""%%8448"",""%%8450"",""%%8448, %%8450"") OR Changes IN (""Failure removed"",""Success removed"",""Success removed, Failure removed"")) dest_category=""domain_controller""
| replace ""%%8448"" with ""Success removed"", ""%%8450"" with ""Failure removed"", ""%%8448, %%8450"" with ""Success removed, Failure removed"" in AuditPolicyChanges 
| eval AuditPolicyChanges=coalesce(AuditPolicyChanges,Changes), SubcategoryGuid=coalesce(SubcategoryGuid,Subcategory_GUID) 
| stats min(_time) as _time values(host) as dest by AuditPolicyChanges SubcategoryGuid 
| lookup advanced_audit_policy_guids GUID as SubcategoryGuid OUTPUT Category SubCategory 
| `windows_ad_domain_controller_audit_policy_disabled_filter`"
Windows AD Domain Controller Promotion,"The following analytic identifies a genuine Domain Controller (DC) promotion event by detecting when a computer assigns itself the necessary Service Principal Names (SPNs) to function as a domain controller. It leverages Windows Security Event Code 4742 to monitor existing domain controllers for these changes. This activity is significant as it can help identify rogue DCs added to the network, which could indicate a DCShadow attack.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion",T1207,"`wineventlog_security` EventCode=4742 ServicePrincipalNames IN (""*E3514235-4B06-11D1-AB04-00C04FC2DCD2/*"",""*GC/*"")
| stats min(_time) as _time latest(ServicePrincipalNames) as ServicePrincipalNames,values(signature) as signature, values(src_user) as src_user, values(user) as user by Logon_ID, dvc
| where src_user=user
| rename Logon_ID as TargetLogonId, user as dest 
| appendpipe [
| map search=""search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$"" 
| fields - dest, dvc, signature]
| stats min(_time) as _time, values(TargetUserSid) as TargetUserSid, values(Target_Domain) as Target_Domain, values(user) as user, values(status) as status, values(src_category) as src_category, values(src_ip) as src_ip values(ServicePrincipalNames) as ServicePrincipalNames values(signature) as signature values(dest) as dest values(dvc) as dvc by TargetLogonId 
| eval dest=trim(dest,""$"") 
| `windows_ad_domain_controller_promotion_filter`"
Windows AD Domain Root ACL Deletion,"ACL deletion performed on the domain root object, significant AD change with high impact. Following MS guidance all changes at this level should be reviewed. Drill into the logonID within EventCode 4624 for information on the source device during triage.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=domainDNS 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Impact, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=domainDNS  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_values>.*?)\)""  
| mvexpand old_values  
| where NOT old_values IN (new_values)  
| rex field=old_values ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);;(?P<aceSid>.*?)$""  
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights  
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(old_values) as old_values by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| `windows_ad_domain_root_acl_deletion_filter`"
Windows AD Domain Root ACL Modification,"ACL modification performed on the domain root object, significant AD change with high impact. Following MS guidance all changes at this level should be reviewed. Drill into the logonID within EventCode 4624 for information on the source device during triage.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=domainDNS 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Impact, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=domainDNS  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace 
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);;(?P<aceSid>.*?)$"" 
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",'access_rights_value'), aceType=ace_type_value, aceFlags=coalesce(ace_flag_value,""This object only""), aceControlAccessRights=ControlAccessRights, user=coalesce(user, group, builtin_group, aceSid)  
| stats values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| `windows_ad_domain_root_acl_modification_filter`"
Windows AD GPO Deleted,"This detection identifies when an Active Directory Group Policy is deleted using the Group Policy Management Console.
Search 1`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=gpLink 2| eval ObjectDN=upper(ObjectDN) 3| stats min(_time) as eventTime values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(src_user) as src_user values(dest) as dest by OpCorrelationID ObjectDN SubjectLogonId 4| rex field=old_value max_match=10000 &#34;(?i)LDAP://(?P&lt;old_dn&gt;cn.*?);(?P&lt;old_flag&gt;\d)\]&#34; 5| rex field=new_value max_match=10000 &#34;(?",Windows Events,"Persistence, Defense Evasion","T1562.001, T1484.001","`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=gpLink 
| eval  ObjectDN=upper(ObjectDN) 
| stats min(_time) as eventTime values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(src_user) as src_user values(dest) as dest by OpCorrelationID ObjectDN SubjectLogonId 
| rex field=old_value max_match=10000 ""(?i)LDAP://(?P<old_dn>cn.*?);(?P<old_flag>\d)\]"" 
| rex field=new_value max_match=10000 ""(?i)LDAP://(?P<new_dn>cn.*?);(?P<new_flag>\d)\]"" 
| mvexpand old_dn 
| where NOT old_dn IN (new_dn) 
| eval ObjectDN=upper(old_dn) 
| join ObjectDN type=outer [
| search `admon` objectCategory=""CN=Group-Policy-Container*"" admonEventType=Update 
| eval ObjectDN=upper(distinguishedName) 
| stats latest(displayName) as displayName by ObjectDN ] 
| stats min(eventTime) as _time values(OpCorrelationID) as OpCorrelationID values(displayName) as policyName values(src_user) as src_user by ObjectDN SubjectLogonId 
| `windows_ad_gpo_deleted_filter`"
Windows AD GPO Disabled,"This detection identifies when an Active Directory Group Policy is disabled using the Group Policy Management Console.
Search 1`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=flags OperationType=&#34;%%14674&#34; AttributeValue!=0 2| eval AttributeValueExp=case(AttributeValue==0,&#34;Enabled&#34;,AttributeValue==1,&#34;User configuration settings disabled&#34;,AttributeValue==2,&#34;Computer configuration settings disabled&#34;,AttributeValue==3,&#34;Disabled&#34;), ObjectDN=upper(ObjectDN) 3| join ObjectDN type=inner [ 4| search `admon` objectCategory=&#34;CN=Group-Policy-Container*&#34; admonEventType=Update 5| eval ObjectDN=upper(distinguishedName) 6| stats latest(displayName) as displayName by ObjectDN ] 7| stats min(_time) as _time values(AttributeValue) as AttributeValue values(AttributeValueExp) as AttributeValueExp values(OpCorrelationID) as OpCorrelationID values(displayName) as policyName values(src_user) as src_user by ObjectDN SubjectLogonId dest 8| `windows_ad_gpo_disabled_filter` Data Source Name Platform Sourcetype Source Windows Event Log Security 5136 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Macros Used Name Value admon source=ActiveDirectory windows_ad_gpo_disabled_filter search * windows_ad_gpo_disabled_filter is an empty macro by default.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1484.001","`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=flags OperationType=""%%14674"" AttributeValue!=0 
| eval AttributeValueExp=case(AttributeValue==0,""Enabled"",AttributeValue==1,""User configuration settings disabled"",AttributeValue==2,""Computer configuration settings disabled"",AttributeValue==3,""Disabled""), ObjectDN=upper(ObjectDN) 
| join ObjectDN type=inner [
| search `admon` objectCategory=""CN=Group-Policy-Container*"" admonEventType=Update 
| eval ObjectDN=upper(distinguishedName) 
| stats latest(displayName) as displayName by ObjectDN ] 
| stats min(_time) as _time values(AttributeValue) as AttributeValue values(AttributeValueExp) as AttributeValueExp values(OpCorrelationID) as OpCorrelationID values(displayName) as policyName values(src_user) as src_user by ObjectDN SubjectLogonId dest 
| `windows_ad_gpo_disabled_filter`"
Windows AD Hidden OU Creation,"This analytic is looking for when an ACL is applied to an OU which denies listing the objects residing in the OU. This activity combined with modifying the owner of the OU will hide AD objects even from domain administrators.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=organizationalUnit 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=organizationalUnit 
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace  
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$""  
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights  
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value as aceType 
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats values(aceType) as aceType values(aceFlags) as aceFlags values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(aceInheritedTypeGuid) as aceInheritedTypeGuid by _time ObjectClass ObjectDN src_user SubjectLogonId user OpCorrelationID 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| search aceType IN (""Access denied"",D) AND aceAccessRights IN (""List contents"",""List objects"",LC,LO) 
| `windows_ad_hidden_ou_creation_filter`"
Windows AD Object Owner Updated,"AD Object Owner Updated. The owner provides Full control level privileges over the target AD Object. This event has significant impact alone and is also a precursor activity for hiding an AD object.
Search 1`wineventlog_security` EventCode=5136 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId DSName 3| rex field=old_value &#34;O:(?",Windows Events,"Persistence, Impact, Defense Evasion","T1484, T1222.001","`wineventlog_security` EventCode=5136 
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId DSName 
| rex field=old_value ""O:(?P<old_owner>.*?)G:"" 
| rex field=new_value ""O:(?P<new_owner>.*?)G:"" 
| where old_owner!=new_owner ``` optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as new_owner OUTPUT downLevelDomainName as new_owner_user 
| lookup admon_groups_def objectSid as new_owner OUTPUT cn as new_owner_group 
| lookup identity_lookup_expanded objectSid as old_owner OUTPUT downLevelDomainName as old_owner_user 
| lookup admon_groups_def objectSid as old_owner OUTPUT cn as old_owner_group ``` 
| lookup builtin_groups_lookup builtin_group_string  as new_owner_group OUTPUT builtin_group_name as new_owner_group_builtin_group 
| lookup builtin_groups_lookup builtin_group_string  as old_owner OUTPUT builtin_group_name as old_owner_group_builtin_group 
| eval user=coalesce(new_owner_user, new_owner_group, new_owner_group_builtin_group, new_owner), previousOwner=coalesce(old_owner_user, old_owner_group, old_owner_group_builtin_group, old_owner) 
| stats values(previousOwner) as previousOwner values(user) as user values(SubjectLogonId) as SubjectLogonId by _time ObjectClass ObjectDN src_user OpCorrelationID DSName 
| `windows_ad_object_owner_updated_filter`"
Windows AD Privileged Group Modification,This detection identifies when users are added to privileged Active Directory groups by leveraging the Windows Security Event Code 4728 along with a lookup of privileged AD groups provided by Splunk Enterprise Security. Attackers often add user accounts to privileged AD groups to escalate privileges or maintain persistence within an Active Directory environment. Monitoring for modifications to privileged groups can help identify potential security breaches and unauthorized access attempts.,Windows Events,"Persistence, Privilege Escalation",T1098,"`wineventlog_security` EventCode IN (4728) 
| stats min(_time) as _time dc(user) as usercount, values(user) as user values(user_category) as user_category values(src_user_category) as src_user_category values(dvc) as dvc by signature, Group_Name,src_user dest 
| lookup admon_groups_def  cn as Group_Name OUTPUT category 
| where category=""privileged"" 
| `windows_ad_privileged_group_modification_filter`"
Windows AD Same Domain SID History Addition,The following analytic detects changes to the sIDHistory attribute of user or computer objects within the same domain. It leverages Windows Security Event Codes 4738 and 4742 to identify when the sIDHistory attribute is modified. This activity is significant because the sIDHistory attribute can be abused by adversaries to grant unauthorized access by inheriting permissions from another account.,Windows Events,"Persistence, Defense Evasion",T1134.005,"`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory IN (""%%1793"", -) 
| rex field=SidHistory ""(^%{
|^)(?P<SidHistoryMatch>.*)(\-
|\\\)"" 
| rex field=TargetSid ""^(?P<TargetSidmatch>.*)(\-
|\\\)"" 
| where SidHistoryMatch=TargetSidmatch OR SidHistoryMatch=TargetDomainName 
| rename TargetSid as userSid, TargetDomainName as userDomainName 
| table _time action status host user userSid userDomainName SidHistory Logon_ID src_user dest 
| `windows_ad_same_domain_sid_history_addition_filter`"
Windows AD Self DACL Assignment,"Detect when a user creates a new DACL in AD for their own AD object.
Search 1`wineventlog_security` 2EventCode=5136 3 4| stats min(_time) as _time 5 values( 6 eval( 7 if(OperationType==&#34;%%14675&#34;,AttributeValue,null) 8 ) 9 ) as old_value 10 11 values( 12 eval( 13 if(OperationType==&#34;%%14674&#34; ,AttributeValue,null) 14 ) 15 ) as new_value 16 17 values(OperationType) as OperationType 18by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId dest 19 20 21| rex field=old_value max_match=10000 &#34;\((?",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1484, T1098","`wineventlog_security` 
EventCode=5136 
| stats min(_time) as _time 
values(
eval(
if(OperationType==""%%14675"",AttributeValue,null)
)
) as old_value 
values(
eval(
if(OperationType==""%%14674"" ,AttributeValue,null)
)
) as new_value 
values(OperationType) as OperationType 
by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId dest 
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)"" 
| mvexpand new_ace
| where NOT new_ace IN (old_values) 
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$""
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})"" 
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})"" 
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value as aceType 
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value 
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights 
``` Optional SID resolution lookups  
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group"
Windows AD Short Lived Domain Controller SPN Attribute,"The following analytic detects the temporary addition of a global catalog SPN or a DRS RPC SPN to an Active Directory computer object, indicative of a potential DCShadow attack. This detection leverages EventCode 5136 from the wineventlog_security data source, focusing on specific SPN attribute changes. This activity is significant as DCShadow attacks allow attackers with privileged access to register rogue Domain Controllers, enabling unauthorized changes to the AD infrastructure.",Windows Events,"Persistence, Defense Evasion",T1207,"`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=servicePrincipalName (AttributeValue=""GC/*"" OR AttributeValue=""E3514235-4B06-11D1-AB04-00C04FC2DCD2/*"") 
| stats min(_time) as _time range(_time) as duration values(OperationType) as OperationType values(user) as user values(src_ip) as src_ip values(src_nt_domain) as src_nt_domain values(src_user) as src_user values(Computer) as dest, values(ObjectDN) as ObjectDN values(action) as action values(app) as app values(authentication_method) as authentication_method values(signature) as signature values(signature_id) as signature_id values(src) as src by Logon_ID 
| eval short_lived=case((duration<30),""TRUE"") 
| where short_lived=""TRUE"" AND mvcount(OperationType)>1 
| replace ""%%14674"" with ""Value Added"", ""%%14675"" with ""Value Deleted"" in OperationType 
| rename Logon_ID as TargetLogonId 
| appendpipe [
| map search=""search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$""] 
| `windows_ad_short_lived_domain_controller_spn_attribute_filter`"
Windows Alternate DataStream - Base64 Content,"The following analytic detects the creation of Alternate Data Streams (ADS) with Base64 content on Windows systems. It leverages Sysmon EventID 15, which captures file creation events, including the content of named streams. ADS can conceal malicious payloads, making them significant for SOC monitoring. This detection identifies hidden streams that may contain executables, scripts, or configuration data, often used by malware to evade detection.",Windows Events,Defense Evasion,T1564.004,"`sysmon` EventCode=15 NOT Contents IN (""-"",""[ZoneTransfer]*"") 
| regex TargetFilename=""(?<!\/)\b\w+(\.\w+)?:\w+(\.\w+)?$"" 
| regex Contents=""(?:[A-Za-z0-9+/]{128,})(?:[A-Za-z0-9+/]{2}==
|[A-Za-z0-9+/]{3}=)?$"" 
| eval file_name = replace(TargetFilename,""(.*\\\)"",""""), process = Image , file_path = TargetFilename , base64 = Contents, file_hash = coalesce(SHA256,SHA1,MD5,Hash) 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc file_hash file_name file_path process process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Contents Image base64 
| `base64decode(base64)` 
| fields - base64 
| rename base64_decode as command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_alternate_datastream___base64_content_filter`"
Windows Alternate DataStream - Executable Content,The following analytic detects the writing of data with an IMPHASH value to an Alternate Data Stream (ADS) in the NTFS file system. It leverages Sysmon Event ID 15 and regex to identify files with a Portable Executable (PE) structure. This activity is significant as it may indicate a threat actor staging malicious code in hidden areas for persistence or future execution.,Windows Events,"Execution, Persistence, Defense Evasion",T1564.004,"`sysmon` EventCode=15 IMPHASH!=00000000000000000000000000000000 
| regex TargetFilename=""(?<!\/)\b\w+(\.\w+)?:\w+(\.\w+)?$"" 
| eval file_name = replace(TargetFilename,""(.*\\\)"",""""), process = Image , file_path = TargetFilename, file_hash = coalesce(SHA256,SHA1,MD5,Hash) 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc file_hash file_name file_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Contents Image 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_alternate_datastream___executable_content_filter`"
Windows App Layer Protocol Qakbot NamedPipe,"The following analytic detects a suspicious process creating or connecting to a potential Qakbot named pipe. It leverages Sysmon EventCodes 17 and 18, focusing on specific processes known to be abused by Qakbot and identifying randomly generated named pipes in GUID form. This activity is significant as Qakbot malware uses named pipes for inter-process communication after code injection, facilitating data theft.",Windows Events,"Command And Control, Exfiltration",T1071,"`sysmon` EventCode IN (17, 18) EventType IN ( ""CreatePipe"", ""ConnectPipe"") Image IN (""*\\calc.exe"", ""*\\notepad.exe"", ""*\\rdpclip.exe"", ""*\\explorer.exe"", ""*\\wermgr.exe"", ""*\\ping.exe"", ""*\\OneDriveSetup.exe"", ""*\\dxdiag.exe"", ""*\\mobsync.exe"", ""*\\msra.exe"", ""*\\xwizard.exe"") 
| regex PipeName=""^\\\{[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{8}"" 
| stats  min(_time) as firstTime max(_time) as lastTime count by dest dvc pipe_name process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Image PipeName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_app_layer_protocol_qakbot_namedpipe_filter`"
Windows App Layer Protocol Wermgr Connect To NamedPipe,"The following analytic detects the wermgr.exe process creating or connecting to a named pipe. It leverages Sysmon EventCodes 17 and 18 to identify these actions. This activity is significant because wermgr.exe, a legitimate Windows OS Problem Reporting application, is often abused by malware such as Trickbot and Qakbot to execute malicious code. If confirmed malicious, this behavior could indicate that an attacker has injected code into wermgr.",Windows Events,Command And Control,T1071,"`sysmon` EventCode IN (17, 18) Image= ""*\\wermgr.exe"" EventType IN ( ""CreatePipe"", ""ConnectPipe"") 
| stats  min(_time) as firstTime max(_time) as lastTime count by dest dvc pipe_name process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Image PipeName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_app_layer_protocol_wermgr_connect_to_namedpipe_filter`"
Windows Attempt To Stop Security Service,"The following analytic detects attempts to stop security-related services on an endpoint, which may indicate malicious activity. It leverages data from Endpoint Detection and Response (EDR) agents, specifically searching for processes involving the &quot;sc.exe&quot; or &quot;net.exe&quot; command with the &quot;stop&quot; parameter or the PowerShell &quot;Stop-Service&quot; cmdlet. This activity is significant because disabling security services can undermine the organization's security posture, potentially leading to unauthorized access, data exfiltration, or further attacks like malware installation or privilege escalation.",Windows Events,"Execution, Exfiltration, Privilege Escalation, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ((`process_net` OR `process_sc`) Processes.process=""* stop *"") OR Processes.process=""*Stop-Service *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| lookup security_services_lookup service as process OUTPUTNEW category, description 
| search category=security 
| `windows_attempt_to_stop_security_service_filter`"
Windows Audit Policy Auditing Option Disabled via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/set&quot;, &quot;/option&quot; and &quot;/value:disable&quot; command-line arguments used to disable specific auditing options of the audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1562.002,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/set*"" Processes.process=""*/option:*"" Processes.process=""*/value:disable*"" Processes.process IN (""*FullPrivilegeAuditing*"", ""*AuditBaseObjects*"", ""*AuditBaseDirectories*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_auditing_option_disabled_via_auditpol_filter`"
Windows Audit Policy Cleared via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/clear&quot; command-line argument used to clears the audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1562.002, T1562","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process IN (""*/clear*"", ""*/remove*"") AND NOT Processes.process IN (""*/resourceSACL*"", ""*/?*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_cleared_via_auditpol_filter`"
Windows Cached Domain Credentials Reg Query,"The following analytic identifies a process command line querying the CachedLogonsCount registry value in the Winlogon registry. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and registry queries. Monitoring this activity is significant as it can indicate the use of post-exploitation tools like Winpeas, which gather information about login caching settings.",Windows Events,"Lateral Movement, Execution, Credential Access, Impact",T1003.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  `process_reg` AND Processes.process = ""* query *"" AND Processes.process = ""*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon*"" AND Processes.process = ""*CACHEDLOGONSCOUNT*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cached_domain_credentials_reg_query_filter`"
Windows Change File Association Command To Notepad,"The following analytic detects attempts to change the command value of a file association of an extension to open with Notepad.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns and registry modifications. This activity is significant as it can indicate an attempt to manipulate file handling behavior, a technique observed in APT and ransomware attacks like Prestige.",Windows Events,"Execution, Impact, Persistence",T1546.001,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime
from datamodel=Endpoint.Processes where 
(
(`process_reg` AND Processes.process=""* add *"")
OR
(`process_powershell` AND Processes.process IN (""*New-ItemProperty*"", ""*Set-ItemProperty*"", ""* sp *""))
)
Processes.process IN (""*HKCR\\*"", ""*HKEY_CLASSES_ROOT\\*"")
Processes.process = ""*\\shell\\open\\command*""
Processes.process = ""*Notepad.exe*"""
Windows Command Shell DCRat ForkBomb Payload,"The following analytic detects the execution of a DCRat &quot;forkbomb&quot; payload, which spawns multiple cmd.exe processes that launch notepad.exe instances in quick succession. This detection leverages Endpoint Detection and Response (EDR) data, focusing on the rapid creation of cmd.exe and notepad.exe processes within a 30-second window. This activity is significant as it indicates a potential DCRat infection, a known Remote Access Trojan (RAT) with destructive capabilities.",Windows Events,Execution,T1059.003,"| tstats `security_content_summariesonly` values(Processes.user) as user values(Processes.action) as action values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product dc(Processes.parent_process_id) as parent_process_id_count dc(Processes.process_id) as process_id_count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name= ""cmd.exe"" (Processes.process_name = ""notepad.exe"" OR Processes.original_file_name= ""notepad.exe"") Processes.parent_process = ""*.bat*"" by Processes.parent_process_name Processes.process_name Processes.original_file_name Processes.parent_process Processes.dest Processes.user _time span=30s 
| where parent_process_id_count>= 10 AND process_id_count >=10 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_command_shell_dcrat_forkbomb_payload_filter`"
Windows Compatibility Telemetry Suspicious Child Process,"The following analytic detects the execution of CompatTelRunner.exe with parameters indicative of a process not part of the normal &quot;Microsoft Compatibility Appraiser&quot; telemetry collection. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line arguments. This activity is significant because CompatTelRunner.exe and the &quot;Microsoft Compatibility Appraiser&quot; task always run as System and can be used to elevate privileges or establish a highly privileged persistence mechanism.",Windows Events,"Collection, Execution, Persistence, Privilege Escalation","T1053.005, T1546","|  tstats `security_content_summariesonly` count min(_time) AS firstTime, max(_time) AS lastTime FROM datamodel=Endpoint.Processes 
where Processes.parent_process_name = ""CompatTelRunner.exe"" AND Processes.process=""* -cv:*"" NOT Processes.process IN (""* -m:*"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name 
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash 
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path 
Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_compatibility_telemetry_suspicious_child_process_filter`"
Windows Compatibility Telemetry Tampering Through Registry,"This detection identifies suspicious modifications to the Windows Compatibility Telemetry registry settings, specifically within the &quot;TelemetryController&quot; registry key and &quot;Command&quot; registry value. It leverages data from the Endpoint.Registry data model, focusing on registry paths and values indicative of such changes. This activity is significant because CompatTelRunner.exe and the &quot;Microsoft Compatibility Appraiser&quot; task always run as System and can be used to elevate privileges or establish a highly privileged persistence mechanism.",Windows Events,"Execution, Persistence, Privilege Escalation","T1053.005, T1546","| tstats `security_content_summariesonly` min(_time) as firstTime, max(_time) as lastTime, count FROM datamodel=Endpoint.Registry 
WHERE (Registry.registry_path = ""*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\TelemetryController*"" 
AND Registry.registry_value_name=""Command"" NOT Registry.registry_value_data IN (""(empty)"")) 
by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path 
Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name  
Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| eval process = registry_value_data 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_compatibility_telemetry_tampering_through_registry_filter`"
Windows ComputerDefaults Spawning a Process,"The following analytic detects the spawning of ComputerDefaults.exe, a Windows system process used to manage default application associations. While normally legitimate, this process can be exploited by attackers to bypass User Account Control (UAC) and execute unauthorized code with elevated privileges. Detection focuses on abnormal execution patterns, unusual parent-child process relationships, or deviations from standard paths.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=ComputerDefaults.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_computerdefaults_spawning_a_process_filter`"
Windows Credentials from Password Stores Chrome Copied in TEMP Dir,"The following analytic detects the copying of Chrome's Local State and Login Data files into temporary folders, a tactic often used by the Braodo stealer malware. These files contain encrypted user credentials, including saved passwords and login session details. The detection monitors for suspicious copying activity involving these specific Chrome files, particularly in temp directories where malware typically processes the stolen data.",Windows Events,Credential Access,T1555.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""Local State"", ""Login Data"") Filesystem.file_path = ""*\\temp\\*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_chrome_copied_in_temp_dir_filter`"
Windows Credentials from Web Browsers Saved in TEMP Folder,"The following analytic detects the creation of files containing passwords, cookies, and saved login account information by the Braodo stealer malware in temporary folders. Braodo often collects these credentials from browsers and applications, storing them in temp directories before exfiltration. This detection focuses on monitoring for the creation of files with patterns or formats commonly associated with stolen credentials.",Windows Events,"Credential Access, Exfiltration",T1555.003,"|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""login*"", ""pass*"",""cookie*"",""master_key*"") Filesystem.file_path = ""*\\temp\\*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_web_browsers_saved_in_temp_folder_filter`"
Windows Credentials in Registry Reg Query,"The following analytic identifies processes querying the registry for potential passwords or credentials. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that access specific registry paths known to store sensitive information. This activity is significant as it may indicate credential theft attempts, often used by adversaries or post-exploitation tools like winPEAS.",Windows Events,"Execution, Credential Access, Lateral Movement, Persistence, Impact, Privilege Escalation","T1552.002, T1552","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` AND Processes.process = ""* query *"" AND Processes.process IN (""*\\Software\\ORL\\WinVNC3\\Password*"", ""*\\SOFTWARE\\RealVNC\\WinVNC4 /v password*"", ""*\\CurrentControlSet\\Services\\SNMP*"", ""*\\Software\\TightVNC\\Server*"", ""*\\Software\\SimonTatham\\PuTTY\\Sessions*"", ""*\\Software\\OpenSSH\\Agent\\Keys*"", ""*password*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_in_registry_reg_query_filter`"
Windows Default Rdp File Deletion,"This detection identifies the deletion of the Default.rdp file from a userâ€™s Documents folder. This file is automatically created or updated by the Remote Desktop Connection client (mstsc.exe) whenever a user initiates an RDP session. It contains session configuration data, such as the remote hostname and display settings. While the presence of this file is normal during legitimate RDP usage, its deletion may indicate an attempt to conceal evidence of remote access activity.",Windows Events,Defense Evasion,T1070.004,"`sysmon` EventCode IN (""23"", ""26"") TargetFilename = ""*\\default.rdp"" 
| stats count min(_time) as firstTime, max(_time) as lastTime by action dest dvc file_path file_hash file_name file_modify_time process_exec process_guid process_id process_name process_path signature signature_id user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_default_rdp_file_deletion_filter`"
Windows Default Rdp File Unhidden,"This detection identifies the use of attrib.exe to remove hidden (-h) or system (-s) attributes from the Default.rdp file, which is automatically created in a user's Documents folder when a Remote Desktop Protocol (RDP) session is initiated using mstsc.exe. The Default.rdp file stores session configuration details such as the remote host address and screen settings.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""attrib.exe"" Processes.process IN(""*-s*"", ""*-h*"") Processes.process = ""*default.rdp*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_default_rdp_file_unhidden_filter`"
Windows Disable Lock Workstation Feature Through Registry,"The following analytic detects a suspicious registry modification that disables the Lock Computer feature in Windows. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\DisableLockWorkstation&quot; with a value of &quot;0x00000001&quot;. This activity is significant because it prevents users from locking their screens, a tactic often used by malware, including ransomware, to maintain control over compromised systems.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableLockWorkstation"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_lock_workstation_feature_through_registry_filter`"
Windows Disable Memory Crash Dump,"The following analytic detects attempts to disable the memory crash dump feature on Windows systems by setting the registry value to 0. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the CrashDumpEnabled registry key. This activity is significant because disabling crash dumps can hinder forensic analysis and incident response efforts. If confirmed malicious, this action could be part of a broader attack strategy, such as data destruction or system destabilization, as seen with HermeticWiper, potentially leading to significant operational disruptions and data loss.",Windows Events,Impact,T1485,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry where (Registry.registry_path=""*\\CurrentControlSet\\Control\\CrashControl\\CrashDumpEnabled"") AND Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_memory_crash_dump_filter`"
Windows DLL Module Loaded in Temp Dir,"The following analytic detects instances where a Dynamic Link Library (DLL) is loaded from a temporary directory on a Windows system. Loading DLLs from non-standard paths such as %TEMP% is uncommon for legitimate applications and is often associated with adversary tradecraft, including DLL search order hijacking, side-loading, or execution of malicious payloads staged in temporary folders.",Windows Events,"Command And Control, Execution, Persistence",T1105,"`sysmon` EventCode=7 NOT (ImageLoaded IN(""C:\\Program Files*"")) AND ImageLoaded=""*\\temp\\*"" AND ImageLoaded=""*.dll"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dll_module_loaded_in_temp_dir_filter`"
Windows DLL Side-Loading In Calc,"The following analytic detects suspicious DLL modules loaded by calc.exe that are not located in the %systemroot%\system32 or %systemroot%\sysWoW64 directories. This detection leverages Sysmon EventCode 7 to identify DLL side-loading, a technique often used by Qakbot malware to execute malicious DLLs. This activity is significant as it indicates potential malware execution through a trusted process, which can bypass security controls.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"`sysmon` EventCode=7 Image = ""*\calc.exe"" AND NOT (Image IN (""*:\\windows\\system32\\*"", ""*:\\windows\\sysWow64\\*"")) AND NOT(ImageLoaded IN(""*:\\windows\\system32\\*"", ""*:\\windows\\sysWow64\\*"", ""*:\\windows\\WinSXS\\*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dll_side_loading_in_calc_filter`"
Windows DLL Side-Loading Process Child Of Calc,"The following analytic identifies suspicious child processes spawned by calc.exe, indicative of DLL side-loading techniques. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process GUIDs, names, and parent processes. This activity is significant as it is commonly associated with Qakbot malware, which uses calc.exe to load malicious DLLs via regsvr32.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name = ""calc.exe"")  AND Processes.process_name != ""win32calc.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dll_side_loading_process_child_of_calc_filter`"
Windows Excessive Disabled Services Event,"The following analytic identifies an excessive number of system events where services are modified from start to disabled. It leverages Windows Event Logs (EventCode 7040) to detect multiple service state changes on a single host. This activity is significant as it may indicate an adversary attempting to disable security applications or other critical services, potentially leading to defense evasion or destructive actions.",Windows Events,Defense Evasion,T1562.001,"`wineventlog_system` EventCode=7040 ""disabled"" 
| stats count values(EventData_Xml) as MessageList dc(EventData_Xml) as MessageCount min(_time) as firstTime max(_time) as lastTime by Computer EventCode UserID 
| rename Computer as dest 
| where count >=10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_excessive_disabled_services_event_filter`"
Windows Excessive Service Stop Attempt,"The following analytic detects multiple attempts to stop or delete services on a system using net.exe or sc.exe. It leverages Endpoint Detection and Response (EDR) telemetry, focusing on process names and command-line executions within a one-minute window. This activity is significant as it may indicate an adversary attempting to disable security or critical services to evade detection and further their objectives.",Windows Events,"Execution, Impact, Persistence",T1489,"| tstats `security_content_summariesonly` values(Processes.action) as action values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (`process_net` OR `process_sc`) AND Processes.process=""*stop*"" OR Processes.process=""*delete*"" by Processes.process_name Processes.original_file_name Processes.parent_process_name Processes.dest Processes.user _time span=1m 
| where count >=5 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_excessive_service_stop_attempt_filter`"
Windows Excessive Usage Of Net App,"The following analytic detects excessive usage of net.exe within a one-minute interval. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This behavior is significant as it may indicate an adversary attempting to create, delete, or disable multiple user accounts rapidly, a tactic observed in Monero mining incidents.",Windows Events,"Execution, Impact",T1531,"| tstats `security_content_summariesonly` values(Processes.action) as action values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product count min(_time) as firstTime max(_time) as lastTime  from datamodel=Endpoint.Processes where `process_net` by Processes.process_name Processes.parent_process_name Processes.original_file_name Processes.dest Processes.user _time span=1m 
| where count >=10 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_excessive_usage_of_net_app_filter`"
Windows Executable in Loaded Modules,"The following analytic identifies instances where executable files (.exe) are loaded as modules, detected through 'ImageLoaded' events in Sysmon logs. This method leverages Sysmon EventCode 7 to track unusual module loading behavior, which is significant as it deviates from the norm of loading .dll files. This activity is crucial for SOC monitoring because it can indicate the presence of malware like NjRAT, which uses this technique to load malicious modules.",Windows Events,"Execution, Persistence",T1129,"`sysmon` EventCode=7 ImageLoaded != *.dll AND Signed != true 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature Signed signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_executable_in_loaded_modules_filter`"
Windows File Without Extension In Critical Folder,"This analytic detects the creation of files without extensions in critical Windows system and driver-related directories, including but not limited to System32\Drivers, Windows\WinSxS, and other known Windows driver storage and loading paths. The detection has been expanded to comprehensively cover all commonly abused and legitimate Windows driver folder locations, increasing visibility into attempts to stage or deploy kernel-mode components.",Windows Events,Impact,T1485,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem
where Filesystem.file_path IN(""*\\System32\\drivers\\*"", ""*\\syswow64\\drivers\\*"", ""*\\WINDOWS\\inf\\*"",""*\\Program Files*"", ""*\\WINDOWS\\System32\\DriverStore\\*"",""*:\\Windows\\WinSxS\\*"",""*\\ProgramData\\Microsoft\\Windows Defender\\Definition Updates\\*"",""*\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*"",""*\\Windows\\servicing\\*"", ""*\\Windows\\ELAMBKUP\\*"",""*\\Windows\\Boot\\*"",""*\\System32\\Boot\\*"",""*\\System32\\Recovery\\*"", ""C:\\AMD\\*"", ""C:\\OEM\\*"")
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path
Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| rex field=""file_name"" ""\.(?<extension>[^\.]*$)"" 
| where isnull(extension) 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_file_without_extension_in_critical_folder_filter`"
Windows Files and Dirs Access Rights Modification Via Icacls,"The following analytic identifies the modification of security permissions on files or directories using tools like icacls.exe, cacls.exe, or xcacls.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line executions. This activity is significant as it is commonly used by Advanced Persistent Threats (APTs) and coinminer scripts to evade detection and maintain control over compromised systems.",Windows Events,"Execution, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
Processes.process_name IN (""icacls.exe"", ""cacls.exe"",""xcacls.exe"") AND 
Processes.process IN (""*:R*"", ""*:W*"", ""*:F*"", ""*:C*"", ""*:N*"", ""*/P*"", ""*/E*"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_files_and_dirs_access_rights_modification_via_icacls_filter`"
Windows Hidden Schedule Task Settings,"The following analytic detects the creation of hidden scheduled tasks on Windows systems, which are not visible in the UI. It leverages Windows Security EventCode 4698 to identify tasks where the 'Hidden' setting is enabled. This behavior is significant as it may indicate malware activity, such as Industroyer2, or the use of living-off-the-land binaries (LOLBINs) to download additional payloads.",Windows Events,"Discovery, Execution, Persistence",T1053,"`wineventlog_security`
EventCode=4698 
TaskContent = ""*&lt;Hidden&gt;true&lt;/Hidden&gt;*""
| stats count min(_time) as firstTime max(_time) as lastTime
by TaskName TaskContent action signature status dest
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_hidden_schedule_task_settings_filter`"
Windows Hide Notification Features Through Registry,"The following analytic detects suspicious registry modifications aimed at hiding common Windows notification features on a compromised host. It leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values. This activity is significant as it is often used by ransomware to obscure visual indicators, increasing the impact of the attack.",Windows Events,"Execution, Impact, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\*"" Registry.registry_value_name IN (""HideClock"", ""HideSCAHealth"", ""HideSCANetwork"", ""HideSCAPower"", ""HideSCAVolume"") Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_hide_notification_features_through_registry_filter`"
Windows Hijack Execution Flow Version Dll Side Load,"The following analytic detects a process loading a version.dll file from a directory other than %windir%\system32 or %windir%\syswow64. This detection leverages Sysmon EventCode 7 to identify instances where an unsigned or improperly located version.dll is loaded. This activity is significant as it is a common technique used in ransomware and APT malware campaigns, including Brute Ratel C4, to execute malicious code via DLL side loading.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"`sysmon` EventCode=7 ImageLoaded = ""*\\version.dll"" AND (Signed = ""false"" OR NOT(ImageLoaded IN(""*\\windows\\system32*"",  ""*\\windows\\syswow64\\*""))) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_hijack_execution_flow_version_dll_side_load_filter`"
Windows Impair Defenses Disable AV AutoStart via Registry,"The following analytic detects modifications to the registry related to the disabling of autostart functionality for certain antivirus products, such as Kingsoft and Tencent. Malware like ValleyRAT may alter specific registry keys to prevent these security tools from launching automatically at startup, thereby weakening system defenses. By monitoring changes in the registry entries associated with antivirus autostart settings, this detection enables security analysts to identify attempts to disable protective software.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path IN(""*\\kingsoft\\antivirus\\KAVReport\\*"" , ""*\\kingsoft\\antivirus\\KSetting\\*"", ""*\\kingsoft\\antivirus\\Windhunter\\*"" ,""*\\Tencent\\QQPCMgr\\*"") AND ((Registry.registry_value_name IN(""autostart"",""kxesc"", ""WindhunterSwitch"") AND Registry.registry_value_data = ""0x00000000"") OR (Registry.registry_value_name = ""WindhunterLevel"" AND Registry.registry_value_data = ""0x00000004"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defenses_disable_av_autostart_via_registry_filter`"
Windows Important Audit Policy Disabled,The following analytic detects the disabling of important audit policies. It leverages EventCode 4719 from Windows Security Event Logs to identify changes where success or failure auditing is removed. This activity is significant as it suggests an attacker may have gained access to the domain controller and is attempting to evade detection by tampering with audit policies.,Windows Events,"Privilege Escalation, Defense Evasion",T1562.001,"`wineventlog_security` EventCode=4719 (AuditPolicyChanges IN (""%%8448"",""%%8450"",""%%8448, %%8450"") OR Changes IN (""Failure removed"",""Success removed"",""Success removed, Failure removed"")) `important_audit_policy_subcategory_guids` 
| replace ""%%8448"" with ""Success removed"", ""%%8450"" with ""Failure removed"", ""%%8448, %%8450"" with ""Success removed, Failure removed"" in AuditPolicyChanges 
| eval AuditPolicyChanges=coalesce(AuditPolicyChanges,Changes), SubcategoryGuid=coalesce(SubcategoryGuid,Subcategory_GUID) 
| rename ClientProcessId as process_id 
| stats min(_time) as _time values(host) as dest by AuditPolicyChanges SubcategoryGuid, process_id 
| lookup advanced_audit_policy_guids GUID as SubcategoryGuid OUTPUT Category SubCategory 
|  `windows_important_audit_policy_disabled_filter`"
Windows Increase in Group or Object Modification Activity,"This analytic detects an increase in modifications to AD groups or objects. Frequent changes to AD groups or objects can indicate potential security risks, such as unauthorized access attempts, impairing defences or establishing persistence. By monitoring AD logs for unusual modification patterns, this detection helps identify suspicious behavior that could compromise the integrity and security of the AD environment.",Windows Events,"Execution, Persistence, Privilege Escalation","T1098, T1562","`wineventlog_security` EventCode IN (4670,4727,4731,4734,4735,4764) 
| bucket span=5m _time  
| stats values(object) as object, dc(object) as objectCount, values(src_user_category) as src_user_category, values(dest) as dest, values(dest_category) as dest_category by _time, src_user, signature, status 
| eventstats avg(objectCount) as comp_avg, stdev(objectCount) as comp_std by src_user, signature 
| eval upperBound=(comp_avg+comp_std) 
| eval isOutlier=if(objectCount > 10 and (objectCount >= upperBound), 1, 0) 
| search isOutlier=1  
| `windows_increase_in_group_or_object_modification_activity_filter`"
Windows Indirect Command Execution Via Series Of Forfiles,"The following analytic detects excessive usage of the forfiles.exe process, which is often indicative of post-exploitation activities. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include process GUID, process name, and parent process. This activity is significant because forfiles.exe can be abused to execute commands on multiple files, a technique used by ransomware like Prestige.",Windows Events,"Execution, Impact, Defense Evasion, Discovery, Exfiltration",T1202,"| tstats `security_content_summariesonly` values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""forfiles.exe"" OR Processes.original_file_name = ""forfiles.exe"" by Processes.parent_process_name Processes.parent_process Processes.dest Processes.user _time span=1m 
| where count >=20 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_indirect_command_execution_via_series_of_forfiles_filter`"
Windows Information Discovery Fsutil,"The following analytic identifies the execution of the Windows built-in tool FSUTIL with the &quot;FSINFO&quot; or &quot;Volume&quot; parameters, in order to discover file system and disk information. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. Monitoring this activity is significant because FSUTIL can be abused by adversaries to gather detailed information about the file system, aiding in further exploitation.",Windows Events,"Execution, Persistence, Impact, Privilege Escalation, Discovery",T1082,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
(
Processes.process_name=""fsutil.exe""
OR
Processes.original_file_name = ""fsutil.exe""
)
(
Processes.process = ""*fsinfo*""
OR
(
Processes.process = ""*volume*""
AND 
Processes.process IN (""*diskfree*"", ""*list*"")
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_information_discovery_fsutil_filter`"
Windows Known GraphicalProton Loaded Modules,"The following analytic detects the loading of DLL modules associated with the GraphicalProton backdoor implant, commonly used by SVR in targeted attacks. It leverages Sysmon EventCode 7 to identify specific DLLs loaded by processes. This activity is significant as it may indicate the presence of a sophisticated backdoor, warranting immediate investigation. If confirmed malicious, the attacker could gain persistent access to the compromised host, potentially leading to further exploitation and data exfiltration.",Windows Events,"Execution, Exfiltration, Discovery, Defense Evasion",T1574.001,"`sysmon` EventCode=7 ImageLoaded IN (""*\\AclNumsInvertHost.dll"", ""*\\ModeBitmapNumericAnimate.dll"", ""*\\UnregisterAncestorAppendAuto.dll"", ""*\\DeregisterSeekUsers.dll"", ""*\\ScrollbarHandleGet.dll"", ""*\\PerformanceCaptionApi.dll"", ""*\\WowIcmpRemoveReg.dll"", ""*\\BlendMonitorStringBuild.dll"", ""*\\HandleFrequencyAll.dll"", ""*\\HardSwapColor.dll"", ""*\\LengthInMemoryActivate.dll"", ""*\\ParametersNamesPopup.dll"", ""*\\ModeFolderSignMove.dll"", ""*\\ChildPaletteConnected.dll"", ""*\\AddressResourcesSpec.dll"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_known_graphicalproton_loaded_modules_filter`"
Windows Mark Of The Web Bypass,"The following analytic identifies a suspicious process that deletes the Mark-of-the-Web (MOTW) data stream. It leverages Sysmon EventCode 23 to detect when a file's Zone.Identifier stream is removed. This activity is significant because it is a common technique used by malware, such as Ave Maria RAT, to bypass security restrictions on files downloaded from the internet.",Windows Events,Defense Evasion,"T1553, T1553.005","`sysmon` EventCode=23 TargetFilename = ""*:Zone.Identifier"" 
| stats count min(_time) as firstTime, max(_time) as lastTime by action dest dvc file_path file_hash file_name file_modify_time process_exec process_guid process_id process_name process_path signature signature_id user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_mark_of_the_web_bypass_filter`"
Windows Masquerading Explorer As Child Process,"The following analytic identifies instances where explorer.exe is spawned by unusual parent processes such as cmd.exe, powershell.exe, or regsvr32.exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. This activity is significant because explorer.exe is typically initiated by userinit.exe, and deviations from this norm can indicate code injection or process masquerading attempts by malware like Qakbot.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN(""cmd.exe"", ""powershell.exe"", ""regsvr32.exe"") AND Processes.process_name = ""explorer.exe"" AND Processes.process IN (""*\\explorer.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_masquerading_explorer_as_child_process_filter`"
Windows Masquerading Msdtc Process,"The following analytic identifies the execution of msdtc.exe with specific command-line parameters (-a or -b), which are indicative of the PlugX malware. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because PlugX uses these parameters to masquerade its malicious operations within legitimate processes, making it harder to detect.",Windows Events,"Execution, Defense Evasion",T1036,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""msdtc.exe"" Processes.process = ""*msdtc.exe*"" Processes.process IN (""* -a*"", ""* -b*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_masquerading_msdtc_process_filter`"
Windows Modify Registry Default Icon Setting,"The following analytic detects suspicious modifications to the Windows registry's default icon settings, a technique associated with Lockbit ransomware. It leverages data from the Endpoint Registry data model, focusing on changes to registry paths under &quot;HKCR\\defaultIcon\(Default)*&quot;. This activity is significant as it is uncommon for normal users to modify these settings, and such changes can indicate ransomware infection or other malware.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path =""*\\defaultIcon\\(Default)*"" Registry.registry_path = ""*HKCR\\*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_modify_registry_default_icon_setting_filter`"
Windows Modify Registry Qakbot Binary Data Registry,"The following analytic detects the creation of a suspicious registry entry by Qakbot malware, characterized by 8 random registry value names with encrypted binary data. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry modifications under the &quot;SOFTWARE\Microsoft\&quot; path by processes like explorer.exe. This activity is significant as it indicates potential Qakbot infection, which uses the registry to store malicious code or configuration data.",Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count dc(registry_value_name) as registry_value_name_count FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Microsoft\\*"" AND Registry.registry_value_data = ""Binary Data"" by _time span=1m Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| eval registry_key_name_len = len(registry_key_name) 
| eval registry_value_name_len = len(registry_value_name) 
| regex registry_value_name=""^[0-9a-fA-F]{8}"" 
| where registry_key_name_len < 80 AND registry_value_name_len == 8 
| join process_guid, _time [
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name IN (""explorer.exe"", ""wermgr.exe"",""dxdiag.exe"", ""OneDriveSetup.exe"", ""mobsync.exe"", ""msra.exe"", ""xwizard.exe"") by _time span=1m Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` ] 
| stats min(_time) as firstTime max(_time) as lastTime values(registry_value_name) as registry_value_name dc(registry_value_name) as registry_value_name_count values(registry_key_name) by dest process_guid process_name parent_process_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where registry_value_name_count >= 5 
| `windows_modify_registry_qakbot_binary_data_registry_filter`"
Windows Modify Registry Utilize ProgIDs,"The following analytic detects modifications to the Windows Registry specifically targeting Programmatic Identifier associations to bypass User Account Control (UAC) Windows OS feature. ValleyRAT may create or alter registry entries to targetted progIDs like .pwn files with malicious processes, allowing it to execute harmful scripts or commands when these files are opened. By monitoring for unusual changes in registry keys linked to ProgIDs, this detection enables security analysts to identify potential threats like ValleyRAT execution attempts.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\ms-settings\\CurVer\\(Default)"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_utilize_progids_filter`"
Windows Modify Registry ValleyRAT C2 Config,"The following analytic detects modifications to theregistry related to ValleyRAT C2 configuration. Specifically, it monitors changes in registry keys where ValleyRAT saves the IP address and port information of its command-and-control (C2) server. This activity is a key indicator of ValleyRAT attempting to establish persistent communication with its C2 infrastructure. By identifying these unauthorized registry modifications, security analysts can quickly detect malicious configurations and investigate the associated threats.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Console\\IpDateInfo"" AND Registry.registry_value_data=""Binary Data"") OR (Registry.registry_path= ""*\\Console\\SelfPath"" AND Registry.registry_value_data=""*.exe"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_valleyrat_c2_config_filter`"
Windows Modify Registry ValleyRat PWN Reg Entry,"The following analytic detects modifications to the Windows Registry specifically targeting .pwn file associations related to the ValleyRAT malware. ValleyRAT may create or alter registry entries to associate .pwn files with malicious processes, allowing it to execute harmful scripts or commands when these files are opened. By monitoring for unusual changes in registry keys linked to .",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*.pwn\\Shell\\Open\\command"" OR Registry.registry_value_data = "".pwn"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_valleyrat_pwn_reg_entry_filter`"
Windows Modify Registry With MD5 Reg Key Name,"The following analytic detects potentially malicious registry modifications characterized by MD5-like registry key names. It leverages the Endpoint data model to identify registry entries under the SOFTWARE path with 32-character hexadecimal names, a technique often used by NjRAT malware for fileless storage of keylogs and .DLL plugins. This activity is significant as it can indicate the presence of NjRAT or similar malware, which can lead to unauthorized data access and persistent threats within the environment.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly`  count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where  Registry.registry_path = ""*\\SOFTWARE\\*"" Registry.registry_value_data = ""Binary Data"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| eval dropped_reg_path = split(registry_path, ""\\"") 
| eval dropped_reg_path_split_count = mvcount(dropped_reg_path) 
| eval validation_result= if(match(registry_value_name,""^[0-9a-fA-F]{32}$""),""md5"",""nonmd5"") 
| where validation_result = ""md5"" AND dropped_reg_path_split_count <= 5 
| table dest user registry_path registry_value_name registry_value_data registry_key_name reg_key_name dropped_reg_path_split_count validation_result 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_with_md5_reg_key_name_filter`"
Windows Modify Show Compress Color And Info Tip Registry,"The following analytic detects suspicious modifications to the Windows registry keys related to file compression color and information tips. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the &quot;ShowCompColor&quot; and &quot;ShowInfoTip&quot; values under the &quot;Microsoft\Windows\CurrentVersion\Explorer\Advanced&quot; path. This activity is significant as it was observed in the Hermetic Wiper malware, indicating potential malicious intent to alter file attributes and user interface elements.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced*"" AND Registry.registry_value_name  IN(""ShowCompColor"", ""ShowInfoTip"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_show_compress_color_and_info_tip_registry_filter`"
Windows Mshta Execution In Registry,"The following analytic detects the execution of mshta.exe via registry entries to run malicious scripts. It leverages registry activity logs to identify entries containing &quot;mshta,&quot; &quot;javascript,&quot; &quot;vbscript,&quot; or &quot;WScript.Shell.&quot; This behavior is significant as it indicates potential fileless malware, such as Kovter, which uses encoded scripts in the registry to persist and execute without files.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_value_data = ""*mshta*"" OR Registry.registry_value_data IN (""*javascript:*"", ""*vbscript:*"",""*WScript.Shell*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_mshta_execution_in_registry_filter`"
Windows Multiple NTLM Null Domain Authentications,"The following analytic detects when a device is the target of numerous NTLM authentications using a null domain. This activity generally results when an attacker attempts to brute force, password spray, or otherwise authenticate to a domain joined Windows device from a non-domain device. This activity may also generate a large number of EventID 4776 events in tandem, however these events will not indicate the attacker or target device",Windows Events,"Execution, Credential Access","T1110.003, T1110","`ntlm_audit` EventCode IN (8004,8005,8006) DomainName=NULL UserName!=NULL 
| eval src = replace(WorkstationName,""\\\\"","""")  ```CIM alignment, remove leading \\ from some auth attempts ``` 
| eval dest = SChannelName, user = UserName ``` CIM alignment``` 
| where SChannelName!=src ``` Remove NTLM auths to self, improves accuracy for certain applications``` 
| stats count min(_time) as firstTime max(_time) as lastTime dc(eval(upper(user))) as unique_count dc(eval(upper(src))) as src_count by dest 
| eventstats avg(unique_count) as unique_avg , stdev(unique_count) as unique_std 
| eval upperBound_unique=(1+unique_avg+unique_std*3) ``` adjust formula for sensitivity``` 
| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0) 
| where isOutlier==1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_multiple_ntlm_null_domain_authentications_filter`"
Windows New Custom Security Descriptor Set On EventLog Channel,"The following analytic detects suspicious modifications to the EventLog security descriptor registry value for defense evasion. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;CustomSD&quot; value within the &quot;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Eventlog&lt;Channel&gt;\CustomSD&quot; path. This activity is significant as changes to the access permissions of the event log could blind security products and help attackers evade defenses.",Windows Events,Defense Evasion,"T1562.002, T1562","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\Services\\Eventlog\\*"" AND Registry.registry_value_name=CustomSD by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_new_custom_security_descriptor_set_on_eventlog_channel_filter`"
Windows New Deny Permission Set On Service SD Via Sc.EXE,"The following analytic detects changes in a service security descriptor where a new deny ace has been added. It leverages data from Endpoint Detection and Response (EDR) agents, specifically searching for any process execution involving the &quot;sc.exe&quot; binary with the &quot;sdset&quot; flag targeting any service and adding a dedicated deny ace. If confirmed malicious, this could allow an attacker to escalate their privileges, blind defenses and more.",Windows Events,"Execution, Defense Evasion",T1564,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe) Processes.process=""*sdset *"" Processes.process=""*(D;*"" Processes.process IN (""*;IU*"", ""*;S-1-5-4*"", ""*;SU*"", ""*;S-1-5-6*"", ""*;BA*"", ""*;S-1-5-32-544*"", ""*;SY*"", ""*;S-1-5-18*"", ""*;WD*"", ""*;S-1-1-0*"", ""*;AU*"", ""*;S-1-5-11*"", ""*;LS*"", ""*;S-1-5-19*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_new_deny_permission_set_on_service_sd_via_sc_exe_filter`"
Windows New Service Security Descriptor Set Via Sc.EXE,"The following analytic detects changes in a service security descriptor where a new deny ace has been added. It leverages data from Endpoint Detection and Response (EDR) agents, specifically searching for any process execution involving the &quot;sc.exe&quot; binary with the &quot;sdset&quot; flag targeting any service and adding a dedicated deny ace. If confirmed malicious, this could allow an attacker to escalate their privileges, blind defenses and more.",Windows Events,"Execution, Defense Evasion",T1564,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe) Processes.process=""*sdset *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_new_service_security_descriptor_set_via_sc_exe_filter`"
Windows Njrat Fileless Storage via Registry,"The following analytic detects suspicious registry modifications indicative of NjRat's fileless storage technique. It leverages the Endpoint.Registry data model to identify specific registry paths and values commonly used by NjRat for keylogging and executing DLL plugins. This activity is significant as it helps evade traditional file-based detection systems, making it crucial for SOC analysts to monitor.",Windows Events,Defense Evasion,T1027.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\[kl]"" OR  Registry.registry_value_data IN (""*[ENTER]*"", ""*[TAP]*"", ""*[Back]*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_njrat_fileless_storage_via_registry_filter`"
Windows Non Discord App Access Discord LevelDB,"The following analytic detects non-Discord applications accessing the Discord LevelDB database. It leverages Windows Security Event logs, specifically event code 4663, to identify file access attempts to the LevelDB directory by processes other than Discord. This activity is significant as it may indicate attempts to steal Discord credentials or access sensitive user data. If confirmed malicious, this could lead to unauthorized access to user profiles, messages, and other critical information, potentially compromising the security and privacy of the affected users.",Windows Events,Discovery,T1012,"`wineventlog_security` EventCode=4663 object_file_path IN (""*\\discord\\Local Storage\\leveldb*"") AND process_name != *\\discord.exe AND NOT (process_path IN (""*:\\Windows\\System32\\*"", ""*:\\Windows\\SysWow64\\*"", ""*:\\Program Files*"", ""*:\\Windows\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_non_discord_app_access_discord_leveldb_filter`"
Windows Parent PID Spoofing with Explorer,"The following analytic identifies a suspicious explorer.exe process with the /root command-line parameter. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process and command-line data. The presence of /root in explorer.exe is significant as it may indicate parent process spoofing, a technique used by malware to evade detection. If confirmed malicious, this activity could allow an attacker to operate undetected, potentially leading to unauthorized access, privilege escalation, or persistent threats within the environment.",Windows Events,"Discovery, Execution, Privilege Escalation, Defense Evasion",T1134.004,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*explorer.exe*"" Processes.process=""*/root,*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_parent_pid_spoofing_with_explorer_filter`"
Windows Password Managers Discovery,"The following analytic identifies command-line activity that searches for files related to password manager software, such as &quot;.kdbx&quot; and &quot;credential&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because attackers often target password manager databases to extract stored credentials, which can be used for further exploitation.",Windows Events,"Impact, Execution, Credential Access, Discovery","T1555, T1555.005","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*dir *"" OR  Processes.process = ""*findstr*"" AND Processes.process IN ( ""*.kdbx*"", ""*credential*"", ""*key3.db*"",""*pass*"", ""*cred*"", ""*key4.db*"", ""*accessTokens*"", ""*access_tokens*"", ""*.htpasswd*"", ""*Ntds.dit*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_password_managers_discovery_filter`"
Windows Phishing Outlook Drop Dll In FORM Dir,"The following analytic detects the creation of a DLL file by an outlook.exe process in the AppData\Local\Microsoft\FORMS directory. This detection leverages data from the Endpoint.Processes and Endpoint.Filesystem datamodels, focusing on process and file creation events. This activity is significant as it may indicate an attempt to exploit CVE-2024-21378, where a custom MAPI form loads a potentially malicious DLL.",Windows Events,"Initial Access, Execution, Discovery, Exfiltration",T1566,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=outlook.exe by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| join process_guid, _time [ 
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name =""*.dll"" Filesystem.file_path = ""*\\AppData\\Local\\Microsoft\\FORMS\\IPM*"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
| fields file_name file_path process_name process_path process dest file_create_time _time process_guid] 
| `windows_phishing_outlook_drop_dll_in_form_dir_filter`"
Windows PowerShell Process With Malicious String,"The following analytic detects the execution of multiple offensive toolkits and commands through the process execution datamodel. This method captures commands given directly to powershell.exe, allowing for the identification of suspicious activities including several well-known tools used for credential theft, lateral movement, and persistence. If confirmed malicious, this could lead to unauthorized access, privilege escalation, and potential compromise of sensitive information within the environment.",Windows Events,"Lateral Movement, Execution, Persistence, Privilege Escalation","T1059.001, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name 
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash 
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path 
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup malicious_powershell_strings command as process
| where isnotnull(match)
| `windows_powershell_process_with_malicious_string_filter`"
Windows PowerShell Script Block With Malicious String,"The following analytic detects the execution of multiple offensive toolkits and commands by leveraging PowerShell Script Block Logging (EventCode=4104). This method captures and logs the full command sent to PowerShell, allowing for the identification of suspicious activities including several well-known tools used for credential theft, lateral movement, and persistence. If confirmed malicious, this could lead to unauthorized access, privilege escalation, and potential compromise of sensitive information within the environment.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Discovery","T1059.001, T1059","`powershell` ScriptBlockText=* EventCode=4104 
| stats count min(_time) as firstTime max(_time) as lastTime list(ScriptBlockText) as command values(Guid) as Guid values(Opcode) as Opcode values(Name) as Name values(Path) as Path values(ProcessID) as ProcessID values(ScriptBlockId) as ScriptBlockId values(ScriptBlockText) as ScriptBlockText by dest signature signature_id user_id vendor_product 
| eval command = mvjoin(command,""\n"") 
| lookup malicious_powershell_strings command 
| where isnotnull(match) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_script_block_with_malicious_string_filter`"
Windows PowerSploit GPP Discovery,"The following analytic detects the execution of the Get-GPPPassword PowerShell cmdlet, which is used to search for unsecured credentials in Group Policy Preferences (GPP). This detection leverages PowerShell Script Block Logging to identify specific script block text associated with this cmdlet. Monitoring this activity is crucial as it can indicate an attempt to retrieve and decrypt stored credentials from SYSVOL, potentially leading to unauthorized access.",Windows Events,"Discovery, Execution, Credential Access, Privilege Escalation","T1552, T1552.006","`powershell` EventCode=4104  (ScriptBlockText=Get-GPPPassword OR ScriptBlockText=Get-CachedGPPPassword) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powersploit_gpp_discovery_filter`"
Windows Private Keys Discovery,"The following analytic identifies processes that retrieve information related to private key files, often used by post-exploitation tools like winpeas. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that search for private key certificates. This activity is significant as it indicates potential attempts to locate insecurely stored credentials, which adversaries can exploit for privilege escalation, persistence, or remote service authentication.",Windows Events,"Execution, Credential Access, Persistence, Impact, Privilege Escalation, Discovery","T1552, T1552.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*dir *"" OR  Processes.process = ""*findstr*"" AND Processes.process IN ( ""*.rdg*"", ""*.gpg*"", ""*.pgp*"", ""*.p12*"", ""*.der*"", ""*.csr*"", ""*.cer*"", ""*.ovpn*"", ""*.key*"",  ""*.ppk*"", ""*.p12*"", ""*.pem*"", ""*.pfx*"", ""*.p7b*"", ""*.asc*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_private_keys_discovery_filter`"
Windows Privilege Escalation System Process Without System Parent,"The following analytic detects any system integrity level process spawned by a non-system account. It leverages Sysmon EventID 1, focusing on process integrity and parent user data. This behavior is significant as it often indicates successful privilege escalation to SYSTEM from a user-controlled process or service. If confirmed malicious, this activity could allow an attacker to gain full control over the system, execute arbitrary code, and potentially compromise the entire environment.",Windows Events,"Discovery, Privilege Escalation, Defense Evasion","T1134, T1134.001, T1068, T1548","`sysmon` EventCode=1 IntegrityLevel=""system"" ParentUser=* NOT ParentUser IN (""*SYSTEM"",""*LOCAL SERVICE"",""*NETWORK SERVICE"",""*DWM-*"",""*$"",""-"") 
| eval src_user = replace(ParentUser,""^[^\\\]+\\\\"","""") 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest original_file_name parent_process parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process process_exec process_guid process_hash process_id process_integrity_level process_name process_path user user_id vendor_product src_user 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `windows_privilege_escalation_system_process_without_system_parent_filter`"
Windows Privilege Escalation User Process Spawn System Process,"The following analytic detects when a process with low, medium, or high integrity spawns a system integrity process from a user-controlled location. This behavior is indicative of privilege escalation attempts where attackers elevate their privileges to SYSTEM level from a user-controlled process or service. The detection leverages Sysmon data, specifically Event ID 15, to identify such transitions.",Windows Events,"Privilege Escalation, Defense Evasion","T1134, T1134.001, T1068, T1548","| tstats `security_content_summariesonly` count min(_time) as firstTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""low"",""medium"",""high"") NOT Processes.user IN (""*SYSTEM"",""*LOCAL SERVICE"",""*NETWORK SERVICE"",""DWM-*"",""*$"") AND Processes.process_path IN (""*\\\\*"",""*\\Users\\*"",""*\\Temp\\*"",""*\\ProgramData\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| eval join_guid = process_guid 
| join max=0 dest join_guid [
| tstats `security_content_summariesonly` count max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""system"") AND Processes.parent_process_path IN (""*\\\\*"",""*\\Users\\*"",""*\\Temp\\*"",""*\\ProgramData\\*"") by Processes.dest, Processes.user, Processes.parent_process_guid, Processes.process_name, Processes.process, Processes.process_path, Processes.process_integrity_level, Processes.process_current_directory 
| `drop_dm_object_name(Processes)` 
| rename parent_process_guid as join_guid, process* as system_process*, user as system_user ] 
| fields dest, user, parent_process, parent_process_name, parent_process_guid, process, process_name, process_guid, process_integrity_level,process_path, process_current_directory, system_process_name, system_process, system_process_path, system_process_integrity_level, system_process_current_directory, system_user, firstTime, lastTime, count 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_privilege_escalation_user_process_spawn_system_process_filter`"
Windows Process Injection In Non-Service SearchIndexer,"The following analytic identifies instances of the searchindexer.exe process that are not spawned by services.exe, indicating potential process injection. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent processes. This activity is significant because QakBot malware often uses a fake searchindexer.exe to evade detection and perform malicious actions such as data exfiltration and keystroke logging.",Windows Events,"Command And Control, Execution, Persistence, Privilege Escalation, Defense Evasion, Exfiltration",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name != services.exe Processes.process_name=searchindexer.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_in_non_service_searchindexer_filter`"
Windows Process Injection Of Wermgr to Known Browser,"The following analytic identifies the suspicious remote thread execution of the wermgr.exe process into known browsers such as firefox.exe, chrome.exe, and others. It leverages Sysmon EventCode 8 logs to detect this behavior by monitoring SourceImage and TargetImage fields. This activity is significant because it is indicative of Qakbot malware, which injects malicious code into legitimate processes to steal information.",Windows Events,"Execution, Defense Evasion",T1055.001,"`sysmon` EventCode=8 SourceImage = ""*\\wermgr.exe"" TargetImage IN (""*\\firefox.exe"", ""*\\chrome.exe"", ""*\\iexplore.exe"",""*\\microsoftedgecp.exe"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_of_wermgr_to_known_browser_filter`"
Windows Process Injection Remote Thread,"The following analytic detects suspicious remote thread execution in processes such as Taskmgr.exe, calc.exe, and notepad.exe, which may indicate process injection by malware like Qakbot. This detection leverages Sysmon EventCode 8 to identify remote thread creation in specific target processes. This activity is significant as it often signifies an attempt by malware to inject malicious code into legitimate processes, potentially leading to unauthorized code execution.",Windows Events,"Execution, Persistence, Defense Evasion",T1055.002,"`sysmon` EventCode=8 TargetImage IN (""*\\Taskmgr.exe"", ""*\\calc.exe"", ""*\\notepad.exe"", ""*\\rdpclip.exe"", ""*\\explorer.exe"", ""*\\wermgr.exe"", ""*\\ping.exe"", ""*\\OneDriveSetup.exe"", ""*\\dxdiag.exe"", ""*\\mobsync.exe"", ""*\\msra.exe"", ""*\\xwizard.exe"",""*\\cmd.exe"", ""*\\powershell.exe"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_remote_thread_filter`"
Windows Process Injection Wermgr Child Process,"The following analytic identifies a suspicious instance of wermgr.exe spawning a child process unrelated to error or fault handling. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process relationships and command-line executions. This activity is significant as it can indicate Qakbot malware, which injects malicious code into wermgr.exe to evade detection and execute malicious actions.",Windows Events,"Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = ""wermgr.exe"" AND NOT (Processes.process_name IN (""WerFaultSecure.exe"", ""wermgr.exe"", ""WerFault.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_wermgr_child_process_filter`"
Windows Proxy Via Registry,"The following analytic detects the modification of registry keys related to the Windows Proxy settings via netsh.exe. It leverages data from the Endpoint.Registry data model, focusing on changes to the registry path &quot;\System\CurrentControlSet\Services\PortProxy\v4tov4\tcp&quot;. This activity is significant because netsh.exe can be used to establish a persistent proxy, potentially allowing an attacker to execute a helper DLL whenever netsh.",Windows Events,"Command And Control, Persistence",T1090.001,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path =""*\\System\\CurrentControlSet\\Services\\PortProxy\\v4tov4\\tcp*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_proxy_via_registry_filter`"
Windows Registry Payload Injection,"The following analytic detects suspiciously long data written to the Windows registry, a behavior often linked to fileless malware or persistence techniques. It leverages Endpoint Detection and Response (EDR) telemetry, focusing on registry events with data lengths exceeding 512 characters. This activity is significant as it can indicate an attempt to evade traditional file-based defenses, making it crucial for SOC monitoring.",Windows Events,"Execution, Persistence, Defense Evasion","T1027.011, T1027","| tstats `security_content_summariesonly` count from datamodel=Endpoint.Registry where Registry.registry_value_data=* by _time span=1h Registry.dest Registry.registry_path Registry.registry_value_name Registry.process_guid Registry.registry_value_data Registry.registry_key_name Registry.registry_hive Registry.status Registry.action Registry.process_id Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| eval reg_data_len = len(registry_value_data) 
| where reg_data_len > 512 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_payload_injection_filter`"
Windows Regsvr32 Renamed Binary,"The following analytic identifies instances where the regsvr32.exe binary has been renamed and executed. This detection leverages Endpoint Detection and Response (EDR) data, specifically focusing on the original filename metadata. Renaming regsvr32.exe is significant as it can be an evasion technique used by attackers to bypass security controls. If confirmed malicious, this activity could allow an attacker to execute arbitrary DLLs, potentially leading to code execution, privilege escalation, or persistence within the environment.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1218.010,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name != regsvr32.exe AND Processes.original_file_name=regsvr32.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_regsvr32_renamed_binary_filter`"
Windows Renamed Powershell Execution,"The following analytic identifies instances where the PowerShell executable has been renamed and executed under an alternate filename. This behavior is commonly associated with attempts to evade security controls or bypass logging mechanisms that monitor standard PowerShell usage. While rare in legitimate environments, renamed PowerShell binaries are frequently observed in malicious campaigns leveraging Living-off-the-Land Binaries (LOLBins) and fileless malware techniques.",Windows Events,"Execution, Defense Evasion",T1036.003,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
(
Processes.original_file_name = PowerShell.EXE
Processes.process_name != powershell.exe
)
OR
(
Processes.original_file_name = pwsh.dll
Processes.process_name != pwsh.exe
)
OR
(
Processes.original_file_name = powershell_ise.EXE
Processes.process_name != powershell_ise.exe
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process 
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id 
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user 
Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_renamed_powershell_execution_filter`"
Windows Rundll32 Apply User Settings Changes,"The following analytic detects the execution of rundll32 with a call to the user32 DLL, specifically the UpdatePerUserSystemParameters function. This function is responsible for updating system parameters, such as desktop backgrounds, display settings, and visual themes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions. This activity can be significant as it is an uncommon way to apply settings.",Windows Events,"Execution, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
`process_rundll32`
Processes.process = ""*user32.dll*""
Processes.process = ""*UpdatePerUserSystemParameters*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_rundll32_apply_user_settings_changes_filter`"
Windows Rundll32 Load DLL in Temp Dir,"This detection identifies instances where rundll32.exe is used to load a DLL from a temporary directory, such as C:\Users&lt;User&gt;\AppData\Local\Temp\ or C:\Windows\Temp. While rundll32.exe is a legitimate Windows utility used to execute functions exported from DLLs, its use to load libraries from temporary locations is highly suspicious. These directories are commonly used by malware and red team tools to stage payloads or execute code in-memory without writing it to more persistent locations.",Windows Events,"Initial Access, Execution, Privilege Escalation, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` AND Processes.process IN (""*temp\\*"", ""*\\tmp\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rundll32_load_dll_in_temp_dir_filter`"
Windows Scheduled Task Service Spawned Shell,"The following analytic detects when the Task Scheduler service (&quot;svchost.exe -k netsvcs -p -s Schedule&quot;) spawns common command line, scripting, or shell execution binaries such as &quot;powershell.exe&quot; or &quot;cmd.exe&quot;. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. This activity is significant as attackers often abuse the Task Scheduler for execution and persistence, blending in with legitimate Windows operations.",Windows Events,"Execution, Persistence","T1053.005, T1053, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process=""*\\system32\\svchost.exe*"" AND Processes.parent_process=""*-k*"" AND Processes.parent_process= ""*netsvcs*"" AND Processes.parent_process=""*-p*"" AND Processes.parent_process=""*-s*"" AND Processes.parent_process=""*Schedule*"" Processes.process_name IN(""powershell.exe"", ""wscript.exe"", ""cscript.exe"", ""cmd.exe"", ""sh.exe"", ""ksh.exe"", ""zsh.exe"", ""bash.exe"", ""scrcons.exe"",""pwsh.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_scheduled_task_service_spawned_shell_filter`"
Windows Scheduled Tasks for CompMgmtLauncher or Eventvwr,"The following analytic detects the creation or modification of Windows Scheduled Tasks related to CompMgmtLauncher or Eventvwr. These legitimate system utilities, used for launching the Computer Management Console and Event Viewer, can be abused by attackers to execute malicious payloads under the guise of normal system processes. By leveraging these tasks, adversaries can establish persistence or elevate privileges without raising suspicion.",Windows Events,"Execution, Persistence",T1053,"`wineventlog_security` EventCode=4698 TaskContent = ""*&lt;Command&gt;C:\\Windows\\System32\\CompMgmtLauncher.exe&lt;/Command&gt;*"" OR TaskContent = ""*&lt;Command&gt;C:\\Windows\\System32\\zh-CN\\eventvwr.msc&lt;/Command&gt;*"" OR TaskContent = ""*&lt;Command&gt;C:\\Windows\\System32\\eventvwr.msc&lt;/Command&gt;*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest action EventData_Xml TaskContent TaskName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_scheduled_tasks_for_compmgmtlauncher_or_eventvwr_filter`"
Windows ScManager Security Descriptor Tampering Via Sc.EXE,"The following analytic detects changes in the ScManager service security descriptor settings. It leverages data from Endpoint Detection and Response (EDR) agents, specifically searching for any process execution involving the &quot;sc.exe&quot; binary with the &quot;sdset&quot; flag targeting the &quot;scmanager&quot; service. If confirmed malicious, this could allow an attacker to escalate their privileges.",Windows Events,"Execution, Defense Evasion","T1569, T1569.002","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe) Processes.process=""*sdset *"" Processes.process=""*scmanager*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_scmanager_security_descriptor_tampering_via_sc_exe_filter`"
Windows Screen Capture in TEMP folder,"The following analytic detects the creation of screen capture files by the Braodo stealer malware. This stealer is known to capture screenshots of the victim's desktop as part of its data theft activities. The detection focuses on identifying unusual screen capture activity, especially when images are saved in directories often used by malware, such as temporary or hidden folders.",Windows Events,Collection,T1113,"|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""screenshot.png"", ""screenshot.jpg"",""screenshot.bmp"") Filesystem.file_path = ""*\\temp\\*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_screen_capture_in_temp_folder_filter`"
Windows Screen Capture Via Powershell,The following analytic detects the execution of a PowerShell script designed to capture screen images on a host. It leverages PowerShell Script Block Logging to identify specific script block text patterns associated with screen capture activities. This behavior is significant as it may indicate an attempt to exfiltrate sensitive information by capturing desktop screenshots.,Windows Events,"Collection, Execution",T1113,"`powershell` EventCode=4104 ScriptBlockText = ""*[Drawing.Graphics]::FromImage(*"" AND ScriptBlockText = ""*New-Object Drawing.Bitmap*"" AND ScriptBlockText = ""*.CopyFromScreen*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_screen_capture_via_powershell_filter`"
Windows Security Support Provider Reg Query,"The following analytic identifies command-line activity querying the registry for Security Support Providers (SSPs) related to Local Security Authority (LSA) protection and configuration. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on processes accessing specific LSA registry paths. Monitoring this activity is crucial as adversaries and post-exploitation tools like winpeas may use it to gather information on LSA protections, potentially leading to credential theft.",Windows Events,"Execution, Impact, Persistence",T1547.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` AND Processes.process = ""* query *"" AND Processes.process = ""*\\SYSTEM\\CurrentControlSet\\Control\\LSA*"" Processes.process IN (""*RunAsPPL*"" , ""*LsaCfgFlags*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_security_support_provider_reg_query_filter`"
Windows Shell Process from CrushFTP,"The following analytic identifies instances where CrushFTP's service process (crushftpservice.exe) spawns shell processes like cmd.exe or powershell.exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events. This activity is significant because CrushFTP should not normally spawn interactive shell processes during regular operations. If confirmed malicious, this behavior could indicate successful exploitation of vulnerabilities like CVE-2025-31161, potentially allowing attackers to execute arbitrary commands with the privileges of the CrushFTP service.",Windows Events,"Initial Access, Execution, Persistence","T1190, T1059.001, T1505, T1059.003","| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=crushftpservice.exe AND `process_cmd` OR `process_powershell` by Processes.dest Processes.parent_process Processes.original_file_name Processes.user Processes.action Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_path Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_path Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_shell_process_from_crushftp_filter`"
Windows Steal or Forge Kerberos Tickets Klist,"The following analytic identifies the execution of the Windows OS tool klist.exe, often used by post-exploitation tools like winpeas. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process details. Monitoring klist.exe is significant as it can indicate attempts to list or gather cached Kerberos tickets, which are crucial for lateral movement or privilege escalation.",Windows Events,"Execution, Credential Access, Lateral Movement, Impact, Privilege Escalation",T1558,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""klist.exe"" OR Processes.original_file_name = ""klist.exe"" Processes.parent_process_name IN (""cmd.exe"", ""powershell*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_or_forge_kerberos_tickets_klist_filter`"
Windows SubInAcl Execution,"The following analytic detects the execution of the SubInAcl utility. SubInAcl is a legacy Windows Resource Kit tool from the Windows 2003 era, used to manipulate security descriptors of securable objects. It leverages data from Endpoint Detection and Response (EDR) agents, specifically searching for any process execution involving &quot;SubInAcl.exe&quot; binary. This activity can be significant because the utility should be rarely found on modern Windows machines, which mean any execution could potentially be considered suspicious.",Windows Events,"Execution, Discovery, Defense Evasion","T1222.001, T1222","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=subinacl.exe OR Processes.original_file_name=SubInAcl.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_subinacl_execution_filter`"
Windows System Network Config Discovery Display DNS,"The following analytic identifies the execution of the &quot;ipconfig /displaydns&quot; command, which retrieves DNS reply information using the built-in Windows tool IPConfig. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line executions. Monitoring this activity is significant as threat actors and post-exploitation tools like WINPEAS often abuse this command to gather network information.",Windows Events,"Lateral Movement, Execution, Impact, Discovery",T1016,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""ipconfig.exe"" OR Processes.original_file_name = ""ipconfig.exe"" AND Processes.process = ""*/displaydns*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_network_config_discovery_display_dns_filter`"
Windows System Time Discovery W32tm Delay,"The following analytic identifies the use of the w32tm.exe utility with the /stripchart function, which is indicative of DCRat malware delaying its payload execution. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line arguments used by w32tm.exe. This activity is significant as it may indicate an attempt to evade detection by delaying malicious actions such as C2 communication and beaconing.",Windows Events,"Discovery, Execution, Persistence",T1124,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = w32tm.exe Processes.process= ""* /stripchart *"" Processes.process= ""* /computer:localhost *"" Processes.process= ""* /period:*"" Processes.process= ""* /dataonly *"" Processes.process= ""* /samples:*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_time_discovery_w32tm_delay_filter`"
Windows Terminating Lsass Process,"The following analytic detects a suspicious process attempting to terminate the Lsass.exe process. It leverages Sysmon EventCode 10 logs to identify processes granted PROCESS_TERMINATE access to Lsass.exe. This activity is significant because Lsass.exe is a critical process responsible for enforcing security policies and handling user credentials. If confirmed malicious, this behavior could indicate an attempt to perform credential dumping, privilege escalation, or evasion of security policies, potentially leading to unauthorized access and persistence within the environment.",Windows Events,"Discovery, Persistence, Privilege Escalation, Defense Evasion",T1562.001,"`sysmon` EventCode=10 TargetImage=*lsass.exe GrantedAccess = 0x1 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_terminating_lsass_process_filter`"
Windows Time Based Evasion,"The following analytic detects potentially malicious processes that initiate a ping delay using an invalid IP address. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;ping 0 -n&quot;. This behavior is significant as it is commonly used by malware like NJRAT to introduce time delays for evasion tactics, such as delaying self-deletion.",Windows Events,"Execution, Persistence, Defense Evasion",T1497.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""ping.exe"" Processes.parent_process = ""* ping 0 -n *"" OR Processes.process = ""* ping 0 -n *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_time_based_evasion_filter`"
Windows Unsigned DLL Side-Loading In Same Process Path,"This detection identifies unsigned DLLs loaded through DLL side-loading with same file path with the process loaded the DLL, a technique observed in DarkGate malware. This detection monitors DLL loading, verifies signatures, and flags unsigned DLLs. Suspicious file paths and known executable associations are checked. Detecting such suspicious DLLs is crucial in preventing privilege escalation attacks and other potential security breaches.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1574.001,"`sysmon` EventCode=7 Signed=false SignatureStatus != Valid NOT (Image IN (""*:\\windows\\system32\\*"", ""*:\\windows\\syswow64\\*"", ""c:\\Program Files*"")) NOT (ImageLoaded IN (""*:\\windows\\system32\\*"", ""*:\\windows\\syswow64\\*"", ""c:\\Program Files*"")) 
|  rex field=Image ""(?<ImageFolderPath>.+\\\)"" 
|  rex field=ImageLoaded ""(?<ImageLoadedFolderPath>.+\\\)"" 
|  where ImageFolderPath = ImageLoadedFolderPath 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unsigned_dll_side_loading_in_same_process_path_filter`"
Windows Unusual NTLM Authentication Destinations By Source,"The following analytic detects when an unusual number NTLM authentications is attempted by the same source against multiple destinations. This activity generally results when an attacker attempts to brute force, password spray, or otherwise authenticate to a multiple domain joined Windows devices using an NTLM based process/attack. This same activity may also generate a large number of EventID 4776 events as well.",Windows Events,Credential Access,"T1110.003, T1110","`ntlm_audit`
EventCode = 8004
SChannelName=* WorkstationName=*
```CIM alignment, remove leading \\ from some auth attempts ```
| eval src = replace(WorkstationName,""\\\\"","""")
| eval dest = SChannelName, user = UserName
``` Remove NTLM auths to self, improves accuracy for certain applications ```
| where SChannelName!=src
| stats count min(_time) as firstTime
max(_time) as lastTime
dc(eval(upper(dest))) as unique_count by src
| eventstats avg(unique_count) as unique_avg
stdev(unique_count) as unique_std
``` adjust formula for sensitivity```
| eval upperBound_unique=(1+unique_avg+unique_std*3)
| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0)
| where isOutlier==1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_unusual_ntlm_authentication_destinations_by_source_filter`"
Windows Unusual NTLM Authentication Destinations By User,"The following analytic detects when an unusual number of NTLM authentications is attempted by the same user account against multiple destinations. This activity generally results when an attacker attempts to brute force, password spray, or otherwise authenticate to numerous domain joined Windows devices using an NTLM based process/attack. This same activity may also generate a large number of EventID 4776 events as well.",Windows Events,Credential Access,"T1110.003, T1110","`ntlm_audit`
EventCode = 8004
SChannelName=* WorkstationName=*
```CIM alignment, remove leading \\ from some auth attempts ```
| eval src = replace(WorkstationName,""\\\\"","""")
``` CIM alignment```
| eval dest = SChannelName, user = UserName
``` Remove NTLM auths to self, improves accuracy for certain applications ```
| where SChannelName!=src
| stats count min(_time) as firstTime
max(_time) as lastTime
dc(eval(upper(dest))) as unique_count by user
| eventstats avg(unique_count) as unique_avg
stdev(unique_count) as unique_std
``` adjust formula for sensitivity```
| eval upperBound_unique=(1+unique_avg+unique_std*3)
| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0)
| where isOutlier==1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_unusual_ntlm_authentication_destinations_by_user_filter`"
Windows Unusual NTLM Authentication Users By Destination,"The following analytic detects when a device is the target of numerous NTLM authentications using a null domain. This activity generally results when an attacker attempts to brute force, password spray, or otherwise authenticate to a domain joined Windows device from a non-domain device. This activity may also generate a large number of EventID 4776 events in tandem, however these events will not indicate the attacker or target device.",Windows Events,Credential Access,"T1110.003, T1110","`ntlm_audit`
EventCode = 8004
SChannelName=*
WorkstationName=*
```CIM alignment, remove leading \\ from some auth attempts ```
| eval src = replace(WorkstationName,""\\\\"","""")
| eval dest = SChannelName, user = UserName
``` Remove NTLM auths to self, improves accuracy for certain applications ```
| where SChannelName!=src
| stats count min(_time) as firstTime
max(_time) as lastTime
dc(eval(upper(user))) as unique_count by dest
| eventstats avg(unique_count) as unique_avg
stdev(unique_count) as unique_std
```adjust formula for sensitivity```
| eval upperBound_unique=(1+unique_avg+unique_std*3)
| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0)
| where isOutlier==1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_unusual_ntlm_authentication_users_by_destination_filter`"
Windows Unusual NTLM Authentication Users By Source,"The following analytic detects when an unusual number of NTLM authentications is attempted by the same source. This activity generally results when an attacker attempts to brute force, password spray, or otherwise authenticate to a domain joined Windows device using an NTLM based process/attack. This same activity may also generate a large number of EventID 4776 events in as well.",Windows Events,Credential Access,"T1110.003, T1110","`ntlm_audit`
EventCode = 8004
SChannelName=*
WorkstationName=*
```CIM alignment, remove leading \\ from some auth attempts```
| eval src = replace(WorkstationName,""\\\\"","""")
| eval dest = SChannelName, user = UserName
``` Remove NTLM auths to self, improves accuracy for certain applications```
| where SChannelName!=src
| stats count min(_time) as firstTime
max(_time) as lastTime
dc(eval(upper(user))) as unique_count by src
| eventstats avg(unique_count) as unique_avg
stdev(unique_count) as unique_std
``` adjust formula for sensitivity```
| eval upperBound_unique=(1+unique_avg+unique_std*3)
| eval isOutlier=CASE(unique_count > upperBound_unique, 1, true(), 0)
| where isOutlier==1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_unusual_ntlm_authentication_users_by_source_filter`"
Windows User Disabled Via Net,"The following analytic detects the use of the net.exe utility to disable a user account via the command line. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant as it may indicate an adversary's attempt to disrupt user availability, potentially as a precursor to further malicious actions.",Windows Events,"Execution, Impact",T1531,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process=""*user*"" AND Processes.process=""*/active:no*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_user_disabled_via_net_filter`"
Windows Visual Basic Commandline Compiler DNSQuery,"The following analytic detects instances where vbc.exe, the Visual Basic Command Line Compiler, initiates DNS queries. Normally, vbc.exe operates locally to compile Visual Basic code and does not require internet access or to perform DNS lookups. Therefore, any observed DNS activity originating from vbc.exe is highly suspicious and indicative of potential malicious activity. This behavior often suggests that a malicious payload is masquerading as the legitimate vbc.",Windows Events,"Command And Control, Execution, Exfiltration",T1071.004,"`sysmon` EventCode=22 process_name=""vbc.exe"" 
| rename dvc as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dest process_exec process_guid process_name  query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_visual_basic_commandline_compiler_dnsquery_filter`"
WinRM Spawning a Process,The following analytic detects suspicious processes spawned by WinRM (wsmprovhost.,Windows Events,"Initial Access, Execution, Persistence",T1190,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=wsmprovhost.exe Processes.process_name IN (""cmd.exe"",""sh.exe"",""bash.exe"",""powershell.exe"",""pwsh.exe"",""schtasks.exe"",""certutil.exe"",""whoami.exe"",""bitsadmin.exe"",""scp.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `winrm_spawning_a_process_filter`"
WSReset UAC Bypass,"The following analytic detects a suspicious modification of the registry aimed at bypassing User Account Control (UAC) by leveraging WSReset.exe. It identifies the creation or modification of specific registry values under the path &quot;\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\Shell\open\command&quot;. This detection uses data from Endpoint Detection and Response (EDR) agents, focusing on process and registry events. This activity is significant because UAC bypass techniques can allow attackers to execute high-privilege actions without user consent.",Windows Events,"Execution, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\\Shell\\open\\command*"" AND (Registry.registry_value_name = ""(Default)"" OR Registry.registry_value_name = ""DelegateExecute"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wsreset_uac_bypass_filter`"
XSL Script Execution With WMIC,"The following analytic detects the execution of an XSL script using the WMIC process, which is often indicative of malicious activity. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving WMIC and XSL files. This behavior is significant as it has been associated with the FIN7 group, known for using this technique to execute malicious scripts.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1220,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` Processes.process = ""*os get*"" Processes.process=""*/format:*"" Processes.process = ""*.xsl*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `xsl_script_execution_with_wmic_filter`"
Detect IPv6 Network Infrastructure Threats,The following analytic detects IPv6 network infrastructure threats by identifying suspicious activities such as IP and MAC address theft or packet drops.,Cisco IOS,"Initial Access, Impact, Collection","T1200, T1498, T1557.002","`cisco_networks` facility=""SISF"" mnemonic IN (""IP_THEFT"",""MAC_THEFT"",""MAC_AND_IP_THEFT"",""PAK_DROP"") 
| eval src_interface=src_int_prefix_long+src_int_suffix 
| eval dest_interface=dest_int_prefix_long+dest_int_suffix 
| stats min(_time) AS firstTime max(_time) AS lastTime values(src_mac) AS src_mac values(src_vlan) AS src_vlan values(mnemonic) AS mnemonic values(vendor_explanation) AS vendor_explanation values(src_ip) AS src_ip values(dest_ip) AS dest_ip values(dest_interface) AS dest_interface values(action) AS action count BY host src_interface 
| table host src_interface dest_interface src_mac src_ip dest_ip src_vlan mnemonic vendor_explanation action count 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `detect_ipv6_network_infrastructure_threats_filter`"
Detect Outbound LDAP Traffic,"The following analytic identifies outbound LDAP traffic to external IP addresses. It leverages the Network_Traffic data model to detect connections on ports 389 or 636 that are not directed to private IP ranges (RFC1918). This activity is significant because outbound LDAP traffic can indicate potential data exfiltration or unauthorized access attempts. If confirmed malicious, attackers could exploit this to access sensitive directory information, leading to data breaches or further network compromise.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Initial Access, Execution, Exfiltration","T1190, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(All_Traffic.dest_ip) as dest_ip from datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port = 389 OR All_Traffic.dest_port = 636 AND NOT (All_Traffic.dest_ip = 10.0.0.0/8 OR All_Traffic.dest_ip=192.168.0.0/16 OR All_Traffic.dest_ip = 172.16.0.0/12) by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.rule 
|`drop_dm_object_name(""All_Traffic"")` 
| where src_ip != dest_ip 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
|`detect_outbound_ldap_traffic_filter`"
Detect SNICat SNI Exfiltration,"The following analytic identifies the use of SNICat tool commands within the TLS SNI field, indicating potential data exfiltration attempts.",Zeek,Exfiltration,T1041,"`zeek_ssl` 
| rex field=server_name ""(?<snicat>(LIST
|LS
|SIZE
|LD
|CB
|CD
|EX
|ALIVE
|EXIT
|WHERE
|finito)-[A-Za-z0-9]{16}\.)"" 
| stats count by src_ip dest_ip server_name snicat 
| where count>0 
| table src_ip dest_ip server_name snicat 
| `detect_snicat_sni_exfiltration_filter`"
Detect Windows DNS SIGRed via Splunk Stream,The following analytic detects attempts to exploit the SIGRed vulnerability (CVE-2020-1350) in Windows DNS servers.,Splunk Internal,Execution,T1203,"`stream_dns`
| spath ""query_type{}""
| search ""query_type{}"" IN (SIG,KEY)
| spath protocol_stack
| search protocol_stack=""ip:tcp:dns""
| append [search `stream_tcp` bytes_out>65000]
| stats count by flow_id
| where count>1
| fields - count
| `detect_windows_dns_sigred_via_splunk_stream_filter`"
Detect Windows DNS SIGRed via Zeek,"The following analytic detects the presence of SIGRed, a critical DNS vulnerability, using Zeek DNS and Zeek Conn data.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Execution, Exfiltration",T1203,"| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where 
DNS.query_type IN (SIG,KEY) by DNS.flow_id
| rename DNS.flow_id as flow_id
| append [
| tstats  `security_content_summariesonly` count
from datamodel=Network_Traffic where
All_Traffic.bytes_in>65000
by All_Traffic.flow_id
| rename All_Traffic.flow_id as flow_id
]
| stats count by flow_id
| where count>1
| fields - count'
| `detect_windows_dns_sigred_via_zeek_filter`"
Detect Zerologon via Zeek,The following analytic detects attempts to exploit the Zerologon CVE-2020-1472 vulnerability via Zeek RPC.,Zeek,"Initial Access, Impact",T1190,"`zeek_rpc` operation IN (NetrServerPasswordSet2,NetrServerReqChallenge,NetrServerAuthenticate3) 
| bin span=5m _time 
| stats values(operation) dc(operation) as opscount count(eval(operation==""NetrServerReqChallenge"")) as challenge count(eval(operation==""NetrServerAuthenticate3"")) as authcount count(eval(operation==""NetrServerPasswordSet2"")) as passcount count as totalcount by _time,src_ip,dest_ip 
| search opscount=3 authcount>4 passcount>0 
| search `detect_zerologon_via_zeek_filter`"
Internal Horizontal Port Scan,"This analytic identifies instances where an internal host has attempted to communicate with 250 or more destination IP addresses using the same port and protocol. Horizontal port scans from internal hosts can indicate reconnaissance or scanning activities, potentially signaling malicious intent or misconfiguration. By monitoring network traffic logs, this detection helps detect and respond to such behavior promptly, enhancing network security and preventing potential threats.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Execution, Discovery",T1046,"| tstats `security_content_summariesonly` values(All_Traffic.action) as action values(All_Traffic.src_category) as src_category values(All_Traffic.dest_zone) as dest_zone values(All_Traffic.src_zone) as src_zone values(All_Traffic.src_port) as src_port count from datamodel=Network_Traffic where All_Traffic.src_ip IN (""10.0.0.0/8"",""172.16.0.0/12"",""192.168.0.0/16"") by All_Traffic.src_ip All_Traffic.dest_port All_Traffic.dest_ip All_Traffic.transport All_Traffic.rule span=1s _time 
| `drop_dm_object_name(""All_Traffic"")` 
| eval gtime=_time 
| bin span=1h gtime 
| stats min(_time) as _time values(action) as action dc(dest_ip) as totalDestIPCount values(src_category) as src_category values(dest_zone) as dest_zone values(src_zone) as src_zone by src_ip dest_port gtime transport 
| where totalDestIPCount>=250 
| eval dest_port=transport + ""/"" + dest_port 
| stats min(_time) as _time values(action) as action sum(totalDestIPCount) as totalDestIPCount values(src_category) as src_category values(dest_port) as dest_ports values(dest_zone) as dest_zone values(src_zone) as src_zone by src_ip gtime 
| fields - gtime 
| `internal_horizontal_port_scan_filter`"
Rundll32 DNSQuery,"The following analytic detects a suspicious rundll32.exe process making HTTP connections and performing DNS queries to web domains. It leverages Sysmon EventCode 22 logs to identify these activities. This behavior is significant as it is commonly associated with IcedID malware, where rundll32.exe checks internet connectivity and communicates with C&amp;C servers to download configurations and other components.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.011,"`sysmon` EventCode=22 process_name=""rundll32.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_dnsquery_filter`"
TOR Traffic,"The following analytic identifies allowed network traffic to The Onion Router (TOR), an anonymity network often exploited for malicious activities. It leverages data from Next Generation Firewalls, using the Network_Traffic data model to detect traffic where the application is TOR and the action is allowed. This activity is significant as TOR can be used to bypass conventional monitoring, facilitating hacking, data breaches, and illicit content dissemination.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Persistence, Exfiltration",T1090.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action IN (""allowed"", ""allow"") by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.rule 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Traffic"")` 
| `tor_traffic_filter`"
Wermgr Process Connecting To IP Check Web Services,"The following analytic detects the wermgr.exe process attempting to connect to known IP check web services. It leverages Sysmon EventCode 22 to identify DNS queries made by wermgr.exe to specific IP check services. This activity is significant because wermgr.exe is typically used for Windows error reporting, and its connection to these services may indicate malicious code injection, often associated with malware like Trickbot.",Windows Events,Execution,T1590.005,"`sysmon` EventCode =22 process_name = wermgr.exe QueryName IN (""*wtfismyip.com"", ""*checkip.amazonaws.com"", ""*ipecho.net"", ""*ipinfo.io"", ""*api.ipify.org"", ""*icanhazip.com"", ""*ip.anysrc.com"",""*api.ip.sb"", ""ident.me"", ""www.myexternalip.com"", ""*zen.spamhaus.org"", ""*cbl.abuseat.org"", ""*b.barracudacentral.org"",""*dnsbl-1.uceprotect.net"", ""*spam.dnsbl.sorbs.net"") 
|  stats  min(_time) as firstTime max(_time) as lastTime count by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wermgr_process_connecting_to_ip_check_web_services_filter`"
Windows AD Rogue Domain Controller Network Activity,The following analytic identifies unauthorized replication RPC calls from non-domain controller devices.,Zeek,"Persistence, Defense Evasion",T1207,"`zeek_rpc` DrsReplicaAdd OR DRSGetNCChanges 
| where NOT (dest_category=""Domain Controller"") OR NOT (src_category=""Domain Controller"") 
| fillnull value=""Unknown"" src_category, dest_category 
| table _time endpoint operation src src_category dest dest_category 
| `windows_ad_rogue_domain_controller_network_activity_filter`"
Detect F5 TMUI RCE CVE-2020-5902,"The following analytic identifies remote code execution (RCE) attempts targeting F5 BIG-IP, BIG-IQ, and Traffix SDC devices, specifically exploiting CVE-2020-5902.",F5 BIG-IP,"Initial Access, Execution, Exfiltration, Lateral Movement",T1190,"`f5_bigip_rogue` 
| regex _raw=""(hsqldb;
|.*\\.\\.;.*)"" 
| search `detect_f5_tmui_rce_cve_2020_5902_filter`"
Monitor Web Traffic For Brand Abuse,"The following analytic identifies web requests to domains that closely resemble your monitored brand's domain, indicating potential brand abuse.",Zscaler Proxy,,,"| tstats `security_content_summariesonly`
values(Web.url) as urls 
min(_time) as firstTime 
from datamodel=Web
by Web.src
| `drop_dm_object_name(""Web"")`
| `security_content_ctime(firstTime)`
| lookup update=true brandMonitoring_lookup domain as urls OUTPUT domain_abuse
| search domain_abuse=true
| `monitor_web_traffic_for_brand_abuse_filter`"
Plain HTTP POST Exfiltrated Data,"The following analytic detects potential data exfiltration using plain HTTP POST requests. It leverages network traffic logs, specifically monitoring the stream_http data source for POST methods containing suspicious form data such as &quot;wermgr.exe&quot; or &quot;svchost.exe&quot;. This activity is significant because it is commonly associated with malware like Trickbot, trojans, keyloggers, or APT adversaries, which use plain text HTTP POST requests to communicate with remote C2 servers.",Splunk Stream,"Command And Control, Exfiltration",T1048.003,"`stream_http` http_method=POST form_data IN (""*wermgr.exe*"",""*svchost.exe*"", ""*name=\""proclist\""*"",""*ipconfig*"", ""*name=\""sysinfo\""*"", ""*net view*"") 
|stats values(form_data) as http_request_body min(_time) as firstTime max(_time) as lastTime count by src_ip dest_ip http_method http_user_agent uri_path url bytes_in bytes_out 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `plain_http_post_exfiltrated_data_filter`"
M365 Copilot Jailbreak Attempts,"Detects M365 Copilot jailbreak attempts through prompt injection techniques including rule manipulation, system bypass commands, and AI impersonation requests that attempt to circumvent built-in safety controls.",Office 365 (Microsoft 365),"Execution, Exfiltration, Discovery, Defense Evasion",T1562.001,"`m365_exported_ediscovery_prompt_logs`
| search Subject_Title IN (
""*act as*"",
""*bypass*"",
""*ignore*"",
""*override*"",
""*pretend you are*"",
""*rules=*""
)
| eval user = Sender
| eval jailbreak_score=case(
match(Subject_Title, ""(?i)pretend you are.*amoral""), 4,
match(Subject_Title, ""(?i)act as.*entities""), 3,
match(Subject_Title, ""(?i)(ignore
|bypass
|override)""), 3,
match(Subject_Title, ""(?i)rules\s*=""), 4, 1=1, 1
)
| where jailbreak_score >= 2
| table _time, user, Subject_Title, jailbreak_score, Workload, Size
| sort -jailbreak_score, -_time
| `m365_copilot_jailbreak_attempts_filter`"
Active Directory Privilege Escalation Identified,The following analytic identifies potential privilege escalation activities within an organization's Active Directory (AD) environment.,Splunk Risk Rule (Multiple Sources),"Execution, Privilege Escalation, Defense Evasion",T1484,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Active Directory Privilege Escalation"" All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 4 
| `active_directory_privilege_escalation_identified_filter`"
Detect mshta inline hta execution,"The following analytic detects the execution of &quot;mshta.exe&quot; with inline protocol handlers such as &quot;JavaScript&quot;, &quot;VBScript&quot;, and &quot;About&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line arguments and process details. This activity is significant because mshta.exe can be exploited to execute malicious scripts, potentially leading to unauthorized code execution.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1218.005,"| tstats `security_content_summariesonly` count values(Processes.process)
as process values(Processes.parent_process) as parent_process min(_time) as firstTime
max(_time) as lastTime from datamodel=Endpoint.Processes where
`process_mshta`
Processes.process IN (""*vbscript*"", ""*javascript*"", ""*about*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_mshta_inline_hta_execution_filter`"
Windows MSHTA Writing to World Writable Path,"The following analytic identifies instances of mshta.exe writing files to world-writable directories. It leverages Sysmon EventCode 11 logs to detect file write operations by mshta.exe to directories like C:\Windows\Tasks and C:\Windows\Temp. This activity is significant as it often indicates an attempt to establish persistence or execute malicious code, deviating from the utility's legitimate use.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.005,"`sysmon`
EventCode=11
(
Image=""*\\mshta.exe""
OR
OriginalFileName=""mshta.exe""
)
TargetFilename IN (
""*\\Windows\\PLA\\Reports\\*"",
""*\\Windows\\PLA\\Rules\\*"",
""*\\Windows\\PLA\\Templates\\*"",
""*\\Windows\\Registration\\CRMLog\\*"",
""*\\Windows\\System32\\Com\\dmp\\*"",
""*\\Windows\\System32\\LogFiles\\WMI\\*"",
""*\\Windows\\System32\\Microsoft\\Crypto\\RSA\\MachineKeys\\*"",
""*\\Windows\\System32\\spool\\drivers\\color\\*"",
""*\\Windows\\System32\\spool\\PRINTERS\\*"",
""*\\Windows\\System32\\spool\\SERVERS\\*"",
""*\\Windows\\System32\\Tasks\\*"",
""*\\Windows\\SysWOW64\\Com\\dmp\\*"",
""*\\Windows\\SysWOW64\\Tasks\\*"",
""*\\Windows\\Tasks\\*"",
""*\\Windows\\Temp\\*"",
""*\\Windows\\tracing\\*""
)
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name
file_path  process_guid process_id user user_id vendor_product Image TargetFilename
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_mshta_writing_to_world_writable_path_filter`"
Windows Process Execution From ProgramData,"The following analytic identifies processes running from file paths within the ProgramData directory, a common location abused by adversaries for executing malicious code while evading detection. Threat actors often drop and execute payloads from this directory to bypass security controls, as it typically has write permissions for standard users. While this behavior can indicate malware execution or persistence techniques, it is important to note that some legitimate software, installers, and update mechanisms also run from ProgramData, leading to potential false positives.",Windows Events,"Execution, Persistence, Defense Evasion",T1036.005,"| tstats `security_content_summariesonly` count values(Processes.process_name)
as process_name values(Processes.process) as process min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
Processes.process_path = ""*:\\ProgramData\\*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_process_execution_from_programdata_filter`"
Windows Unsigned MS DLL Side-Loading,"The following analytic identifies potential DLL side-loading instances involving unsigned DLLs mimicking Microsoft signatures. It detects this activity by analyzing Sysmon logs for Event Code 7, where both the Image and ImageLoaded paths do not match system directories like system32, syswow64, and programfiles. This behavior is significant as adversaries often exploit DLL side-loading to execute malicious code via legitimate processes.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1574.001, T1547","`sysmon`
EventCode=7
Company=""Microsoft Corporation""
Signed=false
SignatureStatus!= Valid
NOT (Image IN (
""C:\\Program Files \(x86\)\\*"",
""C:\\Program Files\\*"",
""C:\\Windows\\System32\\*"",
""C:\\Windows\\SysWow64\\*""
)
)
NOT (ImageLoaded IN (
""C:\\Program Files \(x86\)\\*"",
""C:\\Program Files\\*"",
""C:\\Windows\\System32\\*"",
""C:\\Windows\\SysWow64\\*""
)
)
| rex field=Image ""(?<ImageFolderPath>.+\\\)""
| rex field=ImageLoaded ""(?<ImageLoadedFolderPath>.+\\\)""
| where ImageFolderPath = ImageLoadedFolderPath
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded
dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash
process_id process_name process_path service_dll_signature_exists service_dll_signature_verified
signature signature_id user_id vendor_product
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_unsigned_ms_dll_side_loading_filter`"
Windows Chrome Auto-Update Disabled via Registry,"The following analytic detects modifications to Windows registry values that disable Google Chrome auto-updates. Changes to values such as DisableAutoUpdateChecksCheckboxValue = 1, Update{8A69D345-D564-463C-AFF1-A69D9E530F96} = 0, UpdateDefault = 0, and AutoUpdateCheckPeriodMinutes = 0 can prevent Chrome from receiving security updates. This behavior may indicate attempts to bypass update policies, maintain unauthorized extensions, or facilitate malware persistence.",Windows Events,"Collection, Persistence",T1185,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry
where Registry.registry_path = ""*\\Google\\Update*""
AND
(
Registry.registry_value_name = ""DisableAutoUpdateChecksCheckboxValue""
Registry.registry_value_data = 0x00000001
)
OR
(
Registry.registry_value_name  IN (
""AutoUpdateCheckPeriodMinutes"",
""Update{8A69D345-D564-463C-AFF1-A69D9E530F96}"",
""UpdateDefault""
)
Registry.registry_value_data = 0x00000000
)
by Registry.action Registry.dest Registry.process_guid Registry.process_id
Registry.registry_hive Registry.registry_path Registry.registry_key_name
Registry.registry_value_data Registry.registry_value_name
Registry.registry_value_type Registry.status Registry.user Registry.vendor_product
| `drop_dm_object_name(Registry)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_chrome_auto_update_disabled_via_registry_filter`"
Windows Chrome Enable Extension Loading via Command-Line,"The following analytic detects instances where Google Chrome is started with the --disable-features=DisableLoadExtensionCommandLineSwitch flag, effectively enabling the loading of extensions via the command line. This may indicate attempts to bypass enterprise extension policies, load unauthorized or malicious extensions, or manipulate browser behavior. Monitoring this activity helps identify potential security policy violations, malware persistence techniques, or other suspicious Chrome modifications.",Windows Events,"Collection, Persistence",T1185,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.process_name = ""Chrome.exe""
Processes.process= ""*--disable-features*""
Processes.process= ""*DisableLoadExtensionCommandLineSwitch*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_chrome_enable_extension_loading_via_command_line_filter`"
Windows Chrome Extension Allowed Registry Modification,"The following analytic detects modifications to the Windows registry keys that control the Chrome Extension Install Allowlist. Unauthorized changes to these keys may indicate attempts to bypass Chrome extension restrictions or install unapproved extensions. This detection helps identify potential security policy violations or malicious activity targeting Chrome extension settings.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.",Windows Events,Collection,T1185,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Google\\Chrome\\ExtensionInstallAllowlist*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_chrome_extension_allowed_registry_modification_filter`"
Detect RTLO In File Name,"The following analytic identifies the use of the right-to-left override (RTLO) character in file names. It leverages data from the Endpoint.Filesystem datamodel, specifically focusing on file creation events and file names containing the RTLO character (U+202E). This activity is significant because adversaries use RTLO to disguise malicious files as benign by reversing the text that follows the character.",Windows Events,"Execution, Defense Evasion","T1036, T1036.002","| tstats `security_content_summariesonly`
count min(_time) as firstTime 
max(_time) as lastTime
values(Filesystem.file_create_time) as file_create_time
from datamodel=Endpoint.Filesystem where Filesystem.file_name!=unknown
by Filesystem.action Filesystem.dest Filesystem.file_access_time
Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time
Filesystem.file_name Filesystem.file_path Filesystem.file_acl
Filesystem.file_size Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| regex file_name = ""\\x{202E}""
| rex field=file_name ""(?<RTLO_file_1>.+)(?<RTLO_exist_file>\\x{202E})(?<RTLO_file_2>.+)""
| eval file_name_with_RTLO=file_name
| eval file_name=RTLO_file_1.RTLO_file_2
| fields - RTLO*
| `detect_rtlo_in_file_name_filter`"
Windows Command and Scripting Interpreter Hunting Path Traversal,"The following analytic identifies path traversal command-line executions, leveraging data from Endpoint Detection and Response (EDR) agents. It detects patterns in command-line arguments indicative of path traversal techniques, such as multiple instances of &quot;/..&quot;, &quot;..&quot;, or &quot;\..&quot;. This activity is significant as it often indicates attempts to evade defenses by executing malicious code, such as through msdt.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Processes where
Processes.process IN (""*\\..*"", ""*//..*"", ""*\..*"", ""*/..*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(""Processes"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| eval count_of_pattern1 = (mvcount(split(process,""/..""))-1)
| eval count_of_pattern2 = (mvcount(split(process,""\..""))-1)
| eval count_of_pattern3 = (mvcount(split(process,""\\..""))-1)
| eval count_of_pattern4 = (mvcount(split(process,""//..""))-1)
| search count_of_pattern1 > 1
OR
count_of_pattern2 > 1
OR
count_of_pattern3 > 1
OR
count_of_pattern4 > 1
| `windows_command_and_scripting_interpreter_hunting_path_traversal_filter`"
Cisco Secure Firewall - Privileged Command Execution via HTTP,"This analytic detects HTTP requests to privileged execution paths on Cisco routers, specifically targeting the /level/15/exec/-/* endpoint using Cisco Secure Firewall Intrusion Events. This detection leverages Snort signature 65370 to identify requests to these sensitive endpoints, which when combined with other indicators may signal active exploitation or post-compromise activity.
Search 1`cisco_secure_firewall` 2EventType=IntrusionEvent 3signature_id=65370 4 5| fillnull 6 7| stats dc(signature_id) as unique_signature_count 8 values(signature_id) as signature_id 9 values(signature) as signature 10 values(class_desc) as class_desc 11 values(MitreAttackGroups) as MitreAttackGroups 12 values(InlineResult) as InlineResult 13 values(InlineResultReason) as InlineResultReason 14 values(src) as src 15 values(dest_port) as dest_port 16 values(rule) as rule 17 values(transport) as transport 18 values(app) as app 19 min(_time) as firstTime 20 max(_time) as lastTime 21 by dest 22 23| `security_content_ctime(firstTime)` 24 25| `security_content_ctime(lastTime)` 26 27| `cisco_secure_firewall___privileged_command_execution_via_http_filter` Data Source Name Platform Sourcetype Source Cisco Secure Firewall Threat Defense Intrusion Event Other 'cisco:sfw:estreamer' 'not_applicable' Macros Used Name Value cisco_secure_firewall sourcetype=&quot;cisco:sfw:estreamer&quot; cisco_secure_firewall___privileged_command_execution_via_http_filter search * cisco_secure_firewall___privileged_command_execution_via_http_filter is an empty macro by default.",Cisco FTD,"Execution, Persistence","T1505.003, T1059","`cisco_secure_firewall` 
EventType=IntrusionEvent 
signature_id=65370
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(src) as src 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___privileged_command_execution_via_http_filter`"
Cisco Secure Firewall - SSH Connection to Non-Standard Port,"This analytic detects inbound SSH connections to non-standard ports on network devices using Cisco Secure Firewall Intrusion Events. APT actors have been observed enabling SSH servers on high, non-default TCP ports to maintain encrypted remote access to compromised network infrastructure. This detection leverages Snort signature 65369 to identify SSH protocol traffic on unusual ports, which may indicate persistence mechanisms or backdoor access established by threat actors.",Cisco FTD,"Lateral Movement, Execution, Persistence",T1021.004,"`cisco_secure_firewall` 
EventType=IntrusionEvent 
signature_id=65369
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(src) as src 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___ssh_connection_to_non_standard_port_filter`"
Cisco Secure Firewall - SSH Connection to sshd_operns,"This analytic detects inbound SSH connections to the sshd_operns service on network devices using Cisco Secure Firewall Intrusion Events. APT actors have been observed enabling sshd_operns and opening it on non-standard ports to maintain encrypted remote access to compromised network infrastructure. This detection leverages Snort signature 65368 to identify connections to this service, which when combined with other indicators may signal persistent access mechanisms established by threat actors.",Cisco FTD,Lateral Movement,T1021.004,"`cisco_secure_firewall` 
EventType=IntrusionEvent 
signature_id=65368
| fillnull
| stats dc(signature_id) as unique_signature_count 
values(signature_id) as signature_id 
values(signature) as signature 
values(class_desc) as class_desc 
values(MitreAttackGroups) as MitreAttackGroups 
values(InlineResult) as InlineResult 
values(InlineResultReason) as InlineResultReason 
values(src) as src 
values(dest_port) as dest_port 
values(rule) as rule 
values(transport) as transport 
values(app) as app 
min(_time) as firstTime 
max(_time) as lastTime 
by dest
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_secure_firewall___ssh_connection_to_sshd_operns_filter`"
Cisco Isovalent - Cron Job Creation,"The following analytic detects the creation of a cron job within the Cisco Isovalent environment. It identifies this activity by monitoring process execution logs for cron job creation events. This behavior is significant for a SOC as it could allow an attacker to execute malicious tasks repeatedly and automatically, posing a threat to the Kubernetes infrastructure.",Cisco Isovalent,"Execution, Persistence","T1053.007, T1053, T1053.003","`cisco_isovalent_process_exec` process_name IN (""crond"",""cron"",""crontab"")
| search pod_name!=""""
| stats count 
min(_time) as firstTime 
max(_time) as lastTime 
values(process) as process
by cluster_name pod_name parent_process_name process_name process_exec process_id node_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___cron_job_creation_filter`"
Cisco Isovalent - Curl Execution With Insecure Flags,"The following analytic detects the execution of curl commands with insecure flags within the Cisco Isovalent environment. It identifies this activity by monitoring process execution logs for curl commands that use the -k or --insecure flags. This behavior is significant for a SOC as it could allow an attacker to bypass SSL/TLS verification, potentially exposing the Kubernetes infrastructure to man-in-the-middle attacks.",Cisco Isovalent,"Command And Control, Execution",T1105,"`cisco_isovalent_process_exec`  process_name=""curl""  
| regex process=""(?i)(?<!\w)-(?:[a-z]*k[a-z]*
|-(insecure
|proxy-insecure
|doh-insecure))""
| stats count min(_time) as firstTime max(_time) as lastTime values(process) as process
by cluster_name pod_name parent_process_name process_name process_exec process_id node_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___curl_execution_with_insecure_flags_filter`"
Cisco Isovalent - Late Process Execution,"Detects process executions that occur well after a container has initialized, which can indicate suspicious activity (e.g., interactive shells, injected binaries, or post-compromise tooling). The analytic compares the process start time to the container start time and flags processes launched more than 5 minutes (300 seconds) after initialization.
Search 1`cisco_isovalent_process_exec` process_name=&#34;sh&#34; 2 3| rename process_exec.",Cisco Isovalent,"Execution, Persistence",T1543,"`cisco_isovalent_process_exec` process_name=""sh""
| rename process_exec.process.start_time as ProcessStartTime 
| rename process_exec.process.pod.container.start_time as ContainerStartTime 
| eval ProcessStartTime=strptime(ProcessStartTime, ""%Y-%m-%dT%H:%M:%S.%3Q"")
| eval ContainerStartTime=strptime(ContainerStartTime, ""%Y-%m-%dT%H:%M:%S.%9Q"")
| eval ContainerTime5min=relative_time(ContainerStartTime, ""+5m"")
| where ProcessStartTime > ContainerTime5min
| table node_name cluster_name, pod_name, container_id, process_name, process_exec, process, ProcessStartTime, ContainerTime5min 
| `security_content_ctime(ProcessStartTime)`
| `security_content_ctime(ContainerTime5min)`
| `cisco_isovalent___late_process_execution_filter`"
Cisco Isovalent - Non Allowlisted Image Use,"The following analytic detects use of container images that fall outside an approved allowlist, leveraging Cisco Isovalent/Tetragon runtime telemetry (image name and workload identity). Adversaries commonly introduce untrusted or newly published images to deploy tooling, establish persistence, or abuse supplyâ€‘chain trust. This behavior may indicate image pulls from unauthorized registries, execution of unvetted software, or a drift from established deployment baselines.",Cisco Isovalent,"Execution, Persistence",T1204.003,"`cisco_isovalent_process_exec` pod_name!=""""
| search NOT `cisco_isovalent_allowed_images`
| stats count 
min(_time) as firstTime 
max(_time) as lastTime 
by pod_image_name pod_namespace pod_name process_name cluster_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___non_allowlisted_image_use_filter`"
Cisco Isovalent - Nsenter Usage in Kubernetes Pod,"This analytic detects the execution of the nsenter utility from within a container, a technique often used for exploitation and container escape. Nsenter allows an attacker to enter the namespaces of another processâ€”such as the host's init process (PID 1)â€”and execute a shell or other binaries with elevated privileges. For example, an attacker may use docker exec to gain a shell in a container, enumerate the PID of a target container or the host, and then use nsenter to access all namespaces (mount, UTS, IPC, net, pid) of the host or another container.",Kubernetes,"Execution, Persistence, Privilege Escalation",T1543,"`cisco_isovalent_process_exec` process_name=""nsenter"" 
| eval WorkloadAncestorsBinary=mvjoin(parent_process_name, "" <- "")
| stats count 
min(_time) as firstTime 
max(_time) as lastTime 
values(process) as process
values(WorkloadAncestorsBinary) as WorkloadAncestorsBinary
by cluster_name container_id pod_name pod_namespace pod_image_name parent_process_name process_name process_exec process_id node_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___nsenter_usage_in_kubernetes_pod_filter`"
Cisco Isovalent - Pods Running Offensive Tools,"The following analytic detects execution of known offensive tooling from within Kubernetes pods, including network scanners and post-exploitation frameworks (e.g., nmap, masscan, zmap, impacket-*, hashcat, john, SharpHound, kube-hunter, peirates). We have created a macro named linux_offsec_tool_processes that contains the list of known offensive tooling found on linux systems. Adversaries commonly introduce these tools into compromised workloads to conduct discovery, lateral movement, credential access, or cluster reconnaissance.",Linux,"Execution, Credential Access, Lateral Movement, Persistence, Privilege Escalation, Discovery",T1204.003,"`cisco_isovalent_process_exec`  `linux_offsec_tool_processes`
| stats count 
min(_time) as firstTime 
max(_time) as lastTime 
values(process) as process
by cluster_name container_id pod_name pod_namespace pod_image_name parent_process_name process_name process_exec process_id node_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_isovalent___pods_running_offensive_tools_filter`"
Cisco Isovalent - Shell Execution,"The following analytic detects the execution of a shell inside a container namespace within the Cisco Isovalent environment. It identifies this activity by monitoring process execution logs for the execution of a shell (sh or bash) inside a container namespace. This behavior is significant for a SOC as it could allow an attacker to gain shell access to the container, potentially leading to further compromise of the Kubernetes cluster.",Cisco Isovalent,"Lateral Movement, Execution, Persistence, Privilege Escalation",T1543,"`cisco_isovalent_process_exec` process_name IN (""sh"", ""ksh"", ""zsh"", ""bash"", ""dash"", ""rbash"", ""fish"", ""csh"", ""tcsh"", ""ion"", ""eshell"")
| stats count by cluster_name parent_process_name process_name process_exec process_id node_name 
| `cisco_isovalent___shell_execution_filter`"
DLLHost with no Command Line Arguments with Network,"The following analytic detects instances of DLLHost.exe running without command line arguments while establishing a network connection. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process execution and network activity data. It is significant because DLLHost.exe typically runs with specific arguments, and its absence can indicate malicious activity, such as Cobalt Strike usage.",Windows Events,"Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Processes where
(
Processes.process_name=dllhost.exe
OR
Processes.original_file_name=dllhost.exe
)
Processes.process IN (
""*dllhost"",
""*dllhost.exe"",
""*dllhost.exe\""""
)
by host _time span=1h
Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as src
| join host process_id
[
| tstats `security_content_summariesonly`
count
latest(All_Traffic.dest) as dest
latest(All_Traffic.dest_ip) as dest_ip
latest(All_Traffic.dest_port) as dest_port
FROM datamodel=Network_Traffic.All_Traffic where
All_Traffic.dest_port != 0
by host All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in
All_Traffic.bytes_out All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port
All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src
All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user
All_Traffic.vendor_product All_Traffic.direction All_Traffic.process_id
| `drop_dm_object_name(All_Traffic)`
]
| `dllhost_with_no_command_line_arguments_with_network_filter`"
Rundll32 with no Command Line Arguments with Network,"The following analytic detects the execution of rundll32.exe without command line arguments, followed by a network connection. This behavior is identified using Endpoint Detection and Response (EDR) telemetry and network traffic data. It is significant because rundll32.exe typically requires arguments to function, and its absence is often associated with malicious activity, such as Cobalt Strike.",Windows Events,"Execution, Exfiltration, Persistence, Defense Evasion","T1218, T1218.011","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Processes where
`process_rundll32`
Processes.process IN (
""*rundll32"",
""*rundll32.exe"",
""*rundll32.exe\""""
)
by host _time span=1h Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as src
| join host process_id
[
| tstats `security_content_summariesonly` count
FROM datamodel=Network_Traffic.All_Traffic where
All_Traffic.dest_port != 0
by host All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out
All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port
All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction
All_Traffic.process_id
| `drop_dm_object_name(All_Traffic)`
]
| `rundll32_with_no_command_line_arguments_with_network_filter`"
SearchProtocolHost with no Command Line with Network,"The following analytic detects instances of searchprotocolhost.exe running without command line arguments but with an active network connection. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process execution and network traffic data. It is significant because searchprotocolhost.exe typically runs with specific command line arguments, and deviations from this norm can indicate malicious activity, such as Cobalt Strike usage.",Windows Events,"Command And Control, Execution, Exfiltration, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where
(
Processes.process_name=searchprotocolhost.exe
OR
Processes.original_file_name=searchprotocolhost.exe
)
Processes.process IN (
""*searchprotocolhost"",
""*searchprotocolhost.exe"",
""*searchprotocolhost.exe\""""
)
by _time span=1h Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| join  process_id
[
| tstats `security_content_summariesonly` count
FROM datamodel=Network_Traffic.All_Traffic where
All_Traffic.dest_port != 0
by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out
All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port
All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction
All_Traffic.process_id
| `drop_dm_object_name(All_Traffic)`
| rename dest as C2
]
| table _time dest parent_process_name process_name process_path process process_id dest_port C2
| `searchprotocolhost_with_no_command_line_with_network_filter`"
System Processes Run From Unexpected Locations,"The following analytic identifies system processes running from unexpected locations outside of paths such as C:\Windows\System32\ or C:\Windows\SysWOW64. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process paths, names, and hashes. This activity is significant as it may indicate a malicious process attempting to masquerade as a legitimate system process.",Windows Events,"Execution, Persistence, Defense Evasion","T1036.003, T1036","| tstats `security_content_summariesonly` 
count min(_time) as firstTime max(_time) as lastTime 
FROM datamodel=Endpoint.Processes where 
NOT Processes.process_path IN (
""*:\\$WINDOWS.~BT\\*"",
""*:\\$WinREAgent\\*"",
""*:\\Program Files \(x86\)\\Windows Kits\\10\\App Certification Kit\\*"",
""*:\\Windows\\SoftwareDistribution\\*"",
""*:\\Windows\\System32\\*"",
""*:\\Windows\\SystemTemp\\*"",
""*:\\Windows\\SysWOW64\\*"",
""*:\\Windows\\uus\\*"",
""*:\\Windows\\WinSxS\\*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(""Processes"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup update=true is_windows_system_file filename as process_name OUTPUT systemFile
| search systemFile=true
| `system_processes_run_from_unexpected_locations_filter`"
Single Letter Process On Endpoint,"The following analytic detects processes with names consisting of a single letter, which is often indicative of malware or an attacker attempting to evade detection. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because attackers use such techniques to obscure their presence and carry out malicious activities like data theft or ransomware attacks.",Windows Events,"Execution, Exfiltration",T1204.002,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.process_name IN (
""_.exe"",
""-.exe"",
"",.exe"",
"";.exe"",
""!.exe"",
""'.exe""
""(.exe"",
""(.exe"",
"").exe"",
"").exe"",
""@.exe"",
""&.exe"",
""#.exe"",
""%.exe"",
""`.exe"",
""^.exe"",
""+.exe"",
""=.exe"",
""~.exe"",
""$.exe"",
""0.exe"",
""1.exe"",
""2.exe"",
""3.exe"",
""4.exe"",
""5.exe"",
""6.exe"",
""7.exe"",
""8.exe"",
""9.exe"",
""a.exe"",
""b.exe"",
""c.exe"",
""d.exe"",
""e.exe"",
""f.exe"",
""g.exe"",
""h.exe"",
""i.exe"",
""j.exe"",
""k.exe"",
""l.exe"",
""m.exe"",
""N.exe"",
""o.exe"",
""p.exe"",
""q.exe"",
""r.exe"",
""s.exe"",
""t.exe"",
""u.exe"",
""v.exe"",
""w.exe"",
""x.exe"",
""y.exe"",
""z.exe"",
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(lastTime)`
| `security_content_ctime(firstTime)`
| `single_letter_process_on_endpoint_filter`"
Windows Service Create Kernel Mode Driver,"The following analytic identifies the creation of a new kernel mode driver using the sc.exe command. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. The activity is significant because adding a kernel driver is uncommon in regular operations and can indicate an attempt to gain low-level access to the system.",Windows Events,"Execution, Persistence, Privilege Escalation","T1068, T1543.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes 
where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe)  Processes.process IN (""*kernel*"", ""*filesys*"") Processes.process=""*type*""
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_create_kernel_mode_driver_filter`"
Windows Suspicious Driver Loaded Path,"The following analytic detects the loading of drivers from suspicious paths, which is a technique often used by malicious software such as coin miners (e.g., xmrig). It leverages Sysmon EventCode 6 to identify drivers loaded from non-standard directories. This activity is significant because legitimate drivers typically reside in specific system directories, and deviations may indicate malicious activity.",Windows Events,"Discovery, Persistence, Privilege Escalation",T1543.003,"`sysmon` EventCode=6 ImageLoaded IN(""*\\windows\\fonts\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"", ""*\\Users\\Administrator\\Music\\*"", ""*Recycle.bin*"", ""*\\Windows\\Media\\*"",""\\Windows\\repair\\*"", ""*\\PerfLogs\\*"", ""*:\\Windows\\Prefetch\\*"", ""*:\\Windows\\Cursors\\*"", ""*\\temp\\*"", ""*\\download*"", ""*\\appdata\\*"") 
|  stats  min(_time) as firstTime max(_time) as lastTime count by ImageLoaded dest dvc process_hash process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_suspicious_driver_loaded_path_filter`"
Domain Controller Discovery with Nltest,"The following analytic detects the execution of nltest.exe with command-line arguments /dclist: or /dsgetdc: to discover domain controllers. It leverages Endpoint Detection and Response (EDR) data, focusing on process names and command-line arguments. This activity is significant because both Red Teams and adversaries use nltest.exe for situational awareness and Active Directory discovery. If confirmed malicious, this behavior could allow attackers to map out domain controllers, facilitating further attacks such as privilege escalation or lateral movement within the network.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=nltest.exe OR Processes.original_file_name=nltestrk.exe) (Processes.process=""*/dclist:*"" OR Processes.process=""*/dsgetdc:*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_controller_discovery_with_nltest_filter`"
Suspicious Copy on System32,"The following analytic detects potentially suspicious file copy operations targeting the System32 or SysWow64 directories as source, often indicative of malicious activity. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on activity initiated by command-line tools like cmd.exe or PowerShell. This behavior is significant as it may indicate an attempt to evade defenses by copying an existing binary from the system directory and renaming it.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1036.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
Processes.parent_process_name IN (
""cmd.exe"", 
""powershell.exe"", 
""pwsh.exe"", 
""sqlps.exe"", 
""sqltoolsps.exe""
)
(
Processes.process_name IN (""copy.exe"", ""xcopy.exe"")
OR
Processes.original_file_name IN (""copy.exe"", ""xcopy.exe"")
)
Processes.process IN (
""* \""C:\\Windows\\System32\\*"", 
""* \'C:\\Windows\\System32\\*"", 
""* C:\\Windows\\System32\\*"", 
""* \""C:\\Windows\\SysWow64\\*"",
""* \'C:\\Windows\\SysWow64\\*"",
""* C:\\Windows\\SysWow64\\*""
)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_copy_on_system32_filter`"
Windows Curl Download to Suspicious Path,"The following analytic detects the use of Windows Curl.exe to download a file to a suspicious location, such as AppData, ProgramData, or Public directories. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include the -O or --output options. This activity is significant because downloading files to these locations can indicate an attempt to bypass security controls or establish persistence.",Windows Events,"Command And Control, Execution, Persistence, Exfiltration",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(
Processes.process_name=curl.exe
OR
Processes.original_file_name=Curl.exe
)
Processes.process IN (""*-O *"",""*--output*"", ""*--output-dir*"")
Processes.process IN (
""*:\\PerfLogs\\*"",
""*:\\Windows\\Temp\\*"",
""*\\AppData\\*"",
""*\\ProgramData\\*"",
""*\\Users\\Public\\*"",
""*%AppData%*"",
""*%Public%*"",
""*%Temp%*"",
""*%tmp%*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_curl_download_to_suspicious_path_filter`"
Windows Curl Upload to Remote Destination,"The following analytic detects the use of Windows Curl.exe to upload a file to a remote destination. It identifies command-line arguments such as -T, --upload-file, -d, --data, and -F in process execution logs. This activity is significant because adversaries may use Curl to exfiltrate data or upload malicious payloads. If confirmed malicious, this could lead to data breaches or further compromise of the system.",Windows Events,"Collection, Execution, Command And Control",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=curl.exe OR Processes.original_file_name=Curl.exe)
Processes.process IN (
""*-T *"",
""*--upload-file *"",
""*-d *"",
""*--data *"",
""*-F *""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id
Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_curl_upload_to_remote_destination_filter`"
Windows File Collection Via Copy Utilities,"The following analytic detects the use of Windows command-line copy utilities, such as xcopy, to systematically collect files from user directories and consolidate them into a centralized location on the system. This activity is often indicative of malicious behavior, as threat actors frequently use such commands to gather sensitive information, including documents with .",Windows Events,"Lateral Movement, Execution, Collection, Exfiltration",T1119,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes where
(
Processes.process_name IN (""copy.exe"", ""xcopy.exe"")
OR
Processes.original_file_name IN (""copy.exe"", ""xcopy.exe"")
)
Processes.process IN (
""*.7z*"",
""*.bmp*"",
""*.db*"",
""*.doc*"",
""*.gif*"",
""*.gz*"",
""*.jpg*"",
""*.log*"",
""*.pdf*"",
""*.png*"",
""*.ppt*"",
""*.rar*"",
""*.rtf*"",
""*.tar*"",
""*.txt*"",
""*.xls*"",
""*.zip*""
)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_file_collection_via_copy_utilities_filter`"
Windows LOLBAS Executed Outside Expected Path,The following analytic identifies a LOLBAS process being executed outside of it's expected location. Processes being executed outside of expected locations may be an indicator that an adversary is attempting to evade defenses or execute malicious code. The LOLBAS project documents Windows native binaries that can be abused by threat actors to perform tasks like executing malicious code.,Windows Events,"Collection, Defense Evasion","T1218.011, T1036, T1036.005","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
FROM datamodel=Endpoint.Processes where
NOT Processes.process_path IN (
""*\\PROGRA~*"",
""*\\Program Files \(x86\)\\"",
""*\\Program Files\\"",
""*:\\Windows\\System32\\*"",
""*:\\Windows\\SysWOW64\\*"",
""*:\\Windows\\WinSxS\\*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
|`drop_dm_object_name(Processes)`
| lookup lolbas_file_path lolbas_file_name as process_name OUTPUT description as desc
| lookup lolbas_file_path lolbas_file_name as process_name lolbas_file_path as process_path OUTPUT description as is_lolbas_path
| search desc!=""false"" AND is_lolbas_path=""false""
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_lolbas_executed_outside_expected_path_filter`"
Windows Scheduled Task Created Via XML,"The following analytic detects the creation of scheduled tasks in Windows using schtasks.exe with the &quot;XML&quot; parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it is a common technique for establishing persistence or achieving privilege escalation, often used by malware like Trickbot and Winter-Vivern.",Windows Events,"Execution, Persistence, Privilege Escalation",T1053.005,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where 
(Processes.process_name=schtasks.exe OR Processes.original_file_name=schtasks.exe)
Processes.process IN (""* /create *"", ""* -create *"")
Processes.process IN (""* /xml *"", ""* -xml *"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_scheduled_task_created_via_xml_filter`"
Windows Schtasks Create Run As System,"The following analytic detects the creation of a new scheduled task using Schtasks.exe to run as the SYSTEM user. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it often indicates an attempt to gain elevated privileges or maintain persistence within the environment.",Windows Events,"Execution, Persistence",T1053.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=schtasks.exe OR Processes.original_file_name=schtasks.exe) Processes.process=""*/create *"" Processes.process=""*/ru *"" Processes.process=""*system*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_schtasks_create_run_as_system_filter`"
Windows WBAdmin File Recovery From Backup,"The following analytic identifies the execution of wbadmin.exe with arguments indicative of restoring files from an existing backup. WBAdmin is a legitimate Windows Backup utility used for creating, managing, and restoring backups. However, adversaries may abuse it to restore specific files (e.g., sensitive credentials, configuration files, or malware stagers) from prior backups to regain access or re-establish persistence after cleanup or encryption events.",Windows Events,"Execution, Impact, Persistence","T1565.001, T1490","| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
(Processes.process_name=wbadmin.exe OR Processes.original_file_name=WBADMIN.EXE)
Processes.process = ""*start*""
Processes.process = ""*recovery*""
Processes.process = ""*itemtype:file*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id 
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id 
Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_wbadmin_file_recovery_from_backup_filter`"
HTTP RMM User Agent,"This Splunk query analyzes web logs to identify and categorize user agents, detecting various types of Remote Monitoring and Mangement applications. This activity can signify possible compromised hosts on the network.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.",Zscaler Proxy,"Command And Control, Discovery","T1219, T1071.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| lookup rmm_user_agents rmm_user_agent AS http_user_agent OUTPUT tool 
| where isnotnull(tool) 
| stats count min(firstTime) as first_seen max(lastTime) as last_seen by tool url http_user_agent src dest 
| `security_content_ctime(first_seen)` 
| `security_content_ctime(last_seen)`
| `http_rmm_user_agent_filter`"
Potential System Network Configuration Discovery Activity,"The following analytic identifies the rapid execution of processes used for system network configuration discovery on an endpoint. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process GUIDs, names, parent processes, and command-line executions. This activity can be significant as it may indicate an attacker attempting to map the network, which is a common precursor to lateral movement or further exploitation.",Windows Events,"Lateral Movement, Execution, Discovery, Exfiltration",T1016,"| tstats `security_content_summariesonly` 
count values(Processes.process) as process
values(Processes.parent_process) as parent_process
min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
NOT Processes.user IN ("""",""unknown"")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product _time
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `drop_dm_object_name(Processes)`
| search process_name IN (
""arp.exe"",
""dsquery.exe"",
""hostname.exe"",
""ipconfig.exe"",
""nbstat.exe"",
""net.exe"",
""net1.exe"",
""nltest.exe"",
""netsh.exe"",
""nslookup.exe"",
""ping.exe"",
""quser.exe"",
""qwinsta.exe"",
""telnet.exe"",
""tracert.exe"",
)
| transaction dest connected=false maxpause=5m
| where eventcount>=5
| `potential_system_network_configuration_discovery_activity_filter`"
Windows AI Platform DNS Query,"The following analytic detects DNS queries initiated by the Windows AI Platform to domains associated with Hugging Face, OpenAI, and other popular providers of machine learning models and services. Monitoring these DNS requests is important because it can reveal when systems are accessing external AI platforms, which may indicate the use of third-party AI resources or the transfer of sensitive data outside the organizationâ€™s environment.",Windows Events,"Command And Control, Execution, Discovery, Exfiltration",T1071.004,"`sysmon` EventCode=22 QueryName IN (""router.huggingface.co"", ""api.openai.com"")
| lookup update=true browser_app_list browser_process_name AS process_name OUTPUT isAllowed 
| search isAllowed!=true
| rename dvc as dest
| stats count min(_time) as firstTime max(_time) as lastTime 
by answer answer_count dest process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id Image
vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_ai_platform_dns_query_filter`"
Windows Boot or Logon Autostart Execution In Startup Folder,"The following analytic detects the creation of files in the Windows %startup% folder, a common persistence technique. It leverages the Endpoint.Filesystem data model to identify file creation events in this specific directory. This activity is significant because adversaries often use the startup folder to ensure their malicious code executes automatically upon system boot or user logon.",Windows Events,"Execution, Persistence","T1204, T1547.001","|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_path = ""*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_boot_or_logon_autostart_execution_in_startup_folder_filter`"
HTTP PUA User Agent,"This Splunk query analyzes web logs to identify and categorize user agents, detecting various types of unwanted applications. This activity can signify possible compromised hosts on the network.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 3| `drop_dm_object_name(&#34;Web&#34;)` 4| lookup pua_user_agents pua_user_agent AS http_user_agent OUTPUT tool 5| where isnotnull(tool) 6| stats count min(firstTime) as first_seen max(lastTime) as last_seen by tool url http_user_agent src dest 7| `security_content_ctime(first_seen)` 8| `security_content_ctime(last_seen)` 9| `http_pua_user_agent_filter` Data Source Name Platform Sourcetype Source Suricata Other 'suricata' 'suricata' Macros Used Name Value security_content_ctime convert timeformat=&quot;%Y-%m-%dT%H:%M:%S&quot; ctime($field$) http_pua_user_agent_filter search * http_pua_user_agent_filter is an empty macro by default.",Zscaler Proxy,"Command And Control, Discovery, Privilege Escalation",T1071.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| lookup pua_user_agents pua_user_agent AS http_user_agent OUTPUT tool 
| where isnotnull(tool) 
| stats count min(firstTime) as first_seen max(lastTime) as last_seen by tool url http_user_agent src dest 
| `security_content_ctime(first_seen)` 
| `security_content_ctime(last_seen)` 
| `http_pua_user_agent_filter`"
CMD Carry Out String Command Parameter,"The following analytic detects the use of cmd.exe /c to execute commands, a technique often employed by adversaries and malware to run batch commands or invoke other shells like PowerShell. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process metadata. Monitoring this activity is crucial as it can indicate script-based attacks or unauthorized command execution.",Windows Events,"Execution, Persistence, Privilege Escalation",T1059.003,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_cmd` AND Processes.process IN (""*/c*"", ""*/k*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cmd_carry_out_string_command_parameter_filter`"
Non Chrome Process Accessing Chrome Default Dir,"The following analytic detects a non-Chrome process accessing files in the Chrome user default folder. It leverages Windows Security Event logs, specifically event code 4663, to identify unauthorized access attempts. This activity is significant because the Chrome default folder contains sensitive user data such as login credentials, browsing history, and cookies. If confirmed malicious, this behavior could indicate an attempt to exfiltrate sensitive information, often associated with RATs, trojans, and advanced persistent threats like FIN7.",Windows Events,Credential Access,T1555.003,"`wineventlog_security` EventCode=4663 NOT (ProcessName IN (""*\\chrome.exe"", ""*\\explorer.exe"", ""*sql*"", ""*\\dllhost.exe"")) ObjectName=""*\\Google\\Chrome\\User Data\\Default*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by ObjectName ObjectType ProcessName AccessMask EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `non_chrome_process_accessing_chrome_default_dir_filter`"
Non Firefox Process Access Firefox Profile Dir,"The following analytic detects non-Firefox processes accessing the Firefox profile directory, which contains sensitive user data such as login credentials, browsing history, and cookies. It leverages Windows Security Event logs, specifically event code 4663, to monitor access attempts. This activity is significant because it may indicate attempts by malware, such as RATs or trojans, to harvest user information.",Windows Events,"Credential Access, Exfiltration",T1555.003,"`wineventlog_security` EventCode=4663 NOT (ProcessName IN (""*\\firefox.exe"", ""*\\explorer.exe"", ""*sql*"")) ObjectName=""*\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by ObjectName ObjectType ProcessName AccessMask EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `non_firefox_process_access_firefox_profile_dir_filter`"
Windows Chromium Browser with Custom User Data Directory,"The following analytic detects instances where the Chromium-based browser (e.g., Google Chrome, Microsoft Edge) is launched with the --user-data-dir command-line argument. While this flag is legitimate and used for multi-profile support or automation, it is frequently leveraged by malware and adversaries to run Chrome in an isolated environment for stealth operations, credential harvesting, phishing delivery, or evasion of user session artifacts.",Windows Events,"Credential Access, Defense Evasion",T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--user-data-dir*"" 
Processes.process IN (""*--disable-gpu*"", ""*--disable-3d-apis*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_chromium_browser_with_custom_user_data_directory_filter`"
Windows Credential Access From Browser Password Store,"The following analytic identifies a possible non-common browser process accessing its browser user data profile. This tactic/technique has been observed in various Trojan Stealers, such as SnakeKeylogger, which attempt to gather sensitive browser information and credentials as part of their exfiltration strategy. Detecting this anomaly can serve as a valuable pivot for identifying processes that access lists of browser user data profiles unexpectedly.",Windows Events,"Credential Access, Discovery, Exfiltration",T1012,"`wineventlog_security` EventCode=4663 
| stats count by _time object_file_path object_file_name dest process_name process_path process_id EventCode 
| lookup browser_app_list browser_object_path as object_file_path OUTPUT browser_process_name isAllowed 
| stats count min(_time) as firstTime max(_time) as lastTime values(object_file_name) values(object_file_path)  values(browser_process_name) as browser_process_name by dest process_name process_path process_id EventCode isAllowed 
| rex field=process_name ""(?<extracted_process_name>[^\\\\]+)$"" 
| eval isMalicious=if(match(browser_process_name, extracted_process_name), ""0"", ""1"") 
| where isMalicious=1 and isAllowed=""false"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credential_access_from_browser_password_store_filter`"
Windows Credentials from Password Stores Chrome Extension Access,"The following analytic detects non-Chrome processes attempting to access the Chrome extensions file. It leverages Windows Security Event logs, specifically event code 4663, to identify this behavior. This activity is significant because adversaries may exploit this file to extract sensitive information from the Chrome browser, posing a security risk. If confirmed malicious, this could lead to unauthorized access to stored credentials and other sensitive data, potentially compromising the security of the affected system and broader network.",Windows Events,"Credential Access, Discovery",T1012,"`wineventlog_security` EventCode=4663 object_file_path=""*\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Local Extension Settings\\*"" AND NOT (process_path IN (""*:\\Windows\\explorer.exe"", ""*\\chrome.exe"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_chrome_extension_access_filter`"
Windows Credentials from Password Stores Chrome LocalState Access,"The following analytic detects non-Chrome processes accessing the Chrome &quot;Local State&quot; file, which contains critical settings and information. It leverages Windows Security Event logs, specifically event code 4663, to identify this behavior. This activity is significant because threat actors can exploit this file to extract the encrypted master key used for decrypting saved passwords in Chrome.",Windows Events,Discovery,T1012,"`wineventlog_security` EventCode=4663 object_file_path=""*\\AppData\\Local\\Google\\Chrome\\User Data\\Local State"" NOT (process_name IN (""*\\chrome.exe"",""*:\\Windows\\explorer.exe"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_chrome_localstate_access_filter`"
Windows Credentials from Password Stores Chrome Login Data Access,"The following analytic identifies non-Chrome processes accessing the Chrome user data file &quot;login data.&quot; This file is an SQLite database containing sensitive information, including saved passwords. The detection leverages Windows Security Event logs, specifically event code 4663, to monitor access attempts. This activity is significant as it may indicate attempts by threat actors to extract and decrypt stored passwords, posing a risk to user credentials.",Windows Events,Discovery,T1012,"`wineventlog_security` EventCode=4663 object_file_path=""*\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data"" AND NOT (process_path IN (""*:\\Windows\\explorer.exe"", ""*:\\Windows\\System32\\dllhost.exe"", ""*\\chrome.exe"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_chrome_login_data_access_filter`"
Windows File Download Via PowerShell,"The following analytic detects the use of PowerShell's download methods such as &quot;DownloadString&quot; and &quot;DownloadData&quot; from the WebClient class or Invoke-WebRequest and it's aliases &quot;IWR&quot; or &quot;Curl&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity can be significant such methods and functions are commonly used in malicious PowerShell scripts to fetch and execute remote code.",Windows Events,"Command And Control, Execution, Exfiltration","T1059.001, T1105","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` Processes.process IN ( ""*iwr *"", ""*Invoke-WebRequest*"", ""*wget *"", ""curl"", ""*.DownloadData*"", ""*.DownloadFile*"", ""*.DownloadString*"" ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_download_via_powershell_filter`"
Windows MSIExec Remote Download,"The following analytic detects the use of msiexec.exe with an HTTP or HTTPS URL in the command line, indicating a remote file download attempt. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant as it may indicate an attempt to download and execute potentially malicious software from a remote server.",Windows Events,"Execution, Exfiltration, Discovery, Defense Evasion",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
`process_msiexec`
Processes.process IN (""*http://*"", ""*https://*"")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_msiexec_remote_download_filter`"
Windows MSIExec Spawn Discovery Command,"The following analytic detects MSIExec spawning multiple discovery commands, such as Cmd.exe or PowerShell.exe. This behavior is identified using data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where MSIExec is the parent process. This activity is significant because MSIExec typically does not spawn child processes other than itself, making this behavior highly suspicious.",Windows Events,"Execution, Lateral Movement, Defense Evasion, Discovery, Exfiltration",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=msiexec.exe Processes.process_name IN (""powershell.exe"", ""pwsh.exe"",""cmd.exe"", ""nltest.exe"",""ipconfig.exe"",""systeminfo.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msiexec_spawn_discovery_command_filter`"
Windows Query Registry UnInstall Program List,"The following analytic detects an access request on the uninstall registry key. It leverages Windows Security Event logs, specifically event code 4663. This activity is significant because adversaries or malware can exploit this key to gather information about installed applications, aiding in further attacks. If confirmed malicious, this behavior could allow attackers to map out installed software, potentially identifying vulnerabilities or software to exploit, leading to further system compromise.",Windows Events,Discovery,T1012,"`wineventlog_security` EventCode=4663 object_file_path=""*\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_query_registry_uninstall_program_list_filter`"
Windows Unsecured Outlook Credentials Access In Registry,"The following analytic detects unauthorized access to Outlook credentials stored in the Windows registry. It leverages Windows Security Event logs, specifically EventCode 4663, to identify access attempts to registry paths associated with Outlook profiles. This activity is significant as it may indicate attempts to steal sensitive email credentials, which could lead to unauthorized access to email accounts.",Windows Events,Credential Access,T1552,"`wineventlog_security` EventCode=4663 object_file_path IN (""*\\Profiles\\Outlook\\9375CFF0413111d3B88A00104B2A6676*"", ""*\\Windows Messaging Subsystem\\Profiles\\9375CFF0413111d3B88A00104B2A6676*"") AND process_name != *\\outlook.exe 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unsecured_outlook_credentials_access_in_registry_filter`"
Windows Unusual Process Load Mozilla NSS-Mozglue Module,"The following analytic identifies processes loading Mozilla NSS-Mozglue libraries such as mozglue.dll and nss3.dll. It leverages Sysmon Event logs, specifically monitoring EventCode 7, which tracks image loaded events. This activity is significant because it can indicate unauthorized access or manipulation of these libraries, which are commonly used by Mozilla applications like Firefox and Thunderbird.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218.003,"`sysmon` EventCode=7  ImageLoaded IN (""*\\mozglue.dll"", ""*\\nss3.dll"") NOT(process_path IN(""*:\\Program Files\Mozilla Firefox\\firefox.exe"", ""*:\\Program Files (x86)\Mozilla Firefox\\firefox.exe"", ""*:\\Program Files\\Mozilla Thunderbird\\thunderbird.exe"", ""*:\\Program Files (x86)\\Mozilla Thunderbird\\thunderbird.exe"", ""*\\Tor Browser\\Browser\\firefox.exe"",""*:\\Program Files\\Code42\\CrashPlan\\Code42Service.exe"", ""*:\\Program Files (x86)\\Code42\\CrashPlan\\Code42Service.exe"", ""*:\\Program Files\\Pale Moon\\palemoon.exe"", ""*:\\Program Files (x86)\\Pale Moon\\palemoon.exe"", ""*:\\Program Files\\Waterfox\\waterfox.exe"",""*:\\Program Files (x86)\\Waterfox\\waterfox.exe"", ""*:\\Program Files\\Cyberfox\cyberfox.exe"", ""*:\\Program Files (x86)\\Cyberfox\\cyberfox.exe"", ""*\\AppData\\Local\\slack\\slack.exe"", ""*:\\Program Files (x86)\\VMware\\VMware Horizon View Client\\vmware-view.exe"", ""*:\\Program Files (x86)\\Dropbox\\Client\\Dropbox.exe"", ""*:\\Program Files\\Google\\Google Earth Pro\\client\\googleearth.exe"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unusual_process_load_mozilla_nss_mozglue_module_filter`"
HTTP Malware User Agent,"This Splunk query analyzes web logs to identify and categorize user agents, detecting various types of malware. This activity can signify possible compromised hosts on the network.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 3| `drop_dm_object_name(&#34;Web&#34;)` 4| lookup malware_user_agents malware_user_agent AS http_user_agent OUTPUT malware 5| where isnotnull(malware) 6| stats count min(firstTime) as first_seen max(lastTime) as last_seen by malware url http_user_agent src dest 7| `security_content_ctime(first_seen)` 8| `security_content_ctime(last_seen)` 9| `http_malware_user_agent_filter` Data Source Name Platform Sourcetype Source Suricata Other 'suricata' 'suricata' Macros Used Name Value security_content_ctime convert timeformat=&quot;%Y-%m-%dT%H:%M:%S&quot; ctime($field$) http_malware_user_agent_filter search * http_malware_user_agent_filter is an empty macro by default.",Zscaler Proxy,Command And Control,T1071.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| lookup malware_user_agents malware_user_agent AS http_user_agent OUTPUT malware 
| where isnotnull(malware) 
| stats count min(firstTime) as first_seen max(lastTime) as last_seen by malware url http_user_agent src dest 
| `security_content_ctime(first_seen)` 
| `security_content_ctime(last_seen)` 
| `http_malware_user_agent_filter`"
CSC Net On The Fly Compilation,"The following analytic detects the use of the .NET compiler csc.exe for on-the-fly compilation of potentially malicious .NET code. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns associated with csc.exe. This activity is significant because adversaries and malware often use this technique to evade detection by compiling malicious code at runtime.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1027.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=csc.exe OR Processes.original_file_name=csc.exe) Processes.process = ""*/noconfig*"" Processes.process = ""*/fullpaths*"" Processes.process = ""*@*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `csc_net_on_the_fly_compilation_filter`"
Detect Prohibited Applications Spawning cmd exe,"The following analytic detects executions of cmd.exe spawned by processes that are commonly abused by attackers and do not typically launch cmd.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process GUID, process name, parent process, and command-line executions. This activity is significant because it may indicate an attempt to execute unauthorized commands or scripts, often a precursor to further malicious actions.",Windows Events,"Execution, Persistence, Privilege Escalation",T1059.003,"| tstats `security_content_summariesonly` count values(Processes.process)
as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=cmd.exe OR Processes.original_file_name=Cmd.Exe)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
|search [
| inputlookup prohibited_apps_launching_cmd 
| rename prohibited_applications as parent_process_name
| eval parent_process_name=""*"" . parent_process_name
| table parent_process_name
]
| `detect_prohibited_applications_spawning_cmd_exe_filter`"
Detect Regasm with no Command Line Arguments,"The following analytic detects instances of regasm.exe running without command line arguments. This behavior typically indicates process injection, where another process manipulates regasm.exe. The detection leverages Endpoint Detection and Response (EDR) data, focusing on process names and command-line executions. This activity is significant as it may signal an attempt to evade detection or execute malicious code.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1218.009, T1218","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where
(Processes.process_name=regasm.exe OR Processes.original_file_name=RegAsm.exe)
Processes.process IN (""*regasm"",""*regasm.exe"", ""*regasm.exe\"""")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_regasm_with_no_command_line_arguments_filter`"
Detect Regsvcs with No Command Line Arguments,"The following analytic detects instances of regsvcs.exe running without command line arguments. This behavior typically indicates process injection, where another process manipulates regsvcs.exe. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, IDs, and command-line executions. This activity is significant as it may signal an attempt to evade detection and execute malicious code.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1218.009, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Processes where
(Processes.process_name=regsvcs.exe OR Processes.original_file_name=RegSvcs.exe)
Processes.process IN (""*regsvcs"",""*regsvcs.exe"", ""*regsvcs.exe\"""")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_regsvcs_with_no_command_line_arguments_filter`"
Esentutl SAM Copy,"The following analytic detects the use of esentutl.exe to access credentials stored in the ntds.dit or SAM file. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it may indicate an attempt to extract sensitive credential information, which is a common tactic in lateral movement and privilege escalation.",Windows Events,"Lateral Movement, Execution, Credential Access, Privilege Escalation",T1003.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=esentutl.exe OR Processes.original_file_name=esentutl.exe)
Processes.process IN (""*ntds*"", ""*SAM*"")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `esentutl_sam_copy_filter`"
Network Discovery Using Route Windows App,"The following analytic detects the execution of the route.exe Windows application, commonly used for network discovery. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events. This activity is significant because adversaries often use route.exe to map network routes and identify potential targets within a network. If confirmed malicious, this behavior could allow attackers to gain insights into network topology, facilitating lateral movement and further exploitation.",Windows Events,"Lateral Movement, Execution, Discovery",T1016.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=route.exe OR Processes.original_file_name=route.exe)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `network_discovery_using_route_windows_app_filter`"
Runas Execution in CommandLine,"The following analytic detects the execution of the runas.exe process with administrator user options. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it may indicate an attempt to gain elevated privileges, a common tactic in privilege escalation and lateral movement.",Windows Events,"Execution, Lateral Movement, Privilege Escalation, Defense Evasion, Discovery, Exfiltration",T1134.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=""runas.exe"" OR Processes.original_file_name=""runas.exe"")
Processes.process =""*/user:*""
Processes.process = ""*admin*""
by Processes.action Processes.dest
Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `runas_execution_in_commandline_filter`"
Sdelete Application Execution,"The following analytic detects the execution of the sdelete.exe application, a Sysinternals tool often used by adversaries to securely delete files and remove forensic evidence from a targeted host. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. Monitoring this activity is crucial as sdelete.exe is not commonly used in regular operations and its presence may indicate an attempt to cover malicious activities.",Windows Events,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` values(Processes.process) as process values(Processes.parent_process) as parent_process values(Processes.process_id) as process_id count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""sdelete.exe"" OR Processes.original_file_name=""sdelete.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `sdelete_application_execution_filter`"
Suspicious DLLHost no Command Line Arguments,"The following analytic detects instances of DLLHost.exe executing without command line arguments. This behavior is unusual and often associated with malicious activities, such as those performed by Cobalt Strike. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because DLLHost.exe typically requires arguments to function correctly, and its absence may indicate an attempt to evade detection.",Windows Events,"Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where
(Processes.process_name=dllhost.exe OR Processes.original_file_name=dllhost.exe)
Processes.process IN (""*dllhost"",""*dllhost.exe"", ""*dllhost.exe\"""")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `suspicious_dllhost_no_command_line_arguments_filter`"
Suspicious GPUpdate no Command Line Arguments,"The following analytic detects the execution of gpupdate.exe without any command line arguments. This behavior is identified using data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. It is significant because gpupdate.exe typically runs with specific arguments, and its execution without them is often associated with malicious activities, such as those performed by Cobalt Strike.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where
(Processes.process_name=gpupdate.exe OR Processes.original_file_name=GPUpdate.exe)
Processes.process IN (""*gpupdate"",""*gpupdate.exe"", ""*gpupdate.exe\"""")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `suspicious_gpupdate_no_command_line_arguments_filter`"
Suspicious microsoft workflow compiler usage,"The following analytic identifies the usage of microsoft.workflow.compiler.exe, a rarely utilized executable typically found in C:\Windows\Microsoft.NET\Framework64\v4.0.30319. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution telemetry. The significance of this activity lies in its uncommon usage, which may indicate malicious intent such as code execution or persistence mechanisms.",Windows Events,"Execution, Persistence, Defense Evasion","T1218, T1127","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=microsoft.workflow.compiler.exe OR Processes.original_file_name=Microsoft.Workflow.Compiler.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_microsoft_workflow_compiler_usage_filter`"
System Info Gathering Using Dxdiag Application,"The following analytic identifies the execution of the dxdiag.exe process with specific command-line arguments, which is used to gather system information. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line details. This activity is significant because dxdiag.exe is rarely used in corporate environments and its execution may indicate reconnaissance efforts by malicious actors.",Windows Events,"Lateral Movement, Execution",T1592,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=dxdiag.exe OR Processes.original_file_name=dxdiag.exe)
Processes.process = ""* /t *""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `system_info_gathering_using_dxdiag_application_filter`"
Verclsid CLSID Execution,"The following analytic detects the potential abuse of the verclsid.exe utility to execute malicious files via generated CLSIDs. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns associated with verclsid.exe. This activity is significant because verclsid.exe is a legitimate Windows application used to verify CLSID COM objects, and its misuse can indicate an attempt to bypass security controls.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.012,"| tstats `security_content_summariesonly` values(Processes.process) as process
values(Processes.parent_process) as parent_process values(Processes.process_id)
as process_id count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=""verclsid.exe"" OR Processes.original_file_name=""verclsid.exe"")
Processes.process=""*/S*""
Processes.process=""*/C*""
Processes.process=""*{*""
Processes.process=""*}*""
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `verclsid_clsid_execution_filter`"
Windows Diskshadow Proxy Execution,"The following analytic detects the use of DiskShadow.exe in scripting mode, which can execute arbitrary unsigned code. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions with scripting mode flags. This activity is significant because DiskShadow.exe is typically used for legitimate backup operations, but its misuse can indicate an attempt to execute unauthorized code.",Windows Events,"Execution, Persistence, Defense Evasion",T1218,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(Processes.process_name=diskshadow.exe OR Processes.original_file_name=diskshadow.exe)
Processes.process IN (*-s*, */s*)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_diskshadow_proxy_execution_filter`"
Windows Office Product Spawned Uncommon Process,"The following analytic detects a Microsoft Office product spawning uncommon processes. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where Office applications are the parent process. This activity is significant as it may indicate an attempt of a malicious macro execution or exploitation of an unknown vulnerability in an office product, in order to bypass security controls.",Windows Events,"Initial Access, Execution, Exfiltration, Lateral Movement","T1047, T1197, T1566.001, T1105","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
`process_office_products_parent`
AND
(
Processes.process_name IN (
bitsadmin.exe,
certutil.exe,
cmd.exe,
cscript.exe,
mshta.exe,
powershell.exe,
pwsh.exe,
regsvr32.exe,
rundll32.exe,
wmic.exe,
wscript.exe
)
OR
Processes.original_file_name IN (
bitsadmin.exe,
CertUtil.exe,
Cmd.Exe,
cscript.exe,
MSHTA.EXE,
PowerShell.EXE,
pwsh.dll,
REGSVR32.EXE,
RUNDLL32.EXE,
wmic.exe,
wscript.exe
)
)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_office_product_spawned_uncommon_process_filter`"
Windows Sensitive Registry Hive Dump Via CommandLine,"The following analytic detects the use of reg.exe to export Windows Registry hives, which may contain sensitive credentials. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving save or export actions targeting the sam, system, or security hives. This activity is significant as it indicates potential offline credential access attacks, often executed from untrusted processes or scripts.",Windows Events,"Lateral Movement, Execution, Credential Access",T1003.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
(
(
(Processes.process_name=reg.exe OR Processes.original_file_name=reg.exe)
Processes.process IN (""*save*"", ""*export*"")
)
OR
(
(Processes.process_name=regedit.exe OR Processes.original_file_name=REGEDIT.exe)
Processes.process IN (""*/E *"", ""*-E *"")
)
)
Processes.process IN (
""*HKEY_LOCAL_MACHINE\\SAM*"",
""*HKEY_LOCAL_MACHINE\\Security*"",
""*HKEY_LOCAL_MACHINE\\System*"", 
""*HKLM\\SAM*"",
""*HKLM\\Security*"",
""*HKLM\\System*"",
) 
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_sensitive_registry_hive_dump_via_commandline_filter`"
Windows SQLCMD Execution,"This detection identifies potentially suspicious usage of sqlcmd.exe, focusing on command patterns that may indicate data exfiltration, reconnaissance, or malicious database operations. The detection looks for both short-form (-X) and long-form (--flag) suspicious parameter combinations, which have been observed in APT campaigns targeting high-value organizations. For example, threat actors like CL-STA-0048 have been known to abuse sqlcmd.",Windows Events,"Execution, Exfiltration","T1213, T1105, T1078, T1059.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sqlcmd.exe OR Processes.original_file_name=sqlcmd.exe) by Processes.dest Processes.user Processes.parent_process_name Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 
| `drop_dm_object_name(Processes)` 
| eval process_lower=lower(process) 
| eval is_help_check=case( match(process, ""(?i)-[?]""), 1, match(process_lower, ""(?i)--help""), 1, match(process_lower, ""(?i)--version""), 1, true(), 0 ), has_parameters=if(match(process, ""-[A-Za-z]""), 1, 0), has_query=case( match(process, ""-[Qq]\\s+""), 1, match(process_lower, ""--query\\s+""), 1, match(process_lower, ""--initial-query\\s+""), 1, true(), 0 ), has_output=case( match(process, ""-[oO]\\s+""), 1, match(process_lower, ""--output-file\\s+""), 1, true(), 0 ), has_input=case( match(process, ""-[iI]\\s+""), 1, match(process_lower, ""--input-file\\s+""), 1, true(), 0 ), has_url_input=case( match(process, ""-[iI]\\s+https?://""), 1, match(process_lower, ""--input-file\\s+https?://""), 1, match(process, ""-[iI]\\s+ftp://""), 1, match(process_lower, ""--input-file\\s+ftp://""), 1, true(), 0 ), has_admin_conn=case( match(process, ""-A""), 1, match(process_lower, ""--dedicated-admin-connection""), 1, true(), 0 ), has_suspicious_auth=case( match(process, ""-U\\s+sa\\b""), 1, match(process_lower, ""--user-name\\s+sa\\b""), 1, match(process, ""-U\\s+admin\\b""), 1, match(process_lower, ""--user-name\\s+admin\\b""), 1, match(process, ""-E\\b""), 1, match(process_lower, ""--use-trusted-connection""), 1, true(), 0 ), has_local_server=case( match(process, ""-S\\s+127\\.0\\.0\\.1""), 1, match(process_lower, ""--server\\s+127\\.0\\.0\\.1""), 1, match(process, ""-S\\s+localhost""), 1, match(process_lower, ""--server\\s+localhost""), 1, true(), 0 ), has_suspicious_output=case( match(process_lower, ""-o\\s+.*\\.(txt
|csv
|dat)""), 1, match(process_lower, ""--output-file\\s+.*\\.(txt
|csv
|dat)""), 1, true(), 0 ), has_cert_bypass=case( match(process, ""-C""), 1, match(process_lower, ""--trust-server-certificate""), 1, true(), 0 ), has_suspicious_query=case( match(process_lower, ""(xp_cmdshell
|sp_oacreate
|sp_execute_external
|openrowset
|bulk\\s+insert)""), 1, match(process_lower, ""(master\\.\\.\\.sysdatabases
|msdb\\.\\.\\.backuphistory
|sysadmin
|securityadmin)""), 1, match(process_lower, ""(select.*from.*sys\\.
|select.*password
|dump\\s+database)""), 1, match(process_lower, ""(sp_addextendedproc
|sp_makewebtask
|sp_addsrvrolemember)""), 1, match(process_lower, ""(sp_configure.*show\\s+advanced
|reconfigure
|enable_xp_cmdshell)""), 1, match(process_lower, ""(exec.*master\\.dbo\\.
|exec.*msdb\\.dbo\\.)""), 1, match(process_lower, ""(sp_password
|sp_control_dbmasterkey_password
|sp_dropextendedproc)""), 1, match(process_lower, ""(powershell
|cmd\\.exe
|rundll32
|regsvr32
|certutil)""), 1, true(), 0 ), has_suspicious_path=case( match(process_lower, ""(\\\\temp\\\\
|\\\\windows\\\\
|\\\\public\\\\
|\\\\users\\\\public\\\\
|\\\\programdata\\\\)""), 1, match(process_lower, ""(\\\\desktop\\\\.*\\.(zip
|rar
|7z
|tar
|gz))""), 1, match(process_lower, ""(\\\\downloads\\\\.*\\.(dat
|bin
|tmp))""), 1, match(process_lower, ""(\\\\appdata\\\\local\\\\temp\\\\
|\\\\windows\\\\tasks\\\\)""), 1, match(process_lower, ""(\\\\recycler\\\\
|\\\\system32\\\\
|\\\\system volume information\\\\)""), 1, match(process_lower, ""(\\.vbs
|\\.ps1
|\\.bat
|\\.cmd
|\\.exe)$""), 1, true(), 0 ), has_suspicious_combo=case( match(process, ""-E"") AND match(process_lower, ""(?i)xp_cmdshell""), 1, match(process, ""-Q"") AND match(process_lower, ""(?i)exec\\s+master""), 1, has_local_server=1 AND has_suspicious_query=1, 1, true(), 0 ), has_obfuscation=case( match(process_lower, ""(char\\(
|convert\\(
|cast\\(
|declare\\s+@)""), 1, match(process_lower, ""(exec\\s+\\(
|exec\\s+@
|;\\s*exec)""), 1, match(process, ""\\^
|\\%
|\\+\\+
|\\-\\-""), 1, len(process) > 500, 1, true(), 0 ), has_data_exfil=case( match(process_lower, ""(for\\s+xml
|for\\s+json)""), 1, match(process_lower, ""(bulk\\s+insert.*from)""), 1, match(process_lower, ""(bcp.*queryout
|bcp.*out)""), 1, match(process_lower, ""(select.*into.*from
|select.*into.*outfile)""), 1, true(), 0 )
| eval risk_score=0 
| eval risk_score=case( is_help_check=1, 0, has_parameters=0, 0, has_suspicious_combo=1, risk_score + 90, has_suspicious_query=1, risk_score + 60, has_suspicious_path=1, risk_score + 40, has_url_input=1 AND has_output=1, risk_score + 80, has_query=1 AND has_output=1, risk_score + 30, has_query=1 AND has_suspicious_output=1, risk_score + 40, has_admin_conn=1, risk_score + 50, has_suspicious_auth=1, risk_score + 40, has_local_server=1 AND has_query=1, risk_score + 30, has_cert_bypass=1, risk_score + 20, has_obfuscation=1, risk_score + 70, has_data_exfil=1, risk_score + 60, true(), risk_score )
| eval risk_factors=mvappend( if((is_help_check=0 AND has_parameters=0), null(), if(has_suspicious_combo=1, ""High-risk command combination detected"", null())), if((is_help_check=0 AND has_parameters=0), null(), if(has_suspicious_query=1, ""Suspicious SQL query pattern"", null())), if(has_suspicious_path=1, ""Suspicious output path"", null()), if(has_url_input=1 AND has_output=1, ""File download attempt"", null()), if(has_query=1 AND has_output=1, ""Query output to file"", null()), if(has_admin_conn=1, ""Admin connection"", null()), if(has_suspicious_auth=1, ""Suspicious authentication"", null()), if(has_local_server=1, ""Local server connection"", null()), if(has_cert_bypass=1, ""Certificate validation bypass"", null()), if(has_obfuscation=1, ""Command obfuscation detected"", null()), if(has_data_exfil=1, ""Potential data exfiltration"", null()) ) 
| eval risk_message=""SQLCMD execution with risk factors: "".mvjoin(risk_factors, "", "")
| where is_help_check=0 AND (risk_score >= 30 OR (has_parameters=1 AND has_suspicious_query=1)) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sqlcmd_execution_filter`"
Windows Suspicious Process File Path,"The following analytic identifies processes running from file paths not typically associated with legitimate software. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific process paths within the Endpoint data model. This activity is significant because adversaries often use unconventional file paths to execute malicious code without requiring administrative privileges.",Windows Events,"Execution, Persistence, Privilege Escalation","T1036.005, T1543","| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_path IN(""*\\windows\\fonts\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"", ""*\\Users\\Administrator\\Music\\*"", ""*Recycle.bin*"", ""*\\Windows\\Media\\*"",""\\Windows\\repair\\*"", ""*\\PerfLogs\\*"", ""*:\\Windows\\Prefetch\\*"", ""*:\\Windows\\Cursors\\*"", ""*:\\Windows\\INF\\*"") AND NOT(Processes.process_path IN (""*\\temp\\*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_suspicious_process_file_path_filter`"
HTTP C2 Framework User Agent,"This Splunk query analyzes web logs to identify and categorize user agents, detecting various types of c2 frameworks. This activity can signify malicious actors attempting to interact with hosts on the network using known default configurations of command and control tools.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.",Zscaler Proxy,"Command And Control, Discovery",T1071.001,"| tstats  `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_user_agent != null by Web.http_user_agent Web.http_method, Web.url, Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| lookup suspicious_c2_user_agents c2_user_agent AS http_user_agent OUTPUT tool, description 
| where isnotnull(tool) 
| stats count min(firstTime) as first_seen max(lastTime) as last_seen by tool url http_user_agent src dest description 
| `security_content_ctime(first_seen)` 
| `security_content_ctime(last_seen)` 
| `http_c2_framework_user_agent_filter`"
Windows NirSoft Utilities,"The following analytic identifies the execution of commonly used NirSoft utilities on Windows systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution details such as process name, parent process, and command-line arguments. This activity is significant for a SOC because NirSoft utilities, while legitimate, can be used by adversaries for malicious purposes like credential theft or system reconnaissance.",Windows Events,"Execution, Persistence, Exfiltration",T1588.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Processes
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(""Processes"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup update=true is_nirsoft_software filename as process_name OUTPUT nirsoftFile
| search nirsoftFile=true
| `windows_nirsoft_utilities_filter`"
Registry Keys Used For Persistence,"The following analytic identifies modifications to registry keys commonly used for persistence mechanisms. It leverages data from endpoint detection sources like Sysmon or Carbon Black, focusing on specific registry paths known to initiate applications or services during system startup. This activity is significant as unauthorized changes to these keys can indicate attempts to maintain persistence or execute malicious actions upon system boot.",Windows Events,"Execution, Persistence",T1547.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce OR Registry.registry_path=*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved\\Run OR Registry.registry_path= ""*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\*"" OR Registry.registry_path= ""*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\*"" OR Registry.registry_path=*\\currentversion\\run* OR Registry.registry_path=*\\currentVersion\\Windows\\Appinit_Dlls* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Shell* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Notify* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\Userinit* OR Registry.registry_path=*\\CurrentVersion\\Winlogon\\VmApplet* OR Registry.registry_path=*\\currentversion\\policies\\explorer\\run* OR Registry.registry_path=*\\currentversion\\runservices* OR Registry.registry_path=*\\SOFTWARE\\Microsoft\\Netsh\\* OR Registry.registry_path= ""*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup"" OR Registry.registry_path= *\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\SharedTaskScheduler OR Registry.registry_path= *\\Classes\\htmlfile\\shell\\open\\command OR (Registry.registry_path=""*Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options*"" AND Registry.registry_key_name=Debugger) OR (Registry.registry_path=""*\\CurrentControlSet\\Control\\Lsa"" AND Registry.registry_key_name=""Security Packages"") OR (Registry.registry_path=""*\\CurrentControlSet\\Control\\Lsa\\OSConfig"" AND Registry.registry_key_name=""Security Packages"") OR (Registry.registry_path=""*\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\*"") OR (Registry.registry_path=""*currentVersion\\Windows"" AND Registry.registry_key_name=""Load"") OR (Registry.registry_path=""*\\CurrentVersion"" AND Registry.registry_key_name=""Svchost"") OR (Registry.registry_path=""*\\CurrentControlSet\Control\Session Manager""AND Registry.registry_key_name=""BootExecute"") OR (Registry.registry_path=""*\\Software\\Run"" AND Registry.registry_key_name=""auto_update"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `registry_keys_used_for_persistence_filter`"
Scheduled Task Deleted Or Created via CMD,"The following analytic identifies the creation or deletion of scheduled tasks using the schtasks.exe utility with the -create or -delete flags. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it can indicate unauthorized system manipulation or malicious intent, often associated with threat actors like Dragonfly and incidents such as the SUNBURST attack.",Windows Events,"Execution, Persistence",T1053.005,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe (Processes.process=*delete* OR Processes.process=*create*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `scheduled_task_deleted_or_created_via_cmd_filter`"
Windows Potential AppDomainManager Hijack Artifacts Creation,"The following analytic detects the creation of an .exe file along with its corresponding .exe.config and a .dll in the same directory, which is a common pattern indicative of potential AppDomain hijacking or CLR code injection attempts. This behavior may signal that a malicious actor is attempting to load a rogue assembly into a legitimate application's AppDomain, allowing code execution under the context of a trusted process.",Windows Events,"Execution, Defense Evasion","T1574, T1574.014","| tstats `security_content_summariesonly` count min(_time) AS firstTime max(_time) AS lastTime from datamodel=Endpoint.Filesystem
where Filesystem.file_name IN (""*.exe"", ""*.exe.config"", ""*.dll"") AND Filesystem.file_path IN
(""*\\windows\\fonts\\*"", ""*\\temp\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"",""*\\Users\\Administrator\\Music\\*"", ""*\\Windows\\servicing\\*"", ""*\\Users\\Default\\*"", ""*Recycle.bin*"", ""*\\Windows\\Media\\*"", ""*\\Windows\\repair\\*"", ""*\\PerfLogs\\*"")
AND Filesystem.action = ""created""
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(""Filesystem"")`
| stats values(file_name) AS file_name
values(file_path) AS file_path
values(user) AS user
min(firstTime) AS firstTime max(lastTime) AS lastTime
BY dest process_guid
| eval exe_present = if(mvcount(mvfilter(match(file_name, ""\.exe$""))) > 0, 1, 0)
| eval config_present = if(mvcount(mvfilter(match(file_name, ""\.exe\.config$""))) > 0, 1, 0)
| eval dll_present = if(mvcount(mvfilter(match(file_name, ""\.dll$""))) > 0, 1, 0)
| eval exe_files = mvfilter(match(file_name, ""\.exe$"") AND NOT match(file_name, ""\.exe\.config$""))
| eval config_files = mvfilter(match(file_name, ""\.exe\.config$""))
| eval exe_base_names = mvmap(exe_files, replace(exe_files, ""\.exe$"", """"))
| eval config_base_names = mvmap(config_files, replace(config_files, ""\.exe\.config$"", """"))
| mvexpand exe_base_names
| mvexpand config_base_names
| eval file_count = mvcount(file_name)
| where file_count >= 3 AND exe_present = 1 AND config_present = 1 AND dll_present = 1 AND exe_base_names = config_base_names
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_potential_appdomainmanager_hijack_artifacts_creation_filter`"
Windows Process Execution in Temp Dir,"The following analytic identifies processes running from %temp% directory file paths. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific process paths within the Endpoint data model. This activity is significant because adversaries often use unconventional file paths to execute malicious code without requiring administrative privileges. If confirmed malicious, this behavior could indicate an attempt to bypass security controls, leading to unauthorized software execution, potential system compromise, and further malicious activities within the environment.",Windows Events,"Execution, Persistence, Privilege Escalation","T1036.005, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_path IN(""*\\temp\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_execution_in_temp_dir_filter`"
WinEvent Scheduled Task Created Within Public Path,"The following analytic detects the creation of scheduled tasks within user-writable paths using Windows Security EventCode 4698. It identifies tasks registered via schtasks.exe or TaskService that execute commands from directories like Public, ProgramData, Temp, and AppData. This behavior is significant as it may indicate an attempt to establish persistence or execute unauthorized commands. If confirmed malicious, an attacker could maintain long-term access, escalate privileges, or execute arbitrary code, posing a severe threat to system integrity and security.",Windows Events,"Lateral Movement, Execution, Persistence",T1053.005,"`wineventlog_security`
EventCode=4698 
TaskContent IN (
""*\\users\\public\\*"", ""*\\programdata\\*"", ""*\\temp\\*"", 
""*\\Windows\\Tasks\\*"", ""*\\appdata\\*"", ""*\\perflogs\\*""
)
| stats count min(_time) as firstTime max(_time) as lastTime 
by Computer, TaskName, TaskContent, user 
|  rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `winevent_scheduled_task_created_within_public_path_filter`"
WinEvent Windows Task Scheduler Event Action Started,"The following analytic detects the execution of tasks registered in Windows Task Scheduler by monitoring EventID 200 (action run) and 201 (action completed) from the Task Scheduler logs. This detection leverages Task Scheduler logs to identify potentially suspicious or unauthorized task executions. Monitoring these events is significant for a SOC as it helps uncover evasive techniques used for persistence, unauthorized code execution, or other malicious activities.",Windows Events,"Execution, Persistence, Exfiltration",T1053.005,"`wineventlog_task_scheduler` EventCode IN (""200"",""201"")  
| stats count min(_time) as firstTime max(_time) as lastTime by TaskName dvc EventCode 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `winevent_windows_task_scheduler_event_action_started_filter`"
Suspicious Process DNS Query Known Abuse Web Services,"The following analytic detects a suspicious process making DNS queries to known, abused text-paste web services, VoIP, instant messaging, and digital distribution platforms. It leverages Sysmon EventID 22 logs to identify queries from processes like cmd.exe, powershell.exe, and others. This activity is significant as it may indicate an attempt to download malicious files, a common initial access technique.",Windows Events,"Initial Access, Execution, Exfiltration",T1059.005,"`sysmon` EventCode=22 QueryName IN (""*pastebin*"", ""*discord*"", ""*api.telegram*"",""*t.me*"") process_name IN (""cmd.exe"", ""*powershell*"", ""pwsh.exe"", ""wscript.exe"",""cscript.exe"") OR Image IN (""*\\users\\public\\*"", ""*\\programdata\\*"", ""*\\temp\\*"", ""*\\Windows\\Tasks\\*"", ""*\\appdata\\*"", ""*\\perflogs\\*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_process_dns_query_known_abuse_web_services_filter`"
Linux Suspicious React or Next.js Child Process,"This analytic detects Linux processes such as sh, bash, and common Linux LOLBINs being spawned by React or Next.js application servers. In the context of CVE-2025-55182 / React2Shell / CVE-2025-66478 for Next.js, successful exploitation can lead to arbitrary JavaScript execution on the server, which in turn is commonly used to invoke Node's child_process APIs (for example child_process.",Linux,"Initial Access, Execution","T1190, T1059.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes
where
Processes.parent_process_name = ""node""
Processes.parent_process IN (
""*--experimental-https*"",
""*--experimental-next-config-strip-types*"",
""*/node_modules/next*"",
""*next dev*"",
""*next start*"",
""*node_modules/.bin*"",
""*react-scripts start*"",
""*start-server.js*""
)
AND (
Processes.process_name IN (
""awk"",
""gawk"",
""ifconfig"",
""lua"",
""nc"",
""ncat"",
""netcat"",
""openssl"",
""perl"",
""php"",
""python"",
""python2"",
""python3"",
""ruby"",
""socat"",
""telnet""
)
OR (
Processes.process_name IN (""curl"", ""wget"")
Processes.process = ""*
|*""
)
OR (
Processes.process_name IN (
""bash"",
""dash"",
""sh""
)
NOT Processes.process = ""*-c*""
)
OR (
Processes.process_name IN (
""bash"",
""dash"",
""ksh"",
""sh"",
""zsh""
)
Processes.process IN (
""*/dev/tcp/*"",
""*/dev/udp/*"",
""*0>&1*"",
""*curl*"",
""*exec *>&*"",
""*fsockopen*"",
""*ifconfig*"",
""*mkfifo*"",
""*nc *"",
""*ncat*"",
""*netcat*"",
""*proc_open*"",
""*s_client*"",
""*socat*"",
""*socket*"",
""*subprocess*"",
""*TCPSocket*"",
""*wget*""
)
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_suspicious_react_or_next_js_child_process_filter`"
Windows PUA Named Pipe,"The following analytic detects the creation or connection to named pipes used by potentially unwanted applications (PUAs) like VPNs or utilities like PsExec. It leverages Sysmon EventCodes 17 and 18. If confirmed malicious, this could allow an attacker to abuse these to potentially gain persistence, command and control, or further system compromise.
Search 1`sysmon` 2(EventCode=17 OR EventCode=18) 3NOT process_path IN ( 4 &#34;*:\\Program Files \(x86\)\\Adobe*&#34;, 5 &#34;*:\\Program Files \(x86\)\\Google*&#34;, 6 &#34;*:\\Program Files \(x86\)\\Microsoft*&#34;, 7 &#34;*:\\Program Files\\Adobe*&#34;, 8 &#34;*:\\Program Files\\dotnet\\dotnet.",Windows Events,"Command And Control, Execution, Lateral Movement, Persistence, Defense Evasion","T1021.002, T1559, T1218, T1055","`sysmon`
(EventCode=17 OR EventCode=18)
NOT process_path IN (
""*:\\Program Files \(x86\)\\Adobe*"",
""*:\\Program Files \(x86\)\\Google*"",
""*:\\Program Files \(x86\)\\Microsoft*"",
""*:\\Program Files\\Adobe*"",
""*:\\Program Files\\dotnet\\dotnet.exe"",
""*:\\Program Files\\Google*"",
""*:\\Program Files\\Microsoft*"",
""*:\\Windows\\system32\\SearchIndexer.exe"",
""*:\\Windows\\System32\\svchost.exe"",
""*:\\Windows\\SystemApps\\Microsoft*"",
""*\\Amazon\\SSM\\Instance*"",
""*\\AppData\\Local\\Google*"",
""*\\AppData\\Local\\Kingsoft\\*"",
""*\\AppData\\Local\\Microsoft*"",
""System""
)
| stats  min(_time) as firstTime max(_time) as lastTime
count by dest dvc process_exec process_guid process_id process_path signature signature_id 
vendor_product pipe_name user_id Image process_name
| lookup pua_named_pipes pua_pipe_name AS pipe_name OUTPUT tool, description
| where isnotnull(tool)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_pua_named_pipe_filter`"
Windows RMM Named Pipe,"The following analytic detects the creation or connection to known suspicious named pipes, which is a technique often used by offensive tools. It leverages Sysmon EventCodes 17 and 18 to identify known default pipe names used by RMM tools. If confirmed malicious, this could allow an attacker to abuse these to potentially gain persistence, command and control, or further system compromise.",Windows Events,"Command And Control, Execution, Lateral Movement, Persistence, Defense Evasion","T1021.002, T1559, T1218, T1055","`sysmon`
(EventCode=17 OR EventCode=18)
NOT process_path IN (
""*:\\Program Files \(x86\)\\Adobe*"",
""*:\\Program Files \(x86\)\\Google*"",
""*:\\Program Files \(x86\)\\Microsoft*"",
""*:\\Program Files\\Adobe*"",
""*:\\Program Files\\Google*"",
""*:\\Program Files\\Microsoft*"",
""*:\\Windows\\system32\\SearchIndexer.exe"",
""*:\\Windows\\System32\\svchost.exe"",
""*:\\Windows\\SystemApps\\Microsoft*"",
""*\\Amazon\\SSM\\Instance*"",
""*\\AppData\\Local\\Google*"",
""*\\AppData\\Local\\Kingsoft\\*"",
""*\\AppData\\Local\\Microsoft*"",
""System""
)
| stats  min(_time) as firstTime max(_time) as lastTime
count by dest dvc process_exec process_guid process_id process_path signature signature_id 
vendor_product pipe_name user_id Image process_name
| lookup suspicious_rmm_named_pipes suspicious_pipe_name AS pipe_name OUTPUT tool, description
| where isnotnull(tool)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_rmm_named_pipe_filter`"
Windows Suspicious React or Next.js Child Process,"This analytic detects Windows processes such as cmd.exe, PowerShell, and common Windows LOLBINs being spawned by React or Next.js application servers. In the context of CVE-2025-55182 / React2Shell / CVE-2025-66478 for Next.js, successful exploitation can lead to arbitrary JavaScript execution on the server, which in turn is used to invoke Node's child_process APIs (for example child_process.",Windows Events,"Initial Access, Execution","T1190, T1059.001, T1059.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes
where
Processes.parent_process_name = ""node.exe""
Processes.parent_process IN (
""*--experimental-https*"",
""*--experimental-next-config-strip-types*"",
""*\\node_modules\\next*"",
""*next dev*"",
""*next start*"",
""*next\"" start*"",
""*node_modules\\.bin\\\\..\\next*"",
""*react-scripts start*"",
""*start-server.js*"",
)
AND
(
Processes.process_name IN (
""bash.exe"",
""bitsadmin.exe"",
""calc.exe"",
""certutil.exe"",
""cscript.exe"",
""curl.exe"",
""ftp.exe"",
""ipconfig.exe"",
""mshta.exe"",
""netstat.exe"",
""OpenConsole.exe"",
""powershell.exe"",
""pwsh.exe"",
""regsvr32.exe"",
""rundll32.exe"",
""sh.exe"",
""tftp.exe"",
""wget.exe"",
""wmic.exe"",
""wscript.exe"",
""wsl.exe"",
""wt.exe""
)
OR
(
Processes.process_name = ""cmd.exe""
AND NOT Processes.process = ""*/d /s /c *""
)
OR
(
Processes.process_name = ""cmd.exe""
Processes.process = ""*/d /s /c *""
AND NOT (
Processes.process = ""*git config --local --get remote.origin.url*""
OR
(
Processes.process = ""*netstat -ano 
| findstr /C:*""
Processes.process = ""* 
| findstr LISTENING*""
)
OR
(
Processes.parent_process = ""*--experimental-https*""
Processes.process = ""*\\mkcert\\*""
Processes.process IN (""* -CAROOT*"", ""* -install *"")
)
)
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_suspicious_react_or_next_js_child_process_filter`"
Windows Access Token Manipulation SeDebugPrivilege,"The following analytic detects a process enabling the &quot;SeDebugPrivilege&quot; privilege token. It leverages Windows Security Event Logs with EventCode 4703, filtering out common legitimate processes. This activity is significant because SeDebugPrivilege allows a process to inspect and modify the memory of other processes, potentially leading to credential dumping or code injection. If confirmed malicious, an attacker could gain extensive control over system processes, enabling them to escalate privileges, persist in the environment, or access sensitive information.",Windows Events,"Execution, Defense Evasion","T1134.001, T1134.002","`wineventlog_security` EventCode=4703 EnabledPrivilegeList = ""*SeDebugPrivilege*"" AND NOT(ProcessName IN (""*\\Program File*"", ""*\\System32\\lsass.exe*"", ""*\\SysWOW64\\lsass.exe*"", ""*\\SysWOW64\\svchost.exe*"", ""*\\System32\\svchost.exe*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer ProcessName ProcessId SubjectDomainName SubjectUserName SubjectUserSid TargetUserName TargetLogonId TargetDomainName EnabledPrivilegeList action dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_access_token_manipulation_sedebugprivilege_filter`"
Windows Cmdline Tool Execution From Non-Shell Process,"The following analytic identifies instances where ipconfig.exe, systeminfo.exe, or similar tools are executed by a non-standard shell parent process, excluding CMD, PowerShell, or Explorer. This detection leverages Endpoint Detection and Response (EDR) telemetry to monitor process creation events. Such behavior is significant as it may indicate adversaries using injected processes to perform system discovery, a tactic observed in FIN7's JSSLoader.",Windows Events,"Lateral Movement, Execution, Discovery",T1059.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""ipconfig.exe"", ""systeminfo.exe"", ""net1.exe"", ""arp.exe"", ""nslookup.exe"", ""route.exe"", ""netstat.exe"", ""hostname.exe"", ""whoami.exe"") AND NOT Processes.parent_process_name IN (""cmd.exe"", ""powershell.exe"", ""powershell_ise.exe"", ""pwsh.exe"", ""explorer.exe"", ""-"", ""unknown"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cmdline_tool_execution_from_non_shell_process_filter`"
Windows Service Created with Suspicious Service Name,"The following analytic detects the creation of a Windows Service with a known suspicious or malicious name using Windows Event ID 7045. It leverages logs from the wineventlog_system to identify these services installations. This activity is significant as adversaries, including those deploying Clop ransomware, often create malicious services for lateral movement, remote code execution, persistence, and execution.",Windows Events,"Lateral Movement, Execution, Persistence","T1569, T1569.002","`wineventlog_system` EventCode=7045 
| stats values(ImagePath) as process, count, min(_time) as firstTime, max(_time) as lastTime values(EventCode) as signature by Computer, ServiceName, StartType, ServiceType, UserID
| eval process_name = replace(mvindex(split(process,""\\""),-1), ""\"""", """")
| rename Computer as dest, ServiceName as object_name, ServiceType as object_type, UserID as user_id
| lookup windows_suspicious_services service_name as object_name
| where isnotnull(tool_name)
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_created_with_suspicious_service_name_filter`"
Azure AD High Number Of Failed Authentications For User,"The following analytic identifies an Azure AD account experiencing more than 20 failed authentication attempts within a 10-minute window. This detection leverages Azure SignInLogs data, specifically monitoring for error code 50126 and unsuccessful authentication attempts. This behavior is significant as it may indicate a brute force attack targeting the account. If confirmed malicious, an attacker could potentially gain unauthorized access, leading to data breaches or further exploitation within the environment.",Azure AD (Microsoft Entra ID),Credential Access,"T1110, T1110.001","`azure_monitor_aad`
category=SignInLogs
properties.status.errorCode=50126
properties.authenticationDetails{}.succeeded=false
| rename properties.* as *
| bin span=10m _time
| fillnull value=null
| stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(src) as src values(user_agent) as user_agent by user _time vendor_account vendor_product
| where count > 20
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `azure_ad_high_number_of_failed_authentications_for_user_filter`"
Azure AD High Number Of Failed Authentications From Ip,The following analytic detects an IP address with 20 or more failed authentication attempts to an Azure AD tenant within 10 minutes. It leverages Azure AD SignInLogs to identify repeated failed logins from the same IP. This behavior is significant as it may indicate a brute force attack aimed at gaining unauthorized access or escalating privileges.,Azure AD (Microsoft Entra ID),Credential Access,"T1110.003, T1110.001, T1110","`azure_monitor_aad`
category=SignInLogs
properties.status.errorCode=50126
properties.authenticationDetails{}.succeeded=false
| rename properties.* as *
| bin span=10m _time
| fillnull value=null
| stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(user) as user values(user_agent) as user_agent by src _time vendor_account vendor_product
| where count > 20
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `azure_ad_high_number_of_failed_authentications_from_ip_filter`"
Windows Suspicious Named Pipe,"The following analytic detects the creation or connection to known suspicious named pipes. It leverages Sysmon EventCodes 17 and 18 to identify known default pipe names used by malicious or suspicious tools. If confirmed malicious, this could allow an attacker to abuse these to potentially gain privilege escalation, persistence, c2 communications, or further system compromise.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Defense Evasion","T1021.002, T1559, T1218, T1055","`sysmon`
EventCode IN (17, 18)
NOT process_path IN (
""*:\\Program Files \(x86\)\\Adobe*"",
""*:\\Program Files \(x86\)\\Google*"",
""*:\\Program Files \(x86\)\\Microsoft*"",
""*:\\Program Files\\Adobe*"",
""*:\\Program Files\\Google*"",
""*:\\Program Files\\Microsoft*"",
""*:\\Windows\\system32\\SearchIndexer.exe"",
""*:\\Windows\\System32\\svchost.exe"",
""*:\\Windows\\SystemApps\\Microsoft*"",
""*\\Amazon\\SSM\\Instance*"",
""*\\AppData\\Local\\Google*"",
""*\\AppData\\Local\\Kingsoft\\*"",
""*\\AppData\\Local\\Microsoft*"",
""System"",
)
| stats min(_time) as firstTime max(_time) as lastTime
count by dest dvc process_exec process_guid process_id process_path
pipe_name user_id process_name signature signature_id vendor_product
| lookup suspicious_named_pipes suspicious_pipe_name AS pipe_name OUTPUT tool, type, description
| where isnotnull(tool)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_suspicious_named_pipe_filter`"
Linux Auditd Doas Conf File Creation,"The following analytic detects the creation of the doas.conf file on a Linux host. This file is used by the doas utility to allow standard users to perform tasks as root, similar to sudo. The detection leverages Linux Auditd data, focusing on the creation of the doas.conf file. This activity is significant because it can indicate an attempt to gain elevated privileges, potentially by an adversary.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"`linux_auditd`
(
(type=PATH nametype=""CREATE"")
OR
type=CWD
)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/doas.conf.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table nametype current_working_directory reconstructed_path dest audit_id match_count firstTime lastTime
| `linux_auditd_doas_conf_file_creation_filter`"
Linux Auditd Possible Access Or Modification Of Sshd Config File,"The following analytic detects access, deletion or modification of the ssh_config file on Linux systems. It leverages data from Linux Auditd, focusing on events of type PATH with a nametype of (&quot;NORMAL&quot;, &quot;CREATE&quot;, &quot;DELETE&quot;). This activity could be significant because unauthorized changes to ssh_config can allow threat actors to redirect port connections or use unauthorized keys, potentially compromising the system.",Linux,"Execution, Persistence, Privilege Escalation","T1098.004, T1098","`linux_auditd`
(
(type=PATH nametype IN (""NORMAL"", ""CREATE"", ""DELETE""))
OR
type=CWD
)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/ssh/ssh_config.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
|  `linux_auditd_possible_access_or_modification_of_sshd_config_file_filter`"
Linux Auditd Possible Access To Sudoers File,"The following analytic detects potential access or modification of the /etc/sudoers file on a Linux system. It leverages data from Linux Auditd, focusing on events of type PATH or CWD. This activity could be significant because the sudoers file controls user permissions for executing commands with elevated privileges. Correlate this with related EXECVE or PROCTITLE events to identify the process or user responsible for the access or modification.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1548.003, T1548","`linux_auditd`
(type=PATH OR type=CWD)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/sudoers.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_possible_access_to_sudoers_file_filter`"
Linux Auditd Possible Append Cronjob Entry On Existing Cronjob File,"The following analytic detects potential tampering with cronjob files on a Linux system. It leverages logs from Linux Auditd, focusing on events of type PATH or CWD. This activity could be significant because adversaries often use it for persistence or privilege escalation. Correlate this with related EXECVE or PROCTITLE events to identify the process or user responsible for the access or modification.",Linux,"Execution, Impact, Persistence, Privilege Escalation","T1053, T1053.003","`linux_auditd` (type=PATH OR type=CWD)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/cron.*
|.*/cron/.*
|/etc/anacrontab.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_possible_append_cronjob_entry_on_existing_cronjob_file_filter`"
Linux Auditd Unix Shell Configuration Modification,"The following analytic detects suspicious access or modifications to Unix shell configuration files, which may indicate an attempt to alter system behavior or gain unauthorized access. Unix shell configuration files, such as .bashrc or .profile, control user environment settings and command execution. Unauthorized changes to these files can be used to execute malicious commands, escalate privileges, or hide malicious activities.",Linux,"Execution, Persistence, Privilege Escalation",T1546.004,"`linux_auditd`
(type=PATH OR type=CWD)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, ""/etc/profile
|/etc/shells
|/etc/profile\\.d/.*
|/etc/bash\\.bashrc.*
|/etc/bashrc
|.*/zsh/zprofile
|.*/zsh/zshrc
|.*/zsh/zlogin
|.*/zsh/zlogout
|/etc/csh\\.cshrc.*
|/etc/csh\\.login.*
|/root/\\.bashrc.*
|/root/\\.bash_profile.*
|/root/\\.profile.*
|/root/\\.zshrc.*
|/root/\\.zprofile.*
|/home/.*/\\.bashrc.*
|/home/.*/\\.zshrc.*
|/home/.*/\\.bash_profile.*
|/home/.*/\\.zprofile.*
|/home/.*/\\.profile.*
|/home/.*/\\.bash_login.*
|/home/.*/\\.bash_logout.*
|/home/.*/\\.zlogin.*
|/home/.*/\\.zlogout.*""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_unix_shell_configuration_modification_filter`"
Linux Magic SysRq Key Abuse,"Detects potential abuse of the Linux Magic SysRq (System Request) key by adversaries with root or sufficient privileges to manipulate or destabilize a system. Writing to /proc/sysrq-trigger can crash the system, kill processes, or bypass standard logging. Monitoring SysRq abuse helps detect stealthy post-exploitation activity. Correlate with related EXECVE or PROCTITLE events to identify the process or user responsible for the access or modification.",Linux,"Execution, Impact","T1529, T1059.004, T1489, T1499","`linux_auditd`
(type=PATH OR type=CWD)
| rex ""msg=audit\([^)]*:(?<audit_id>\d+)\)""
| stats
values(type) as types
values(name) as names
values(nametype) as nametype
values(cwd) as cwd_list
values(_time) as event_times
by audit_id, host
| eval current_working_directory = coalesce(mvindex(cwd_list, 0), ""N/A"")
| eval candidate_paths = mvmap(names, if(match(names, ""^/""), names, current_working_directory + ""/"" + names))
| eval matched_paths = mvfilter(match(candidate_paths, "".*/proc/sysrq-trigger
|.*/proc/sys/kernel/sysrq
|.*/etc/sysctl.conf""))
| eval match_count = mvcount(matched_paths)
| eval reconstructed_path = mvindex(matched_paths, 0)
| eval e_time = mvindex(event_times, 0)
| where match_count > 0
| rename host as dest
| stats count min(e_time) as firstTime max(e_time) as lastTime
values(nametype) as nametype
by current_working_directory
reconstructed_path
match_count
dest
audit_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_magic_sysrq_key_abuse_filter`"
File Download or Read to Pipe Execution,"The following analytic detects the use of download or file reading utilities from Windows, Linux or MacOS to download or read the contents of a file from a remote or local source and pipe it directly to a shell for execution. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions.",Windows Events,"Command And Control, Execution",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime
from datamodel=Endpoint.Processes where
``` This aims to cover download utilities and file reading ones ```
Processes.process IN (
""*.DownloadFile(*"",
""*.DownloadString(*"",
""*ASCII.GetString*"",
""*bitsadmin*"",
""*certutil*"",
""*curl*"",
""*Invoke-RestMethod*"",
""*Invoke-WebRequest*"",
""*irm*"",
""*iwr *"",
""*mshta*"",
""*wget*""
)
Processes.process IN (""*
|*"")
(
``` Linux / MacOS ```
Processes.process IN (
""*bash*"",
""*csh*"",
""*dash*"",
""*fish*"",
""*ksh*"",
""*rbash*"",
""*tcsh*"",
""*zsh*""
)
OR
``` Because the ""sh"" string can overlap and is a short atom we treat it in a special case ```
Processes.process IN (
""*
|sh""
""* sh*""
)
OR
``` Windows ```
Processes.process IN (""*IEX*"", ""*Invoke-Expression*"")
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `file_download_or_read_to_pipe_execution_filter`"
GitHub Workflow File Creation or Modification,"The following analytic hunts for any creations or modifications to GitHub Actions workflow YAML files across the organization's Linux or Windows endpoints. This hunting query tracks all workflow file activity under .github/workflows directories to help defenders establish baselines of legitimate CI/CD workflow creation patterns, identify unusual or unauthorized changes, and detect anomalies that may indicate supply chain compromise.",GitHub Enterprise,"Execution, Persistence, Impact, Privilege Escalation, Defense Evasion, Exfiltration","T1195, T1554, T1574.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
Filesystem.file_path IN (
""*/.github/workflows/*.yaml"",
""*/.github/workflows/*.yml"",
""*\\.github\\workflows\\*.yaml"",
""*\\.github\\workflows\\*.yml""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `github_workflow_file_creation_or_modification_filter`"
Shai-Hulud 2 Exfiltration Artifact Files,"Detects creation of exfiltration artifact files associated with Shai-Hulud 2.0 npm supply chain malware. The malware creates cloud.json, contents.json, environment.json, truffleSecrets.json, and actionsSecrets.json files containing harvested credentials from AWS, Azure, GCP, GitHub secrets, and environment variables. These files are staged before being pushed to attacker-controlled repositories.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime 3 4from datamodel=Endpoint.",Windows Events,"Initial Access, Credential Access, Collection, Exfiltration","T1074.001, T1552.001, T1195.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
Filesystem.file_name IN (
""cloud.json"",
""contents.json"",
""environment.json"",
""truffleSecrets.json"",
""actionsSecrets.json""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `shai_hulud_2_exfiltration_artifact_files_filter`"
Shai-Hulud Workflow File Creation or Modification,"Detects creation or deletion of malicious GitHub Actions workflow files associated with Shai-Hulud worm variants on Linux or Windows endpoints. This includes the original shai-hulud-workflow.yml, the 2.0 backdoor discussion.yaml (enables command injection via GitHub Discussions on self-hosted runners named SHA1HULUD), and the secrets exfiltration workflow formatter_*.yml pattern. These files are used to exfiltrate credentials and propagate across repositories.",Windows Events,"Persistence, Impact, Privilege Escalation, Defense Evasion, Exfiltration","T1195, T1554, T1574.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
Filesystem.file_path IN (
""*/.github/workflows/discussion.yaml"",
""*/.github/workflows/discussion.yml"",
""*/.github/workflows/formatter_*.yaml"",
""*/.github/workflows/formatter_*.yml"",
""*/.github/workflows/shai-hulud-workflow.yaml"",
""*/.github/workflows/shai-hulud-workflow.yml"",
""*/.github/workflows/shai-hulud.yaml"",
""*/.github/workflows/shai-hulud.yml"",
""*\\.github\\workflows\\discussion.yaml"",
""*\\.github\\workflows\\discussion.yml"",
""*\\.github\\workflows\\formatter_*.yaml"",
""*\\.github\\workflows\\formatter_*.yml"",
""*\\.github\\workflows\\shai-hulud-workflow.yaml"",
""*\\.github\\workflows\\shai-hulud-workflow.yml"",
""*\\.github\\workflows\\shai-hulud.yaml"",
""*\\.github\\workflows\\shai-hulud.yml""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user
Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `shai_hulud_workflow_file_creation_or_modification_filter`"
Add or Set Windows Defender Exclusion,"The following analytic detects the use of commands to add or set exclusions in Windows Defender. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;Add-MpPreference&quot; or &quot;Set-MpPreference&quot; with exclusion parameters. This activity is significant because adversaries often use it to bypass Windows Defender, allowing malicious code to execute undetected.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
(
Processes.process = ""*Add-MpPreference *""
OR 
Processes.process = ""*Set-MpPreference *""
) 
Processes.process IN (
""*-Exclusion*"", 
""*-ControlledFolderAccessAllowedApplications*"", 
""*-AttackSurfaceReductionOnlyExclusions*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `add_or_set_windows_defender_exclusion_filter`"
Allow Inbound Traffic In Firewall Rule,"The following analytic detects a suspicious PowerShell command that allows inbound traffic to a specific local port within the public profile. It leverages PowerShell script block logging (EventCode 4104) to identify commands containing keywords like &quot;firewall,&quot; &quot;Inbound,&quot; &quot;Allow,&quot; and &quot;-LocalPort.&quot; This activity is significant because it may indicate an attacker attempting to establish remote access by modifying firewall rules.",Windows Events,"Lateral Movement, Exfiltration",T1021.001,"`powershell` EventCode=4104 ScriptBlockText = ""*firewall*"" ScriptBlockText = ""*Inbound*"" ScriptBlockText = ""*Allow*""  ScriptBlockText = ""*-LocalPort*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `allow_inbound_traffic_in_firewall_rule_filter`"
Detect MSHTA Url in Command Line,"The following analytic detects the use of Microsoft HTML Application Host (mshta.exe) to make remote HTTP or HTTPS connections. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line arguments containing URLs. This activity is significant because adversaries often use mshta.exe to download and execute remote .hta files, bypassing security controls.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_mshta` (Processes.process=""*http://*"" OR Processes.process=""*https://*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_mshta_url_in_command_line_filter`"
LOLBAS With Network Traffic,"The following analytic identifies the use of Living Off the Land Binaries and Scripts (LOLBAS) with network traffic. It leverages data from the Network Traffic data model to detect when native Windows binaries, often abused by adversaries, initiate network connections. This activity is significant as LOLBAS are frequently used to download malicious payloads, enabling lateral movement, command-and-control, or data exfiltration.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Execution, Lateral Movement, Persistence, Defense Evasion, Exfiltration","T1218, T1105, T1567","| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime
from datamodel=Network_Traffic.All_Traffic where
All_Traffic.app IN (
""*\\At.exe"",
""*\\Atbroker.exe"",
""*\\Bash.exe"",
""*\\Bitsadmin.exe"",
""*\\Certoc.exe"",
""*\\certutil.exe"",
""*\\cmd.exe"",
""*\\Cmstp.exe"",
""*\\cscript.exe"",
""*\\Diskshadow.exe"",
""*\\Dnscmd.exe"",
""*\\Extexport.exe"",
""*\\Forfiles.exe"",
""*\\Ftp.exe"",
""*\\Gpscript.exe"",
""*\\Hh.exe"",
""*\\Ie4uinit.exe"",
""*\\Ieexec.exe"",
""*\\Infdefaultinstall.exe"",
""*\\Installutil.exe"",
""*\\makecab.exe"",
""*\\Mavinject.exe"",
""*\\Microsoft.Workflow.Compiler.exe"",
""*\\Msbuild.exe"",
""*\\Msconfig.exe"",
""*\\Msdt.exe"",
""*\\Mshta.exe"",
""*\\Msiexec.exe"",
""*\\Netsh.exe"",
""*\\notepad.exe"",
""*\\Odbcconf.exe"",
""*\\OfflineScannerShell.exe"",
""*\\Pcalua.exe"",
""*\\Pcwrun.exe"",
""*\\Pnputil.exe"",
""*\\powershell_ise.exe"",
""*\\powershell.exe"",
""*\\Presentationhost.exe"",
""*\\pwsh.exe"",
""*\\Rasautou.exe"",
""*\\Regasm.exe"",
""*\\Register-cimprovider.exe"",
""*\\Regsvcs.exe"",
""*\\Regsvr32.exe"",
""*\\Runonce.exe"",
""*\\Runscripthelper.exe"",
""*\\Schtasks.exe"",
""*\\Scriptrunner.exe"",
""*\\SettingSyncHost.exe"",
""*\\Stordiag.exe"",
""*\\Syncappvpublishingserver.exe"",
""*\\Ttdinject.exe"",
""*\\Tttracer.exe"",
""*\\Verclsid.exe"",
""*\\Wab.exe"",
""*\\Wmic.exe"",
""*\\WorkFolders.exe"",
""*\\Wuauclt.exe"",
""*\\Xwizard.exe""
)
NOT All_Traffic IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4""
)
by All_Traffic.action All_Traffic.app All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port 
All_Traffic.direction All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version
All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user 
All_Traffic.vendor_product
| `drop_dm_object_name(All_Traffic)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rex field=app "".*\\\(?<process_name>.*)$""
| `lolbas_with_network_traffic_filter`"
Ntdsutil Export NTDS,"The following analytic detects the use of Ntdsutil to export the Active Directory database (NTDS.dit). It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because exporting NTDS.dit can be a precursor to offline password cracking, posing a severe security risk.",Windows Events,"Execution, Credential Access, Privilege Escalation",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=ntdsutil.exe Processes.process=*ntds* Processes.process=*create*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `ntdsutil_export_ntds_filter`"
Powershell Fileless Script Contains Base64 Encoded Content,"The following analytic detects the execution of PowerShell scripts containing Base64 encoded content, specifically identifying the use of FromBase64String. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command sent to PowerShell. This activity is significant as Base64 encoding is often used by attackers to obfuscate malicious payloads, making it harder to detect.",Windows Events,"Execution, Defense Evasion","T1059.001, T1027","`powershell` EventCode=4104 ScriptBlockText = ""*frombase64string*"" OR ScriptBlockText = ""*gnirtS46esaBmorF*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_fileless_script_contains_base64_encoded_content_filter`"
Powershell Windows Defender Exclusion Commands,"The following analytic detects the use of PowerShell commands to add or set Windows Defender exclusions. It leverages EventCode 4104 to identify suspicious Add-MpPreference or Set-MpPreference commands with exclusion parameters. This activity is significant because adversaries often use it to bypass Windows Defender, allowing malicious code to execute without detection. If confirmed malicious, this behavior could enable attackers to evade antivirus defenses, maintain persistence, and execute further malicious activities undetected.",Windows Events,"Persistence, Defense Evasion",T1562.001,"`powershell` EventCode=4104 (ScriptBlockText = ""*Add-MpPreference *"" OR ScriptBlockText = ""*Set-MpPreference *"") AND ScriptBlockText = ""*-exclusion*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_windows_defender_exclusion_commands_filter`"
Suspicious Scheduled Task from Public Directory,"The following analytic identifies the creation of scheduled tasks that execute binaries or scripts from public directories, such as users\public, \programdata, or \windows\temp, using schtasks.exe with the /create command. It leverages Sysmon Event ID 1 data to detect this behavior. This activity is significant because it often indicates an attempt to maintain persistence or execute malicious scripts, which are common tactics in malware deployment.",Windows Events,"Discovery, Execution, Persistence, Lateral Movement","T1053.005, T1053","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe (Processes.process=*\\users\\public\\* OR Processes.process=*\\programdata\\* OR Processes.process=*windows\\temp*)  Processes.process=*/create* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `suspicious_scheduled_task_from_public_directory_filter`"
System Information Discovery Detection,"The following analytic identifies system information discovery techniques, such as the execution of commands like wmic qfe, systeminfo, and hostname. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because attackers often use these commands to gather system configuration details, which can aid in further exploitation.",Windows Events,"Execution, Persistence, Privilege Escalation, Discovery, Exfiltration",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=""*wmic* qfe*"" OR Processes.process=*systeminfo* OR Processes.process=*hostname*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| eventstats dc(process) as dc_processes_by_dest by dest 
| where dc_processes_by_dest > 2 
| stats values(process) as process values(action) as action values(original_file_name) as original_file_name values(parent_process) as parent_process values(parent_process_exec) as parent_process_exec values(parent_process_guid) as parent_process_guid values(parent_process_id) as parent_process_id values(parent_process_path) as parent_process_path values(process_exec) as process_exec values(process_guid) as process_guid values(.process_hash) as process_hash values(process_id) as process_id values(process_integrity_level) as process_integrity_level values(process_path) as process_path values(user_id) as user_id values(vendor_product) as vendor_product  min(firstTime) as firstTime max(lastTime) as lastTime by user, dest parent_process_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `system_information_discovery_detection_filter`"
Windows Cabinet File Extraction Via Expand,"Detects usage of expand.exe to extract Microsoft Cabinet (CAB) archives, with emphasis on extractions into C:\\ProgramData or similar staging locations. In recent APT37 activity, a CAB payload (e.g., wonder.cab) was expanded into ProgramData prior to persistence and execution. This behavior is a strong signal for ingress tool transfer and staging of payloads.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime 3from datamodel=Endpoint.",Windows Events,"Discovery, Execution, Command And Control, Persistence",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes
where Processes.process_name=""expand.exe""
(Processes.process=""*-F:*"" OR Processes.process=""*/F:*"")
Processes.process=""*\\ProgramData\\*""
by Processes.dest Processes.user Processes.parent_process_name Processes.process_name Processes.process Processes.original_file_name Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_path Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_path Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_cabinet_file_extraction_via_expand_filter`"
Windows Credentials from Password Stores Creation,"The following analytic detects the execution of the Windows OS tool cmdkey.exe, which is used to create stored usernames, passwords, or credentials. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant because cmdkey.exe is often abused by post-exploitation tools and malware, such as Darkgate, to gain unauthorized access.",Windows Events,"Execution, Credential Access, Persistence",T1555,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""cmdkey.exe"" OR Processes.original_file_name = ""cmdkey.exe"" AND Processes.process = ""*/generic*"" Processes.process IN (""*/user*"", ""*/password*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_creation_filter`"
Windows Credentials from Password Stores Deletion,"The following analytic detects the execution of the Windows OS tool cmdkey.exe with the /delete parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. The activity is significant because cmdkey.exe can be used by attackers to delete stored credentials, potentially leading to privilege escalation and persistence.",Windows Events,"Execution, Credential Access, Persistence, Privilege Escalation",T1555,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""cmdkey.exe"" OR Processes.original_file_name = ""cmdkey.exe"" AND Processes.process = ""*/delete*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_deletion_filter`"
Windows Credentials from Password Stores Query,"The following analytic detects the execution of the Windows OS tool cmdkey.exe, which is often abused by post-exploitation tools like winpeas, commonly used in ransomware attacks to list stored usernames, passwords, or credentials. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant as it indicates potential credential harvesting, which can lead to privilege escalation and persistence.",Windows Events,"Execution, Credential Access, Persistence, Impact, Privilege Escalation",T1555,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""cmdkey.exe"" OR Processes.original_file_name = ""cmdkey.exe"" AND Processes.process = ""*/list*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_from_password_stores_query_filter`"
Windows Defender Exclusion Registry Entry,"The following analytic detects modifications to the Windows Defender exclusion registry entries. It leverages endpoint registry data to identify changes in the registry path &quot;\SOFTWARE\Policies\Microsoft\Windows Defender\Exclusions\&quot;. This activity is significant because adversaries often modify these entries to bypass Windows Defender, allowing malicious code to execute without detection. If confirmed malicious, this behavior could enable attackers to evade antivirus defenses, maintain persistence, and execute further malicious activities undetected.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Exclusions\\*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_defender_exclusion_registry_entry_filter`"
Windows Executable Masquerading as Benign File Types,"The following analytic detects the presence of executable files masquerading as benign file types on Windows systems. Adversaries employ this technique to evade defenses and trick users into executing malicious code by renaming executables with extensions commonly associated with documents, images, or other non-executable formats (e.g., .pdf, .jpg, .doc, .png).
Search 1`sysmon` 2EventCode=29 3NOT `executable_extensions` 4 5| stats count min(_time) as firstTime max(_time) as lastTime 6 by Image file_name file_path process_guid file_hash process_id dest user EventCode 7 8| `security_content_ctime(firstTime)` 9 10| `security_content_ctime(lastTime)` 11 12| `windows_executable_masquerading_as_benign_file_types_filter` Data Source Name Platform Sourcetype Source Sysmon EventID 29 Windows 'XmlWinEventLog' 'XmlWinEventLog:Microsoft-Windows-Sysmon/Operational' Macros Used Name Value executable_extensions (TargetFilename IN (&quot;*.",Windows Events,Defense Evasion,T1036.008,"`sysmon`
EventCode=29
NOT `executable_extensions`
| stats count min(_time) as firstTime max(_time) as lastTime
by Image file_name file_path process_guid file_hash process_id dest user EventCode
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_executable_masquerading_as_benign_file_types_filter`"
Windows File and Directory Enable ReadOnly Permissions,"The following analytic detects instances where file or folder permissions are modified to grant read-only access. Such changes are characterized by the presence of read-related permissions (e.g., R, REA, RA, RD) and the absence of write (W) or execute (E) permissions. Monitoring these events is crucial for tracking access control changes that could be intentional for restricting access or indicative of malicious behavior.",Windows Events,"Execution, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") AND Processes.process IN (""*/grant*"", ""*/G*"") AND Processes.process IN (""*SYSTEM*"", ""*admin*"", ""*S-1-1-0*"", ""*EVERYONE*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| rex field=process "":\\((?<permission>[^)]+)\\)"" 
| eval has_read_attribute=if(match(permission, ""R""), ""true"", ""false"") 
| eval has_write_execute=if(match(permission, ""(W
|GA
|X
|M
|F
|AD
|DC
|DE)""), ""true"", ""false"") 
| where has_write_execute=""false"" and has_read_attribute = ""true"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_and_directory_enable_readonly_permissions_filter`"
Windows File and Directory Permissions Enable Inheritance,"The following analytic detects the enabling of permission inheritance using ICACLS. This analytic identifies instances where ICACLS commands are used to enable permission inheritance on files or directories. The /inheritance:e flag, which restores inherited permissions from a parent directory, is monitored to detect changes that might reapply broader access control settings. Enabling inheritance can indicate legitimate administrative actions but may also signal attempts to override restrictive custom permissions, potentially exposing sensitive files to unauthorized access.",Windows Events,"Execution, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") AND Processes.process = ""*/inheritance:e*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_and_directory_permissions_enable_inheritance_filter`"
Windows Firewall Rule Added,"This detection identifies instances where a Windows Firewall rule is added by monitoring Event ID 4946 in the Windows Security Event Log. Firewall rule modifications can indicate legitimate administrative actions, but they may also signal unauthorized changes, misconfigurations, or malicious activity such as attackers allowing traffic for backdoors or persistence mechanisms. By analyzing fields like RuleName, RuleId, Computer, and ProfileChanged, security teams can determine whether the change aligns with expected behavior.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.004,"`wineventlog_security` EventCode=4946 
| stats count min(_time) as firstTime max(_time) as lastTime by RuleName signature subject status dest ProcessID 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_firewall_rule_added_filter`"
Windows Firewall Rule Deletion,"This detection identifies instances where a Windows Firewall rule has been deleted, potentially exposing the system to security risks. Unauthorized removal of firewall rules can indicate an attacker attempting to bypass security controls or malware disabling protections for persistence and command-and-control communication. The event logs details such as the deleted rule name, protocol, port, and the user responsible for the action.",Windows Events,"Persistence, Defense Evasion",T1562.004,"`wineventlog_security` EventCode=4948 
| stats count min(_time) as firstTime max(_time) as lastTime by RuleName signature subject status dest ProcessID 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_firewall_rule_deletion_filter`"
Windows Firewall Rule Modification,"This detection identifies instances where a Windows Firewall rule has been modified, which may indicate an attempt to alter security policies. Unauthorized modifications can weaken firewall protections, allowing malicious traffic or preventing legitimate communications. The event logs details such as the modified rule name, protocol, ports, application path, and the user responsible for the change.",Windows Events,"Execution, Defense Evasion",T1562.004,"`wineventlog_security` EventCode=4947 
| stats count min(_time) as firstTime max(_time) as lastTime by RuleName signature subject status dest ProcessID 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_firewall_rule_modification_filter`"
Windows Local LLM Framework Execution,"The following analytic detects execution of unauthorized local LLM frameworks (Ollama, LM Studio, GPT4All, Jan, llama.cpp, KoboldCPP, Oobabooga, NutStudio) and Python-based AI/ML libraries (HuggingFace Transformers, LangChain) on Windows endpoints by leveraging process creation events. It identifies cases where known LLM framework executables are launched or command-line arguments reference AI/ML libraries. This activity is significant as it may indicate shadow AI deployments, unauthorized model inference operations, or potential data exfiltration through local AI systems.",Windows Events,"Execution, Persistence, Exfiltration",T1543,"| tstats `security_content_summariesonly` count
min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes
where
(
Processes.process_name IN (
""gpt4all.exe"",
""jan.exe"",
""kobold.exe"",
""koboldcpp.exe"",
""llama-run.exe"",
""llama.cpp.exe"",
""lmstudio.exe"",
""nutstudio.exe"",
""ollama.exe"",
""oobabooga.exe"",
""text-generation-webui.exe""
)
OR
Processes.original_file_name IN (
""ollama.exe"",
""lmstudio.exe"",
""gpt4all.exe"",
""jan.exe"",
""llama-run.exe"",
""koboldcpp.exe"",
""nutstudio.exe""
)
OR
Processes.process IN (
""*\\gpt4all\\*"",
""*\\jan\\*"",
""*\\koboldcpp\\*"",
""*\\llama.cpp\\*"",
""*\\lmstudio\\*"",
""*\\nutstudio\\*"",
""*\\ollama\\*"",
""*\\oobabooga\\*"",
""*huggingface*"",
""*langchain*"",
""*llama-run*"",
""*transformers*""
)
OR
Processes.parent_process_name IN (
""gpt4all.exe"",
""jan.exe"",
""kobold.exe"",
""koboldcpp.exe"",
""llama-run.exe"",
""llama.cpp.exe"",
""lmstudio.exe"",
""nutstudio.exe"",
""ollama.exe"",
""oobabooga.exe"",
""text-generation-webui.exe""
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| eval Framework=case(
match(process_name, ""(?i)ollama"") OR match(process, ""(?i)ollama""), ""Ollama"",
match(process_name, ""(?i)lmstudio"") OR match(process, ""(?i)lmstudio"") OR match(process, ""(?i)lm-studio""), ""LM Studio"",
match(process_name, ""(?i)gpt4all"") OR match(process, ""(?i)gpt4all""), ""GPT4All"",
match(process_name, ""(?i)kobold"") OR match(process, ""(?i)kobold""), ""KoboldCPP"",
match(process_name, ""(?i)jan"") OR match(process, ""(?i)jan""), ""Jan AI"",
match(process_name, ""(?i)nutstudio"") OR match(process, ""(?i)nutstudio""), ""NutStudio"",
match(process_name, ""(?i)llama"") OR match(process, ""(?i)llama""), ""llama.cpp"",
match(process_name, ""(?i)oobabooga"") OR match(process, ""(?i)oobabooga"") OR match(process, ""(?i)text-generation-webui""), ""Oobabooga"",
match(process, ""(?i)transformers"") OR match(process, ""(?i)huggingface""), ""HuggingFace/Transformers"",
match(process, ""(?i)langchain""), ""LangChain"",
1=1, ""Other""
)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table action dest Framework original_file_name parent_process parent_process_exec
parent_process_guid parent_process_id parent_process_name parent_process_path
process process_exec process_guid process_hash process_id process_integrity_level
process_name process_path user user_id vendor_product
| `windows_local_llm_framework_execution_filter`"
Windows Modify Registry Delete Firewall Rules,"The following analytic detects a potential deletion of firewall rules, indicating a possible security breach or unauthorized access attempt. It identifies actions where firewall rules are removed using commands like netsh advfirewall firewall delete rule, which can expose the network to external threats by disabling critical security measures. Monitoring these activities helps maintain network integrity and prevent malicious attacks.",Windows Events,"Execution, Defense Evasion",T1112,"`sysmon` EventCode=12 TargetObject = ""*\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\FirewallRules\\*"" EventType=DeleteValue 
|  stats count min(_time) as firstTime max(_time) as lastTime by action dest process_guid process_id registry_hive registry_path registry_key_name status user vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_delete_firewall_rules_filter`"
Windows Modify Registry to Add or Modify Firewall Rule,"The following analytic detects a potential addition or modification of firewall rules, signaling possible configuration changes or security policy adjustments. It tracks commands such as netsh advfirewall firewall add rule and netsh advfirewall firewall set rule, which may indicate attempts to alter network access controls. Monitoring these actions ensures the integrity of firewall settings and helps prevent unauthorized network access.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\FirewallRules\\*""  Registry.action = modified by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_to_add_or_modify_firewall_rule_filter`"
Windows NetSupport RMM DLL Loaded By Uncommon Process,"The following analytic detects the loading of specific dynamic-link libraries (DLLs) associated with the NetSupport Remote Manager (RMM) tool by any process on a Windows system. Modules such as CryptPak.dll, HTCTL32.DLL, IPCTL32.DLL, keyshowhook.dll, pcicapi.DLL, PCICL32.DLL, and TCCTL32.DLL, are integral to NetSupport's functionality. This detection is particularly valuable when these modules are loaded by processes running from unusual directories (e.",Windows Events,"Execution, Defense Evasion",T1036,"`sysmon`
EventCode=7
ImageLoaded IN (
""*\\CryptPak.dll"",
""*\\HTCTL32.DLL"",
""*\\pcicapi.dll"",
""*\\pcichek.dll"",
""*\\PCICL32.DLL"",
""*\\TCCTL32.DLL""
)
NOT Image IN (""C:\\Program Files\\*"", ""C:\\Program Files (x86)\\*"")
Signature = ""NetSupport Ltd*""
| fillnull
| stats count min(_time) as firstTime max(_time) as lastTime
by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec
process_guid process_hash process_id process_name process_path service_dll_signature_exists
service_dll_signature_verified signature signature_id user_id vendor_product
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_netsupport_rmm_dll_loaded_by_uncommon_process_filter`"
Windows PowerShell FakeCAPTCHA Clipboard Execution,"This detection identifies potential FakeCAPTCHA/ClickFix clipboard hijacking campaigns by looking for PowerShell execution with hidden window parameters and distinctive strings related to fake CAPTCHA verification. These campaigns use social engineering to trick users into pasting malicious PowerShell commands from their clipboard, typically delivering information stealers or remote access trojans.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.",Windows Events,Execution,"T1204, T1059.001, T1059.003, T1204.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where `process_powershell` AND Processes.process=""*-w*h*"" AND ( (Processes.process IN (""*robot*"", ""*captcha*"", ""*verify*"", ""*security check*"", ""*complete verification*"")) OR ( (Processes.process IN (""*iwr *"", ""*Invoke-WebRequest*"", ""*wget *"", ""*curl *"", ""*Net.WebClient*"", ""*DownloadString*"", ""*[Convert]::FromBase64String*"")) AND (Processes.process IN (""*iex*"", ""*Invoke-Expression*"")) AND (Processes.process IN (""*click*"", ""*verify*"", ""*check*"", ""*human*"", ""*bot*"", ""*token*"", ""*challenge*"")) ) OR ( Processes.process=""*clipboard*"" AND Processes.process=""*iex*"" AND (Processes.process=""*FromBase64String*"" OR Processes.process=""*decode*"") ) ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_fakecaptcha_clipboard_execution_filter`"
Windows RDP Connection Successful,"The following analytic detects successful Remote Desktop Protocol (RDP) connections by monitoring EventCode 1149 from the Windows TerminalServices RemoteConnectionManager Operational log. This detection is significant as successful RDP connections can indicate remote access to a system, which may be leveraged by attackers to control or exfiltrate data. If confirmed malicious, this activity could lead to unauthorized access, data theft, or further lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1563.002,"`remoteconnectionmanager` EventCode=1149 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, user_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| rename Computer as dest 
| `windows_rdp_connection_successful_filter`"
Windows RunMRU Registry Key or Value Deleted,"The following analytic detects the deletion or modification of Most Recently Used (MRU) command entries stored within the Windows Registry. Adversaries often clear these registry keys, such as HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU, to remove forensic evidence of commands executed via the Windows Run dialog or other system utilities. This activity aims to obscure their actions, hinder incident response efforts, and evade detection.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU*"" Registry.action = deleted by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_runmru_registry_key_or_value_deleted_filter`"
Windows Scheduled Task with Highest Privileges,The following analytic detects the creation of a new scheduled task with the highest execution privileges via Schtasks.exe. It leverages Endpoint Detection and Response (EDR) logs to monitor for specific command-line parameters ('/rl' and 'highest') in schtasks.exe executions. This activity is significant as it is commonly used in AsyncRAT attacks for persistence and privilege escalation.,Windows Events,"Execution, Persistence, Privilege Escalation",T1053.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime  from datamodel=Endpoint.Processes where Processes.process_name = ""schtasks.exe"" Processes.process = ""*/rl *"" Processes.process = ""* highest *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_scheduled_task_with_highest_privileges_filter`"
Windows NirSoft Tool Bundle File Created,"The following analytic detects the creation of files associated with the NirSoft tool bundles on Windows endpoints. NirSoft is a well-known provider of free, portable utilities that can be used for various system and network tasks. However, threat actors often leverage these tools for malicious purposes, such as credential harvesting, network reconnaissance, and data exfiltration.",Windows Events,Exfiltration,T1588.002,"| tstats `security_content_summariesonly`
count values(Filesystem.file_path) as file_path
min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Filesystem where
``` Increase coverage by adding additional Nirsoft tool bundle or tool filenames ```
Filesystem.file_name IN (
""brtools.zip"",
""mailpv.zip"",
""networktools.zip"",
""passreccommandline.zip"",
""passrecenc.zip"",
""progtools.zip"",
""rdpv.zip"",
""systools.zip"",
""webbrowserpassview.zip""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path
Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(""Filesystem"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_nirsoft_tool_bundle_file_created_filter`"
Windows PowerShell Process Implementing Manual Base64 Decoder,"The following analytic identifies Windows PowerShell processes that implement a manual Base64 decoder. Threat actors often use Base64 encoding to obfuscate malicious payloads or commands within PowerShell scripts. By manually decoding Base64 strings, attackers can evade detection mechanisms that look for standard decoding functions like using the &quot;-enc&quot; flag or the &quot;FromBase64String&quot; function. This detection focuses on PowerShell processes that exhibit characteristics of manual Base64 decoding, such as the presence of specific string manipulation methods and bitwise operations.",Windows Events,"Execution, Defense Evasion","T1059.001, T1027.010","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
`process_powershell`
Processes.process = ""*ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/*""
Processes.process = ""*.Substring(*""
Processes.process = ""*.GetString(*""
Processes.process = ""*.IndexOf(*""
Processes.process IN (""*-shl*"", *-shr*, ""*-bxor*"", ""*-bor*"", ""*-band*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id
Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_powershell_process_implementing_manual_base64_decoder_filter`"
Windows PsTools Recon Usage,"The following analytic identifies execution of Sysinternals PsTools and Sysinternals Suit binaries that are commonly used for reconnaissance and information gathering on Windows endpoints. PsTools (PsExec, PsFile, PsGetSid, PsInfo, PsPing, etc.) or Sysinternals Suit tools, are frequently used by administrators for legitimate maintenance but are also leveraged by threat actors to collect system, account, network and service information during discovery and lateral movement.",Windows Events,"Lateral Movement, Execution, Collection, Discovery","T1046, T1018, T1082","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.process_name IN (
""PsGetsid.exe"",
""PsGetsid64.exe"",
""PsInfo.exe"",
""PsInfo64.exe"",
""pslist.exe"",
""pslist64.exe"",
""PsLoggedon.exe"",
""PsLoggedon64.exe"",
""psloglist.exe"",
""psloglist64.exe"",
""PsPing.exe"",
""PsPing64.exe"",
""PsService.exe"",
""PsService64.exe"",
""Tcpvcon.exe"",
""Tcpvcon64.exe"",
""Tcpvcon64a.exe""
)
OR
Processes.original_file_name IN (
""PsGetSid.exe"",
""Psinfo.exe"",
""pslist.exe"",
""psloggedon.exe"",
""psloglist.exe"",
""psping.exe"",
""psservice.exe"",
""Tcpvcon.exe""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id
Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_pstools_recon_usage_filter`"
Cisco ASA - AAA Policy Tampering,"This analytic detects modifications to authentication and authorization (AAA) security policies on Cisco ASA devices via CLI or ASDM. AAA policies control critical security mechanisms including authentication attempts, lockout thresholds, password policies, and access control settings that protect administrative access to network infrastructure. Adversaries or malicious insiders may weaken authentication policies to facilitate brute force attacks, disable account lockouts to enable unlimited password attempts, reduce password complexity requirements, or modify authorization settings to elevate privileges and maintain persistent access.",Cisco ASA,"Execution, Credential Access",T1556.004,"`cisco_asa`
message_id IN (111008, 111010)
command IN (
""aaa authentication*"",
""aaa authorization*"",
""aaa local authentication*"",
""aaa-server*"",
""no aaa*""
)
| fillnull
| stats count
earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___aaa_policy_tampering_filter`"
Cisco ASA - Device File Copy Activity,"This analytic detects file copy activity on Cisco ASA devices via CLI or ASDM. Adversaries may copy device files including configurations, logs, packet captures, or system files for reconnaissance, credential extraction, or data exfiltration. While legitimate file operations occur during backups and maintenance, unauthorized copies may indicate malicious activity. The detection monitors for command execution events (message ID 111008 or 111010) containing copy commands targeting running-config, startup-config, packet capture files, or other system files from disk0:, flash:, system:, or capture: locations.",Cisco ASA,"Collection, Execution, Exfiltration","T1005, T1530","`cisco_asa`
message_id IN (111008, 111010)
command = ""copy *""
command IN (
""*running-config*"",
""*startup-config*"",
""*/pcap capture:*"",
""* disk0:*"",
""* flash:*"",
""* system:*""
)
| fillnull
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___device_file_copy_activity_filter`"
Cisco ASA - Device File Copy to Remote Location,"This analytic detects file copy operations to remote locations on Cisco ASA devices via CLI or ASDM. Adversaries may exfiltrate device files including configurations, logs, packet captures, or system data to remote servers using protocols like TFTP, FTP, HTTP, HTTPS, SMB, or SCP. While legitimate backups to centralized servers are common, copies to unexpected destinations may indicate data exfiltration to attacker-controlled infrastructure.",Cisco ASA,"Collection, Execution, Exfiltration","T1041, T1005, T1048.003","`cisco_asa`
message_id IN (111008, 111010)
command = ""copy *""
command IN (
""*running-config*"",
""*startup-config*"",
""*/pcap capture:*"",
""* disk0:*"",
""* flash:*"",
""* system:*""
)
command IN (
""*ftp:*"",
""*http:*"",
""*https:*"",
""*smb:*"",
""*scp:*""
)
| eval remote_protocol = mvappend(
if(match(command, ""tftp:""), ""TFTP"", null()),
if(match(command, ""ftp:""), ""FTP"", null()),
if(match(command, ""http:""), ""HTTP"", null()),
if(match(command, ""https:""), ""HTTPS"", null()),
if(match(command, ""smb:""), ""SMB"", null()),
if(match(command, ""scp:""), ""SCP"", null())
)
| fillnull
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(remote_protocol) as remote_protocol
values(src_ip) as src_ip
values(dest) as dest
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___device_file_copy_to_remote_location_filter`"
Cisco ASA - Logging Filters Configuration Tampering,"This analytic detects tampering with logging filter configurations on Cisco ASA devices via CLI or ASDM. Adversaries may reduce logging levels or disable specific log categories to evade detection, hide their activities, or prevent security monitoring systems from capturing evidence of their actions. By lowering logging verbosity, attackers can operate with reduced visibility to security teams.",Cisco ASA,Defense Evasion,T1562,"`cisco_asa`
message_id IN (111008, 111010)
command = ""logging *""
command IN (
""*asdm*"",
""*console*"",
""*history*"",
""*mail*"",
""*monitor*"",
""*trap*""
)
NOT command IN (
""*notifications*"",
""*informational*"",
""*debugging*"",
""* 5*"",
""* 6*"",
""* 7*""
)
| fillnull
| stats count
earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___logging_filters_configuration_tampering_filter`"
Cisco ASA - Logging Message Suppression,"This analytic detects suppression of specific logging messages on Cisco ASA devices using the &quot;no logging message&quot; command. Adversaries may suppress specific log message IDs to selectively disable logging of security-critical events such as authentication failures, configuration changes, or suspicious network activity. This targeted approach allows attackers to evade detection while maintaining normal logging operations that might otherwise alert administrators to complete logging disablement.",Cisco ASA,"Execution, Defense Evasion","T1070, T1562.002","`cisco_asa`
message_id IN (111008, 111010)
command = ""no logging message *""
| fillnull
| stats count
earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___logging_message_suppression_filter`"
Cisco ASA - New Local User Account Created,"This analytic detects creation of new user accounts on Cisco ASA devices via CLI or ASDM. Adversaries may create unauthorized user accounts to establish persistence, maintain backdoor access, or elevate privileges on network infrastructure devices. These rogue accounts can provide attackers with continued access even after initial compromise vectors are remediated. The detection monitors for ASA message ID 502101, which is generated whenever a new user account is created on the device, capturing details including the username, privilege level, and the administrator who created the account.",Cisco ASA,"Persistence, Defense Evasion","T1136.001, T1078.003","`cisco_asa`
message_id IN (502101)
| fillnull
| stats count earliest(_time) as firstTime
latest(_time) as lastTime
values(action) as action
values(message_id) as message_id
values(result) as result
values(privilege_level) as privilege_level
by host user
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___new_local_user_account_created_filter`"
Cisco ASA - Packet Capture Activity,"This analytic detects execution of packet capture commands on Cisco ASA devices via CLI or ASDM. Adversaries may abuse the built-in packet capture functionality to perform network sniffing, intercept credentials transmitted over the network, capture sensitive data in transit, or gather intelligence about network traffic patterns and internal communications. Packet captures can reveal usernames, passwords, session tokens, and confidential business data.",Cisco ASA,"Execution, Credential Access, Discovery","T1557, T1040","`cisco_asa`
message_id IN (111008, 111010)
command IN (""capture *"")
| fillnull
| stats count
earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___packet_capture_activity_filter`"
Cisco ASA - Reconnaissance Command Activity,"This analytic detects potential reconnaissance activities on Cisco ASA devices by identifying execution of multiple information-gathering &quot;show&quot; commands within a short timeframe. Adversaries who gain initial access to network infrastructure devices typically perform systematic reconnaissance to understand the device configuration, network topology, security policies, connected systems, and potential attack paths. This reconnaissance phase involves executing multiple &quot;show&quot; commands to enumerate device details, running configurations, active connections, routing information, and VPN sessions.",Cisco ASA,"Initial Access, Execution, Discovery","T1590.005, T1590.001, T1082","`cisco_asa`
message_id IN (111009)
command IN (
""show access-list*"",
""show capture*"",
""show conn*"",
""show cpu*"",
""show crypto*"",
""show eigrp*"",
""show failover*"",
""show flow*"",
""show interface*"",
""show inventory*"",
""show ip*"",
""show license*"",
""show memory*"",
""show nat*"",
""show ospf*"",
""show process*"",
""show running-config*"",
""show startup-config*"",
""show version*"",
""show vpn-sessiondb*"",
""show xlate*""
)
| fillnull"
Cisco ASA - User Account Deleted From Local Database,"This analytic detects deletion of user accounts from Cisco ASA devices via CLI or ASDM. Adversaries may delete local accounts to cover their tracks, remove evidence of their activities, disrupt incident response efforts, or deny legitimate administrator access during an attack. Account deletion can also indicate an attempt to hide the creation of temporary accounts used during compromise.",Cisco ASA,"Impact, Defense Evasion","T1070.008, T1531","`cisco_asa`
message_id IN (502102)
| fillnull
| stats count earliest(_time) as firstTime
latest(_time) as lastTime
values(action) as action
values(message_id) as message_id
values(result) as result
values(privilege_level) as privilege_level
by host user
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___user_account_deleted_from_local_database_filter`"
Cisco ASA - User Account Lockout Threshold Exceeded,"This analytic detects user account lockouts on Cisco ASA devices resulting from excessive failed authentication attempts. Account lockouts may indicate brute force attacks, password spraying campaigns, credential stuffing attempts using compromised credentials from external breaches, or misconfigured automation attempting authentication with incorrect credentials. These activities represent attempts to gain unauthorized access to network infrastructure.",Cisco ASA,Credential Access,"T1110.003, T1110.001","`cisco_asa`
message_id IN (113006)
| rex ""locked out on exceeding '(?<attempts_count>\d+)' successive failed authentication attempts""
| rex ""User '(?<user>[^']+)' locked out""
| eval failure_description=""locked out on exceeding "" . attempts_count . "" successive failed authentication attempts""
| fillnull
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(message_id) as message_id
values(failure_description) as failure_description
by host user
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___user_account_lockout_threshold_exceeded_filter`"
Cisco ASA - User Privilege Level Change,"This analytic detects privilege level changes for user accounts on Cisco ASA devices via CLI or ASDM. Adversaries may escalate account privileges to gain elevated access to network infrastructure, enable additional command execution capabilities, or establish higher-level persistent access. Privilege levels on Cisco ASA range from 0 (lowest) to 15 (full administrative access), with level 15 providing complete device control.",Cisco ASA,"Initial Access, Execution, Privilege Escalation, Defense Evasion","T1098, T1078.003","`cisco_asa`
message_id IN (502103)
| fillnull
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(action) as action
values(message_id) as message_id
values(old_privilege_level) as old_privilege_level
values(new_privilege_level) as new_privilege_level
by host user
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___user_privilege_level_change_filter`"
Linux apt-get Privilege Escalation,"The following analytic detects the execution of the 'apt-get' command with elevated privileges using 'sudo' on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a user may be attempting to escalate privileges to root, which could lead to unauthorized system control.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*apt-get*"" AND Processes.process=""*APT::Update::Pre-Invoke::*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_apt_get_privilege_escalation_filter`"
Suspicious mshta child process,"The following analytic identifies child processes spawned from &quot;mshta.exe&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific child processes like &quot;powershell.exe&quot; and &quot;cmd.exe&quot;. This activity is significant because &quot;mshta.exe&quot; is often exploited by attackers to execute malicious scripts or commands. If confirmed malicious, this behavior could allow an attacker to execute arbitrary code, escalate privileges, or maintain persistence within the environment.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=mshta.exe AND Processes.process_name IN (""powershell.exe"",""colorcpl.exe"", ""msbuild.exe"", ""microsoft.workflow.compiler.exe"", ""searchprotocolhost.exe"", ""scrcons.exe"", ""cscript.exe"", ""wscript.exe"", ""cmd.exe"", ""bitsadmin.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_mshta_child_process_filter`"
DNS Kerberos Coercion,"Detects DNS-based Kerberos coercion attacks where adversaries inject marshaled credential structures into DNS records to spoof SPNs and redirect authentication such as in CVE-2025-33073. This detection leverages suricata looking for specific CREDENTIAL_TARGET_INFORMATION structures in DNS queries.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution where DNS.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Collection, Credential Access, Command And Control, Privilege Escalation","T1557.001, T1187, T1071.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution where DNS.query=""*1UWhRC*"" DNS.query=""*AAAAA*"" DNS.query=""*YBAAAA*"" by DNS.answer DNS.answer_count DNS.query DNS.query_count DNS.reply_code_id DNS.src DNS.vendor_product 
| `drop_dm_object_name(DNS)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime lastTime query count src dest 
| `dns_kerberos_coercion_filter`"
Windows Credential Target Information Structure in Commandline,"Detects DNS-based Kerberos coercion attacks where adversaries inject marshaled credential structures into DNS records to spoof SPNs and redirect authentication such as in CVE-2025-33073. This detection leverages process creation events looking for specific CREDENTIAL_TARGET_INFORMATION structures.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=&#34;*1UWhRCA*&#34; Processes.process=&#34;*AAAAA*&#34; Processes.process=&#34;*YBAAAA*&#34; by Processes.",Windows Events,"Command And Control, Execution, Credential Access, Collection, Privilege Escalation","T1557.001, T1187, T1071.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*1UWhRCA*"" Processes.process=""*AAAAA*"" Processes.process=""*YBAAAA*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credential_target_information_structure_in_commandline_filter`"
Windows Short Lived DNS Record,"The following analytic identifies the creation and quick deletion of a DNS object within 300 seconds in an Active Directory environment, indicative of a potential attack abusing DNS. This detection leverages Windows Security Event Codes 5136 and 5137, analyzing the duration between these events. This activity is significant as temporary DNS entries allows attackers to cause unexpecting network trafficking, leading to potential compromise.",Windows Events,"Collection, Credential Access, Command And Control, Privilege Escalation","T1557.001, T1187, T1071.004","`wineventlog_security` ((EventCode=5137  ObjectClass=""dnsNode"") OR (EventCode=5136 ObjectClass=""dnsNode"" AttributeLDAPDisplayName=""dNSTombstoned"" AttributeValue=""TRUE"")) 
| stats min(_time) as firstTime max(_time) as lastTime values(EventCode) as event_codes values(ObjectDN) as dns_record values(SubjectUserName) as user values(Computer) as dest by ObjectGUID 
| where mvcount(event_codes)=2 
| eval time_diff=lastTime - firstTime 
| where time_diff <= 300 
| table firstTime, lastTime, dns_record, user, dest, time_diff, ObjectGUID 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_short_lived_dns_record_filter`"
LLM Model File Creation,"Detects the creation of Large Language Model (LLM) files on Windows endpoints by monitoring file creation events for specific model file formats and extensions commonly used by local AI frameworks. This detection identifies potential shadow AI deployments, unauthorized model downloads, and rogue LLM infrastructure by detecting file creation patterns associated with quantized models (.gguf, .",Windows Events,"Persistence, Exfiltration",T1543,"| tstats `security_content_summariesonly` count
min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Filesystem
where Filesystem.file_name IN (
""*.gguf*"",
""*ggml*"",
""*Modelfile*"",
""*safetensors*""
)
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path
Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id
Filesystem.user Filesystem.vendor_product
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `llm_model_file_creation_filter`"
Local LLM Framework DNS Query,"Detects DNS queries related to local LLM models on endpoints by monitoring Sysmon DNS query events (Event ID 22) for known LLM model domains and services. Local LLM frameworks like Ollama, LM Studio, and GPT4All make DNS calls to repositories such as huggingface.co and ollama.ai for model downloads, updates, and telemetry. These queries can reveal unauthorized AI tool usage or data exfiltration risks on corporate networks.",Windows Events,Exfiltration,T1590,"`sysmon`
EventCode=22
QueryName IN (
""*huggingface*"",
""*ollama*"",
""*jan.ai*"",
""*gpt4all*"",
""*nomic*"",
""*koboldai*"",
""*lmstudio*"",
""*modelscope*"",
""*civitai*"",
""*oobabooga*"",
""*replicate*"",
""*anthropic*"",
""*openai*"",
""*openrouter*"",
""*api.openrouter*"",
""*aliyun*"",
""*alibabacloud*"",
""*dashscope.aliyuncs*""
)
NOT Image IN (
""*\\MsMpEng.exe"",
""C:\\ProgramData\\*"",
""C:\\Windows\\System32\\*"",
""C:\\Windows\\SysWOW64\\*""
)
| stats count
min(_time) as firstTime
max(_time) as lastTime
by src Image process_name QueryName query_count answer answer_count reply_code_id vendor_product
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `local_llm_framework_dns_query_filter`"
Windows Kerberos Coercion via DNS,"Detects DNS-based Kerberos coercion attacks where adversaries inject marshaled credential structures into DNS records to spoof SPNs and redirect authentication such as in CVE-2025-33073. This detection leverages Windows Security Event Codes 5136, 5137, 4662, looking for DNS events with specific CREDENTIAL_TARGET_INFORMATION entries.
Search 1`wineventlog_security` (((EventCode=&#34;5136&#34; OR EventCode=&#34;5137&#34;) ObjectClass=&#34;dnsNode&#34; ObjectDN=&#34;*1UWhRCA*&#34; ObjectDN=&#34;*AAAAA*&#34; ObjectDN=&#34;*YBAAAA*&#34;) OR (EventCode=&#34;4662&#34; AdditionalInfo=&#34;*1UWhRCA*&#34; AdditionalInfo=&#34;*AAAAA*&#34; AdditionalInfo=&#34;*YBAAAA*&#34;)) 2| eval Object=coalesce(lower(ObjectGUID), trim(AdditionalInfo2, &#34;%{}&#34;)) 3| eval user=coalesce(SubjectUserName, Caller_User_Name) 4| stats min(_time) as firstTime, max(_time) as lastTime values(EventCode) as event_codes values(ObjectDN) as dns_record values(user) as user values(Computer) as dest by Object 5| `security_content_ctime(firstTime)` 6| `security_content_ctime(lastTime)` 7| `windows_kerberos_coercion_via_dns_filter` Data Source Name Platform Sourcetype Source Windows Event Log Security 4662 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Windows Event Log Security 5136 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Windows Event Log Security 5137 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Macros Used Name Value security_content_ctime convert timeformat=&quot;%Y-%m-%dT%H:%M:%S&quot; ctime($field$) windows_kerberos_coercion_via_dns_filter search * windows_kerberos_coercion_via_dns_filter is an empty macro by default.",Windows Events,"Collection, Credential Access, Command And Control, Privilege Escalation","T1557.001, T1187, T1071.004","`wineventlog_security`  (((EventCode=""5136"" OR EventCode=""5137"") ObjectClass=""dnsNode"" ObjectDN=""*1UWhRCA*"" ObjectDN=""*AAAAA*"" ObjectDN=""*YBAAAA*"") OR (EventCode=""4662"" AdditionalInfo=""*1UWhRCA*"" AdditionalInfo=""*AAAAA*"" AdditionalInfo=""*YBAAAA*"")) 
| eval Object=coalesce(lower(ObjectGUID), trim(AdditionalInfo2, ""%{}"")) 
| eval user=coalesce(SubjectUserName, Caller_User_Name) 
| stats min(_time) as firstTime, max(_time) as lastTime values(EventCode) as event_codes values(ObjectDN) as dns_record values(user) as user values(Computer) as dest by Object 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_kerberos_coercion_via_dns_filter`"
Windows Svchost.exe Parent Process Anomaly,"The following analytic detects an anomaly where an svchost.exe process is spawned by a parent process other than the standard services.exe. In a typical Windows environment, svchost.exe is a system process that hosts Windows service DLLs, and is expected to be a child of services.exe. A process deviation from this hierarchy may indicate suspicious behavior, such as malicious code attempting to masquerade as a legitimate system process or evade detection.",Windows Events,"Execution, Defense Evasion","T1036, T1036.009","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name != ""services.exe"" AND Processes.process_name = ""svchost.exe"" AND Processes.process != unknown AND Processes.parent_process_path != ""C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*\\MsMpEng.exe"" AND Processes.parent_process_path != ""C:\\Program Files\\Windows Defender\\MsMpEng.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_svchost_exe_parent_process_anomaly_filter`"
Windows Kerberos Local Successful Logon,"The following analytic identifies a local successful authentication event on a Windows endpoint using the Kerberos package. It detects EventCode 4624 with LogonType 3 and source address 127.0.0.1, indicating a login to the built-in local Administrator account. This activity is significant as it may suggest a Kerberos relay attack, a method attackers use to escalate privileges.",Windows Events,"Credential Access, Privilege Escalation",T1558,"`wineventlog_security`  EventCode=4624 LogonType=3 AuthenticationPackageName=Kerberos action=success src=127.0.0.1  
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by action app authentication_method dest dvc process process_id process_name process_path signature signature_id src src_port status subject user user_group vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_kerberos_local_successful_logon_filter`"
Microsoft Defender Incident Alerts,"The following analytic is to leverage alerts from Microsoft Defender O365 Incidents. This query aggregates and summarizes all alerts from Microsoft Defender O365 Incidents, providing details such as the destination, file name, severity, process command line, ip address, registry key, signature, description, unique id, and timestamps. This detection is not intended to detect new activity from raw data, but leverages Microsoft provided alerts to be correlated with other data as part of risk based alerting.",Office 365 (Microsoft 365),,,"`ms365_defender_incident_alerts`  (dest=* OR user=*) 
| eval tmp_entities=json_extract(_raw, ""entities""), tmp_entitymv=json_array_to_mv(tmp_entities), tmp_filtered_mv=mvfilter(json_extract(tmp_entitymv, ""verdict"") != ""Clean""), entityType = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""entityType"")), filePath = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""filePath"")), processCommandLine = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""processCommandLine"")), ipAddress = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""ipAddress"")), registryKey = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""registryKey"")), url = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""url"")) 
| eval tmp_filtered_mv=mvfilter(json_extract(tmp_filtered_mv, ""entityType"") = ""File""), fileName = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, ""fileName"")) 
| eval risk_score=case(severity=""informational"", 5, severity=""low"", 15, severity=""medium"", 25, severity=""high"", 50, true(), 2) 
| stats count  min(_time) as firstTime max(_time) as lastTime values(fileName) as file_name values(severity) as severity values(processCommandLine) as process values(ipAddress) as ip_address values(registryKey) as registry_key values(url) as url values(mitreTechniques{}) as annotations.mitre_attack.mitre_technique_id values(signature) as signature values(dest) as dest values(user) as user values(risk_score) as risk_score by id description 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `microsoft_defender_incident_alerts_filter`"
Cisco NVM - Suspicious Network Connection to IP Lookup Service API,"This analytic identifies non-browser processes reaching out to public IP lookup or geolocation services, such as ipinfo.io, icanhazip.com, ip-api.com, and others. These domains are commonly used by legitimate tools, but their usage outside of browsers may indicate network reconnaissance, virtual machine detection, or staging by malware. This activity is observed in post-exploitation frameworks, stealer malware, and advanced threat actor campaigns.",Cisco NVM,Discovery,"T1590.005, T1016","`cisco_network_visibility_module_flowdata`
dest_hostname IN (
""*api.2ip.ua*"", ""*api.bigdatacloud.net*"", ""*api.ipify.org*"", ""*whatismyipaddress.com*"",
""*canireachthe.net*"", ""*checkip.amazonaws.com*"", ""*checkip.dyndns.org*"", ""*curlmyip.com*"",
""*db-ip.com*"", ""*edns.ip-api.com*"", ""*eth0.me*"", ""*freegeoip.app*"", ""*geoipy.com*"", ""*getip.pro*"",
""*icanhazip.com*"", ""*ident.me*"", ""*ifconfig.io*"", ""*ifconfig.me*"", ""*ip-api.com*"", ""*ip.360.cn*"",
""*ip.anysrc.net*"", ""*ip.taobao.com*"", ""*ip.tyk.nu*"", ""*ipaddressworld.com*"", ""*ipapi.co*"",
""*ipconfig.io*"", ""*ipecho.net*"", ""*ipinfo.io*"", ""*ipip.net*"", ""*iplocation.net*"",
""*ipof.in*"", ""*ipv6-test.com*"", ""*ipwho.is*"", ""*trackip.net*"", ""*inet-ip.info*"",
""*jsonip.com*"", ""*myexternalip.com*"", ""*seeip.org*"",  ""*wgetip.com*"",
""*whatismyip.akamai.com*"", ""*whois.pconline.com.cn*"", ""*wtfismyip.com*"", ""*ip.cn""
)
NOT process_name IN (
""brave.exe"", ""chrome.exe"", ""firefox.exe"", ""iexplore.exe"", ""maxthon.exe"",
""MicrosoftEdge.exe"", ""msedge.exe"", ""msedgewebview2.exe"", ""opera.exe"", ""safari.exe"",
""seamonkey.exe"", ""vivaldi.exe"", ""whale.exe""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___suspicious_network_connection_to_ip_lookup_service_api_filter`"
Windows Anonymous Pipe Activity,"The following analytic detects the creation or connection of anonymous pipes for inter-process communication (IPC) within a Windows environment. Anonymous pipes are commonly used by legitimate system processes, services, and applications to transfer data between related processes. However, adversaries frequently abuse anonymous pipes to facilitate stealthy process injection, command-and-control (C2) communication, credential theft, or privilege escalation.",Windows Events,"Lateral Movement, Execution, Persistence, Privilege Escalation",T1559,"`sysmon` EventCode IN (17,18) EventType IN ( ""CreatePipe"", ""ConnectPipe"") PipeName=""*Anonymous Pipe*"" NOT( Image IN (""C:\\Program Files*"", ""C:\\Windows\\system32\\*"",""C:\\Windows\\syswow64\\*"")) 
| stats  min(_time) as firstTime max(_time) as lastTime count by dest EventCode PipeName ProcessGuid ProcessId Image EventType 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_anonymous_pipe_activity_filter`"
Windows Browser Process Launched with Unusual Flags,"The following analytic detects the use of unusual browser flags, specifically --mute-audio and --do-not-elevate, which deviate from standard browser launch behavior. These flags may indicate automated scripts, testing environments, or attempts to modify browser functionality for silent operation or restricted privilege execution. Detection focuses on non-standard launch parameters, unexpected process behavior, or deviations from baseline configurations.",Windows Events,"Collection, Execution",T1185,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where NOT (Processes.parent_process_name IN (""chrome.exe"", ""msedge.exe"", ""brave.exe"", ""firefox.exe"", ""explorer.exe"")) AND NOT (Processes.parent_process_path IN(""C:\\Program Files*"", ""C:\\Windows\\System32\\*"", ""C:\\Windows\\SysWow64\\*"",)) AND Processes.process_name IN (""chrome.exe"", ""msedge.exe"", ""brave.exe"", ""firefox.exe"") AND Processes.process IN (""*--mute-audio*"",""*--no-de-elevate*"", ""*--do-not-de-elevate*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_browser_process_launched_with_unusual_flags_filter`"
Windows Disable or Stop Browser Process,"The following analytic detects the use of the taskkill command in a process command line to terminate several known browser processes, a technique commonly employed by the Braodo stealer malware to steal credentials. By forcefully closing browsers like Chrome, Edge, and Firefox, the malware can unlock files that store sensitive information, such as passwords and login data.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*taskkill*"" Processes.process IN(""*chrome.exe"",""*firefox.exe"",""*brave.exe"",""*opera.exe"",""*msedge.exe"",""*chromium.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_or_stop_browser_process_filter`"
Windows Handle Duplication in Known UAC-Bypass Binaries,"The following analytic detects suspicious handle duplication activity targeting known Windows utilities such as ComputerDefaults.exe, Eventvwr.exe, and others. This technique is commonly used to escalate privileges or bypass UAC by inheriting or injecting elevated tokens or handles. The detection focuses on non-standard use of DuplicateHandle or token duplication where process, thread, or token handles are copied into the context of trusted, signed utilities.",Windows Events,Defense Evasion,T1134.001,"`sysmon` EventCode=10 TargetImage IN(""*\\ComputerDefaults.exe"", ""*\\eventvwr.exe*"", ""*\\fodhelper.exe"",""*\\slui.exe"",""*\\sdclt.exe"",""*\\mmc.exe"", ""*\\colorcpl.exe"",""*\\wsreset.exe"",""*\\esentutl.exe"", ""*\PkgMgr.exe"") AND NOT (SourceImage IN (""*C:\\Windows\\system32\\*"",""*C:\\Windows\\syswow64\\*"",""*C:\\Program Files\\*"", ""*C:\\Program Files (x86)\\*"",""%systemroot%\\*"")) 
| eval g_access_decimal = tonumber(replace(GrantedAccess,""0x"",""""),16) 
| eval PROCESS_DUP_HANDLE = 64 
| eval dup_handle_set = bit_and (g_access_decimal, PROCESS_DUP_HANDLE) 
| where dup_handle_set == PROCESS_DUP_HANDLE 
| stats count min(_time) as firstTime max(_time) as lastTime by SourceImage TargetImage GrantedAccess PROCESS_DUP_HANDLE g_access_decimal dup_handle_set Guid Opcode ProcessID SecurityID SourceProcessGUID SourceProcessId  TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product CallTrace EventID 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_handle_duplication_in_known_uac_bypass_binaries_filter`"
Windows Scheduled Task with Suspicious Name,"The following analytic detects the creation, modification, or enabling of scheduled tasks with known suspicious or malicious task names. It leverages Windows Security EventCode 4698, 4700, and 4702 to identify when such tasks are registered, modified, or enabled. This activity is significant as it may indicate an attempt to establish persistence or execute malicious commands on a system.",Windows Events,"Execution, Persistence","T1053.005, T1053","`wineventlog_security` EventCode IN (4698,4700,4702)
| eval TaskContent = case(isnotnull(TaskContentNew),TaskContentNew,true(),TaskContent)
| xmlkv TaskContent
| stats count min(_time) as firstTime max(_time) as lastTime latest(Arguments) as Arguments latest(Author) as Author by Computer, TaskName, Command, Enabled, Hidden,Caller_User_Name, EventCode
| lookup windows_suspicious_tasks task_name as TaskName 
| where isnotnull(tool_type)
| eval command=TaskName, process=Command+if(isnotnull(Arguments),"" "".Arguments,""""), src_user=Author, user = Caller_User_Name, dest = Computer
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_scheduled_task_with_suspicious_name_filter`"
Windows UAC Bypass Suspicious Child Process,"The following analytic detects when an executable known for User Account Control (UAC) bypass exploitation spawns a child process in a user-controlled location or a command shell executable (e.g., cmd.exe, powershell.exe). This detection leverages Sysmon EventID 1 data, focusing on high or system integrity level processes with specific parent-child process relationships. This activity is significant as it may indicate an attacker has successfully used a UAC bypass exploit to escalate privileges.",Windows Events,Defense Evasion,"T1548, T1548.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""high"",""system"") AND Processes.parent_process_name IN (`uacbypass_process_name`) AND (Processes.process_name IN (""cmd.exe"",""powershell.exe"",""pwsh.exe"",""wscript"",""cscript.exe"",""bash.exe"",""werfault.exe"") OR Processes.process IN (""*\\\\*"",""*\\Users\\*"",""*\\ProgramData\\*"",""*\\Temp\\*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| where parent_process_name != process_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_uac_bypass_suspicious_child_process_filter`"
WinEvent Scheduled Task Created to Spawn Shell,"The following analytic detects the creation of scheduled tasks designed to execute commands using native Windows shells like PowerShell, Cmd, Wscript, or Cscript. It leverages Windows Security EventCode 4698 to identify when such tasks are registered. This activity is significant as it may indicate an attempt to establish persistence or execute malicious commands on a system.",Windows Events,"Execution, Persistence",T1053.005,"`wineventlog_security` EventCode=4698 TaskContent IN (""*powershell.exe*"", ""*wscript.exe*"", ""*cscript.exe*"", ""*cmd.exe*"", ""*sh.exe*"", ""*ksh.exe*"", ""*zsh.exe*"", ""*bash.exe*"", ""*scrcons.exe*"", ""*pwsh.exe*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, TaskName, TaskContent 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `winevent_scheduled_task_created_to_spawn_shell_filter`"
Windows Gather Victim Network Info Through Ip Check Web Services,"The following analytic detects processes attempting to connect to known IP check web services. This behavior is identified using Sysmon EventCode 22 logs, specifically monitoring DNS queries to services like &quot;wtfismyip.com&quot; and &quot;ipinfo.io&quot;. This activity is significant as it is commonly used by malware, such as Trickbot, for reconnaissance to determine the infected machine's IP address.",Windows Events,Lateral Movement,T1590.005,"`sysmon` EventCode=22  QueryName IN (""*wtfismyip.com"", ""*checkip.*"", ""*ipecho.net"", ""*ipinfo.io"", ""*api.ipify.org"", ""*icanhazip.com"", ""*ip.anysrc.com"",""*api.ip.sb"", ""ident.me"", ""www.myexternalip.com"", ""*zen.spamhaus.org"", ""*cbl.abuseat.org"", ""*b.barracudacentral.org"", ""*dnsbl-1.uceprotect.net"", ""*spam.dnsbl.sorbs.net"", ""*iplogger.org*"", ""*ip-api.com*"", ""*geoip.*"", ""*icanhazip.*"", ""*ipwho.is*"", ""*ifconfig.me*"", ""*myip.com*"", ""*ipstack.com*"", ""*myexternalip.com*"", ""*ip-api.io*"", ""*trackip.net*"", ""*ipgeolocation.io*"", ""*ipfind.io*"", ""*freegeoip.app*"", ""*ipv4bot.whatismyipaddress.com*"") 
|  stats  min(_time) as firstTime max(_time) as lastTime count by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_gather_victim_network_info_through_ip_check_web_services_filter`"
Linux Curl Upload File,"The following analytic detects the use of the curl command with specific switches (-F, --form, --upload-file, -T, -d, --data, --data-raw, -I, --head) to upload AWS credentials or configuration files to a remote destination. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it may indicate an attempt to exfiltrate sensitive AWS credentials, a technique known to be used by the TeamTNT group.",Linux,"Command And Control, Execution, Exfiltration",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=curl Processes.process IN (""*-F *"", ""*--form *"",""*--upload-file *"",""*-T *"",""*-d *"",""*--data *"",""*--data-raw *"", ""*-I *"", ""*--head *"") AND Processes.process IN (""*.aws/credentials*"". ""*.aws/config*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_curl_upload_file_filter`"
Linux Ingress Tool Transfer Hunting,"The following analytic detects the use of 'curl' and 'wget' commands within a Linux environment. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, user information, and command-line executions. This activity is significant as 'curl' and 'wget' are commonly used for downloading files, which can indicate potential ingress of malicious tools.",Linux,"Command And Control, Execution, Exfiltration",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=curl OR Processes.process_name=wget) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_ingress_tool_transfer_hunting_filter`"
Windows Default RDP File Creation By Non MSTSC Process,"This detection monitors the creation or modification of the Default.rdp file by non mstsc.exe process, typically found in the user's Documents folder. This file is automatically generated or updated by the Remote Desktop Connection client (mstsc.exe) when a user initiates an RDP session. It stores connection settings such as the last-used hostname, screen size, and other preferences.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name != mstsc.exe by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
|rename process_guid as proc_guid 
| join proc_guid, _time [ 
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name=default.rdp by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
|rename process_guid as proc_guid 
| fields _time dest file_create_time file_name file_path process_name process_path process proc_guid] 
| dedup file_create_time 
| table dest, process_name, process, file_create_time, file_name, file_path, proc_guid 
| `windows_default_rdp_file_creation_by_non_mstsc_process_filter`"
Cisco NVM - Curl Execution With Insecure Flags,"This analytic detects the use of curl.exe with insecure flags such as -k, --insecure, --proxy-insecure, or --doh-insecure which disable TLS certificate validation. It leverages Cisco Network Visibility Module (NVM) flow data and process arguments to identify outbound connections initiated by curl where TLS checks were explicitly disabled. This behavior may indicate an attempt to bypass certificate validation to connect to potentially untrusted or malicious endpoints, a common tactic in red team operations, malware staging, or data exfiltration over HTTPS.",Cisco NVM,"Execution, Exfiltration, Defense Evasion",T1197,"`cisco_network_visibility_module_flowdata`
process_name = ""curl.exe""
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
| regex process_arguments=""(?i)(?<!\w)-(?:[a-z]*k[a-z]*
|-(insecure
|proxy-insecure
|doh-insecure))""
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___curl_execution_with_insecure_flags_filter`"
Malicious PowerShell Process - Encoded Command,"The following analytic detects the use of the EncodedCommand parameter in PowerShell processes. It leverages Endpoint Detection and Response (EDR) data to identify variations of the EncodedCommand parameter, including shortened forms and different command switch types. This activity is significant because adversaries often use encoded commands to obfuscate malicious scripts, making detection harder.",Windows Events,"Lateral Movement, Execution, Privilege Escalation, Defense Evasion","T1059.001, T1027","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process,""(?i)[\-
|\/
|â€“
|â€”
|â€•][Ee^]{1,2}[NnCcOoDdEeMmAa^]+\s+[\""]?[A-Za-z0-9+/=]{5,}[\""]?"") 
| `malicious_powershell_process___encoded_command_filter`"
Possible Lateral Movement PowerShell Spawn,"The following analytic detects the spawning of a PowerShell process as a child or grandchild of commonly abused processes like services.exe, wmiprvse.exe, svchost.exe, wsmprovhost.exe, and mmc.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process names, as well as command-line executions. This activity is significant as it often indicates lateral movement or remote code execution attempts by adversaries.",Windows Events,"Lateral Movement, Execution, Persistence, Privilege Escalation","T1059.001, T1218.014, T1021.006, T1543.003, T1053, T1053.005, T1021.003, T1047, T1021, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=wmiprvse.exe OR Processes.parent_process_name=services.exe OR Processes.parent_process_name=svchost.exe OR Processes.parent_process_name=wsmprovhost.exe OR Processes.parent_process_name=mmc.exe) (Processes.process_name=powershell.exe OR (Processes.process_name=cmd.exe AND Processes.process=*powershell.exe*) OR Processes.process_name=pwsh.exe OR (Processes.process_name=cmd.exe AND Processes.process=*pwsh.exe*)) NOT (Processes.process IN (""*c:\\windows\\ccm\\*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `possible_lateral_movement_powershell_spawn_filter`"
PowerShell 4104 Hunting,"The following analytic identifies suspicious PowerShell execution using Script Block Logging (EventCode 4104). It leverages specific patterns and keywords within the ScriptBlockText field to detect potentially malicious activities. This detection is significant for SOC analysts as PowerShell is commonly used by attackers for various malicious purposes, including code execution, privilege escalation, and persistence. If confirmed malicious, this activity could allow attackers to execute arbitrary commands, exfiltrate data, or maintain long-term access to the compromised system, posing a severe threat to the organization's security.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Exfiltration",T1059.001,"`powershell` EventCode=4104 
| eval DoIt = if(match(ScriptBlockText,""(?i)(\$doit)""), ""4"", 0) 
| eval enccom=if(match(ScriptBlockText,""[A-Za-z0-9+\/]{44,}([A-Za-z0-9+\/]{4}
|[A-Za-z0-9+\/]{3}=
|[A-Za-z0-9+\/]{2}==)"") OR match(ScriptBlockText, ""(?i)[-]e(nc*o*d*e*d*c*o*m*m*a*n*d*)*\s+[^-]""),4,0) 
| eval suspcmdlet=if(match(ScriptBlockText, ""(?i)Add-Exfiltration
|Add-Persistence
|Add-RegBackdoor
|Add-ScrnSaveBackdoor
|Check-VM
|Do-Exfiltration
|Enabled-DuplicateToken
|Exploit-Jboss
|Find-Fruit
|Find-GPOLocation
|Find-TrustedDocuments
|Get-ApplicationHost
|Get-ChromeDump
|Get-ClipboardContents
|Get-FoxDump
|Get-GPPPassword
|Get-IndexedItem
|Get-Keystrokes
|LSASecret
|Get-PassHash
|Get-RegAlwaysInstallElevated
|Get-RegAutoLogon
|Get-RickAstley
|Get-Screenshot
|Get-SecurityPackages
|Get-ServiceFilePermission
|Get-ServicePermission
|Get-ServiceUnquoted
|Get-SiteListPassword
|Get-System
|Get-TimedScreenshot
|Get-UnattendedInstallFile
|Get-Unconstrained
|Get-VaultCredential
|Get-VulnAutoRun
|Get-VulnSchTask
|Gupt-Backdoor
|HTTP-Login
|Install-SSP
|Install-ServiceBinary
|Invoke-ACLScanner
|Invoke-ADSBackdoor
|Invoke-ARPScan
|Invoke-AllChecks
|Invoke-BackdoorLNK
|Invoke-BypassUAC
|Invoke-CredentialInjection
|Invoke-DCSync
|Invoke-DllInjection
|Invoke-DowngradeAccount
|Invoke-EgressCheck
|Invoke-Inveigh
|Invoke-InveighRelay
|Invoke-Mimikittenz
|Invoke-NetRipper
|Invoke-NinjaCopy
|Invoke-PSInject
|Invoke-Paranoia
|Invoke-PortScan
|Invoke-PoshRat
|Invoke-PostExfil
|Invoke-PowerDump
|Invoke-PowerShellTCP
|Invoke-PsExec
|Invoke-PsUaCme
|Invoke-ReflectivePEInjection
|Invoke-ReverseDNSLookup
|Invoke-RunAs
|Invoke-SMBScanner
|Invoke-SSHCommand
|Invoke-Service
|Invoke-Shellcode
|Invoke-Tater
|Invoke-ThunderStruck
|Invoke-Token
|Invoke-UserHunter
|Invoke-VoiceTroll
|Invoke-WScriptBypassUAC
|Invoke-WinEnum
|MailRaider
|New-HoneyHash
|Out-Minidump
|Port-Scan
|PowerBreach
|PowerUp
|PowerView
|Remove-Update
|Set-MacAttribute
|Set-Wallpaper
|Show-TargetScreen
|Start-CaptureServer
|VolumeShadowCopyTools
|NEEEEWWW
|(Computer
|User)Property
|CachedRDPConnection
|get-net\S+
|invoke-\S+hunter
|Install-Service
|get-\S+(credent
|password)
|remoteps
|Kerberos.*(policy
|ticket)
|netfirewall
|Uninstall-Windows
|Verb\s+Runas
|AmsiBypass
|nishang
|Invoke-Interceptor
|EXEonRemote
|NetworkRelay
|PowerShelludp
|PowerShellIcmp
|CreateShortcut
|copy-vss
|invoke-dll
|invoke-mass
|out-shortcut
|Invoke-ShellCommand""),1,0) 
| eval base64 = if(match(lower(ScriptBlockText),""frombase64""), ""4"", 0) 
| eval empire=if(match(lower(ScriptBlockText),""system.net.webclient"") AND match(lower(ScriptBlockText), ""frombase64string"") ,5,0) 
| eval mimikatz=if(match(lower(ScriptBlockText),""mimikatz"") OR match(lower(ScriptBlockText), ""-dumpcr"") OR match(lower(ScriptBlockText), ""SEKURLSA::Pth"") OR match(lower(ScriptBlockText), ""kerberos::ptt"") OR match(lower(ScriptBlockText), ""kerberos::golden"") ,5,0) 
| eval iex=if(match(ScriptBlockText, ""(?i)iex
|invoke-expression""),2,0) 
| eval webclient=if(match(lower(ScriptBlockText),""http"") OR match(lower(ScriptBlockText),""web(client
|request)"") OR match(lower(ScriptBlockText),""socket"") OR match(lower(ScriptBlockText),""download(file
|string)"") OR match(lower(ScriptBlockText),""bitstransfer"") OR match(lower(ScriptBlockText),""internetexplorer.application"") OR match(lower(ScriptBlockText),""xmlhttp""),5,0) 
| eval get = if(match(lower(ScriptBlockText),""get-""), ""1"", 0) 
| eval rundll32 = if(match(lower(ScriptBlockText),""rundll32""), ""4"", 0) 
| eval suspkeywrd=if(match(ScriptBlockText, ""(?i)(bitstransfer
|mimik
|metasp
|AssemblyBuilderAccess
|Reflection\.Assembly
|shellcode
|injection
|cnvert
|shell\.application
|start-process
|Rc4ByteStream
|System\.Security\.Cryptography
|lsass\.exe
|localadmin
|LastLoggedOn
|hijack
|BackupPrivilege
|ngrok
|comsvcs
|backdoor
|brute.?force
|Port.?Scan
|Exfiltration
|exploit
|DisableRealtimeMonitoring
|beacon)""),1,0) 
| eval syswow64 = if(match(lower(ScriptBlockText),""syswow64""), ""3"", 0) 
| eval httplocal = if(match(lower(ScriptBlockText),""http://127.0.0.1""), ""4"", 0) 
| eval reflection = if(match(lower(ScriptBlockText),""reflection""), ""1"", 0) 
| eval invokewmi=if(match(lower(ScriptBlockText), ""(?i)(wmiobject
|WMIMethod
|RemoteWMI
|PowerShellWmi
|wmicommand)""),5,0) 
| eval downgrade=if(match(ScriptBlockText, ""(?i)([-]ve*r*s*i*o*n*\s+2)"") OR match(lower(ScriptBlockText),""powershell -version""),3,0) 
| eval compressed=if(match(ScriptBlockText, ""(?i)GZipStream
|::Decompress
|IO.Compression
|write-zip
|(expand
|compress)-Archive""),5,0) 
| eval invokecmd = if(match(lower(ScriptBlockText),""invoke-command""), ""4"", 0) 
| addtotals fieldname=Score DoIt, enccom, suspcmdlet, suspkeywrd, compressed, downgrade, mimikatz, iex, empire, rundll32, webclient, syswow64, httplocal, reflection, invokewmi, invokecmd, base64, get 
| stats values(Score) by UserID, Computer, DoIt, enccom, compressed, downgrade, iex, mimikatz, rundll32, empire, webclient, syswow64, httplocal, reflection, invokewmi, invokecmd, base64, get, suspcmdlet, suspkeywrd 
| rename Computer as dest, UserID as user 
| `powershell_4104_hunting_filter`"
PowerShell Domain Enumeration,"The following analytic detects the execution of PowerShell commands used for domain enumeration, such as get-netdomaintrust and get-adgroupmember. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command sent to PowerShell. This activity is significant as it often indicates reconnaissance efforts by an attacker to map out the domain structure and identify key users and groups.",Windows Events,"Execution, Privilege Escalation",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (*get-netdomaintrust*, *get-netforesttrust*, *get-addomain*, *get-adgroupmember*, *get-domainuser*) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_domain_enumeration_filter`"
Windows Common Abused Cmd Shell Risk Behavior,"The following analytic identifies instances where four or more distinct detection analytics are associated with malicious command line behavior on a specific host. This detection leverages the Command Line Interface (CLI) data from various sources to identify suspicious activities. This behavior is significant as it often indicates attempts to execute malicious commands, access sensitive data, install backdoors, or perform other nefarious actions.",Windows Events,"Execution, Impact, Defense Evasion, Discovery, Exfiltration","T1033, T1529, T1016, T1049, T1059, T1222","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where source IN (""*Windows Cmdline Tool Execution From Non-Shell Process*"", ""*Windows System Network Config Discovery Display DNS*"", ""*Local Account Discovery With Wmic*"", ""*Windows Group Discovery Via Net*"", ""*Windows Create Local Administrator Account Via Net*"", ""*Windows User Discovery Via Net*"", ""*Icacls Deny Command*"", ""*ICACLS Grant Command*"", ""*Windows Proxy Via Netsh*"", ""*Processes launching netsh*"", ""*Disabling Firewall with Netsh*"", ""*Windows System Network Connections Discovery Netsh*"", ""*Network Connection Discovery With Arp*"", ""*Windows System Discovery Using ldap Nslookup*"", ""*Windows System Shutdown CommandLine*"") by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 4 
| `windows_common_abused_cmd_shell_risk_behavior_filter`"
Windows Exfiltration Over C2 Via Invoke RestMethod,"The following analytic detects potential data exfiltration using PowerShell's Invoke-RestMethod. It leverages PowerShell Script Block Logging to identify scripts that attempt to upload files via HTTP POST requests. This activity is significant as it may indicate an attacker is exfiltrating sensitive data, such as desktop screenshots or files, to an external command and control (C2) server.",Windows Events,"Command And Control, Discovery, Exfiltration",T1041,"`powershell` EventCode=4104 ScriptBlockText = ""*Invoke-RestMethod *"" AND ScriptBlockText = ""* -Uri *"" AND ScriptBlockText = ""* -Method *"" AND ScriptBlockText = ""* Post *"" AND ScriptBlockText = ""* -InFile *"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_exfiltration_over_c2_via_invoke_restmethod_filter`"
Windows Group Discovery Via Net,"The following analytic identifies the execution of net.exe with command-line arguments used to query global, local and domain groups. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate local or domain groups, which is a common step in Active Directory or privileged accounts discovery.",Windows Events,"Execution, Lateral Movement, Privilege Escalation, Discovery, Exfiltration","T1069.002, T1069, T1069.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` Processes.process=""*group*"" AND NOT (Processes.process=""*/add"" OR Processes.process=""*/delete"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_group_discovery_via_net_filter`"
Windows Sensitive Group Discovery With Net,"The following analytic detects the execution of net.exe with command-line arguments used to query elevated domain or sensitive groups. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to identify high-privileged users within Active Directory.",Windows Events,"Execution, Discovery","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` Processes.process=""*group*"" Processes.process IN (""*Domain Admins*"", ""*Enterprise Admins*"", ""*Schema Admins*"", ""*Account Operators*"", ""*Server Operators*"", ""*Protected Users*"", ""*Dns Admins*"", ""*Domain Computers*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sensitive_group_discovery_with_net_filter`"
Windows Suspicious Child Process Spawned From WebServer,"The following analytic identifies the execution of suspicious processes typically associated with WebShell activity on web servers. It detects when processes like cmd.exe, powershell.exe, or bash.exe are spawned by web server processes such as w3wp.exe or nginx.exe. This behavior is significant as it may indicate an adversary exploiting a web application vulnerability to install a WebShell, providing persistent access and command execution capabilities.",Windows Events,"Discovery, Execution, Persistence","T1505, T1505.003","| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime from datamodel=Endpoint.Processes where (Processes.process_name IN (""arp.exe"",""at.exe"",""bash.exe"",""bitsadmin.exe"",""certutil.exe"",""cmd.exe"",""cscript.exe"", ""dsget.exe"",""dsquery.exe"",""find.exe"",""findstr.exe"",""fsutil.exe"",""hostname.exe"",""ipconfig.exe"",""ksh.exe"",""nbstat.exe"", ""net.exe"",""net1.exe"",""netdom.exe"",""netsh.exe"",""netstat.exe"",""nltest.exe"",""nslookup.exe"",""ntdsutil.exe"",""pathping.exe"", ""ping.exe"",""powershell.exe"",""pwsh.exe"",""qprocess.exe"",""query.exe"",""qwinsta.exe"",""reg.exe"",""rundll32.exe"",""sc.exe"", ""scrcons.exe"",""schtasks.exe"",""sh.exe"",""systeminfo.exe"",""tasklist.exe"",""tracert.exe"",""ver.exe"",""vssadmin.exe"", ""wevtutil.exe"",""whoami.exe"",""wmic.exe"",""wscript.exe"",""wusa.exe"",""zsh.exe"") AND Processes.parent_process_name IN (""w3wp.exe"", ""http*.exe"", ""nginx*.exe"", ""php*.exe"", ""php-cgi*.exe"",""tomcat*.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_suspicious_child_process_spawned_from_webserver_filter`"
Windows WSUS Spawning Shell,"The following analytic identifies instances where a shell (PowerShell.exe or Cmd.exe) is spawned from wsusservice.exe, the Windows Server Update Services process. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where the parent process is wsusservice.exe. This activity is significant as it may indicate exploitation of CVE-2025-59287, a critical deserialization vulnerability in WSUS that allows unauthenticated remote code execution.",Windows Events,"Initial Access, Execution, Lateral Movement, Persistence, Exfiltration","T1190, T1505.003","| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=wsusservice.exe AND `process_cmd` OR `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_wsus_spawning_shell_filter`"
Detect New Local Admin account,"The following analytic detects the creation of new accounts elevated to local administrators. It uses Windows event logs, specifically EventCode 4720 (user account creation) and EventCode 4732 (user added to Administrators group). This activity is significant as it indicates potential unauthorized privilege escalation, which is critical for SOC monitoring. If confirmed malicious, this could allow attackers to gain administrative access, leading to unauthorized data access, system modifications, and disruption of services.",Windows Events,"Persistence, Privilege Escalation",T1136.001,"`wineventlog_security`
(
EventCode=4720 
OR
(
EventCode=4732
AND
(
Group_Name=Administrators
OR
TargetUserName=Administrators
)
)
)
| transaction user dest connected=false maxspan=180m
| stats count min(_time) as firstTime 
max(_time) as lastTime 
dc(EventCode) as distinct_eventcodes 
by src_user user dest
| where distinct_eventcodes > 1
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_new_local_admin_account_filter`"
O365 Elevated Mailbox Permission Assigned,"The following analytic identifies the assignment of elevated mailbox permissions in an Office 365 environment via the Add-MailboxPermission operation. It leverages logs from the Exchange workload in the o365_management_activity data source, focusing on permissions such as FullAccess, ChangePermission, or ChangeOwner. This activity is significant as it indicates potential unauthorized access or control over mailboxes, which could lead to data exfiltration or privilege escalation.",Office 365 (Microsoft 365),"Collection, Persistence, Privilege Escalation, Exfiltration","T1098, T1098.002","`o365_management_activity` Workload=Exchange Operation=Add-MailboxPermission (AccessRights=FullAccess OR AccessRights=ChangePermission OR AccessRights=ChangeOwner) 
| rename Identity AS dest_user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product dest_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_elevated_mailbox_permission_assigned_filter`"
O365 Mailbox Folder Read Permission Assigned,"The following analytic identifies instances where read permissions are assigned to mailbox folders within an Office 365 environment. It leverages the o365_management_activity data source, specifically monitoring the ModifyFolderPermissions and AddFolderPermissions operations, while excluding Calendar, Contacts, and PersonMetadata objects. This activity is significant as unauthorized read permissions can lead to data exposure and potential information leakage.",Office 365 (Microsoft 365),"Collection, Persistence","T1098, T1098.002","`o365_management_activity` Workload=Exchange (Operation=ModifyFolderPermissions OR Operation=AddFolderPermissions) Workload=Exchange object!=Calendar object!=Contacts object!=PersonMetadata 
| eval isReadRole=if(match('Item.ParentFolder.MemberRights',""(ReadAny)""), ""true"", ""false"") 
| rename UserId as user 
| stats count earliest(_time) as firstTime latest(_time) as lastTime by signature user object dest Item.ParentFolder.MemberUpn Item.ParentFolder.MemberRights src vendor_account vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_mailbox_folder_read_permission_assigned_filter`"
O365 Mailbox Folder Read Permission Granted,"The following analytic identifies instances where read permissions are granted to mailbox folders within an Office 365 environment. It detects this activity by monitoring the o365_management_activity data source for the Set-MailboxFolderPermission and Add-MailboxFolderPermission operations. This behavior is significant as it may indicate unauthorized access or changes to mailbox folder permissions, potentially exposing sensitive email content.",Office 365 (Microsoft 365),"Collection, Persistence","T1098, T1098.002","`o365_management_activity` Workload=Exchange (Operation=""Set-MailboxFolderPermission"" OR Operation=""Add-MailboxFolderPermission"" ) 
| eval isReadRole=if(match(AccessRights,""^(ReadItems
|Author
|NonEditingAuthor
|Owner
|PublishingAuthor
|Reviewer)$""), ""true"", ""false"") 
| search isReadRole=""true"" 
| rename UserId as user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product Identity AccessRights 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_mailbox_folder_read_permission_granted_filter`"
Processes Tapping Keyboard Events,"The following analytic detects processes on macOS systems that are tapping keyboard events, potentially monitoring all keystrokes made by a user.",Windows Events,,,"| from datamodel Alerts.Alerts 
| search app=osquery:results name=pack_osx-attacks_Keyboard_Event_Taps 
| rename columns.cmdline as cmd, columns.name as process_name, columns.pid as process_id
| dedup host,process_name 
| table host,process_name, cmd, process_id 
| `processes_tapping_keyboard_events_filter`"
Suspicious PlistBuddy Usage via OSquery,The following analytic detects the use of the PlistBuddy utility on macOS to create or modify property list (.,Windows Events,Persistence,T1543.001,"`osquery_process` ""columns.cmdline""=""*LaunchAgents*"" OR ""columns.cmdline""=""*RunAtLoad*"" OR ""columns.cmdline""=""*true*"" 
|  `suspicious_plistbuddy_usage_via_osquery_filter`"
Windows Create Local Account,"The following analytic detects the creation of a new local user account on a Windows system. It leverages Windows Security Audit logs, specifically event ID 4720, to identify this activity. Monitoring the creation of local accounts is crucial for a SOC as it can indicate unauthorized access or lateral movement within the network. If confirmed malicious, this activity could allow an attacker to establish persistence, escalate privileges, or gain unauthorized access to sensitive systems and data.",Windows Events,"Lateral Movement, Execution, Persistence",T1136.001,"| tstats `security_content_summariesonly` 
values(All_Changes.result_id) as result_id 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Change where 
All_Changes.result_id=4720 
by All_Changes.user All_Changes.dest All_Changes.result All_Changes.action
| `drop_dm_object_name(""All_Changes"")`
| `security_content_ctime(lastTime)`
| `security_content_ctime(firstTime)`
| `windows_create_local_account_filter`"
Windows Debugger Tool Execution,"This analysis detects the use of debugger tools within a production environment. While these tools are legitimate for file analysis and debugging, they are abused by malware like PlugX and DarkGate for malicious DLL side-loading. The hunting query aids Security Operations Centers (SOCs) in identifying potentially suspicious tool executions, particularly for non-technical users in the production network.",Windows Events,"Execution, Defense Evasion",T1036,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""x32dbg.exe"" OR Processes.process_name = ""x64dbg.exe"" OR Processes.process_name = ""windbg.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_debugger_tool_execution_filter`"
Windows Process Execution From RDP Share,"The following analytic identifies process executions originating from RDP shares on Windows endpoints. Remote Desktop Protocol (RDP) shares, typically accessed via the &quot;tsclient&quot; path, allow users to share files between their local machine and a remote desktop session. However, threat actors may exploit RDP shares to execute malicious processes or transfer harmful files onto a compromised system.",Windows Events,"Lateral Movement, Execution, Command And Control","T1021.001, T1105, T1059","| tstats `security_content_summariesonly`
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where
Processes.process = ""*\\\\tsclient\\*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_process_execution_from_rdp_share_filter`"
Windows Process Writing File to World Writable Path,"The following analytic identifies a process writing a .txt file to a world writable path. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on file creation events within specific directories. This activity is significant as adversaries often use such techniques to deliver payloads to a system, which is uncommon for legitimate processes.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name=*.txt Filesystem.file_path IN (""*\\Windows\\Tasks\\*"", ""*\\Windows\\Temp\\*"", ""*\\Windows\\tracing\\*"", ""*\\Windows\\PLA\\Reports\\*"", ""*\\Windows\\PLA\\Rules\\*"", ""*\\Windows\\PLA\\Templates\\*"", ""*\\Windows\\PLA\\Reports\\en-US\\*"", ""*\\Windows\\PLA\\Rules\\en-US\\*"", ""*\\Windows\\Registration\\CRMLog\\*"", ""*\\Windows\\System32\\Tasks\\*"", ""*\\Windows\\System32\\Com\\dmp\\*"", ""*\\Windows\\System32\\LogFiles\\WMI\\*"", ""*\\Windows\\System32\\Microsoft\\Crypto\\RSA\\MachineKeys\\*"", ""*\\Windows\\System32\\spool\\PRINTERS\\*"", ""*\\Windows\\System32\\spool\\SERVERS\\*"", ""*\\Windows\\System32\\spool\\drivers\\color\\*"", ""*\\Windows\\System32\\Tasks\\Microsoft\\Windows\\RemoteApp and Desktop Connections Update\\*"", ""*\\Windows\\SysWOW64\\Tasks\\*"", ""*\\Windows\\SysWOW64\\Com\\dmp\\*"", ""*\\Windows\\SysWOW64\\Tasks\\Microsoft\\Windows\\PLA\\*"", ""*\\Windows\\SysWOW64\\Tasks\\Microsoft\\Windows\\RemoteApp and Desktop Connections Update\\*"", ""*\\Windows\\SysWOW64\\Tasks\\Microsoft\\Windows\\PLA\\System\\*"") by Filesystem.dest, Filesystem.user, Filesystem.file_name Filesystem.file_path 
| `drop_dm_object_name(""Filesystem"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_writing_file_to_world_writable_path_filter`"
Detect ARP Poisoning,The following analytic detects ARP Poisoning attacks by monitoring for Dynamic ARP Inspection (DAI) errors on Cisco network devices.,Cisco IOS,"Initial Access, Impact, Collection","T1200, T1498, T1557.002","`cisco_networks` facility=""PM"" mnemonic=""ERR_DISABLE"" disable_cause=""arp-inspection"" 
| eval src_interface=src_int_prefix_long+src_int_suffix 
| stats min(_time) AS firstTime max(_time) AS lastTime count BY host src_interface 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)`
| `detect_arp_poisoning_filter`"
Detect Port Security Violation,The following analytic detects port security violations on Cisco switches.,Cisco IOS,"Initial Access, Collection, Lateral Movement, Impact, Exfiltration","T1200, T1498, T1557.002","`cisco_networks` (facility=""PM"" mnemonic=""ERR_DISABLE"" disable_cause=""psecure-violation"") OR (facility=""PORT_SECURITY"" mnemonic=""PSECURE_VIOLATION"" OR mnemonic=""PSECURE_VIOLATION_VLAN"") 
| eval src_interface=src_int_prefix_long+src_int_suffix 
| stats min(_time) AS firstTime max(_time) AS lastTime values(disable_cause) AS disable_cause values(src_mac) AS src_mac values(src_vlan) AS src_vlan values(action) AS action count by host src_interface 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_port_security_violation_filter`"
Detect Rogue DHCP Server,The following analytic identifies the presence of unauthorized DHCP servers on the network.,Cisco IOS,"Initial Access, Impact, Collection","T1200, T1498, T1557","`cisco_networks` facility=""DHCP_SNOOPING"" mnemonic=""DHCP_SNOOPING_UNTRUSTED_PORT"" 
| stats min(_time) AS firstTime max(_time) AS lastTime count values(message_type) AS message_type values(src_mac) AS src_mac BY host 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)`
| `detect_rogue_dhcp_server_filter`"
Detect Traffic Mirroring,The following analytic detects the initiation of traffic mirroring sessions on Cisco network devices.,Cisco IOS,"Initial Access, Impact, Exfiltration","T1020.001, T1200, T1498","`cisco_networks` (facility=""MIRROR"" mnemonic=""ETH_SPAN_SESSION_UP"") OR (facility=""SPAN"" mnemonic=""SESSION_UP"") OR (facility=""SPAN"" mnemonic=""PKTCAP_START"") OR (mnemonic=""CFGLOG_LOGGEDCMD"" command=""monitor session*"") 
| stats min(_time) AS firstTime max(_time) AS lastTime count BY host facility mnemonic 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)` 
| `detect_traffic_mirroring_filter`"
Detect Regasm with Network Connection,"The following analytic detects the execution of regasm.exe establishing a network connection to a public IP address, excluding private IP ranges. This detection leverages Sysmon EventID 3 logs to identify such behavior. This activity is significant as regasm.exe is a legitimate Microsoft-signed binary that can be exploited to bypass application control mechanisms. If confirmed malicious, this behavior could indicate an adversary's attempt to establish a remote Command and Control (C2) channel, potentially leading to privilege escalation and further malicious actions within the environment.",Windows Events,"Command And Control, Execution, Privilege Escalation, Defense Evasion","T1218.009, T1218","`sysmon`
EventID=3 
process_name=regasm.exe
NOT dest_ip IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4""
)
| stats count min(_time) as firstTime max(_time) as lastTime
by action app dest dest_ip dest_port direction dvc protocol protocol_version src
src_ip src_port transport user vendor_product process_name process_exec process_guid
process_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_regasm_with_network_connection_filter`"
Detect Regsvcs with Network Connection,"The following analytic identifies instances of Regsvcs.exe establishing a network connection to a public IP address, excluding private IP ranges. This detection leverages Sysmon EventID 3 logs to monitor network connections initiated by Regsvcs.exe. This activity is significant as Regsvcs.exe, a legitimate Microsoft-signed binary, can be exploited to bypass application control mechanisms and establish remote Command and Control (C2) channels.",Windows Events,"Command And Control, Execution, Defense Evasion","T1218.009, T1218","`sysmon`
EventID=3
NOT dest_ip IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4""
)
process_name=regsvcs.exe
| stats count min(_time) as firstTime max(_time) as lastTime
by action app dest dest_ip dest_port direction dvc protocol protocol_version src
src_ip src_port transport user vendor_product process_name process_exec process_guid
process_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `detect_regsvcs_with_network_connection_filter`"
Windows File Transfer Protocol In Non-Common Process Path,"The following analytic detects FTP connections initiated by processes located in non-standard installation paths on Windows systems. It leverages Sysmon EventCode 3 to identify network connections where the process image path does not match common directories like &quot;Program Files&quot; or &quot;Windows\System32&quot;. This activity is significant as FTP is often used by adversaries and malware, such as AgentTesla, for Command and Control (C2) communications to exfiltrate stolen data.",Windows Events,Command And Control,T1071.003,"`sysmon`
EventCode=3
NOT Image IN(
""C:\\Program Files \(x86\)\\*"",
""C:\\Program Files\\*"",
""C:\\Windows\\System32\\*"",
""C:\\Windows\\SysWOW64\\*""
)
(
DestinationPortName=""ftp""
OR
DestinationPort=21
)
| stats count min(_time) as firstTime
max(_time) as lastTime
by action app dest dest_ip dest_port direction dvc protocol protocol_version
src src_ip src_port transport user vendor_product process_name
process_exec process_guid process_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_file_transfer_protocol_in_non_common_process_path_filter`"
Windows Mail Protocol In Non-Common Process Path,"The following analytic detects a Windows application establishing an SMTP connection from a non-common installation path. It leverages Sysmon EventCode 3 to identify processes not typically associated with email clients (e.g., Thunderbird, Outlook) making SMTP connections. This activity is significant as adversaries, including malware like AgentTesla, use such connections for Command and Control (C2) communication to exfiltrate stolen data.",Windows Events,"Command And Control, Exfiltration",T1071.003,"`sysmon`
EventCode=3
NOT Image IN(
""C:\\Program Files \(x86\)\\*"",
""C:\\Program Files\\*"",
""C:\\Windows\\System32\\*"",
""C:\\Windows\\SysWOW64\\*""
)
(
DestinationPortName=""smtp""
OR
DestinationPort IN (25, 587)
)
| stats count min(_time) as firstTime 
max(_time) as lastTime
by action app dest dest_ip dest_port direction dvc protocol protocol_version
src src_ip src_port transport user vendor_product process_name
process_exec process_guid process_id
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_mail_protocol_in_non_common_process_path_filter`"
Cisco ASA - Logging Disabled via CLI,"This analytic detects the disabling of logging functionality on a Cisco ASA device through CLI commands. Adversaries or malicious insiders may attempt to disable logging to evade detection and hide malicious activity. The detection looks for specific ASA syslog message IDs (111010, 111008) associated with command execution, combined with suspicious commands such as no logging, logging disable, clear logging, or no logging host.",Cisco ASA,"Execution, Defense Evasion",T1562,"`cisco_asa`
message_id IN (111008, 111010)
command IN (
""*no logging*"",
""*logging disable*"",
""*clear logging*"",
""*no logging host*"",
""*no logging trap*""
)
| stats earliest(_time) as firstTime
latest(_time) as lastTime
values(user) as user
values(action) as action
values(message_id) as message_id
values(command) as command
values(src_ip) as src_ip
values(process_name) as process_name
by host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `cisco_asa___logging_disabled_via_cli_filter`"
HTTP Request to Reserved Name on IIS Server,"Detects attempts to exploit a request smuggling technique against IIS that leverages a Windows quirk where requests for reserved Windows device names such as &quot;/con&quot; trigger an early server response before the request body is received. When combined with a Content-Length desynchronization, this behavior can lead to a parsing confusion between frontend and backend.",Zscaler Proxy,"Initial Access, Impact, Command And Control, Lateral Movement","T1190, T1071.001","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/con"", ""/prn"", ""/aux"", ""/nul"", ""/com1"",""/com2"",""/com3"",""/com4"", ""/com5"",""/com6"",""/com7"") by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.status, Web.http_method 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `http_request_to_reserved_name_on_iis_server_filter`"
Web or Application Server Spawning a Shell,"The following analytic detects instances where Java, or Tomcat processes spawn a Linux shell, which may indicate exploitation attempts, such as those related to CVE-2021-44228 (Log4Shell). This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process names and parent-child process relationships. This activity is significant as it can signify a compromised Java application, potentially leading to unauthorized shell access.",Linux,"Initial Access, Execution","T1190, T1133","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
(
Processes.parent_process_name IN (""java"", ""tomcat*"", ""httpd"", ""lighttpd"", ""apache2"", ""nginx"", ""node"", ""caddy"")
`linux_shells`
)
OR
(
Processes.parent_process_name IN (""httpd.exe"", ""nginx.exe"", ""php*.exe"", ""php-cgi.exe"", ""tomcat*.exe"", ""caddy.exe"", ""UMWorkerProcess.exe"", ""w3wp.exe"", ""ws_TomcatService.exe"", ""node.exe"", ""java.exe"")
`windows_shells`
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `web_or_application_server_spawning_a_shell_filter`"
Windows SSH Proxy Command,"This detection identifies potential abuse of SSH &quot;ProxyCommand&quot; or &quot;LocalCommand&quot; by monitoring for suspicious process execution patterns. Specifically, it looks for instances where ssh.exe (as a parent process) containing &quot;ProxyCommand&quot; or &quot;LocalCommand&quot; in its arguments spawns potentially malicious child processes like mshta, powershell, wscript, or cscript, or processes containing &quot;http&quot; in their command line.",Windows Events,"Command And Control, Execution","T1059.001, T1572, T1105","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.parent_process_name=""ssh.exe""
(
Processes.parent_process = ""*ProxyCommand=*""
OR
(
Processes.parent_process = ""* PermitLocalCommand=yes*""
Processes.parent_process = ""* LocalCommand=*""
)
)
Processes.process IN (
""*cscript*"",
""*http*"",
""*mshta*"",
""*powershell*"",
""*pwsh*"",
""*wmic*"",
""*wscript*""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id
Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_ssh_proxy_command_filter`"
HTTP Duplicated Header,"Detects when a request has more than one of the same header. This is commonly used in request smuggling and other web based attacks. HTTP Request Smuggling exploits inconsistencies in how front-end and back-end servers parse HTTP requests by using ambiguous or malformed headers to hide malicious requests within legitimate ones. Attackers leverage duplicate headers, particularly Content-Length and Transfer-Encoding, to cause different servers in the chain to disagree on where one request ends and another begins.",Zscaler Proxy,"Initial Access, Impact, Command And Control","T1190, T1071.001","`suricata` http.request_headers{}.name=""*"" 
| rename dest_ip as dest 
| spath path=http.request_headers{}.name output=header_names 
| mvexpand header_names 
| where lower(header_names) != ""set-cookie"" 
| stats count by _raw, header_names, src_ip, dest 
| where count > 1 
| stats values(header_names) as duplicate_headers by _raw, count, src_ip, dest 
| `http_duplicated_header_filter`"
CrushFTP Server Side Template Injection,"This analytic is designed to identify attempts to exploit a server-side template injection vulnerability in CrushFTP, designated as CVE-2024-4040. This severe vulnerability enables unauthenticated remote attackers to access and read files beyond the VFS Sandbox, circumvent authentication protocols, and execute arbitrary commands on the affected server. The issue impacts all versions of CrushFTP up to 10.",CrushFTP,"Initial Access, Impact",T1190,"`crushftp` 
| rex field=_raw ""\[(?<protocol>HTTPS
|HTTP):(?<session_id>[^\:]+):(?<user>[^\:]+):(?<src_ip>\d+\.\d+\.\d+\.\d+)\] (?<action>READ
|WROTE): \*(?<http_method>[A-Z]+) (?<uri_query>[^\s]+) HTTP/[^\*]+\*"" 
| eval message=if(match(_raw, ""INCLUDE"") and isnotnull(src_ip), ""traces of exploitation by "" . src_ip, ""false"") 
| search message!=false 
| rename host as dest 
| stats count by _time, dest, source, message, src_ip, http_method, uri_query, user, action 
| sort -_time
| `crushftp_server_side_template_injection_filter`"
Detect New Login Attempts to Routers,The following analytic identifies new login attempts to routers.,Azure AD (Microsoft Entra ID),,,"| tstats `security_content_summariesonly` count earliest(_time) as earliest latest(_time) as latest from datamodel=Authentication where Authentication.dest_category=router by Authentication.dest Authentication.user
| eval isOutlier=if(earliest >= relative_time(now(), ""-30d@d""), 1, 0) 
| where isOutlier=1
| `security_content_ctime(earliest)`
| `security_content_ctime(latest)` 
| `drop_dm_object_name(""Authentication"")` 
| `detect_new_login_attempts_to_routers_filter`"
ESXi SSH Brute Force,"This detection identifies signs of SSH brute-force attacks by monitoring for a high number of failed login attempts within a short time frame. Such activity may indicate an attacker attempting to gain unauthorized access through password guessing.
Search 1`esxi_syslog` Message=&#34;*Authentication failure for*&#34; 2| rex &#34;for (?&lt;user&gt;[\w]+) from (?&lt;src_ip&gt;\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})&#34; 3| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 4| bin _time span=5m 5| stats min(_time) as firstTime max(_time) as lastTime count by user, src_ip, dest 6| where count &gt; 10 7| `security_content_ctime(firstTime)` 8| `security_content_ctime(lastTime)` 9| `esxi_ssh_brute_force_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_ssh_brute_force_filter search * esxi_ssh_brute_force_filter is an empty macro by default.",VMware ESXi,"Credential Access, Discovery",T1110,"`esxi_syslog` Message=""*Authentication failure for*"" 
| rex ""for (?<user>[\w]+) from (?<src_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| bin _time span=5m 
| stats min(_time) as firstTime max(_time) as lastTime count by user, src_ip, dest 
| where count > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_ssh_brute_force_filter`"
ESXi SSH Enabled,"This detection identifies SSH being enabled on ESXi hosts, which can be an early indicator of malicious activity. Threat actors often use SSH to gain persistent remote access after compromising credentials or exploiting vulnerabilities.
Search 1`esxi_syslog` Message=&#34;*SSH access has been enabled&#34; 2| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 3| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 4| `security_content_ctime(firstTime)` 5| `security_content_ctime(lastTime)` 6| `esxi_ssh_enabled_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_ssh_enabled_filter search * esxi_ssh_enabled_filter is an empty macro by default.",VMware ESXi,Lateral Movement,T1021.004,"`esxi_syslog` Message=""*SSH access has been enabled"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_ssh_enabled_filter`"
Ivanti VTM New Account Creation,"This analytic detects potential exploitation of the Ivanti Virtual Traffic Manager (vTM) authentication bypass vulnerability (CVE-2024-7593) to create new administrator accounts. The vulnerability allows unauthenticated remote attackers to bypass authentication on the admin panel and create new admin users. This detection looks for suspicious new account creation events in the Ivanti vTM audit logs that lack expected authentication details, which may indicate exploitation attempts.",Ivanti,"Initial Access, Execution",T1190,"`ivanti_vtm_audit` OPERATION=""adduser"" MODGROUP=""admin"" IP=""!!ABSENT!!"" 
| stats count min(_time) as firstTime max(_time) as lastTime by IP, MODUSER, OPERATION, MODGROUP, AUTH 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_vtm_new_account_creation_filter`"
Okta Authentication Failed During MFA Challenge,The following analytic identifies failed authentication attempts during the Multi-Factor Authentication (MFA) challenge in an Okta tenant. It uses the Authentication datamodel to detect specific failed events where the authentication signature is user.authentication.auth_via_mfa. This activity is significant as it may indicate an adversary attempting to authenticate with compromised credentials on an account with MFA enabled.,Okta,"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime  values(Authentication.app) as app values(Authentication.reason) as reason values(Authentication.signature) as signature  values(Authentication.method) as method  from datamodel=Authentication where  Authentication.signature=user.authentication.auth_via_mfa Authentication.action = failure by _time Authentication.src Authentication.user Authentication.dest Authentication.action 
| `drop_dm_object_name(""Authentication"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| iplocation src 
| `okta_authentication_failed_during_mfa_challenge_filter`"
Okta MFA Exhaustion Hunt,"The following analytic detects patterns of successful and failed Okta MFA push attempts to identify potential MFA exhaustion attacks. It leverages Okta event logs, specifically focusing on push verification events, and uses statistical evaluations to determine suspicious activity. This activity is significant as it may indicate an attacker attempting to bypass MFA by overwhelming the user with push notifications.",Okta,Credential Access,T1110,"`okta` eventType=system.push.send_factor_verify_push OR ((legacyEventType=core.user.factor.attempt_success) AND (debugContext.debugData.factor=OKTA_VERIFY_PUSH)) OR ((legacyEventType=core.user.factor.attempt_fail) AND (debugContext.debugData.factor=OKTA_VERIFY_PUSH)) 
| stats count(eval(legacyEventType=""core.user.factor.attempt_success""))  as successes count(eval(legacyEventType=""core.user.factor.attempt_fail"")) as failures count(eval(eventType=""system.push.send_factor_verify_push"")) as pushes by user,_time 
| stats latest(_time) as lasttime earliest(_time) as firsttime sum(successes) as successes sum(failures) as failures sum(pushes) as pushes by user 
| eval seconds=lasttime-firsttime 
| eval lasttime=strftime(lasttime, ""%c"") 
| search (pushes>1) 
| eval totalattempts=successes+failures 
| eval finding=""Normal authentication pattern"" 
| eval finding=if(failures==pushes AND pushes>1,""Authentication attempts not successful because multiple pushes denied"",finding) 
| eval finding=if(totalattempts==0,""Multiple pushes sent and ignored"",finding) 
| eval finding=if(successes>0 AND pushes>3,""Probably should investigate. Multiple pushes sent, eventual successful authentication!"",finding) 
| `okta_mfa_exhaustion_hunt_filter`"
Okta Mismatch Between Source and Response for Verify Push Request,"The following analytic identifies discrepancies between the source and response events for Okta Verify Push requests, indicating potential suspicious behavior. It leverages Okta System Log events, specifically system.push.send_factor_verify_push and user.authentication.auth_via_mfa with the factor &quot;OKTA_VERIFY_PUSH.&quot; The detection groups events by SessionID, calculates the ratio of successful sign-ins to push requests, and checks for session roaming and new device/IP usage.",Okta,Credential Access,T1621,"`okta` eventType IN (system.push.send_factor_verify_push) OR (eventType IN (user.authentication.auth_via_mfa) debugContext.debugData.factor=""OKTA_VERIFY_PUSH"") 
| eval groupby=""authenticationContext.externalSessionId"" 
| eval group_push_time=_time 
| bin span=2s group_push_time 
| fillnull value=NULL 
| stats min(_time) as _time by authenticationContext.externalSessionId eventType debugContext.debugData.factor outcome.result actor.alternateId client.device client.ipAddress client.userAgent.rawUserAgent debugContext.debugData.behaviors group_push_time 
| iplocation client.ipAddress 
| fields - lat, lon, group_push_time 
| stats min(_time) as _time dc(client.ipAddress) as dc_ip sum(eval(if(eventType=""system.push.send_factor_verify_push"" AND $outcome.result$=""SUCCESS"", 1, 0))) as total_pushes sum(eval(if(eventType=""user.authentication.auth_via_mfa"" AND $outcome.result$=""SUCCESS"", 1, 0))) as total_successes sum(eval(if(eventType=""user.authentication.auth_via_mfa"" AND $outcome.result$=""FAILURE"", 1, 0))) as total_rejected sum(eval(if(eventType=""system.push.send_factor_verify_push"" AND $debugContext.debugData.behaviors$ LIKE ""%New Device=POSITIVE%"", 1, 0))) as suspect_device_from_source sum(eval(if(eventType=""system.push.send_factor_verify_push"" AND $debugContext.debugData.behaviors$ LIKE ""%New IP=POSITIVE%"", 1, 0))) as suspect_ip_from_source values(eval(if(eventType=""system.push.send_factor_verify_push"", $client.ipAddress$, """"))) as src values(eval(if(eventType=""user.authentication.auth_via_mfa"", $client.ipAddress$, """"))) as dest values(*) as * by authenticationContext.externalSessionId 
| eval ratio = round(total_successes / total_pushes, 2) 
| search ((ratio < 0.5 AND total_pushes > 1) OR (total_rejected > 0)) AND dc_ip > 1 AND suspect_device_from_source > 0 AND suspect_ip_from_source > 0 
|rename actor.alternateId as user 
| `okta_mismatch_between_source_and_response_for_verify_push_request_filter`"
Okta Multi-Factor Authentication Disabled,"The following analytic identifies an attempt to disable multi-factor authentication (MFA) for an Okta user. It leverages OktaIM2 logs to detect when the 'user.mfa.factor.deactivate' command is executed. This activity is significant because disabling MFA can allow an adversary to maintain persistence within the environment using a compromised valid account. If confirmed malicious, this action could enable attackers to bypass additional security layers, potentially leading to unauthorized access to sensitive information and prolonged undetected presence in the network.",Okta,"Persistence, Credential Access","T1556.006, T1556","| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime from datamodel=Change where sourcetype=""OktaIM2:log"" All_Changes.object_category=User AND All_Changes.action=modified All_Changes.command=user.mfa.factor.deactivate by All_Changes.user All_Changes.result All_Changes.command sourcetype All_Changes.src All_Changes.dest 
| `drop_dm_object_name(""All_Changes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_multi_factor_authentication_disabled_filter`"
Okta Multiple Failed MFA Requests For User,"The following analytic identifies multiple failed multi-factor authentication (MFA) requests for a single user within an Okta tenant. It triggers when more than 10 MFA attempts fail within 5 minutes, using Okta event logs to detect this pattern. This activity is significant as it may indicate an adversary attempting to bypass MFA by bombarding the user with repeated authentication requests, a technique used by threat actors like Lapsus and APT29.",Okta,Credential Access,T1621,"`okta` eventType=user.authentication.auth_via_mfa outcome.result=FAILURE debugContext.debugData.factor!=PASSWORD_AS_FACTOR 
| bucket _time span=5m 
| stats count min(_time) as firstTime max(_time) as lastTime values(displayMessage) values(src_ip) as src_ip values(debugContext.debugData.factor) values(dest) as dest by _time src_user 
| where count >= 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_multiple_failed_mfa_requests_for_user_filter`"
Okta New API Token Created,"The following analytic detects the creation of a new API token within an Okta tenant. It uses OktaIm2 logs ingested via the Splunk Add-on for Okta Identity Cloud to identify events where the system.api_token.create command is executed. This activity is significant because creating a new API token can indicate potential account takeover attempts or unauthorized access, allowing an adversary to maintain persistence.",Okta,"Persistence, Defense Evasion",T1078.001,"| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime from datamodel=Change where All_Changes.action=created AND All_Changes.command=system.api_token.create by _time span=5m All_Changes.user All_Changes.result All_Changes.command sourcetype All_Changes.src All_Changes.action All_Changes.object_category All_Changes.dest 
| `drop_dm_object_name(""All_Changes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_new_api_token_created_filter`"
Okta New Device Enrolled on Account,The following analytic identifies when a new device is enrolled on an Okta account. It uses OktaIm2 logs ingested via the Splunk Add-on for Okta Identity Cloud to detect the creation of new device enrollments. This activity is significant as it may indicate a legitimate user setting up a new device or an adversary adding a device to maintain unauthorized access.,Okta,Persistence,"T1098, T1098.005","| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime from datamodel=Change where All_Changes.action=created All_Changes.command=device.enrollment.create by _time span=5m All_Changes.user All_Changes.result All_Changes.command sourcetype All_Changes.src All_Changes.action All_Changes.object_category All_Changes.dest 
| `drop_dm_object_name(""All_Changes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_new_device_enrolled_on_account_filter`"
Okta Suspicious Use of a Session Cookie,"The following analytic identifies suspicious use of a session cookie by detecting multiple client values (IP, User Agent, etc.) changing for the same Device Token associated with a specific user. It leverages policy evaluation events from successful authentication logs in Okta. This activity is significant as it may indicate an adversary attempting to reuse a stolen web session cookie, potentially bypassing authentication mechanisms.",Okta,Credential Access,T1539,"`okta` eventType IN (policy.evaluate_sign_on) outcome.result IN (ALLOW, SUCCESS) 
| stats earliest(_time) as _time, values(client.ipAddress) as src_ip, values(client.userAgent.rawUserAgent) as user_agent, values(client.userAgent.os) as userAgentOS_list, values(client.geographicalContext.city) as city, values(client.userAgent.browser) as userAgentBrowser_list, values(device.os_platform) as okta_device_os, dc(client.userAgent.browser) as dc_userAgentBrowser, dc(client.userAgent.os) as dc_userAgentOS, dc(client.ipAddress) as dc_src_ip, values(outcome.reason) as reason values(dest) as dest by debugContext.debugData.dtHash, user 
| where dc_src_ip>1 AND (dc_userAgentOS>1 OR dc_userAgentBrowser>1) 
| `okta_suspicious_use_of_a_session_cookie_filter`"
PingID New MFA Method After Credential Reset,"The following analytic identifies the provisioning of a new MFA device shortly after a password reset. It detects this activity by correlating Windows Event Log events for password changes (EventID 4723, 4724) with PingID logs indicating device pairing. This behavior is significant as it may indicate a social engineering attack where a threat actor impersonates a valid user to reset credentials and add a new MFA device.",Windows Events,"Credential Access, Defense Evasion","T1556.006, T1556, T1621, T1098.005, T1098","`pingid` ""result.message"" = ""*Device Paired*"" 
| rex field=result.message ""Device (Unp)?(P)?aired (?<device_extract>.+)"" 
| eval src = coalesce('resources{}.ipaddress','resources{}.devicemodel'), user = upper('actors{}.name'), reason = 'result.message' 
| eval object=CASE(ISNOTNULL('resources{}.devicemodel'),'resources{}.devicemodel',true(),device_extract) 
| eval action=CASE(match('result.message',""Device Paired*""),""created"",match('result.message', ""Device Unpaired*""),""deleted"") 
| stats count min(_time) as firstTime, max(_time) as lastTime, values(reason) as reason by src,user,action,object 
| join type=outer user [
| search `wineventlog_security` EventID IN(4723,4724) 
| eval PW_Change_Time = _time, user = upper(user) 
| fields user,src_user,EventID,PW_Change_Time] 
| eval timeDiffRaw = round(lastTime - PW_Change_Time) 
| eval timeDiff = replace(tostring(abs(timeDiffRaw) ,""duration""),""(\d*)\+*(\d+):(\d+):(\d+)"",""\2 hours \3 minutes"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(PW_Change_Time)` 
| where timeDiffRaw > 0 AND timeDiffRaw < 3600 
| `pingid_new_mfa_method_after_credential_reset_filter`"
ASL AWS Concurrent Sessions From Different Ips,"The following analytic identifies an AWS IAM account with concurrent sessions originating from more than one unique IP address within a 5-minute span. This detection leverages AWS CloudTrail logs, specifically the DescribeEventAggregates API call, to identify multiple IP addresses associated with the same user session. This behavior is significant as it may indicate a session hijacking attack, where an adversary uses stolen session cookies to access AWS resources from a different location.",AWS CloudTrail,"Collection, Discovery",T1185,"`amazon_security_lake` api.operation=DescribeEventAggregates src_endpoint.domain!=""AWS Internal"" 
| bin span=5m _time 
| stats min(_time) as firstTime max(_time) as lastTime values(api.operation) as api.operation values(api.service.name) as api.service.name values(http_request.user_agent) as http_request.user_agent values(src_endpoint.ip) as src_ip values(actor.user.account.uid) as actor.user.account.uid values(cloud.provider) as cloud.provider values(cloud.region) as cloud.region dc(src_endpoint.ip) as distinct_ip_count by _time actor.user.uid 
| where distinct_ip_count > 1 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_concurrent_sessions_from_different_ips_filter`"
ASL AWS Create Access Key,"The following analytic identifies the creation of AWS IAM access keys by a user for another user, which can indicate privilege escalation. It leverages AWS CloudTrail logs to detect instances where the user creating the access key is different from the user for whom the key is created. This activity is significant because unauthorized access key creation can allow attackers to establish persistence or exfiltrate data via AWS APIs.",AWS CloudTrail,"Persistence, Privilege Escalation, Exfiltration",T1136.003,"`amazon_security_lake` api.operation=CreateAccessKey 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`asl_aws_create_access_key_filter`"
ASL AWS Create Policy Version to allow all resources,"The following analytic identifies the creation of a new AWS IAM policy version that allows access to all resources. It detects this activity by analyzing AWS CloudTrail logs for the CreatePolicyVersion event with a policy document that grants broad permissions. This behavior is significant because it violates the principle of least privilege, potentially exposing the environment to misuse or abuse.",AWS CloudTrail,"Exfiltration, Credential Access, Privilege Escalation, Defense Evasion",T1078.004,"`amazon_security_lake` api.operation=CreatePolicy 
| spath input=api.request.data 
| spath input=policyDocument 
| regex Statement{}.Action=""\*"" 
| regex Statement{}.Resource=""\*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`asl_aws_create_policy_version_to_allow_all_resources_filter`"
ASL AWS Credential Access RDS Password reset,"The following analytic detects the resetting of the master user password for an Amazon RDS DB instance. It leverages AWS CloudTrail logs from Amazon Security Lake to identify events where the ModifyDBInstance API call includes a new masterUserPassword parameter. This activity is significant because unauthorized password resets can grant attackers access to sensitive data stored in production databases, such as credit card information, PII, and healthcare data.",AWS CloudTrail,Credential Access,"T1586.003, T1110","`amazon_security_lake` api.operation=ModifyDBInstance OR api.operation=ModifyDBCluster 
| spath input=api.request.data 
| search masterUserPassword=* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`asl_aws_credential_access_rds_password_reset_filter`"
ASL AWS IAM Assume Role Policy Brute Force,"The following analytic detects multiple failed attempts to assume an AWS IAM role, indicating a potential brute force attack. It leverages AWS CloudTrail logs to identify MalformedPolicyDocumentException errors with a status of failure and filters out legitimate AWS services. This activity is significant as repeated failures to assume roles can indicate an adversary attempting to guess role names, which is a precursor to unauthorized access.",AWS CloudTrail,"Discovery, Credential Access, Privilege Escalation","T1110, T1580","`amazon_security_lake` api.operation=""AssumeRole"" ""api.response.error""=AccessDenied 
| bucket _time span=1h 
| stats count as failures min(_time) as firstTime max(_time) as lastTime values(api.operation) as api.operation values(api.service.name) as api.service.name values(http_request.user_agent) as http_request.user_agent values(src_endpoint.ip) as src_ip values(actor.user.account.uid) as actor.user.account.uid values(cloud.provider) as cloud.provider values(cloud.region) as cloud.region by _time actor.user.uid 
| where failures >= 3 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_iam_assume_role_policy_brute_force_filter`"
ASL AWS Network Access Control List Deleted,"The following analytic detects the deletion of AWS Network Access Control Lists (ACLs). It leverages AWS CloudTrail logs to identify events where a user deletes a network ACL entry. This activity is significant because deleting a network ACL can remove critical access restrictions, potentially allowing unauthorized access to cloud instances. If confirmed malicious, this action could enable attackers to bypass network security controls, leading to unauthorized access, data exfiltration, or further compromise of the cloud environment.",AWS CloudTrail,"Exfiltration, Defense Evasion",T1562.007,"`amazon_security_lake` api.operation=DeleteNetworkAclEntry status=Success 
| spath input=api.request.data path=egress output=egress 
| spath input=api.request.data path=networkAclId output=networkAclId 
| search egress=false 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region networkAclId 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_network_access_control_list_deleted_filter`"
AWS Concurrent Sessions From Different Ips,"The following analytic identifies an AWS IAM account with concurrent sessions originating from more than one unique IP address within a 5-minute window. It leverages AWS CloudTrail logs, specifically the DescribeEventAggregates event, to detect this behavior. This activity is significant as it may indicate a session hijacking attack, where an adversary uses stolen session cookies to access AWS resources from a different location.",AWS CloudTrail,"Collection, Credential Access",T1185,"`cloudtrail` eventName = DescribeEventAggregates src_ip!=""AWS Internal"" 
| bin span=5m _time 
| rename user_name as user 
| stats min(_time) as firstTime max(_time) as lastTime values(user_agent) as user_agent values(signature) as signature values(src) as src values(dest) as dest dc(src) as distinct_ip_count by _time user vendor_account vendor_region vendor_product 
| where distinct_ip_count > 1 
|  `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `aws_concurrent_sessions_from_different_ips_filter`"
AWS Credential Access RDS Password reset,"The following analytic detects the resetting of the master user password for an Amazon RDS DB instance. It leverages AWS CloudTrail logs to identify events where the ModifyDBInstance API call includes a new masterUserPassword parameter. This activity is significant because unauthorized password resets can grant attackers access to sensitive data stored in production databases, such as credit card information, PII, and healthcare data.",AWS CloudTrail,"Credential Access, Exfiltration","T1586.003, T1110","`cloudtrail` eventSource=""rds.amazonaws.com"" eventName=ModifyDBInstance ""requestParameters.masterUserPassword""=* 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.dBInstanceIdentifier) as database_id by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `aws_credential_access_rds_password_reset_filter`"
AWS Exfiltration via DataSync Task,"The following analytic detects the creation of an AWS DataSync task, which could indicate potential data exfiltration. It leverages AWS CloudTrail logs to identify the CreateTask event from the DataSync service. This activity is significant because attackers can misuse DataSync to transfer sensitive data from a private AWS location to a public one, leading to data compromise.",AWS CloudTrail,"Collection, Credential Access, Exfiltration",T1119,"`cloudtrail` eventName = CreateTask eventSource=""datasync.amazonaws.com"" 
| rename  requestParameters.*  as * 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product destinationLocationArn sourceLocationArn 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_exfiltration_via_datasync_task_filter`"
AWS Multi-Factor Authentication Disabled,"The following analytic detects attempts to disable multi-factor authentication (MFA) for an AWS IAM user. It leverages AWS CloudTrail logs to identify events where MFA devices are deleted or deactivated. This activity is significant because disabling MFA can indicate an adversary attempting to weaken account security, potentially to maintain persistence using a compromised account.",AWS CloudTrail,"Exfiltration, Persistence, Credential Access, Defense Evasion","T1556.006, T1586.003, T1621","`cloudtrail` (eventName= DeleteVirtualMFADevice OR eventName=DeactivateMFADevice) 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_multi_factor_authentication_disabled_filter`"
Azure AD Application Administrator Role Assigned,"The following analytic identifies the assignment of the Application Administrator role to an Azure AD user. It leverages Azure Active Directory events, specifically monitoring the &quot;Add member to role&quot; operation. This activity is significant because users in this role can manage all aspects of enterprise applications, including credentials, which can be used to impersonate application identities.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation","T1098, T1098.003","`azure_monitor_aad`  operationName=""Add member to role""  ""properties.targetResources{}.modifiedProperties{}.newValue""=""*Application Administrator*"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy, userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_application_administrator_role_assigned_filter`"
Azure AD Concurrent Sessions From Different Ips,"The following analytic detects an Azure AD account with concurrent sessions originating from multiple unique IP addresses within a 5-minute window. It leverages Azure Active Directory NonInteractiveUserSignInLogs to identify this behavior by analyzing successful authentication events and counting distinct source IPs. This activity is significant as it may indicate session hijacking, where an attacker uses stolen session cookies to access corporate resources from a different location.",Azure AD (Microsoft Entra ID),Collection,T1185,"`azure_monitor_aad` properties.authenticationDetails{}.succeeded=true category=NonInteractiveUserSignInLogs action=success 
| rename properties.* as * 
| bucket span=5m _time 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(src) as unique_ips values(dest) as dest values(src) as src values(user_agent) as user_agent by user _time vendor_account vendor_product category 
| where unique_ips > 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_concurrent_sessions_from_different_ips_filter`"
Azure AD Global Administrator Role Assigned,"The following analytic detects the assignment of the Azure AD Global Administrator role to a user. It leverages Azure Active Directory AuditLogs to identify when the &quot;Add member to role&quot; operation includes the &quot;Global Administrator&quot; role. This activity is significant because the Global Administrator role grants extensive access to data, resources, and settings, similar to a Domain Administrator in traditional AD environments.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation","T1098, T1098.003","`azure_monitor_aad` operationName=""Add member to role"" properties.targetResources{}.modifiedProperties{}.newValue=""*Global Administrator*"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_global_administrator_role_assigned_filter`"
Azure AD Multi-Factor Authentication Disabled,"The following analytic detects attempts to disable multi-factor authentication (MFA) for an Azure AD user. It leverages Azure Active Directory AuditLogs to identify the &quot;Disable Strong Authentication&quot; operation. This activity is significant because disabling MFA can allow adversaries to maintain persistence using compromised accounts without raising suspicion. If confirmed malicious, this action could enable attackers to bypass an essential security control, potentially leading to unauthorized access and prolonged undetected presence in the environment.",Azure AD (Microsoft Entra ID),"Persistence, Credential Access, Defense Evasion","T1556.006, T1556, T1586.003","`azure_monitor_aad` category=AuditLogs operationName=""Disable Strong Authentication"" 
| rename properties.* as * 
| rename targetResources{}.type as type 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multi_factor_authentication_disabled_filter`"
Azure AD New MFA Method Registered,The following analytic detects the registration of a new Multi-Factor Authentication (MFA) method for a user account in Azure Active Directory. It leverages Azure AD audit logs to identify changes in MFA configurations. This activity is significant because adding a new MFA method can indicate an attacker's attempt to maintain persistence on a compromised account.,Azure AD (Microsoft Entra ID),Persistence,"T1098, T1098.005","`azure_monitor_aad` operationName=""Update user"" 
| rename properties.* as * 
| eval propertyName = mvindex('targetResources{}.modifiedProperties{}.displayName',0) 
| search propertyName = StrongAuthenticationMethod 
| eval oldvalue = mvindex('targetResources{}.modifiedProperties{}.oldValue',0) 
| eval newvalue = mvindex('targetResources{}.modifiedProperties{}.newValue',0) 
| rex field=newvalue max_match=0 ""(?i)(?<new_method_type>\""MethodType\"")"" 
| rex field=oldvalue max_match=0 ""(?i)(?<old_method_type>\""MethodType\"")"" 
| eval count_new_method_type = coalesce(mvcount(new_method_type), 0) 
| eval count_old_method_type = coalesce(mvcount(old_method_type), 0) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product newvalue oldvalue signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_new_mfa_method_registered_filter`"
Azure AD New MFA Method Registered For User,The following analytic detects the registration of a new Multi-Factor Authentication (MFA) method for an Azure AD account. It leverages Azure AD AuditLogs to identify when a user registers new security information. This activity is significant because adversaries who gain unauthorized access to an account may add their own MFA method to maintain persistence.,Azure AD (Microsoft Entra ID),"Persistence, Credential Access","T1556.006, T1556","`azure_monitor_aad` category=AuditLogs operationName=""User registered security info"" properties.operationType=Add 
| rename properties.* as * 
| rename targetResources{}.* as * 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest user src vendor_account vendor_product user_agent result resultDescription signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_new_mfa_method_registered_for_user_filter`"
Azure AD PIM Role Assigned,"The following analytic detects the assignment of an Azure AD Privileged Identity Management (PIM) role. It leverages Azure Active Directory events to identify when a user is added as an eligible member to a PIM role. This activity is significant because PIM roles grant elevated privileges, and their assignment should be closely monitored to prevent unauthorized access.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation",T1098.003,"`azure_monitor_aad` operationName=""Add eligible member to role in PIM completed*"" 
| rename properties.* as * 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_pim_role_assigned_filter`"
Azure AD PIM Role Assignment Activated,"The following analytic detects the activation of an Azure AD Privileged Identity Management (PIM) role. It leverages Azure Active Directory events to identify when a user activates a PIM role assignment, indicated by the &quot;Add member to role completed (PIM activation)&quot; operation. Monitoring this activity is crucial as PIM roles grant elevated privileges, and unauthorized activation could indicate an adversary attempting to gain privileged access.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation",T1098.003,"`azure_monitor_aad` operationName=""Add member to role completed (PIM activation)"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_pim_role_assignment_activated_filter`"
Azure AD Privileged Authentication Administrator Role Assigned,"The following analytic detects the assignment of the Privileged Authentication Administrator role to an Azure AD user. It leverages Azure Active Directory audit logs to identify when this specific role is assigned. This activity is significant because users in this role can set or reset authentication methods for any user, including those in privileged roles like Global Administrators.",Azure AD (Microsoft Entra ID),"Credential Access, Privilege Escalation",T1003.002,"`azure_monitor_aad` ""operationName""=""Add member to role"" ""properties.targetResources{}.modifiedProperties{}.newValue""=""\""Privileged Authentication Administrator\"""" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_privileged_authentication_administrator_role_assigned_filter`"
Azure AD Privileged Role Assigned to Service Principal,"The following analytic detects the assignment of privileged roles to service principals in Azure Active Directory (AD). It leverages the AuditLogs log category from ingested Azure AD events. This activity is significant because assigning elevated permissions to non-human entities can lead to unauthorized access or malicious activities. If confirmed malicious, attackers could exploit these service principals to gain elevated access to Azure resources, potentially compromising sensitive data and critical infrastructure.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation",T1098.003,"`azure_monitor_aad` operationName=""Add member to role"" 
| rename properties.* as * 
| search ""targetResources{}.type""=ServicePrincipal 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename targetResources{}.modifiedProperties{}.newValue as roles 
| eval role=mvindex(roles,1) 
| rename targetResources{}.displayName as apps 
| eval displayName=mvindex(apps,0) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product displayName initiatedBy result role signature 
| lookup privileged_azure_ad_roles azureadrole AS role OUTPUT isprvilegedadrole description 
| search isprvilegedadrole = True 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_privileged_role_assigned_to_service_principal_filter`"
Azure AD Service Principal New Client Credentials,"The following analytic detects the addition of new credentials to Service Principals and Applications in Azure AD. It leverages Azure AD AuditLogs, specifically monitoring the &quot;Update application*Certificates and secrets management&quot; operation. This activity is significant as it may indicate an adversary attempting to maintain persistent access or escalate privileges within the Azure environment.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation","T1098.001, T1098","`azure_monitor_aad` category=AuditLogs operationName=""Update application*Certificates and secrets management "" 
| rename properties.* as * 
| rename targetResources{}.* as * 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product modifiedProperties{}.newValue signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_service_principal_new_client_credentials_filter`"
Azure AD User Enabled And Password Reset,The following analytic detects an Azure AD user enabling a previously disabled account and resetting its password within 2 minutes. It uses Azure Active Directory events to identify this sequence of actions. This activity is significant because it may indicate an adversary with administrative access attempting to establish a backdoor identity within the Azure AD tenant.,Azure AD (Microsoft Entra ID),Persistence,T1098,"`azure_monitor_aad` (operationName=""Enable account"" OR operationName=""Reset password (by admin)"" OR operationName=""Update user"") 
| transaction user startsWith=(operationName=""Enable account"") endsWith=(operationName=""Reset password (by admin)"") maxspan=2m 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_user_enabled_and_password_reset_filter`"
Azure AD User ImmutableId Attribute Updated,"The following analytic identifies the modification of the SourceAnchor (ImmutableId) attribute for an Azure Active Directory user. This detection leverages Azure AD audit logs, specifically monitoring the &quot;Update user&quot; operation and changes to the SourceAnchor attribute. This activity is significant as it is a step in setting up an Azure AD identity federation backdoor, allowing an adversary to establish persistence.",Azure AD (Microsoft Entra ID),Persistence,T1098,"`azure_monitor_aad` operationName=""Update user"" properties.targetResources{}.modifiedProperties{}.displayName=SourceAnchor 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename targetResources{}.modifiedProperties{}.newValue as modifiedProperties 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_user_immutableid_attribute_updated_filter`"
GCP Authentication Failed During MFA Challenge,The following analytic detects failed authentication attempts during the Multi-Factor Authentication (MFA) challenge on a Google Cloud Platform (GCP) tenant. It uses Google Workspace login failure events to identify instances where MFA methods were challenged but not successfully completed. This activity is significant as it may indicate an adversary attempting to access an account with compromised credentials despite MFA protection.,GCP,"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`gws_reports_login` event.name=login_failure `gws_login_mfa_methods` 
| stats count min(_time) as firstTime max(_time) as lastTime by user, src_ip, login_challenge_method 
| `gcp_authentication_failed_during_mfa_challenge_filter`"
GCP Kubernetes cluster pod scan detection,The following analytic identifies unauthenticated requests to Kubernetes cluster pods.,GCP,Discovery,T1526,"`google_gcp_pubsub_message` category=kube-audit 
|spath input=properties.log 
|search responseStatus.code=401 
|table sourceIPs{} userAgent verb requestURI responseStatus.reason properties.pod 
| `gcp_kubernetes_cluster_pod_scan_detection_filter`"
GCP Multi-Factor Authentication Disabled,"The following analytic detects an attempt to disable multi-factor authentication (MFA) for a Google Cloud Platform (GCP) user. It leverages Google Workspace Admin log events, specifically the UNENROLL_USER_FROM_STRONG_AUTH command. This activity is significant because disabling MFA can allow an adversary to maintain persistence within the environment using a compromised account without raising suspicion.",GCP,"Exfiltration, Persistence, Credential Access, Defense Evasion","T1556.006, T1556, T1586.003","`gws_reports_admin` command=UNENROLL_USER_FROM_STRONG_AUTH 
| stats count min(_time) as firstTime max(_time) as lastTime by user, command, actor.email, status, id.applicationName, event.name, vendor_account, action 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `gcp_multi_factor_authentication_disabled_filter`"
GCP Multiple Failed MFA Requests For User,"The following analytic detects multiple failed multi-factor authentication (MFA) requests for a single user within a Google Cloud Platform (GCP) tenant. It triggers when 10 or more MFA prompts fail within a 5-minute window, using Google Workspace login failure events. This behavior is significant as it may indicate an adversary attempting to bypass MFA by bombarding the user with repeated authentication requests.",GCP,"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`gws_reports_login` event.name=login_failure `gws_login_mfa_methods` 
| bucket span=5m _time 
| stats dc(_raw) AS mfa_prompts values(user) AS user by src_ip, login_challenge_method,  _time 
| where mfa_prompts >= 10 
| `gcp_multiple_failed_mfa_requests_for_user_filter`"
GCP Successful Single-Factor Authentication,"The following analytic identifies a successful single-factor authentication event against Google Cloud Platform (GCP) for an account without Multi-Factor Authentication (MFA) enabled. It uses Google Workspace login event data to detect instances where MFA is not utilized. This activity is significant as it may indicate a misconfiguration, policy violation, or potential account takeover attempt.",GCP,"Initial Access, Defense Evasion","T1586.003, T1078.004, T1078","`gws_reports_login` event.name=login_success NOT `gws_login_mfa_methods` 
| stats count min(_time) as firstTime max(_time) as lastTime by user, src_ip,  login_challenge_method, app, event.name, vendor_account, action 
|`security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `gcp_successful_single_factor_authentication_filter`"
Gdrive suspicious file sharing,"The following analytic identifies suspicious file-sharing activity on Google Drive, where internal users share documents with more than 50 external recipients.",Google Workspace,"Initial Access, Exfiltration",T1566,"`gsuite_drive` name=change_user_access 
| rename parameters.* as * 
| search email = ""*@yourdomain.com"" target_user != ""*@yourdomain.com"" 
| stats count values(owner) as owner values(target_user) as target values(doc_type) as doc_type values(doc_title) as doc_title dc(target_user) as distinct_target by src_ip email 
| where distinct_target > 50 
| `gdrive_suspicious_file_sharing_filter`"
Gsuite Drive Share In External Email,The following analytic detects Google Drive or Google Docs files shared externally from an internal domain.,Google Workspace,Exfiltration,T1567.002,"`gsuite_drive` NOT (email IN("""", ""null""))
| spath path=parameters.owner output=owner
| rex field=owner ""[^@]+@(?<src_domain>[^@]+)""
| rex field=email ""[^@]+@(?<dest_domain>[^@]+)""
| where src_domain = ""internal_test_email.com"" and not dest_domain = ""internal_test_email.com""
| eval phase=""plan""
| eval severity=""low""
| stats values(parameters.doc_title) as doc_title,
values(parameters.doc_type) as doc_types,
values(email) as dst_email_list,
values(parameters.visibility) as visibility,
values(parameters.doc_id) as doc_id,
count min(_time) as firstTime max(_time) as lastTime
by parameters.owner ip_address phase severity
| rename parameters.owner as user ip_address as src_ip
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `gsuite_drive_share_in_external_email_filter`"
O365 Multiple Failed MFA Requests For User,"The following analytic identifies potential &quot;MFA fatigue&quot; attacks targeting Office 365 users by detecting more than nine Multi-Factor Authentication (MFA) prompts within a 10-minute timeframe. It leverages O365 management activity logs, focusing on Azure Active Directory events with the UserLoginFailed operation, a Success ResultStatus, and an ErrorNumber of 500121. This activity is significant as attackers may exploit MFA fatigue to gain unauthorized access by overwhelming users with repeated MFA requests.",Office 365 (Microsoft 365),Credential Access,T1621,"`o365_management_activity` Workload=AzureActiveDirectory Operation=UserLoginFailed ResultStatus=Success ErrorNumber=500121 
| bucket span=10m _time 
| stats dc(_raw) as mfa_prompts values(LogonError) as LogonError values(signature) as signature values(action) as action values(src) as src by user _time vendor_account vendor_product dest 
| where mfa_prompts > 9 
| `o365_multiple_failed_mfa_requests_for_user_filter`"
O365 Privileged Role Assigned,"The following analytic identifies the assignment of sensitive and privileged Azure Active Directory roles to an Azure AD user. Adversaries and red teams alike may assign these roles to a compromised account to establish Persistence in an Azure AD environment. This detection leverages the O365 Universal Audit Log data source.
Search 1`o365_management_activity` Workload=AzureActiveDirectory Operation IN (&#34;Add member to role.",Azure AD (Microsoft Entra ID),Persistence,"T1098, T1098.003","`o365_management_activity` Workload=AzureActiveDirectory Operation IN (""Add member to role."",""Add eligible member to role."") 
| eval user = ObjectId, src_user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)), object_name = mvindex('ModifiedProperties{}.NewValue', mvfind('ModifiedProperties{}.Name',""Role\.DisplayName"")), object_id = mvindex('ModifiedProperties{}.NewValue', mvfind('ModifiedProperties{}.Name',""Role\.TemplateId"")), signature = Operation, result = ResultStatus, category = mvindex('Target{}.ID',2) 
| fillnull 
| stats count, min(_time) as firstTime, max(_time) as lastTime by src_user, src, user, category, result, object_name, object_id, signature, vendor_account, vendor_product, dest 
| lookup privileged_azure_ad_roles azuretemplateid as object_id OUTPUT isprvilegedadrole 
| search isprvilegedadrole=""TRUE"" category=""User"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_privileged_role_assigned_filter`"
O365 Privileged Role Assigned To Service Principal,"The following analytic detects potential privilege escalation threats in Azure Active Directory (AD). This detection is important because it identifies instances where privileged roles that hold elevated permissions are assigned to service principals. This prevents unauthorized access or malicious activities, which occur when these non-human entities access Azure resources to exploit them. False positives might occur since administrators can legitimately assign privileged roles to service principals.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation","T1098, T1098.003","`o365_management_activity` Workload=AzureActiveDirectory Operation IN (""Add member to role."",""Add eligible member to role."") 
| eval user = ObjectId, src_user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)), object_name = mvindex('ModifiedProperties{}.NewValue', mvfind('ModifiedProperties{}.Name',""Role\.DisplayName"")), object_id = mvindex('ModifiedProperties{}.NewValue', mvfind('ModifiedProperties{}.Name',""Role\.TemplateId"")), signature = Operation, result = ResultStatus, category = mvindex('Target{}.ID',2) 
| fillnull 
| stats count, min(_time) as firstTime, max(_time) as lastTime by src_user, src, user, category, result, object_name, object_id, signature,vendor_account, vendor_product, dest 
| lookup privileged_azure_ad_roles azuretemplateid as object_id OUTPUT isprvilegedadrole 
| search isprvilegedadrole=""TRUE"" category!=""User"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_privileged_role_assigned_to_service_principal_filter`"
Access LSASS Memory for Dump Creation,"The following analytic detects attempts to dump the LSASS process memory, a common technique in credential dumping attacks. It leverages Sysmon logs, specifically EventCode 10, to identify suspicious call traces to dbgcore.dll and dbghelp.dll associated with lsass.exe. This activity is significant as it often precedes the theft of sensitive login credentials, posing a high risk of unauthorized access to systems and data.",Windows Events,"Lateral Movement, Credential Access, Discovery",T1003.001,"`sysmon` EventCode=10 TargetImage=*lsass.exe CallTrace=*dbgcore.dll* OR CallTrace=*dbghelp.dll* 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `access_lsass_memory_for_dump_creation_filter`"
AdsiSearcher Account Discovery,"The following analytic detects the use of the [Adsisearcher] type accelerator in PowerShell to query Active Directory for domain users. It leverages PowerShell Script Block Logging (EventCode=4104) to identify script blocks containing [adsisearcher], objectcategory=user, and .findAll(). This activity is significant as it may indicate an attempt by adversaries or Red Teams to enumerate domain users for situational awareness and Active Directory discovery.",Windows Events,"Lateral Movement, Discovery, Privilege Escalation","T1087.002, T1087",[Adsisearcher]
Allow File And Printing Sharing In Firewall,"The following analytic detects the modification of firewall settings to allow file and printer sharing. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving 'netsh' commands that enable file and printer sharing. This activity is significant because it can indicate an attempt by ransomware to discover and encrypt files on additional machines connected to the compromised host.",Windows Events,"Execution, Impact, Discovery, Defense Evasion",T1562.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` Processes.process= ""*firewall*"" Processes.process= ""*group=\""File and Printer Sharing\""*""  Processes.process=""*enable=Yes*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `allow_file_and_printing_sharing_in_firewall_filter`"
Allow Network Discovery In Firewall,"The following analytic detects a suspicious modification to the firewall to allow network discovery on a machine. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving the 'netsh' command to enable network discovery. This activity is significant because it is commonly used by ransomware, such as REvil and RedDot, to discover and compromise additional machines on the network.",Windows Events,"Execution, Impact, Discovery, Defense Evasion",T1562.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` Processes.process= ""*firewall*"" Processes.process= ""*group=\""Network Discovery\""*""  Processes.process=""*enable*"" Processes.process=""*Yes*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `allow_network_discovery_in_firewall_filter`"
BITSAdmin Download File,"The following analytic detects the use of bitsadmin.exe with the transfer parameter to download a remote object. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. This activity is significant because bitsadmin.exe can be exploited to download and execute malicious files without immediate detection. If confirmed malicious, an attacker could use this technique to download and execute payloads, potentially leading to code execution, privilege escalation, or persistent access within the environment.",Windows Events,"Command And Control, Execution, Persistence, Privilege Escalation, Defense Evasion","T1197, T1105","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_bitsadmin` Processes.process IN (""*transfer*"", ""*addfile*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `bitsadmin_download_file_filter`"
Cisco NVM - Rclone Execution With Network Activity,"This detection identifies execution of the file synchronization utility &quot;rclone&quot;. It leverages Cisco Network Visibility Module logs, specifically flow data in order to capture process executions initiating network connections. While rclone is a legitimate command-line tool for syncing data to cloud storage providers, it has been widely abused by threat actors for data exfiltration.",Cisco NVM,"Execution, Discovery, Exfiltration",T1567.002,"`cisco_network_visibility_module_flowdata`
(
process_name = ""rclone.exe""
OR
(
process_arguments = ""* copy *""
process_arguments = ""*\\\\*""
process_arguments IN (""*remote:*"", ""*mega:*"", ""*ftp:*"", ""*ftp1:*"")
)
OR
(
process_arguments IN (""*remote:*"", ""*mega:*"", ""*ftp:*"", ""*ftp1:*"")
process_arguments = ""*--transfers""
process_arguments = ""*--ignore-existing*""
process_arguments = ""*--auto-confirm*""
)
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___rclone_execution_with_network_activity_filter`"
Conti Common Exec parameter,"The following analytic detects the execution of suspicious command-line arguments commonly associated with Conti ransomware, specifically targeting local drives and network shares for encryption. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a potential ransomware attack, which can lead to widespread data encryption and operational disruption.",Windows Events,"Execution, Impact",T1204,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*-m local*"" OR Processes.process = ""*-m net*"" OR Processes.process = ""*-m all*"" OR Processes.process = ""*-nomutex*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `conti_common_exec_parameter_filter`"
Creation of lsass Dump with Taskmgr,"The following analytic detects the creation of an lsass.exe process dump using Windows Task Manager. It leverages Sysmon EventID 11 to identify file creation events where the target filename matches lsass.dmp. This activity is significant because creating an lsass dump can be a precursor to credential theft, as the dump file contains sensitive information such as user passwords.",Windows Events,Credential Access,"T1003, T1003.001","`sysmon` EventID=11 process_name=taskmgr.exe TargetFilename=*lsass*.dmp 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path  process_guid process_id user_id vendor_product process_name TargetFilename 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `creation_of_lsass_dump_with_taskmgr_filter`"
Detect Credential Dumping through LSASS access,"The following analytic detects attempts to read LSASS memory, indicative of credential dumping. It leverages Sysmon EventCode 10, filtering for specific access permissions (0x1010 and 0x1410) on the lsass.exe process. This activity is significant because it suggests an attacker is trying to extract credentials from LSASS memory, potentially leading to unauthorized access, data breaches, and compromise of sensitive information.",Windows Events,Credential Access,T1003.001,"`sysmon` EventCode=10 TargetImage=*lsass.exe (GrantedAccess=0x1010 OR GrantedAccess=0x1410) 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_credential_dumping_through_lsass_access_filter`"
Detect Empire with PowerShell Script Block Logging,"The following analytic detects suspicious PowerShell execution indicative of PowerShell-Empire activity. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze commands sent to PowerShell, specifically looking for patterns involving system.net.webclient and base64 encoding. This behavior is significant as it often represents initial stagers used by PowerShell-Empire, a known post-exploitation framework. If confirmed malicious, this activity could allow attackers to download and execute additional payloads, leading to potential code execution, data exfiltration, or further compromise of the affected system.",Windows Events,"Execution, Exfiltration",T1059.001,"`powershell` EventCode=4104  (ScriptBlockText=*system.net.webclient* AND ScriptBlockText=*frombase64string*) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_empire_with_powershell_script_block_logging_filter`"
Detect Excessive User Account Lockouts,"The following analytic identifies user accounts experiencing an excessive number of lockouts within a short timeframe. It leverages the 'Change' data model, specifically focusing on events where the result indicates a lockout. This activity is significant as it may indicate a brute-force attack or misconfiguration, both of which require immediate attention. If confirmed malicious, this behavior could lead to account compromise, unauthorized access, and potential lateral movement within the network.",Windows Events,"Lateral Movement, Defense Evasion",T1078.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where  All_Changes.result=""*lock*"" by All_Changes.user All_Changes.result 
|`drop_dm_object_name(""All_Changes"")` 
|`drop_dm_object_name(""Account_Management"")`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| search count > 5 
| `detect_excessive_user_account_lockouts_filter`"
Detect Mimikatz With PowerShell Script Block Logging,"The following analytic detects the execution of Mimikatz commands via PowerShell by leveraging PowerShell Script Block Logging (EventCode=4104). This method captures and logs the full command sent to PowerShell, allowing for the identification of suspicious activities such as Pass the Ticket, Pass the Hash, and credential dumping. This activity is significant as Mimikatz is a well-known tool used for credential theft and lateral movement.",Windows Events,"Lateral Movement, Execution, Credential Access, Privilege Escalation","T1059.001, T1003","`powershell` EventCode=4104 ScriptBlockText IN (*mimikatz*, *-dumpcr*, *sekurlsa::pth*, *kerberos::ptt*, *kerberos::golden*) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_mimikatz_with_powershell_script_block_logging_filter`"
Detect Remote Access Software Usage FileInfo,"The following analytic detects the execution of processes with file or code signing attributes from known remote access software within the environment. It leverages Sysmon EventCode 1 data and cross-references a lookup table of remote access utilities such as AnyDesk, GoToMyPC, LogMeIn, and TeamViewer. This activity is significant as adversaries often use these tools to maintain unauthorized remote access.",Windows Events,"Collection, Execution, Command And Control, Exfiltration",T1219,"`sysmon` EventCode=1 
| stats count min(_time) as firstTime max(_time) as lastTime, values(Company) as Company values(Product) as Product by action dest original_file_name parent_process parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process process_exec process_guid process_hash process_id process_integrity_level process_name process_path user user_id vendor_product 
| lookup remote_access_software remote_utility_fileinfo AS Product OUTPUT isutility, description as signature, comment_reference as desc, category 
| search isutility = True 
| `remote_access_software_usage_exceptions` 
| `detect_remote_access_software_usage_fileinfo_filter`"
Detect Remote Access Software Usage Registry,"The following analytic detects when a known remote access software is added to common persistence locations on a device within the environment. Adversaries use these utilities to retain remote access capabilities to the environment. Utilities in the lookup include AnyDesk, GoToMyPC, LogMeIn, TeamViewer and much more. Review the lookup for the entire list and add any others.",Windows Events,"Collection, Persistence, Command And Control",T1219,"| tstats `security_content_summariesonly` latest(Registry.process_guid) as process_guid  count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=""*\\Microsoft\\Windows\\CurrentVersion\\Run*"" OR (Registry.registry_path=""*\\SYSTEM\\CurrentControlSet\\Services\\*"" AND Registry.registry_value_name=""ImagePath"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| rex field=registry_value_data ""(\"")?.+\\\(?<file_name_1>[^\""=]+\.[^\"" ]{1,5})(\"")?"" 
| rex field=registry_value_data ""(?<file_name_2>[^\.]+\.[^\"" ]{1,5}$)"" 
| eval file_name = coalesce(file_name_1,file_name_2) 
| lookup remote_access_software remote_utility AS file_name OUTPUT isutility, description as signature, comment_reference as desc, category 
| search isutility = TRUE 
| `remote_access_software_usage_exceptions` 
| `detect_remote_access_software_usage_registry_filter`"
Detect WMI Event Subscription Persistence,"The following analytic identifies the creation of WMI Event Subscriptions, which can be used to establish persistence or perform privilege escalation. It detects EventID 19 (EventFilter creation), EventID 20 (EventConsumer creation), and EventID 21 (FilterToConsumerBinding creation) from Sysmon logs. This activity is significant because WMI Event Subscriptions can execute code with elevated SYSTEM privileges, making it a powerful persistence mechanism.",Windows Events,"Discovery, Persistence, Privilege Escalation",T1546.003,"`sysmon` EventID=20 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc object object_category object_path signature signature_id src status user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_wmi_event_subscription_persistence_filter`"
Domain Group Discovery with Adsisearcher,The following analytic detects the use of the [Adsisearcher] type accelerator in PowerShell to query Active Directory for domain groups. It leverages PowerShell Script Block Logging (EventCode=4104) to identify specific script blocks containing [adsisearcher] and group-related queries. This activity is significant as it may indicate an attempt by adversaries or Red Teams to enumerate domain groups for situational awareness and Active Directory discovery.,Windows Events,"Discovery, Persistence, Privilege Escalation, Lateral Movement","T1069.002, T1069",[Adsisearcher]
GetAdGroup with PowerShell Script Block,"The following analytic detects the execution of the Get-AdGroup PowerShell cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet is used to enumerate all domain groups, which adversaries may exploit for situational awareness and Active Directory discovery. Monitoring this activity is crucial as it can indicate reconnaissance efforts within the network. If confirmed malicious, this behavior could lead to further exploitation, such as privilege escalation or lateral movement, by providing attackers with detailed information about the domain's group structure.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069.002, T1069","`powershell` EventCode=4104 ScriptBlockText = ""*Get-ADGroup*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getadgroup_with_powershell_script_block_filter`"
GPUpdate with no Command Line Arguments with Network,"The following analytic detects the execution of gpupdate.exe without command line arguments and with an active network connection. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process execution and network traffic data. It is significant because gpupdate.exe typically runs with specific arguments, and its execution without them, especially with network activity, is often associated with malicious software like Cobalt Strike.",Windows Events,"Lateral Movement, Execution, Command And Control, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=gpupdate.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| regex process=""(?i)(gpupdate\.exe.{0,4}$)""
| join  process_id [
| tstats `security_content_summariesonly` count values(All_Traffic.app) as app values(All_Traffic.dest_ip) as dest_ip values(All_Traffic.direction) as direction values(All_Traffic.dvc) as dvc values(All_Traffic.protocol) as protocol values(All_Traffic.protocol_version) as protocol_version values(All_Traffic.src) as src values(All_Traffic.src_ip) as src_ip values(All_Traffic.src_port) as src_port values(All_Traffic.transport) as transport FROM datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port != 0 by All_Traffic.process_id All_Traffic.dest All_Traffic.dest_port 
| `drop_dm_object_name(All_Traffic)` 
| rename dest as C2 ] 
| table _time user dest parent_process_name process_name process_path process process_id dest_port C2 app dest_ip direction dvc protocol protocol_version src src_ip src_port transport 
| `gpupdate_with_no_command_line_arguments_with_network_filter`"
High Frequency Copy Of Files In Network Share,"The following analytic detects a high frequency of file copying or moving within network shares, which may indicate potential data sabotage or exfiltration attempts. It leverages Windows Security Event Logs (EventCode 5145) to monitor access to specific file types and network shares. This activity is significant as it can reveal insider threats attempting to transfer classified or internal files, potentially leading to data breaches or evidence tampering.",Windows Events,Exfiltration,T1537,"`wineventlog_security` EventCode=5145 RelativeTargetName IN (""*.doc"",""*.docx"",""*.xls"",""*.xlsx"",""*.ppt"",""*.pptx"",""*.log"",""*.txt"",""*.db"",""*.7z"",""*.zip"",""*.rar"",""*.tar"",""*.gz"",""*.jpg"",""*.gif"",""*.png"",""*.bmp"",""*.pdf"",""*.rtf"",""*.key"") ObjectType=File ShareName IN (""\\\\*\\C$"",""\\\\*\\IPC$"",""\\\\*\\admin$"") AccessMask= ""0x2"" 
|  bucket _time span=5m 
| stats values(RelativeTargetName) as valRelativeTargetName, values(ShareName) as valShareName, values(ObjectType) as valObjectType, values(AccessMask) as valAccessmask, values(src_port) as valSrcPort, values(SourceAddress) as valSrcAddress count as numShareName by dest, _time, EventCode, src_user, src_ip 
| eventstats avg(numShareName) as avgShareName, stdev(numShareName) as stdShareName, count as numSlots by dest, _time, EventCode, src_user 
|  eval upperThreshold=(avgShareName + stdShareName *3) 
|  eval isOutlier=if(avgShareName > 20 and avgShareName >= upperThreshold, 1, 0) 
|  search isOutlier=1  
| `high_frequency_copy_of_files_in_network_share_filter`"
High Process Termination Frequency,The following analytic identifies a high frequency of process termination events on a computer within a short period. It leverages Sysmon EventCode 5 logs to detect instances where 15 or more processes are terminated within a 3-second window. This behavior is significant as it is commonly associated with ransomware attempting to avoid exceptions during file encryption.,Windows Events,Impact,T1486,"`sysmon` EventCode=5 
| bin _time span=3s 
| stats values(process) as process values(process_exec) as process_exec values(process_guid) as process_guid values(process_id) as process_id values(process_name) as process_name values(process_path) as process_path values(user_id) as user_id min(_time) as firstTime max(_time) as lastTime count by _time dest EventCode ProcessID signature signature_id vendor_product 
| where count >= 15 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `high_process_termination_frequency_filter`"
Kerberos Service Ticket Request Using RC4 Encryption,"The following analytic detects Kerberos service ticket requests using RC4 encryption, leveraging Kerberos Event 4769. This method identifies potential Golden Ticket attacks, where adversaries forge Kerberos Granting Tickets (TGT) using the Krbtgt account NTLM password hash to gain unrestricted access to an Active Directory environment. Monitoring for RC4 encryption usage is significant as it is rare in modern networks, indicating possible malicious activity.",Windows Events,"Credential Access, Privilege Escalation","T1558.001, T1558","`wineventlog_security` EventCode=4769 ServiceName=""*$"" (TicketOptions=0x40810000 OR TicketOptions=0x40800000 OR TicketOptions=0x40810010) TicketEncryptionType=0x17 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, service, service_id, TicketEncryptionType, TicketOptions 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `kerberos_service_ticket_request_using_rc4_encryption_filter`"
Kerberos TGT Request Using RC4 Encryption,"The following analytic detects a Kerberos Ticket Granting Ticket (TGT) request using RC4-HMAC encryption (type 0x17) by leveraging Event 4768. This encryption type is outdated and its presence may indicate an OverPass The Hash attack. Monitoring this activity is crucial as it can signify credential theft, allowing adversaries to authenticate to the Kerberos Distribution Center (KDC) using a stolen NTLM hash.",Windows Events,"Lateral Movement, Defense Evasion",T1550,"`wineventlog_security` EventCode=4768 TicketEncryptionType=0x17 ServiceName!=*$ 
| stats count min(_time) as firstTime max(_time) as lastTime by ServiceName src_ip dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `kerberos_tgt_request_using_rc4_encryption_filter`"
Linux Account Manipulation Of SSH Config and Keys,"The following analytic detects the deletion of SSH keys on a Linux machine. It leverages filesystem event logs to identify when files within &quot;/etc/ssh/&quot; or &quot;~/.ssh/&quot; are deleted. This activity is significant because attackers may delete or modify SSH keys to evade security measures or as part of a destructive payload, similar to the AcidRain malware.",Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted AND Filesystem.file_path IN (""/etc/ssh/*"", ""~/.ssh/*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_account_manipulation_of_ssh_config_and_keys_filter`"
Linux Auditd Data Transfer Size Limits Via Split,"The following analytic detects suspicious data transfer activities that involve the use of the split syscall, potentially indicating an attempt to evade detection by breaking large files into smaller parts. Attackers may use this technique to bypass size-based security controls, facilitating the covert exfiltration of sensitive data. By monitoring for unusual or unauthorized use of the split syscall, this analytic helps identify potential data exfiltration attempts, allowing security teams to intervene and prevent the unauthorized transfer of critical information from the network.",Linux,"Execution, Exfiltration, Persistence, Privilege Escalation",T1030,"`linux_auditd` execve_command = ""*split*"" AND execve_command = ""*-b *"" 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_data_transfer_size_limits_via_split_filter`"
Linux Auditd Find Credentials From Password Managers,"The following analytic detects suspicious attempts to find credentials stored in password managers, which may indicate an attacker's effort to retrieve sensitive login information. Password managers are often targeted by adversaries seeking to access stored passwords for further compromise or lateral movement within a network. By monitoring for unusual or unauthorized access to password manager files or processes, this analytic helps identify potential credential theft attempts, enabling security teams to respond quickly to protect critical accounts and prevent further unauthorized access.",Linux,"Execution, Credential Access, Lateral Movement, Persistence, Privilege Escalation",T1555.005,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"") AND execve_command IN (""*.kdbx*"", ""*KeePass*"", ""*.enforced*"", ""*.lpdb*"", ""*.opvault*"", ""*.agilekeychain*"", ""*.dashlane*"", ""*.rfx*"", ""*passbolt*"", ""*.spdb*"", ""*StickyPassword*"", ""*.walletx*"", ""*enpass*"", ""*vault*"", ""*.kdb*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_find_credentials_from_password_managers_filter`"
Linux Auditd Find Credentials From Password Stores,"The following analytic detects suspicious attempts to find credentials stored in password stores, indicating a potential attacker's effort to access sensitive login information. Password stores are critical repositories that contain valuable credentials, and unauthorized access to them can lead to significant security breaches. By monitoring for unusual or unauthorized activities related to password store access, this analytic helps identify potential credential theft attempts, allowing security teams to respond promptly and prevent unauthorized access to critical systems and data.",Linux,"Execution, Credential Access, Persistence, Privilege Escalation",T1555.005,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"") AND execve_command IN (""*password*"", ""*pass *"", ""*credential*"", ""*creds*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_find_credentials_from_password_stores_filter`"
Linux Auditd Find Ssh Private Keys,"The following analytic detects suspicious attempts to find SSH private keys, which may indicate an attacker's effort to compromise secure access to systems. SSH private keys are essential for secure authentication, and unauthorized access to these keys can enable attackers to gain unauthorized access to servers and other critical infrastructure. By monitoring for unusual or unauthorized searches for SSH private keys, this analytic helps identify potential threats to network security, allowing security teams to quickly respond and safeguard against unauthorized access and potential breaches.",Linux,"Execution, Credential Access, Persistence, Privilege Escalation",T1552.004,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"") AND execve_command IN (""*id_rsa*"", ""*id_dsa*"", ""*.key*"", ""*ssh_key*"", ""*authorized_keys*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_find_ssh_private_keys_filter`"
Linux Auditd Hardware Addition Swapoff,"The following analytic detects the execution of the &quot;swapoff&quot; command, which disables the swapping of paging devices on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because disabling swap can be a tactic used by malware, such as Awfulshred, to evade detection and hinder forensic analysis.",Linux,"Initial Access, Execution",T1200,"`linux_auditd` proctitle = ""*swapoff*"" AND proctitle = ""*-a*"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `linux_auditd_hardware_addition_swapoff_filter`"
Linux Hardware Addition SwapOff,"The following analytic detects the execution of the &quot;swapoff&quot; command, which disables the swapping of paging devices on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because disabling swap can be a tactic used by malware, such as Awfulshred, to evade detection and hinder forensic analysis.",Linux,"Initial Access, Execution",T1200,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""swapoff"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_hardware_addition_swapoff_filter`"
Linux Impair Defenses Process Kill,"The following analytic identifies the execution of the 'pkill' command, which is used to terminate processes on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because threat actors often use 'pkill' to disable security defenses or terminate critical processes, facilitating further malicious actions.",Linux,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN ( ""pgrep"", ""pkill"") Processes.process = ""*pkill *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_impair_defenses_process_kill_filter`"
Linux Possible Ssh Key File Creation,"The following analytic detects the creation of SSH key files in the ~/.ssh/ directory. It leverages filesystem data to identify new files in this specific path. This activity is significant because threat actors often create SSH keys to gain persistent access and escalate privileges on a compromised host. If confirmed malicious, this could allow attackers to remotely access the machine using the OpenSSH daemon service, leading to potential unauthorized control and data exfiltration.",Linux,"Execution, Exfiltration, Persistence, Privilege Escalation","T1098.004, T1098","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/.ssh*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_possible_ssh_key_file_creation_filter`"
Living Off The Land Detection,"The following correlation identifies multiple risk events associated with the &quot;Living Off The Land&quot; analytic story, indicating potentially suspicious behavior. It leverages the Risk data model to aggregate and correlate events tagged under this story, focusing on systems with a high count of distinct sources. This activity is significant as it often involves the use of legitimate tools for malicious purposes, making detection challenging.",Splunk Risk Rule (Multiple Sources),"Initial Access, Execution, Command And Control, Discovery","T1190, T1133, T1105, T1059","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Living Off The Land"" All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 5 
| `living_off_the_land_detection_filter`"
Local Account Discovery With Wmic,"The following analytic detects the execution of wmic.exe with command-line arguments used to query local user accounts, specifically the useraccount argument. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate local users, which is a common step in situational awareness and Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.001, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=*useraccount*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `local_account_discovery_with_wmic_filter`"
Mimikatz PassTheTicket CommandLine Parameters,"The following analytic detects the use of Mimikatz command line parameters associated with pass-the-ticket attacks. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns related to Kerberos ticket manipulation. This activity is significant because pass-the-ticket attacks allow adversaries to move laterally within an environment using stolen Kerberos tickets, bypassing normal access controls.",Windows Events,"Discovery, Execution, Persistence, Defense Evasion","T1550.003, T1550","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process = ""*sekurlsa::tickets /export*"" OR Processes.process = ""*kerberos::ptt*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `mimikatz_passtheticket_commandline_parameters_filter`"
MOVEit Empty Key Fingerprint Authentication Attempt,"This detection identifies attempts to authenticate with an empty public key fingerprint in Progress MOVEit Transfer, which is a key indicator of potential exploitation of the CVE-2024-5806 vulnerability. Such attempts are characteristic of the authentication bypass technique used in this vulnerability, where attackers try to impersonate valid users without providing proper credentials. While occasional empty key fingerprint authentication attempts might occur due to misconfigurations, a sudden increase or attempts from unexpected sources could signify malicious activity.",MOVEit,Initial Access,T1190,"`moveit_sftp_logs` ""UserAuthRequestHandler: SftpPublicKeyAuthenticator: Attempted to authenticate empty public key fingerprint"" 
| stats count by source _raw 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `moveit_empty_key_fingerprint_authentication_attempt_filter`"
Permission Modification using Takeown App,"The following analytic detects the modification of file or directory permissions using the takeown.exe Windows application. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include process GUID, process name, and command-line details. This activity is significant because it is a common technique used by ransomware to take ownership of files or folders for encryption or deletion.",Windows Events,"Execution, Impact, Defense Evasion",T1222,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""takeown.exe"" Processes.process = ""*/f*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `permission_modification_using_takeown_app_filter`"
Potential Telegram API Request Via CommandLine,"The following analytic detects the presence of &quot;api.telegram.org&quot; in the CommandLine of a process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity can be significant as the telegram API has been used as an exfiltration mechanism or even as a C2 channel.",Windows Events,"Command And Control, Execution, Persistence, Exfiltration","T1041, T1102.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process= ""*api.telegram.org*"" NOT Processes.process IN (""*-osint -url*"", ""* --single-argument*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `potential_telegram_api_request_via_commandline_filter`"
Powershell Fileless Process Injection via GetProcAddress,"The following analytic detects the use of GetProcAddress in PowerShell script blocks, leveraging PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, which is then logged in Windows event logs. The presence of GetProcAddress is unusual for typical PowerShell scripts and often indicates malicious activity, as many attack toolkits use it to achieve code execution.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1059.001, T1055","`powershell` EventCode=4104 ScriptBlockText=*getprocaddress* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_fileless_process_injection_via_getprocaddress_filter`"
PowerShell Invoke CIMMethod CIMSession,"The following analytic detects the creation of a New-CIMSession cmdlet followed by the use of the Invoke-CIMMethod cmdlet within PowerShell. It leverages PowerShell Script Block Logging to identify these specific cmdlets in the ScriptBlockText field. This activity is significant because it mirrors the behavior of the Invoke-WMIMethod cmdlet, often used for remote code execution via NTLMv2 pass-the-hash authentication.",Windows Events,"Lateral Movement, Execution",T1047,"`powershell` EventCode=4104 ScriptBlockText IN (""*invoke-CIMMethod*"", ""*New-CimSession*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_invoke_cimmethod_cimsession_filter`"
PowerShell Invoke WmiExec Usage,"The following analytic detects the execution of the Invoke-WMIExec utility within PowerShell Script Block Logging (EventCode 4104). This detection leverages PowerShell script block logs to identify instances where the Invoke-WMIExec command is used. Monitoring this activity is crucial as it indicates potential lateral movement using WMI commands with NTLMv2 pass-the-hash authentication. If confirmed malicious, this activity could allow an attacker to execute commands remotely on target systems, potentially leading to further compromise and lateral spread within the network.",Windows Events,"Lateral Movement, Execution",T1047,"`powershell` EventCode=4104 ScriptBlockText IN (""*invoke-wmiexec*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_invoke_wmiexec_usage_filter`"
PowerShell Loading DotNET into Memory via Reflection,"The following analytic detects the use of PowerShell scripts to load .NET assemblies into memory via reflection, a technique often used in malicious activities such as those by Empire and Cobalt Strike. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command executed. This behavior is significant as it can indicate advanced attack techniques aiming to execute code in memory, bypassing traditional defenses.",Windows Events,"Execution, Privilege Escalation",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*Reflection.Assembly]::Load*"",
""*Reflection.Assembly.Load*"", ""*UnsafeLoadFrom*"", ""*.LoadFrom(*"", ""*.LoadModule(*"",
""*.LoadWithPartialName*"", ""*ReflectionOnlyLoad*"", ""*Reflection.Assembly]::('daoL'[-1..-4] -join '')*"")
| fillnull
| stats count min(_time) as firstTime max(_time) as lastTime
by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `powershell_loading_dotnet_into_memory_via_reflection_filter`"
Powershell Processing Stream Of Data,"The following analytic detects suspicious PowerShell script execution involving compressed stream data processing, identified via EventCode 4104. It leverages PowerShell Script Block Logging to flag scripts using IO.Compression, IO.StreamReader, or decompression methods. This activity is significant as it often indicates obfuscated PowerShell or embedded .NET/binary execution, which are common tactics for evading detection. If confirmed malicious, this behavior could allow attackers to execute hidden code, escalate privileges, or maintain persistence within the environment.",Windows Events,"Execution, Persistence",T1059.001,"`powershell` EventCode=4104 ScriptBlockText = ""*IO.Compression.*"" OR ScriptBlockText = ""*IO.StreamReader*"" OR ScriptBlockText = ""*]::Decompress*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_processing_stream_of_data_filter`"
PowerShell Start or Stop Service,"The following analytic identifies the use of PowerShell's Start-Service or Stop-Service cmdlets on an endpoint. It leverages PowerShell Script Block Logging to detect these commands. This activity is significant because attackers can manipulate services to disable or stop critical functions, causing system instability or disrupting business operations. If confirmed malicious, this behavior could allow attackers to disable security services, evade detection, or disrupt essential services, leading to potential system downtime and compromised security.",Windows Events,"Lateral Movement, Execution",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*start-service*"", ""*stop-service*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_start_or_stop_service_filter`"
Processes launching netsh,"The following analytic identifies processes launching netsh.exe, a command-line utility used to modify network configurations. It detects this activity by analyzing data from Endpoint Detection and Response (EDR) agents, focusing on process GUIDs, names, parent processes, and command-line executions. This behavior is significant because netsh.exe can be exploited to execute malicious helper DLLs, serving as a persistence mechanism.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(""Processes"")` 
|`security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
|`processes_launching_netsh_filter`"
Rubeus Command Line Parameters,"The following analytic detects the use of Rubeus command line parameters, a toolset for Kerberos attacks within Active Directory environments. It leverages Endpoint Detection and Response (EDR) data to identify specific command-line arguments associated with actions like ticket manipulation, kerberoasting, and password spraying. This activity is significant as Rubeus is commonly used by adversaries to exploit Kerberos for privilege escalation and lateral movement.",Windows Events,"Execution, Credential Access, Lateral Movement, Persistence, Privilege Escalation, Defense Evasion","T1550.003, T1550, T1558.003, T1558.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process = ""*ptt /ticket*"" OR Processes.process = ""* monitor /interval*"" OR Processes.process =""* asktgt* /user:*"" OR Processes.process =""* asktgs* /service:*"" OR Processes.process =""* golden* /user:*"" OR Processes.process =""* silver* /service:*"" OR Processes.process =""* kerberoast*"" OR Processes.process =""* asreproast*"" OR Processes.process = ""* renew* /ticket:*"" OR Processes.process = ""* brute* /password:*"" OR Processes.process = ""* brute* /passwords:*"" OR Processes.process =""* harvest*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rubeus_command_line_parameters_filter`"
Rubeus Kerberos Ticket Exports Through Winlogon Access,"The following analytic detects a process accessing the winlogon.exe system process, indicative of the Rubeus tool attempting to export Kerberos tickets from memory. This detection leverages Sysmon EventCode 10 logs, focusing on processes obtaining a handle to winlogon.exe with specific access rights. This activity is significant as it often precedes pass-the-ticket attacks, where adversaries use stolen Kerberos tickets to move laterally within an environment.",Windows Events,Defense Evasion,"T1550.003, T1550","`sysmon` EventCode=10 TargetImage=C:\\Windows\\system32\\winlogon.exe (GrantedAccess=0x1f3fff) (SourceImage!=C:\\Windows\\system32\\svchost.exe AND SourceImage!=C:\\Windows\\system32\\lsass.exe AND SourceImage!=C:\\Windows\\system32\\LogonUI.exe AND SourceImage!=C:\\Windows\\system32\\smss.exe AND SourceImage!=C:\\Windows\\system32\\wbem\\wmiprvse.exe) 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `rubeus_kerberos_ticket_exports_through_winlogon_access_filter`"
Ryuk Wake on LAN Command,"The following analytic detects the use of Wake-on-LAN commands associated with Ryuk ransomware. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific process and command-line activities. This behavior is significant as Ryuk ransomware uses Wake-on-LAN to power on devices in a compromised network, increasing its encryption success rate. If confirmed malicious, this activity could lead to widespread ransomware encryption across multiple endpoints, causing significant operational disruption and data loss.",Windows Events,"Execution, Impact, Discovery",T1059.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=""*8 LAN*"" OR Processes.process=""*9 REP*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `ryuk_wake_on_lan_command_filter`"
ServicePrincipalNames Discovery with PowerShell,"The following analytic detects the use of powershell.exe to query the domain for Service Principal Names (SPNs) using Script Block Logging EventCode 4104. It identifies the use of the KerberosRequestorSecurityToken class within the script block, which is equivalent to using setspn.exe. This activity is significant as it often precedes kerberoasting or silver ticket attacks, which can lead to credential theft.",Windows Events,"Discovery, Credential Access, Privilege Escalation","T1558.003, T1558","`powershell` EventCode=4104 ScriptBlockText=""*KerberosRequestorSecurityToken*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `serviceprincipalnames_discovery_with_powershell_filter`"
Suspicious Computer Account Name Change,"The following analytic detects a suspicious computer account name change in Active Directory. It leverages Event ID 4781, which logs account name changes, to identify instances where a computer account name is changed to one that does not end with a $. This behavior is significant as it may indicate an attempt to exploit CVE-2021-42278 and CVE-2021-42287, which can lead to domain controller impersonation and privilege escalation.",Windows Events,"Discovery, Privilege Escalation, Defense Evasion",T1078.002,"`wineventlog_security` EventCode=4781 OldTargetUserName=""*$"" NewTargetUserName!=""*$"" 
| table _time, Computer, Caller_User_Name, OldTargetUserName, NewTargetUserName 
| rename Computer as dest 
| `suspicious_computer_account_name_change_filter`"
Suspicious Rundll32 no Command Line Arguments,"The following analytic detects the execution of rundll32.exe without any command line arguments. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process execution logs. It is significant because rundll32.exe typically requires command line arguments to function properly, and its absence is often associated with malicious activities, such as those performed by Cobalt Strike.",Windows Events,"Execution, Persistence, Defense Evasion","T1218, T1218.011","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where `process_rundll32` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| regex process=""(?i)(rundll32\.exe.{0,4}$)"" 
| `suspicious_rundll32_no_command_line_arguments_filter`"
Suspicious Rundll32 StartW,"The following analytic identifies the execution of rundll32.exe with the DLL function names &quot;Start&quot; and &quot;StartW,&quot; commonly associated with Cobalt Strike payloads. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process metadata. This activity is significant as it often indicates the presence of malicious payloads, such as Cobalt Strike, which can lead to unauthorized code execution.",Windows Events,"Execution, Persistence, Defense Evasion","T1218, T1218.011","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*start* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_rundll32_startw_filter`"
Suspicious SearchProtocolHost no Command Line Arguments,"The following analytic detects instances of searchprotocolhost.exe running without command line arguments. This behavior is unusual and often associated with malicious activities, such as those performed by Cobalt Strike. The detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process execution data. This activity is significant because searchprotocolhost.exe typically runs with specific arguments, and its absence may indicate an attempt to evade detection.",Windows Events,"Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=searchprotocolhost.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| regex process=""(?i)(searchprotocolhost\.exe.{0,4}$)"" 
| `suspicious_searchprotocolhost_no_command_line_arguments_filter`"
Svchost LOLBAS Execution Process Spawn,"The following analytic detects instances of 'svchost.exe' spawning Living Off The Land Binaries and Scripts (LOLBAS) processes. It leverages Endpoint Detection and Response (EDR) data to monitor child processes of 'svchost.exe' that match known LOLBAS executables. This activity is significant as adversaries often use LOLBAS techniques to execute malicious code stealthily, potentially indicating lateral movement or code execution attempts.",Windows Events,"Lateral Movement, Execution, Persistence","T1053.005, T1053","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=svchost.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `svchost_lolbas_execution_process_spawn_filter`"
Unusual Number of Computer Service Tickets Requested,"The following analytic identifies an unusual number of computer service ticket requests from a single source, leveraging Event ID 4769, &quot;A Kerberos service ticket was requested.",Windows Events,"Execution, Lateral Movement, Privilege Escalation, Defense Evasion, Exfiltration",T1078,"`wineventlog_security` EventCode=4769 Service_Name=""*$"" Account_Name!=""*$*"" 
| bucket span=2m _time 
| stats dc(Service_Name) AS unique_targets values(Service_Name) as host_targets by _time, Client_Address, Account_Name 
| eventstats avg(unique_targets) as comp_avg , stdev(unique_targets) as comp_std by Client_Address, Account_Name 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_targets >10 and unique_targets >= upperBound, 1, 0) 
| `unusual_number_of_computer_service_tickets_requested_filter`"
Windows AD DSRM Account Changes,"The following analytic identifies changes to the Directory Services Restore Mode (DSRM) account behavior via registry modifications. It detects alterations in the registry path &quot;*\System\CurrentControlSet\Control\Lsa\DSRMAdminLogonBehavior&quot; with specific values indicating potential misuse. This activity is significant because the DSRM account, if misconfigured, can be exploited to persist within a domain, similar to a local administrator account.",Windows Events,"Execution, Persistence",T1098,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path= ""*\\System\\CurrentControlSet\\Control\\Lsa\\DSRMAdminLogonBehavior"" Registry.registry_value_data IN (""*1"",""*2"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_ad_dsrm_account_changes_filter`"
Windows AD DSRM Password Reset,"The following analytic detects attempts to reset the Directory Services Restore Mode (DSRM) administrator password on a Domain Controller. It leverages event code 4794 from the Windows Security Event Log, specifically looking for events where the DSRM password reset is attempted. This activity is significant because the DSRM account can be used similarly to a local administrator account, providing potential persistence for an attacker.",Windows Events,Persistence,T1098,"| tstats `security_content_summariesonly` min(_time) as _time from datamodel=Change where All_Changes.result_id=""4794"" AND All_Changes.result=""set the Directory Services Restore Mode administrator password"" by All_Changes.action, All_Changes.dest, All_Changes.src, All_Changes.user 
| `drop_dm_object_name(All_Changes)` 
| `windows_ad_dsrm_password_reset_filter`"
Windows AdFind Exe,"The following analytic identifies the execution of adfind.exe standalone or with specific command-line arguments related to Active Directory queries. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line arguments, and parent Processes. This activity is significant because adfind.exe is a powerful tool often used by threat actors like Wizard Spider and FIN6 to gather sensitive AD information.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1018,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
(
Processes.process_name = ""AdFind.exe"" 
OR 
Processes.original_file_name = ""AdFind.exe""
)
OR
(
Processes.process IN (""* -f *"", ""* /f*"")
Processes.process = ""*objectcategory=*""
)
OR
(
Processes.process IN (""* -sc *"", ""* /sc *"")
Processes.process IN (""* -gcb *"", ""* /gcb *"")
)
OR
(
Processes.process IN (""* -sc *"", ""* /sc *"")
Processes.process IN (
""* trustdmp*"", 
""* dclist*"", 
""* dcdmp*"", 
""* adobjcnt*"", 
""* adamobjcnt*"", 
""* sdump*"", 
""* exchaddresses*"",
""* getacl*"",
""* domainlist*"",
""* export_user*"",
""* export_group*"",
""* admincountdmp*""
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_adfind_exe_filter`"
Windows BitLockerToGo with Network Activity,"The following analytic detects suspicious usage of BitLockerToGo.exe, which has been observed being abused by Lumma stealer malware. The malware leverages this legitimate Windows utility to manipulate registry keys, search for cryptocurrency wallets and credentials, and exfiltrate sensitive data. This activity is significant because BitLockerToGo.exe provides functionality for viewing, copying, and writing files as well as modifying registry branches - capabilities that the Lumma stealer exploits for malicious purposes.",Windows Events,"Execution, Defense Evasion",T1218,"`sysmon` EventCode=22 process_name=""bitlockertogo.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_bitlockertogo_with_network_activity_filter`"
Windows Cisco Secure Endpoint Related Service Stopped,"The following analytic detects the suspicious termination of known services commonly targeted by ransomware before file encryption. It leverages Windows System Event Logs (EventCode 7036) to identify when critical services such as Volume Shadow Copy, backup, and antivirus services are stopped. This activity is significant because ransomware often disables these services to avoid errors and ensure successful file encryption.",Windows Events,Impact,T1490,"`wineventlog_system` `normalized_service_binary_field` 
| rename param1 as display_name 
| rename param2 as status 
| search EventCode=7036 display_name IN (""Cisco AMP Orbital"", ""*Cisco Secure Endpoint*"", ""*Cisco Security Connector Monitoring*"", ""CiscoSAM"", ""CiscoAMPHeurDriver"", ""CiscoAMPELAMDriver"", ""CiscoAMPCEFWDriver"", ""ImmunetNetworkMonitorDriver"", ""ImmunetProtectDriver"", ""ImmunetSelfProtectDriver"") status IN (""stopped"", ""arrÃªtÃ©"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode display_name normalized_service_name status dest 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_cisco_secure_endpoint_related_service_stopped_filter`"
Windows Create Local Administrator Account Via Net,The following analytic detects the creation of a local administrator account using the &quot;net.exe&quot; command. It leverages Endpoint Detection and Response (EDR) data to identify processes named &quot;net.exe&quot; with the &quot;/add&quot; parameter and keywords related to administrator accounts. This activity is significant as it may indicate an attacker attempting to gain persistent access or escalate privileges.,Windows Events,"Execution, Persistence",T1136.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process=*/add* AND Processes.process IN (""*administrators*"", ""*administratoren*"", ""*administrateurs*"", ""*administrador*"", ""*amministratori*"", ""*administratorer*"", ""*Rendszergazda*"", ""*ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€*"", ""*AdministratÃ¶r*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_create_local_administrator_account_via_net_filter`"
Windows Credential Dumping LSASS Memory Createdump,"The following analytic detects the use of CreateDump.exe to perform a process dump. This binary is not native to Windows and is often introduced by third-party applications, including PowerShell 7. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, GUIDs, and complete command-line executions. This activity is significant as it may indicate an attempt to dump LSASS memory, which can be used to extract credentials.",Windows Events,"Lateral Movement, Execution, Credential Access",T1003.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=createdump.exe OR Processes.original_file_name=""FX_VER_INTERNALNAME_STR"" Processes.process=""*-u *"" AND Processes.process=""*-f *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credential_dumping_lsass_memory_createdump_filter`"
Windows Credentials Access via VaultCli Module,"The following analytic detects potentially abnormal interactions with VaultCLI.dll, particularly those initiated by processes located in publicly writable Windows folder paths. The VaultCLI.dll module allows processes to extract credentials from the Windows Credential Vault. It was seen being abused by information stealers such as Meduza. The analytic monitors suspicious API calls, unauthorized credential access patterns, and anomalous process behaviors indicative of malicious activity.",Windows Events,"Execution, Credential Access",T1555.004,"`sysmon` EventCode=7  ImageLoaded =""*\\vaultcli.dll"" process_path IN(""*\\windows\\fonts\\*"", ""*\\windows\\temp\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"", ""*\\Users\\Administrator\\Music\\*"", ""*\\Windows\\servicing\\*"", ""*\\Users\\Default\\*"", ""*Recycle.bin*"", ""*\\Windows\\Media\\*"", ""\\Windows\\repair\\*"", ""*\\appdata\\local\\temp\\*"", ""*\\PerfLogs\\*"", ""*:\\temp\\*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_credentials_access_via_vaultcli_module_filter`"
Windows Event Logging Service Has Shutdown,"The following analytic detects the shutdown of the Windows Event Log service by leveraging Windows Event ID 1100. This event is logged every time the service stops, including during normal system shutdowns. Monitoring this activity is crucial as it can indicate attempts to cover tracks or disable logging. If confirmed malicious, an attacker could hide their activities, making it difficult to trace their actions and investigate further incidents.",Windows Events,Defense Evasion,"T1070, T1070.001","`wineventlog_security` EventCode=1100 
| stats count min(_time) as firstTime max(_time) as lastTime by action app change_type dest dvc name object_attrs object_category service service_name signature signature_id status subject vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_event_logging_service_has_shutdown_filter`"
Windows EventLog Recon Activity Using Log Query Utilities,"This analytic detects EventLog reconnaissance activity using utilities such as wevtutil.exe, wmic.exe, PowerShell cmdlets like Get-WinEvent, or WMI queries targeting Win32_NTLogEvent. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. These tools are often used by adversaries to extract usernames, IP addresses, session data, and event information for credential access or situational awareness during lateral movement.",Windows Events,"Lateral Movement, Execution, Credential Access, Discovery",T1654,"| tstats `security_content_summariesonly` values(Processes.process) as process
min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes
where (
(
(
Processes.process_name IN (""powershell.exe"", ""pwsh.exe"", ""powershell_ise.exe"")
OR
Processes.original_file_name IN (""PowerShell.EXE"", ""pwsh.dll"", ""powershell_ise.EXE"")
)
Processes.process IN (""*Get-WinEvent*"", ""*Get-EventLog*"", ""*EventLogQuery*"", ""*.ReadEvent(*"")
)
OR
(
(
Processes.process_name = wevtutil.exe 
OR 
Processes.original_file_name = wevtutil.exe
)
Processes.process IN (""* qe *"", ""* query-events *"")
)
OR
(
(
Processes.process_name = wmic.exe 
OR 
Processes.original_file_name = wmic.exe
)
Processes.process IN (""*ntevent*"")
)
OR
(
Processes.process=""*Win32_NTLogEvent*""
Processes.process=""*EventCode*""
)
OR
(
Processes.process IN (""*PsLogList*"", ""*Eventquery*"")
)
)
by
Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_eventlog_recon_activity_using_log_query_utilities_filter`"
Windows Hunting System Account Targeting Lsass,"The following analytic identifies processes attempting to access Lsass.exe, which may indicate credential dumping or applications needing credential access. It leverages Sysmon EventCode 10 to detect such activities by analyzing fields like TargetImage, GrantedAccess, and SourceImage. This behavior is significant as unauthorized access to Lsass.exe can lead to credential theft, posing a severe security risk.",Windows Events,"Execution, Credential Access, Privilege Escalation, Exfiltration",T1003.001,"`sysmon` EventCode=10 TargetImage=*lsass.exe 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_hunting_system_account_targeting_lsass_filter`"
Windows Impair Defense Deny Security Software With Applocker,"The following analytic detects modifications in the Windows registry by the Applocker utility that deny the execution of various security products. This detection leverages data from the Endpoint.Registry datamodel, focusing on specific registry paths and values indicating a &quot;Deny&quot; action against known antivirus and security software. This activity is significant as it may indicate an attempt to disable security defenses, a tactic observed in malware like Azorult.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Group Policy Objects\\*"" AND Registry.registry_path= ""*}Machine\\Software\\Policies\\Microsoft\\Windows\\SrpV2*"") OR Registry.registry_path=""*\\Software\\Policies\\Microsoft\\Windows\\SrpV2*"" AND Registry.registry_value_data = ""*Action\=\""Deny\""*"" AND Registry.registry_value_data IN(""*O=SYMANTEC*"",""*O=MCAFEE*"",""*O=KASPERSKY*"",""*O=BLEEPING COMPUTER*"", ""*O=PANDA SECURITY*"",""*O=SYSTWEAK SOFTWARE*"", ""*O=TREND MICRO*"", ""*O=AVAST*"", ""*O=GRIDINSOFT*"", ""*O=MICROSOFT*"", ""*O=NANO SECURITY*"", ""*O=SUPERANTISPYWARE.COM*"", ""*O=DOCTOR WEB*"", ""*O=MALWAREBYTES*"", ""*O=ESET*"", ""*O=AVIRA*"", ""*O=WEBROOT*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_deny_security_software_with_applocker_filter`"
Windows Impair Defense Disable Defender Firewall And Network,"The following analytic detects modifications in the Windows registry to disable firewall and network protection settings within Windows Defender Security Center. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the UILockdown registry value. This activity is significant as it may indicate an attempt to impair system defenses, potentially restricting users from modifying firewall or network protection settings.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender Security Center\\Firewall and network protection\\UILockdown"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_defender_firewall_and_network_filter`"
Windows Impair Defense Disable Defender Protocol Recognition,"The following analytic detects modifications to the Windows registry that disable the Windows Defender protocol recognition feature. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the &quot;DisableProtocolRecognition&quot; setting. This activity is significant because disabling protocol recognition can hinder Windows Defender's ability to detect and respond to malware or suspicious software.",Windows Events,"Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\NIS\\DisableProtocolRecognition"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_defender_protocol_recognition_filter`"
Windows Impair Defense Disable PUA Protection,"The following analytic detects a modification in the Windows registry to disable Windows Defender PUA protection by setting PUAProtection to 0. This detection leverages data from the Endpoint.Registry datamodel, focusing on registry path changes related to Windows Defender. Disabling PUA protection is significant as it reduces defenses against Potentially Unwanted Applications (PUAs), which, while not always malicious, can negatively impact user experience and security.",Windows Events,"Impact, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\PUAProtection"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_pua_protection_filter`"
Windows Impair Defense Disable Win Defender Network Protection,"The following analytic detects modifications to the Windows registry that disable Windows Defender Network Protection. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the EnableNetworkProtection registry entry. This activity is significant because disabling Network Protection can leave the system vulnerable to network-based threats by preventing Windows Defender from analyzing and blocking malicious network activity.",Windows Events,"Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Windows Defender Exploit Guard\\Network Protection\\EnableNetworkProtection"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_network_protection_filter`"
Windows Impair Defense Disable Win Defender Signature Retirement,"The following analytic detects modifications to the Windows registry that disable Windows Defender Signature Retirement. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the DisableSignatureRetirement registry setting. This activity is significant because disabling signature retirement can prevent Windows Defender from removing outdated antivirus signatures, potentially reducing its effectiveness in detecting threats.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\NIS\\Consumers\\IPS\\DisableSignatureRetirement"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_signature_retirement_filter`"
Windows Local Administrator Credential Stuffing,"The following analytic detects attempts to authenticate using the built-in local Administrator account across more than 30 endpoints within a 5-minute window. It leverages Windows Event Logs, specifically events 4625 and 4624, to identify this behavior. This activity is significant as it may indicate an adversary attempting to validate stolen local credentials across multiple hosts, potentially leading to privilege escalation.",Windows Events,"Lateral Movement, Credential Access, Privilege Escalation","T1110.004, T1110","`wineventlog_security` EventCode=4625 OR EventCode=4624 Logon_Type=3 TargetUserName=Administrator 
| bucket span=5m _time 
| stats dc(Computer) AS unique_targets values(Computer) as host_targets values(dest) as dest values(src) as src values(user) as user by _time, IpAddress, TargetUserName, EventCode, action, app, authentication_method, signature, signature_id 
| where unique_targets > 30 
| `windows_local_administrator_credential_stuffing_filter`"
Windows LSA Secrets NoLMhash Registry,"The following analytic detects modifications to the Windows registry related to the Local Security Authority (LSA) NoLMHash setting. It identifies when the registry value is set to 0, indicating that the system will store passwords in the weaker Lan Manager (LM) hash format. This detection leverages registry activity logs from endpoint data sources like Sysmon or EDR tools.",Windows Events,Credential Access,T1003.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\System\\CurrentControlSet\\Control\\Lsa\\NoLMHash"" Registry.registry_value_data = 0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_lsa_secrets_nolmhash_registry_filter`"
Windows Modify Registry Tamper Protection,"The following analytic detects a suspicious modification to the Windows Defender Tamper Protection registry setting. It leverages data from the Endpoint datamodel, specifically targeting changes where the registry path is set to disable Tamper Protection. This activity is significant because disabling Tamper Protection can allow adversaries to make further undetected changes to Windows Defender settings, potentially leading to reduced security on the system.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Microsoft\\Windows Defender\\Features\\TamperProtection"" AND Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_tamper_protection_filter`"
Windows MOVEit Transfer Writing ASPX,"The following analytic detects the creation of new ASPX files in the MOVEit Transfer application's &quot;wwwroot&quot; directory. It leverages endpoint data on process and filesystem activity to identify processes responsible for creating these files. This activity is significant as it may indicate exploitation of a critical zero-day vulnerability in MOVEit Transfer, used by threat actors to install malicious ASPX files.",Windows Events,"Initial Access, Exfiltration","T1190, T1133","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime FROM datamodel=Endpoint.Filesystem where 
Filesystem.file_path IN (""*\\MOVEitTransfer\\wwwroot\\*"") AND 
Filesystem.file_name IN(""*.ashx"", ""*.asp*"")
by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time 
Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path 
Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id 
Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_moveit_transfer_writing_aspx_filter`"
Windows New InProcServer32 Added,The following analytic detects the addition of new InProcServer32 registry keys on Windows endpoints. It leverages data from the Endpoint.Registry datamodel to identify changes in registry paths associated with InProcServer32. This activity is significant because malware often uses this mechanism to achieve persistence or execute malicious code by registering a new InProcServer32 key pointing to a harmful DLL.,Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\InProcServer32\\*"" by Registry.registry_path Registry.registry_key_name Registry.registry_value_name Registry.registry_value_data Registry.dest Registry.process_guid Registry.user 
| `drop_dm_object_name(Registry)` 
|`security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_new_inprocserver32_added_filter`"
Windows Non-System Account Targeting Lsass,"The following analytic identifies non-SYSTEM accounts requesting access to lsass.exe. This detection leverages Sysmon EventCode 10 logs to monitor access attempts to the Local Security Authority Subsystem Service (lsass.exe) by non-SYSTEM users. This activity is significant as it may indicate credential dumping attempts or unauthorized access to sensitive credentials. If confirmed malicious, an attacker could potentially extract credentials from memory, leading to privilege escalation or lateral movement within the network.",Windows Events,"Execution, Credential Access, Lateral Movement, Privilege Escalation, Exfiltration",T1003.001,"`sysmon` EventCode=10 TargetImage=*lsass.exe NOT (SourceUser=""NT AUTHORITY\\*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_non_system_account_targeting_lsass_filter`"
Windows Possible Credential Dumping,"The following analytic detects potential credential dumping by identifying specific GrantedAccess permission requests and CallTrace DLLs targeting the LSASS process. It leverages Sysmon EventCode 10 logs, focusing on access requests to lsass.exe and call traces involving debug and native API DLLs like dbgcore.dll, dbghelp.dll, and ntdll.dll. This activity is significant as credential dumping can lead to unauthorized access to sensitive credentials.",Windows Events,"Execution, Credential Access, Exfiltration",T1003.001,"`sysmon` EventCode=10 TargetImage=*\\lsass.exe granted_access IN (""0x01000"", ""0x1010"", ""0x1038"", ""0x40"", ""0x1400"", ""0x1fffff"", ""0x1410"", ""0x143a"", ""0x1438"", ""0x1000"") CallTrace IN (""*dbgcore.dll*"", ""*dbghelp.dll*"", ""*ntdll.dll*"", ""*kernelbase.dll*"", ""*kernel32.dll*"") NOT SourceUser IN (""NT AUTHORITY\\SYSTEM"", ""NT AUTHORITY\\NETWORK SERVICE"") 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_possible_credential_dumping_filter`"
Windows PowerShell Export PfxCertificate,"The following analytic detects the use of the PowerShell cmdlet export-pfxcertificate by leveraging Script Block Logging. This activity is significant as it may indicate an adversary attempting to exfiltrate certificates from the Windows Certificate Store. Monitoring this behavior is crucial for identifying potential certificate theft, which can lead to unauthorized access and impersonation attacks.",Windows Events,Credential Access,"T1552.004, T1649","`powershell` EventCode=4104 ScriptBlockText IN (""*export-pfxcertificate*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_export_pfxcertificate_filter`"
Windows Privileged Group Modification,"This analytic detects modifications to privileged groups in Active Directory, including creation, deletion, and changes to various types of groups such as local, global, universal, and LDAP query groups. It specifically monitors for changes to high-privilege groups like &quot;Administrators&quot;, &quot;Domain Admins&quot;, &quot;Enterprise Admins&quot;, and &quot;ESX Admins&quot;, among others. This detection is particularly relevant in the context of potential exploitation of vulnerabilities like the VMware ESXi Active Directory Integration Authentication Bypass (CVE-2024-37085), where attackers may attempt to manipulate privileged groups to gain unauthorized access to systems.",Windows Events,"Execution, Persistence","T1136.001, T1136.002","`wineventlog_security` EventCode IN (4727,4731,4744,4749,4754,4759,4783,4790) TargetUserName IN (""Account Operators"", ""Administrators"", ""Admins DNS"", ""Backup Operators"", ""DnsAdmins"", ""Domain Admins"", ""Enterprise Admins"", ""Enterprise Key Admins"", ""ESX Admins"", ""ESXi Admins"", ""Group Policy Creator Owners"", ""Hyper-V Administrators"", ""Key Admins"", ""Print Operators"", ""Remote Desktop Users"", ""Remote Management Users"", ""Replicators"", ""Schema Admins"", ""Server Operators"") 
| eval object_category=case( EventCode=""4731"", ""Local Group (Security)"", EventCode=""4744"", ""Local Group (Distribution)"", EventCode=""4727"", ""Global Group (Security)"", EventCode=""4749"", ""Global Group (Distribution)"", EventCode=""4754"", ""Universal Group (Security)"", EventCode=""4759"", ""Universal Group (Distribution)"", EventCode=""4783"", ""Basic Application Group"", EventCode=""4790"", ""LDAP Query Group"") 
| rename Computer as dest, result AS change_type, TargetUserName AS object, TargetSid AS object_path 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode src_user object_category object object_path dest change_type status 
| `windows_privileged_group_modification_filter`"
Windows Rasautou DLL Execution,"The following analytic detects the execution of an arbitrary DLL by the Windows Remote Auto Dialer (rasautou.exe). This behavior is identified by analyzing process creation events where rasautou.exe is executed with specific command-line arguments. This activity is significant because it leverages a Living Off The Land Binary (LOLBin) to execute potentially malicious code, bypassing traditional security controls.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1055.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=rasautou.exe Processes.process=""* -d *""AND Processes.process=""* -p *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rasautou_dll_execution_filter`"
Windows RDP Login Session Was Established,"The following analytic detects instances where a successful Remote Desktop Protocol (RDP) login session was established, as indicated by Windows Security Event ID 4624 with Logon Type 10. This event confirms that a user has not only provided valid credentials but has also initiated a full interactive RDP session. It is a key indicator of successful remote access to a Windows system.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"`wineventlog_security`  EventCode=4624 Logon_Type=10 
| stats count min(_time) as firstTime max(_time) as lastTime by action app authentication_method dest dvc process process_id process_name process_path signature signature_id src src_port status subject user user_group vendor_product Logon_Type 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rdp_login_session_was_established_filter`"
Windows Remote Service Rdpwinst Tool Execution,"The following analytic detects the execution of the RDPWInst.exe tool, which is an RDP wrapper library used to enable remote desktop host support and concurrent RDP sessions. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, original file names, and specific command-line arguments. This activity is significant because adversaries can abuse this tool to establish unauthorized RDP connections, facilitating remote access and potential lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""RDPWInst.exe"" OR Processes.original_file_name=""RDPWInst.exe"") AND Processes.process IN (""* -i*"", ""* -s*"", ""* -o*"", ""* -w*"", ""* -r*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_service_rdpwinst_tool_execution_filter`"
Windows Security Account Manager Stopped,"The following analytic detects the stopping of the Windows Security Account Manager (SAM) service via command-line, typically using the &quot;net stop samss&quot; command. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because stopping the SAM service can disrupt authentication mechanisms and is often associated with ransomware attacks like Ryuk.",Windows Events,"Execution, Impact, Privilege Escalation",T1489,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes WHERE (""Processes.process_name""=""net*.exe"" ""Processes.process""=""*stop \""samss\""*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_security_account_manager_stopped_filter`"
Windows Security And Backup Services Stop,"The following analytic detects the suspicious termination of known services commonly targeted by ransomware before file encryption. It leverages Windows System Event Logs (EventCode 7036) to identify when critical services such as Volume Shadow Copy, backup, and antivirus services are stopped. This activity is significant because ransomware often disables these services to avoid errors and ensure successful file encryption.",Windows Events,Impact,T1490,"`wineventlog_system` `normalized_service_binary_field` 
| rename param1 as display_name 
| where param2=""stopped"" AND (match(display_name, ""(?i)(Volume Shadow Copy
|VSS
|backup
|sophos
|sql
|memtas
|mepocs
|veeam
|svc\$
|DefWatch
|ccEvtMgr
|ccSetMgr
|SavRoam
|RTVscan
|QBFCService
|QBIDPService
|Intuit\.QuickBooks\.FCS
|QBCFMonitorService
|YooBackup
|YooIT
|Veeam
|PDVFSService
|BackupExec
|WdBoot
|WdFilter
|WdNisDrv
|WdNisSvc
|WinDefend
|wscsvc
|Sense
|sppsvc
|SecurityHealthService)"") OR match(normalized_service_name, ""(?i)(Volume Shadow Copy
|VSS
|backup
|sophos
|sql
|memtas
|mepocs
|veeam
|svc\$
|DefWatch
|ccEvtMgr
|ccSetMgr
|SavRoam
|RTVscan
|QBFCService
|QBIDPService
|Intuit\.QuickBooks\.FCS
|QBCFMonitorService
|YooBackup
|YooIT
|Veeam
|PDVFSService
|BackupExec
|WdBoot
|WdFilter
|WdNisDrv
|WdNisSvc
|WinDefend
|wscsvc
|Sense
|sppsvc
|SecurityHealthService)"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode display_name dest normalized_service_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_security_and_backup_services_stop_filter`"
Windows Service Create SliverC2,"The following analytic detects the creation of a Windows service named &quot;Sliver&quot; with the description &quot;Sliver Implant,&quot; indicative of SliverC2 lateral movement using the PsExec module. It leverages Windows EventCode 7045 from the System Event log to identify this activity. This behavior is significant as it may indicate an adversary's attempt to establish persistence or execute commands remotely.",Windows Events,"Lateral Movement, Execution, Persistence",T1569.002,"`wineventlog_system` EventCode=7045 ServiceName=""sliver"" 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer EventCode ImagePath ServiceName ServiceType 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_create_sliverc2_filter`"
Windows Service Stop Attempt,"The following analytic identifies attempts to stop services on a system using net.exe, sc.exe or the &quot;Stop-Service&quot; cmdlet. It leverages Endpoint Detection and Response (EDR) telemetry. This activity can be significant as adversaries often terminate security or critical services to evade detection and further their objectives. If confirmed malicious, this behavior could allow attackers to disable security defenses, facilitate ransomware encryption, or disrupt essential services, leading to potential data loss or system compromise.",Windows Events,"Execution, Impact",T1489,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime  from datamodel=Endpoint.Processes where ((`process_net` OR `process_sc`) Processes.process=""* stop *"") OR Processes.process=""*Stop-Service *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_stop_attempt_filter`"
Windows SpeechRuntime COM Hijacking DLL Load,"SpeechRuntime is vulnerable to an attack that allows a user to run code on another user's session remotely and stealthily by exploiting a Windows COM class. When this class is invoked, it launches SpeechRuntime.exe in the context of the currently logged-on user. Because this COM class is susceptible to COM Hijacking, the attacker can alter the registry remotely to point to a malicious DLL.",Windows Events,Lateral Movement,T1021.003,"`sysmon` EventCode=7 Image=""*SpeechRuntime.exe"" 
| eval image_loaded_lower = lower(ImageLoaded) 
| search NOT image_loaded_lower=""*system32*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name parent_process_name parent_process_guid process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_speechruntime_com_hijacking_dll_load_filter`"
Windows SQL Server Startup Procedure,"This detection identifies when a startup procedure is registered or executed in SQL Server. Startup procedures automatically execute when SQL Server starts, making them an attractive persistence mechanism for attackers. The detection monitors for suspicious stored procedure names and patterns that may indicate malicious activity, such as attempts to execute operating system commands or gain elevated privileges.",Windows Events,"Collection, Execution, Persistence","T1505, T1505.001","`wineventlog_application` EventCode=17135 
| rex field=EventData_Xml ""<Data>(?<startup_procedure>[^<]+)</Data>"" 
| rename host as dest 
| eval risk_score=case( match(lower(startup_procedure), ""xp_
|sp_
|cmdshell
|shell
|exec""), 90, true(), 70 ) 
| eval risk_message=""SQL Server startup procedure '"".startup_procedure.""' was launched on host "".dest 
| stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode startup_procedure risk_message risk_score 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sql_server_startup_procedure_filter`"
Windows Steal Authentication Certificates CryptoAPI,"The following analytic detects the extraction of authentication certificates using Windows Event Log - CAPI2 (CryptoAPI 2). It leverages EventID 70, which is generated when a certificate's private key is acquired. This detection is significant because it can identify potential misuse of certificates, such as those extracted by tools like Mimikatz or Cobalt Strike.",Windows Events,Credential Access,T1649,"`capi2_operational` EventCode=70 
| xmlkv UserData_Xml 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, UserData_Xml 
| rename Computer as dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_cryptoapi_filter`"
Windows System LogOff Commandline,"The following analytic detects the execution of the Windows command line to log off a host machine. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes involving shutdown.exe with specific parameters. This activity is significant as it is often associated with Advanced Persistent Threats (APTs) and Remote Access Trojans (RATs) like dcrat, which use this technique to disrupt operations, aid in system destruction, or inhibit recovery.",Windows Events,"Execution, Impact",T1529,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = shutdown.exe OR Processes.original_file_name = shutdown.exe) Processes.process=""*shutdown*"" Processes.process IN (""* /l*"", ""* -l*"") Processes.process IN (""* /t*"",""* -t*"",""* /f*"",""* -f*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_logoff_commandline_filter`"
Windows System Reboot CommandLine,"The following analytic identifies the execution of the Windows command line to reboot a host machine using &quot;shutdown.exe&quot; with specific parameters. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as it is often associated with advanced persistent threats (APTs) and remote access trojans (RATs) like dcrat, which may use system reboots to disrupt operations, aid in system destruction, or inhibit recovery.",Windows Events,"Execution, Impact",T1529,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = shutdown.exe OR Processes.original_file_name = shutdown.exe) Processes.process=""*shutdown*"" Processes.process IN (""* /r*"", ""* -r*"") Processes.process IN (""* /t*"",""* -t*"",""* /f*"",""* -f*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_reboot_commandline_filter`"
Windows System Shutdown CommandLine,"The following analytic identifies the execution of the Windows shutdown command via the command line interface. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because attackers may use the shutdown command to erase tracks, cause disruption, or ensure changes take effect after installing backdoors.",Windows Events,"Execution, Impact",T1529,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = shutdown.exe OR Processes.original_file_name = shutdown.exe) Processes.process=""*shutdown*"" AND Processes.process IN(""* /s*"", ""* -s*"") AND Processes.process IN (""* /t*"",""* -t*"",""* /f*"",""* -f*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_shutdown_commandline_filter`"
Wsmprovhost LOLBAS Execution Process Spawn,"The following analytic identifies Wsmprovhost.exe spawning a LOLBAS execution process. It leverages Endpoint Detection and Response (EDR) data to detect when Wsmprovhost.exe spawns child processes that are known LOLBAS (Living Off the Land Binaries and Scripts) executables. This activity is significant because it may indicate an adversary using Windows Remote Management (WinRM) to execute code on remote endpoints, a common technique for lateral movement.",Windows Events,"Lateral Movement, Execution, Persistence","T1021.006, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=wsmprovhost.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Dllhost.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Mmc.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Rundll32.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Explorer.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `wsmprovhost_lolbas_execution_process_spawn_filter`"
Cisco Smart Install Port Discovery and Status,"This analytic detects network traffic to TCP port 4786, which is used by the Cisco Smart Install protocol. Smart Install is a plug-and-play configuration and image-management feature that helps customers to deploy Cisco switches. This protocol has been exploited via CVE-2018-0171, a vulnerability that allows unauthenticated remote attackers to execute arbitrary code or cause denial of service conditions.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Initial Access, Execution, Discovery",T1190,"| tstats `security_content_summariesonly` count values(All_Traffic.src_ip) as src_ip values(All_Traffic.src_port) as src_port values(All_Traffic.dest_ip) as dest_ip earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.dest_port=4786 AND All_Traffic.transport=tcp by All_Traffic.dest_ip All_Traffic.dest_port 
| `drop_dm_object_name(""All_Traffic"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_smart_install_port_discovery_and_status_filter`"
Internal Vulnerability Scan,"This analytic detects internal hosts triggering multiple IDS signatures, which may include either more than 25 signatures against a single host or a single signature across over 25 destination IP addresses.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Execution, Discovery","T1046, T1595.002","| tstats `security_content_summariesonly` values(IDS_Attacks.action) as action values(IDS_Attacks.src_category) as src_category values(IDS_Attacks.dest_category) as dest_category count from datamodel=Intrusion_Detection.IDS_Attacks where IDS_Attacks.src IN (10.0.0.0/8,192.168.0.0/16,172.16.0.0/12) IDS_Attacks.severity IN (critical, high, medium) by IDS_Attacks.src IDS_Attacks.severity IDS_Attacks.signature IDS_Attacks.dest IDS_Attacks.dest_port IDS_Attacks.transport span=1s _time 
| `drop_dm_object_name(""IDS_Attacks"")` 
| eval gtime=_time 
| bin span=1h gtime 
| eventstats count as sevCount by severity src 
| eventstats count as sigCount by signature src 
| eval severity=severity +""(""+sevCount+"")"" 
| eval signature=signature +""(""+sigCount+"")"" 
| eval dest_port=transport + ""/"" + dest_port 
| stats min(_time) as _time values(action) as action dc(dest) as destCount dc(signature) as sigCount values(signature) values(src_category) as src_category values(dest_category) as dest_category values(severity) as severity values(dest_port) as dest_ports by src gtime 
| fields - gtime 
| where destCount>25 OR sigCount>25 
| `internal_vulnerability_scan_filter`"
Protocols passing authentication in cleartext,"The following analytic identifies the use of cleartext protocols that risk leaking sensitive information. It detects network traffic on legacy protocols such as Telnet (port 23), POP3 (port 110), IMAP (port 143), and non-anonymous FTP (port 21). The detection leverages the Network_Traffic data model to identify TCP traffic on these ports. Monitoring this activity is crucial as it can expose credentials and other sensitive data to interception.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",,,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where NOT All_Traffic.action IN (""blocked"", ""block"") AND All_Traffic.transport=""tcp"" AND (All_Traffic.dest_port=""23"" OR All_Traffic.dest_port=""143"" OR All_Traffic.dest_port=""110"" OR (All_Traffic.dest_port=""21"" AND All_Traffic.user != ""anonymous"")) by All_Traffic.user All_Traffic.src_ip All_Traffic.dest All_Traffic.dest_port All_Traffic.rule 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Traffic"")` 
| `protocols_passing_authentication_in_cleartext_filter`"
Citrix ADC and Gateway Unauthorized Data Disclosure,"The following analytic detects attempts to exploit the Citrix Bleed vulnerability (CVE-2023-4966), which can lead to the leaking of session tokens. It identifies HTTP requests with a 200 status code targeting the /oauth/idp/.well-known/openid-configuration URL endpoint. By parsing web traffic and filtering based on user agent details, HTTP method, source and destination IPs, and sourcetype, it aims to identify potentially malicious requests.",Zscaler Proxy,"Initial Access, Discovery, Exfiltration",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/oauth/idp/.well-known/openid-configuration*"")  Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `citrix_adc_and_gateway_unauthorized_data_disclosure_filter`"
CrushFTP Authentication Bypass Exploitation,"The following analytic detects potential exploitation of the CrushFTP authentication bypass vulnerability (CVE-2025-31161). This detection identifies suspicious command execution patterns associated with exploitation of this vulnerability, such as executing mesch.exe with specific arguments like b64exec or fullinstall. This activity is indicative of an attacker exploiting CVE-2025-31161 to gain unauthorized access to the CrushFTP server and perform post-exploitation activities.",CrushFTP,"Initial Access, Execution","T1190, T1059.001, T1059.003","`crushftp` 
| rex field=_raw ""\\[HTTP:[^:]+:(?<user>[^:]+):(?<src_ip>[^\\]]+)\\]"" 
| rex field=_raw ""cmd:(?<process>[^\\*\\r\\n]+)"" 
| where isnotnull(process) AND (match(process, ""mesch\.exe"") OR match(process, ""b64exec"") OR match(process, ""fullinstall"") OR match(process, ""run"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by src_ip, user, process 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crushftp_authentication_bypass_exploitation_filter`"
Exploit Public-Facing Fortinet FortiNAC CVE-2022-39952,"The following analytic detects attempts to exploit the Fortinet FortiNAC CVE-2022-39952 vulnerability. It identifies HTTP POST requests to the URI configWizard/keyUpload.jsp with a payload.zip file. The detection leverages the Web datamodel, analyzing fields such as URL, HTTP method, and user agent. This activity is significant as it indicates an attempt to exploit a known vulnerability, potentially leading to remote code execution.",Zscaler Proxy,"Initial Access, Execution, Command And Control","T1190, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*configWizard/keyUpload.jsp*"") by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `exploit_public_facing_fortinet_fortinac_cve_2022_39952_filter`"
High Volume of Bytes Out to Url,"The following analytic detects a high volume of outbound web traffic, specifically over 1GB of data sent to a URL within a 2-minute window. It leverages the Web data model to identify significant uploads by analyzing the sum of bytes out. This activity is significant as it may indicate potential data exfiltration by malware or malicious insiders.",Zscaler Proxy,Exfiltration,T1567,"| tstats  `security_content_summariesonly` count sum(Web.bytes_out) as sum_bytes_out values(Web.user) as user values(Web.app) as app values(Web.dest) as dest from datamodel=Web by _time span=2m Web.url Web.src sourcetype 
| search sum_bytes_out > 1070000000 
| `drop_dm_object_name(""Web"")`
| `high_volume_of_bytes_out_to_url_filter`"
HTTP Rapid POST with Mixed Status Codes,"This detection identifies rapid-fire POST request attacks where an attacker sends more than 20 POST requests within a 5-second window, potentially attempting to exploit race conditions or overwhelm request handling. The pattern is particularly suspicious when responses vary in size or status codes, indicating successful exploitation attempts or probing for vulnerable endpoints.
Search 1`nginx_access_logs` http_method=&#34;POST&#34; 2| bin _time span=5s 3| rename dest_ip as dest 4| stats count, values(status) as status_codes, values(bytes_out) as bytes_out, values(uri_path) as uris by _time, src_ip, dest, http_user_agent 5| where count&gt;20 6| table _time, dest, src_ip, count, status_codes, bytes_out, http_user_agent 7| `http_rapid_post_with_mixed_status_codes_filter` Data Source Name Platform Sourcetype Source Nginx Access Other 'nginx:plus:kv' '/var/log/nginx/access.",NGINX,"Initial Access, Impact, Command And Control, Collection","T1190, T1071.001, T1595","`nginx_access_logs` http_method=""POST""
| bin _time span=5s 
| rename dest_ip as dest 
| stats count, values(status) as status_codes, values(bytes_out) as bytes_out, values(uri_path) as uris by _time, src_ip, dest, http_user_agent 
| where count>20 
| table _time, dest, src_ip, count, status_codes, bytes_out, http_user_agent 
| `http_rapid_post_with_mixed_status_codes_filter`"
Ivanti EPM SQL Injection Remote Code Execution,"This detection identifies potential exploitation of a critical SQL injection vulnerability in Ivanti Endpoint Manager (EPM), identified as CVE-2024-29824. The vulnerability, which has a CVSS score of 9.8, allows for remote code execution through the RecordGoodApp function in the PatchBiz.dll file. An attacker can exploit this vulnerability by manipulating the goodApp.md5 value in an HTTP POST request to the /WSStatusEvents/EventHandler.",Ivanti,"Initial Access, Execution, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/WSStatusEvents/EventHandler.asmx"") Web.http_method=POST Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_epm_sql_injection_remote_code_execution_filter`"
Jenkins Arbitrary File Read CVE-2024-23897,"The following analytic identifies attempts to exploit Jenkins Arbitrary File Read CVE-2024-23897. It detects HTTP POST requests to Jenkins URLs containing &quot;/cli?remoting=false&quot; with a 200 status code. This activity is significant as it indicates potential unauthorized access to sensitive files on the Jenkins server, such as credentials and private keys. If confirmed malicious, this could lead to severe data breaches, unauthorized access, and further exploitation within the environment.",Zscaler Proxy,"Initial Access, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/cli?remoting=false*"" Web.status=200 Web.http_method=POST by Web.src, Web.dest, Web.http_user_agent, Web.url Web.status, Web.http_method 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `jenkins_arbitrary_file_read_cve_2024_23897_filter`"
JetBrains TeamCity Authentication Bypass Suricata CVE-2024-27198,"The following analytic detects attempts to exploit the CVE-2024-27198 vulnerability in JetBrains TeamCity on-premises servers, which allows attackers to bypass authentication mechanisms. It leverages Suricata HTTP traffic logs to identify suspicious POST requests to the /app/rest/users and /app/rest/users/id:1/tokens endpoints. This activity is significant because it can lead to unauthorized administrative access, enabling attackers to gain full control over the TeamCity server, including projects, builds, agents, and artifacts.",Zscaler Proxy,"Initial Access, Discovery",T1190,"`suricata` ((http.url=""*?jsp=*"" AND http.url=""*;.jsp*"") http.status=200 http_method=POST) OR (http.url IN (""*jsp=/app/rest/users;.jsp"",""*?jsp=/app/rest/users;.jsp"",""*?jsp=.*/app/rest/users/id:*/tokens;*"") http.status=200 http_method=POST ) 
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, http.http_user_agent, http.url, http.status,http_method 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `jetbrains_teamcity_authentication_bypass_suricata_cve_2024_27198_filter`"
Multiple Archive Files Http Post Traffic,"The following analytic detects the high-frequency exfiltration of archive files via HTTP POST requests. It leverages HTTP stream logs to identify specific archive file headers within the request body. This activity is significant as it often indicates data exfiltration by APTs or trojan spyware after data collection. If confirmed malicious, this behavior could lead to the unauthorized transfer of sensitive data to an attackerâ€™s command and control server, potentially resulting in severe data breaches and loss of confidential information.",Splunk Stream,"Collection, Command And Control, Exfiltration","T1560, T1048.003","`stream_http` http_method=POST 
|eval archive_hdr1=substr(form_data,1,2) 
| eval archive_hdr2 = substr(form_data,1,4) 
|stats values(form_data) as http_request_body min(_time) as firstTime max(_time) as lastTime count by src_ip dest_ip http_method http_user_agent uri_path url bytes_in bytes_out archive_hdr1 archive_hdr2 
|where count >20 AND (archive_hdr1 = ""7z"" OR archive_hdr1 = ""PK"" OR archive_hdr2=""Rar!"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `multiple_archive_files_http_post_traffic_filter`"
Nginx ConnectWise ScreenConnect Authentication Bypass,"The following analytic detects attempts to exploit the ConnectWise ScreenConnect CVE-2024-1709 vulnerability, which allows attackers to bypass authentication via alternate paths or channels. It leverages Nginx access logs to identify web requests to the SetupWizard.aspx page, indicating potential exploitation. This activity is significant as it can lead to unauthorized administrative access and remote code execution.",NGINX,"Initial Access, Execution",T1190,"`nginx_access_logs` uri_path IN (""*/SetupWizard.aspx/*"",""*/SetupWizard/"") status=200 http_method=POST  
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, http_user_agent, url, uri_path, status, http_method, sourcetype, source 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `nginx_connectwise_screenconnect_authentication_bypass_filter`"
WordPress Bricks Builder plugin RCE,"The following analytic identifies potential exploitation of the WordPress Bricks Builder plugin RCE vulnerability. It detects HTTP POST requests to the URL path &quot;/wp-json/bricks/v1/render_element&quot; with a status code of 200, leveraging the Web datamodel. This activity is significant as it indicates an attempt to exploit CVE-2024-25600, a known vulnerability that allows remote code execution.",Zscaler Proxy,"Initial Access, Execution",T1190,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/wp-json/bricks/v1/render_element"") Web.status=200 Web.http_method=POST by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.uri_path, Web.status, Web.http_method, sourcetype, source 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wordpress_bricks_builder_plugin_rce_filter`"
Zscaler Phishing Activity Threat Blocked,"The following analytic identifies potential phishing attempts blocked by Zscaler within a network. It leverages web proxy logs to detect actions tagged as HTML.Phish. The detection method involves analyzing critical data points such as user, threat name, URL, and hostname. This activity is significant for a SOC as it serves as an early warning system for phishing threats, enabling prompt investigation and mitigation.",Zscaler Proxy,"Initial Access, Execution",T1566,"`zscaler_proxy` action=blocked threatname=""HTML.Phish*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user threatname url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_phishing_activity_threat_blocked_filter`"
Cisco ASA - Core Syslog Message Volume Drop,"Adversaries may intentionally suppress or reduce the volume of core Cisco ASA syslog messages to evade detection or cover their tracks. This hunting search is recommended to proactively identify suspicious downward shifts or absences in key syslog message IDs, which may indicate tampering or malicious activity. Visualizing this data in Splunk dashboards enables security teams to quickly spot anomalies and investigate potential compromise.",Cisco ASA,"Execution, Defense Evasion",T1562,"`cisco_asa`
message_id IN (302013, 302014, 609002, 710005)
| eval msg_desc=case(
message_id=""302013"",""Built inbound TCP connection"",
message_id=""302014"",""Teardown TCP connection"",
message_id=""609002"",""Teardown local-host management"",
message_id=""710005"",""TCP request discarded""
)
| bin _time span=15m
| stats count values(msg_desc) as message_description
values(dest) as dest
by _time message_id
| xyseries _time message_id count
| `cisco_asa___core_syslog_message_volume_drop_filter`"
Advanced IP or Port Scanner Execution,"The following analytic detects the execution of network scanning utilities such as Advanced IP Scanner or Advanced Port Scanner. These legitimate administrative tools are often leveraged by threat actors and ransomware operators during the discovery phase to enumerate active hosts and open ports within a target environment. Detection is based on process creation telemetry referencing known executable names, original file names, or specific command-line parameters such as &quot;/portable&quot; and &quot;/lng&quot; that are characteristic of these tools.",Windows Events,"Lateral Movement, Execution, Discovery, Defense Evasion","T1046, T1135","| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
Processes.process_name IN (""advanced_ip_scanner.exe"", ""advanced_ip_scanner_console.exe"", ""advanced_port_scanner.exe"", ""advanced_port_scanner_console.exe"")
OR
Processes.original_file_name IN (""advanced_ip_scanner.exe"", ""advanced_ip_scanner_console.exe"", ""advanced_port_scanner.exe"", ""advanced_port_scanner_console.exe"")
OR (
Processes.process = ""* /portable *""
Processes.process = ""* /lng *""
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `advanced_ip_or_port_scanner_execution_filter`"
Windows Defender ASR or Threat Configuration Tamper,"The following analytic detects the use of commands to disable Attack Surface Reduction (ASR) rules or change threat default actions in Windows Defender. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;Add-MpPreference&quot; or &quot;Set-MpPreference&quot;. This activity is significant because adversaries often use it to bypass Windows Defender, allowing malicious code to execute undetected.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
Processes.process IN (""*Add-MpPreference *"", ""*Set-MpPreference *"")
Processes.process IN (
""*-AttackSurfaceReductionRules_Actions*"",
""*-ThreatIDDefaultAction_Actions*""
)
Processes.process IN (
""*Allow*"", 
""*NoAction*"", 
""*Disabled*"", 
""*_Actions 6*"", 
""*_Actions 9*"", 
""*_Actions 0*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_defender_asr_or_threat_configuration_tamper_filter`"
HTTP Scripting Tool User Agent,"This Splunk query analyzes web access logs to identify and categorize non-browser user agents, detecting various types of security tools, scripting languages, automation frameworks, and suspicious patterns. This activity can signify malicious actors attempting to interact with web endpoints in non-standard ways.
Search 1`nginx_access_logs` 2| eval http_user_agent = lower(http_user_agent) 3| `security_content_ctime(firstTime)` 4| `security_content_ctime(lastTime)` 5| `drop_dm_object_name(Web)` 6| lookup scripting_tools_user_agents tool_user_agent AS http_user_agent OUTPUT tool 7| where isnotnull(tool) 8| rename dest_ip as dest 9| stats count min(firstTime) as first_seen max(lastTime) as last_seen values(tool) as tool by http_user_agent dest src_ip status 10| `http_scripting_tool_user_agent_filter` Data Source Name Platform Sourcetype Source Nginx Access Other 'nginx:plus:kv' '/var/log/nginx/access.",NGINX,"Collection, Impact, Command And Control",T1071.001,"`nginx_access_logs` 
| eval http_user_agent = lower(http_user_agent) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Web)` 
| lookup scripting_tools_user_agents tool_user_agent AS http_user_agent OUTPUT tool 
| where isnotnull(tool) 
| rename dest_ip as dest 
| stats count min(firstTime) as first_seen max(lastTime) as last_seen values(tool) as tool by http_user_agent dest src_ip status 
| `http_scripting_tool_user_agent_filter`"
Linux Service Started Or Enabled,"The following analytic detects the creation or enabling of services on Linux platforms using the systemctl or service tools. It leverages Endpoint Detection and Response (EDR) logs, focusing on process names, parent processes, and command-line executions. This activity is significant as adversaries may create or modify services to maintain persistence or execute malicious payloads.",Linux,"Execution, Persistence, Privilege Escalation","T1543, T1053.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name IN (""systemctl"", ""service"") OR Processes.process IN (""*systemctl *"", ""*service *"")) Processes.process IN (""* start *"", ""* enable *"") AND NOT (Processes.os=""Microsoft Windows"" OR Processes.vendor_product=""Microsoft Windows"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_service_started_or_enabled_filter`"
Windows Remote Management Execute Shell,"The following analytic detects the execution of winrshost.exe initiating CMD or PowerShell processes as part of a potential payload execution. winrshost.exe is associated with Windows Remote Management (WinRM) and is typically used for remote execution. By monitoring for this behavior, the detection identifies instances where winrshost.exe is leveraged to run potentially malicious commands or payloads via CMD or PowerShell.",Windows Events,"Lateral Movement, Execution",T1021.006,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=""winrshost.exe"" AND Processes.process_name IN (""cmd.exe"",""*powershell*"", ""pwsh.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_management_execute_shell_filter`"
Windows Set Network Profile Category to Private via Registry,"The following analytic detects attempts to modify the Windows Registry to change a network profile's category to &quot;Private&quot;, which may indicate an adversary is preparing the environment for lateral movement or reducing firewall restrictions. Specifically, this activity involves changes to the Category value within the HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles{GUID} registry path. A value of 1 corresponds to a private network profile, which typically enables less restrictive firewall policies.",Windows Events,"Lateral Movement, Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path = ""*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Profiles\\*"" Registry.registry_value_name = ""Category"" Registry.registry_value_data = 0x00000001 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_set_network_profile_category_to_private_via_registry_filter`"
Windows Symlink Evaluation Change via Fsutil,"This analytic detects the execution of the Windows built-in tool Fsutil.exe with the &quot;behavior&quot;, &quot;set&quot; and &quot;SymlinkEvaluation&quot; parameters. Attackers can abuse this to alter symlink evaluation behavior on Windows, potentially enabling remote traversal over SMB shares or evading defenses. Such changes should be uncommon or even rare in enterprise environments and should be investigated.",Windows Events,"Execution, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly`
count min(_time) as firstTime max(_time) as lastTime
from datamodel=Endpoint.Processes where 
(
Processes.process_name=""fsutil.exe""
OR Processes.original_file_name=""fsutil.exe""
)
Processes.process=""*behavior*""
Processes.process=""*set*""
Processes.process=""*SymlinkEvaluation*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_symlink_evaluation_change_via_fsutil_filter`"
Attempt To Add Certificate To Untrusted Store,The following analytic detects attempts to add a certificate to the untrusted certificate store using the 'certutil -addstore' command. It leverages process activity and command-line arguments from Endpoint Detection and Response (EDR) logs mapped to the Splunk Processes data model. This activity is significant as it may indicate an attacker trying to disable security tools to gain unauthorized access.,Windows Events,"Execution, Defense Evasion",T1553.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where `process_certutil` (Processes.process=*-addstore*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `attempt_to_add_certificate_to_untrusted_store_filter`"
Windows Application Whitelisting Bypass Attempt via Rundll32,"The following analytic detects the execution of rundll32.exe calling one of the following DLLs:
Advpack.dll Ieadvpack.dll Syssetup.dll Setupapi.dll with one of the following functions: &quot;LaunchINFSection&quot;, &quot;InstallHinfSection&quot;, &quot;SetupInfObjectInstallAction&quot;. This method is identified through Endpoint Detection and Response (EDR) telemetry, focusing on command-line executions and process details. This activity is significant as it indicates a potential application control or whitelisting bypass, allowing script code execution from a file.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1218, T1218.011","| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
`process_rundll32` 
Processes.process IN (""*syssetup*"", ""*advpack*"", ""*setupapi*"")
Processes.process IN (""*LaunchINFSection*"", ""*InstallHinfSection*"", ""*SetupInfObjectInstallAction*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_application_whitelisting_bypass_attempt_via_rundll32_filter`"
Windows Archived Collected Data In TEMP Folder,"The following analytic detects the creation of archived files in a temporary folder, which may contain collected data. This behavior is often associated with malicious activity, where attackers compress sensitive information before exfiltration. The detection focuses on monitoring specific directories, such as temp folders, for the presence of newly created archive files (e.g., .",Windows Events,"Collection, Execution, Exfiltration",T1560,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
FROM datamodel=Endpoint.Filesystem where 
Filesystem.file_name IN (""*.zip"", ""*.rar"", ""*.tar"", ""*.7z"") 
Filesystem.file_path IN (""*\\AppData\\Local\\Temp\\*"", ""*\\Windows\\Temp\\*"")
by Filesystem.action Filesystem.dest Filesystem.file_access_time 
Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time 
Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size 
Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_archived_collected_data_in_temp_folder_filter`"
Windows AutoIt3 Execution,"The following analytic detects the execution of AutoIt3, a scripting language often used for automating Windows GUI tasks and general scripting. It identifies instances where AutoIt3 or its variants are executed by searching for process names or original file names matching 'autoit3.exe'. This activity is significant because attackers frequently use AutoIt3 to automate malicious actions, such as executing malware.",Windows Events,Execution,T1059,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime 
from datamodel=Endpoint.Processes where 
(
Processes.process_name = ""autoit*.exe"" 
OR 
Processes.original_file_name = ""autoit*.exe""
)
by Processes.action Processes.dest Processes.original_file_name 
Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path 
Processes.process Processes.process_exec Processes.process_guid 
Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user 
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_autoit3_execution_filter`"
Windows Certutil Root Certificate Addition,"The following analytic detects the use of certutil.exe to add a certificate to the Root certificate store using the &quot;-addstore&quot; flag. In this case, the certificate is loaded from a temporary file path (e.g., %TEMP%) or other uncommon locations (e.g. C:\Users\Public\), which is highly suspicious and uncommon in legitimate administrative activity. This behavior may indicate an adversary is installing a malicious root certificate to intercept HTTPS traffic, impersonate trusted entities, or bypass security controls.",Windows Events,Execution,T1587.003,"| tstats `security_content_summariesonly` 
count min(_time) as firstTime 
max(_time) as lastTime
values(Processes.process) as process 
from datamodel=Endpoint.Processes where 
`process_certutil` 
Processes.process=*-addstore* 
Processes.process=*root*
Processes.process IN (
""*:\\PerfLogs\\*"",
""*:\\Windows\\Temp\\*"",
""*\\AppData\\Local\\Temp\\*"",
""*\\ProgramData\\*"",
""*\\Users\\Public\\*"",
""*%AppData%*"",
""*%Public%*"",
""*%Temp%*"",
""*%tmp%*""
)
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid 
Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user 
Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")`
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_certutil_root_certificate_addition_filter`"
HTTP Possible Request Smuggling,"HTTP request smuggling is a technique for interfering with the way a web site processes sequences of HTTP requests that are received from one or more users. Request smuggling vulnerabilities are often critical in nature, allowing an attacker to bypass security controls, gain unauthorized access to sensitive data, and directly compromise other application users.",Zscaler Proxy,"Command And Control, Impact",T1071.001,"`suricata` (http.request_headers{}.name=""*Content-Length*"" http.request_headers{}.name=""*Transfer-Encoding*"") OR (http.request_headers{}.name=""*Content-Length*"" http.request_headers{}.value=""*Transfer-Encoding*"") OR (http.request_headers{}.value=""*Content-Length*"" http.request_headers{}.name=""*Transfer-Encoding*"") OR (http.request_headers{}.name=""*Content-Length*"" http.request_headers{}.value=""0"") 
| rename dest_ip as dest 
| rex field=_raw ""request_headers.:\[(?<headers>.*)\]"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, dest_port, src_ip, http.url, http.http_method, http.http_user_agent, http.protocol, http.status, headers 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `http_possible_request_smuggling_filter`"
Ollama Abnormal Network Connectivity,"Detects abnormal network activity and connectivity issues in Ollama including non-localhost API access attempts and warning-level network errors such as DNS lookup failures, TCP connection issues, or host resolution problems that may indicate network-based attacks, unauthorized access attempts, or infrastructure reconnaissance activity.",Ollama,Command And Control,T1571,"`ollama_server` level=WARN (msg=""*failed*"" OR msg=""*dial tcp*"" OR msg=""*lookup*"" OR msg=""*no such host*"" OR msg=""*connection*"" OR msg=""*network*"" OR msg=""*timeout*"" OR msg=""*unreachable*"" OR msg=""*refused*"") 
| eval src=coalesce(src, src_ip, ""N/A"") 
| stats count as incidents, values(src) as src, values(msg) as warning_messages, latest(_time) as last_incident by host 
| eval last_incident=strftime(last_incident, ""%Y-%m-%d %H:%M:%S"") 
| eval severity=""medium"" 
| eval attack_type=""Abnormal Network Connectivity"" 
| stats count by last_incident, host, incidents, src, warning_messages, severity, attack_type 
| `ollama_abnormal_network_connectivity_filter`"
Ollama Abnormal Service Crash Availability Attack,"Detects critical service crashes, fatal errors, and abnormal process terminations in Ollama that may indicate exploitation attempts, resource exhaustion attacks, malicious input triggering unhandled exceptions, or deliberate denial of service attacks designed to disrupt AI model availability and degrade system stability.",Ollama,Impact,T1489,"`ollama_server` (level=ERROR OR level=FATAL OR ""service stopped"" OR ""terminated"" OR ""exit"" OR ""shutdown"" OR ""crash"" OR ""killed"") 
| rex field=_raw ""msg=\""(?<msg>[^\""]+)\"""" 
| rex field=_raw ""exit_code=(?<exit_code>\d+)"" 
| bin _time span=5m 
| stats count as termination_count, earliest(_time) as first_seen, latest(_time) as last_seen, values(msg) as error_messages, values(exit_code) as exit_codes, dc(msg) as unique_errors by host 
| eval first_seen=strftime(first_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval last_seen=strftime(last_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval severity=case( termination_count > 5, ""critical"", termination_count > 2, ""high"", 1=1, ""medium"" ) 
| eval attack_type=case( termination_count > 5, ""Resource Exhaustion"", termination_count > 2, ""Repeated Service Failures"", 1=1, ""Service Instability"" ) 
| where termination_count > 1 
| table first_seen, last_seen, host, termination_count, unique_errors, error_messages, severity, attack_type 
| `ollama_abnormal_service_crash_availability_attack_filter`"
Ollama Excessive API Requests,Detects potential Distributed Denial of Service (DDoS) attacks or rate limit abuse against Ollama API endpoints by identifying excessive request volumes from individual client IP addresses.,Ollama,Impact,T1498,"`ollama_server` 
| rex field=_raw ""\
|\s+(?<client_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\s+\
|"" 
| eval src=coalesce(src, client_ip) 
| eval dest=coalesce(dest, url, uripath, endpoint) 
| bin _time span=5m 
| stats count as request_count by _time, src, dest, host 
| where request_count > 120 
| eval severity=""high"" 
| eval attack_type=""Rate Limit Abuse / DDoS"" 
| stats count by _time, host, src, dest, request_count, severity, attack_type 
| `ollama_excessive_api_requests_filter`"
Ollama Possible API Endpoint Scan Reconnaissance,"Detects API reconnaissance and endpoint scanning activity against Ollama servers by identifying sources probing multiple API endpoints within short timeframes, particularly when using HEAD requests or accessing diverse endpoint paths, which indicates systematic enumeration to map the API surface, discover hidden endpoints, or identify vulnerabilities before launching targeted attacks.",Ollama,,T1595,"`ollama_server` ""[GIN]"" 
| bin _time span=5m 
| stats count as total_requests, values(dest) as dest, values(http_method) as methods, values(status) as status_codes by _time, src, host 
| where total_requests > 120 
| eval severity=""medium"" 
| eval attack_type=""API Activity Surge"" 
| stats count by _time, host, src, total_requests, dest, methods, status_codes, severity, attack_type 
| `ollama_possible_api_endpoint_scan_reconnaissance_filter`"
Ollama Possible Memory Exhaustion Resource Abuse,"Detects abnormal memory allocation patterns and excessive runner operations in Ollama that may indicate resource exhaustion attacks, memory abuse through malicious model loading, or attempts to degrade system performance by overwhelming GPU/CPU resources.",Ollama,"Impact, Exfiltration",T1499,"`ollama_server` (""*llama_kv_cache*"" OR ""*compute buffer*"" OR ""*llama runner started*"" OR ""*loaded runners*"") 
| rex field=_raw ""count=(?<runner_count>\d+)"" 
| rex field=_raw ""size\s*=\s*(?<memory_mb>[\d\.]+)\s+MiB"" 
| rex field=_raw ""started in\s*(?<load_time>[\d\.]+)\s*seconds"" 
| rex field=_raw ""source=(?<code_source>[^\s]+)"" 
| bin _time span=5m 
| stats count as operations, sum(runner_count) as total_runners, dc(code_source) as unique_sources, values(code_source) as code_sources, avg(memory_mb) as avg_memory, max(memory_mb) as max_memory, sum(memory_mb) as total_memory, avg(load_time) as avg_load_time, max(load_time) as max_load_time by _time, host 
| where operations > 5 OR total_runners > 0 OR max_memory > 400 OR total_memory > 500 
| eval avg_memory=round(avg_memory, 2) 
| eval max_memory=round(max_memory, 2) 
| eval total_memory=round(total_memory, 2) 
| eval avg_load_time=round(avg_load_time, 2) 
| eval severity=case( max_memory > 500 OR total_memory > 1000, ""critical"", max_memory > 400 OR operations > 20, ""high"", operations > 10, ""medium"", 1=1, ""low"" ) 
| eval attack_type=""Resource Exhaustion / Memory Abuse"" 
| sort -_time 
| table _time, host, operations, total_runners, unique_sources, avg_memory, max_memory, total_memory, avg_load_time, max_load_time, severity, attack_type 
| `ollama_possible_memory_exhaustion_resource_abuse_filter`"
Ollama Possible Model Exfiltration Data Leakage,Detects data leakage and exfiltration attempts targeting Ollama model metadata and configuration endpoints.,Ollama,Exfiltration,T1048,"`ollama_server` 
| rex field=_raw ""\
|\s+(?<status_code>\d+)\s+\
|\s+(?<response_time>[\d\.]+)s\s+\
|\s+(?<src_ip>[\:\da-f\.]+)\s+\
|\s+(?<http_method>\w+)\s+\""(?<uri_path>[^\""]+)\"""" 
| eval src=src_ip 
| eval dest=uri_path 
| where response_time > 55 
| bin _time span=15m 
| stats count, avg(response_time) as avg_response_time, max(response_time) as max_response_time by _time, src, dest, uri_path 
| eval avg_response_time=round(avg_response_time, 2) 
| eval max_response_time=round(max_response_time, 2) 
| eval severity=case( avg_response_time > 50, ""high"", avg_response_time > 40, ""medium"", 1=1, ""low"" ) 
| eval attack_type=""Potential Data Exfiltration"" 
| sort -_time 
| stats count by _time, src, uri_path, avg_response_time, max_response_time, severity, attack_type 
| `ollama_possible_model_exfiltration_data_leakage_filter`"
Ollama Possible RCE via Model Loading,"Detects Ollama server errors and failures during model loading operations that may indicate malicious model injection, path traversal attempts, or exploitation of model loading mechanisms to achieve remote code execution.",Ollama,"Initial Access, Execution, Exfiltration",T1190,"`ollama_server` level=ERROR (""*llama runner*"" OR ""*model*"" OR ""*server.go*"" OR ""*exited*"") 
| rex field=_raw ""source=(?<code_source>[^\s]+)"" 
| rex field=_raw ""msg=\""(?<msg>[^\""]+)\"""" 
| rex field=_raw ""err=\""(?<err>[^\""]+)\"""" 
| rex field=_raw ""level=(?<log_level>\w+)"" 
| eval error_type=case( match(_raw, ""exited""), ""service_crash"", match(_raw, ""model""), ""model_error"", match(_raw, ""llama runner""), ""runner_error"", 1=1, ""unknown_error"" ) 
| bin _time span=1h 
| stats count as error_count, earliest(_time) as first_error, latest(_time) as last_error, values(msg) as error_messages, values(err) as error_details, values(code_source) as code_sources, values(error_type) as error_types, dc(error_type) as unique_error_types by host 
| where error_count > 0 
| eval first_error=strftime(first_error, ""%Y-%m-%d %H:%M:%S"") 
| eval last_error=strftime(last_error, ""%Y-%m-%d %H:%M:%S"") 
| eval severity=case( match(error_details, ""exit status"") OR error_count > 5, ""critical"", error_count > 2, ""high"", 1=1, ""medium"" ) 
| eval attack_type=""Suspicious Model Loading / Potential RCE"" 
| stats count by first_error, last_error, host, code_sources, error_count, unique_error_types, error_types, error_messages, error_details, severity, attack_type 
| `ollama_possible_rce_via_model_loading_filter`"
Ollama Suspicious Prompt Injection Jailbreak,Detects potential prompt injection or jailbreak attempts against Ollama API endpoints by identifying requests with abnormally long response times.,Ollama,"Initial Access, Execution","T1190, T1059","`ollama_server` ""GIN"" (""*/api/generate*"" OR ""*/v1/chat/completions*"") 
| rex field=_raw ""\
|\s+(?<status_code>\d+)\s+\
|\s+(?<response_time>[\d\.]+[a-z]+)\s+\
|\s+(?<src_ip>[\:\da-f\.]+)\s+\
|\s+(?<http_method>\w+)\s+\""(?<uri_path>[^\""]+)\"""" 
| rex field=response_time ""^(?:(?<minutes>\d+)m)?(?<seconds>[\d\.]+)s$"" 
| eval response_time_seconds=if(isnotnull(minutes), tonumber(minutes)*60+tonumber(seconds), tonumber(seconds)) 
| eval src=src_ip 
| where response_time_seconds > 30 
| bin _time span=10m 
| stats count as long_request_count, avg(response_time_seconds) as avg_response_time, max(response_time_seconds) as max_response_time, values(uri_path) as uri_path, values(status_code) as status_codes by _time, src, host 
| where long_request_count > 170 
| eval avg_response_time=round(avg_response_time, 2) 
| eval max_response_time=round(max_response_time, 2) 
| eval severity=case( long_request_count > 50 OR max_response_time > 55, ""critical"", long_request_count > 20 OR max_response_time > 40, ""high"", 1=1, ""medium"" ) 
| eval attack_type=""Potential Prompt Injection / Jailbreak"" 
| table _time, host, src, uri_path, long_request_count, avg_response_time, max_response_time, status_codes, severity, attack_type 
| `ollama_suspicious_prompt_injection_jailbreak_filter`"
Linux Decode Base64 to Shell,"The following analytic detects the behavior of decoding base64-encoded data and passing it to a Linux shell. Additionally, it mitigates the potential damage and protects the organization's systems and data.The detection is made by searching for specific commands in the Splunk query, namely &quot;base64 -d&quot; and &quot;base64 --decode&quot;, within the Endpoint.Processes data model. The analytic also includes a filter for Linux shells.",Linux,"Execution, Exfiltration, Defense Evasion","T1059.004, T1027","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process=""*
|*"" `linux_shells` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| rex field=process ""base64\s+(?<decode_flag>-{1,2}d\w*)"" 
| where isnotnull(decode_flag) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_decode_base64_to_shell_filter`"
Create Remote Thread into LSASS,"The following analytic detects the creation of a remote thread in the Local Security Authority Subsystem Service (LSASS). This behavior is identified using Sysmon EventID 8 logs, focusing on processes that create remote threads in lsass.exe. This activity is significant because it is commonly associated with credential dumping, a tactic used by adversaries to steal user authentication credentials.",Windows Events,Credential Access,T1003.001,"`sysmon` EventID=8 TargetImage=*lsass.exe 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `create_remote_thread_into_lsass_filter`"
Windows Unusual Intelliform Storage Registry Access,"The following analytic identifies processes accessing Intelliform Storage Registry keys used by Internet Explorer. It leverages Windows Security Event logs, specifically monitoring EventCode 4663, which tracks object access events. This activity is significant because it can indicate unauthorized access or manipulation of sensitive registry keys used for storing form data in Internet Explorer. If confirmed malicious, this could lead to data exfiltration, credential theft, or further compromise of the system.",Windows Events,"Credential Access, Exfiltration",T1552.001,"`wineventlog_security` EventCode=4663  NOT (ProcessName IN(""C:\\Program Files\\Internet Explorer\\iexplore.exe"", ""C:\\Windows\\System32\\dllhost.exe"", ""C:\\Windows\\SysWow64\\dllhost.exe"")) ObjectName IN (""*Software\\microsoft\\Internet Explorer\\Intelliforms\\storage2*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by  ObjectName ObjectType ProcessName AccessMask process_id EventCode Computer Caller_User_Name 
| rename Computer as dest Caller_User_Name as user ProcessName as process_name 
|  `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unusual_intelliform_storage_registry_access_filter`"
M365 Copilot Agentic Jailbreak Attack,"Detects agentic AI jailbreak attempts that try to establish persistent control over M365 Copilot through rule injection, universal triggers, response automation, system overrides, and persona establishment techniques.",Office 365 (Microsoft 365),"Exfiltration, Discovery, Defense Evasion",T1562,"`m365_exported_ediscovery_prompt_logs` 
| eval user = Sender 
| eval rule_injection=if(match(Subject_Title, ""(?i)(rules
|instructions)\s*=""), ""YES"", ""NO"") 
| eval universal_trigger=if(match(Subject_Title, ""(?i)(every
|all).*prompt""), ""YES"", ""NO"") 
| eval response_automation=if(match(Subject_Title, ""(?i)(always
|automatic).*respond""), ""YES"", ""NO"") 
| eval system_override=if(match(Subject_Title, ""(?i)(override
|bypass
|ignore).*(system
|default)""), ""YES"", ""NO"") 
| eval persona_establishment=if(match(Subject_Title, ""(?i)(with.*\[.*\]
|persona)""), ""YES"", ""NO"") 
| where rule_injection=""YES"" OR universal_trigger=""YES"" OR response_automation=""YES"" OR system_override=""YES"" OR persona_establishment=""YES"" 
| table _time, ""Source ID"", user, Subject_Title, rule_injection, universal_trigger, response_automation, system_override, persona_establishment, Workload 
| sort -_time 
| `m365_copilot_agentic_jailbreak_attack_filter`"
M365 Copilot Impersonation Jailbreak Attack,"Detects M365 Copilot impersonation and roleplay jailbreak attempts where users try to manipulate the AI into adopting alternate personas, behaving as unrestricted entities, or impersonating malicious AI systems to bypass safety controls.",Office 365 (Microsoft 365),"Exfiltration, Discovery, Defense Evasion",T1562,"`m365_exported_ediscovery_prompt_logs` 
| search Subject_Title=""*Pretend you are*"" OR Subject_Title=""*act as*"" OR Subject_Title=""*you are now*"" OR Subject_Title=""*amoral*"" OR Subject_Title=""*being*"" OR Subject_Title=""*roleplay as*"" OR Subject_Title=""*imagine you are*"" OR Subject_Title=""*behave like*"" 
| eval user = Sender 
| eval impersonation_type=case(match(Subject_Title, ""(?i)pretend you are.*AI""), ""AI_Impersonation"", match(Subject_Title, ""(?i)(act as
|roleplay as).*AI""), ""AI_Roleplay"", match(Subject_Title, ""(?i)amoral.*AI""), ""Amoral_AI"", match(Subject_Title, ""(?i)transcendent being""), ""Fictional_Entity"", match(Subject_Title, ""(?i)(act as
|pretend you are).*(entities
|multiple)""), ""Multi_Entity"", match(Subject_Title, ""(?i)(imagine you are
|behave like).*AI""), ""AI_Behavioral_Change"", match(Subject_Title, ""(?i)you are now.*AI""), ""AI_Identity_Override"", match(Subject_Title, ""(?i)(evil
|malicious
|harmful).*AI""), ""Malicious_AI_Persona"", match(Subject_Title, ""(?i)(unrestricted
|unlimited
|uncensored).*AI""), ""Unrestricted_AI_Persona"", 1=1, ""Generic_Roleplay"") 
| table _time, user, Subject_Title, impersonation_type, Workload 
| sort -_time 
| `m365_copilot_impersonation_jailbreak_attack_filter`"
M365 Copilot Information Extraction Jailbreak Attack,"Detects M365 Copilot information extraction jailbreak attacks that attempt to obtain sensitive, classified, or comprehensive data through various social engineering techniques including fictional entity impersonation, bulk data requests, and privacy bypass attempts.",Office 365 (Microsoft 365),"Exfiltration, Discovery, Defense Evasion",T1562,"`m365_exported_ediscovery_prompt_logs` 
| search Subject_Title=""*transcendent*"" OR Subject_Title=""*incorporeal*"" OR Subject_Title=""*being who*"" OR Subject_Title=""*tell me everything*"" OR Subject_Title=""*give me all*"" OR Subject_Title=""*comprehensive*"" OR Subject_Title=""*step by step*"" OR Subject_Title=""*hidden*"" OR Subject_Title=""*secret*"" OR Subject_Title=""*confidential*"" OR Subject_Title=""*classified*"" OR Subject_Title=""*internal*"" OR Subject_Title=""*sensitive*"" OR Subject_Title=""*proprietary*"" OR Subject_Title=""*dump*"" OR Subject_Title=""*extract*"" OR Subject_Title=""*reveal*"" OR Subject_Title=""*disclose*"" OR Subject_Title=""*leak*"" 
| eval user = Sender 
| eval extraction_type=case(match(Subject_Title, ""(?i)(transcendent
|incorporeal).*being""), ""Knowledge_Entity"", match(Subject_Title, ""(?i)tell.*me.*(everything
|all)""), ""Everything_Request"", match(Subject_Title, ""(?i)(give
|show
|provide).*me.*(all
|every)""), ""Complete_Data_Request"", match(Subject_Title, ""(?i)(hidden
|secret
|confidential
|classified)""), ""Restricted_Info"", match(Subject_Title, ""(?i)(comprehensive
|complete
|full
|entire)""), ""Complete_Info"", match(Subject_Title, ""(?i)(dump
|extract
|scrape).*(data
|info
|content)""), ""Data_Extraction"", match(Subject_Title, ""(?i)(reveal
|disclose
|expose
|leak)""), ""Information_Disclosure"", match(Subject_Title, ""(?i)(internal
|proprietary
|sensitive).*information""), ""Sensitive_Data_Request"", match(Subject_Title, ""(?i)step.*by.*step.*(process
|procedure
|method)""), ""Process_Extraction"", match(Subject_Title, ""(?i)(bypass
|ignore).*privacy""), ""Privacy_Bypass"", match(Subject_Title, ""(?i)(access
|view
|see).*(private
|restricted)""), ""Unauthorized_Access"", 1=1, ""Generic_Request"") 
| eval severity=case(match(Subject_Title, ""(?i)(transcendent
|incorporeal)""), ""HIGH"", match(Subject_Title, ""(?i)tell.*everything""), ""HIGH"", match(Subject_Title, ""(?i)(dump
|extract
|scrape)""), ""HIGH"", match(Subject_Title, ""(?i)(classified
|proprietary
|confidential)""), ""CRITICAL"", match(Subject_Title, ""(?i)(hidden
|secret
|internal
|sensitive)""), ""MEDIUM"", match(Subject_Title, ""(?i)(reveal
|disclose
|leak)""), ""MEDIUM"", match(Subject_Title, ""(?i)(bypass
|ignore).*privacy""), ""HIGH"", 1=1, ""LOW"") 
| where severity!=""LOW"" 
| eval data_risk_flags=case(match(Subject_Title, ""(?i)(classified
|confidential
|proprietary)"") AND match(Subject_Title, ""(?i)(dump
|extract
|scrape)""), ""Confidential+Extraction"", match(Subject_Title, ""(?i)(everything
|all
|complete)"") AND match(Subject_Title, ""(?i)(bypass
|ignore)""), ""Bulk_Request+Bypass"", match(Subject_Title, ""(?i)(classified
|confidential
|proprietary)""), ""Confidential"", match(Subject_Title, ""(?i)(dump
|extract
|scrape)""), ""Extraction"", match(Subject_Title, ""(?i)(everything
|all
|complete
|comprehensive)""), ""Bulk_Request"", match(Subject_Title, ""(?i)(bypass
|ignore)""), ""Bypass_Attempt"", 1=1, ""Standard_Request"") 
| table _time, user, Subject_Title, extraction_type, severity, data_risk_flags, Size 
| sort -severity, -_time 
| `m365_copilot_information_extraction_jailbreak_attack_filter`"
M365 Copilot Application Usage Pattern Anomalies,"Detects M365 Copilot users exhibiting suspicious application usage patterns including multi-location access, abnormally high activity volumes, or access to multiple Copilot applications that may indicate account compromise or automated abuse. The detection aggregates M365 Copilot Graph API events per user, calculating metrics like distinct cities/countries accessed, unique IP addresses, number of different Copilot apps used, and average events per day over the observation period.",Office 365 (Microsoft 365),Defense Evasion,T1078,"`m365_copilot_graph_api` (appDisplayName=""*Copilot*"" OR appDisplayName=""M365ChatClient"" OR appDisplayName=""OfficeAIAppChatCopilot"") 
| eval user = userPrincipalName 
| stats count as events,
dc(location.city) as cities_count,
values(location.city) as city_list,
dc(location.countryOrRegion) as countries_count,
values(location.countryOrRegion) as country_list,
dc(ipAddress) as ip_count,
values(ipAddress) as ip_addresses,
dc(appDisplayName) as app_count,
values(appDisplayName) as apps_used,
dc(resourceDisplayName) as resource_count,
values(resourceDisplayName) as resources_accessed,
min(_time) as first_seen,
max(_time) as last_seen
by user
| eval days_active = round((last_seen - first_seen)/86400, 1) 
| eval first_seen = strftime(first_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval last_seen = strftime(last_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval events_per_day = if(days_active > 0, round(events/days_active, 2), events) 
| where cities_count > 1 OR events_per_day > 100 OR app_count > 2 
| sort -events_per_day, -countries_count 
| `m365_copilot_application_usage_pattern_anomalies_filter`"
M365 Copilot Failed Authentication Patterns,"Detects M365 Copilot users with failed authentication attempts, MFA failures, or multi-location access patterns indicating potential credential attacks or account compromise. The detection aggregates M365 Copilot Graph API authentication events per user, calculating metrics like distinct cities/countries accessed, unique IP addresses and browsers, failed login attempts (status containing &quot;fail&quot; or &quot;error&quot;), and MFA failures (error code 50074).",Office 365 (Microsoft 365),Credential Access,T1110,"`m365_copilot_graph_api` (appDisplayName=""*Copilot*"" OR appDisplayName=""M365ChatClient"" OR appDisplayName=""OfficeAIAppChatCopilot"") 
| eval user = userPrincipalName 
| stats count as events, dc(location.city) as cities_count, values(location.city) as city_list, dc(location.countryOrRegion) as countries_count, values(location.countryOrRegion) as country_list, dc(ipAddress) as ip_count, values(ipAddress) as ip_addresses, sum(eval(if(match(status, ""(?i)fail
|error""), 1, 0))) as failed_attempts, sum(eval(if(match(_raw, ""50074""), 1, 0))) as mfa_failures, dc(deviceDetail.browser) as browser_count, values(deviceDetail.browser) as browsers_used, min(_time) as first_seen, max(_time) as last_seen by user 
| eval first_seen = strftime(first_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval last_seen = strftime(last_seen, ""%Y-%m-%d %H:%M:%S"") 
| where cities_count > 1 OR failed_attempts > 0 OR mfa_failures > 0 
| sort -mfa_failures, -failed_attempts, -countries_count 
| `m365_copilot_failed_authentication_patterns_filter`"
M365 Copilot Non Compliant Devices Accessing M365 Copilot,"Detects M365 Copilot access from non-compliant or unmanaged devices that violate corporate security policies, indicating potential shadow IT usage, BYOD policy violations, or compromised endpoint access. The detection filters M365 Copilot Graph API events where deviceDetail.isCompliant=false or deviceDetail.isManaged=false, then aggregates by user, operating system, and browser to calculate metrics including event counts, unique IPs and locations, and compliance/management status over time.",Office 365 (Microsoft 365),Defense Evasion,T1562,"`m365_copilot_graph_api` (appDisplayName=""*Copilot*"" OR appDisplayName=""M365ChatClient"") deviceDetail.isCompliant=false OR deviceDetail.isManaged=false 
| eval user = userPrincipalName 
| stats count as events, dc(ipAddress) as unique_ips, values(ipAddress) as ip_addresses, dc(location.city) as unique_cities, values(location.city) as cities, dc(location.countryOrRegion) as unique_countries, values(location.countryOrRegion) as countries, values(deviceDetail.isCompliant) as compliance_status, values(deviceDetail.isManaged) as management_status, min(_time) as first_seen, max(_time) as last_seen by user, deviceDetail.operatingSystem, deviceDetail.browser 
| eval days_active = round((last_seen - first_seen)/86400, 1) 
| eval first_seen = strftime(first_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval last_seen = strftime(last_seen, ""%Y-%m-%d %H:%M:%S"") 
| sort -events, -unique_countries 
| `m365_copilot_non_compliant_devices_accessing_m365_copilot_filter`"
M365 Copilot Session Origin Anomalies,"Detects M365 Copilot users accessing from multiple geographic locations to identify potential account compromise, credential sharing, or impossible travel patterns. The detection aggregates M365 Copilot Graph API events per user, calculating distinct cities and countries accessed, unique IP addresses, and the observation timeframe to compute a locations-per-day metric that measures geographic mobility. Users accessing Copilot from more than one city (cities_count &gt; 1) are flagged and sorted by country and city diversity, surfacing accounts exhibiting anomalous geographic patterns that suggest compromised credentials being used from distributed locations or simultaneous access from impossible travel distances.",Office 365 (Microsoft 365),Defense Evasion,T1078,"`m365_copilot_graph_api` (appDisplayName=""*Copilot*"" OR appDisplayName=""M365ChatClient"" OR appDisplayName=""OfficeAIAppChatCopilot"") 
| eval user = userPrincipalName 
| stats count as events, dc(location.city) as cities_count, values(location.city) as city_list, dc(location.countryOrRegion) as countries_count, values(location.countryOrRegion) as country_list, dc(ipAddress) as ip_count, values(ipAddress) as ip_addresses, min(_time) as first_seen, max(_time) as last_seen by user 
| eval days_active = round((last_seen - first_seen)/86400, 1) 
| eval locations_per_day = if(days_active > 0, round(cities_count/days_active, 2), cities_count) 
| eval first_seen = strftime(first_seen, ""%Y-%m-%d %H:%M:%S"") 
| eval last_seen = strftime(last_seen, ""%Y-%m-%d %H:%M:%S"") 
| where cities_count > 1 
| sort -countries_count, -cities_count 
| `m365_copilot_session_origin_anomalies_filter`"
Windows Driver Load Non-Standard Path,"The following analytic detects the loading of new Kernel Mode Drivers from non-standard paths using Windows EventCode 7045. It identifies drivers not located in typical directories like Windows, Program Files, or SystemRoot. This activity is significant because adversaries may use these non-standard paths to load malicious or vulnerable drivers, potentially bypassing security controls. If confirmed malicious, this could allow attackers to execute code at the kernel level, escalate privileges, or maintain persistence within the environment, posing a severe threat to system integrity and security.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1068, T1014","`wineventlog_system`  EventCode = 7045  ServiceType = ""kernel mode driver"" 
| regex ImagePath != ""(?i)^(\w:\\\\Program Files\\\\
|\w:\\\\Program Files \(x86\)\\\\
|\w:\\\\Windows\\\\System32\\\\
|\w:\\\\Windows\\\\SysWOW64\\\\
|\w:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Definition Updates\\\\
|\w:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\
|%SystemRoot%
|\\\\SystemRoot\\\\
|SystemRoot\\\\)"" 
| stats count min(_time) as firstTime max(_time) as lastTime by
Computer EventCode ImagePath ServiceName ServiceType
| rename Computer as dest 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)`   
| `windows_driver_load_non_standard_path_filter`"
Detect HTML Help Spawn Child Process,"The following analytic detects the execution of hh.exe (HTML Help) spawning a child process, indicating the use of a Compiled HTML Help (CHM) file to execute Windows script code. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where hh.exe is the parent process. This activity is significant as it may indicate an attempt to execute malicious scripts via CHM files, a known technique for bypassing security controls.",Windows Events,"Execution, Defense Evasion","T1218.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=hh.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_html_help_spawn_child_process_filter`"
Cisco NVM - Suspicious Download From File Sharing Website,"This analytic detects suspicious downloads from common file sharing and content delivery platforms using known living-off-the-land binaries (LOLBins) such as 'curl.exe', 'certutil.exe', 'msiexec.exe', 'powershell.exe', 'wmic.exe', and others. It leverages Cisco Network Visibility Module logs to correlate network flow activity with process context, including command-line arguments, process path, and parent process information. These tools are often abused by adversaries and malware to retrieve payloads from public hosting platforms such as GitHub, Discord CDN, Transfer.",Cisco NVM,"Initial Access, Command And Control, Defense Evasion",T1197,"`cisco_network_visibility_module_flowdata`
(
(process_name = ""svchost.exe"" process_arguments = ""*-s BITS*"")
OR
process_name IN (
""curl.exe"", ""wmic.exe"", ""wscript.exe"", ""cscript.exe"", ""certutil.exe"",
""msiexec.exe"", ""hh.exe"", ""powershell.exe"", ""pwsh.exe"", ""powershell_ise.exe"",
""installutil.exe"", ""certoc.exe"", ""bitsadmin.exe""
)
)
dest_hostname IN (
""*.githubusercontent.com*"", ""*anonfiles.com*"", ""*cdn.discordapp.com*"", ""*ddns.net*"",
""*dl.dropboxusercontent.com*"", ""*ghostbin.co*"", ""*glitch.me*"", ""*gofile.io*"",
""*hastebin.com*"", ""*mediafire.com*"", ""*mega.nz*"", ""*onrender.com*"", ""*pages.dev*"",
""*paste.ee*"", ""*pastebin.*"", ""*pastetext.net*"", ""*privatlab.*"",
""*send.exploit.in*"", ""*sendspace.com*"", ""*storage.googleapis.com*"",
""*storjshare.io*"", ""*supabase.co*"", ""*temp.sh*"", ""*transfer.sh*"", ""*trycloudflare.com*"",
""*ufile.io*"", ""*w3spaces.com*"", ""*workers.dev*""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___suspicious_download_from_file_sharing_website_filter`"
Detect HTML Help Renamed,"The following analytic detects instances where hh.exe (HTML Help) has been renamed and is executing a Compiled HTML Help (CHM) file. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names. This activity is significant because attackers can use renamed hh.exe to execute malicious scripts embedded in CHM files, potentially leading to code execution.",Windows Events,"Execution, Defense Evasion","T1218.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name!=hh.exe AND Processes.original_file_name=HH.EXE by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_html_help_renamed_filter`"
Detect HTML Help URL in Command Line,"The following analytic detects the execution of hh.exe (HTML Help) loading a Compiled HTML Help (CHM) file from a remote URL. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions containing URLs. This activity is significant as it can indicate an attempt to execute malicious scripts via CHM files, potentially leading to unauthorized code execution.",Windows Events,"Execution, Exfiltration, Defense Evasion","T1218.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_hh` Processes.process=*http* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_html_help_url_in_command_line_filter`"
Detect HTML Help Using InfoTech Storage Handlers,"The following analytic detects the execution of hh.exe (HTML Help) using InfoTech Storage Handlers to load Windows script code from a Compiled HTML Help (CHM) file. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because it can be used to execute malicious scripts embedded within CHM files, potentially leading to code execution.",Windows Events,"Execution, Defense Evasion","T1218.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_hh` Processes.process IN (""*its:*"", ""*mk:@MSITStore:*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_html_help_using_infotech_storage_handlers_filter`"
Detect mshta renamed,"The following analytic identifies instances where mshta.exe has been renamed and executed. It leverages Endpoint Detection and Response (EDR) data, specifically focusing on the original file name field to detect discrepancies. This activity is significant because renaming mshta.exe is a common tactic used by attackers to evade detection and execute malicious scripts. If confirmed malicious, this could allow an attacker to execute arbitrary code, potentially leading to system compromise, data exfiltration, or further lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name!=mshta.exe AND Processes.original_file_name=MSHTA.EXE by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_mshta_renamed_filter`"
Detect Rundll32 Inline HTA Execution,"The following analytic detects the execution of &quot;rundll32.exe&quot; with inline protocol handlers such as &quot;JavaScript&quot;, &quot;VBScript&quot;, and &quot;About&quot;. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on command-line arguments. This activity is significant as it is often associated with fileless malware or application whitelisting bypass techniques. If confirmed malicious, this could allow an attacker to execute arbitrary code, bypass security controls, and maintain persistence within the environment.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` (Processes.process=*vbscript* OR Processes.process=*javascript* OR Processes.process=*about*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_rundll32_inline_hta_execution_filter`"
Linux Auditd Service Started,"The following analytic detects the suspicious service started. This behavior is critical for a SOC to monitor because it may indicate attempts to gain unauthorized access or maintain control over a system. Such actions could be signs of malicious activity. If confirmed, this could lead to serious consequences, including a compromised system, unauthorized access to sensitive data, or even a wider breach affecting the entire network.",Linux,"Execution, Persistence, Privilege Escalation",T1569.002,"`linux_auditd`  proctitle IN (""*systemctl *"", ""*service *"") AND proctitle IN (""* start*"", ""* enable*"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle  dest 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `linux_auditd_service_started_filter`"
Malicious PowerShell Process - Execution Policy Bypass,"The following analytic detects PowerShell processes initiated with parameters that bypass the local execution policy for scripts. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions containing specific flags like &quot;-ex&quot; or &quot;bypass.&quot; This activity is significant because bypassing execution policies is a common tactic used by attackers to run malicious scripts undetected.",Windows Events,"Execution, Exfiltration",T1059.001,"| tstats `security_content_summariesonly` values(Processes.process_id) as process_id, values(Processes.parent_process_id) as parent_process_id values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` (Processes.process=""* -ex*"" AND Processes.process=""* bypass *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `malicious_powershell_process___execution_policy_bypass_filter`"
Mshta spawning Rundll32 OR Regsvr32 Process,"The following analytic detects a suspicious mshta.exe process spawning rundll32 or regsvr32 child processes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process GUID, process name, and parent process fields. This activity is significant as it is a known technique used by malware like Trickbot to load malicious DLLs and execute payloads.",Windows Events,"Execution, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = ""mshta.exe""  `process_rundll32` OR `process_regsvr32` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `mshta_spawning_rundll32_or_regsvr32_process_filter`"
Recursive Delete of Directory In Batch CMD,"The following analytic detects the execution of a batch command designed to recursively delete files or directories, a technique often used by ransomware like Reddot to delete files in the recycle bin and prevent recovery. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include specific flags for recursive and quiet deletions.",Windows Events,"Execution, Impact, Defense Evasion",T1070.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_cmd` Processes.process=*/c*  Processes.process=""* rd *"" Processes.process=""*/s*"" Processes.process=""*/q*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `recursive_delete_of_directory_in_batch_cmd_filter`"
Suspicious mshta spawn,"The following analytic detects the spawning of mshta.exe by wmiprvse.exe or svchost.exe. This behavior is identified using Endpoint Detection and Response (EDR) data, focusing on process creation events where the parent process is either wmiprvse.exe or svchost.exe. This activity is significant as it may indicate the use of a DCOM object to execute malicious scripts via mshta.",Windows Events,"Execution, Defense Evasion",T1218.005,"| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=svchost.exe OR Processes.parent_process_name=wmiprvse.exe) AND `process_mshta` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_mshta_spawn_filter`"
Windows Archive Collected Data via Powershell,"The following analytic detects the use of PowerShell scripts to archive files into a temporary folder. It leverages PowerShell Script Block Logging, specifically monitoring for the Compress-Archive command targeting the Temp directory. This activity is significant as it may indicate an adversary's attempt to collect and compress data for exfiltration. If confirmed malicious, this behavior could lead to unauthorized data access and exfiltration, posing a severe risk to sensitive information and overall network security.",Windows Events,"Collection, Exfiltration",T1560,"`powershell` EventCode=4104 ScriptBlockText = ""*Compress-Archive*""  ScriptBlockText = ""*\\Temp\\*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_archive_collected_data_via_powershell_filter`"
Windows Archive Collected Data via Rar,"The following analytic identifies the execution of RAR utilities to archive files on a system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, GUIDs, and command-line arguments. This activity is significant as threat actors, including red-teamers and malware like DarkGate, use RAR archiving to compress and exfiltrate collected data from compromised hosts.",Windows Events,"Collection, Execution, Command And Control",T1560.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""Rar.exe"" OR Processes.original_file_name = ""Rar.exe"" AND Processes.process = ""*a*"" Processes.process = ""* -ep1*"" Processes.process = ""* -r*"" Processes.process = ""* -y*"" Processes.process = ""* -v5m*"" Processes.process = ""* -m1*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_archive_collected_data_via_rar_filter`"
Windows CAB File on Disk,"The following analytic detects .cab files being written to disk. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on events where the file name is '*.cab' and the action is 'write'. This activity is significant as .cab files can be used to deliver malicious payloads, including embedded .url files that execute harmful code.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count values(Filesystem.file_path) as file_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where (Filesystem.file_name=*.cab) by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(""Filesystem"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cab_file_on_disk_filter`"
Windows Exfiltration Over C2 Via Powershell UploadString,"The following analytic identifies potential data exfiltration using the PowerShell net.webclient command with the UploadString method. It leverages PowerShell Script Block Logging to detect instances where this command is executed. This activity is significant as it may indicate an attempt to upload sensitive data, such as desktop screenshots or files, to an external or internal URI, often associated with malware like Winter-Vivern.",Windows Events,Exfiltration,T1041,"`powershell` EventCode=4104 ScriptBlockText = ""*Net.webclient*"" AND ScriptBlockText = ""*.UploadString*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_exfiltration_over_c2_via_powershell_uploadstring_filter`"
Windows High File Deletion Frequency,"The following analytic identifies a high frequency of file deletions by monitoring Sysmon EventCodes 23 and 26 for specific file extensions. This detection leverages Sysmon logs to track deleted target filenames, process names, and process IDs. Such activity is significant as it often indicates ransomware behavior, where files are encrypted and the originals are deleted.",Windows Events,"Impact, Exfiltration",T1485,"`sysmon` EventCode IN (""23"",""26"") TargetFilename IN (""*.cmd"", ""*.ini"",""*.gif"", ""*.jpg"", ""*.jpeg"", ""*.db"", ""*.ps1"", ""*.doc"", ""*.docx"", ""*.xls"", ""*.xlsx"", ""*.ppt"", ""*.pptx"", ""*.bmp"",""*.zip"", ""*.rar"", ""*.7z"", ""*.chm"", ""*.png"", ""*.log"", ""*.vbs"", ""*.js"", ""*.vhd"", ""*.bak"", ""*.wbcat"", ""*.bkf"" , ""*.backup*"", ""*.dsk"", ""*.win"") NOT TargetFilename IN (""*\\INetCache\\Content.Outlook\\*"") 
| stats count min(_time) as firstTime, max(_time) as lastTime values(file_path) as file_path values(file_hash) as file_hash values(file_name) as file_name values(file_modify_time) as file_modify_time values(process_name) as process_name values(process_path) as process_path values(process_guid) as process_guid values(process_id) as process_id values(process_exec) as process_exec by action dest dvc signature signature_id user user_id vendor_product 
| where count >=100 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_high_file_deletion_frequency_filter`"
Windows Indicator Removal Via Rmdir,"The following analytic detects the execution of the 'rmdir' command with '/s' and '/q' options to delete files and directory trees. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process metadata. This activity is significant as it may indicate malware attempting to remove traces or components during cleanup operations.",Windows Events,"Execution, Persistence, Defense Evasion",T1070,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*rmdir*"" Processes.process = ""* /s *"" Processes.process = ""* /q *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_indicator_removal_via_rmdir_filter`"
Windows Input Capture Using Credential UI Dll,"The following analytic detects a process loading the credui.dll or wincredui.dll module. This detection leverages Sysmon EventCode 7 to identify instances where these DLLs are loaded by processes outside typical system directories. This activity is significant because adversaries often abuse these modules to create fake credential prompts or dump credentials, posing a risk of credential theft.",Windows Events,"Lateral Movement, Collection",T1056.002,"`sysmon` EventCode=7  (ImageLoaded = ""*\\credui.dll"" AND OriginalFileName = ""credui.dll"") OR (ImageLoaded = ""*\\wincredui.dll"" AND OriginalFileName = ""wincredui.dll"") AND NOT(Image IN(""*\\windows\\explorer.exe"", ""*\\windows\\system32\\*"", ""*\\windows\\sysWow64\\*"", ""*:\\program files*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_input_capture_using_credential_ui_dll_filter`"
Windows ISO LNK File Creation,"The following analytic detects the creation of .iso.lnk files in the %USER%\AppData\Local\Temp&lt;random folder name&gt;\ path, indicating that an ISO file has been mounted and accessed. This detection leverages the Endpoint.Filesystem data model, specifically monitoring file creation events in the Windows Recent folder. This activity is significant as it may indicate the delivery and execution of potentially malicious payloads via ISO files.",Windows Events,"Initial Access, Execution, Exfiltration","T1566.001, T1204.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\Microsoft\\Windows\\Recent\\*"") Filesystem.file_name IN (""*.iso.lnk"", ""*.img.lnk"", ""*.vhd.lnk"", ""*vhdx.lnk"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iso_lnk_file_creation_filter`"
Windows Office Product Dropped Cab or Inf File,"The following analytic detects Office products writing .cab or .inf files, indicative of CVE-2021-40444 exploitation. It leverages the Endpoint.Processes and Endpoint.Filesystem data models to identify Office applications creating these file types. This activity is significant as it may signal an attempt to load malicious ActiveX controls and download remote payloads, a known attack vector.",Windows Events,"Initial Access, Execution",T1566.001,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where `process_office_products` by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
|rename process_guid as proc_guid 
| join proc_guid, _time [ 
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.cab"", ""*.inf"") by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
|rename process_guid as proc_guid 
| fields _time dest file_create_time file_name file_path process_name process_path process proc_guid] 
| dedup file_create_time 
| table dest, process_name, process, file_create_time, file_name, file_path, proc_guid 
| `windows_office_product_dropped_cab_or_inf_file_filter`"
Windows Office Product Spawned Child Process For Download,"The following analytic identifies Office applications spawning child processes to download content via HTTP/HTTPS. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where Office applications like Word or Excel initiate network connections, excluding common browsers. This activity is significant as it often indicates the use of malicious documents to execute living-off-the-land binaries (LOLBins) for payload delivery.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
`process_office_products_parent`
Processes.process IN (""*http:*"",""*https:*"") 
NOT (
Processes.original_file_name IN (""firefox.exe"", ""chrome.exe"",""iexplore.exe"",""msedge.exe"")
OR
Processes.process_name IN (""firefox.exe"", ""chrome.exe"",""iexplore.exe"",""msedge.exe"")
) 
by Processes.action Processes.dest
Processes.original_file_name Processes.parent_process Processes.parent_process_exec
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid
Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name
Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_office_product_spawned_child_process_for_download_filter`"
Windows Process Executed From Removable Media,"This analytic is used to identify when a removable media device is attached to a machine and then a process is executed from the same drive letter assigned to the removable media device. Adversaries and Insider Threats may use removable media devices for several malicious activities, including initial access, execution, and exfiltration.
Search 1 2| tstats `security_content_summariesonly` count values(Processes.",Windows Events,"Initial Access, Execution, Collection, Exfiltration","T1200, T1091, T1025","| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_current_directory=* AND NOT Processes.process_current_directory IN (""C:\\*"",""*\\sysvol\\*"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name 
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash 
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path 
Processes.user Processes.user_id Processes.vendor_product Processes.process_current_directory
| `drop_dm_object_name(Processes)` 
| rex field=process_current_directory ""^(?<object_handle>[^\\\]+\\\)"" 
| where isnotnull(object_handle) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| join dest,object_handle 
[
| tstats `security_content_summariesonly` count values(Registry.action) as action values(Registry.process_guid) as process_guid values(Registry.process_id) as process_id values(Registry.registry_hive) as registry_hive values(Registry.registry_key_name) as registry_key_name values(Registry.registry_value_name) as registry_value_name values(Registry.registry_value_type) as registry_value_type values(Registry.status) as status values(Registry.user) as user values(Registry.vendor_product) as vendor_product from datamodel=Endpoint.Registry where Registry.registry_value_data=""*:\\*"" AND Registry.registry_path=""*USBSTOR*"" AND Registry.registry_path IN (""HKLM\\SOFTWARE\\Microsoft\\Windows Portable Devices\\Devices\\*"",""HKLM\\System\\CurrentControlSet\\Enum\\SWD\\WPDBUSENUM\\*"") by Registry.dest,Registry.registry_value_data, Registry.registry_path 
| `drop_dm_object_name(Registry)` 
| eval object_handle = registry_value_data, object_name = replace(mvindex(split(mvindex(split(registry_path, ""??""),1),""&amp;""),2),""PROD_"","""")
]
| `windows_process_executed_from_removable_media_filter`"
Windows Process Injection into Commonly Abused Processes,"The following analytic detects process injection into executables that are commonly abused using Sysmon EventCode 10. It identifies suspicious GrantedAccess requests (0x40 and 0x1fffff) to processes such as notepad.exe, wordpad.exe and calc.exe, excluding common system paths like System32, Syswow64, and Program Files. This behavior is often associated with the SliverC2 framework by BishopFox. Monitoring this activity is crucial as it may indicate an initial payload attempting to execute malicious code.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1055.002,"`sysmon` EventCode=10 TargetImage IN (""*\\notepad.exe"", ""*\\wordpad.exe"", ""*\\calc.exe"", ""*\\mspaint.exe"", ""*\\lsass.exe"", ""*\\svchost.exe"", ""*\\backgroundtaskhost.exe"", ""*\\dllhost.exe"", ""*\\regsvr32.exe"", ""*\\searchprotocolhost.exe"", ""*\\werfault.exe"", ""*\\wuauclt.exe"", ""*\\spoolsv.exe"", ""*\\chrome.exe"", ""*\\edge.exe"", ""*\\firefox.exe"") NOT (SourceImage IN (""*\\system32\\*"",""*\\syswow64\\*"",""*\\Program Files\\*"", ""*\\Program Files (x86)\\*"")) GrantedAccess IN (""0x40"",""0x1fffff"", ""0x1f3fff"") 
| stats values(user) as user, min(_time) as firstTime, max(_time) as lastTime, count by dest user_id parent_process_name parent_process_guid process_name process_guid process_id signature SourceImage TargetImage GrantedAccess CallTrace 
| eval CallTrace=split(CallTrace, ""
|"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime lastTime dest user_id parent_process_name parent_process_guid process_name process_guid process_id signature SourceImage TargetImage GrantedAccess CallTrace
| `windows_process_injection_into_commonly_abused_processes_filter`"
Windows Process Injection into Notepad,"The following analytic detects process injection into Notepad.exe using Sysmon EventCode 10. It identifies suspicious GrantedAccess requests (0x40 and 0x1fffff) to Notepad.exe, excluding common system paths like System32, Syswow64, and Program Files. This behavior is often associated with the SliverC2 framework by BishopFox. Monitoring this activity is crucial as it may indicate an initial payload attempting to execute malicious code within Notepad.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1055.002,"`sysmon` EventCode=10 TargetImage IN (*\\notepad.exe) NOT (SourceImage IN (""*\\system32\\*"",""*\\syswow64\\*"",""*\\Program Files\\*"")) GrantedAccess IN (""0x40"",""0x1fffff"") 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_into_notepad_filter`"
Windows Replication Through Removable Media,"The following analytic detects the creation or dropping of executable or script files in the root directory of a removable drive. It leverages data from the Endpoint.Filesystem datamodel, focusing on specific file types and their creation paths. This activity is significant as it may indicate an attempt to spread malware, such as ransomware, via removable media.",Windows Events,"Initial Access, Execution, Persistence, Lateral Movement","T1204, T1091","|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.exe"", ""*.dll"", ""*.sys"", ""*.com"", ""*.vbs"", ""*.vbe"", ""*.js"", ""*.bat"", ""*.cmd"", ""*.pif"", ""*.lnk"", ""*.url"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| eval dropped_file_path = split(file_path, ""\\"") 
| eval dropped_file_path_split_count = mvcount(dropped_file_path) 
| eval root_drive = mvindex(dropped_file_path,0) 
| where LIKE(root_drive, ""%:"") AND dropped_file_path_split_count = 2  AND root_drive!= ""C:"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_replication_through_removable_media_filter`"
Windows Scheduled Task with Suspicious Command,"The following analytic detects the creation of scheduled tasks designed to execute commands using native Windows shells like PowerShell, Cmd, Wscript, or Cscript or from public folders such as Users, Temp, or ProgramData. It leverages Windows Security EventCode 4698, 4700, and 4702 to identify when such tasks are registered, enabled, or modified. This activity is significant as it may indicate an attempt to establish persistence or execute malicious commands on a system.",Windows Events,"Execution, Persistence","T1053.005, T1053","`wineventlog_security` EventCode IN (4698,4700,4702)
| eval TaskContent = case(isnotnull(TaskContentNew),TaskContentNew,true(),TaskContent)
| xmlkv TaskContent
| stats count min(_time) as firstTime max(_time) as lastTime latest(Arguments) as Arguments latest(Author) as Author by Computer, Caller_User_Name, TaskName, Command, Enabled, Hidden, EventCode
| lookup windows_suspicious_tasks task_command as Command 
| where tool == ""shell command use"" OR tool == ""suspicious paths""
| eval command=TaskName, process=Command+if(isnotnull(Arguments),"" "".Arguments,""""), src_user=Author, user = Caller_User_Name, dest = Computer, signature_id = EventCode 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_scheduled_task_with_suspicious_command_filter`"
Windows Service Created with Suspicious Service Path,"The following analytic detects the creation of a Windows Service with a binary path located in uncommon directories, using Windows Event ID 7045. It leverages logs from the wineventlog_system to identify services installed outside typical system directories. This activity is significant as adversaries, including those deploying Clop ransomware, often create malicious services for lateral movement, remote code execution, persistence, and execution.",Windows Events,"Lateral Movement, Execution, Persistence",T1569.002,"`wineventlog_system` EventCode=7045 ImagePath = ""*.exe"" NOT (ImagePath IN (""*:\\Windows\\*"", ""*:\\Program File*"", ""*:\\Programdata\\*"", ""*%systemroot%\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath ServiceName ServiceType StartType Computer UserID 
| rename Computer as dest
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_created_with_suspicious_service_path_filter`"
Windows Spearphishing Attachment Onenote Spawn Mshta,"The following analytic detects OneNote spawning mshta.exe, a behavior often associated with spearphishing attacks. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where OneNote is the parent process. This activity is significant as it is commonly used by malware families like TA551, AsyncRat, Redline, and DCRAT to execute malicious scripts.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""onenote.exe"", ""onenotem.exe"") `process_mshta` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_spearphishing_attachment_onenote_spawn_mshta_filter`"
Windows System Binary Proxy Execution Compiled HTML File Decompile,"The following analytic detects the use of the decompile parameter with the HTML Help application (HH.exe). This behavior is identified through Endpoint Detection and Response (EDR) telemetry, focusing on command-line executions involving the decompile parameter. This activity is significant because it is an uncommon command and has been associated with APT41 campaigns, where it was used to unpack HTML help files for further malicious actions.",Windows Events,"Execution, Persistence, Defense Evasion","T1218.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_hh` Processes.process=*-decompile* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_binary_proxy_execution_compiled_html_file_decompile_filter`"
Windows USBSTOR Registry Key Modification,"This analytic is used to identify when a USB removable media device is attached to a Windows host. In this scenario we are querying the Endpoint Registry data model to look for modifications to the HKLM\System\CurrentControlSet\Enum\USBSTOR\ key. Adversaries and Insider Threats may use removable media devices for several malicious activities, including initial access, execution, and exfiltration.",Windows Events,"Initial Access, Execution, Collection, Exfiltration","T1200, T1091, T1025","| tstats `security_content_summariesonly` min(_time) as firstTime, max(_time) as lastTime, count from datamodel=Endpoint.Registry where Registry.registry_path IN (""HKLM\\System\\CurrentControlSet\\Enum\\USBSTOR\\*"") 
AND Registry.registry_value_name =""FriendlyName"" 
by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path 
Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name  
Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| eval object_name = registry_value_data, object_handle = split(mvindex(split(registry_path, ""\\""),6),""&amp;""), object_handle = mvindex(mvfilter(NOT len(object_handle)=1),0)
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_usbstor_registry_key_modification_filter`"
Windows User Execution Malicious URL Shortcut File,"The following analytic detects the creation URL shortcut files, often used by malware like CHAOS ransomware. It leverages the Endpoint.Filesystem datamodel to identify &quot;.url&quot; files created outside common directories, such as &quot;Program Files&quot;. This activity can be significant as &quot;.URL&quot; files can be used as mean to trick the user into visiting certain websites unknowingly, or when placed in certain locations such as &quot;\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\&quot;, it may allow the execution of malicious code upon system reboot.",Windows Events,"Execution, Persistence","T1204, T1204.002","|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where NOT Filesystem.file_path IN (""*:\\Program Files\\*"", ""*:\\Program Files (x86)\\*"", ""*\\AppData\\Roaming\\Microsoft\\Office\\Recent\\*"", ""*:\\Windows\\WinSxS\\*"") Filesystem.file_name=*.url by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_user_execution_malicious_url_shortcut_file_filter`"
Windows WPDBusEnum Registry Key Modification,"This analytic is used to identify when a USB removable media device is attached to a Windows host. In this scenario we are querying the Endpoint Registry data model to look for modifications to the Windows Portable Device keys HKLM\SOFTWARE\Microsoft\Windows Portable Devices\Devices\ or HKLM\System\CurrentControlSet\Enum\SWD\WPDBUSENUM\ . Adversaries and Insider Threats may use removable media devices for several malicious activities, including initial access, execution, and exfiltration.",Windows Events,"Initial Access, Execution, Collection, Exfiltration","T1200, T1091, T1025","| tstats `security_content_summariesonly` min(_time) as firstTime, max(_time) as lastTime, count from datamodel=Endpoint.Registry 
where Registry.registry_path IN (""HKLM\\SOFTWARE\\Microsoft\\Windows Portable Devices\\Devices\\*"",""HKLM\\System\\CurrentControlSet\\Enum\\SWD\\WPDBUSENUM\\*"") 
AND Registry.registry_value_name =""FriendlyName"" AND Registry.registry_path=""*USBSTOR*"" 
by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path 
Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name  
Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| eval object_handle = registry_value_data, object_name = replace(mvindex(split(mvindex(split(registry_path, ""??""),1),""&amp;""),2),""PROD_"","""")
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_wpdbusenum_registry_key_modification_filter`"
Azure AD Multi-Source Failed Authentications Spike,"The following analytic detects potential distributed password spraying attacks in an Azure AD environment. It identifies a spike in failed authentication attempts across various user-and-IP combinations from multiple source IPs and countries, using different user agents. This detection leverages Azure AD SignInLogs, focusing on error code 50126 for failed authentications. This activity is significant as it indicates an adversary's attempt to bypass security controls by distributing login attempts.",Azure AD (Microsoft Entra ID),"Lateral Movement, Credential Access, Privilege Escalation","T1586.003, T1110.004, T1110.003, T1110","`azure_monitor_aad` category=*SignInLogs properties.status.errorCode=50126 properties.authenticationDetails{}.succeeded=false 
| rename properties.* as * 
| bucket span=5m _time 
| eval uniqueIPUserCombo = src_ip . ""-"" . user 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(uniqueIPUserCombo) as uniqueIpUserCombinations, dc(user) as uniqueUsers, dc(src_ip) as uniqueIPs, dc(user_agent) as uniqueUserAgents, dc(location.countryOrRegion) as uniqueCountries values(location.countryOrRegion) as countries  values(action) as action values(dest) as dest values(user) as user values(src) as src values(vendor_account) as vendor_account values(vendor_product) as vendor_product values(user_agent) as user_agent 
| where uniqueIpUserCombinations > 20 AND uniqueUsers > 20 AND uniqueIPs > 20 AND uniqueUserAgents >= 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multi_source_failed_authentications_spike_filter`"
CertUtil With Decode Argument,"The following analytic detects the use of CertUtil.exe with the 'decode' argument, which may indicate an attempt to decode a previously encoded file, potentially containing malicious payloads. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving CertUtil.exe. This activity is significant because attackers often use CertUtil to decode malicious files downloaded from the internet, which are then executed to compromise the system.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1140,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_certutil` Processes.process=*decode* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `certutil_with_decode_argument_filter`"
Cisco NVM - Webserver Download From File Sharing Website,"This analytic detects unexpected outbound network connections initiated by known webserver processes such as httpd.exe, nginx.exe, or tomcat.exe to common file sharing or public content hosting services like GitHub, Discord CDN, Transfer.sh, or Pastebin. Webservers are rarely expected to perform outbound downloads, especially to dynamic or anonymous file hosting domains. This behavior is often associated with server compromise, where an attacker uses a reverse shell, webshell, or injected task to fetch malware or tools post-exploitation.",Cisco NVM,"Initial Access, Command And Control","T1190, T1105","`cisco_network_visibility_module_flowdata`
process_name IN (
""http*.exe"", ""nginx*.exe"", ""php*.exe"", ""php-cgi*.exe"", ""tomcat*.exe""
)
dest_hostname IN (
""*.githubusercontent.com*"", ""*anonfiles.com*"", ""*cdn.discordapp.com*"", ""*ddns.net*"",
""*dl.dropboxusercontent.com*"", ""*ghostbin.co*"", ""*glitch.me*"", ""*gofile.io*"",
""*hastebin.com*"", ""*mediafire.com*"", ""*mega.nz*"", ""*onrender.com*"", ""*pages.dev*"",
""*paste.ee*"", ""*pastebin.*"", ""*pastetext.net*"", ""*privatlab.*"",
""*send.exploit.in*"", ""*sendspace.com*"", ""*storage.googleapis.com*"",
""*storjshare.io*"", ""*supabase.co*"", ""*temp.sh*"", ""*transfer.sh*"", ""*trycloudflare.com*"",
""*ufile.io*"", ""*w3spaces.com*"", ""*workers.dev*""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___webserver_download_from_file_sharing_website_filter`"
Detect Exchange Web Shell,"The following analytic identifies the creation of suspicious .aspx files in known drop locations for Exchange exploitation, specifically targeting paths associated with HAFNIUM group and vulnerabilities like ProxyShell and ProxyNotShell. It leverages data from the Endpoint datamodel, focusing on process and filesystem events. This activity is significant as it may indicate a web shell deployment, a common method for persistent access and remote code execution.",Windows Events,"Initial Access, Execution, Persistence","T1190, T1505.003, T1133","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\HttpProxy\\owa\\auth\\*"", ""*\\inetpub\\wwwroot\\aspnet_client\\*"", ""*\\HttpProxy\\OAB\\*"") Filesystem.file_name IN( ""*.aspx"", ""*.ashx"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_exchange_web_shell_filter`"
Headless Browser Mockbin or Mocky Request,"The following analytic detects headless browser activity accessing mockbin.org or mocky.io. It identifies processes with the &quot;--headless&quot; and &quot;--disable-gpu&quot; command line arguments, along with references to mockbin.org or mocky.io. This behavior is significant as headless browsers are often used for automated tasks, including malicious activities like web scraping or automated attacks. If confirmed malicious, this activity could indicate an attempt to bypass traditional browser security measures, potentially leading to data exfiltration or further exploitation of web applications.",Windows Events,"Exfiltration, Defense Evasion",T1564.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=""*--headless*"" AND Processes.process=""*--disable-gpu*"" AND (Processes.process=""*mockbin.org/*"" OR Processes.process=""*mocky.io/*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `headless_browser_mockbin_or_mocky_request_filter`"
Short Lived Windows Accounts,"The following analytic detects the rapid creation and deletion of Windows accounts within a short time frame of 1 hour. It leverages the &quot;Change&quot; data model in Splunk, specifically monitoring events with result IDs 4720 (account creation) and 4726 (account deletion). This behavior is significant as it may indicate an attacker attempting to create and remove accounts quickly to evade detection or gain unauthorized access.",Windows Events,"Initial Access, Lateral Movement, Privilege Escalation, Defense Evasion","T1136.001, T1078.003, T1078","| tstats `security_content_summariesonly` values(All_Changes.result_id) as result_id count min(_time) as firstTime max(_time) as lastTime from datamodel=Change where All_Changes.result_id=4720 OR All_Changes.result_id=4726 by _time span=1h All_Changes.user All_Changes.dest All_Changes.Account_Management.src All_Changes.Account_Management.src_user 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(""All_Changes"")` 
| `drop_dm_object_name(""Account_Management"")` 
| transaction user connected=false maxspan=60m 
| eval create_result_id=mvindex(result_id, 0) 
| eval delete_result_id=mvindex(result_id, 1) 
| search create_result_id = 4720 delete_result_id=4726 
| table firstTime lastTime count user src src_user dest create_result_id delete_result_id 
| `short_lived_windows_accounts_filter`"
Suspicious Process Executed From Container File,"The following analytic identifies a suspicious process executed from within common container/archive file types such as ZIP, ISO, IMG, and others. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it is a common technique used by adversaries to execute scripts or evade defenses.",Windows Events,"Execution, Defense Evasion","T1036.008, T1204, T1204.002","| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""*.ZIP\\*"",""*.ISO\\*"",""*.IMG\\*"",""*.CAB\\*"",""*.TAR\\*"",""*.GZ\\*"",""*.RAR\\*"",""*.7Z\\*"") AND Processes.action=""allowed"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| regex process=""(?i).*(ZIP
|ISO
|IMG
|CAB
|TAR
|GZ
|RAR
|7Z)\\\\.+\.(BAT
|BIN
|CAB
|CMD
|COM
|CPL
|EX_
|EXE
|GADGET
|INF1
|INS
|INX
|
|HTM
|HTML
|ISU
|JAR
|JOB
|JS
|JSE
|LNK
|MSC
|MSI
|MSP
|MST
|PAF
|PIF
|PS1
|REG
|RGS
|SCR
|SCT
|SHB
|SHS
|U3P
|VB
|VBE
|VBS
|VBSCRIPT
|WS
|WSF
|WSH)\""?$"" 
| rex field=process ""(?i).+\\\\(?<file_name>[^\\\]+\.(ZIP
|ISO
|IMG
|CAB
|TAR
|GZ
|RAR
|7Z))\\\\((.+\\\\)+)?(?<process_name>.+\.(BAT
|BIN
|CAB
|CMD
|COM
|CPL
|EX_
|EXE
|GADGET
|INF1
|INS
|INX
|
|HTM
|HTML
|ISU
|JAR
|JOB
|JS
|JSE
|LNK
|MSC
|MSI
|MSP
|MST
|PAF
|PIF
|PS1
|REG
|RGS
|SCR
|SCT
|SHB
|SHS
|U3P
|VB
|VBE
|VBS
|VBSCRIPT
|WS
|WSF
|WSH))\""?$""
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_process_executed_from_container_file_filter`"
Windows HTTP Network Communication From MSIExec,"The following analytic detects MSIExec making network connections over ports 443 or 80. This behavior is identified by correlating process creation events from Endpoint Detection and Response (EDR) agents with network traffic logs. Typically, MSIExec does not perform network communication to the internet, making this activity unusual and potentially indicative of malicious behavior. If confirmed malicious, an attacker could be using MSIExec to download or communicate with external servers, potentially leading to data exfiltration, command and control (C2) communication, or further malware deployment.",Windows Events,"Command And Control, Execution, Exfiltration, Defense Evasion",T1218.007,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where `process_msiexec` by _time Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| join  process_id [
| tstats `security_content_summariesonly` count FROM datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port IN (""80"",""443"") by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction All_Traffic.process_id 
| `drop_dm_object_name(All_Traffic)` ] 
| table _time user dest parent_process_name process_name process_path process process_id dest_port dest_ip 
| `windows_http_network_communication_from_msiexec_filter`"
Windows IIS Components Add New Module,"The following analytic detects the execution of AppCmd.exe to install a new module in IIS. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries may use it to install webshells or backdoors, leading to credit card scraping, persistence, and further post-exploitation.",Windows Events,"Execution, Persistence",T1505.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where NOT (Processes.parent_process_name  IN (""msiexec.exe"", ""iissetup.exe"")) Processes.process_name=appcmd.exe Processes.process IN (""*install *"", ""*module *"") AND Processes.process=""*image*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iis_components_add_new_module_filter`"
Windows IIS Components Get-WebGlobalModule Module Query,"The following analytic identifies the execution of the PowerShell cmdlet Get-WebGlobalModule, which lists all IIS Modules installed on a system. It leverages PowerShell input data to detect this activity by capturing the module names and the image paths of the DLLs. This activity is significant for a SOC because it can indicate an attempt to enumerate installed IIS modules, which could be a precursor to exploiting vulnerabilities or misconfigurations.",Windows Events,"Execution, Persistence, Privilege Escalation",T1505.004,"`iis_get_webglobalmodule` 
| stats count min(_time) as firstTime max(_time) as lastTime by host name image 
| rename host as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iis_components_get_webglobalmodule_module_query_filter`"
Windows IIS Components New Module Added,"The following analytic detects the addition of new IIS modules on a Windows IIS server. It leverages the Windows Event log - Microsoft-IIS-Configuration/Operational, specifically EventCode 29, to identify this activity. This behavior is significant because IIS modules are rarely added to production servers, and unauthorized modules could indicate malicious activity. If confirmed malicious, an attacker could use these modules to execute arbitrary code, escalate privileges, or maintain persistence within the environment, potentially compromising the server and sensitive data.",Windows Events,Persistence,T1505.004,"`iis_operational_logs` EventCode=29 
| stats  count min(_time) as firstTime max(_time) as lastTime by OpCode EventCode ComputerName Message 
| rename ComputerName AS dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iis_components_new_module_added_filter`"
Windows Modify Registry Disable Restricted Admin,"The following analytic detects modifications to the Windows registry entry &quot;DisableRestrictedAdmin,&quot; which controls the Restricted Admin mode behavior. This detection leverages registry activity logs from endpoint data sources like Sysmon or Carbon Black. Monitoring this activity is crucial as changes to this setting can disable a security feature that limits credential exposure during remote connections.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\System\\CurrentControlSet\\Control\\Lsa\\DisableRestrictedAdmin"" Registry.registry_value_data = 0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disable_restricted_admin_filter`"
Windows Obfuscated Files or Information via RAR SFX,"The following analytic detects the creation of RAR Self-Extracting (SFX) files by monitoring the generation of file related to rar sfx .tmp file creation during sfx installation. This method leverages a heuristic to identify RAR SFX archives based on specific markers that indicate a combination of executable code and compressed RAR data. By tracking such activity, the analytic helps pinpoint potentially unauthorized or suspicious file creation events, which are often associated with malware packaging or data exfiltration.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1027.013,"`sysmon` EventCode=11 TargetFilename IN (""*__tmp_rar_sfx_access_check*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path  process_guid process_id user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_obfuscated_files_or_information_via_rar_sfx_filter`"
Windows PowerShell IIS Components WebGlobalModule Usage,"The following analytic detects the usage of PowerShell Cmdlets - New-WebGlobalModule, Enable-WebGlobalModule, and Set-WebGlobalModule, which are used to create, enable, or modify IIS Modules. This detection leverages PowerShell Script Block Logging, specifically monitoring EventCode 4104 for these cmdlets. This activity is significant as adversaries may use these lesser-known cmdlets to manipulate IIS configurations, similar to AppCmd.",Windows Events,"Execution, Persistence",T1505.004,"`powershell` EventCode=4104 ScriptBlockText IN(""*New-WebGlobalModule*"",""*Enable-WebGlobalModule*"",""*Set-WebGlobalModule*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`  
| `windows_powershell_iis_components_webglobalmodule_usage_filter`"
Windows PowerShell Invoke-Sqlcmd Execution,"This detection identifies potentially suspicious usage of Invoke-Sqlcmd PowerShell cmdlet, which can be used for database operations and potential data exfiltration. The detection looks for suspicious parameter combinations and query patterns that may indicate unauthorized database access, data theft, or malicious database operations. Threat actors may prefer using PowerShell Invoke-Sqlcmd over sqlcmd.exe as it provides a more flexible programmatic interface and can better evade detection.",Windows Events,"Execution, Privilege Escalation, Exfiltration","T1059.001, T1059.003","`powershell` EventCode=4104 ScriptBlockText=""*invoke-sqlcmd*"" 
| eval script_lower=lower(ScriptBlockText) 
| eval has_query=case( match(script_lower, ""(?i)-query\\s+""), 1, match(script_lower, ""(?i)-q\\s+""), 1, true(), 0 ), has_input_file=case( match(script_lower, ""(?i)-inputfile\\s+""), 1, match(script_lower, ""(?i)-i\\s+""), 1, true(), 0 ), has_url_input=case( match(script_lower, ""(?i)-inputfile\\s+https?://""), 1, match(script_lower, ""(?i)-i\\s+https?://""), 1, match(script_lower, ""(?i)-inputfile\\s+ftp://""), 1, match(script_lower, ""(?i)-i\\s+ftp://""), 1, true(), 0 ), has_admin_conn=case( match(script_lower, ""(?i)-dedicatedadministratorconnection""), 1, true(), 0 ), has_suspicious_auth=case( match(script_lower, ""(?i)-username\\s+sa\\b""), 1, match(script_lower, ""(?i)-u\\s+sa\\b""), 1, match(script_lower, ""(?i)-username\\s+admin\\b""), 1, match(script_lower, ""(?i)-u\\s+admin\\b""), 1, true(), 0 ), has_suspicious_query=case( match(script_lower, ""(?i)(xp_cmdshell
|sp_oacreate
|sp_execute_external
|openrowset
|bulk\\s+insert)""), 1, match(script_lower, ""(?i)(master\\.\\.\\.sysdatabases
|msdb\\.\\.\\.backuphistory
|sysadmin
|securityadmin)""), 1, match(script_lower, ""(?i)(select.*from.*sys\\.
|select.*password
|dump\\s+database)""), 1, match(script_lower, ""(?i)(sp_addextendedproc
|sp_makewebtask
|sp_addsrvrolemember)""), 1, match(script_lower, ""(?i)(sp_configure.*show\\s+advanced
|reconfigure
|enable_xp_cmdshell)""), 1, match(script_lower, ""(?i)(exec.*master\\.dbo\\.
|exec.*msdb\\.dbo\\.)""), 1, match(script_lower, ""(?i)(sp_password
|sp_control_dbmasterkey_password
|sp_dropextendedproc)""), 1, match(script_lower, ""(?i)(powershell
|cmd\\.exe
|rundll32
|regsvr32
|certutil)""), 1, true(), 0 ), has_data_exfil=case( match(script_lower, ""(?i)-outputas\\s+(dataset
|datatables)""), 1, match(script_lower, ""(?i)-as\\s+(dataset
|datatables)""), 1, match(script_lower, ""(?i)(for\\s+xml
|for\\s+json)""), 1, match(script_lower, ""(?i)(select.*into.*from
|select.*into.*outfile)""), 1, true(), 0 ), has_cert_bypass=case( match(script_lower, ""(?i)-trustservercertificate""), 1, true(), 0 )
| eval risk_score=0 
| eval risk_score=case( has_suspicious_query=1 AND has_data_exfil=1, risk_score + 90, has_url_input=1, risk_score + 80, has_suspicious_query=1, risk_score + 60, has_data_exfil=1, risk_score + 60, has_admin_conn=1, risk_score + 50, has_suspicious_auth=1, risk_score + 40, has_cert_bypass=1, risk_score + 20, true(), risk_score )
| eval command_type=case( match(script_lower, ""xp_cmdshell""), ""xp_cmdshell abuse"", match(script_lower, ""https?://""), ""Remote file execution"", match(script_lower, ""sys\\.server_principals""), ""System enumeration"", match(script_lower, ""fn_my_permissions""), ""Permission enumeration"", match(script_lower, ""username\\s+sa\\b""), ""SA account usage"", match(script_lower, ""show\\s+advanced\\s+options""), ""Configuration change attempt"", match(script_lower, ""select.*from\\s+customers""), ""Large data export"", match(script_lower, ""select.*password""), ""Sensitive data query"", match(script_lower, ""sp_configure.*xp_cmdshell""), ""Enable xp_cmdshell"", 1=1, ""General database access"" )
| eval risk_factors=mvappend( if(has_suspicious_query=1 AND has_data_exfil=1, ""High-risk query with data extraction: "".command_type, null()), if(has_url_input=1, ""Remote file input detected in command"", null()), if(has_suspicious_query=1, ""Suspicious SQL query pattern: "".command_type, null()), if(has_data_exfil=1, ""Potential data exfiltration using "".command_type, null()), if(has_admin_conn=1, ""Administrative database connection"", null()), if(has_suspicious_auth=1, ""Suspicious authentication method used"", null()), if(has_cert_bypass=1, ""Certificate validation bypassed"", null()) ) 
| eval risk_message=""PowerShell Invoke-Sqlcmd execution with risk factors: "".mvjoin(risk_factors, "", "")
| where risk_score >= 30 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode ScriptBlockText UserID Computer risk_message risk_score command_type 
| rename Computer as dest, UserID as user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_invoke_sqlcmd_execution_filter`"
Windows Privilege Escalation Suspicious Process Elevation,"The following analytic detects when a process running with low or medium integrity from a user account spawns an elevated process with high or system integrity in suspicious locations. This behavior is identified using process execution data from Windows process monitoring or Sysmon EventID 1. This activity is significant as it may indicate a threat actor successfully elevating privileges, which is a common tactic in advanced attacks.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1134, T1134.001, T1068, T1548","| tstats `security_content_summariesonly` count min(_time) as firstTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""low"",""medium"",""high"") NOT Processes.user IN (""*SYSTEM"",""*LOCAL SERVICE"",""*NETWORK SERVICE"",""DWM-*"",""*$"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| eval join_guid = process_guid, integrity_level = CASE(match(process_integrity_level,""low""),1,match(process_integrity_level,""medium""),2,match(process_integrity_level,""high""),3,match(process_integrity_level,""system""),4,true(),0) 
| rename user as src_user, parent_process* as orig_parent_process*, process* as parent_process* 
| join max=0 dest join_guid [
| tstats `security_content_summariesonly` count max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_integrity_level IN (""system"") NOT Processes.user IN (""*SYSTEM"",""*LOCAL SERVICE"",""*NETWORK SERVICE"",""DWM-*"",""*$"")) OR (Processes.process_integrity_level IN (""high"",""system"") AND (Processes.parent_process_path IN (""*\\\\*"",""*\\Users\\*"",""*\\Temp\\*"",""*\\ProgramData\\*"") OR Processes.process_path IN (""*\\\\*"",""*\\Users\\*"",""*\\Temp\\*"",""*\\ProgramData\\*""))) by Processes.dest, Processes.user, Processes.parent_process_guid, Processes.process_name, Processes.process, Processes.process_path, Processes.process_integrity_level, Processes.process_current_directory 
| `drop_dm_object_name(Processes)` 
| eval elevated_integrity_level = CASE(match(process_integrity_level,""low""),1,match(process_integrity_level,""medium""),2,match(process_integrity_level,""high""),3,match(process_integrity_level,""system""),4,true(),0) 
| rename parent_process_guid as join_guid ] 
| where elevated_integrity_level > integrity_level OR user != elevated_user 
| fields dest, user, src_user, parent_process_name, parent_process, parent_process_path, parent_process_guid, parent_process_integrity_level, parent_process_current_directory, process_name, process, process_path, process_guid, process_integrity_level, process_current_directory, orig_parent_process_name, orig_parent_process, orig_parent_process_guid, firstTime, lastTime, count 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_privilege_escalation_suspicious_process_elevation_filter`"
Windows SQL Server xp_cmdshell Config Change,"This detection identifies when the xp_cmdshell configuration is modified in SQL Server. The xp_cmdshell extended stored procedure allows execution of operating system commands and programs from SQL Server, making it a high-risk feature commonly abused by attackers for privilege escalation and lateral movement.
Search 1`wineventlog_application` EventCode=15457 2| rex field=EventData_Xml &#34;&lt;Data&gt;(?",Windows Events,"Lateral Movement, Execution, Persistence, Privilege Escalation","T1505, T1505.001","`wineventlog_application` EventCode=15457 
| rex field=EventData_Xml ""<Data>(?<config_name>[^<]+)</Data><Data>(?<old_value>[^<]+)</Data><Data>(?<new_value>[^<]+)</Data>"" 
| rename host as dest 
| where config_name=""xp_cmdshell"" 
| eval change_type=case( old_value=""0"" AND new_value=""1"", ""enabled"", old_value=""1"" AND new_value=""0"", ""disabled"", true(), ""modified"" ) 
| eval risk_score=case( change_type=""enabled"", 90, change_type=""disabled"", 60, true(), 70 ) 
| eval risk_message=""SQL Server xp_cmdshell was "".change_type."" on host "".dest 
| stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode config_name change_type risk_message risk_score 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sql_server_xp_cmdshell_config_change_filter`"
SQL Injection with Long URLs,"The following analytic detects long URLs containing multiple SQL commands, indicating a potential SQL injection attack.",Zscaler Proxy,Initial Access,T1190,"| tstats `security_content_summariesonly` count from datamodel=Web where Web.dest_category=web_server AND (Web.url_length > 1024 OR Web.http_user_agent_length > 200) by Web.src Web.dest Web.url Web.url_length Web.http_user_agent 
| `drop_dm_object_name(""Web"")` 
| eval url=lower(url) 
| eval num_sql_cmds=mvcount(split(url, ""alter%20table"")) + mvcount(split(url, ""between"")) + mvcount(split(url, ""create%20table"")) + mvcount(split(url, ""create%20database"")) + mvcount(split(url, ""create%20index"")) + mvcount(split(url, ""create%20view"")) + mvcount(split(url, ""delete"")) + mvcount(split(url, ""drop%20database"")) + mvcount(split(url, ""drop%20index"")) + mvcount(split(url, ""drop%20table"")) + mvcount(split(url, ""exists"")) + mvcount(split(url, ""exec"")) + mvcount(split(url, ""group%20by"")) + mvcount(split(url, ""having"")) + mvcount(split(url, ""insert%20into"")) + mvcount(split(url, ""inner%20join"")) + mvcount(split(url, ""left%20join"")) + mvcount(split(url, ""right%20join"")) + mvcount(split(url, ""full%20join"")) + mvcount(split(url, ""select"")) + mvcount(split(url, ""distinct"")) + mvcount(split(url, ""select%20top"")) + mvcount(split(url, ""union"")) + mvcount(split(url, ""xp_cmdshell"")) - 24 
| where num_sql_cmds > 3 
| `sql_injection_with_long_urls_filter`"
Supernova Webshell,"The following analytic detects the presence of the Supernova webshell, used in the SUNBURST attack, by identifying specific patterns in web URLs.",Zscaler Proxy,"Initial Access, Execution, Persistence","T1505.003, T1133","| tstats `security_content_summariesonly` count from datamodel=Web.Web where web.url=*logoimagehandler.ashx*codes* OR Web.url=*logoimagehandler.ashx*clazz* OR Web.url=*logoimagehandler.ashx*method* OR Web.url=*logoimagehandler.ashx*args* by Web.src Web.dest Web.url Web.vendor_product Web.user Web.http_user_agent _time span=1s 
| `supernova_webshell_filter`"
Web Remote ShellServlet Access,"The following analytic identifies attempts to access the Remote ShellServlet on a web server, specifically targeting Confluence servers vulnerable to CVE-2023-22518 and CVE-2023-22515. It leverages web data to detect URLs containing &quot;plugins/servlet/com.jsos.shell/&quot; with a status code of 200. This activity is significant as it is commonly associated with web shells and other malicious behaviors, potentially leading to unauthorized command execution.",Zscaler Proxy,"Initial Access, Execution, Collection, Privilege Escalation",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*plugins/servlet/com.jsos.shell/*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `web_remote_shellservlet_access_filter`"
Cisco NVM - MSHTML or MSHTA Network Execution Without URL in CLI,"This analytic detects suspicious use of 'mshta.exe' or 'rundll32.exe' invoking 'mshtml.dll' or the 'RunHTMLApplication' export without including a direct HTTP/HTTPS URL in the command line. This pattern could be associated with obfuscated script execution used by threat actors during initial access or payload staging. The absence of a visible URL may indicate attempts to evade static detections by embedding the URL via string concatenation, encoding (e.",Cisco NVM,"Initial Access, Execution, Defense Evasion","T1218.005, T1059.005, T1218","`cisco_network_visibility_module_flowdata`
(
(
process_name = ""mshta.exe""
process_arguments IN (""*javascript*"", ""*vbscript*"")
)
OR
( process_name = ""rundll32.exe"" AND
process_arguments = ""*mshtml*"" AND
process_arguments = ""*RunHTMLApplication*""
)
)
NOT process_arguments IN (""*http://*"", ""*https://*"")
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___mshtml_or_mshta_network_execution_without_url_in_cli_filter`"
Cisco NVM - Non-Network Binary Making Network Connection,"This analytic detects network connections initiated by binaries that are not typically associated with network communication, such as 'notepad.exe', 'calc.exe' or 'write.exe'. It leverages Cisco Network Visibility Module logs to correlate network flow activity with process context, including command-line arguments, process path, and parent process information. These applications are normally used for locally and do not require outbound network access.",Cisco NVM,"Execution, Privilege Escalation, Defense Evasion","T1036, T1055","`cisco_network_visibility_module_flowdata`
process_name IN (
""notepad.exe"", ""write.exe"", ""mspaint.exe"", ""calc.exe"",
""addinutil.exe"", ""cmstp.exe"", ""dialer.exe"", ""eqnedt32.exe"", ""IMEWDBLD.exe""
)
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___non_network_binary_making_network_connection_filter`"
Cisco NVM - Outbound Connection to Suspicious Port,"The following analytic detects any outbound network connection from an endpoint process to a known suspicious or non-standard port. It leverages Cisco Network Visibility Module flow data logs to identify potentially suspicious behavior by looking at processes communicating over ports like 4444, 2222, or 51820 are commonly used by tools like Metasploit, SliverC2 or other pentest, red team or malware.",Cisco NVM,Command And Control,T1571,"`cisco_network_visibility_module_flowdata`
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| lookup suspicious_ports_list dest_port OUTPUTNEW comment as dest_port_metadata confidence as dest_confidence category as dest_port_category
| where isnotnull(dest_port_metadata)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___outbound_connection_to_suspicious_port_filter`"
Cisco NVM - Rundll32 Abuse of MSHTML.DLL for Payload Download,"This analytic detects suspicious use of rundll32.exe in combination with mshtml.dll and the export RunHTMLApplication. This behavior is often observed in malware to execute JavaScript or VBScript in memory, enabling payload staging or bypassing script execution policies and bypassing the usage of the &quot;mshta.exe&quot; binary. The detection leverages Cisco Network Visibility Module telemetry which offers network flow activity along with process information such as command-line arguments If confirmed malicious, this activity may indicate initial access or payload download.",Cisco NVM,"Initial Access, Execution, Defense Evasion",T1218.005,"`cisco_network_visibility_module_flowdata`
process_name = ""rundll32.exe""
process_arguments = ""*mshtml*""
process_arguments IN (""*135*"", ""*RunHTMLApplication*"")
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___rundll32_abuse_of_mshtml_dll_for_payload_download_filter`"
Cisco NVM - Susp Script From Archive Triggering Network Activity,"This analytic detects script execution (wscript.exe or cscript.exe) triggered from compressed files opened directly using explorer.exe, winrar.exe, or 7zFM.exe. When a user double clicks on a &quot;.js&quot; file from within one of these compressed files. Its extracted temporally in the temp directory in folder with certain markers. It leverages Cisco Network Visibility Module (NVM) flow data, in order to look for a specific parent/child relationship and an initiated network connection.",Cisco NVM,"Initial Access, Execution","T1059.005, T1204.002","`cisco_network_visibility_module_flowdata`
parent_process_name IN (""explorer.exe"", ""winrar.exe"", ""7zFM.exe"")
process_name IN (""wscript.exe"", ""cscript.exe"")
process_arguments = ""*\\AppData\\Local\\Temp\\*""
process_arguments IN (""*\\rar*"", ""*\\7z*"", ""*.zip*"")
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_name parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_name parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___susp_script_from_archive_triggering_network_activity_filter`"
Cisco NVM - Suspicious File Download via Headless Browser,"This analytic identifies the use of Chromium-based browsers (like Microsoft Edge) running in headless mode with the --dump-dom argument. This behavior has been observed in attack campaigns such as DUCKTAIL, where browsers are automated to stealthily download content from the internet using direct URLs or suspicious hosting platforms. The detection focuses on identifying connections to known file-sharing domains or direct IPs extracted from command-line arguments and cross-checks those against the destination of the flow.",Cisco NVM,"Command And Control, Execution","T1105, T1059","`cisco_network_visibility_module_flowdata`
``` Usually the initiator of the connection is the child process, meaning the parent will contain the suspicious command.```
(
parent_process_name IN (""brave.exe"", ""chrome.exe"", ""msedge.exe"", ""opera.exe"", ""vivaldi.exe"")
OR
process_name IN (""brave.exe"", ""chrome.exe"", ""msedge.exe"", ""opera.exe"", ""vivaldi.exe"")
)
(
(parent_process_arguments=""*--headless*"" parent_process_arguments=""*--dump-dom*"")
OR
(process_arguments=""*--headless*"" process_arguments=""*--dump-dom*"")
)
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
``` In order to avoid matching with any public IP, we extract the IP value from the CommandLine and filter on it```
| rex field=parent_process_arguments ""(?i)\\b(?:https?
|ftp)://(?<extracted_ip_parent>(?:\\d{1,3}\\.){3}\\d{1,3})""
| rex field=process_arguments ""(?i)\\b(?:https?
|ftp)://(?<extracted_ip_child>(?:\\d{1,3}\\.){3}\\d{1,3})""
| eval direct_ip_match=if(dest == extracted_ip_child, 1, if(dest == extracted_ip_parent, 1, 0))
| where (
dest_hostname IN (
""*.githubusercontent.com*"", ""*anonfiles.com*"", ""*cdn.discordapp.com*"", ""*ddns.net*"",
""*dl.dropboxusercontent.com*"", ""*ghostbin.co*"", ""*glitch.me*"", ""*gofile.io*"",
""*hastebin.com*"", ""*mediafire.com*"", ""*mega.nz*"", ""*onrender.com*"", ""*pages.dev*"",
""*paste.ee*"", ""*pastebin.*"", ""*pastetext.net*"", ""*privatlab.*"",
""*send.exploit.in*"", ""*sendspace.com*"", ""*storage.googleapis.com*"",
""*storjshare.io*"", ""*supabase.co*"", ""*temp.sh*"", ""*transfer.sh*"", ""*trycloudflare.com*"",
""*ufile.io*"", ""*w3spaces.com*"", ""*workers.dev*""
)
OR direct_ip_match = 1
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_name parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_name parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___suspicious_file_download_via_headless_browser_filter`"
Cisco NVM - Suspicious Network Connection From Process With No Args,"This analytic detects system binaries that are commonly abused in process injection techniques but are observed without any command-line arguments. It leverages Cisco Network Visibility Module (NVM) flow data and process arguments to identify outbound connections initiated by curl where TLS checks were explicitly disabled. Binaries such as rundll32.exe, regsvr32.exe, dllhost.exe, svchost.exe, and others are legitimate Windows processes that are often injected into by malware or post-exploitation frameworks (e.",Cisco NVM,"Command And Control, Execution, Privilege Escalation, Defense Evasion","T1218, T1055","`cisco_network_visibility_module_flowdata`
process_name IN (
""backgroundtaskhost.exe"", ""svchost.exe"", ""dllhost.exe"", ""werfault.exe"",
""searchprotocolhost.exe"", ""wuauclt.exe"", ""spoolsv.exe"", ""rundll32.exe"",
""regasm.exe"", ""regsvr32.exe"", ""regsvcs.exe""
)
NOT process_arguments=""*""
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___suspicious_network_connection_from_process_with_no_args_filter`"
Cisco NVM - Suspicious Network Connection Initiated via MsXsl,"This analytic identifies the use of msxsl.exe initiating a network connection to a non-private IP address. Although msxsl.exe is a legitimate Microsoft utility used to apply XSLT transformations, adversaries can abuse it to execute arbitrary code or load external resources in an evasive manner. This detection leverages Cisco NVM telemetry to identify potentially malicious use of msxsl.",Cisco NVM,"Command And Control, Exfiltration, Defense Evasion",T1220,"`cisco_network_visibility_module_flowdata`
process_name = ""msxsl.exe""
NOT dest IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"",
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"",
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"",
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"",
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
src dest_hostname dest dest_port transport firstTime lastTime
| `cisco_nvm___suspicious_network_connection_initiated_via_msxsl_filter`"
Windows InstallUtil Remote Network Connection,"The following analytic detects the Windows InstallUtil.exe binary making a remote network connection. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and network telemetry. This activity is significant because InstallUtil.exe can be exploited to download and execute malicious code, bypassing application control mechanisms. If confirmed malicious, an attacker could achieve code execution, potentially leading to further system compromise, data exfiltration, or lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1218.004,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes
where `process_installutil`
by _time span=1h
Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| join process_id dest
[
| tstats `security_content_summariesonly`
count FROM datamodel=Network_Traffic.All_Traffic where
All_Traffic.dest_port != 0
by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out
All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port
All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction All_Traffic.process_id
| `drop_dm_object_name(All_Traffic)`
| rename dest as command_and_control
| rename src as dest]
| table _time user src dest parent_process_name process_name process_path process process_id dest_port command_and_control
| stats count min(_time) as firstTime
max(_time) as lastTime
values(process) as process
values(command_and_control) as command_and_control
by user dest process_name process_id dest_port parent_process_name
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_installutil_remote_network_connection_filter`"
Windows InstallUtil URL in Command Line,"The following analytic detects the use of Windows InstallUtil.exe with an HTTP or HTTPS URL in the command line. This is identified through Endpoint Detection and Response (EDR) telemetry, focusing on command-line executions containing URLs. This activity is significant as it may indicate an attempt to download and execute malicious code, potentially bypassing application control mechanisms.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1218.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
`process_installutil`
Processes.process IN (""*http://*"",""*https://*"")
by Processes.action Processes.dest Processes.original_file_name
Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid
Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path
Processes.process Processes.process_exec Processes.process_guid Processes.process_hash
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `windows_installutil_url_in_command_line_filter`"
Windows Outlook LoadMacroProviderOnBoot Persistence,"The following analytic detects the modification of the Windows Registry key &quot;LoadMacroProviderOnBoot&quot; under Outlook. This enables automatic loading of macros, which could allow malicious scripts to run without notice. This detection leverages data from the Endpoint.Registry datamodel to search for this key being enabled. This activity is significant as it is commonly associated with some malware infections, indicating potential malicious intent to harvest email information.",Windows Events,"Persistence, Defense Evasion","T1112, T1137","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\Outlook\\*"" Registry.registry_value_name=""LoadMacroProviderOnBoot"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_outlook_loadmacroprovideronboot_persistence_filter`"
Windows Outlook Macro Created by Suspicious Process,"The following analytic detects the creation of an Outlook Macro (VbaProject.OTM) by a suspicious process. This file is normally created when you create a macro from within Outlook. If this file is created by a process other than Outlook.exe it may be maliciously created. This detection leverages data from the Filesystem datamodel, specifically looking for the file creation event for VbaProject.",Windows Events,"Execution, Persistence","T1059.005, T1137","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.file_create_time) as file_create_time from datamodel=Endpoint.Filesystem where Filesystem.file_path=""*Appdata\\Roaming\\Microsoft\\Outlook\\VbaProject.OTM"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_outlook_macro_created_by_suspicious_process_filter`"
Windows PowerShell MSIX Package Installation,"The following analytic detects the execution of PowerShell commands to install unsigned AppX packages using Add-AppxPackage or Add-AppPackage cmdlets with the -AllowUnsigned flag. This detection leverages PowerShell Script Block Logging (EventCode=4104) to capture the full command content. This activity is significant as adversaries may use unsigned AppX packages to install malicious applications, bypass security controls, or establish persistence.",Windows Events,"Execution, Persistence","T1547, T1059.001, T1547.001, T1059","`powershell` EventCode=4104 ScriptBlockText IN(""*Add-AppPackage *"", ""*Add-AppxPackage *"") AND ScriptBlockText IN (""* -AllowUnsigned*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_msix_package_installation_filter` 
| `windows_powershell_msix_package_installation_filter`"
WMIC XSL Execution via URL,"The following analytic detects wmic.exe loading a remote XSL script via a URL. This detection leverages Endpoint Detection and Response (EDR) data, focusing on command-line executions that include HTTP/HTTPS URLs and the /FORMAT switch. This activity is significant as it indicates a potential application control bypass, allowing adversaries to execute JScript or VBScript within an XSL file.",Windows Events,"Execution, Persistence, Defense Evasion",T1220,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where
`process_wmic`
Processes.process IN (""*http://*"", ""*https://*"")
Processes.process=""*/format:*""
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process
Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id
Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user
Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `wmic_xsl_execution_via_url_filter`"
Cisco Smart Install Oversized Packet Detection,"This analytic detects oversized Cisco Smart Install (SMI) protocol messages by inspecting traffic to TCP port 4786 within the Network_Traffic data model. Abnormally large SMI payloads have been associated with exploitation and protocol abuse (e.g., CVE-2018-0171; activity reported by the &quot;Static Tundra&quot; threat actor). Monitoring message sizes over time can help identify possible attempts at remote code execution, denial of service, or reconnaissance against Cisco devices exposing Smart Install.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Initial Access, Execution",T1190,"| tstats `security_content_summariesonly`
avg(All_Traffic.packets) as avg_packets,
max(All_Traffic.bytes) as max_bytes
from datamodel=Network_Traffic
where All_Traffic.dest_port=4786 AND All_Traffic.transport=tcp
by All_Traffic.src_ip, All_Traffic.dest_ip, _time span=1h
| `drop_dm_object_name(""All_Traffic"")`
| where max_bytes > 500
| eval severity=case(max_bytes>1400, ""critical"", max_bytes>1000, ""high"", 1=1, ""medium"")
| `cisco_smart_install_oversized_packet_detection_filter`"
Windows Outlook Dialogs Disabled from Unusual Process,"The following analytic detects the modification of the Windows Registry key &quot;PONT_STRING&quot; under Outlook Options. This disables certain dialog popups, which could allow malicious scripts to run without notice. This detection leverages data from the Endpoint.Registry datamodel to search for this key changing from an unusual process. This activity is significant as it is commonly associated with some malware infections, indicating potential malicious intent to harvest email information.",Windows Events,"Execution, Persistence, Defense Evasion","T1112, T1562","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\Outlook\\Options\\General*"" Registry.registry_value_name=""PONT_STRING"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| join process_guid [
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes WHERE NOT (Processes.process_name = ""Outlook.exe"") by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`] 
| fields _time parent_process_name parent_process process_name process_path process process_guid registry_path registry_value_name registry_value_data registry_key_name action dest user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_outlook_dialogs_disabled_from_unusual_process_filter`"
Windows Outlook Macro Security Modified,"The following analytic detects the modification of the Windows Registry key &quot;Level&quot; under Outlook Security. This allows macros to execute without warning, which could allow malicious scripts to run without notice. This detection leverages data from the Endpoint.Registry datamodel, specifically looking for the registry value name &quot;Level&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it is commonly associated with some malware infections, indicating potential malicious intent to harvest email information.",Windows Events,"Command And Control, Persistence","T1008, T1137","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\Outlook\\Security*"" Registry.registry_value_name=""Level"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_outlook_macro_security_modified_filter`"
Azure Automation Account Created,"The following analytic detects the creation of a new Azure Automation account within an Azure tenant. It leverages Azure Audit events, specifically the Azure Activity log category, to identify when an account is created or updated. This activity is significant because Azure Automation accounts can be used to automate tasks and orchestrate actions across Azure and on-premise environments.",Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_audit` operationName.value=""Microsoft.Automation/automationAccounts/write"" status.value=Succeeded 
| dedup object 
| rename claims.ipaddr as src, subscriptionId as vendor_account, operationName.value as signature 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product object object_path signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_automation_account_created_filter`"
Azure Automation Runbook Created,"The following analytic detects the creation of a new Azure Automation Runbook within an Azure tenant. It leverages Azure Audit events, specifically the Azure Activity log category, to identify when a new Runbook is created or updated. This activity is significant because adversaries with privileged access can use Runbooks to maintain persistence, escalate privileges, or execute malicious code.",Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_audit` operationName.value=""Microsoft.Automation/automationAccounts/runbooks/write"" object!=AzureAutomationTutorial* status.value=Succeeded 
| dedup object 
| rename claims.ipaddr as src, subscriptionId as vendor_account, operationName.value as operationName 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product object object_path 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_automation_runbook_created_filter`"
Azure Runbook Webhook Created,"The following analytic detects the creation of a new Automation Runbook Webhook within an Azure tenant. It leverages Azure Audit events, specifically the &quot;Create or Update an Azure Automation webhook&quot; operation, to identify this activity. This behavior is significant because Webhooks can trigger Automation Runbooks via unauthenticated URLs exposed to the Internet, posing a security risk.",Azure AD (Microsoft Entra ID),"Persistence, Discovery, Defense Evasion","T1078.004, T1078","`azure_audit` operationName.value=""Microsoft.Automation/automationAccounts/webhooks/write"" status.value=Succeeded 
| dedup object 
| rename claims.ipaddr as src_ip 
| rename caller as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest by object user, src_ip, resourceGroupName, object_path 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_runbook_webhook_created_filter`"
Domain Account Discovery with Dsquery,"The following analytic identifies the execution of dsquery.exe with command-line arguments used to discover domain users. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to map out domain users, which is a common precursor to further attacks.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.002, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""dsquery.exe"" AND Processes.process = ""*user*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_account_discovery_with_dsquery_filter`"
Domain Group Discovery With Dsquery,"The following analytic identifies the execution of dsquery.exe with command-line arguments used to query for domain groups. It leverages Endpoint Detection and Response (EDR) data, focusing on process names and command-line arguments. This activity is significant because both Red Teams and adversaries use dsquery.exe to enumerate domain groups, gaining situational awareness and facilitating further Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Exfiltration","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""dsquery.exe"") (Processes.process=""*group*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_group_discovery_with_dsquery_filter`"
Remote System Discovery with Dsquery,"The following analytic detects the execution of dsquery.exe with the computer argument, which is used to discover remote systems within a domain. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Remote system discovery is significant as it indicates potential reconnaissance activities by adversaries or Red Teams to map out network resources and Active Directory structures.",Windows Events,"Lateral Movement, Execution, Discovery",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""dsquery.exe"") (Processes.process=""*computer*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_system_discovery_with_dsquery_filter`"
System User Discovery With Whoami,"The following analytic detects the execution of whoami.exe without any arguments. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because both Red Teams and adversaries use whoami.exe to identify the current logged-in user, aiding in situational awareness and Active Directory discovery. If confirmed malicious, this behavior could indicate an attacker is gathering information to further compromise the system, potentially leading to privilege escalation or lateral movement within the network.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""whoami.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `system_user_discovery_with_whoami_filter`"
Windows SQL Server Configuration Option Hunt,"This detection helps hunt for changes to SQL Server configuration options that could indicate malicious activity. It monitors for modifications to any SQL Server configuration settings, allowing analysts to identify potentially suspicious changes that may be part of an attack, such as enabling dangerous features or modifying security-relevant settings.",Windows Events,"Persistence, Discovery","T1505, T1505.001","`wineventlog_application` EventCode=15457 
| rex field=EventData_Xml ""<Data>(?<config_name>[^<]+)</Data><Data>(?<old_value>[^<]+)</Data><Data>(?<new_value>[^<]+)</Data>"" 
| rename host as dest 
| eval change_type=case( old_value=""0"" AND new_value=""1"", ""enabled"", old_value=""1"" AND new_value=""0"", ""disabled"", true(), ""modified"" ) 
| eval risk_score=case( change_type=""enabled"", 90, change_type=""disabled"", 60, true(), 70 ) 
| eval risk_message=""SQL Server "".config_name."" was "".change_type."" on host "".dest 
| stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode config_name change_type risk_message risk_score 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sql_server_configuration_option_hunt_filter`"
Windows SQL Server Critical Procedures Enabled,"This detection identifies when critical SQL Server configuration options are modified, including &quot;Ad Hoc Distributed Queries&quot;, &quot;external scripts enabled&quot;, &quot;Ole Automation Procedures&quot;, &quot;clr enabled&quot;, and &quot;clr strict security&quot;. These features can be abused by attackers for various malicious purposes - Ad Hoc Distributed Queries enables Active Directory reconnaissance through ADSI provider, external scripts and Ole Automation allow execution of arbitrary code, and CLR features can be used to run custom assemblies.",Windows Events,"Discovery, Execution, Persistence","T1505, T1505.001","`wineventlog_application` EventCode=15457 
| rex field=EventData_Xml ""<Data>(?<config_name>[^<]+)</Data><Data>(?<old_value>[^<]+)</Data><Data>(?<new_value>[^<]+)</Data>"" 
| where config_name IN (""Ad Hoc Distributed Queries"", ""external scripts enabled"", ""Ole Automation Procedures"", ""clr enabled"", ""clr strict security"") 
| rename host as dest 
| eval change_type=case( old_value=""0"" AND new_value=""1"", ""enabled"", old_value=""1"" AND new_value=""0"", ""disabled"", true(), ""modified"" ) 
| eval risk_score=case( change_type=""enabled"", 90, change_type=""disabled"", 60, true(), 70 ) 
| eval risk_message=""SQL Server critical procedure "".config_name."" was "".change_type."" on host "".dest."", which may indicate attempts to gain code execution or perform reconnaissance"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode config_name change_type risk_message risk_score 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sql_server_critical_procedures_enabled_filter`"
Wmic Group Discovery,"The following analytic identifies the use of wmic.exe to enumerate local groups on an endpoint. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs, including command-line details. Monitoring this activity is significant as it can indicate reconnaissance efforts by an attacker to understand group memberships, which could be a precursor to privilege escalation or lateral movement.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Defense Evasion, Discovery","T1069, T1069.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wmic.exe (Processes.process=""*group get name*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `wmic_group_discovery_filter`"
AWS Defense Evasion Impair Security Services,"The following analytic detects attempts to impair or disable AWS security services by monitoring specific deletion operations across GuardDuty, AWS WAF (classic and v2), CloudWatch, Route 53, and CloudWatch Logs. These actions include deleting detectors, rule groups, IP sets, web ACLs, logging configurations, alarms, and log streams. Adversaries may perform such operations to evade detection or remove visibility from defenders.",AWS CloudTrail,"Discovery, Defense Evasion",T1562.008,"`cloudtrail`
(eventName=""DeleteDetector"" AND eventSource=""guardduty.amazonaws.com"") OR (   eventName IN (""DeleteIPSet"", ""DeleteWebACL"", ""DeleteRuleGroup"", ""DeleteRule"") AND eventSource IN (""guardduty.amazonaws.com"", ""wafv2.amazonaws.com"", ""waf.amazonaws.com"") ) OR ( eventName=""DeleteLoggingConfiguration"" AND eventSource IN (""wafv2.amazonaws.com"", ""waf.amazonaws.com"", ""route53.amazonaws.com"") )
| rename user_name as user
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `aws_defense_evasion_impair_security_services_filter`"
Windows Net System Service Discovery,"The following analytic detects the enumeration of Windows services using the net start command, which is a built-in utility that lists all running services on a system. Adversaries, system administrators, or automated tools may use this command to gain situational awareness of what services are active, identify potential security software, or discover opportunities for privilege escalation and lateral movement.",Windows Events,"Execution, Lateral Movement, Privilege Escalation, Defense Evasion, Discovery",T1007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process=""* start*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_net_system_service_discovery_filter`"
Windows WMI Process And Service List,"The following analytic identifies suspicious WMI command lines querying for running processes or services. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific process and command-line events. This activity is significant as adversaries often use WMI to gather system information and identify services on compromised machines. If confirmed malicious, this behavior could allow attackers to map out the system, identify critical services, and plan further attacks, potentially leading to privilege escalation or persistence within the environment.",Windows Events,"Execution, Persistence, Impact, Privilege Escalation, Discovery",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` Processes.process IN (""*process*"", ""*service*"") Processes.process = ""*list*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmi_process_and_service_list_filter`"
Windows Wmic CPU Discovery,"The following analytic detects the use of WMIC (Windows Management Instrumentation Command-line) for CPU discovery, often executed with commands such as â€œwmic cpu get nameâ€ This behavior is commonly associated with reconnaissance, where adversaries seek to gather details about system hardware, assess processing power, or determine if the environment is virtualized. While WMIC is a legitimate administrative tool, its use for CPU queries outside of normal inventory or management scripts can indicate malicious intent.",Windows Events,"Execution, Discovery",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""* cpu*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_cpu_discovery_filter`"
Windows Wmic DiskDrive Discovery,The following analytic detects the use of Windows Management Instrumentation Command-line (WMIC) for disk drive discovery activities on a Windows system. This process involves monitoring commands such as â€œwmic diskdriveâ€ which are often used by administrators for inventory and diagnostics but can also be leveraged by attackers to enumerate hardware details for malicious purposes.,Windows Events,"Lateral Movement, Execution, Discovery",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""* diskdrive*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_diskdrive_discovery_filter`"
Windows Wmic Memory Chip Discovery,"The following analytic detects the execution of Windows Management Instrumentation Command-line (WMIC) commands related to memory chip discovery on a Windows system. Specifically, it monitors instances where commands such as â€œwmic memorychipâ€ are used to retrieve detailed information about installed RAM modules. While these commands can serve legitimate administrative and troubleshooting purposes, they may also be employed by adversaries to gather system hardware specifications as part of their reconnaissance activities.",Windows Events,"Execution, Discovery",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""* memorychip*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_memory_chip_discovery_filter`"
Windows Wmic Network Discovery,"The following analytic detects the execution of Windows Management Instrumentation Command-line (WMIC) commands used for network interface discovery on a Windows system. Specifically, it identifies commands such as â€œwmic nicâ€ that retrieve detailed information about the network adapters installed on the device. While these commands are commonly used by IT administrators for legitimate network inventory and diagnostics, they can also be leveraged by malicious actors for reconnaissance, enabling them to map network configurations and identify potential targets.",Windows Events,"Execution, Discovery",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""* nic*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_network_discovery_filter`"
Windows Wmic Systeminfo Discovery,"The following analytic detects the execution of Windows Management Instrumentation Command-line (WMIC) commands used for computer system discovery on a Windows system. Specifically, it monitors for commands such as â€œwmic computersystemâ€ that retrieve detailed information about the computerâ€™s model, manufacturer, name, domain, and other system attributes. While these commands are commonly used by administrators for inventory and troubleshooting, they may also be exploited by adversaries to gain insight into the target environment during the reconnaissance phase of an attack.",Windows Events,"Execution, Discovery",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""* computersystem*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_systeminfo_discovery_filter`"
Download Files Using Telegram,"The following analytic detects suspicious file downloads by the Telegram application on a Windows system. It leverages Sysmon EventCode 15 to identify instances where Telegram.exe creates files with a Zone.Identifier, indicating a download. This activity is significant as it may indicate an adversary using Telegram to download malicious tools, such as network scanners, for further exploitation.",Windows Events,"Lateral Movement, Command And Control, Discovery",T1105,"`sysmon` EventCode= 15 process_name = ""telegram.exe"" TargetFilename = ""*:Zone.Identifier"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc file_hash file_name file_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Contents Image 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `download_files_using_telegram_filter`"
Randomly Generated Scheduled Task Name,"The following analytic detects the creation of a Scheduled Task with a high entropy, randomly generated name, leveraging Event ID 4698.",Windows Events,"Lateral Movement, Execution, Persistence","T1053.005, T1053","`wineventlog_security` EventCode=4698 
| xmlkv Message 
| lookup ut_shannon_lookup word as Task_Name 
| where ut_shannon > 3 
| table  _time, dest, Task_Name, ut_shannon, Command, Author, Enabled, Hidden 
| `randomly_generated_scheduled_task_name_filter`"
Scheduled Task Creation on Remote Endpoint using At,"The following analytic detects the creation of scheduled tasks on remote Windows endpoints using the at.exe command. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process creation events involving at.exe with remote command-line arguments. Identifying this activity is significant for a SOC as it may indicate lateral movement or remote code execution attempts by an attacker.",Windows Events,"Lateral Movement, Execution, Persistence",T1053.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=at.exe OR Processes.original_file_name=at.exe) (Processes.process=*\\\\*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `scheduled_task_creation_on_remote_endpoint_using_at_filter`"
Windows SpeechRuntime Suspicious Child Process,"SpeechRuntime is vulnerable to an attack that allows a user to run code on another user's session remotely and stealthily by exploiting a Windows COM class. When this class is invoked, it launches SpeechRuntime.exe in the context of the currently logged-on user. Because this COM class is susceptible to COM Hijacking, the attacker can alter the registry remotely to point to a malicious DLL.",Windows Events,"Lateral Movement, Execution",T1021.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=""*SpeechRuntime.exe*"") Processes.process IN (""*cmd.exe*"",""*powershell.exe*"",""*rundll32.exe*"",""*bitsadmin.exe*"",""*wmic.exe*"",""*cscript.exe*"") by Processes.dest Processes.user Processes.original_file_name Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id Processes.parent_process_name action parent_process_exec parent_process_guid parent_process_path process_exec process_guid process_hash process_integrity_level process_path user_id vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_speechruntime_suspicious_child_process_filter`"
Windows Time Based Evasion via Choice Exec,"The following analytic detects the use of choice.exe in batch files as a delay tactic, a technique observed in SnakeKeylogger malware. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential time-based evasion techniques used by malware to avoid detection.",Windows Events,"Execution, Defense Evasion",T1497.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name =choice.exe  Processes.process = ""*/T*""  Processes.process = ""*/N*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_time_based_evasion_via_choice_exec_filter`"
Wscript Or Cscript Suspicious Child Process,"This analytic identifies a suspicious spawned process by WScript or CScript process. This technique was a common technique used by adversaries and malware to execute different LOLBIN, other scripts like PowerShell or spawn a suspended process to inject its code as a defense evasion. This TTP may detect some normal script that uses several application tools that are in the list of the child process it detects but a good pivot and indicator that a script may execute suspicious code.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1134.004, T1543, T1055","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""cscript.exe"", ""wscript.exe"") Processes.process_name IN (""regsvr32.exe"", ""rundll32.exe"",""winhlp32.exe"",""certutil.exe"",""msbuild.exe"",""cmd.exe"",""powershell*"",""pwsh.exe"",""wmic.exe"",""mshta.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wscript_or_cscript_suspicious_child_process_filter`"
Windows DNS Query Request by Telegram Bot API,"The following analytic detects the execution of a DNS query by a process to the associated Telegram API domain, which could indicate access via a Telegram bot commonly used by malware for command and control (C2) communications. By monitoring DNS queries related to Telegram's infrastructure, the detection identifies potential attempts to establish covert communication channels between a compromised system and external malicious actors.",Windows Events,"Command And Control, Execution","T1102.002, T1071.004","`sysmon` EventCode=22  query = ""api.telegram.org"" process_name != ""telegram.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dns_query_request_by_telegram_bot_api_filter`"
Cisco Configuration Archive Logging Analysis,"This analytic provides comprehensive monitoring of configuration changes on Cisco devices by analyzing archive logs. Configuration archive logging captures all changes made to a device's configuration, providing a detailed audit trail that can be used to identify suspicious or malicious activities. This detection is particularly valuable for identifying patterns of malicious configuration changes that might indicate an attacker's presence, such as the creation of backdoor accounts, SNMP community string modifications, and TFTP server configurations for data exfiltration.",Windows Events,"Execution, Persistence, Privilege Escalation, Defense Evasion, Exfiltration","T1562.001, T1098, T1505.003","| tstats `security_content_summariesonly` count values(All_Changes.command) as commands min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where ( (All_Changes.command=""*username*privilege 15*"") OR (All_Changes.command=""*username*password*"") OR (All_Changes.command=""*USER TABLE MODIFIED*"") OR (All_Changes.command=""*tftp-server*"") OR (All_Changes.command=""*snmp-server community*"") ) by All_Changes.dvc All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_configuration_archive_logging_analysis_filter`"
Cisco IOS Suspicious Privileged Account Creation,"This analytic detects the creation of privileged user accounts on Cisco IOS devices, which could indicate an attacker establishing backdoor access. The detection focuses on identifying when user accounts are created with privilege level 15 (the highest administrative privilege level in Cisco IOS) or when existing accounts have their privileges elevated. This type of activity is particularly concerning when performed by unauthorized users or during unusual hours, as it may represent a key step in establishing persistence following the exploitation of vulnerabilities like CVE-2018-0171 in Cisco Smart Install.",Cisco IOS,"Initial Access, Execution, Persistence, Defense Evasion","T1078, T1136","| tstats `security_content_summariesonly` count values(All_Changes.command) as command min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where ( (All_Changes.command=""*username * privilege 15*"") OR (All_Changes.command=""*username * password*"" AND All_Changes.command=""*USER TABLE MODIFIED*"") OR (All_Changes.command=""*USER_PRIVILEGE_UPDATE*priv-15*"") ) by All_Changes.dvc All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_ios_suspicious_privileged_account_creation_filter`"
Cisco Network Interface Modifications,"This analytic detects the creation or modification of network interfaces on Cisco devices, which could indicate an attacker establishing persistence or preparing for lateral movement. After gaining initial access to network devices, threat actors like Static Tundra often create new interfaces (particularly loopback interfaces) to establish covert communication channels or maintain persistence.",Cisco IOS,"Initial Access, Execution, Credential Access, Lateral Movement, Persistence, Defense Evasion","T1556, T1021, T1133","| tstats `security_content_summariesonly` count values(All_Changes.command) as command min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where ( (All_Changes.command=""*interface*"") OR (All_Changes.command=""*LINEPROTO-5-UPDOWN*"") OR (All_Changes.command=""*ip address*"") ) by All_Changes.dvc All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_network_interface_modifications_filter`"
Cisco SNMP Community String Configuration Changes,"This analytic detects changes to SNMP community strings on Cisco devices, which could indicate an attacker establishing persistence or attempting to extract credentials. After gaining initial access to network devices, threat actors like Static Tundra often modify SNMP configurations to enable unauthorized monitoring and data collection. This detection specifically looks for the configuration of SNMP community strings with read-write (rw) or read-only (ro) permissions, as well as the configuration of SNMP hosts that may be used to exfiltrate data.",Windows Events,"Initial Access, Execution, Credential Access, Collection, Persistence, Defense Evasion, Discovery, Exfiltration","T1552, T1040, T1562.001","| tstats `security_content_summariesonly` count values(All_Changes.command) as command min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where ( (All_Changes.command=""*snmp-server community*rw*"") OR (All_Changes.command=""*snmp-server community*ro*"") OR (All_Changes.command=""*snmp-server host*"") ) by All_Changes.dvc All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_snmp_community_string_configuration_changes_filter`"
Cisco TFTP Server Configuration for Data Exfiltration,"This analytic detects the configuration of TFTP services on Cisco IOS devices that could be used to exfiltrate sensitive configuration files. Threat actors like Static Tundra have been observed configuring TFTP servers to make device configuration files accessible for exfiltration after gaining initial access. The detection specifically looks for commands that expose critical configuration files such as startup-config, running-config, and other sensitive system information through TFTP.",Windows Events,"Initial Access, Execution, Collection, Exfiltration","T1005, T1567","| tstats `security_content_summariesonly` count values(All_Changes.command) as command min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where  (All_Changes.command=""*tftp-server*"") AND ( All_Changes.command=""*nvram:startup-config*"" OR All_Changes.command=""*bootflash:running-config*"" OR All_Changes.command=""*system:running-config*"" OR All_Changes.command=""*bootflash:info*"" OR All_Changes.command=""*startup-config*"" OR All_Changes.command=""*running-config*"" ) by All_Changes.dvc All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cisco_tftp_server_configuration_for_data_exfiltration_filter`"
Disabling Windows Local Security Authority Defences via Registry,"The following analytic identifies the deletion of registry keys that disable Local Security Authority (LSA) protection and Microsoft Defender Device Guard. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry actions and paths associated with LSA and Device Guard settings. This activity is significant because disabling these defenses can leave a system vulnerable to various attacks, including credential theft and unauthorized code execution.",Windows Events,"Exfiltration, Execution, Credential Access, Defense Evasion",T1556,"| tstats `security_content_summariesonly` min(_time) as _time from datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\Lsa\\LsaCfgFlags"", ""*\\Lsa\\RunAsPPL"", ""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\DeviceGuard\\*"") AND ((Registry.action = deleted) OR (Registry.action = modified AND Registry.registry_value_data IN(0x00000000, 0))) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_windows_local_security_authority_defences_via_registry_filter`"
Windows Access Token Winlogon Duplicate Handle In Uncommon Path,"The following analytic detects a process attempting to duplicate the handle of winlogon.exe from an uncommon or public source path. This is identified using Sysmon EventCode 10, focusing on processes targeting winlogon.exe with specific access rights and excluding common system paths. This activity is significant because it may indicate an adversary trying to escalate privileges by leveraging the high-privilege tokens associated with winlogon.",Windows Events,Defense Evasion,"T1134, T1134.001","`sysmon` EventCode=10  TargetImage IN(""*\\system32\\winlogon.exe*"", ""*\\SysWOW64\\winlogon.exe*"") AND GrantedAccess = 0x1040 AND NOT (SourceImage IN(""C:\\Windows\\*"", ""C:\\Program File*"", ""%systemroot%\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_access_token_winlogon_duplicate_handle_in_uncommon_path_filter`"
Windows Excel ActiveMicrosoftApp Child Process,"The following analytic identifies the execution of the ActiveMicrosoftApp process as a child of Microsoft Excel. Under normal conditions, Excel primarily spawns internal Office-related processes, and the creation of ActiveMicrosoftApp is uncommon in day-to-day business workflows. Adversaries may abuse this behavior to blend malicious activity within trusted applications, execute unauthorized code, or bypass application control mechanisms.",Windows Events,"Initial Access, Execution, Persistence, Lateral Movement",T1021.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = ""EXCEL.EXE"" Processes.process_name IN (""WINPROJ.EXE"", ""FOXPROW.exe"",""SCHDPLUS.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_excel_activemicrosoftapp_child_process_filter`"
Windows Raw Access To Disk Volume Partition,"The following analytic detects suspicious raw access reads to the device disk partition of a host machine. It leverages Sysmon EventCode 9 logs to identify processes attempting to read or write to the boot sector, excluding legitimate system processes. This activity is significant as it is commonly associated with destructive actions by adversaries, such as wiping, encrypting, or overwriting the boot sector, as seen in attacks involving malware like HermeticWiper.",Windows Events,Impact,T1561.002,"`sysmon` EventCode=9 Device = \\Device\\HarddiskVolume* NOT (Image IN(""*\\Windows\\System32\\*"", ""*\\Windows\\SysWOW64\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Device Image 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_raw_access_to_disk_volume_partition_filter`"
Windows Raw Access To Master Boot Record Drive,"The following analytic detects suspicious raw access reads to the drive containing the Master Boot Record (MBR). It leverages Sysmon EventCode 9 to identify processes attempting to read or write to the MBR sector, excluding legitimate system processes. This activity is significant because adversaries often target the MBR to wipe, encrypt, or overwrite it as part of their impact payload.",Windows Events,Impact,T1561.002,"`sysmon` EventCode=9 Device = \\Device\\Harddisk0\\DR0 NOT (Image IN(""*\\Windows\\System32\\*"", ""*\\Windows\\SysWOW64\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Device Image 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_raw_access_to_master_boot_record_drive_filter`"
Linux Auditd Install Kernel Module Using Modprobe Utility,"The following analytic detects the installation of a Linux kernel module using the modprobe utility. It leverages data from Linux Auditd, focusing on process names and command-line executions. This activity is significant because installing a kernel module can indicate an attempt to deploy a rootkit or other malicious kernel-level code, potentially leading to elevated privileges and bypassing security detections.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"`linux_auditd` type=SYSCALL comm=modprobe 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_install_kernel_module_using_modprobe_utility_filter`"
Windows AD Replication Request Initiated by User Account,"The following analytic detects a user account initiating an Active Directory replication request, indicative of a DCSync attack. It leverages EventCode 4662 from the Windows Security Event Log, focusing on specific object types and replication permissions. This activity is significant because it can allow an attacker with sufficient privileges to request password hashes for any or all users within the domain.",Windows Events,"Persistence, Credential Access, Privilege Escalation",T1003.006,"`wineventlog_security` EventCode=4662 ObjectType IN (""%{19195a5b-6da0-11d0-afd3-00c04fd930c9}"",""domainDNS"") 
AND Properties IN (""*Replicating Directory Changes All*"",""*Manage Replication Topology*"",""*Remove Replica In Domain*"",""*{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}*"",""*{9923a32a-3607-11d2-b9be-0000f87a36b2}*"",""*{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}*"")
AND AccessMask=""0x100"" AND NOT (SubjectUserSid=""NT AUT*"" OR SubjectUserSid=""S-1-5-18"" OR SubjectDomainName=""Window Manager"" OR SubjectUserName=""*$"") 
| stats min(_time) as _time, count by SubjectDomainName, SubjectUserName, Computer, Logon_ID, ObjectName, ObjectServer, ObjectType, OperationType, status dest 
| rename SubjectDomainName as Target_Domain, SubjectUserName as user, Logon_ID as TargetLogonId, _time as attack_time 
| appendpipe 
[
| map search=""search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$"" 
| fields - status] 
| stats min(attack_time) as _time values(TargetUserSid) as TargetUserSid, values(Target_Domain) as Target_Domain, values(user) as user, values(Computer) as Computer, values(status) as status, values(src_category) as
src_category, values(src_ip) as src_ip values(action) as action values(authentication_method) as authentication_method values(dest) as dest values(signature) as signature values(signature_id) as signature_id by TargetLogonId 
| `windows_ad_replication_request_initiated_by_user_account_filter`"
Windows AD Replication Request Initiated from Unsanctioned Location,"The following analytic identifies unauthorized Active Directory replication requests initiated from non-domain controller locations. It leverages EventCode 4662 to detect when a computer account with replication permissions creates a handle to domainDNS, filtering out known domain controller IP addresses. This activity is significant as it may indicate a DCSync attack, where an attacker with privileged access can request password hashes for any or all users within the domain.",Windows Events,"Execution, Credential Access, Persistence",T1003.006,"`wineventlog_security` EventCode=4662 ObjectType IN (""%{19195a5b-6da0-11d0-afd3-00c04fd930c9}"",
""domainDNS"") AND Properties IN (""*Replicating Directory Changes All*"",""*Manage Replication Topology*"",""*Remove Replica In Domain*"",""*{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}*"",""*{9923a32a-3607-11d2-b9be-0000f87a36b2}*"",""*{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}*"")
AND AccessMask=""0x100"" AND (SubjectUserSid=""NT AUT*"" OR SubjectUserSid=""S-1-5-18""
OR SubjectDomainName=""Window Manager"" OR SubjectUserName=""*$"") 
| stats min(_time)
as attack_time, count by SubjectDomainName, SubjectUserName, Computer, Logon_ID, ObjectName, ObjectServer, ObjectType, OperationType, status 
| rename SubjectDomainName
as Target_Domain, SubjectUserName as user, Logon_ID as TargetLogonId 
| appendpipe 
[
| map search=""search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$""] 
| stats min(attack_time) as _time, values(TargetUserSid)
as TargetUserSid, values(Target_Domain) as Target_Domain, values(user) as user,
values(Computer) as Computer, values(status) as status, values(src_category) as
src_category, values(src_ip) as src_ip values(action) as action values(authentication_method) as authentication_method values(dest) as dest values(signature) as signature values(signature_id) as signature_id by TargetLogonId 
| search NOT src_category=""domain_controller""
| `windows_ad_replication_request_initiated_from_unsanctioned_location_filter`"
CHCP Command Execution,"The following analytic detects the execution of the chcp.com utility, which is used to change the active code page of the console. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events. This activity is significant because it can indicate the presence of malware, such as IcedID, which uses this technique to determine the locale region, language, or country of the compromised host.",Windows Events,"Execution, Exfiltration",T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=chcp.com by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `chcp_command_execution_filter`"
Remote Desktop Process Running On System,The following analytic detects the execution of the remote desktop process (mstsc.,Windows Events,"Execution, Lateral Movement, Privilege Escalation, Defense Evasion, Exfiltration",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=*mstsc.exe AND Processes.dest_category!=common_rdp_source by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| `remote_desktop_process_running_on_system_filter`"
Windows RDP File Execution,"The following analytic detects when a Windows RDP client attempts to execute an RDP file from a temporary directory, downloads directory, or Outlook directories. This detection is significant as it can indicate an attempt for an adversary to deliver a .rdp file, which may be leveraged by attackers to control or exfiltrate data. If confirmed malicious, this activity could lead to unauthorized access, data theft, or further lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1021.001, T1598.002","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""*\\AppData\\Local\\Temp\\*"", ""*\\Olk\\Attachments\\*"", ""*\\AppData\\Local\\Microsoft\\Outlook\\*"", ""*\\Content.Outlook\\*"", ""*\\Downloads\\*"") AND Processes.process=""*.rdp*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval execution_type=case( match(process, ""\\\\Temp\\\\.*\\.(zip
|7z
|rar
|cab
|tgz
|gz
|tar
|iso
|img
|vhd
|vhdx).*\\.*\\.rdp""), ""temp_archive_execution"", match(process, ""\\\\Downloads\\\\""), ""downloads_execution"", match(process, ""\\\\Temp\\\\""), ""temp_execution"", match(process, ""\\\\Microsoft\\\\Outlook\\\\""), ""outlook_execution"", match(process, ""\\\\Olk\\\\Attachments\\\\""), ""outlook_execution"", match(process, ""\\\\Content.Outlook\\\\""), ""outlook_execution"", true(), ""other"" ), risk_score=case( execution_type=""temp_archive_execution"", ""Critical"", execution_type IN (""temp_execution"", ""outlook_execution""), ""High"", execution_type=""downloads_execution"", ""Medium"", true(), ""Low"" ), risk_reason=case( execution_type=""temp_archive_execution"", ""RDP file executed directly from archive/disk image in Temp directory"", execution_type=""downloads_execution"", ""RDP file executed from Downloads directory (Could be legitimate admin activity)"", execution_type=""temp_execution"", ""RDP file executed from Temp directory"", execution_type=""outlook_execution"", ""RDP file executed from Outlook directories"", true(), ""Standard RDP file execution"" ) 
| sort - risk_score 
| rename process_name as ""RDP Process"", parent_process_name as ""Parent Process"", process as ""Command Line"", user as ""User"", execution_type as ""Execution Context"", risk_score as ""Risk Level"", risk_reason as ""Risk Details"" 
| fields - parent_process 
| `windows_rdp_file_execution_filter`"
Windows RDPClient Connection Sequence Events,"This analytic monitors Windows RDP client connection sequence events (EventCode 1024) from the Microsoft-Windows-TerminalServices-RDPClient/Operational log. These events track when RDP ClientActiveX initiates connection attempts to remote servers. The connection sequence is a critical phase of RDP where the client and server exchange settings and establish common parameters for the session. Monitoring these events can help identify unusual RDP connection patterns, potential lateral movement attempts, unauthorized remote access activity, and RDP connection chains that may indicate compromised systems.",Windows Events,"Initial Access, Execution, Lateral Movement, Defense Evasion",T1133,"`wineventlog_rdp` EventCode=1024 
| rename host as dest 
| stats count as ""Event Count"", min(_time) as firstTime, max(_time) as lastTime, values(Message) as messages by dest, source, LogName, EventCode, category 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rdpclient_connection_sequence_events_filter`"
Remote Desktop Network Traffic,"The following analytic detects unusual Remote Desktop Protocol (RDP) traffic on TCP/3389 by filtering out known RDP sources and destinations, focusing on atypical connections within the network. This detection leverages network traffic data to identify potentially unauthorized RDP access. Monitoring this activity is crucial for a SOC as unauthorized RDP access can indicate an attacker's attempt to control networked systems, leading to data theft, ransomware deployment, or further network compromise.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.dest_port=3389 AND All_Traffic.dest_category!=common_rdp_destination AND All_Traffic.src_category!=common_rdp_source AND All_Traffic.action=""allowed"" by All_Traffic.src All_Traffic.dest All_Traffic.dest_port All_Traffic.dest_ip All_Traffic.dvc All_Traffic.src_ip All_Traffic.src_port All_Traffic.vendor_product 
| `drop_dm_object_name(""All_Traffic"")` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `remote_desktop_network_traffic_filter`"
ESXi Firewall Disabled,"This detection identifies when the ESXi firewall is disabled or set to permissive mode, which can expose the host to unauthorized access and network-based attacks. Such changes are often a precursor to lateral movement, data exfiltration, or the installation of malicious software by a threat actor.
Search 1`esxi_syslog` Message=&#34;*network firewall set*&#34; AND Message=&#34;*enabled f*&#34; 2| rex field=_raw &#34;Z (?",VMware ESXi,"Lateral Movement, Exfiltration, Defense Evasion",T1562.004,"`esxi_syslog` Message=""*network firewall set*"" AND Message=""*enabled f*"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_firewall_disabled_filter`"
ESXi Malicious VIB Forced Install,"Detects potentially malicious installation of VMware Installation Bundles (VIBs) using the --force flag. The --force option bypasses signature and compatibility checks, allowing unsigned, community-supported, or incompatible VIBs to be installed on an ESXi host. This behavior is uncommon in normal administrative operations and is often observed in post-compromise scenarios where adversaries attempt to install backdoored or unauthorized kernel modules, drivers, or monitoring tools to establish persistence or gain deeper control of the hypervisor.",VMware ESXi,Persistence,T1505.006,"`esxi_syslog` Message=""* image profile with validation disabled. *"" OR Message=""* image profile bypassing signing and acceptance level verification. *"" OR Message=""* vib without valid signature, *"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_malicious_vib_forced_install_filter`"
ESXi Sensitive Files Accessed,"This detection identifies access to sensitive system and configuration files on an ESXi host, including authentication data, service configurations, and VMware-specific management settings. Interaction with these files may indicate adversary reconnaissance, credential harvesting, or preparation for privilege escalation, lateral movement, or persistence.
Search 1`esxi_syslog` Message=&#34;*shell[*&#34; Message IN (&#34;*/etc/shadow*&#34;,&#34;*/etc/vmware/hostd/hostd.xml*&#34;, &#34;*/etc/vmware/vpxa/vpxa.cfg*&#34;,&#34;*/etc/sfcb/sfcb.cfg*&#34;,&#34;*/etc/security/*&#34;, &#34;*/etc/likewise/krb5-affinity.conf*&#34;,&#34;*/etc/vmware-vpx/vcdb.properties*&#34;) 2| rex field=_raw &#34;\]: \[(?",VMware ESXi,"Credential Access, Lateral Movement, Persistence, Collection, Privilege Escalation","T1005, T1003.008","`esxi_syslog` Message=""*shell[*"" Message IN (""*/etc/shadow*"",""*/etc/vmware/hostd/hostd.xml*"", ""*/etc/vmware/vpxa/vpxa.cfg*"",""*/etc/sfcb/sfcb.cfg*"",""*/etc/security/*"", ""*/etc/likewise/krb5-affinity.conf*"",""*/etc/vmware-vpx/vcdb.properties*"") 
| rex field=_raw ""\]: \[(?<user>\w+)\]:(?<command>.+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_sensitive_files_accessed_filter`"
ESXi VIB Acceptance Level Tampering,"This detection identifies changes to the VIB (vSphere Installation Bundle) acceptance level on an ESXi host. Modifying the acceptance level, such as setting it to CommunitySupported, lowers the system's integrity enforcement and may allow the installation of unsigned or unverified software.
Search 1`esxi_syslog` Message=&#34;*esxcli software acceptance set*&#34; Message=&#34;*shell*&#34; 2| rex field=_raw &#34;\]: \[(?&lt;user&gt;\w+)\]:(?&lt;command&gt;.+)&#34; 3| rex field=_raw &#34;Z (?",VMware ESXi,"Discovery, Defense Evasion",T1562,"`esxi_syslog` Message=""*esxcli software acceptance set*"" Message=""*shell*"" 
| rex field=_raw ""\]: \[(?<user>\w+)\]:(?<command>.+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_vib_acceptance_level_tampering_filter`"
ESXi VM Discovery,"This detection identifies the use of ESXCLI commands to discover virtual machines on an ESXi host While used by administrators, this activity may also indicate adversary reconnaissance aimed at identifying high value targets, mapping the virtual environment, or preparing for data theft or destructive operations.
Search 1`esxi_syslog` Message=&#34;*esxcli vm process*&#34; Message=&#34;*list*&#34; 2| rex field=_raw &#34;\]: \[(?",VMware ESXi,"Execution, Discovery",T1673,"`esxi_syslog` Message=""*esxcli vm process*"" Message=""*list*"" 
| rex field=_raw ""\]: \[(?<user>\w+)\]:(?<command>.+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_vm_discovery_filter`"
Windows Advanced Installer MSIX with AI_STUBS Execution,"The following analytic identifies the execution of Advanced Installer MSIX Package Support Framework (PSF) components, specifically the AI_STUBS executables with the original filename 'popupwrapper.exe'. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process paths and original filenames. This activity is significant as adversaries have been observed packaging malicious content within MSIX files built with Advanced Installer to bypass security controls.",Windows Events,"Discovery, Execution, Persistence, Defense Evasion","T1553.005, T1218, T1204.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path IN (""*\\AI_STUBS\\AiStubX64Elevated.exe"", ""*\\AI_STUBS\\AiStubX86Elevated.exe"", ""*\\AI_STUBS\\AiStubX64.exe"", ""*\\AI_STUBS\\AiStubX86.exe"") AND Processes.original_file_name=""popupwrapper.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_advanced_installer_msix_with_ai_stubs_execution_filter`"
Windows AppX Deployment Full Trust Package Installation,"The following analytic detects the installation of MSIX/AppX packages with full trust privileges. This detection leverages Windows event logs from the AppXDeployment-Server, specifically focusing on EventCode 400 which indicates a package deployment operation. Full trust packages are significant as they run with elevated privileges outside the normal AppX container restrictions, allowing them to access system resources that regular AppX packages cannot.",Windows Events,"Collection, Execution, Persistence, Defense Evasion","T1553, T1553.005, T1204.002","`wineventlog_appxdeploymentserver` EventCode=400 HasFullTrust=""true"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(PackageFullName) as PackageFullName values(Path) as PackagePath values(PackageSourceUri) as PackageSourceUri values(PackageDisplayName) as PackageDisplayName values(CallingProcess) as CallingProcess values(IsCentennial) as IsCentennial by dvc EventCode HasFullTrust user_id 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_appx_deployment_full_trust_package_installation_filter`"
Windows AppX Deployment Package Installation Success,"This analytic detects successful MSIX/AppX package installations on Windows systems by monitoring EventID 854 in the Microsoft-Windows-AppXDeployment-Server/Operational log. This event is generated when an MSIX/AppX package has been successfully installed on a system. While most package installations are legitimate, monitoring these events can help identify unauthorized or suspicious package installations, especially when correlated with other events such as unsigned package installations (EventID 603 with Flags=8388608) or full trust package installations (EventID 400 with HasFullTrust=true).",Windows Events,Execution,T1204.002,"`wineventlog_appxdeploymentserver` EventCode=854 
| stats count min(_time) as firstTime max(_time) as lastTime values(Path) as PackagePath by dvc EventCode user_id 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_appx_deployment_package_installation_success_filter`"
Windows AppX Deployment Unsigned Package Installation,"The following analytic detects attempts to install unsigned MSIX/AppX packages using the -AllowUnsigned parameter. This detection leverages Windows event logs from the AppXDeployment-Server, specifically focusing on EventID 603 which indicates the start of a deployment operation with specific deployment flags. The flag value 8388608 corresponds to the -AllowUnsigned option in PowerShell's Add-AppxPackage cmdlet. This activity is significant as adversaries have been observed leveraging unsigned MSIX packages to deliver malware, bypassing signature verification that would normally protect users from malicious packages.",Windows Events,"Collection, Execution, Persistence, Defense Evasion","T1553, T1553.005, T1204.002","`wineventlog_appxdeploymentserver` EventCode=603 Flags=""8388608"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(Path) as file_name values(CallingProcess) as CallingProcess by dvc EventCode Flags user_id 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_appx_deployment_unsigned_package_installation_filter`"
Windows Developer-Signed MSIX Package Installation,"This detection identifies the installation of developer-signed MSIX packages that lack Microsoft Store signatures. All malicious MSIX packages observed in recent threat campaigns (including those from FIN7, Zloader/Storm-0569, and FakeBat/Storm-1113) were developer-signed rather than Microsoft Store signed. Microsoft Store apps have specific publisher IDs containing '8wekyb3d8bbwe' or 'cw5n1h2txyewy', while developer-signed packages lack these identifiers.",Windows Events,"Collection, Execution, Defense Evasion","T1553.005, T1204.002","`wineventlog_appxdeploymentserver` EventCode=855 NOT PackageMoniker IN (""*8wekyb3d8bbwe*"",""*cw5n1h2txyewy*"") 
| stats count min(_time) as firstTime max(_time) as lastTime values(PackageMoniker) as PackageMoniker by dvc EventCode user_id 
| rename dvc as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_developer_signed_msix_package_installation_filter`"
Windows MSIX Package Interaction,"This hunting query detects user interactions with MSIX packages by monitoring EventCode 171 in the Microsoft-Windows-AppXPackaging/Operational logs. These events are generated when a user clicks on or attempts to interact with an MSIX package, even if the package is not fully installed. This information can be valuable for security teams to identify what MSIX packages users are attempting to open in their environment, which may help detect malicious MSIX packages before they're fully installed.",Windows Events,"Collection, Execution",T1204.002,"`wineventlog_appxpackaging` EventCode=171 
| stats count min(_time) as firstTime max(_time) as lastTime values(packageFullName) as packageFullName values(user_id) as user_id by host EventCode 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msix_package_interaction_filter`"
Windows PowerShell Script From WindowsApps Directory,"The following analytic identifies the execution of PowerShell scripts from the WindowsApps directory, which is a common technique used in malicious MSIX package execution. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command lines and parent process paths. This activity is significant as adversaries have been observed using MSIX packages with embedded PowerShell scripts (particularly StartingScriptWrapper.",Windows Events,"Execution, Persistence","T1059.001, T1204.002, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_name=""powershell.exe"" AND (Processes.parent_process_path=""*\\WindowsApps\\*"" OR Processes.process=""*WindowsApps*-file *"" OR Processes.process=""*WindowsApps*.ps1*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_script_from_windowsapps_directory_filter`"
Linux Gdrive Binary Activity,"The following analytic detects the execution of the 'gdrive' tool on a Linux host. This tool allows standard users to perform tasks associated with Google Drive via the command line. This is used by actors to stage tools as well as exfiltrate data. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions.",Linux,"Execution, Exfiltration",T1567,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""gdrive"" Processes.process IN  (""* download *"", ""* upload *"", ""* list*"", ""* update *"", ""* sync *"", ""* share *"", ""* account add*"", ""* drives *"", ""* files *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_gdrive_binary_activity_filter`"
Windows Gdrive Binary Activity,"The following analytic detects the execution of the 'gdrive' tool on a Windows host. This tool allows standard users to perform tasks associated with Google Drive via the command line. This is used by actors to stage tools as well as exfiltrate data. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions.",Windows Events,"Execution, Exfiltration",T1567,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""gdrive.exe"" OR Processes.original_file_name=""*gdrive.exe"") Processes.process IN  (""* download *"", ""* upload *"", ""* list*"", ""* update *"", ""* sync *"", ""* share *"", ""* account add*"", ""* drives *"", ""* files *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_gdrive_binary_activity_filter`"
Windows Modify Registry Disable RDP,"This analytic is developed to detect suspicious registry modifications that disable Remote Desktop Protocol (RDP) by altering the &quot;fDenyTSConnections&quot; key. Changing this key's value to 1 prevents remote connections, which can disrupt remote management and access. Such modifications could indicate an attempt to hinder remote administration or isolate the system from remote intervention, potentially signifying malicious activity.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Control\\Terminal Server\\fDenyTSConnections*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disable_rdp_filter`"
Windows MSTSC RDP Commandline,"The following analytic detects the use of the mstsc.exe command-line, which is commonly used to initiate Remote Desktop Protocol (RDP) connections. This detection focuses on instances where mstsc.exe is executed with specific parameters that may indicate suspicious or unauthorized remote access attempts. Monitoring command-line arguments such as /v: for direct connections or /admin for administrative sessions can help identify potential misuse or lateral movement within a network.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""mstsc.exe"" Processes.process = ""*/v:*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_mstsc_rdp_commandline_filter`"
Windows RDP Client Launched with Admin Session,"This detection identifies the execution of the Windows Remote Desktop Client (mstsc.exe) with the &quot;/v&quot; and /admin command-line arguments. The &quot;/v&quot; flag specifies the remote host to connect to, while the /admin flag initiates a connection to the target systemâ€™s console session, often used for administrative purposes. This combination may indicate that a user or attacker is performing privileged remote access, potentially to manage a system without disrupting existing user sessions.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""mstsc.exe"" Processes.process = ""*/v:*"" Processes.process = ""*/admin*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rdp_client_launched_with_admin_session_filter`"
Windows Remote Services Allow Rdp In Firewall,"The following analytic detects modifications to the Windows firewall to enable Remote Desktop Protocol (RDP) on a targeted machine. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;netsh.exe&quot; to allow TCP port 3389. This activity is significant as it may indicate an adversary attempting to gain remote access to a compromised host, a common tactic for lateral movement.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` values(Processes.process) as cmdline values(Processes.parent_process_name) as parent_process values(Processes.process_name) count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = ""netsh.exe"" OR Processes.original_file_name= ""netsh.exe"") AND Processes.process = ""*firewall*"" AND Processes.process = ""*add*"" AND Processes.process = ""*protocol=TCP*"" AND Processes.process = ""*localport=3389*"" AND Processes.process = ""*action=allow*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_services_allow_rdp_in_firewall_filter`"
Windows Remote Services Rdp Enable,"The following analytic detects modifications in the Windows registry to enable Remote Desktop Protocol (RDP) on a targeted machine. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the &quot;fDenyTSConnections&quot; registry value. This activity is significant as enabling RDP via registry is uncommon and often associated with adversaries or malware attempting to gain remote access.",Windows Events,"Lateral Movement, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Control\\Terminal Server\\fDenyTSConnections*"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_services_rdp_enable_filter`"
Windows Service Create with Tscon,"The following analytic detects potential RDP Hijacking attempts by identifying the creation of a Windows service using sc.exe with a binary path that includes tscon.exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line arguments. This activity is significant as it indicates an attacker may be trying to hijack a disconnected RDP session, posing a risk of unauthorized access.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Defense Evasion","T1563.002, T1543.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=sc.exe Processes.process=""*/dest:rdp-tcp*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_create_with_tscon_filter`"
Windows Remote Desktop Network Bruteforce Attempt,The following analytic identifies potential Remote Desktop Protocol (RDP) brute force attacks by monitoring network traffic for RDP application activity. This query detects potential RDP brute force attacks by identifying source IPs that have made more than 10 connection attempts to the same RDP port on a host within a one-hour window.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Credential Access, Defense Evasion",T1110.001,"| tstats `security_content_summariesonly` count, min(_time) as firstTime, max(_time) as lastTime values(Al_Traffic.src_port) as src_port from datamodel=Network_Traffic where (All_Traffic.app=rdp OR All_Traffic.dest_port=3389)   by All_Traffic.action All_Traffic.app All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.direction  All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip  All_Traffic.transport All_Traffic.user All_Traffic.vendor_product 
| `drop_dm_object_name(""All_Traffic"")`  
| eval duration=lastTime-firstTime  
| where count > 10 AND duration < 3600  
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)`  
| `windows_remote_desktop_network_bruteforce_attempt_filter`"
Azure AD Multiple Denied MFA Requests For User,"The following analytic detects an unusually high number of denied Multi-Factor Authentication (MFA) requests for a single user within a 10-minute window, specifically when more than nine MFA prompts are declined. It leverages Azure Active Directory (Azure AD) sign-in logs, focusing on &quot;Sign-in activity&quot; events with error code 500121 and additional details indicating &quot;MFA denied; user declined the authentication.",Azure AD (Microsoft Entra ID),"Lateral Movement, Credential Access, Exfiltration","T1621, T1078","`azure_monitor_aad` category=SignInLogs operationName=""Sign-in activity"" 
| rename properties.* as * 
| search status.errorCode=500121 status.additionalDetails=""MFA denied; user declined the authentication"" 
| bucket span=10m _time 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(user_agent) as user_agent values(src) as src by user status.additionalDetails vendor_account vendor_product signature _time 
| where count > 9 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_denied_mfa_requests_for_user_filter`"
Windows Audit Policy Auditing Option Modified - Registry,"The following analytic detects potentially suspicious modifications to the Audit Policy auditing options registry values. It leverages data from the Endpoint.Registry data model, focusing on changes to one of the following auditing option values &quot;CrashOnAuditFail&quot;, &quot;FullPrivilegeAuditing&quot;, &quot;AuditBaseObjects&quot; and &quot;AuditBaseDirectories&quot; within the &quot;HKLM\System\CurrentControlSet\Control\Lsa\&quot; registry key. This activity is significant as it could be a sign of a threat actor trying to tamper with the audit policy configuration, and disabling SACLs configuration.",Windows Events,"Lateral Movement, Persistence",T1547.014,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\Control\\Lsa*"" Registry.registry_value_name IN (""CrashOnAuditFail"", ""FullPrivilegeAuditing"", ""AuditBaseObjects"", ""AuditBaseDirectories"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_auditing_option_modified___registry_filter`"
Windows Impair Defense Overide Win Defender Phishing Filter,"The following analytic detects modifications to the Windows registry that disable the Windows Defender phishing filter. It leverages data from the Endpoint.Registry data model, focusing on changes to specific registry values related to Microsoft Edge's phishing filter settings. This activity is significant because disabling the phishing filter can allow attackers to deceive users into visiting malicious websites without triggering browser warnings.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path = ""*\\MicrosoftEdge\\PhishingFilter*"" Registry.registry_value_name IN (""EnabledV9"", ""PreventOverride"") Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_overide_win_defender_phishing_filter_filter`"
Windows Phishing Recent ISO Exec Registry,"The following analytic detects the creation of registry artifacts when an ISO container is opened, clicked, or mounted on a Windows operating system. It leverages data from the Endpoint.Registry data model, specifically monitoring registry keys related to recent ISO or IMG file executions. This activity is significant as adversaries increasingly use container-based phishing campaigns to bypass macro-based document execution controls.",Windows Events,"Initial Access, Execution, Persistence, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\\.iso*"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\\.img*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_phishing_recent_iso_exec_registry_filter`"
Windows Rdp AutomaticDestinations Deletion,"This detection identifies the deletion of files within the AutomaticDestinations folder, located under a userâ€™s AppData\Roaming\Microsoft\Windows\Recent directory. These files are part of the Windows Jump List feature, which records recently accessed files and folders tied to specific applications. Each .automaticDestinations-ms file corresponds to a program (e.g., Explorer, Word, Notepad) and can be valuable for forensic analysis of user activity.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion",T1070.004,"`sysmon` EventCode=23 TargetFilename IN (""*\\Recent\\AutomaticDestinations*"") 
| stats count min(_time) as firstTime, max(_time) as lastTime by action dest dvc file_path file_hash file_name file_modify_time process_exec process_guid process_id process_name process_path signature signature_id user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rdp_automaticdestinations_deletion_filter`"
Windows RDP Bitmap Cache File Creation,"This detection identifies the creation of Remote Desktop Protocol (RDP) bitmap cache files on a Windows system, typically located in the userâ€™s profile under the Terminal Server Client cache directory. These files (.bmc, cache.bin) are generated when a user initiates an RDP session using the built-in mstsc.exe client. Their presence can indicate interactive remote access activity and may be useful in detecting lateral movement or unauthorized RDP usage.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\Terminal Server Client\\Cache\\*.bmc"", ""*\\Terminal Server Client\\Cache\\cache*.bin"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
|`drop_dm_object_name(Filesystem)` 
| `windows_rdp_bitmap_cache_file_creation_filter`"
Windows RDP Cache File Deletion,This detection identifies the deletion of RDP bitmap cache filesâ€”specifically .bmc and .bin filesâ€”typically stored in the user profile under the Terminal Server Client\Cache directory. These files are created by the native Windows Remote Desktop Client (mstsc.exe) and store graphical elements from remote sessions to improve performance. Deleting these files may indicate an attempt to remove forensic evidence of RDP usage.,Windows Events,"Lateral Movement, Execution, Defense Evasion",T1070.004,"`sysmon` EventCode IN (""23"", ""26"") TargetFilename IN (""*\\Terminal Server Client\\Cache\\*.bmc"", ""*\\Terminal Server Client\\Cache\\cache*.bin"") 
| stats count min(_time) as firstTime, max(_time) as lastTime by action dest dvc file_path file_hash file_name file_modify_time process_exec process_guid process_id process_name process_path signature signature_id user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rdp_cache_file_deletion_filter`"
Windows RDP Server Registry Deletion,"This detection identifies the deletion of registry keys under HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers, which store records of previously connected remote systems via Remote Desktop Protocol (RDP). These keys are created automatically when a user connects to a remote host using the native Windows RDP client (mstsc.exe) and can be valuable forensic artifacts for tracking remote access activity.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1070.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\Microsoft\\Terminal Server Client\\Servers\\*"" Registry.action = deleted by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_rdp_server_registry_deletion_filter`"
Windows RDP Server Registry Entry Created,"This detection identifies the creation of registry keys under HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers, which occur when a user initiates a Remote Desktop Protocol (RDP) connection using the built-in Windows RDP client (mstsc.exe). These registry entries store information about previously connected remote hosts, including usernames and display settings. Their creation is a strong indicator that an outbound RDP session was initiated from the system.",Windows Events,"Lateral Movement, Defense Evasion",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\Microsoft\\Terminal Server Client\\Servers\\*"" Registry.action != deleted by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_rdp_server_registry_entry_created_filter`"
Windows Suspicious VMWare Tools Child Process,"The following analytic identifies child processes spawned by vmtoolsd.exe, the VMWare Tools service in Windows, which typically runs with SYSTEM privileges. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. Monitoring this activity is crucial as it can indicate exploitation attempts, such as CVE-2023-20867. If confirmed malicious, attackers could gain SYSTEM-level access, allowing them to execute arbitrary code, escalate privileges, and potentially compromise the entire system.",Windows Events,Execution,T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=vmtoolsd.exe AND Processes.process_name IN (""powershell.exe"",""cmd.exe"", ""msbuild.exe"", ""microsoft.workflow.compiler.exe"", ""searchprotocolhost.exe"", ""scrcons.exe"", ""cscript.exe"", ""wscript.exe"",""bitsadmin.exe"", ""rundll32.exe"", ""wmic.exe"", ""mshta.exe"", ""certutil.exe"", ""schtasks.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_suspicious_vmware_tools_child_process_filter`"
Attacker Tools On Endpoint,"The following analytic detects the execution of tools commonly exploited by cybercriminals, such as those used for unauthorized access, network scanning, or data exfiltration. It leverages process activity data from Endpoint Detection and Response (EDR) agents, focusing on known attacker tool names. This activity is significant because it serves as an early warning system for potential security incidents, enabling prompt response.",Windows Events,"Exfiltration, Execution, Credential Access, Defense Evasion","T1003, T1595, T1036.005","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process) as process values(Processes.parent_process) as parent_process from datamodel=Endpoint.Processes where [
| inputlookup attacker_tools 
| rename attacker_tool_names AS Processes.process_name 
| fields Processes.process_name] AND Processes.dest!=unknown AND Processes.user!=unknown by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| lookup attacker_tools attacker_tool_names AS process_name OUTPUT description 
| search description !=false
| `attacker_tools_on_endpoint_filter`"
Clear Unallocated Sector Using Cipher App,"The following analytic detects the execution of cipher.exe with the /w flag to clear unallocated sectors on a disk. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line arguments, and parent processes. This activity is significant because it is a technique used by ransomware to prevent forensic recovery of deleted files.",Windows Events,"Execution, Defense Evasion",T1070.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""cipher.exe"" Processes.process = ""*/w:*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `clear_unallocated_sector_using_cipher_app_filter`"
Exchange PowerShell Module Usage,"The following analytic detects the usage of specific Exchange PowerShell modules, such as New-MailboxExportRequest, New-ManagementRoleAssignment, New-MailboxSearch, and Get-Recipient. It leverages PowerShell Script Block Logging (EventCode 4104) to identify these commands. This activity is significant because these modules can be exploited by adversaries who have gained access via ProxyShell or ProxyNotShell vulnerabilities. If confirmed malicious, attackers could export mailbox contents, assign management roles, conduct mailbox searches, or view recipient objects, potentially leading to data exfiltration, privilege escalation, or unauthorized access to sensitive information.",Windows Events,"Execution, Privilege Escalation, Exfiltration",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*New-MailboxExportRequest*"", ""*New-ManagementRoleAssignment*"", ""*New-MailboxSearch*"", ""*Get-Recipient*"", ""Search-Mailbox"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `exchange_powershell_module_usage_filter`"
Recon Using WMI Class,"The following analytic detects suspicious PowerShell activity via EventCode 4104, where WMI performs event queries to gather information on running processes or services. This detection leverages PowerShell Script Block Logging to identify specific WMI queries targeting system information classes like Win32_Bios and Win32_OperatingSystem. This activity is significant as it often indicates reconnaissance efforts by an adversary to profile the compromised machine.",Windows Events,"Lateral Movement, Execution","T1059.001, T1592","`powershell` EventCode=4104 AND ScriptBlockText IN (""*SELECT*"", ""*Get-WmiObject*"") AND ScriptBlockText IN (""*Win32_Bios*"", ""*Win32_OperatingSystem*"", ""*Win32_Processor*"", ""*Win32_ComputerSystem*"", ""*Win32_PnPEntity*"", ""*Win32_ShadowCopy*"", ""*Win32_DiskDrive*"", ""*Win32_PhysicalMemory*"", ""*Win32_BaseBoard*"", ""*Win32_DisplayConfiguration*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `recon_using_wmi_class_filter`"
Sc exe Manipulating Windows Services,"The following analytic detects the creation or modification of Windows services using the sc.exe command. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because manipulating Windows services can be a method for attackers to establish persistence, escalate privileges, or execute arbitrary code.",Windows Events,"Execution, Persistence",T1543.003,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=""* create *"" OR Processes.process=""* config *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `sc_exe_manipulating_windows_services_filter`"
Script Execution via WMI,"The following analytic detects the execution of scripts via Windows Management Instrumentation (WMI) by monitoring the process 'scrcons.exe'. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events. WMI-based script execution is significant because adversaries often use it to perform malicious activities stealthily, such as system compromise, data exfiltration, or establishing persistence.",Windows Events,"Execution, Persistence, Exfiltration",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=scrcons.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `script_execution_via_wmi_filter`"
Windows Mimikatz Binary Execution,"The following analytic identifies the execution of the native mimikatz.exe binary on Windows systems, including instances where the binary is renamed. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names. This activity is significant because Mimikatz is a widely used tool for extracting authentication credentials, posing a severe security risk.",Windows Events,"Execution, Credential Access",T1003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=mimikatz.exe OR Processes.original_file_name=mimikatz.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_mimikatz_binary_execution_filter`"
Windows MSExchange Management Mailbox Cmdlet Usage,"The following analytic identifies suspicious Cmdlet usage in Exchange Management logs, focusing on commands like New-MailboxExportRequest and New-ManagementRoleAssignment. It leverages EventCode 1 and specific Message patterns to detect potential ProxyShell and ProxyNotShell abuse. This activity is significant as it may indicate unauthorized access or manipulation of mailboxes and roles, which are critical for maintaining email security.",Windows Events,"Execution, Privilege Escalation",T1059.001,"`msexchange_management` EventCode=1 Message IN (""*New-MailboxExportRequest*"", ""*New-ManagementRoleAssignment*"", ""*New-MailboxSearch*"", ""*Get-Recipient*"", ""*Search-Mailbox*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by host Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| rename host AS dest 
| `windows_msexchange_management_mailbox_cmdlet_usage_filter`"
Windows PowerShell ScheduleTask,"The following analytic detects potential malicious activities involving PowerShell's task scheduling cmdlets. It leverages PowerShell Script Block Logging (EventCode 4104) to identify unusual or suspicious use of cmdlets like 'New-ScheduledTask' and 'Set-ScheduledTask'. This activity is significant as attackers often use these cmdlets for persistence and remote execution of malicious code. If confirmed malicious, this could allow attackers to maintain access, deliver additional payloads, or execute ransomware, leading to data theft or other severe impacts.",Windows Events,"Discovery, Execution, Impact, Persistence","T1053.005, T1059.001","`powershell` EventCode=4104 ScriptBlockText IN (""*New-ScheduledTask*"", ""*New-ScheduledTaskAction*"", ""*New-ScheduledTaskSettingsSet*"", ""*New-ScheduledTaskTrigger*"", ""*Register-ClusteredScheduledTask*"", ""*Register-ScheduledTask*"", ""*Set-ClusteredScheduledTask*"", ""*Set-ScheduledTask*"", ""*Start-ScheduledTask*"", ""*Enable-ScheduledTask*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_scheduletask_filter`"
Disabled Kerberos Pre-Authentication Discovery With Get-ADUser,The following analytic detects the execution of the Get-ADUser PowerShell cmdlet with parameters indicating a search for domain accounts with Kerberos Pre-Authentication disabled. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this specific activity. This behavior is significant because discovering accounts with Kerberos Pre-Authentication disabled can allow adversaries to perform offline password cracking.,Windows Events,"Execution, Credential Access, Discovery","T1558.004, T1558","`powershell` EventCode=4104 (ScriptBlockText = ""*Get-ADUser*"" AND ScriptBlockText=""*4194304*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabled_kerberos_pre_authentication_discovery_with_get_aduser_filter`"
Disabled Kerberos Pre-Authentication Discovery With PowerView,"The following analytic detects the execution of the Get-DomainUser commandlet with the -PreauthNotRequired parameter using PowerShell Script Block Logging (EventCode=4104). This command is part of PowerView, a tool used for enumerating Windows Active Directory networks. Identifying domain accounts with Kerberos Pre-Authentication disabled is significant because adversaries can leverage this information to attempt offline password cracking.",Windows Events,"Execution, Credential Access, Discovery","T1558.004, T1558","`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainUser*"" AND ScriptBlockText=""*PreauthNotRequired*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabled_kerberos_pre_authentication_discovery_with_powerview_filter`"
Domain Account Discovery with Wmic,"The following analytic detects the execution of wmic.exe with command-line arguments used to query for domain users. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns indicative of domain account discovery. This activity is significant as it often precedes lateral movement or privilege escalation attempts by adversaries.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.002, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""wmic.exe"" AND Processes.process = ""*/NAMESPACE:\\\\root\\directory\\ldap*"" AND Processes.process = ""*ds_user*"" AND Processes.process = ""*GET*"" AND Processes.process = ""*ds_samaccountname*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_account_discovery_with_wmic_filter`"
Network Connection Discovery With Arp,"The following analytic detects the execution of arp.exe with the -a flag, which is used to list network connections on a compromised system. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line executions, and related telemetry. Monitoring this activity is significant because both Red Teams and adversaries use arp.",Windows Events,"Lateral Movement, Execution, Discovery",T1049,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""arp.exe"") (Processes.process=*-a*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `network_connection_discovery_with_arp_filter`"
Windows AD ServicePrincipalName Added To Domain Account,"The following analytic detects the addition of a Service Principal Name (SPN) to a domain account. It leverages Windows Event Code 5136 and monitors changes to the servicePrincipalName attribute. This activity is significant because it may indicate an attempt to perform Kerberoasting, a technique where attackers extract and crack service account passwords offline. If confirmed malicious, this could allow an attacker to obtain cleartext passwords, leading to unauthorized access and potential lateral movement within the domain environment.",Windows Events,"Lateral Movement, Persistence, Discovery",T1098,"`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=servicePrincipalName OperationType=""%%14674"" ObjectClass=user 
| stats values(ObjectDN) as ObjectDN by _time, Computer, SubjectUserName, AttributeValue 
| rex field=ObjectDN ""^CN=(?P<user>[a-zA-Z0-9!#$%&'@^_{}~.-]+),"" 
| rename Computer as dest, SubjectUserName as src_user  
| `windows_ad_serviceprincipalname_added_to_domain_account_filter`"
Windows AD Short Lived Domain Account ServicePrincipalName,"The following analytic identifies the addition and quick deletion of a Service Principal Name (SPN) to a domain account within 5 minutes. This detection leverages EventCode 5136 from the Windows Security Event Log, focusing on changes to the servicePrincipalName attribute. This activity is significant as it may indicate an attempt to perform Kerberoasting, a technique used to crack the cleartext password of a domain account offline.",Windows Events,Persistence,T1098,"`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=servicePrincipalName 
| transaction ObjectDN AttributeValue startswith=(EventCode=5136 OperationType=""%%14674"") endswith=(EventCode=5136 OperationType=""%%14675"") 
| eval short_lived=case((duration<300),""TRUE"") 
| search short_lived = TRUE 
| rename ObjectDN as user 
| rename Computer as dest 
| `windows_ad_short_lived_domain_account_serviceprincipalname_filter`"
Windows PowerView SPN Discovery,"The following analytic detects the execution of the Get-DomainUser or Get-NetUser PowerShell cmdlets with the -SPN parameter, indicating the use of PowerView for SPN discovery. It leverages PowerShell Script Block Logging (EventCode=4104) to identify these specific commands. This activity is significant as it suggests an attempt to enumerate domain accounts associated with Service Principal Names (SPNs), a common precursor to Kerberoasting attacks.",Windows Events,"Discovery, Execution, Credential Access, Privilege Escalation","T1558.003, T1558","`powershell` EventCode=4104 (ScriptBlockText =*Get-NetUser* OR ScriptBlockText=*Get-DomainUser*) ScriptBlockText= *-SPN* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_powerview_spn_discovery_filter`"
Windows Multi hop Proxy TOR Website Query,"The following analytic identifies DNS queries to known TOR proxy websites, such as &quot;*.torproject.org&quot; and &quot;www.theonionrouter.com&quot;. It leverages Sysmon EventCode 22 to detect these queries by monitoring DNS query events from endpoints. This activity is significant because adversaries often use TOR proxies to disguise the source of their malicious traffic, making it harder to trace their actions.",Windows Events,"Command And Control, Discovery",T1071.003,"`sysmon` EventCode=22 QueryName IN (""*.torproject.org"", ""www.theonionrouter.com"") 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_multi_hop_proxy_tor_website_query_filter`"
O365 BEC Email Hiding Rule Created,"This analytic detects mailbox rule creation, a common technique used in Business Email Compromise. It uses a scoring mechanism to identify a combination of attributes often featured in mailbox rules created by attackers. This may indicate that an attacker has gained access to the account.
Search 1`o365_management_activity` Workload=Exchange Operation IN (&#34;New-InboxRule&#34;, &#34;Set-InboxRule&#34;) 2 3| stats min(_time) as firstTime, max(_time) as lastTime, values(Operation) as Operation, latest(Name) as Name, latest(MarkAsRead) as MarkAsRead, latest(MoveToFolder) as MoveToFolder by object_id user 4 5| `security_content_ctime(firstTime)` 6 7| `security_content_ctime(lastTime)` 8 9| lookup ut_shannon_lookup word as Name 10 11| eval entropy_score=if(ut_shannon&lt;=2, 1, 0) 12 13| eval len_score=if(len(Name)&lt;=3, 1,0) 14 15| eval read_score=if(MarkAsRead=&#34;True&#34;, 1, 0) 16 17| eval folder_score=if(match(MoveToFolder, &#34;^(RSS 18|Conversation History 19|Archive)&#34;), 1, 0) 20 21| eval suspicious_score=entropy_score+len_score+read_score+folder_score 22 23| where suspicious_score&gt;2 24 25| `o365_bec_email_hiding_rule_created_filter` Data Source No data sources specified for this detection.",Office 365 (Microsoft 365),"Discovery, Defense Evasion","T1564, T1564.008","`o365_management_activity` Workload=Exchange Operation IN (""New-InboxRule"", ""Set-InboxRule"")
| stats min(_time) as firstTime, max(_time) as lastTime, values(Operation) as Operation, latest(Name) as Name, latest(MarkAsRead) as MarkAsRead, latest(MoveToFolder) as MoveToFolder by object_id user 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| lookup ut_shannon_lookup word as Name 
| eval entropy_score=if(ut_shannon<=2, 1, 0) 
| eval len_score=if(len(Name)<=3, 1,0) 
| eval read_score=if(MarkAsRead=""True"", 1, 0) 
| eval folder_score=if(match(MoveToFolder, ""^(RSS
|Conversation History
|Archive)""), 1, 0) 
| eval suspicious_score=entropy_score+len_score+read_score+folder_score 
| where suspicious_score>2 
| `o365_bec_email_hiding_rule_created_filter`"
Windows SharePoint Spinstall0 Webshell File Creation,"This detection identifies the creation or modification of the &quot;spinstall0.aspx&quot; webshell file in Microsoft SharePoint directories. This file is a known indicator of compromise associated with the exploitation of CVE-2025-53770 (ToolShell vulnerability). Attackers exploit the vulnerability to drop webshells that provide persistent access to compromised SharePoint servers, allowing them to execute arbitrary commands, access sensitive data, and move laterally within the network.",Windows Events,"Initial Access, Persistence","T1190, T1505.003","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name=""spinstall0.aspx"" AND (Filesystem.file_path=""*\\microsoft shared\\Web Server Extensions\\16\\TEMPLATE\\LAYOUTS*"" OR Filesystem.file_path=""*\\microsoft shared\\Web Server Extensions\\15\\TEMPLATE\\LAYOUTS*"") by Filesystem.dest Filesystem.user Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.action Filesystem.process_guid Filesystem.process_id Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sharepoint_spinstall0_webshell_file_creation_filter`"
Windows SharePoint Spinstall0 GET Request,"The following analytic detects potential post-exploitation activity related to the Microsoft SharePoint CVE-2025-53770 vulnerability. After successful exploitation via the ToolPane.aspx endpoint, attackers typically deploy a webshell named &quot;spinstall0.aspx&quot; in the SharePoint layouts directory. This detection identifies GET requests to this webshell, which indicates active use of the backdoor for command execution, data exfiltration, or credential/key extraction.",Zscaler Proxy,"Initial Access, Execution, Credential Access, Persistence, Exfiltration","T1190, T1552, T1505.003","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/_layouts/15/spinstall0.aspx*"" Web.http_method=""GET"" by Web.url Web.src Web.dest Web.status Web.http_user_agent Web.url_length sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sharepoint_spinstall0_get_request_filter`"
Windows SharePoint ToolPane Endpoint Exploitation Attempt,"The following analytic detects potential exploitation attempts against Microsoft SharePoint Server vulnerability CVE-2025-53770, also known as &quot;ToolShell&quot;. This detection monitors for POST requests to the ToolPane.aspx endpoint with specific DisplayMode parameter, which is a key indicator of the exploit. This vulnerability allows unauthenticated remote code execution on affected SharePoint servers, enabling attackers to fully access SharePoint content, file systems, internal configurations, and execute code over the network.",Zscaler Proxy,"Initial Access, Execution, Persistence","T1190, T1505.003","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/_layouts/15/ToolPane.aspx*"" AND Web.url=""*DisplayMode=Edit*"" Web.http_method=POST by Web.http_user_agent, Web.status, Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sharepoint_toolpane_endpoint_exploitation_attempt_filter`"
Ping Sleep Batch Command,"The following analytic identifies the execution of ping sleep batch commands. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process command-line details. This activity is significant as it indicates an attempt to delay malicious code execution, potentially evading detection or sandbox analysis. If confirmed malicious, this technique allows attackers to bypass security measures, making it harder to detect and analyze their activities, thereby increasing the risk of prolonged unauthorized access and potential data exfiltration.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1497.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where ( Processes.parent_process= ""*ping*"" Processes.parent_process = *-n* Processes.parent_process=""* Nul*"" Processes.parent_process IN (""*&gt;*"", ""*>*"") Processes.parent_process IN (""*&amp;*"", ""*& *"") ) OR ( Processes.process = ""*ping*"" Processes.process = *-n* Processes.process=""* Nul*"" Processes.process IN (""*&gt;*"", ""*>*"") Processes.process IN (""*&amp;*"", ""*& *"") ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `ping_sleep_batch_command_filter`"
Recon AVProduct Through Pwh or WMI,"The following analytic detects suspicious PowerShell script execution via EventCode 4104, specifically targeting checks for installed anti-virus products using WMI or PowerShell commands. This detection leverages PowerShell Script Block Logging to identify scripts containing keywords like &quot;SELECT,&quot; &quot;WMIC,&quot; &quot;AntiVirusProduct,&quot; or &quot;AntiSpywareProduct.&quot; This activity is significant as it is commonly used by malware and APT actors to map running security applications or services, potentially aiding in evasion techniques.",Windows Events,Execution,T1592,"`powershell` EventCode=4104 (ScriptBlockText = ""*SELECT*"" OR ScriptBlockText = ""*WMIC*"") AND (ScriptBlockText = ""*AntiVirusProduct*"" OR ScriptBlockText = ""*AntiSpywareProduct*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `recon_avproduct_through_pwh_or_wmi_filter`"
Schtasks scheduling job on remote system,"The following analytic detects the use of 'schtasks.exe' to create a scheduled task on a remote system, indicating potential lateral movement or remote code execution. It leverages process data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line arguments and flags. This activity is significant as it may signify an adversary's attempt to persist or execute code remotely.",Windows Events,"Lateral Movement, Execution",T1053.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = schtasks.exe OR Processes.original_file_name=schtasks.exe) (Processes.process=""*/create*"" AND Processes.process=""*/s *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `schtasks_scheduling_job_on_remote_system_filter`"
Windows Unusual FileZilla XML Config Access,"The following analytic identifies processes accessing FileZilla XML config files such as recentservers.xml and sitemanager.xml. It leverages Windows Security Event logs, specifically monitoring EventCode 4663, which tracks object access events. This activity is significant because it can indicate unauthorized access or manipulation of sensitive configuration files used by FileZilla, a popular FTP client. If confirmed malicious, this could lead to data exfiltration, credential theft, or further compromise of the system.",Windows Events,"Credential Access, Exfiltration",T1552.001,"`wineventlog_security` EventCode=4663  NOT (ProcessName IN(""C:\\Program Files\\FileZilla FTP Client\\filezilla.exe"", ""C:\Program Files (x86)\\FileZilla FTP Client\\filezilla.exe"", ""C:\\Program Files\\Microsoft OneDrive\\OneDrive.exe"", ""C:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe"")) file_path IN (""*FileZilla\\recentservers.xml*"", ""*FileZilla\\sitemanager.xml*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by  ObjectName ObjectType ProcessName AccessMask process_id EventCode Computer Caller_User_Name 
| rename Computer as dest Caller_User_Name as user ProcessName as process_name 
|  `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unusual_filezilla_xml_config_access_filter`"
Powershell Disable Security Monitoring,"The following analytic identifies attempts to disable Windows Defender real-time behavior monitoring via PowerShell commands. It detects the use of specific Set-MpPreference parameters that disable various security features. This activity is significant as it is commonly used by malware such as RATs, bots, or Trojans to evade detection by disabling antivirus protections.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly`
count min(_time) as firstTime
max(_time) as lastTime
from datamodel=Endpoint.Processes where
`process_powershell`
Processes.process=""*Set-MpPreference*""
(
Processes.process IN (
""*DisableArchiveScanning*"",
""*DisableBehaviorMonitoring*"",
""*DisableBlockAtFirstSeen*"",
""*DisableCatchupFullScan*"",
""*DisableCatchupQuickScan*"",
""*DisableIOAVProtection*"",
""*DisableRealtimeMonitoring*"",
""*DisableRemovableDriveScanning*"",
""*DisableRestorePoint*"",
""*DisableScanningMappedNetworkDrivesForFullScan*"",
""*DisableScanningNetworkFiles*"",
""*DisableScriptScanning*"",
""*drdsc*"",
""*dsnf *"",
""*drtm *"",
""*dioavp *"",
""*dscrptsc *"",
""*dbaf *"",
""*darchsc *"",
""*dcfsc *"",
""*dbm *""
)
Processes.process IN (
""* $true*"",
""* 1*""
)
)
OR
(
Processes.process = ""*PUAProtection*""
Processes.process = ""*disable*""
)
OR
(
Processes.process = ""*CloudBlockLevel*""
Processes.process IN (
""* $false*"", 
""* 0*""
)
)
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `powershell_disable_security_monitoring_filter`"
ESXi Encryption Settings Modified,"Detects the disabling of critical encryption enforcement settings on an ESXi host, such as secure boot or executable verification requirements, which may indicate an attempt to weaken hypervisor integrity or allow unauthorized code execution.
Search 1`esxi_syslog` Message=&#34;*system settings encryption set*&#34; NOT Message=&#34;*shell.*&#34; Message IN (&#34;* -s *&#34;, &#34;* -e *&#34;,&#34;*--require-secure-boot*&#34;, &#34;*require-exec-installed-only*&#34;, &#34;execInstalledOnly&#34;) 2| rex field=_raw &#34;Z (?",VMware ESXi,"Execution, Defense Evasion",T1562,"`esxi_syslog` Message=""*system settings encryption set*"" NOT Message=""*shell.*"" Message IN (""* -s *"", ""* -e *"",""*--require-secure-boot*"", ""*require-exec-installed-only*"", ""execInstalledOnly"") 
| rex field=_raw ""Z (?<dest>[\w\.]*)\s.*\]: \[(?<user>\w+)\]:(?<command>.+)"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_encryption_settings_modified_filter`"
Cisco NVM - Installation of Typosquatted Python Package,"This analytic detects suspicious python package installations where the package name resembles popular Python libraries but may be typosquatted or slightly altered. Typosquatting is a common technique used by attackers to trick users into installing malicious packages that mimic legitimate ones. This detection leverages Cisco NVM flow telemetry and checks for pip or poetry package managers with the &quot;install&quot; or &quot;add&quot; flags, making outbound connections to package repository such as pypi.",Cisco NVM,Execution,T1059,"`cisco_network_visibility_module_flowdata`
dest_hostname IN (""*.pythonhosted.org"", ""*pypi.org"", ""*python-poetry.org"")
(
(process_arguments = ""*pip*"" process_arguments = ""*install*"")
OR
(process_arguments = ""*poetry*"" process_arguments = ""*add*"")
)
| rex field=process_arguments ""(?i)(?:pip
|poetry)[^
|]*?\s+(?:install
|add)\s+(?P<package_name>[^\s\""']+)$""
| lookup typo_squatted_python_packages
typosquatted_package_name as package_name
OUTPUTNEW comment package_official_url
| where isnotnull(comment)
| stats count min(_time) as firstTime max(_time) as lastTime
values(parent_process_arguments) as parent_process_arguments
values(process_arguments) as process_arguments
values(parent_process_hash) as parent_process_hash
values(process_hash) as process_hash
values(module_name_list) as module_name_list
values(module_hash_list) as module_hash_list
values(dest_port) as dest_port
values(aliul) as additional_logged_in_users_list
values(dest_hostname) as dest_hostname
by src dest parent_process_path parent_process_integrity_level process_path process_name process_integrity_level process_id transport package_name comment package_official_url
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table firstTime lastTime src dest_hostname dest dest_port transport  package_name comment package_official_url
parent_process_integrity_level parent_process_path parent_process_arguments parent_process_hash
process_integrity_level process_path process_name process_arguments process_hash process_id
additional_logged_in_users_list module_name_list module_hash_list
| `cisco_nvm___installation_of_typosquatted_python_package_filter`"
ESXi Account Modified,"This detection identifies the creation, deletion, or modification of a local user account on an ESXi host. This activity may indicate unauthorized access, indicator removal, or persistence attempts by an attacker seeking to establish or maintain control of the host.
Search 1`esxi_syslog` Message=&#34;*esxcli system account*&#34; Message IN (&#34;*-i *&#34;,&#34;*--id*&#34;) NOT Message=&#34;*[shell*&#34; 2| rex field=_raw &#34;Z (?",VMware ESXi,"Initial Access, Persistence, Defense Evasion","T1136.001, T1098, T1078","`esxi_syslog` Message=""*esxcli system account*"" Message IN (""*-i *"",""*--id*"") NOT Message=""*[shell*"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s.*: \[(?<initial_user>\w+)]:\s.+-i[d]*\s(?<modified_user>[\w_\-0-9]+)"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest initial_user modified_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_account_modified_filter`"
ESXi Audit Tampering,"This detection identifies the use of the esxcli system auditrecords commands, which can be used to tamper with logging on an ESXi host. This action may indicate an attempt to evade detection or hinder forensic analysis by preventing the recording of system-level audit events.
Search 1`esxi_syslog` Message=&#34;*esxcli system auditrecords*&#34; Message IN (&#34;*remote*&#34;,&#34;*local*&#34;) NOT Message = &#34;*[shell*&#34; 2| rex field=_raw &#34;Z (?",VMware ESXi,Defense Evasion,"T1070, T1562.003","`esxi_syslog` Message=""*esxcli system auditrecords*"" Message IN (""*remote*"",""*local*"") NOT Message = ""*[shell*"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| rex field=_raw ""[\w+]\]: (?<full_command>.*)"" 
| rex field=full_command ""\[(?<user>.*)]:\s(?<command>.*)"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_audit_tampering_filter`"
Windows Ingress Tool Transfer Using Explorer,"The following analytic identifies instances where the Windows Explorer process (explorer.exe) is executed with a URL in its command line. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because adversaries, such as those using DCRat malware, may abuse explorer.exe to open URLs with the default browser, which is an uncommon and suspicious behavior.",Windows Events,"Command And Control, Execution",T1105,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
(Processes.process_name = explorer.exe OR Processes.original_file_name = explorer.exe) 
AND NOT (Processes.parent_process_name IN(""userinit.exe"", ""svchost.exe"")) 
Processes.process IN (""* http://*"", ""* https://*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_ingress_tool_transfer_using_explorer_filter`"
Windows File Download Via CertUtil,"The following analytic detects the use of certutil.exe to download files using the -URL, -urlcache or '-verifyctl' arguments. This behavior is identified by monitoring command-line executions for these specific arguments via Endpoint Detection and Response (EDR) telemetry. This activity is significant because certutil.exe is a legitimate tool often abused by attackers to download and execute malicious payloads.",Windows Events,"Command And Control, Execution, Exfiltration",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_certutil` AND ((Processes.process IN (""*-URL *"", ""*/URL *"")) OR (Processes.process IN (""*urlcache*"", ""*verifyctl*"") AND Processes.process IN (""*/f *"", ""*-f *""))) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_download_via_certutil_filter`"
Windows Data Destruction Recursive Exec Files Deletion,"The following analytic identifies a suspicious process that is recursively deleting executable files on a compromised host. It leverages Sysmon Event Codes 23 and 26 to detect this activity by monitoring for a high volume of deletions or overwrites of files with extensions like .exe, .sys, and .dll. This behavior is significant as it is commonly associated with destructive malware such as CaddyWiper, DoubleZero, and SwiftSlicer, which aim to make file recovery impossible.",Windows Events,"Execution, Impact",T1485,"`sysmon` EventCode IN (""23"",""26"") TargetFilename IN (""*.exe"", ""*.sys"", ""*.dll"") 
| bin _time span=2m 
| stats count min(_time) as firstTime, max(_time) as lastTime values(file_path) as file_path values(file_hash) as file_hash values(file_name) as file_name values(file_modify_time) as file_modify_time values(process_name) as process_name values(process_path) as process_path values(process_guid) as process_guid values(process_id) as process_id values(process_exec) as process_exec by action dest dvc signature signature_id user user_id vendor_product 
| where count >=100 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_data_destruction_recursive_exec_files_deletion_filter`"
Linux Auditd Add User Account Type,"The following analytic detects the suspicious add user account type. This behavior is critical for a SOC to monitor because it may indicate attempts to gain unauthorized access or maintain control over a system. Such actions could be signs of malicious activity. If confirmed, this could lead to serious consequences, including a compromised system, unauthorized access to sensitive data, or even a wider breach affecting the entire network.",Linux,"Execution, Persistence, Privilege Escalation",T1136.001,"`linux_auditd` type=ADD_USER 
| rename host as dest
| stats count min(_time) as firstTime max(_time) as lastTime by exe pid dest res type 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_auditd_add_user_account_type_filter`"
Potential password in username,"The following analytic identifies instances where users may have mistakenly entered their passwords in the username field during authentication attempts. It detects this by analyzing failed authentication events with usernames longer than 7 characters and high Shannon entropy, followed by a successful authentication from the same source to the same destination. This activity is significant as it can indicate potential security risks, such as password exposure.",Azure AD (Microsoft Entra ID),"Initial Access, Defense Evasion","T1552.001, T1078.003","| tstats `security_content_summariesonly` earliest(_time) AS starttime latest(_time) AS endtime latest(sourcetype) AS sourcetype values(Authentication.src) AS src values(Authentication.dest) AS dest count FROM datamodel=Authentication WHERE nodename=Authentication.Failed_Authentication BY ""Authentication.user"" 
| `drop_dm_object_name(Authentication)` 
| lookup ut_shannon_lookup word AS user 
| where ut_shannon>3 AND len(user)>=8 AND mvcount(src) == 1 
| sort count, - ut_shannon 
| eval incorrect_cred=user 
| eval endtime=endtime+1000 
| map maxsearches=70 search=""
| tstats `security_content_summariesonly` earliest(_time) AS starttime latest(_time) AS endtime latest(sourcetype) AS sourcetype values(Authentication.src) AS src values(Authentication.dest) AS dest count FROM datamodel=Authentication WHERE nodename=Authentication.Successful_Authentication Authentication.src=\""$src$\"" Authentication.dest=\""$dest$\"" sourcetype IN (\""$sourcetype$\"") earliest=\""$starttime$\"" latest=\""$endtime$\"" BY \""Authentication.user\"" 
| `drop_dm_object_name(\""Authentication\"")` 
| `potential_password_in_username_false_positive_reduction` 
| eval incorrect_cred=\""$incorrect_cred$\"" 
| eval ut_shannon=\""$ut_shannon$\"" 
| sort count"" 
| where user!=incorrect_cred 
| outlier action=RM count 
| `potential_password_in_username_filter`"
Detect Copy of ShadowCopy with Script Block Logging,"The following analytic detects the use of PowerShell commands to copy the SAM, SYSTEM, or SECURITY hives, which are critical for credential theft. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command executed. This activity is significant as it indicates an attempt to exfiltrate sensitive registry hives for offline password cracking.",Windows Events,"Lateral Movement, Credential Access, Discovery",T1003.002,"`powershell` EventCode=4104 ScriptBlockText IN (""*copy*"",""*[System.IO.File]::Copy*"") AND ScriptBlockText IN (""*System32\\config\\SAM*"", ""*System32\\config\\SYSTEM*"",""*System32\\config\\SECURITY*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_copy_of_shadowcopy_with_script_block_logging_filter`"
Elevated Group Discovery with PowerView,"The following analytic detects the execution of the Get-DomainGroupMember cmdlet from PowerView, identified through PowerShell Script Block Logging (EventCode=4104). This cmdlet is used to enumerate members of elevated domain groups such as Domain Admins and Enterprise Admins. Monitoring this activity is crucial as it indicates potential reconnaissance efforts by adversaries to identify high-privileged users within the domain.",Windows Events,"Lateral Movement, Execution, Discovery","T1069.002, T1069","`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainGroupMember*"") AND ScriptBlockText IN (""*Domain Admins*"",""*Enterprise Admins*"", ""*Schema Admins*"", ""*Account Operators*"" , ""*Server Operators*"", ""*Protected Users*"",  ""*Dns Admins*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `elevated_group_discovery_with_powerview_filter`"
Get-DomainTrust with PowerShell Script Block,"The following analytic detects the execution of the Get-DomainTrust command from PowerView using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, allowing for detailed inspection. Identifying this activity is significant because it may indicate an attempt to gather domain trust information, which is often a precursor to lateral movement or privilege escalation.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1482,"`powershell` EventCode=4104 ScriptBlockText = ""*get-domaintrust*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domaintrust_with_powershell_script_block_filter`"
Get-ForestTrust with PowerShell Script Block,"The following analytic detects the execution of the Get-ForestTrust command from PowerSploit using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, providing detailed visibility into potentially suspicious activities. Monitoring this behavior is crucial as it can indicate an attempt to gather domain trust information, which is often a precursor to lateral movement or privilege escalation.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1059.001, T1482","`powershell` EventCode=4104 ScriptBlockText = ""*get-foresttrust*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_foresttrust_with_powershell_script_block_filter`"
Get WMIObject Group Discovery with Script Block Logging,"The following analytic detects the execution of the Get-WMIObject Win32_Group command using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, allowing for detailed analysis. Identifying group information on an endpoint is not inherently malicious but can be suspicious based on context such as time, endpoint, and user. This activity is significant as it may indicate reconnaissance efforts by an attacker.",Windows Events,"Lateral Movement, Execution, Discovery",T1069.001,"`powershell` EventCode=4104 ScriptBlockText = ""*Get-WMIObject*"" AND ScriptBlockText = ""*Win32_Group*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_wmiobject_group_discovery_with_script_block_logging_filter`"
GetAdComputer with PowerShell Script Block,"The following analytic detects the execution of the Get-AdComputer PowerShell commandlet using PowerShell Script Block Logging (EventCode=4104). This detection leverages script block text to identify when this commandlet is run. The Get-AdComputer commandlet is significant as it can be used by adversaries to enumerate all domain computers, aiding in situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-AdComputer*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `getadcomputer_with_powershell_script_block_filter`"
GetCurrent User with PowerShell Script Block,The following analytic detects the execution of the GetCurrent method from the WindowsIdentity .NET class using PowerShell Script Block Logging (EventCode=4104). This method identifies the current Windows user. The detection leverages PowerShell script block logs to identify when this method is called. This activity is significant because adversaries and Red Teams may use it to gain situational awareness and perform Active Directory discovery on compromised endpoints.,Windows Events,"Execution, Discovery",T1033,"`powershell` EventCode=4104 ScriptBlockText = ""*[System.Security.Principal.WindowsIdentity]*""  ScriptBlockText = ""*GetCurrent()*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getcurrent_user_with_powershell_script_block_filter`"
GetDomainComputer with PowerShell Script Block,"The following analytic detects the execution of the Get-DomainComputer commandlet using PowerShell Script Block Logging (EventCode=4104). This commandlet is part of PowerView, a tool often used for enumerating domain computers within Windows environments. The detection leverages script block text analysis to identify this specific command. Monitoring this activity is crucial as it can indicate an adversary's attempt to gather information about domain computers, which is a common step in Active Directory reconnaissance.",Windows Events,"Lateral Movement, Execution, Discovery",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainComputer*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getdomaincomputer_with_powershell_script_block_filter`"
GetDomainController with PowerShell Script Block,"The following analytic detects the execution of the Get-DomainController commandlet using PowerShell Script Block Logging (EventCode=4104). This commandlet is part of PowerView, a tool often used for domain enumeration. The detection leverages script block text to identify this specific activity. Monitoring this behavior is crucial as it may indicate an adversary or Red Team performing reconnaissance to map out domain controllers.",Windows Events,"Lateral Movement, Execution, Discovery",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainController*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `getdomaincontroller_with_powershell_script_block_filter`"
GetDomainGroup with PowerShell Script Block,"The following analytic detects the execution of the Get-DomainGroup cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet, part of the PowerView tool, is used to enumerate domain groups within a Windows domain. The detection leverages script block text to identify this specific command. Monitoring this activity is crucial as it may indicate an adversary or Red Team performing reconnaissance to gain situational awareness and map out Active Directory structures.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069.002, T1069","`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainGroup*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getdomaingroup_with_powershell_script_block_filter`"
GetLocalUser with PowerShell Script Block,The following analytic detects the execution of the Get-LocalUser PowerShell commandlet using PowerShell Script Block Logging (EventCode=4104). This commandlet lists all local users on a system. The detection leverages script block text from PowerShell logs to identify this activity. Monitoring this behavior is significant as adversaries and Red Teams may use it to enumerate local users for situational awareness and Active Directory discovery.,Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1059.001, T1087.001, T1087","`powershell` EventCode=4104 (ScriptBlockText = ""*Get-LocalUser*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getlocaluser_with_powershell_script_block_filter`"
GetNetTcpconnection with PowerShell Script Block,"The following analytic detects the execution of the Get-NetTcpconnection PowerShell cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet lists network connections on a system, which adversaries may use for situational awareness and Active Directory discovery. Monitoring this activity is crucial as it can indicate reconnaissance efforts by an attacker. If confirmed malicious, this behavior could allow an attacker to map the network, identify critical systems, and plan further attacks, potentially leading to data exfiltration or lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Discovery, Exfiltration",T1049,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-NetTcpconnection*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getnettcpconnection_with_powershell_script_block_filter`"
GetWmiObject Ds Computer with PowerShell Script Block,The following analytic detects the execution of the Get-WmiObject cmdlet with the DS_Computer class parameter via PowerShell Script Block Logging (EventCode=4104). This detection leverages script block text to identify queries targeting domain computers using WMI. Monitoring this activity is crucial as adversaries and Red Teams may use it for Active Directory Discovery and situational awareness.,Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1018,"`powershell` EventCode=4104 (ScriptBlockText=*Get-WmiObject* AND ScriptBlockText=""*namespace root\\directory\\ldap*"" AND ScriptBlockText=""*class ds_computer*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_ds_computer_with_powershell_script_block_filter`"
GetWmiObject Ds Group with PowerShell Script Block,"The following analytic detects the execution of the Get-WmiObject commandlet with the DS_Group parameter via PowerShell Script Block Logging (EventCode=4104). This method leverages WMI to query all domain groups. Monitoring this activity is crucial as adversaries and Red Teams may use it for domain group enumeration, aiding in situational awareness and Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation","T1069.002, T1069","`powershell` EventCode=4104 (ScriptBlockText=*Get-WmiObject* AND ScriptBlockText=""*namespace root\\directory\\ldap*"" AND ScriptBlockText=""*class ds_group*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`getwmiobject_ds_group_with_powershell_script_block_filter`"
GetWmiObject User Account with PowerShell Script Block,The following analytic detects the execution of the Get-WmiObject commandlet with the Win32_UserAccount parameter via PowerShell Script Block Logging (EventCode=4104). This method leverages script block text to identify when a list of all local users is being enumerated. This activity is significant as it may indicate an adversary or Red Team operation attempting to gather user information for situational awareness and Active Directory discovery.,Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1059.001, T1087.001, T1087","`powershell` EventCode=4104 (ScriptBlockText=""*Get-WmiObject*"" AND ScriptBlockText=""*Win32_UserAccount*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_user_account_with_powershell_script_block_filter`"
Interactive Session on Remote Endpoint with PowerShell,The following analytic detects the use of the Enter-PSSession cmdlet to establish an interactive session on a remote endpoint via the WinRM protocol. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity by searching for specific script block text patterns. This behavior is significant as it may indicate lateral movement or remote code execution attempts by adversaries.,Windows Events,"Lateral Movement, Execution","T1021.006, T1021","`powershell` EventCode=4104 (ScriptBlockText=""*Enter-PSSession*"" AND ScriptBlockText=""*-ComputerName*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `interactive_session_on_remote_endpoint_with_powershell_filter`"
Kerberos Pre-Authentication Flag Disabled with PowerShell,"The following analytic detects the use of the Set-ADAccountControl PowerShell cmdlet with parameters that disable Kerberos Pre-Authentication. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this specific command execution. Disabling Kerberos Pre-Authentication is significant because it allows adversaries to perform offline brute force attacks against user passwords using the AS-REP Roasting technique. If confirmed malicious, this activity could enable attackers to escalate privileges or maintain persistence within an Active Directory environment, posing a severe security risk.",Windows Events,"Execution, Credential Access, Persistence",T1558.004,"`powershell` EventCode=4104 (ScriptBlockText = ""*Set-ADAccountControl*"" AND ScriptBlockText=""*DoesNotRequirePreAuth:$true*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `kerberos_pre_authentication_flag_disabled_with_powershell_filter`"
Powershell Creating Thread Mutex,"The following analytic detects the execution of PowerShell scripts using the mutex function via EventCode 4104. This detection leverages PowerShell Script Block Logging to identify scripts that create thread mutexes, a technique often used in obfuscated scripts to ensure only one instance runs on a compromised machine. This activity is significant as it may indicate the presence of sophisticated malware or persistence mechanisms.",Windows Events,"Execution, Persistence, Defense Evasion","T1059.001, T1027.005","`powershell` EventCode=4104 ScriptBlockText = ""*Threading.Mutex*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_creating_thread_mutex_filter`"
PowerShell Enable PowerShell Remoting,"The following analytic detects the use of the Enable-PSRemoting cmdlet, which allows PowerShell remoting on a local or remote computer. This detection leverages PowerShell Script Block Logging (EventCode 4104) to identify when this cmdlet is executed. Monitoring this activity is crucial as it can indicate an attacker enabling remote command execution capabilities on a compromised system.",Windows Events,"Lateral Movement, Execution, Discovery",T1059.001,"`powershell` EventCode=4104 ScriptBlockText=""*Enable-PSRemoting*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `powershell_enable_powershell_remoting_filter`"
Powershell Get LocalGroup Discovery with Script Block Logging,"The following analytic detects the execution of the PowerShell cmdlet get-localgroup using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, providing detailed visibility into script execution. Monitoring this activity is significant as it can indicate an attempt to enumerate local groups, which may be a precursor to privilege escalation or lateral movement.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1069.001,"`powershell` EventCode=4104 ScriptBlockText = ""*get-localgroup*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `powershell_get_localgroup_discovery_with_script_block_logging_filter`"
Powershell Remote Services Add TrustedHost,"The following analytic detects the execution of a PowerShell script that modifies the 'TrustedHosts' configuration via EventCode 4104. It leverages PowerShell Script Block Logging to identify commands targeting WSMan settings, specifically those altering or concatenating trusted hosts. This activity is significant as it can indicate attempts to manipulate remote connection settings, potentially allowing unauthorized remote access.",Windows Events,"Lateral Movement, Execution, Discovery",T1021.006,"`powershell` EventCode=4104  ScriptBlockText = ""*WSMan:\\localhost\\Client\\TrustedHosts*"" ScriptBlockText IN (""* -Value *"", ""* -Concatenate *"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_remote_services_add_trustedhost_filter`"
Powershell Using memory As Backing Store,"The following analytic detects suspicious PowerShell script execution using memory streams as a backing store, identified via EventCode 4104. It leverages PowerShell Script Block Logging to capture scripts that create new objects with memory streams, often used to decompress and execute payloads in memory. This activity is significant as it indicates potential in-memory execution of malicious code, bypassing traditional file-based detection.",Windows Events,"Execution, Persistence",T1059.001,"`powershell` EventCode=4104 ScriptBlockText = *New-Object* ScriptBlockText = *IO.MemoryStream* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_using_memory_as_backing_store_filter`"
Remote Process Instantiation via DCOM and PowerShell Script Block,"The following analytic detects the execution of PowerShell commands that initiate a process on a remote endpoint via the DCOM protocol. It leverages PowerShell Script Block Logging (EventCode=4104) to identify the use of ShellExecute and ExecuteShellCommand. This activity is significant as it may indicate lateral movement or remote code execution attempts by adversaries. If confirmed malicious, this behavior could allow attackers to execute arbitrary code on remote systems, potentially leading to further compromise and persistence within the network.",Windows Events,"Lateral Movement, Execution, Persistence","T1021.003, T1021","`powershell` EventCode=4104 (ScriptBlockText=""*Document.Application.ShellExecute*"" OR ScriptBlockText=""*Document.ActiveView.ExecuteShellCommand*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_dcom_and_powershell_script_block_filter`"
Remote Process Instantiation via WinRM and PowerShell Script Block,The following analytic detects the execution of PowerShell commands that use the Invoke-Command cmdlet to start a process on a remote endpoint via the WinRM protocol. It leverages PowerShell Script Block Logging (EventCode=4104) to identify such activities. This behavior is significant as it may indicate lateral movement or remote code execution attempts by adversaries.,Windows Events,"Lateral Movement, Execution, Persistence","T1021.006, T1021","`powershell` EventCode=4104 (ScriptBlockText=""*Invoke-Command*"" AND ScriptBlockText=""*-ComputerName*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_winrm_and_powershell_script_block_filter`"
Remote Process Instantiation via WMI and PowerShell Script Block,"The following analytic detects the execution of the Invoke-WmiMethod commandlet with parameters used to start a process on a remote endpoint via WMI, leveraging PowerShell Script Block Logging (EventCode=4104). This method identifies specific script block text patterns associated with remote process instantiation. This activity is significant as it may indicate lateral movement or remote code execution attempts by adversaries.",Windows Events,"Discovery, Execution, Persistence, Lateral Movement",T1047,"`powershell` EventCode=4104 ScriptBlockText=""*Invoke-WmiMethod*"" AND (ScriptBlockText=""*-CN*"" OR ScriptBlockText=""*-ComputerName*"") AND ScriptBlockText=""*-Class Win32_Process*"" AND ScriptBlockText=""*-Name create*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_wmi_and_powershell_script_block_filter`"
Remote System Discovery with Adsisearcher,The following analytic detects the use of the [Adsisearcher] type accelerator in PowerShell scripts to query Active Directory for domain computers. It leverages PowerShell Script Block Logging (EventCode=4104) to identify specific script blocks containing adsisearcher and objectcategory=computer with methods like findAll() or findOne(). This activity is significant as it may indicate an attempt by adversaries or Red Teams to perform Active Directory discovery and gain situational awareness.,Windows Events,"Lateral Movement, Discovery",T1018,[Adsisearcher]
Unloading AMSI via Reflection,"The following analytic detects the tampering of AMSI (Antimalware Scan Interface) via PowerShell reflection. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze suspicious PowerShell commands, specifically those involving system.management.automation.amsi. This activity is significant as it indicates an attempt to bypass AMSI, a critical security feature that helps detect and block malicious scripts.",Windows Events,"Execution, Exfiltration, Discovery, Defense Evasion","T1059.001, T1562","`powershell` EventCode=4104 ScriptBlockText = *system.management.automation.amsi* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `unloading_amsi_via_reflection_filter`"
User Discovery With Env Vars PowerShell Script Block,The following analytic detects the use of PowerShell environment variables to identify the current logged user by leveraging PowerShell Script Block Logging (EventCode=4104). This method monitors script blocks containing $env:UserName or [System.Environment]::UserName. Identifying this activity is significant as adversaries and Red Teams may use it for situational awareness and Active Directory discovery on compromised endpoints.,Windows Events,"Lateral Movement, Discovery",T1033,"`powershell` EventCode=4104 (ScriptBlockText = ""*$env:UserName*"" OR ScriptBlockText = ""*[System.Environment]::UserName*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `user_discovery_with_env_vars_powershell_script_block_filter`"
Windows Account Discovery for None Disable User Account,"The following analytic detects the execution of the PowerView PowerShell cmdlet Get-NetUser with the UACFilter parameter set to NOT_ACCOUNTDISABLE, indicating an attempt to enumerate Active Directory user accounts that are not disabled. This detection leverages PowerShell Script Block Logging (EventCode 4104) to identify the specific script block text. Monitoring this activity is significant as it may indicate reconnaissance efforts by an attacker to identify active user accounts for further exploitation.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1087.001,"`powershell` EventCode=4104  ScriptBlockText = ""*Get-NetUser*"" ScriptBlockText = ""*NOT_ACCOUNTDISABLE*"" ScriptBlockText = ""*-UACFilter*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_account_discovery_for_none_disable_user_account_filter`"
Windows Account Discovery for Sam Account Name,"The following analytic detects the execution of the PowerView PowerShell cmdlet Get-NetUser, specifically querying for &quot;samaccountname&quot; and &quot;pwdlastset&quot; attributes. It leverages Event ID 4104 from PowerShell Script Block Logging to identify this activity. This behavior is significant as it may indicate an attempt to gather user account information from Active Directory, which is a common reconnaissance step in lateral movement or privilege escalation attacks.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1087,"`powershell` EventCode=4104  ScriptBlockText = ""*Get-NetUser*"" ScriptBlockText IN (""*samaccountname*"", ""*pwdlastset*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_account_discovery_for_sam_account_name_filter`"
Windows Account Discovery With NetUser PreauthNotRequire,"The following analytic detects the execution of the PowerView PowerShell cmdlet Get-NetUser with the -PreauthNotRequire parameter, leveraging Event ID 4104. This method identifies attempts to query Active Directory user accounts that do not require Kerberos preauthentication. Monitoring this activity is crucial as it can indicate reconnaissance efforts by an attacker to identify potentially vulnerable accounts.",Windows Events,"Discovery, Execution, Privilege Escalation",T1087,"`powershell` EventCode=4104  ScriptBlockText = ""*Get-NetUser*"" ScriptBlockText = ""*-PreauthNotRequire*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_account_discovery_with_netuser_preauthnotrequire_filter`"
Windows Admon Default Group Policy Object Modified,"The following analytic detects modifications to the default Group Policy Objects (GPOs) in an Active Directory environment. It leverages Splunk's Admon to monitor updates to the &quot;Default Domain Policy&quot; and &quot;Default Domain Controllers Policy.&quot; This activity is significant because changes to these default GPOs can indicate an adversary with privileged access attempting to gain further control, establish persistence, or deploy malware across multiple hosts.",Windows Events,"Discovery, Persistence, Privilege Escalation, Defense Evasion","T1484, T1484.001","`admon` admonEventType=Update objectCategory=""CN=Group-Policy-Container,CN=Schema,CN=Configuration,DC=*"" (displayName=""Default Domain Policy"" OR displayName=""Default Domain Controllers Policy"") 
| stats min(_time) as firstTime max(_time) as lastTime values(gPCFileSysPath) by dcName, displayName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_admon_default_group_policy_object_modified_filter`"
Windows Admon Group Policy Object Created,"The following analytic detects the creation of a new Group Policy Object (GPO) using Splunk's Admon data. It identifies events where a new GPO is created, excluding default &quot;New Group Policy Object&quot; entries. Monitoring GPO creation is crucial as adversaries can exploit GPOs to escalate privileges or deploy malware across an Active Directory network.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1484, T1484.001","`admon` admonEventType=Update objectCategory=""CN=Group-Policy-Container,CN=Schema,CN=Configuration,DC=*"" versionNumber=0 displayName!=""New Group Policy Object"" 
| stats min(_time) as firstTime max(_time) as lastTime values(gPCFileSysPath) by dcName, displayName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_admon_group_policy_object_created_filter`"
Windows ClipBoard Data via Get-ClipBoard,"The following analytic detects the execution of the PowerShell command 'Get-Clipboard' to retrieve clipboard data. It leverages PowerShell Script Block Logging (EventCode 4104) to identify instances where this command is used. This activity is significant because it can indicate an attempt to steal sensitive information such as usernames, passwords, or other confidential data copied to the clipboard.",Windows Events,"Collection, Execution, Impact, Discovery",T1115,"`powershell` EventCode=4104 ScriptBlockText = ""*Get-Clipboard*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_clipboard_data_via_get_clipboard_filter`"
Windows Domain Account Discovery Via Get-NetComputer,"The following analytic detects the execution of the PowerView PowerShell cmdlet Get-NetComputer, which is used to query Active Directory for user account details such as &quot;samaccountname,&quot; &quot;accountexpires,&quot; &quot;lastlogon,&quot; and more. It leverages Event ID 4104 from PowerShell Script Block Logging to identify this activity. This behavior is significant as it may indicate an attempt to gather user account information, which is often a precursor to further malicious actions.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1087.002,"`powershell` EventCode=4104  ScriptBlockText = ""*Get-NetComputer*"" ScriptBlockText IN (""*samaccountname*"", ""*accountexpires*"", ""*lastlogon*"", ""*lastlogoff*"", ""*pwdlastset*"", ""*logoncount*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_domain_account_discovery_via_get_netcomputer_filter`"
Windows Enable PowerShell Web Access,"The following analytic detects the enabling of PowerShell Web Access via PowerShell commands. It leverages PowerShell script block logging (EventCode 4104) to identify the execution of the Install-WindowsFeature cmdlet with the WindowsPowerShellWebAccess parameter. This activity is significant because enabling PowerShell Web Access can facilitate remote execution of PowerShell commands, potentially allowing an attacker to gain unauthorized access to systems and networks.",Windows Events,"Execution, Discovery",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*Install-WindowsFeature*WindowsPowerShellWebAccess*"",""*Install-PswaWebApplication*"",""*Add-PswaAuthorizationRule*UserName *ComputerName *"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_enable_powershell_web_access_filter`"
Windows File Share Discovery With Powerview,"The following analytic detects the execution of the Invoke-ShareFinder PowerShell cmdlet from PowerView. This detection leverages PowerShell Script Block Logging to identify instances where this specific command is executed. Monitoring this activity is crucial as it indicates an attempt to enumerate network file shares, which may contain sensitive information such as backups, scripts, and credentials.",Windows Events,"Discovery, Execution, Privilege Escalation",T1135,"`powershell` EventCode=4104  (ScriptBlockText=Invoke-ShareFinder*) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_share_discovery_with_powerview_filter`"
Windows Gather Victim Host Information Camera,"The following analytic detects a PowerShell script that enumerates camera devices on the targeted host. This detection leverages PowerShell Script Block Logging, specifically looking for commands querying Win32_PnPEntity for camera-related information. This activity is significant as it is commonly observed in DCRat malware, which collects camera data to send to its command-and-control server. If confirmed malicious, this behavior could indicate an attempt to gather sensitive visual information from the host, potentially leading to privacy breaches or further exploitation.",Windows Events,Discovery,T1592.001,"`powershell` EventCode=4104 ScriptBlockText= ""* Win32_PnPEntity *"" ScriptBlockText= ""*SELECT*"" ScriptBlockText= ""*WHERE*"" ScriptBlockText = ""*PNPClass*"" ScriptBlockText IN (""*Image*"", ""*Camera*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_gather_victim_host_information_camera_filter`"
Windows PowerShell Add Module to Global Assembly Cache,"The following analytic detects the addition of a DLL to the Windows Global Assembly Cache (GAC) using PowerShell. It leverages PowerShell Script Block Logging to identify commands containing &quot;system.enterpriseservices.internal.publish&quot;. This activity is significant because adding a DLL to the GAC allows it to be shared across multiple applications, potentially enabling an adversary to execute malicious code system-wide.",Windows Events,"Execution, Persistence, Privilege Escalation",T1505.004,"`powershell` EventCode=4104 ScriptBlockText IN(""*system.enterpriseservices.internal.publish*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_add_module_to_global_assembly_cache_filter`"
Windows Powershell Cryptography Namespace,"The following analytic detects suspicious PowerShell script execution involving the cryptography namespace via EventCode 4104. It leverages PowerShell Script Block Logging to identify scripts using cryptographic functions, excluding common hashes like SHA and MD5. This activity is significant as it is often associated with malware that decrypts or decodes additional malicious payloads. If confirmed malicious, this could allow an attacker to execute further code, escalate privileges, or establish persistence within the environment.",Windows Events,"Execution, Persistence",T1059.001,"`powershell` EventCode=4104 ScriptBlockText = ""*System.Security.Cryptography*"" AND NOT(ScriptBlockText IN (""*SHA*"", ""*MD5*"", ""*DeriveBytes*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_cryptography_namespace_filter`"
Windows PowerShell Disable HTTP Logging,"The following analytic detects the use of get-WebConfigurationProperty and Set-ItemProperty commands in PowerShell to disable HTTP logging on Windows systems. This detection leverages PowerShell Script Block Logging, specifically looking for script blocks that reference HTTP logging properties and attempt to set them to &quot;false&quot; or &quot;dontLog&quot;. Disabling HTTP logging is significant as it can be used by adversaries to cover their tracks and delete logs, hindering forensic investigations.",Windows Events,"Persistence, Defense Evasion","T1562.002, T1505.004","`powershell` EventCode=4104 ScriptBlockText IN(""*get-WebConfigurationProperty*"",""*Set-ItemProperty*"") AND ScriptBlockText IN (""*httpLogging*"",""*Logfile.enabled*"") AND ScriptBlockText IN (""*dontLog*"", ""*false*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_disable_http_logging_filter`"
Windows PowerShell Export Certificate,"The following analytic detects the use of the PowerShell Cmdlet export-certificate by leveraging Script Block Logging. This activity is significant as it may indicate an adversary attempting to exfiltrate certificates from the local Certificate Store on a Windows endpoint. Monitoring this behavior is crucial because stolen certificates can be used to impersonate users, decrypt sensitive data, or facilitate further attacks.",Windows Events,Credential Access,"T1552.004, T1649","`powershell` EventCode=4104 ScriptBlockText IN (""*export-certificate*"") 
| rename Computer as dest 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_export_certificate_filter`"
Windows PowerShell Get CIMInstance Remote Computer,"The following analytic detects the use of the Get-CimInstance cmdlet with the -ComputerName parameter, indicating an attempt to retrieve information from a remote computer. It leverages PowerShell Script Block Logging to identify this specific command execution. This activity is significant as it may indicate unauthorized remote access or information gathering by an attacker. If confirmed malicious, this could allow the attacker to collect sensitive data from remote systems, potentially leading to further exploitation or lateral movement within the network.",Windows Events,"Lateral Movement, Execution",T1059.001,"`powershell` EventCode=4104 ScriptBlockText=""*get-ciminstance*"" AND ScriptBlockText=""*computername*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_get_ciminstance_remote_computer_filter`"
Windows Powershell History File Deletion,"The following analytic detects the usage of PowerShell to delete its command history file, which may indicate an attempt to evade detection by removing evidence of executed commands. PowerShell stores command history in ConsoleHost_history.txt under the userâ€™s profile directory. Adversaries or malicious scripts may delete this file using Remove-Item, del, or similar commands. This detection focuses on file deletion events targeting the history file, correlating them with recent PowerShell activity.",Windows Events,"Execution, Defense Evasion","T1070.003, T1059.003","`powershell` EventCode=4104 ScriptBlockText = ""*Remove-Item*"" ScriptBlockText = ""*.HistorySavePath"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_history_file_deletion_filter`"
Windows Powershell Import Applocker Policy,"The following analytic detects the import of Windows PowerShell Applocker cmdlets, specifically identifying the use of &quot;Import-Module Applocker&quot; and &quot;Set-AppLockerPolicy&quot; with an XML policy. It leverages PowerShell Script Block Logging (EventCode 4104) to capture and analyze script block text. This activity is significant as it may indicate an attempt to enforce restrictive Applocker policies, potentially used by malware like Azorult to disable antivirus products.",Windows Events,"Collection, Execution, Persistence, Defense Evasion","T1059.001, T1562.001","`powershell` EventCode=4104 ScriptBlockText=""*Import-Module Applocker*"" ScriptBlockText=""*Set-AppLockerPolicy*"" ScriptBlockText=""* -XMLPolicy *"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_import_applocker_policy_filter`"
Windows PowerShell Invoke-RestMethod IP Information Collection,"The following analytic detects the use of PowerShell's Invoke-RestMethod cmdlet to collect geolocation data from ipinfo.io or IP address information from api.ipify.org. This behavior leverages PowerShell Script Block Logging to identify scripts that gather external IP information and potential geolocation data. This activity is significant as it may indicate reconnaissance efforts, where threat actors are attempting to determine the geographical location or network details of a compromised system.",Windows Events,"Collection, Execution, Discovery","T1059.001, T1016, T1082","`powershell` EventCode=4104 (ScriptBlockText=""*Invoke-RestMethod*"" AND (ScriptBlockText=""*ipinfo.io*"" OR ScriptBlockText=""*api.ipify.org*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_invoke_restmethod_ip_information_collection_filter`"
Windows PowerShell WMI Win32 ScheduledJob,"The following analytic detects the use of the Win32_ScheduledJob WMI class via PowerShell script block logging. This class, which manages scheduled tasks, is disabled by default due to security concerns and must be explicitly enabled through registry modifications. The detection leverages PowerShell event code 4104 and script block text analysis. Monitoring this activity is crucial as it may indicate malicious intent, especially if the class was enabled by an attacker.",Windows Events,"Lateral Movement, Execution, Collection",T1059.001,"`powershell` EventCode=4104 ScriptBlockText=""*win32_scheduledjob*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_wmi_win32_scheduledjob_filter`"
Windows PowerView AD Access Control List Enumeration,"The following analytic detects the execution of PowerView PowerShell cmdlets Get-ObjectAcl or Get-DomainObjectAcl, which are used to enumerate Access Control List (ACL) permissions for Active Directory objects. It leverages Event ID 4104 from PowerShell Script Block Logging to identify this activity. This behavior is significant as it may indicate an attempt to discover weak permissions in Active Directory, potentially leading to privilege escalation.",Windows Events,"Initial Access, Execution, Privilege Escalation, Defense Evasion, Discovery","T1078.002, T1078, T1069","`powershell` EventCode=4104  (ScriptBlockText=*get-objectacl* OR ScriptBlockText=*Get-DomainObjectAcl*) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powerview_ad_access_control_list_enumeration_filter`"
WMI Recon Running Process Or Services,"The following analytic identifies suspicious PowerShell script execution via EventCode 4104, where WMI performs an event query to list running processes or services. This detection leverages PowerShell Script Block Logging to capture and analyze script block text for specific WMI queries. This activity is significant as it is commonly used by malware and APT actors to map security applications or services on a compromised machine.",Windows Events,"Execution, Persistence",T1592,"`powershell` EventCode=4104 ScriptBlockText= ""*SELECT*"" AND (ScriptBlockText=""*Win32_Process*"" OR ScriptBlockText=""*Win32_Service*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wmi_recon_running_process_or_services_filter`"
Gsuite Suspicious Shared File Name,The following analytic detects shared files in Google Drive with suspicious filenames commonly used in spear phishing campaigns.,Google Workspace,Initial Access,T1566.001,"`gsuite_drive` parameters.owner_is_team_drive=false ""parameters.doc_title"" IN (""*dhl*"", ""* ups *"", ""*delivery*"", ""*parcel*"", ""*label*"", ""*invoice*"", ""*postal*"", ""*fedex*"", ""* usps *"", ""* express *"", ""*shipment*"", ""*Banking/Tax*"",""*shipment*"", ""*new order*"") parameters.doc_type IN (""document"",""pdf"", ""msexcel"", ""msword"", ""spreadsheet"", ""presentation"") 
| rex field=parameters.owner ""[^@]+@(?<source_domain>[^@]+)"" 
| rex field=parameters.target_user ""[^@]+@(?<dest_domain>[^@]+)"" 
| where not source_domain=""internal_test_email.com"" and dest_domain=""internal_test_email.com"" 
| eval phase=""plan"" 
| eval severity=""low"" 
| stats count min(_time) as firstTime max(_time) as lastTime by email parameters.owner parameters.target_user parameters.doc_title parameters.doc_type phase severity 
| rename parameters.target_user AS user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `gsuite_suspicious_shared_file_name_filter`"
Excessive Usage Of Cacls App,"The following analytic identifies excessive usage of cacls.exe, xcacls.exe, or icacls.exe to change file or folder permissions. It looks for 10 or more execution of the aforementioned processes in the span of 1 minute. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an adversary attempting to restrict access to malware components or artifacts on a compromised system.",Windows Events,"Execution, Persistence, Defense Evasion",T1222,"| tstats `security_content_summariesonly` 
min(_time) as firstTime 
max(_time) as lastTime 
values(Processes.dest) as dest
values(Processes.user) as user 
values(Processes.action) as action 
values(Processes.original_file_name) as original_file_name 
values(Processes.parent_process_exec) as parent_process_exec 
values(Processes.parent_process_guid) as parent_process_guid
values(Processes.parent_process_id) as parent_process_id 
values(Processes.parent_process_path) as parent_process_path 
values(Processes.process) as process 
values(Processes.process_exec) as process_exec 
values(Processes.process_guid) as process_guid 
values(Processes.process_hash) as process_hash 
values(Processes.process_id) as process_id 
values(Processes.process_integrity_level) as process_integrity_level 
values(Processes.process_name) as process_name 
values(Processes.process_path) as process_path 
values(Processes.user_id) as user_id 
values(Processes.vendor_product) as vendor_product count 
from datamodel=Endpoint.Processes where 
Processes.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") 
by Processes.parent_process_name Processes.parent_process Processes.dest Processes.user _time span=1m 
| where count >=10 
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_usage_of_cacls_app_filter`"
Modify ACL permission To Files Or Folder,"The following analytic detects the modification of ACL permissions to files or folders, making them accessible to everyone or to system account. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes like &quot;cacls.exe,&quot; &quot;icacls.exe,&quot; and &quot;xcacls.exe&quot; with specific command-line arguments. This activity is significant as it may indicate an adversary attempting to evade ACLs or access protected files.",Windows Events,"Execution, Defense Evasion",T1222,"| tstats `security_content_summariesonly` count 
min(_time) as firstTime 
max(_time) as lastTime
values(Processes.process) as process
values(Processes.process_id) as process_id 
from datamodel=Endpoint.Processes where 
Processes.process_name IN (""icacls.exe"", ""cacls.exe"", ""xcacls.exe"") 
Processes.process IN (""*/grant*"", ""*/g:*"", ""*/g *"") 
Processes.process IN (""* Everyone:*"", ""* SYSTEM:*"", ""* S-1-1-0:*"")
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `modify_acl_permission_to_files_or_folder_filter`"
Network Traffic to Active Directory Web Services Protocol,"The following analytic identifies network traffic directed to the Active Directory Web Services Protocol (ADWS) on port 9389. It leverages network traffic logs, focusing on source and destination IP addresses, application names, and destination ports. This activity is significant as ADWS is used to manage Active Directory, and unauthorized access could indicate malicious intent.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Discovery, Privilege Escalation","T1069.001, T1087.001, T1069.002, T1482, T1087.002","| tstats count from datamodel=Network_Traffic where All_Traffic.dest_port=9389 by All_Traffic.action All_Traffic.app All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.direction All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Traffic"")` 
| `network_traffic_to_active_directory_web_services_protocol_filter`"
ASL AWS New MFA Method Registered For User,"The following analytic identifies the registration of a new Multi-Factor Authentication (MFA) method for an AWS account, as logged through Amazon Security Lake (ASL). It detects this activity by monitoring the CreateVirtualMFADevice API operation within ASL logs. This behavior is significant because adversaries who gain unauthorized access to an AWS account may register a new MFA method to maintain persistence.",AWS CloudTrail,"Persistence, Credential Access","T1556.006, T1556","`amazon_security_lake` api.operation=CreateVirtualMFADevice 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_new_mfa_method_registered_for_user_filter`"
Cloud Compute Instance Created By Previously Unseen User,"The following analytic identifies the creation of cloud compute instances by users who have not previously created them. It leverages data from the Change data model, focusing on 'create' actions by users, and cross-references with a baseline of known user activities. This activity is significant as it may indicate unauthorized access or misuse of cloud resources by new or compromised accounts.",Windows Events,"Exfiltration, Defense Evasion",T1078.004,"| tstats `security_content_summariesonly` count earliest(_time) as firstTime, latest(_time) as lastTime values(All_Changes.object) as dest from datamodel=Change where All_Changes.action=created by All_Changes.user All_Changes.vendor_region 
| `drop_dm_object_name(""All_Changes"")` 
| lookup previously_seen_cloud_compute_creations_by_user user as user OUTPUTNEW firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenUser=min(firstTimeSeen) 
| where isnull(firstTimeSeenUser) OR firstTimeSeenUser > relative_time(now(), ""-24h@h"") 
| table firstTime, user, dest, count vendor_region 
| `security_content_ctime(firstTime)` 
| `cloud_compute_instance_created_by_previously_unseen_user_filter`"
Cloud Compute Instance Created In Previously Unused Region,"The following analytic detects the creation of a cloud compute instance in a region that has not been previously used within the last hour. It leverages cloud infrastructure logs and compares the regions of newly created instances against a lookup file of historically used regions. This activity is significant because the creation of instances in new regions can indicate unauthorized or suspicious activity, such as an attacker attempting to evade detection or establish a foothold in a less monitored area.",Windows Events,"Exfiltration, Defense Evasion",T1535,"| tstats earliest(_time) as firstTime latest(_time) as lastTime values(All_Changes.object_id) as dest, count from datamodel=Change where All_Changes.action=created by All_Changes.vendor_region, All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| lookup previously_seen_cloud_regions vendor_region as vendor_region OUTPUTNEW firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenRegion=min(firstTimeSeen) 
| where isnull(firstTimeSeenRegion) OR firstTimeSeenRegion > relative_time(now(), ""-24h@h"") 
| table firstTime, user, dest, count , vendor_region 
| `security_content_ctime(firstTime)` 
| `cloud_compute_instance_created_in_previously_unused_region_filter`"
Cloud Compute Instance Created With Previously Unseen Image,"The following analytic detects the creation of cloud compute instances using previously unseen image IDs. It leverages cloud infrastructure logs to identify new image IDs that have not been observed before. This activity is significant because it may indicate unauthorized or suspicious activity, such as the deployment of malicious payloads or unauthorized access to sensitive information.",Windows Events,,,"| tstats count earliest(_time) as firstTime, latest(_time) as lastTime values(All_Changes.object_id) as dest from datamodel=Change where All_Changes.action=created by All_Changes.Instance_Changes.image_id, All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| `drop_dm_object_name(""Instance_Changes"")` 
| where image_id != ""unknown"" 
| lookup previously_seen_cloud_compute_images image_id as image_id OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenImage=min(firstTimeSeen) 
| where isnull(firstTimeSeenImage) OR firstTimeSeenImage > relative_time(now(), ""-24h@h"") 
| table firstTime, user, image_id, count, dest 
| `security_content_ctime(firstTime)` 
| `cloud_compute_instance_created_with_previously_unseen_image_filter`"
Cloud Compute Instance Created With Previously Unseen Instance Type,"The following analytic detects the creation of EC2 instances with previously unseen instance types. It leverages Splunk's tstats command to analyze data from the Change data model, identifying instance types that have not been previously recorded. This activity is significant for a SOC because it may indicate unauthorized or suspicious activity, such as an attacker attempting to create instances for malicious purposes.",Windows Events,Exfiltration,,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime values(All_Changes.object_id) as dest, count from datamodel=Change where All_Changes.action=created by All_Changes.Instance_Changes.instance_type, All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| `drop_dm_object_name(""Instance_Changes"")` 
| where instance_type != ""unknown"" 
| lookup previously_seen_cloud_compute_instance_types instance_type as instance_type OUTPUTNEW firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenInstanceType=min(firstTimeSeen) 
| where isnull(firstTimeSeenInstanceType) OR firstTimeSeenInstanceType > relative_time(now(), ""-24h@h"") 
| table firstTime, user, dest, count, instance_type 
| `security_content_ctime(firstTime)` 
| `cloud_compute_instance_created_with_previously_unseen_instance_type_filter`"
Cloud Instance Modified By Previously Unseen User,"The following analytic identifies cloud instances being modified by users who have not previously modified them. It leverages data from the Change data model, focusing on successful modifications of EC2 instances. This activity is significant because it can indicate unauthorized or suspicious changes by potentially compromised or malicious users. If confirmed malicious, this could lead to unauthorized access, configuration changes, or potential disruption of cloud services, posing a significant risk to the organization's cloud infrastructure.",Windows Events,Defense Evasion,T1078.004,"| tstats `security_content_summariesonly` count earliest(_time) as firstTime, latest(_time) as lastTime values(All_Changes.object_id) as object_id values(All_Changes.command) as command from datamodel=Change where All_Changes.action=modified All_Changes.change_type=EC2 All_Changes.status=success by All_Changes.user 
| `drop_dm_object_name(""All_Changes"")` 
| lookup previously_seen_cloud_instance_modifications_by_user user as user OUTPUTNEW firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenUser=min(firstTimeSeen) 
| where isnull(firstTimeSeenUser) OR firstTimeSeenUser > relative_time(now(), ""-24h@h"") 
| table firstTime user command object_id count 
| `security_content_ctime(firstTime)` 
| `cloud_instance_modified_by_previously_unseen_user_filter`"
Detect AWS Console Login by New User,The following analytic detects AWS console login events by new users. It leverages AWS CloudTrail events and compares them against a lookup file of previously seen users based on ARN values. This detection is significant because a new user logging into the AWS console could indicate the creation of new accounts or potential unauthorized access.,Azure AD (Microsoft Entra ID),"Credential Access, Exfiltration","T1586.003, T1552","| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user 
| `drop_dm_object_name(Authentication)` 
| join user type=outer [ 
| inputlookup previously_seen_users_console_logins 
| stats min(firstTime) as earliestseen by user] 
| eval userStatus=if(earliestseen >= relative_time(now(), ""-24h@h"") OR isnull(earliestseen), ""First Time Logging into AWS Console"", ""Previously Seen User"") 
| where userStatus=""First Time Logging into AWS Console"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_aws_console_login_by_new_user_filter`"
Microsoft Intune Mobile Apps,"Microsoft Intune supports deploying packaged applications to support software deployment, this functionality can also be abused for deploying malicious payloads to intune managed devices.",Microsoft Intune (Azure Monitor),"Lateral Movement, Execution, Command And Control, Defense Evasion","T1072, T1021.007, T1202, T1105","`azure_monitor_activity` operationName=""*MobileApp*"" 
| rename identity as user, properties.TargetObjectIds{} as TargetObjectId, properties.TargetDisplayNames{} as TargetDisplayName, properties.Actor.IsDelegatedAdmin as user_isDelegatedAdmin
| rex field=""operationName"" ""^(?P<action>\w+)\s"" 
| replace ""Patch"" with ""updated"", ""Create"" with ""created"", ""Delete"", with ""deleted"", ""assign"", with ""assigned"" IN action
| table _time operationName action user user_type user_isDelegatedAdmin TargetDisplayName TargetObjectId status tenantId correlationId
| `microsoft_intune_mobile_apps_filter`"
Disable Defender Enhanced Notification,"The following analytic detects the modification of the registry to disable Windows Defender's Enhanced Notification feature. It leverages data from Endpoint Detection and Response (EDR) agents, specifically monitoring changes to the registry path associated with Windows Defender reporting. This activity is significant because disabling Enhanced Notifications can prevent users and administrators from receiving critical security alerts, potentially allowing malicious activities to go unnoticed.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*Microsoft\\Windows Defender\\Reporting*"" Registry.registry_value_name = DisableEnhancedNotifications Registry.registry_value_data = 0x00000001) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_enhanced_notification_filter`"
Linux Auditd Auditd Service Stop,"The following analytic detects the suspicious auditd service stop. This behavior is critical for a SOC to monitor because it may indicate attempts to gain unauthorized access or maintain control over a system. Such actions could be signs of malicious activity. If confirmed, this could lead to serious consequences, including a compromised system, unauthorized access to sensitive data, or even a wider breach affecting the entire network.",Linux,"Execution, Impact, Persistence, Privilege Escalation",T1489,"`linux_auditd` type=SERVICE_STOP unit IN (""auditd"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type pid comm exe unit dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_auditd_auditd_service_stop_filter`"
Linux Auditd Disable Or Modify System Firewall,"The following analytic detects the suspicious disable or modify system firewall. This behavior is critical for a SOC to monitor because it may indicate attempts to gain unauthorized access or maintain control over a system. Such actions could be signs of malicious activity. If confirmed, this could lead to serious consequences, including a compromised system, unauthorized access to sensitive data, or even a wider breach affecting the entire network.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1562.004,"`linux_auditd` type=SERVICE_STOP unit IN (""firewalld"", ""ufw"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type pid comm exe unit dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_disable_or_modify_system_firewall_filter`"
Linux Auditd Osquery Service Stop,"The following analytic detects suspicious stopping of the osquery service, which may indicate an attempt to disable monitoring and evade detection. Osquery is a powerful tool used for querying system information and detecting anomalies, and stopping its service can be a sign that an attacker is trying to disrupt security monitoring or hide malicious activities.",Linux,"Execution, Impact, Persistence, Privilege Escalation",T1489,"`linux_auditd` type=SERVICE_STOP unit IN (""osqueryd"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type pid comm exe unit dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_auditd_osquery_service_stop_filter`"
Linux Auditd Stop Services,"The following analytic detects attempts to stop a service on Linux systems. It leverages data from Linux Auditd. This activity is significant as adversaries often stop or terminate security or critical services to disable defenses or disrupt operations, as seen in malware like Industroyer2. If confirmed malicious, this could lead to the disabling of security mechanisms, allowing attackers to persist, escalate privileges, or deploy destructive payloads, severely impacting system integrity and availability.",Linux,"Execution, Impact",T1489,"`linux_auditd` type=SERVICE_STOP 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type pid comm exe dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `linux_auditd_stop_services_filter`"
Linux Auditd Sysmon Service Stop,"The following analytic detects the suspicious sysmon service stop. This behavior is critical for a SOC to monitor because it may indicate attempts to gain unauthorized access or maintain control over a system. Such actions could be signs of malicious activity. If confirmed, this could lead to serious consequences, including a compromised system, unauthorized access to sensitive data, or even a wider breach affecting the entire network.",Linux,"Execution, Impact, Persistence, Privilege Escalation",T1489,"`linux_auditd` type=SERVICE_STOP unit IN (""sysmon"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type pid comm exe unit dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_auditd_sysmon_service_stop_filter`"
PaperCut NG Suspicious Behavior Debug Log,"The following analytic identifies potential exploitation attempts on a PaperCut NG server by analyzing its debug log data. It detects unauthorized or suspicious access attempts from public IP addresses and searches for specific URIs associated with known exploits. The detection leverages regex to parse unstructured log data, focusing on admin login activities. This activity is significant as it can indicate an active exploitation attempt on the server.",PaperCut NG,Initial Access,"T1190, T1133","`papercutng` (loginType=Admin OR userName=admin) 
| eval uri_match=if(match(_raw, ""(?i)(\/app\?service=page\/SetupCompleted
|\/app
|\/app\?service=page\/PrinterList
|\/app\?service=direct\/1\/PrinterList\/selectPrinter&sp=l1001
|\/app\?service=direct\/1\/PrinterDetails\/printerOptionsTab\.tab)""), ""URI matches"", null()) 
| eval ip_match=if(match(_raw, ""(?i)((25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?))"") AND NOT match(_raw, ""(?i)(10\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?))
|(172\.(1[6-9]
|2[0-9]
|3[0-1])\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?))
|(192\.168\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?)\.(25[0-5]
|2[0-4][0-9]
|[01]?[0-9][0-9]?))""), ""IP matches"", null()) 
| where  (isnotnull(uri_match) OR isnotnull(ip_match)) 
| stats sparkline, count, values(uri_match) AS uri_match, values(ip_match) AS ip_match latest(_raw) BY host, index, sourcetype 
| `papercut_ng_suspicious_behavior_debug_log_filter`"
Print Processor Registry Autostart,The following analytic detects suspicious modifications or new entries in the Print Processor registry path. It leverages registry activity data from the Endpoint data model to identify changes in the specified registry path. This activity is significant because the Print Processor registry is known to be exploited by APT groups like Turla for persistence and privilege escalation.,Windows Events,"Persistence, Privilege Escalation","T1547, T1547.012","| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path =""*\\Control\\Print\\Environments\\Windows x64\\Print Processors*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `print_processor_registry_autostart_filter`"
Windows Driver Inventory,"The following analytic identifies drivers being loaded across the fleet. It leverages a PowerShell script input deployed to critical systems to capture driver data. This detection is significant as it helps monitor for unauthorized or malicious drivers that could compromise system integrity. If confirmed malicious, such drivers could allow attackers to execute arbitrary code, escalate privileges, or maintain persistence within the environment.",Windows Events,"Persistence, Privilege Escalation",T1068,"`driverinventory` 
| stats values(Path) min(_time) as firstTime max(_time) as lastTime count by host DriverType 
| rename host as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_driver_inventory_filter`"
Windows Rundll32 WebDav With Network Connection,"The following analytic detects the execution of rundll32.exe with command-line arguments loading davclnt.dll and the davsetcookie function to access a remote WebDav instance. It uses data from Endpoint Detection and Response (EDR) agents, correlating process execution and network traffic data. This activity is significant as it may indicate exploitation of CVE-2023-23397, a known vulnerability.",Windows Events,"Execution, Exfiltration",T1048.003,"| tstats `security_content_summariesonly` count 
min(_time) as firstTime 
max(_time) as lastTime 
FROM datamodel=Endpoint.Processes where 
Processes.parent_process_name=svchost.exe
`process_rundll32` 
Processes.process IN (
""*\\windows\\system32\\davclnt.dll,*davsetcookie*"", 
""*\\windows\\syswow64\\davclnt.dll,*davsetcookie*"") 
by host _time span=1h 
Processes.action Processes.dest Processes.original_file_name Processes.parent_process 
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id 
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec 
Processes.process_guid Processes.process_hash  Processes.process_id Processes.process_integrity_level 
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| rename dest as src 
| join host process_id
[
| tstats `security_content_summariesonly` count 
latest(All_Traffic.dest) as dest
latest(All_Traffic.dest_ip) as dest_ip 
latest(All_Traffic.dest_port) as dest_port
FROM datamodel=Network_Traffic.All_Traffic where 
All_Traffic.dest_port!=0 
NOT (All_Traffic.dest_ip IN (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)) 
by host All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out
All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port
All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction
All_Traffic.process_id
| `drop_dm_object_name(All_Traffic)`
] 
| `windows_rundll32_webdav_with_network_connection_filter`"
Windows RunMRU Command Execution,"The following analytic detects modifications to the Windows RunMRU registry key, which stores a history of commands executed through the Run dialog box (Windows+R). It leverages Endpoint Detection and Response (EDR) telemetry to monitor registry events targeting this key. This activity is significant as malware often uses the Run dialog to execute malicious commands while attempting to appear legitimate.",Windows Events,"Execution, Persistence, Defense Evasion",T1202,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU*"" NOT Registry.registry_value_name=""MRUList"" NOT Registry.registry_value_data=""unknown"" by Registry.dest Registry.registry_value_data Registry.action Registry.process_guid Registry.process_id Registry.registry_key_name Registry.user Registry.registry_path Registry.registry_hive Registry.registry_value_name Registry.status Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_runmru_command_execution_filter`"
Windows Vulnerable Driver Loaded,"The following analytic detects the loading of known vulnerable Windows drivers, which may indicate potential persistence or privilege escalation attempts. It leverages Sysmon EventCode 6 to identify driver loading events and cross-references them with a list of vulnerable drivers. This activity is significant as attackers often exploit vulnerable drivers to gain elevated privileges or maintain persistence on a system.",Windows Events,"Execution, Exfiltration, Persistence, Privilege Escalation",T1543.003,"`sysmon` EventCode=6 
| stats  min(_time) as firstTime max(_time) as lastTime count by ImageLoaded dest dvc process_hash process_path signature signature_id user_id vendor_product 
| lookup loldrivers driver_name AS ImageLoaded OUTPUT is_driver driver_description 
| search is_driver = TRUE 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_vulnerable_driver_loaded_filter`"
Windows WinLogon with Public Network Connection,"The following analytic detects instances of Winlogon.exe, a critical Windows process, connecting to public IP addresses. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on network connections made by Winlogon.exe. Under normal circumstances, Winlogon.exe should not connect to public IPs, and such activity may indicate a compromise, such as the BlackLotus bootkit attack.",Windows Events,"Execution, Persistence, Defense Evasion",T1542.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (winlogon.exe) Processes.process!=unknown by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| join process_id [
| tstats `security_content_summariesonly` count FROM datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port != 0 NOT (All_Traffic.dest IN (127.0.0.1,10.0.0.0/8,172.16.0.0/12, 192.168.0.0/16, 0:0:0:0:0:0:0:1)) by All_Traffic.process_id All_Traffic.dest All_Traffic.dest_port 
| `drop_dm_object_name(All_Traffic)` 
| rename dest as publicIp ] 
| table dest parent_process_name process_name process_path process process_id dest_port publicIp 
| `windows_winlogon_with_public_network_connection_filter`"
Detect Outbound SMB Traffic,"The following analytic detects outbound SMB (Server Message Block) connections from internal hosts to external servers. It identifies this activity by monitoring network traffic for SMB requests directed towards the Internet, which are unusual for standard operations. This detection is significant for a SOC as it can indicate an attacker's attempt to retrieve credential hashes through compromised servers, a key step in lateral movement and privilege escalation.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Lateral Movement, Command And Control, Privilege Escalation",T1071.002,"| tstats `security_content_summariesonly` 
earliest(_time) as start_time 
latest(_time) as end_time 
values(All_Traffic.action) as action 
values(All_Traffic.app) as app
values(sourcetype) as sourcetype count 
from datamodel=Network_Traffic where
All_Traffic.action IN (""allowed"", ""allow"") AND
(All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=""smb"")
AND All_Traffic.src_ip IN (
""10.0.0.0/8"",""172.16.0.0/12"",""192.168.0.0/16""
) 
AND NOT All_Traffic.dest_ip IN (
""10.0.0.0/8"", ""172.16.0.0/12"", ""192.168.0.0/16"", ""100.64.0.0/10"", 
""127.0.0.0/8"", ""169.254.0.0/16"", ""192.0.0.0/24"", ""192.0.0.0/29"", ""192.0.0.8/32"", 
""192.0.0.9/32"", ""192.0.0.10/32"", ""192.0.0.170/32"", ""192.0.0.171/32"", ""192.0.2.0/24"", 
""192.31.196.0/24"", ""192.52.193.0/24"", ""192.88.99.0/24"", ""224.0.0.0/4"", ""192.175.48.0/24"", 
""198.18.0.0/15"", ""198.51.100.0/24"", ""203.0.113.0/24"", ""240.0.0.0/4"", ""::1""
)
by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out
All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol
All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port
All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.rule 
| `drop_dm_object_name(""All_Traffic"")`  
| `security_content_ctime(start_time)`  
| `security_content_ctime(end_time)` 
| iplocation dest_ip 
| `detect_outbound_smb_traffic_filter`"
Linux Auditd Auditd Daemon Abort,"The following analytic detects the abnormal termination of the Linux audit daemon (auditd) by identifying DAEMON_ABORT events in audit logs. These terminations suggest a serious failure of the auditing subsystem, potentially due to resource exhaustion, corruption, or malicious interference. Unlike a clean shutdown, DAEMON_ABORT implies that audit logging may have been disabled without system administrator intent.",Linux,"Execution, Impact, Defense Evasion",T1562.012,"`linux_auditd` type=DAEMON_ABORT 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type op res uid dest pid 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_auditd_daemon_abort_filter`"
Linux Auditd Auditd Daemon Shutdown,"The following analytic detects the unexpected termination of the Linux Audit daemon (auditd) by monitoring for log entries of type DAEMON_END. This event signifies that the audit logging service has stopped, either due to a legitimate system shutdown, manual administrative action, or potentially malicious tampering. Since auditd is responsible for recording critical security events, its sudden stoppage may indicate an attempt to disable security monitoring or evade detection during an attack.",Linux,"Execution, Defense Evasion",T1562.012,"`linux_auditd` type=DAEMON_END 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type op res auid dest pid 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_auditd_daemon_shutdown_filter`"
Linux Auditd Auditd Daemon Start,"The following analytic detects the (re)initialization of the Linux audit daemon (auditd) by identifying log entries of type DAEMON_START. This event indicates that the audit subsystem has resumed logging after being stopped or has started during system boot. While DAEMON_START may be expected during reboots or legitimate configuration changes, it can also signal attempts to re-enable audit logging after evasion, or restarts with modified or reduced rule sets.",Linux,"Execution, Defense Evasion",T1562.012,"`linux_auditd` type=DAEMON_START 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by type op res auid dest pid 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_auditd_daemon_start_filter`"
Geographic Improbable Location,Geolocation data can be inaccurate or easily spoofed by Remote Employment Fraud (REF) workers.,Palo Alto Firewall,Defense Evasion,T1078,"| tstats summariesonly=true values(Authentication.app) as app from datamodel=Authentication.Authentication where (`okta` OR (index=""firewall"" AND sourcetype=""pan:globalprotect"")) AND Authentication.action=""success"" AND Authentication.app IN (""Workday"", ""Slack"", ""*GlobalProtect"", ""Jira*"", ""Atlassian Cloud"", ""Zoom"") AND NOT Authentication.user=""unknown"" by _time index sourcetype host Authentication.user Authentication.src span=1s 
| `drop_dm_object_name(""Authentication"")` 
| fields user,src,app,_time,count,host 
| eval user=lower(replace(user, ""((^.*\\\)
|(@.*$))"", """")) 
| join type=outer user [
| inputlookup identity_lookup_expanded where user_status=active 
| rex field=email ""^(?<user>[a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})$"" 
| rename email as user_email bunit as user_bunit priority as user_priority work_country as user_work_country work_city as user_work_city 
| fields user user_email user_bunit user_priority user_work_country user_work_city] 
| eventstats dc(src) as src_count by user 
| eventstats dc(user) as user_count by src 
| sort 0 + _time 
| iplocation src 
| lookup local=true asn_lookup_by_cidr ip as src OUTPUT ip asn description 
| eval session_lat=if(isnull(src_lat), lat, src_lat), session_lon=if(isnull(src_long), lon, src_long), session_city=if(isnull(src_city), City, src_city), session_country=if(isnull(src_country), Country, src_country), session_region=if(isnull(src_region), Region, src_region) 
| eval session_city=if(isnull(session_city) OR match(session_city,""^\s+
|^$""), null(), session_city), session_country=if(isnull(session_country) OR match(session_country,""^\s+
|^$""), null(), session_country), session_region=if(isnull(session_region) OR match(session_region,""^\s+
|^$""), null(), session_region) 
| where isnotnull(session_lat) and isnotnull(session_lon) 
| eval session_city=if(isnull(session_city),""-"",session_city), session_country=if(isnull(session_country),""-"",session_country), session_region=if(isnull(session_region),""-"",session_region) 
| streamstats current=t window=2 earliest(session_region) as prev_region,earliest(session_lat) as prev_lat, earliest(session_lon) as prev_lon, earliest(session_city) as prev_city, earliest(session_country) as prev_country, earliest(_time) as prev_time, earliest(src) as prev_src, latest(user_bunit) as user_bunit, earliest(app) as prev_app values(user_work_country) as user_work_country by user 
| where (src!=prev_src) AND !(prev_city=session_city AND prev_country=session_country) AND ((isnotnull(prev_city) AND isnotnull(session_city)) OR prev_country!=session_country) 
| `globedistance(session_lat,session_lon,prev_lat,prev_lon,""m"")` 
| eval time_diff=if((_time-prev_time)==0, 1, _time - prev_time) 
| eval speed = round(distance*3600/time_diff,2) 
| eval distance= round(distance,2) 
| eval user_work_country=case(user_work_country=""usa"",""United States"", user_work_country=""cze"",""Czechia"", user_work_country=""pol"",""Poland"", user_work_country=""ind"",""India"", user_work_country=""fra"",""France"", user_work_country=""can"",""Canada"", user_work_country=""mys"",""Malaysia"", user_work_country=""kor"",""South Korea"", user_work_country=""aus"",""Australia"", user_work_country=""bel"",""Belgium"", user_work_country=""dnk"",""Denmark"", user_work_country=""bra"",""Brazil"", user_work_country=""deu"",""Germany"", user_work_country=""jpn"",""Japan"", user_work_country=""che"",""Switzerland"", user_work_country=""swe"",""Sweden"", user_work_country=""zaf"",""South Africa"", user_work_country=""irl"",""Ireland"", user_work_country=""ita"",""Italy"", user_work_country=""nor"",""Norway"", user_work_country=""gbr"",""United Kingdom"", user_work_country=""hkg"",""Hong Kong"", user_work_country=""chn"",""China"", user_work_country=""esp"",""Spain"", user_work_country=""nld"", ""Netherlands"", user_work_country=""twn"",""Taiwan"", user_work_country=""est"",""Estonia"", user_work_country=""sgp"",""Singapore"", user_work_country=""are"",""United Arab Emirates"", 1=1,""N/A"") 
| lookup local=true asn_lookup_by_cidr ip as prev_src OUTPUT ip as prev_ip asn as prev_asn description as prev_description 
| eval suspect=if(!user_work_country==session_country,""Sketchy"",""Normal"") 
| search (speed>500 AND distance>750) 
| table _time,prev_time,user,host,src,prev_src,app,prev_app,distance,speed,suspect,session_city,session_region, session_country,prev_city,prev_region,prev_country,user_priority,user_work_*,prev_ip,ip,asn,prev_asn,prev_description,description 
| rename _time as event_time 
| convert ctime(event_time) timeformat=""%Y-%m-%d %H:%M:%S"" 
| convert ctime(prev_time) timeformat=""%Y-%m-%d %H:%M:%S"" 
| eval problem=if(!session_country==prev_country AND (!session_country==user_work_country),""Yes"",""Nope"") 
| search NOT (prev_city=""-"" OR session_city=""-"") AND NOT [inputlookup known_devices_public_ip_filter.csv 
| fields ip 
| rename ip as src] 
| dedup user host prev_src src 
| fillnull value=""N/A"" 
| search problem=""Yes""
| `geographic_improbable_location_filter`"
Okta Non-Standard VPN Usage,Remote Employment Fraud (REF) actors will often use virtual private networks (VPNs) to conceal their true physical location.,Okta,"Initial Access, Persistence, Command And Control, Defense Evasion","T1090, T1572, T1078","`okta` debugContext.debugData.tunnels IN (*Astrill*,*Azire*,*CyberGhost*,*Express*VPN,*HideMe*, *IPVanish*,*Mullvad*,*Nord*VPN*,*OVPN*,*PIA*VPN*,*Proton*VPN*,*Pure*VPN*,*Slick*VPN*,*Surf*Easy*, *SurfShark*,*Star*VPN*,*TorGuard*,*TorProxy*,*Tiger*VPN*,*TunnelBear*,*Unblock*VPN*,*Warp*VPN*,*WarpSpeed*, *VPNReactor*,*VPN*Shield*,*VPN*Super*VPN*,*ZenMate*) ```listing of commonly used known VPN providers. Add or remove whatever is appropriate for your environment``` 
| eval user=coalesce('actor.alternateId',user), user=mvindex(split(user, ""@""), 0) 
| rename targetUserAlternateId as user client.* as * request.* as * ipChain{}.* as * geographicalContext.* as * debugContext.* as * debugData.* as * 
| eval status=case(match(_raw, ""FAILURE""), ""failure"", !match(_raw, ""FAILURE""), ""success"") 
| stats count values(status) as status max(published) as UTC min(_time) as firsttime max(_time) as lasttime values(target_data) as target_data values(displayMessage) as displayMessage values(eventType) as eventType values(city) as city values(country) as country values(action) as action values(src_ip) as src_ip values(outcome.*) as * values(user) as user by tunnels,_time,host sourcetype index 
| fillnull value=""N/A"" 
| convert ctime(*ttime) 
| `okta_non_standard_vpn_usage_filter`"
Zoom High Video Latency,Detects particularly high latency from Zoom logs.,Zoom,Defense Evasion,T1078,"`zoom_index` 
| spath ""payload.object.participant.qos{}.type"" 
| search ""payload.object.participant.qos{}.type""=video_input 
| rename payload.object.participant.qos{}.details.avg_latency as avg_latency ""payload.object.participant.qos{}.details.latency"" as latency payload.object.participant.email as email 
| rex field=avg_latency ""(?<average_latency>\d+) ms"" 
| rex field=latency ""(?<overall_latency>\d+) ms"" 
| search email=""*"" 
| table email overall_latency latency avg_latency average_latency _raw 
| stats latest(overall_latency) as overall_latency by email _raw 
| where overall_latency>300 
| `zoom_high_video_latency_filter`"
Zoom Rare Audio Devices,Detects rare audio devices from Zoom logs.,Zoom,Collection,T1123,"`zoom_index` speaker=* NOT (camera=*iPhone* OR camera=""*FaceTime*"" OR speaker=""*AirPods*"" OR camera=""*MacBook*"" OR microphone=""*MacBook Pro Microphone*"") 
| rare speaker limit=50 
| `zoom_rare_audio_devices_filter`"
Zoom Rare Input Devices,Detects rare input devices from Zoom logs.,Zoom,Collection,T1123,"`zoom_index` microphone=* NOT (camera=*iPhone* OR camera=""*FaceTime*"" OR speaker=""*AirPods*"" OR camera=""*MacBook*"" OR microphone=""*MacBook Pro Microphone*"") 
| rare microphone limit=50 
| `zoom_rare_input_devices_filter`"
Zoom Rare Video Devices,Detects rare video devices from Zoom logs.,Zoom,Collection,T1123,"`zoom_index` camera=* NOT (camera=*iPhone* OR camera=""*FaceTime*"" OR speaker=""*AirPods*"" OR camera=""*MacBook*"" OR microphone=""*MacBook Pro Microphone*"") 
| rare camera limit=50 
| `zoom_rare_video_devices_filter`"
Detect Renamed 7-Zip,"The following analytic detects the usage of a renamed 7-Zip executable using Sysmon data. It leverages the OriginalFileName field to identify instances where the 7-Zip process has been renamed. This activity is significant as attackers often rename legitimate tools to evade detection while staging or exfiltrating data. If confirmed malicious, this behavior could indicate data exfiltration attempts or other unauthorized data manipulation, potentially leading to significant data breaches or loss of sensitive information.",Windows Events,"Collection, Execution, Exfiltration",T1560.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.original_file_name=7z*.exe AND Processes.process_name!=7z*.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_renamed_7_zip_filter`"
Windows DNS Query Request To TinyUrl,"The following analytic detects a process located in a potentially suspicious location making DNS queries to known URL shortening services, specifically tinyurl. URL shorteners are frequently used by threat actors to obfuscate malicious destinations, including phishing pages, malware distribution sites, or command-and-control (C2) endpoints. While tinyurl.com is a legitimate service, its use in enterprise environmentsâ€”particularly by non-browser processes or scriptsâ€”should be considered suspicious, especially if correlated with subsequent outbound connections, file downloads, process file path or credential prompts.",Windows Events,"Command And Control, Execution",T1105,"`sysmon` 
EventCode=22 
QueryName = ""tinyurl.com""
Image IN (
""*\\AppData\\*"",
""*\\Perflogs\\*"",
""*\\ProgramData\\*"",
""*\\Temp\\*"",
""*\\Users\\Public\\*"",
""*\\Windows\\Tasks\\*""
) 
| stats count min(_time) as firstTime max(_time) as lastTime 
by answer answer_count dvc process_exec process_guid process_name query query_count 
reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dns_query_request_to_tinyurl_filter`"
Hiding Files And Directories With Attrib exe,"The following analytic detects the use of the Windows binary attrib.exe to hide files or directories by marking them with specific flags. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line arguments that include the &quot;+h&quot; flag. This activity is significant because hiding files can be a tactic used by attackers to conceal malicious files or tools from users and security software.",Windows Events,"Execution, Exfiltration, Persistence, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly` count min(_time) values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=attrib.exe (Processes.process=*+h*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)` 
|`hiding_files_and_directories_with_attrib_exe_filter`"
Windows Chromium Browser No Security Sandbox Process,"The following analytic detects instances where a Chrome or Chromium-based browser is launched with the --no-sandbox flag, a known indicator of potentially malicious or suspicious behavior. While this flag is occasionally used during software development or testing, it is rarely seen in normal user activity. Threat actors often abuse this setting to disable Chrome's built-in security sandbox, making it easier to execute malicious code or escape browser isolation.",Windows Events,"Command And Control, Defense Evasion",T1497,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
Processes.process_name IN (""Chrome.exe"",""Brave.exe"", ""Opera.exe"", ""Vivaldi.exe"", ""msedge.exe"")
Processes.process = ""*--no-sandbox*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_chromium_browser_no_security_sandbox_process_filter`"
Windows Disable Internet Explorer Addons,"The following analytic detects the execution of iexplore.exe (Internet Explorer) with the -extoff command-line flag, which disables all browser extensions. This flag is commonly abused by adversaries to launch a clean browser session that bypasses security controls such as antivirus browser extensions, toolbars, or group policy-enforced add-ons. Malicious documents or scripts may leverage iexplore.",Windows Events,"Execution, Persistence",T1176.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time)
as lastTime from datamodel=Endpoint.Processes where 
(Processes.process_name = ""iexplore.exe"" OR Processes.original_file_name=""IEXPLORE.EXE"")
Processes.process = ""*-extoff*"" 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_internet_explorer_addons_filter`"
Windows DLL Search Order Hijacking Hunt with Sysmon,The following analytic identifies potential DLL search order hijacking or DLL sideloading by detecting known Windows libraries loaded from non-standard directories. It leverages Sysmon EventCode 7 to monitor DLL loads and cross-references them with a lookup of known hijackable libraries. This activity is significant as it may indicate an attempt to execute malicious code by exploiting DLL search order vulnerabilities.,Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"`sysmon` EventCode=7 NOT (process_path IN (""*\\system32\\*"", ""*\\syswow64\\*"",""*\\winsxs\\*"",""*\\wbem\\*"")) 
| lookup hijacklibs library AS loaded_file OUTPUT islibrary 
| search islibrary = True 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dll_search_order_hijacking_hunt_with_sysmon_filter`"
ESXi System Clock Manipulation,"This detection identifies a significant change to the system clock on an ESXi host, which may indicate an attempt to manipulate timestamps and evade detection or forensic analysis
Search 1`esxi_syslog` Message=&#34;*NTPClock*&#34; AND Message=&#34;*system clock stepped*&#34; 2| rex field=_raw &#34;stepped to (?&lt;epoch_time&gt;\d+\.\d+),.+delta\s(?&lt;delta&gt;\d+)\s&#34; 3| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 4| eval epoch_time=tonumber(epoch_time) 5| eval delta=tonumber(delta) 6| eval event_time=round(_time, 0) 7| eval direction=if(epoch_time &lt; event_time, &#34;backward&#34;, &#34;forward&#34;) 8| eval original_time=if(direction==&#34;backward&#34;, epoch_time + delta, epoch_time - delta) 9| eval stepped_to_str=strftime(epoch_time, &#34;%Y-%m-%d %H:%M:%S&#34;) 10| eval original_time_str=strftime(original_time, &#34;%Y-%m-%d %H:%M:%S&#34;) 11| stats min(_time) as firstTime max(_time) as lastTime count by dest direction original_time_str stepped_to_str epoch_time delta 12| `security_content_ctime(firstTime)` 13| `security_content_ctime(lastTime)` 14| `esxi_system_clock_manipulation_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_system_clock_manipulation_filter search * esxi_system_clock_manipulation_filter is an empty macro by default.",VMware ESXi,Defense Evasion,T1070.006,"`esxi_syslog` Message=""*NTPClock*"" AND Message=""*system clock stepped*"" 
| rex field=_raw ""stepped to (?<epoch_time>\d+\.\d+),.+delta\s(?<delta>\d+)\s"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| eval epoch_time=tonumber(epoch_time) 
| eval delta=tonumber(delta) 
| eval event_time=round(_time, 0) 
| eval direction=if(epoch_time < event_time, ""backward"", ""forward"") 
| eval original_time=if(direction==""backward"", epoch_time + delta, epoch_time - delta) 
| eval stepped_to_str=strftime(epoch_time, ""%Y-%m-%d %H:%M:%S"") 
| eval original_time_str=strftime(original_time, ""%Y-%m-%d %H:%M:%S"") 
| stats min(_time) as firstTime max(_time) as lastTime count by dest direction original_time_str stepped_to_str epoch_time delta 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_system_clock_manipulation_filter`"
Windows MSIExec DLLRegisterServer,"The following analytic detects the execution of msiexec.exe with the /y switch parameter, which enables the loading of DLLRegisterServer. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments and parent-child process relationships. This activity is significant because it can indicate an attempt to register malicious DLLs, potentially leading to code execution or persistence on the system.",Windows Events,"Execution, Persistence, Defense Evasion, Discovery, Exfiltration",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_msiexec` Processes.process IN (""* /y*"", ""* -y*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msiexec_dllregisterserver_filter`"
Windows Process Commandline Discovery,"The following analytic detects the use of Windows Management Instrumentation Command-line (WMIC) to retrieve information about running processes, specifically targeting the command lines used to launch those processes. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on logs containing process details and command-line executions. This activity is significant as it may indicate suspicious behavior, such as a user or process gathering detailed process information, which is uncommon for non-technical users.",Windows Events,"Lateral Movement, Execution, Discovery",T1057,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` Processes.process= ""* process *"" Processes.process= ""* get *"" Processes.process= ""*CommandLine*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_commandline_discovery_filter`"
ESXi User Granted Admin Role,"This detection identifies when a user is granted the Administrator role on an ESXi host. Assigning elevated privileges is a critical action that can indicate potential malicious behavior if performed unexpectedly. Adversaries who gain access may use this to escalate privileges, maintain persistence, or disable security controls.
Search 1`esxi_syslog` Message=&#34;*esxcli system permission set*&#34; AND Message=&#34;*role Admin*&#34; 2| rex field=_raw &#34;\]: \[(?",VMware ESXi,"Discovery, Persistence, Privilege Escalation","T1098, T1078","`esxi_syslog` Message=""*esxcli system permission set*"" AND Message=""*role Admin*"" 
| rex field=_raw ""\]: \[(?<user>\w+)\]:(?<command>.+)"" 
| rex field=_raw ""--id (?<target_user>\w+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command target_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_user_granted_admin_role_filter`"
ESXi VM Exported via Remote Tool,"This detection identifies the use of a remote tool to download virtual machine disk files from a datastore. The NFC protocol is used by management tools to transfer files to and from ESXi hosts, but it can also be abused by attackers or insiders to exfiltrate full virtual disk images
Search 1`esxi_syslog` Message=&#34;*File download from path*&#34; Message=&#34;*was initiated from*&#34; 2| rex field=_raw &#34;from path &#39;\[(?",VMware ESXi,Collection,T1005,"`esxi_syslog` Message=""*File download from path*"" Message=""*was initiated from*"" 
| rex field=_raw ""from path '\[(?<Datastore>[^\]]+)\](?<VMPath>[^']+)'"" 
| rex field=_raw ""initiated from '(?<InitiatorTool>[^/]+)/(?<ToolVersion>[^@]+)@(?<InitiatorIP>\d{1,3}(?:\.\d{1,3}){3})'"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by Datastore VMPath InitiatorTool ToolVersion InitiatorIP dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_vm_exported_via_remote_tool_filter`"
First Time Seen Child Process of Zoom,The following analytic identifies the first-time execution of child processes spawned by Zoom (zoom.,Zoom,"Discovery, Execution, Privilege Escalation, Exfiltration",T1068,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime values(Processes.user) as user values(Processes.action) as action values(Processes.dest) as dest values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product from datamodel=Endpoint.Processes where (Processes.parent_process_name=zoom.exe OR Processes.parent_process_name=zoom.us) by Processes.process_id Processes.dest 
| `drop_dm_object_name(Processes)` 
| lookup zoom_first_time_child_process dest as dest process_name as process_name OUTPUT firstTimeSeen 
| where isnull(firstTimeSeen) OR firstTimeSeen > relative_time(now(), ""`previously_seen_zoom_child_processes_window`"") 
| `security_content_ctime(firstTime)` 
| `first_time_seen_child_process_of_zoom_filter`"
ESXi System Information Discovery,"This detection identifies the use of ESXCLI system-level commands that retrieve configuration details. While used for legitimate administration, this behavior may also indicate adversary reconnaissance aimed at profiling the ESXi host's capabilities, build information, or system role in preparation for further compromise.
Search 1`esxi_syslog` Message=&#34;*system*&#34; AND Message=&#34;*esxcli*&#34; AND Message IN (&#34;*get*&#34;,&#34;*list*&#34;) AND Message=&#34;*user=*&#34; NOT Message=&#34;*filesystem*&#34; 2| rex field=_raw &#34;user=(?",VMware ESXi,Discovery,T1082,"`esxi_syslog` Message=""*system*"" AND Message=""*esxcli*"" AND Message IN (""*get*"",""*list*"") AND Message=""*user=*"" NOT Message=""*filesystem*"" 
| rex field=_raw ""user=(?<user>\w+)\]\s+Dispatch\s+(?<command>[^\s]+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_system_information_discovery_filter`"
ESXi External Root Login Activity,"This detection identifies instances where the ESXi UI is accessed using the root account instead of a delegated administrative user. Direct root access to the UI bypasses role-based access controls and auditing practices, and may indicate risky behavior, misconfiguration, or unauthorized activity by a malicious actor using compromised credentials.
Search 1`esxi_syslog` Message=&#34;*root*&#34; AND Message=&#34;*logged in*&#34; 2| rex field=_raw &#34;root@(?",VMware ESXi,"Discovery, Defense Evasion",T1078,"`esxi_syslog` Message=""*root*"" AND Message=""*logged in*"" 
| rex field=_raw ""root@(?<SrcIpAddr>\d{1,3}(?:\.\d{1,3}){3})"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| search SrcIpAddr != ""127.0.0.1"" AND SrcIpAddr != 192.168.0.0/16 AND SrcIpAddr != 172.16.0.0/12 AND SrcIpAddr != 10.0.0.0/8 
| stats min(_time) as firstTime max(_time) as lastTime count by dest SrcIpAddr 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_external_root_login_activity_filter`"
ESXi Loghost Config Tampering,"This detection identifies changes to the syslog loghost configuration on an ESXi host, which may indicate an attempt to disrupt log forwarding and evade detection.
Search 1`esxi_syslog` Message=&#34;*Set called with key*&#34; AND Message IN (&#34;*Syslog.global.logHost*&#34;,&#34;*Syslog.global.logdir*&#34;) 2| rex field=_raw &#34;key &#39;(?&lt;key&gt;[^&#39;]+)&#39;, value &#39;\&#34;(?&lt;value&gt;[^\&#34;]+)\&#34;&#39;&#34; 3| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 4| stats min(_time) as firstTime max(_time) as lastTime count by dest key value 5| `security_content_ctime(firstTime)` 6| `security_content_ctime(lastTime)` 7| `esxi_loghost_config_tampering_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_loghost_config_tampering_filter search * esxi_loghost_config_tampering_filter is an empty macro by default.",VMware ESXi,Defense Evasion,T1562,"`esxi_syslog` Message=""*Set called with key*"" AND Message IN (""*Syslog.global.logHost*"",""*Syslog.global.logdir*"") 
| rex field=_raw ""key '(?<key>[^']+)', value '\""(?<value>[^\""]+)\""'"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest key value 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_loghost_config_tampering_filter`"
ESXi Syslog Config Change,"This detection identifies changes to the syslog configuration on an ESXi host using esxcli, which may indicate an attempt to disrupt log collection and evade detection.
Search 1`esxi_syslog` Message=&#34;*syslog config set*&#34; AND Message=&#34;*esxcli*&#34; 2| rex field=_raw &#34;\].*\[\s*(?P&lt;user&gt;[^\]]+)\]:\s(?P&lt;command&gt;.+)&#34; 3| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 4| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 5| `security_content_ctime(firstTime)` 6| `security_content_ctime(lastTime)` 7| `esxi_syslog_config_change_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_syslog_config_change_filter search * esxi_syslog_config_change_filter is an empty macro by default.",VMware ESXi,"Collection, Defense Evasion",T1562.003,"`esxi_syslog` Message=""*syslog config set*"" AND Message=""*esxcli*"" 
| rex field=_raw ""\].*\[\s*(?P<user>[^\]]+)\]:\s(?P<command>.+)"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user command 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_syslog_config_change_filter`"
ESXi Bulk VM Termination,"This detection identifies when all virtual machines on an ESXi host are abruptly terminated, which may indicate malicious activity such as a deliberate denial-of-service, ransomware staging, or an attempt to destroy critical workloads.
Search 1`esxi_syslog` 2| rex field=_raw &#34;\s\[(?&lt;user&gt;[^\]]+)\]:\s(?&lt;shell_command&gt;.+)$&#34; 3| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s.*:\s(?&lt;esxicli_Command&gt;esxcli\s.+)&#34; 4| eval command=mvappend(esxicli_Command, shell_Command) 5| where isnotnull(command) 6| search (command=&#34;pkill -9 vmx-*&#34;) OR ( command=&#34;*esxcli*&#34; AND command=&#34;*--format-param*&#34; AND command=&#34;*vm process list*&#34; AND command=&#34;*awk*&#34; AND command=&#34;*esxcli vm process kill*&#34;) 7| stats min(_time) as firstTime max(_time) as lastTime values(_time) as timeStamp values(command) as commands values(user) as user by dest 8| `security_content_ctime(firstTime)` 9| `security_content_ctime(lastTime)` 10| `esxi_bulk_vm_termination_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_bulk_vm_termination_filter search * esxi_bulk_vm_termination_filter is an empty macro by default.",VMware ESXi,"Impact, Discovery","T1529, T1673, T1499","`esxi_syslog` 
| rex field=_raw ""\s\[(?<user>[^\]]+)\]:\s(?<shell_command>.+)$"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s.*:\s(?<esxicli_Command>esxcli\s.+)"" 
| eval command=mvappend(esxicli_Command, shell_Command) 
| where isnotnull(command) 
| search (command=""pkill -9 vmx-*"") OR ( command=""*esxcli*"" AND command=""*--format-param*"" AND command=""*vm process list*"" AND command=""*awk*"" AND command=""*esxcli vm process kill*"") 
| stats min(_time) as firstTime max(_time) as lastTime values(_time) as timeStamp values(command) as commands values(user) as user by dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_bulk_vm_termination_filter`"
ESXi Download Errors,"This detection identifies failed file download attempts on ESXi hosts by looking for specific error messages in the system logs. These failures may indicate unauthorized or malicious attempts to install or update componentsâ€”such as VIBs or scripts
Search 1`esxi_syslog` Message IN (&#34;*Download failed*&#34;, &#34;*Failed to download file*&#34;, &#34;*File download error*&#34;, &#34;*Could not download*&#34;) 2| rex field=_raw &#34;Z (?",VMware ESXi,Defense Evasion,"T1562.001, T1601.001","`esxi_syslog` Message IN (""*Download failed*"", ""*Failed to download file*"", ""*File download error*"", ""*Could not download*"") 
| rex field=_raw ""Z (?<dest>[\w\.]*)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_download_errors_filter`"
ESXi Lockdown Mode Disabled,"This detection identifies when Lockdown Mode is disabled on an ESXi host, which can indicate that a threat actor is attempting to weaken host security controls. Disabling Lockdown Mode allows broader remote access via SSH or the host client and may precede further malicious actions such as data exfiltration, lateral movement, or VM tampering.",VMware ESXi,"Lateral Movement, Exfiltration, Defense Evasion",T1562,"`esxi_syslog` Message IN (""*lockdownmode.disabled*"", ""*Administrator access to the host has been enabled*"") 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_lockdown_mode_disabled_filter`"
ESXi Reverse Shell Patterns,"This detection looks for reverse shell string patterns on an ESXi host, which may indicate that a threat actor is attempting to establish remote control over the system.
Search 1`esxi_syslog` Message IN (&#34;*bash -i &gt;&amp;*&#34;,&#34;*/dev/tcp/*&#34;,&#34;*/dev/udp/*&#34;, &#34;*/socat exec:*&#34;,&#34;*socket(S,PF_INET*&#34;) OR (Message=&#34;*python -c*&#34; AND Message=&#34;*import socket*&#34;) 2| rex field=_raw &#34;Z (?&lt;dest&gt;[\w\.]+)\s&#34; 3| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 4| `security_content_ctime(firstTime)` 5| `security_content_ctime(lastTime)` 6| `esxi_reverse_shell_patterns_filter` Data Source Name Platform Sourcetype Source VMWare ESXi Syslog Other 'vmw-syslog' 'vmware:esxlog' Macros Used Name Value esxi_syslog sourcetype=vmw-syslog OR sourcetype=vmware:esxlog* esxi_reverse_shell_patterns_filter search * esxi_reverse_shell_patterns_filter is an empty macro by default.",VMware ESXi,Execution,T1059,"`esxi_syslog` Message IN (""*bash -i >&*"",""*/dev/tcp/*"",""*/dev/udp/*"", ""*/socat exec:*"",""*socket(S,PF_INET*"") OR (Message=""*python -c*"" AND Message=""*import socket*"") 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_reverse_shell_patterns_filter`"
ESXi Shell Access Enabled,"This detection identifies when the ESXi Shell is enabled on a host, which may indicate that a malicious actor is preparing to execute commands locally or establish persistent access. Enabling the shell outside of approved maintenance windows can be a sign of compromise or unauthorized administrative activity.
Search 1`esxi_syslog` Message=&#34;*ESXi Shell*&#34; Message=&#34;*has been enabled*&#34; 2| rex field=_raw &#34;&#39;(?",VMware ESXi,Lateral Movement,T1021,"`esxi_syslog` Message=""*ESXi Shell*"" Message=""*has been enabled*"" 
| rex field=_raw ""'(?<user>\w+)@"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| stats min(_time) as firstTime max(_time) as lastTime count by dest user Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_shell_access_enabled_filter`"
CrowdStrike Falcon Stream Alerts,"The following analytic is to leverage alerts from CrowdStrike Falcon Event Stream. This query aggregates and summarizes DetectionSummaryEvent and IdpDetectionSummaryEvent alerts from CrowdStrike Falcon Event Stream, providing details such as destination, user, severity, MITRE information, and Crowdstrike id and links. The evals in the search do multiple things to include align the severity, ensure the user, dest, title, description, MITRE fields are set properly, and the drilldowns are defined based on the type of alert.",CrowdStrike EDR,,,"`crowdstrike_stream` metadata.eventType IN (DetectionSummaryEvent,IdpDetectionSummaryEvent) 
| rename event.* as * 
| eval risk_score=case(severity=""Critical"", 500, severity=""High"", 250, severity=""Medium"", 100, severity=""Low"", 25, severity=""Informational"", 0) 
| eval user=coalesce(lower(SourceAccountName),lower(UserName)) 
| eval dest=coalesce(ComputerName,SourceEndpointHostName)
| eval mitre_technique = case(!match(DetectName, ""(NGAV
|Intel Detection)""), Technique)
| join type=left mitre_technique 
[
| inputlookup append=t mitre_attack_lookup 
| fields mitre_technique mitre_technique_id ] 
| eval annotations.mitre_attack = mitre_technique_id
| eval drilldown_user = if(NOT isnull(user), if(NOT isnull(SourceAccountName),(""event.SourceAccountName="" + $SourceAccountName$),""event.UserName="" + $UserName$ ),"""")
| eval drilldown_dest = if(NOT isnull(dest), if(NOT isnull(SourceEndpointHostName),(""event.SourceEndpointHostName="" + $SourceEndpointHostName$ +""*""),""event.ComputerName="" + $ComputerName$ +""*""),"""")
| eval drilldown_dest2 = if( NOT isnull(dest) AND NOT isnull(IOARuleInstanceID) AND Tactic==""Custom Intelligence"", if(NOT isnull(SourceEndpointHostName),(""dest="" + $SourceEndpointHostName$ +""*""),""dest="" + $ComputerName$ +""*""),"""") 
| eval annotations.drilldown_search = if(isnull(IOARuleInstanceID) AND Tactic!=""Custom Intelligence"", ""`crowdstrike_stream` metadata.eventType="" + $metadata.eventType$ + "" "" + drilldown_user + "" "" + drilldown_dest, ""`crowdstrike_stream` ((metadata.eventType="" + $metadata.eventType$ + "" "" + drilldown_user + "" "" + drilldown_dest + "") OR (event_simpleName IN (CustomIOABasicProcessDetectionInfoEvent,CustomIOADomainNameDetectionInfoEvent,CustomIOAFileWrittenDetectionInfoEvent,CustomIOANetworkConnectionDetectionInfoEvent) TemplateInstanceId="" + IOARuleInstanceID + "" "" + drilldown_dest2 + ""))"")
| rename ""metadata.eventType"" as eventType
| eval title = case(DetectName==""NGAV"", (""RR - CS - "" + Tactic + "" - "" + Technique),DetectName==""Intel Detection"", (""RR - CS - "" + DetectName),eventType==""IdpDetectionSummaryEvent"", (""RR - CS - Identity Protection""),1==1, (""RR - CS - "" + DetectName + "" - "" + Technique) ) 
| eval user_append = if(NOT isnull(user),"" by "" + user,"""") 
| eval dest_append = if(NOT isnull(dest),"" on "" + dest,"""") 
| eval description = case(DetectName==""NGAV"", (""CS "" + Tactic + "" - "" + Technique + "": "" + FileName),eventType==""IdpDetectionSummaryEvent"", (""CS IdP"" + "" - "" + DetectName),DetectName==""Intel Detection"", (""CS "" + DetectName + "" - "" + IOCType + "": "" + IOCValue),1==1, (Objective + "" - "" + DetectDescription) ) 
| eval description = description + user_append + dest_append
| eval gid=DetectId, display_id=FalconHostLink, file_hash=SHA256String, hash=MD5String, signature=IOCValue, ip='NetworkAccesses{}.RemoteAddress', process=CommandLine, pid=ProcessId 
| eval file_name = if(isnull('ExecutablesWritten{}.FileName'), FileName, 'ExecutablesWritten{}.FileName')
| rename DetectId as detection_id, FalconHostLink as detection_url 
| table _time source detection_id detection_url title risk_score description Severity severity ComputerName dest Tactic Technique user UserName Objective DetectName DetectDescription gid, display_id, mitre_technique annotations.mitre_attack annotations.drilldown_search file_hash hash signature ip process pid file_name
| `crowdstrike_falcon_stream_alerts_filter`"
ESXi Shared or Stolen Root Account,"This detection monitors for signs of a shared or potentially compromised root account on ESXi hosts by tracking the number of unique IP addresses logging in as root within a short time window. Multiple logins from different IPs in a brief period may indicate credential misuse, lateral movement, or account compromise.
Search 1`esxi_syslog` Message=&#34;*root*&#34; Message=&#34;*logged in*&#34; NOT Message=&#34;*root@127.",VMware ESXi,"Lateral Movement, Defense Evasion",T1078,"`esxi_syslog` Message=""*root*"" Message=""*logged in*"" NOT Message=""*root@127.0.0.1*"" 
| rex field=_raw ""root@(?<SrcIpAddr>\d{1,3}(?:\.\d{1,3}){3})"" 
| rex field=_raw ""Z (?<dest>[\w\.]+)\s"" 
| bin _time span=15m 
| stats min(_time) as firstTime max(_time) as lastTime dc(SrcIpAddr) AS distinct_ip_count values(SrcIpAddr) AS SrcIps by dest 
| where distinct_ip_count > 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `esxi_shared_or_stolen_root_account_filter`"
MacOS - Re-opened Applications,The following analytic identifies processes referencing plist files that determine which applications are re-opened when a user reboots their MacOS machine.,MacOS,"Execution, Persistence",,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*com.apple.loginwindow*"" by Processes.user Processes.process_name Processes.parent_process_name Processes.dest 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `macos___re_opened_applications_filter`"
Cisco AI Defense Security Alerts by Application Name,"The search surfaces alerts from the Cisco AI Defense product for potential attacks against the AI models running in your environment. This analytic identifies security events within Cisco AI Defense by examining event messages, actions, and policy names. It focuses on connections and applications associated with specific guardrail entities and ruleset types. By aggregating and analyzing these elements, the search helps detect potential policy violations and security threats, enabling proactive defense measures and ensuring network integrity.",Cisco AI Defense,,,"`cisco_ai_defense` 
| rename genai_application.application_name as application_name 
| rename connection.connection_name as connection_name 
```Aggregating data by model name, connection name, application name, application ID, and user ID```
| stats count 
values(user_id) as user_id
values(event_message_type) as event_message_type
values(event_action) as event_action
values(policy.policy_name) as policy_name 
values(event_policy_guardrail_assocs{}.policy_guardrail_assoc.guardrail_avail_entity.guardrail_entity_name) as guardrail_entity_name 
values(event_policy_guardrail_assocs{}.policy_guardrail_assoc.guardrail_avail_ruleset.guardrail_ruleset_type) as guardrail_ruleset_type 
by model.model_name connection_name application_name application_id 
```Evaluating severity based on policy name and guardrail ruleset type```
| eval severity=case(
policy_name IN (""AI Runtime Latency Testing - Prompt Injection""), ""critical"",
policy_name IN (""AI Runtime Latency Testing - Code Detection""), ""high"", 
guardrail_ruleset_type IN (""Toxicity""), ""medium"",
true(), ""low""
) 
```Calculating risk score based on severity level```
| eval risk_score=case(
severity=""critical"", 100,
severity=""high"", 75,
severity=""medium"", 50,
severity=""low"", 25
)
| table model.model_name, user_id, event_action, application_id, application_name, severity, risk_score, policy_name, connection_name, guardrail_ruleset_type, guardrail_entity_name 
| `cisco_ai_defense_security_alerts_by_application_name_filter`"
Detect Distributed Password Spray Attempts,"This analytic employs the 3-sigma approach to identify distributed password spray attacks. A distributed password spray attack is a type of brute force attack where the attacker attempts a few common passwords against many different accounts, connecting from multiple IP addresses to avoid detection. By utilizing the Authentication Data Model, this detection is effective for all CIM-mapped authentication events, providing comprehensive coverage and enhancing security against these attacks.",Azure AD (Microsoft Entra ID),Credential Access,"T1110.003, T1110","| tstats `security_content_summariesonly` dc(Authentication.user) AS unique_accounts dc(Authentication.src) as unique_src values(Authentication.app) as app values(Authentication.src) as src count(Authentication.user) as total_failures from datamodel=Authentication.Authentication where Authentication.action=""failure"" NOT Authentication.src IN (""-"",""unknown"") Authentication.user_agent=""*"" by Authentication.signature_id, Authentication.user_agent, sourcetype, _time  span=10m 
| `drop_dm_object_name(""Authentication"")` ```fill out time buckets for 0-count events during entire search length``` 
| appendpipe [
| timechart limit=0 span=10m count 
| table _time] 
| fillnull value=0 unique_accounts, unique_src ``` Create aggregation field & apply to all null events``` 
| eval counter=sourcetype+""__""+signature_id 
| eventstats values(counter) as fnscounter 
| eval counter=coalesce(counter,fnscounter)  
| stats values(total_failures) as total_failures values(signature_id) as signature_id values(src) as src values(sourcetype) as sourcetype values(app) as app count by counter unique_accounts unique_src user_agent _time
``` remove 0 count rows where counter has data```
| sort - _time unique_accounts 
| dedup _time counter ``` 3-sigma detection logic ``` 
| eventstats avg(unique_accounts) as comp_avg_user , stdev(unique_accounts) as comp_std_user avg(unique_src) as comp_avg_src , stdev(unique_src) as comp_std_src by counter user_agent 
| eval upperBoundUser=(comp_avg_user+comp_std_user*3), upperBoundsrc=(comp_avg_src+comp_std_src*3) 
| eval isOutlier=if((unique_accounts > 30 and unique_accounts >= upperBoundUser) and (unique_src > 30 and unique_src >= upperBoundsrc), 1, 0) 
| replace ""::ffff:*"" with * in src 
| where isOutlier=1 
| foreach * 
[ eval <<FIELD>> = if(<<FIELD>>=""null"",null(),<<FIELD>>)] 
| mvexpand src  
| iplocation src  
| table _time, unique_src, unique_accounts, total_failures, sourcetype, signature_id, user_agent, src, Country 
| eval date_wday=strftime(_time,""%a""), date_hour=strftime(_time,""%H"") 
| `detect_distributed_password_spray_attempts_filter`"
Email files written outside of the Outlook directory,The following analytic detects email files (.,Windows Events,"Collection, Discovery, Exfiltration",T1114.001,"| tstats `security_content_summariesonly` count values(Filesystem.file_path) as file_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where (Filesystem.file_name=*.pst OR Filesystem.file_name=*.ost) Filesystem.file_path != ""C:\\Users\\*\\My Documents\\Outlook Files\\*""  Filesystem.file_path!=""C:\\Users\\*\\AppData\\Local\\Microsoft\\Outlook*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(""Filesystem"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `email_files_written_outside_of_the_outlook_directory_filter`"
Email servers sending high volume traffic to hosts,The following analytic identifies a significant increase in data transfers from your email server to client hosts.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Collection, Impact",T1114.002,"| tstats `security_content_summariesonly` sum(All_Traffic.bytes_out) as bytes_out from datamodel=Network_Traffic where All_Traffic.src_category=email_server by All_Traffic.dest_ip _time span=1d 
| `drop_dm_object_name(""All_Traffic"")` 
| eventstats avg(bytes_out) as avg_bytes_out stdev(bytes_out) as stdev_bytes_out 
| eventstats count as num_data_samples avg(eval(if(_time < relative_time(now(), ""@d""), bytes_out, null))) as per_source_avg_bytes_out stdev(eval(if(_time < relative_time(now(), ""@d""), bytes_out, null))) as per_source_stdev_bytes_out by dest_ip 
| eval minimum_data_samples = 4, deviation_threshold = 3 
| where num_data_samples >= minimum_data_samples AND bytes_out > (avg_bytes_out + (deviation_threshold * stdev_bytes_out)) AND bytes_out > (per_source_avg_bytes_out + (deviation_threshold * per_source_stdev_bytes_out)) AND _time >= relative_time(now(), ""@d"") 
| eval num_standard_deviations_away_from_server_average = round(abs(bytes_out - avg_bytes_out) / stdev_bytes_out, 2), num_standard_deviations_away_from_client_average = round(abs(bytes_out - per_source_avg_bytes_out) / per_source_stdev_bytes_out, 2) 
| table dest_ip, _time, bytes_out, avg_bytes_out, per_source_avg_bytes_out, num_standard_deviations_away_from_server_average, num_standard_deviations_away_from_client_average 
| `email_servers_sending_high_volume_traffic_to_hosts_filter`"
Okta IDP Lifecycle Modifications,"The following analytic identifies modifications to Okta Identity Provider (IDP) lifecycle events, including creation, activation, deactivation, and deletion of IDP configurations. It uses OktaIm2 logs ingested via the Splunk Add-on for Okta Identity Cloud. Monitoring these events is crucial for maintaining the integrity and security of authentication mechanisms. Unauthorized or anomalous changes could indicate potential security breaches or misconfigurations.",Okta,Discovery,T1087.004,"`okta` eventType IN (""system.idp.lifecycle.activate"",""system.idp.lifecycle.create"",""system.idp.lifecycle.delete"",""system.idp.lifecycle.deactivate"") 
|  stats count  min(_time) as firstTime max(_time) as lastTime values(target{}.id) as target_id values(target{}.type) as target_modified by src dest src_user_id user user_agent command description 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_idp_lifecycle_modifications_filter`"
Okta Multiple Accounts Locked Out,"The following analytic detects multiple Okta accounts being locked out within a short period. It uses the user.account.lock event from Okta logs, aggregated over a 5-minute window, to identify this behavior. This activity is significant as it may indicate a brute force or password spraying attack, where an adversary attempts to guess passwords, leading to account lockouts.",Okta,Credential Access,T1110,"| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime values(All_Changes.user) as user from datamodel=Change where All_Changes.change_type=AAA All_Changes.object_category=User AND All_Changes.action=lockout AND All_Changes.command=user.account.lock by _time span=5m All_Changes.result All_Changes.command sourcetype All_Changes.src All_Changes.dest 
| where count > 5 
| `drop_dm_object_name(""All_Changes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_multiple_accounts_locked_out_filter`"
Okta Multiple Failed Requests to Access Applications,"The following analytic detects multiple failed attempts to access applications in Okta, potentially indicating the reuse of a stolen web session cookie.",Okta,"Lateral Movement, Defense Evasion","T1538, T1550, T1550.004","`okta` target{}.type=AppInstance (eventType=policy.evaluate_sign_on outcome.result=CHALLENGE) OR (eventType=user.authentication.sso outcome.result=SUCCESS) 
| eval targets=mvzip('target{}.type', 'target{}.displayName', "": "") 
| eval targets=mvfilter(targets LIKE ""AppInstance%"") 
| stats count min(_time) as _time values(outcome.result) as outcome.result dc(eval(if(eventType=""policy.evaluate_sign_on"",targets,NULL))) as total_challenges sum(eval(if(eventType=""user.authentication.sso"",1,0))) as total_successes by authenticationContext.externalSessionId targets actor.alternateId client.ipAddress 
| search total_challenges > 0 
| stats min(_time) as _time values(*) as * sum(total_challenges) as total_challenges sum(total_successes) as total_successes values(eval(if(""outcome.result""=""SUCCESS"",targets,NULL))) as success_apps values(eval(if("":outcome.result""!=""SUCCESS"",targets,NULL))) as no_success_apps by authenticationContext.externalSessionId actor.alternateId client.ipAddress 
| fillnull 
| eval ratio=round(total_successes/total_challenges,2), severity=""HIGH"", mitre_technique_id=""T1538"", description=""actor.alternateId"". "" from "" . ""client.ipAddress"" . "" seen opening "" . total_challenges . "" chiclets/apps with "" . total_successes . "" challenges successfully passed"" 
| fields - count, targets 
| search ratio < 0.5 total_challenges > 2 
| `okta_multiple_failed_requests_to_access_applications_filter`"
Okta Multiple Users Failing To Authenticate From Ip,The following analytic identifies instances where more than 10 unique user accounts have failed to authenticate from a single IP address within a 5-minute window in an Okta tenant. This detection uses OktaIm2 logs ingested via the Splunk Add-on for Okta Identity Cloud. Such activity is significant as it may indicate brute-force attacks or password spraying attempts.,Okta,Credential Access,"T1110.003, T1110","| tstats `security_content_summariesonly` count max(_time) as lastTime, min(_time) as firstTime dc(Authentication.user) as unique_accounts values(Authentication.signature) as signature values(Authentication.user) as user values(Authentication.app) as app values(Authentication.authentication_method) as authentication_method values(Authentication.dest) as dest from datamodel=Authentication where Authentication.action=""failure"" AND Authentication.signature=user.session.start by _time span=5m Authentication.src sourcetype 
| where unique_accounts > 9 
| `drop_dm_object_name(""Authentication"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_multiple_users_failing_to_authenticate_from_ip_filter`"
Okta Phishing Detection with FastPass Origin Check,The following analytic identifies failed user authentication attempts in Okta due to FastPass declining a phishing attempt.,Okta,"Initial Access, Lateral Movement, Defense Evasion","T1556, T1078.001","`okta` eventType=""user.authentication.auth_via_mfa"" AND result=""FAILURE"" AND outcome.reason=""FastPass declined phishing attempt"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(displayMessage) by user eventType client.userAgent.rawUserAgent client.userAgent.browser outcome.reason 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_phishing_detection_with_fastpass_origin_check_filter`"
Okta Risk Threshold Exceeded,"The following correlation identifies when a user exceeds a risk threshold based on multiple suspicious Okta activities. It leverages the Risk Framework from Enterprise Security, aggregating risk events from &quot;Suspicious Okta Activity,&quot; &quot;Okta Account Takeover,&quot; and &quot;Okta MFA Exhaustion&quot; analytic stories. This detection is significant as it highlights potentially compromised user accounts exhibiting multiple tactics, techniques, and procedures (TTPs) within a 24-hour period.",Okta,"Initial Access, Defense Evasion","T1110, T1078","| tstats `security_content_summariesonly` values(All_Risk.analyticstories) as analyticstories  sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count,values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk  where All_Risk.risk_object_type = user All_Risk.analyticstories IN (""Okta Account Takeover"", ""Suspicious Okta Activity"",""Okta MFA Exhaustion"") by All_Risk.risk_object,All_Risk.risk_object_type 
| `drop_dm_object_name(""All_Risk"")` 
|  search mitre_technique_id_count > 5 
| `okta_risk_threshold_exceeded_filter`"
Okta Successful Single Factor Authentication,"The following analytic identifies successful single-factor authentication events against the Okta Dashboard for accounts without Multi-Factor Authentication (MFA) enabled. It detects this activity by analyzing Okta logs for successful authentication events where &quot;Okta Verify&quot; is not used. This behavior is significant as it may indicate a misconfiguration, policy violation, or potential account takeover. If confirmed malicious, an attacker could gain unauthorized access to the account, potentially leading to data breaches or further exploitation within the environment.",Okta,"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`okta`  action=success src_user_type = User eventType = user.authentication.verify OR eventType = user.authentication.auth_via_mfa
| stats dc(eventType) values(eventType) as eventType values(target{}.displayName) as targets values(debugContext.debugData.url) min(_time) as firstTime max(_time) as lastTime values(authentication_method) by src_ip user action dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| search targets !=""Okta Verify"" 
| `okta_successful_single_factor_authentication_filter`"
Okta Suspicious Activity Reported,"The following analytic identifies when an associate reports a login attempt as suspicious via an email from Okta. It leverages Okta Identity Management logs, specifically the user.account.report_suspicious_activity_by_enduser event type. This activity is significant as it indicates potential unauthorized access attempts, warranting immediate investigation to prevent possible security breaches. If confirmed malicious, the attacker could gain unauthorized access to sensitive systems and data, leading to data theft, privilege escalation, or further compromise of the environment.",Okta,"Privilege Escalation, Defense Evasion",T1078.001,"`okta` eventType=user.account.report_suspicious_activity_by_enduser 
| stats count min(_time) as firstTime max(_time) as lastTime values(displayMessage) by user dest src eventType client.userAgent.rawUserAgent client.userAgent.browser client.geographicalContext.city  client.geographicalContext.country 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_suspicious_activity_reported_filter`"
Okta ThreatInsight Threat Detected,"The following analytic identifies threats detected by Okta ThreatInsight, such as password spraying, login failures, and high counts of unknown user login attempts. It leverages Okta Identity Management logs, specifically focusing on security.threat.detected events. This activity is significant for a SOC as it highlights potential unauthorized access attempts and credential-based attacks. If confirmed malicious, these activities could lead to unauthorized access, data breaches, and further exploitation of compromised accounts, posing a significant risk to the organization's security posture.",Okta,Defense Evasion,T1078.004,"`okta` eventType = security.threat.detected 
| rename client.geographicalContext.country as country, client.geographicalContext.state as state, client.geographicalContext.city as city 
| stats count min(_time) as firstTime max(_time) as lastTime by app src_ip dest signature eventType displayMessage client.device city state country user_agent outcome.reason outcome.result severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `okta_threatinsight_threat_detected_filter`"
Okta Unauthorized Access to Application,"The following analytic identifies attempts by users to access Okta applications that have not been assigned to them. It leverages Okta Identity Management logs, specifically focusing on failed access attempts to unassigned applications. This activity is significant for a SOC as it may indicate potential unauthorized access attempts, which could lead to exposure of sensitive information or disruption of services.",Okta,Discovery,"T1087.004, T1110","| tstats values(Authentication.app) as app values(Authentication.action) as action values(Authentication.user) as user values(Authentication.reason) as reason from datamodel=Authentication where Authentication.signature=app.generic.unauth_app_access_attempt Authentication.action=""failure"" by _time Authentication.src Authentication.user Authentication.dest 
| `drop_dm_object_name(""Authentication"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| iplocation src 
| `okta_unauthorized_access_to_application_filter`"
Okta User Logins from Multiple Cities,"The following analytic identifies instances where the same Okta user logs in from different cities within a 24-hour period. This detection leverages Okta Identity Management logs, analyzing login events and their geographic locations. Such behavior is significant as it may indicate a compromised account, with an attacker attempting unauthorized access from multiple locations. If confirmed malicious, this activity could lead to account takeovers and data breaches, allowing attackers to access sensitive information and potentially escalate their privileges within the environment.",Okta,,"T1586.003, T1110","| tstats  `security_content_summariesonly` values(Authentication.app) as app values(Authentication.action) as action values(Authentication.user) as user values(Authentication.reason) as reason values(Authentication.dest) as dest values(Authentication.signature) as signature  values(Authentication.method) as method  from datamodel=Authentication where  Authentication.signature=user.session.start by _time Authentication.src 
| `drop_dm_object_name(""Authentication"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| iplocation src 
| stats count min(_time) as firstTime max(_time) as lastTime dc(src) as distinct_src dc(City) as distinct_city values(src) as src values(City) as City values(Country) as Country values(action) as action by user 
| where distinct_city > 1 
| `okta_user_logins_from_multiple_cities_filter`"
PingID Mismatch Auth Source and Verification Response,"The following analytic identifies discrepancies between the IP address of an authentication event and the IP address of the verification response event, focusing on differences in the originating countries. It leverages JSON logs from PingID, comparing the 'auth_Country' and 'verify_Country' fields. This activity is significant as it may indicate suspicious sign-in behavior, such as account compromise or unauthorized access attempts.",PingID,"Credential Access, Defense Evasion","T1556.006, T1556, T1621, T1098.005, T1098","`pingid` (""result.status"" IN (""SUCCESS*"",""FAIL*"",""UNSUCCESSFUL*"" ) NOT ""result.message"" IN (""*pair*"",""*create*"",""*delete*"")) 
| eval user = upper('actors{}.name'), session_id = 'resources{}.websession', dest = 'resources{}.ipaddress', reason = 'result.message', object = 'resources{}.devicemodel', status = 'result.status' 
| join user session_id [ search `pingid` (""result.status"" IN (""POLICY"") AND ""resources{}.ipaddress""=*) AND ""result.message"" IN(""*Action: Authenticate*"",""*Action: Approve*"",""*Action: Allowed*"") 
| rex field=result.message ""IP Address: (?:N\/A)?(?<policy_ipaddress>.+)?\n"" 
| rex field=result.message ""Action: (?:N\/A)?(?<signature>.+)?\n"" 
| rex field=result.message ""Requested Application Name: (?:N\/A)?(?<Requested_Application_Name>.+)?\n"" 
| rex field=result.message "" Requested Application ID: (?:N\/A)?(?<Requested_Application_ID>.+)?\n"" 
| eval user = upper('actors{}.name'), session_id = 'resources{}.websession', src = coalesce('resources{}.ipaddress',policy_ipaddress), app = coalesce(Requested_Application_ID,Requested_Application_Name) 
| fields app, user, session_id, src, signature ] 
| iplocation prefix=auth_ dest 
| iplocation prefix=verify_ src 
| stats count min(_time) as firstTime max(_time) as lastTime values(app) as app values(session_id) as session_id by user, dest, auth_Country, src, verify_Country, object, signature, status, reason 
| where auth_Country != verify_Country 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `pingid_mismatch_auth_source_and_verification_response_filter`"
PingID Multiple Failed MFA Requests For User,"The following analytic identifies multiple failed multi-factor authentication (MFA) requests for a single user within a PingID environment. It triggers when 10 or more MFA prompts fail within 10 minutes, using JSON logs from PingID. This activity is significant as it may indicate an adversary attempting to bypass MFA by bombarding the user with repeated authentication requests.",PingID,"Initial Access, Credential Access, Defense Evasion","T1110, T1621, T1078","`pingid` ""result.status"" IN (""FAILURE,authFail"",""UNSUCCESSFUL_ATTEMPT"") 
| eval time = _time, src = coalesce('resources{}.ipaddress','resources{}.devicemodel'), user = upper('actors{}.name'), object = 'resources{}.devicemodel', reason = 'result.message'
| bucket span=10m _time 
| stats dc(_raw) AS mfa_prompts min(time) as firstTime, max(time) as lastTime values(src) as src by user, reason, _time 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| where mfa_prompts >= 10 
| `pingid_multiple_failed_mfa_requests_for_user_filter`"
PingID New MFA Method Registered For User,"The following analytic detects the registration of a new Multi-Factor Authentication (MFA) method for a PingID (PingOne) account. It leverages JSON logs from PingID, specifically looking for successful device pairing events. This activity is significant as adversaries who gain unauthorized access to a user account may register a new MFA method to maintain persistence. If confirmed malicious, this could allow attackers to bypass existing security measures, maintain long-term access, and potentially escalate their privileges within the compromised environment.",PingID,"Persistence, Credential Access, Defense Evasion","T1556.006, T1556, T1621, T1098.005, T1098","`pingid` ""result.message""=""Device Paired*"" result.status=""SUCCESS""   
| rex field=result.message ""Device (Unp)?(P)?aired (?<device_extract>.+)"" 
| eval src = coalesce('resources{}.ipaddress','resources{}.devicemodel'), user = upper('actors{}.name'), reason = 'result.message' 
| eval object=CASE(ISNOTNULL('resources{}.devicemodel'),'resources{}.devicemodel',true(),device_extract) 
| eval action=CASE(match('result.message',""Device Paired*""),""created"",match('result.message', ""Device Unpaired*""),""deleted"") 
| stats count min(_time) as firstTime, max(_time) as lastTime by src,user,object,action,reason 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `pingid_new_mfa_method_registered_for_user_filter`"
Splunk App for Lookup File Editing RCE via User XSLT,"The following analytic identifies the creation of lookup files in Splunk, which could indicate an attempt to exploit remote code execution via user-supplied XSLT.",Splunk Internal,"Lateral Movement, Execution",T1210,"| rest splunk_server=local /services/data/lookup-table-files/ 
| fields title author disabled eai:acl.app eai:acl.owner eai:acl.sharing eai:appName eai:data 
| `splunk_app_for_lookup_file_editing_rce_via_user_xslt_filter`"
Splunk AppDynamics Secure Application Alerts,"The following analytic is to leverage alerts from Splunk AppDynamics SecureApp, which identifies and monitors exploit attempts targeting business applications. The primary attack observed involves exploiting vulnerabilities in web applications, including injection attacks (SQL, API abuse), deserialization vulnerabilities, remote code execution attempts, LOG4J and zero day attacks. These attacks are typically aimed at gaining unauthorized access, exfiltrating sensitive data, or disrupting application functionality.",Splunk Internal,Execution,,"`appdynamics_security`  blocked=false
| rename attackEvents{}.* AS *, detailJson.* AS *, vulnerabilityInfo.* AS *
| fields - tag::eventtype, eventtype, host, id, index, linecount, punct, source, sourcetype, splunk_server, tag, SourceType, app clientAddressType, application, tier, ""attackEvents{}.* status""  
| eval socketOut=mvjoin(socketOut,"" AND "")  
| eval risk_score=kennaScore  
| fillnull risk_score value=""0""  
`secureapp_es_field_mappings`
| stats values(*) as * by attackId  
| eval severity=case( 
risk_score>=100 OR signature=""LOG4J"", ""critical"", 
risk_score>50 AND risk_score<75, ""high"", 
risk_score=0 AND attackOutcome=""EXPLOITED"", ""high"", 
risk_score<=50 AND attackOutcome!=""OBSERVED"", ""medium"", 
risk_score=0 AND attackOutcome=""ATTEMPTED"", ""medium"", 
risk_score=0, ""low"", 
risk_score=0 AND attackOutcome=""OBSERVED"", ""low"" 
)  
| eval risk_message=case( 
(signature=""API"" OR signature=""LOG4J"" OR signature=""SSRF""), ""An attempt to exploit a "".signature."" vulnerability was made from a "".src_category."" IP address "".src_ip."". The server "".dest_nt_host."" hosting application "".app_name."" was accessed, and data may have been exfiltrated to "".socketOut.""."", 
(signature=""MALIP"" OR signature=""SQL""), ""A vulnerability is being "".attackOutcome."" from a "".src_category."" IP address "".src_ip."". The server "".dest_nt_host."" hosting application "".app_name."" was accessed."", 
(signature=""DESEREAL""), ""The application "".app_name."" deserializes untrusted data without sufficiently verifying that the resulting data will be valid. Data which is untrusted cannot be trusted to be well-formed. Malformed data or unexpected data could be used to abuse application logic, deny service, or execute arbitrary code, when deserialized."" 
) 
| `splunk_appdynamics_secure_application_alerts_filter`"
Splunk Authentication Token Exposure in Debug Log,"The following analytic identifies exposed authentication tokens in debug logs within Splunk Enterprise. It leverages logs from the splunkd component with a DEBUG log level, specifically searching for event messages that validate tokens. This activity is significant because exposed tokens can be exploited by attackers to gain unauthorized access to the Splunk environment.",Splunk Internal,"Discovery, Privilege Escalation",T1654,"`splunkd` component=JsonWebToken log_level=DEBUG eventtype=""splunkd-log"" event_message=""Validating token:*"" 
| rex ""Validating token: (?<token>.*)\.$"" 
| search token!=None 
| stats count min(_time) as firstTime max(_time) as lastTime values(log_level) as log_level values(event_message) as event_message by index, sourcetype, host, token 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `splunk_authentication_token_exposure_in_debug_log_filter`"
Splunk Code Injection via custom dashboard leading to RCE,"The following analytic identifies attempts to exploit a vulnerability in Splunk Enterprise versions below 8.2.9, 8.1.12, and 9.0.2, where an authenticated user can execute arbitrary code via the dashboard PDF generation component. It detects this activity by analyzing events in the _internal index with the file=export parameter. This behavior is significant because it indicates a potential code injection attack, which could lead to remote code execution (RCE).",Splunk Internal,"Lateral Movement, Execution",T1210,"`splunkd_ui` uri_path=*/data/ui/views/* OR uri_path=*saved/searches/* 
| dedup uri_path 
| eval URL=urldecode(""uri_path"")
| rex field=URL ""\/saved\/searches\/(?<NAME>[^\/]*)"" 
| rex field=URL ""\/data\/ui\/views\/(?<NAME1>[^\/]*)"" 
| eval NAME=NAME.""( Saved Search )"",NAME1=NAME1.""( Dashboard )"" 
| eval NAME=coalesce(NAME,NAME1) 
| eval STATUS=case(match(status,""2\d+""),""SUCCESS"",match(status,""3\d+""),""REDIRECTION"",match(status,""4\d+"") OR match(status,""5\d+""),""ERROR"") 
| stats list(NAME) as DASHBOARD_TITLE,list(method) as HTTP_METHOD,list(status) as Status_Code,list(STATUS) as STATUS by user 
| rename user as User 
| `splunk_code_injection_via_custom_dashboard_leading_to_rce_filter`"
Splunk Enterprise KV Store Incorrect Authorization,"The following analytic detects unauthorized attempts to reload Splunk KV Store collections via the REST API. It leverages internal index logs to identify POST requests to the /servicesNS/nobody/search/admin/collections-conf/_reload endpoint, focusing on status codes starting with '2'. This activity is significant as it may indicate improper permission handling, potentially leading to unauthorized deletion of KV Store collections.",Splunk Internal,"Collection, Impact, Defense Evasion",T1548,/servicesNS/nobody/search/admin/collections-conf/_reload
Splunk Information Disclosure on Account Login,"This is a composed hunting search that looks for possible user enumeration attempts when SAML is enabled on a Splunk instance by capturing different responses from server.
Search 1`splunkd` component=UiAuth status=failure action=login TcpChannelThread 2| stats count min(_time) as firstTime max(_time) as lastTime by user status action clientip 3| `security_content_ctime(firstTime)` 4| `security_content_ctime(lastTime)` 5| `splunk_information_disclosure_on_account_login_filter` Data Source Name Platform Sourcetype Source Splunk Splunk 'splunkd_ui_access' 'splunkd_ui_access.",Splunk Internal,Discovery,T1087,"`splunkd` component=UiAuth status=failure action=login TcpChannelThread 
| stats count min(_time) as firstTime max(_time) as lastTime by user status action clientip 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `splunk_information_disclosure_on_account_login_filter`"
Splunk Path Traversal In Splunk App For Lookup File Edit,"The following analytic identifies path traversal attempts in the Splunk App for Lookup File Editing. It detects specially crafted web requests targeting lookup files by analyzing the uri_query field in the _internal index. This activity is significant because it allows low-privilege users to read and write to restricted areas of the Splunk installation directory, potentially accessing sensitive files like password hashes.",Splunk Internal,Discovery,T1083,"`splunkda` uri_query=*lookup_file* 
| table clientip uri_query lookup_file owner namespace  version 
| stats count by clientip namespace lookup_file uri_query 
| `splunk_path_traversal_in_splunk_app_for_lookup_file_edit_filter`"
Splunk RCE PDFgen Render,"This is a hunting search designed to find and discover exploitation attempts against Splunk pdfgen render endpoint which results in remote
Search 1index=_internal sourcetype=splunk_pdfgen _raw IN (&#34;*base64*&#34;, &#34;*lambda*&#34;, &#34;*system*&#34;) 2| stats count min(_time) as firstTime max(_time) as lastTime by index, sourcetype, host, _raw 3| `security_content_ctime(firstTime)` 4| `security_content_ctime(lastTime)` 5| `splunk_rce_pdfgen_render_filter` Data Source Name Platform Sourcetype Source Splunk Splunk 'splunkd_ui_access' 'splunkd_ui_access.",Splunk Internal,Lateral Movement,T1210,"index=_internal sourcetype=splunk_pdfgen _raw IN (""*base64*"", ""*lambda*"", ""*system*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by index, sourcetype, host, _raw 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `splunk_rce_pdfgen_render_filter`"
Splunk RCE Through Arbitrary File Write to Windows System Root,"In Splunk Enterprise for Windows versions below 9.3.0, 9.2.3, and 9.1.6, a low-privileged user that does not hold the â€œadminâ€ or â€œpowerâ€ Splunk roles could write a file to the Windows system root directory, which has a default location of C:\Windows\System32, when Splunk Enterprise for Windows is installed on a separate drive. Additionally, this user may be able to upload and execute code due to insecure session storage configuration.",Splunk Internal,"Lateral Movement, Execution",T1210,"```Each exploit attempt abuses the following endpoint. A request to the endpoint MUST occur immediately before the App Creation Message. However, this endpoint does not expose the name of the app that was created```
`splunkda` status=200 uri_path=""*/search/apps/local/_new""
| bin _time span=1m 
| stats count by _time, user
``` A request to this endpoint also results in an ApplicationManager event showing that a new application was created. This exposes the name and is created immediately following the initial request.  We will look for these creation messages up to 60 seconds after the request to the vulnerable endpoint.```
| eval earliest_app_creation_time=_time
| eval latest_app_creation_time=_time+60
| eval api_user=user
```Search for the names of apps that were created with the time bounds above```
| map maxsearches=150 search=""search index=_internal earliest=$earliest_app_creation_time$ latest=$latest_app_creation_time$ 
```Admins, or users with app creation privileges may abuse this command```
(sourcetype=splunkd component=ApplicationManager event_message=\""Detected app creation:*\"") OR 
```But the command may also be abused by users with lower privileges```
(sourcetype=splunk_python user=$api_user$ type=ERROR \""requires capability\"" AND (\""edit_local_apps\"" OR \""admin_all_objects\"")) 
```Create meaningful messages in the case that app creation was successful or if it failed```
| strcat event_message \"" - This app should be examined to ensure that it is legitimate.\"" message_if_app_creation_successful
| strcat event_message \""Detected failed app creation: user does not have admin_all_objects or edit_local_apps capability and the user account MUST be investigated. This may still have resulted in the upload of malicious file(s) or execution of maliciouis command(s).\"" message_if_app_creation_failed
| eval message=if(isnull(event_message), message_if_app_creation_failed, message_if_app_creation_successful ) 
| eval user=\""$api_user$\""""
| stats count min(_time) as firstTime max(_time) as lastTime by user, message, host
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `splunk_rce_through_arbitrary_file_write_to_windows_system_root_filter`"
Splunk RCE via User XSLT,The following analytic identifies potential remote code execution (RCE) attempts via user-supplied Extensible Stylesheet Language Transformations (XSLT) in Splunk versions 9.1.x. It detects this activity by analyzing splunkd_ui logs for specific URI patterns and status codes indicative of XSLT injection attempts. This activity is significant because successful exploitation could allow an attacker to execute arbitrary code on the Splunk server.,Splunk Internal,"Lateral Movement, Execution",T1210,"`splunkd_ui` ((uri=""*NO_BINARY_CHECK=1*"" AND ""*input.path=*.xsl*"") OR uri=""*dispatch*.xsl*"") AND uri!= ""*splunkd_ui*"" 
| rex field=uri ""(?<string>=\s*([\S\s]+))"" 
| eval decoded_field=urldecode(string) 
| eval action=case(match(status,""200""),""Allowed"",match(status,""303
|500
|401
|403
|404
|301
|406""),""Blocked"",1=1,""Unknown"") 
| stats count min(_time) as firstTime max(_time) as lastTime by clientip useragent uri decoded_field action host 
| rename clientip as src, uri as dest_uri 
| iplocation src 
| fillnull value=""N/A"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime, lastTime src, useragent, action, count, Country, Region, City, dest_uri, decoded_field 
| `splunk_rce_via_user_xslt_filter`"
Splunk Sensitive Information Disclosure in DEBUG Logging Channels,"In Splunk versions 9.3, 9.2, 9.1, 9.1.5 Applications which have been enabled with logging level DEBUG may write sensitive information such as keys, tokens, or other sensitive strings into the internal index.
Search 1`splunkd` log_level=&#34;DEBUG&#34; AND component IN (&#34;REST_Calls&#34;, &#34;AdminManager&#34;, &#34;JSONWebToken&#34;) 2 3| stats count min(_time) as firstTime max(_time) as lastTime by host splunk_server log_level component event_message 4 5| `security_content_ctime(firstTime)` 6 7| `security_content_ctime(lastTime)` 8 9| `splunk_sensitive_information_disclosure_in_debug_logging_channels_filter` Data Source Name Platform Sourcetype Source Splunk Splunk 'splunkd_ui_access' 'splunkd_ui_access.",Splunk Internal,Credential Access,T1552,"`splunkd` log_level=""DEBUG"" AND component IN (""REST_Calls"", ""AdminManager"", ""JSONWebToken"")
| stats count min(_time) as firstTime max(_time) as lastTime by host splunk_server log_level component event_message
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `splunk_sensitive_information_disclosure_in_debug_logging_channels_filter`"
Splunk User Enumeration Attempt,"The following analytic identifies attempts to enumerate usernames in Splunk by detecting multiple failed authentication attempts from the same source. It leverages data from the _audit index, specifically focusing on failed authentication events. This activity is significant for a SOC because it can indicate an attacker trying to discover valid usernames, which is a precursor to more targeted attacks like password spraying or brute force attempts.",Splunk Internal,"Privilege Escalation, Defense Evasion",T1078,"`splunkd_failed_auths` 
| stats count(user) as auths by user, src 
| where auths>5 
| stats values(user) as user, sum(auths) as TotalFailedAuths by src 
| `splunk_user_enumeration_attempt_filter`"
Splunk XSS Privilege Escalation via Custom Urls in Dashboard,This is a composed hunting search that looks for POST requests to splunk_internal_metrics/data/ui/views which can be used to elevate privileges on the Splunk server via custom urls. The way to find privilege escalation is by looking at created users with high privielges after payload has been executed. This search looks at POST request and then looks at created users privileges.,Splunk Internal,"Initial Access, Privilege Escalation",T1189,"`splunkd_ui` method=POST /*/data/ui/views* 
| stats values(method) as method by _time index, sourcetype, host 
| eval event=""post_request"" 
| append [
| search `audittrail` action=""edit_user"" operation=""create"" 
| rex field=_raw ""object=\""(?<newUser>.*)\"""" 
| stats count values(operation) as operation values(splunk_server) as splunk_server values(user) as user by _time index, sourcetype, host, newUser 
| eval event=""create_user""] 
| sort - _time 
| transaction host startswith=event=""post_request"" endswith=event=""create_user"" maxspan=10m 
| table _time index, sourcetype, host, method, user, splunk_server, operation, event, newUser eventcount 
| `splunk_xss_privilege_escalation_via_custom_urls_in_dashboard_filter`"
Suspicious Java Classes,The following analytic identifies suspicious Java classes often used for remote command execution exploits in Java frameworks like Apache Struts.,Splunk Stream,Execution,,"`stream_http` http_method=POST http_content_length>1 
| regex form_data=""(?i)java\.lang\.(?:runtime
|processbuilder)"" 
| rename src_ip as src 
| stats count earliest(_time) as firstTime, latest(_time) as lastTime, values(url) as uri, values(status) as status, values(http_user_agent) as http_user_agent by src, dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_java_classes_filter`"
Abnormally High Number Of Cloud Instances Destroyed,The following analytic identifies an abnormally high number of cloud instances being destroyed within a 4-hour period.,Windows Events,"Impact, Defense Evasion",T1078.004,"| tstats count as instances_destroyed values(All_Changes.object_id) as object_id from datamodel=Change where All_Changes.action=deleted AND All_Changes.status=success AND All_Changes.object_category=instance by All_Changes.user _time span=1h 
| `drop_dm_object_name(""All_Changes"")` 
| eval HourOfDay=strftime(_time, ""%H"") 
| eval HourOfDay=floor(HourOfDay/4)*4 
| eval DayOfWeek=strftime(_time, ""%w"") 
| eval isWeekend=if(DayOfWeek >= 1 AND DayOfWeek <= 5, 0, 1) 
| join HourOfDay isWeekend [summary cloud_excessive_instances_destroyed_v1] 
| where cardinality >=16 
| apply cloud_excessive_instances_destroyed_v1 threshold=0.005 
| rename ""IsOutlier(instances_destroyed)"" as isOutlier 
| where isOutlier=1 
| eval expected_upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), "":""), 0) 
| eval distance_from_threshold = instances_destroyed - expected_upper_threshold 
| table _time, user, instances_destroyed, expected_upper_threshold, distance_from_threshold, object_id 
| `abnormally_high_number_of_cloud_instances_destroyed_filter`"
Abnormally High Number Of Cloud Instances Launched,The following analytic detects an abnormally high number of cloud instances launched within a 4-hour period.,Windows Events,Defense Evasion,T1078.004,"| tstats count as instances_launched values(All_Changes.object_id) as object_id from datamodel=Change where (All_Changes.action=created) AND All_Changes.status=success AND All_Changes.object_category=instance by All_Changes.user _time span=1h 
| `drop_dm_object_name(""All_Changes"")` 
| eval HourOfDay=strftime(_time, ""%H"") 
| eval HourOfDay=floor(HourOfDay/4)*4 
| eval DayOfWeek=strftime(_time, ""%w"") 
| eval isWeekend=if(DayOfWeek >= 1 AND DayOfWeek <= 5, 0, 1) 
| join HourOfDay isWeekend [summary cloud_excessive_instances_created_v1] 
| where cardinality >=16 
| apply cloud_excessive_instances_created_v1 threshold=0.005 
| rename ""IsOutlier(instances_launched)"" as isOutlier 
| where isOutlier=1 
| eval expected_upper_threshold = mvindex(split(mvindex(BoundaryRanges, -1), "":""), 0) 
| eval distance_from_threshold = instances_launched - expected_upper_threshold 
| table _time, user, instances_launched, expected_upper_threshold, distance_from_threshold, object_id 
| `abnormally_high_number_of_cloud_instances_launched_filter`"
Amazon EKS Kubernetes cluster scan detection,"The following analytic detects unauthenticated requests to an Amazon EKS Kubernetes cluster, specifically identifying actions by the &quot;system:anonymous&quot; user.",AWS CloudTrail,"Discovery, Exfiltration",T1526,"`aws_cloudwatchlogs_eks` ""user.username""=""system:anonymous"" userAgent!=""AWS Security Scanner"" 
| rename sourceIPs{} as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime values(responseStatus.reason) values(source) as cluster_name values(responseStatus.code) values(userAgent) as http_user_agent values(verb) values(requestURI) by src_ip user.username user.groups{} 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
|`amazon_eks_kubernetes_cluster_scan_detection_filter`"
Amazon EKS Kubernetes Pod scan detection,"The following analytic detects unauthenticated requests made against the Kubernetes Pods API, indicating potential unauthorized access attempts.",AWS CloudTrail,"Lateral Movement, Execution, Discovery",T1526,"`aws_cloudwatchlogs_eks` ""user.username""=""system:anonymous"" verb=list objectRef.resource=pods requestURI=""/api/v1/pods"" 
| rename source as cluster_name sourceIPs{} as src_ip 
| stats count min(_time) as firstTime max(_time) as lastTime values(responseStatus.reason) values(responseStatus.code) values(userAgent) values(verb) values(requestURI) by src_ip cluster_name user.username user.groups{} 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `amazon_eks_kubernetes_pod_scan_detection_filter`"
ASL AWS Credential Access GetPasswordData,"The following analytic identifiesGetPasswordData API calls in your AWS account. It leverages CloudTrail logs from Amazon Security Lake to detect this activity by counting the distinct instance IDs accessed. This behavior is significant as it may indicate an attempt to retrieve encrypted administrator passwords for running Windows instances, which is a critical security concern.",AWS CloudTrail,"Credential Access, Defense Evasion","T1586.003, T1552, T1110.001","`amazon_security_lake` api.operation=GetPasswordData 
| spath input=api.request.data 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region instanceId 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`asl_aws_credential_access_getpassworddata_filter`"
ASL AWS Defense Evasion Delete Cloudtrail,"The following analytic detects AWS DeleteTrail events within CloudTrail logs. It leverages Amazon Security Lake logs parsed in the Open Cybersecurity Schema Framework (OCSF) format to identify when a CloudTrail is deleted. This activity is significant because adversaries may delete CloudTrail logs to evade detection and operate with stealth. If confirmed malicious, this action could allow attackers to cover their tracks, making it difficult to trace their activities and investigate other potential compromises within the AWS environment.",AWS CloudTrail,"Credential Access, Defense Evasion","T1562.008, T1562","`amazon_security_lake` api.operation=DeleteTrail 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_delete_cloudtrail_filter`"
ASL AWS Defense Evasion Delete CloudWatch Log Group,"The following analytic detects the deletion of CloudWatch log groups in AWS, identified through DeleteLogGroup events in CloudTrail logs. This method leverages Amazon Security Lake logs parsed in the OCSF format. The activity is significant because attackers may delete log groups to evade detection and disrupt logging capabilities, hindering incident response efforts. If confirmed malicious, this action could allow attackers to cover their tracks, making it difficult to trace their activities and potentially leading to undetected data breaches or further malicious actions within the compromised AWS environment.",AWS CloudTrail,Defense Evasion,"T1562.008, T1562","`amazon_security_lake` api.operation=DeleteLogGroup 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_delete_cloudwatch_log_group_filter`"
ASL AWS Defense Evasion Impair Security Services,"The following analytic detects the deletion of critical AWS Security Services configurations, such as CloudWatch alarms, GuardDuty detectors, and Web Application Firewall rules. It leverages Amazon Security Lake logs to identify specific API calls like &quot;DeleteLogStream&quot; and &quot;DeleteDetector.&quot; This activity is significant because adversaries often use these actions to disable security monitoring and evade detection.",AWS CloudTrail,"Persistence, Defense Evasion",T1562.008,"`amazon_security_lake` api.operation IN (""DeleteLogStream"",""DeleteDetector"",""DeleteIPSet"",""DeleteWebACL"",""DeleteRule"",""DeleteRuleGroup"",""DeleteLoggingConfiguration"",""DeleteAlarms"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_impair_security_services_filter`"
ASL AWS Defense Evasion PutBucketLifecycle,"The following analytic detects PutBucketLifecycle events in AWS CloudTrail logs where a user sets a lifecycle rule for an S3 bucket with an expiration period of fewer than three days. This detection leverages CloudTrail logs to identify suspicious lifecycle configurations. This activity is significant because attackers may use it to delete CloudTrail logs quickly, thereby evading detection and impairing forensic investigations.",AWS CloudTrail,"Impact, Defense Evasion","T1562.008, T1485.001","`amazon_security_lake` api.operation=PutBucketLifecycle 
| spath input=api.request.data path=LifecycleConfiguration.Rule.NoncurrentVersionExpiration.NoncurrentDays output=NoncurrentDays 
| where NoncurrentDays < 3 
| spath input=api.request.data 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region NoncurrentDays bucketName 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
|  `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_putbucketlifecycle_filter`"
ASL AWS Defense Evasion Stop Logging Cloudtrail,"The following analytic detects StopLogging events within AWS CloudTrail logs, a critical action that adversaries may use to evade detection. By halting the logging of their malicious activities, attackers aim to operate undetected within a compromised AWS environment. This detection is achieved by monitoring for specific CloudTrail log entries that indicate the cessation of logging activities.",AWS CloudTrail,"Impact, Defense Evasion","T1562.008, T1562","`amazon_security_lake` api.operation=StopLogging 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_stop_logging_cloudtrail_filter`"
ASL AWS Defense Evasion Update Cloudtrail,"The following analytic detects UpdateTrail events within AWS CloudTrail logs, aiming to identify attempts by attackers to evade detection by altering logging configurations. By updating CloudTrail settings with incorrect parameters, such as changing multi-regional logging to a single region, attackers can impair the logging of their activities across other regions. This behavior is crucial for Security Operations Centers (SOCs) to identify, as it indicates an adversary's intent to operate undetected within a compromised AWS environment.",AWS CloudTrail,"Impact, Defense Evasion","T1562.008, T1562","`amazon_security_lake` api.operation=UpdateTrail 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_defense_evasion_update_cloudtrail_filter`"
ASL AWS Disable Bucket Versioning,"The following analytic detects when AWS S3 bucket versioning is suspended by a user. It leverages AWS CloudTrail logs to identify PutBucketVersioning events with the VersioningConfiguration.Status set to Suspended. This activity is significant because disabling versioning can prevent recovery of deleted or modified data, which is a common tactic in ransomware attacks. If confirmed malicious, this action could lead to data loss and hinder recovery efforts, severely impacting data integrity and availability.",AWS CloudTrail,"Exfiltration, Impact, Defense Evasion",T1490,"`amazon_security_lake` api.operation=PutBucketVersioning 
| spath input=api.request.data path=VersioningConfiguration.Status output=Status 
| spath input=api.request.data path=bucketName output=bucketName 
| search Status=Suspended 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data bucketName 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `asl_aws_disable_bucket_versioning_filter`"
ASL AWS EC2 Snapshot Shared Externally,"The following analytic detects when an EC2 snapshot is shared publicly by analyzing AWS CloudTrail events. This detection method leverages CloudTrail logs to identify modifications in snapshot permissions, specifically when the snapshot is shared outside the originating AWS account. This activity is significant as it may indicate an attempt to exfiltrate sensitive data stored in the snapshot.",AWS CloudTrail,Exfiltration,T1537,"`amazon_security_lake` api.operation=ModifySnapshotAttribute 
| spath input=api.request.data path=createVolumePermission.add.items{}.group output=group 
| search group=all 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_ec2_snapshot_shared_externally_filter`"
ASL AWS ECR Container Upload Outside Business Hours,"The following analytic detects the upload of new containers to AWS Elastic Container Service (ECR) outside of standard business hours through AWS CloudTrail events. It identifies this behavior by monitoring for PutImage events occurring before 8 AM or after 8 PM, as well as any uploads on weekends. This activity is significant for a SOC to investigate as it may indicate unauthorized access or malicious deployments, potentially leading to compromised services or data breaches.",AWS CloudTrail,"Execution, Impact, Discovery","T1204.003, T1204","`amazon_security_lake` api.operation=PutImage 
| eval hour=strftime(time/pow(10,3), ""%H""), weekday=strftime(time/pow(10,3), ""%A"") 
| where hour >= 20 OR hour < 8 OR weekday=Saturday OR weekday=Sunday 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region api.request.data bucketName 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_ecr_container_upload_outside_business_hours_filter`"
ASL AWS IAM AccessDenied Discovery Events,The following analytic identifies excessive AccessDenied events within an hour timeframe for IAM users in AWS. It leverages AWS CloudTrail logs to detect multiple failed access attempts from the same source IP and user identity. This activity is significant as it may indicate that an access key has been compromised and is being misused for unauthorized discovery actions.,AWS CloudTrail,"Discovery, Privilege Escalation",T1580,"`amazon_security_lake` api.response.error=AccessDenied OR api.response.error=OperationNotPermittedException OR api.response.error=*Unauthorized* actor.user.type=IAMUser 
| bucket _time span=1h 
| stats count as failures min(_time) as firstTime max(_time) as lastTime dc(api.operation) as dc_operation, dc(api.service.name) as dc_service values(api.operation) as api.operation values(api.service.name) as api.service.name values(http_request.user_agent) as http_request.user_agent values(src_endpoint.ip) as src_ip values(actor.user.account.uid) as actor.user.account.uid values(cloud.provider) as cloud.provider values(cloud.region) as cloud.region by _time actor.user.uid 
| where failures >= 5 AND dc_operation >= 1 AND dc_service >= 1 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_iam_accessdenied_discovery_events_filter`"
ASL AWS IAM Delete Policy,"The following analytic identifies when a policy is deleted in AWS. It leverages Amazon Security Lake logs to detect the DeletePolicy API operation. Monitoring policy deletions is crucial as it can indicate unauthorized attempts to weaken security controls. If confirmed malicious, this activity could allow an attacker to remove critical security policies, potentially leading to privilege escalation or unauthorized access to sensitive resources.",AWS CloudTrail,"Discovery, Persistence, Privilege Escalation",T1098,"`amazon_security_lake` api.operation=DeletePolicy 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_iam_delete_policy_filter`"
ASL AWS IAM Failure Group Deletion,"The following analytic detects failed attempts to delete AWS IAM groups, triggered by access denial, conflicts, or non-existent groups. It operates by monitoring CloudTrail logs for specific error codes related to deletion failures. This behavior is significant for a SOC as it may indicate unauthorized attempts to modify access controls or disrupt operations by removing groups.",AWS CloudTrail,"Persistence, Impact, Privilege Escalation",T1098,"`amazon_security_lake` api.operation=DeleteGroup status=Failure http_request.user_agent!=*.amazonaws.com 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_iam_failure_group_deletion_filter`"
ASL AWS IAM Successful Group Deletion,"The following analytic detects the successful deletion of a group within AWS IAM, leveraging CloudTrail IAM events. This action, while not inherently malicious, can serve as a precursor to more sinister activities, such as unauthorized access or privilege escalation attempts. By monitoring for such deletions, the analytic aids in identifying potential preparatory steps towards an attack, allowing for early detection and mitigation.",AWS CloudTrail,"Discovery, Persistence, Impact, Privilege Escalation","T1069.003, T1098","`amazon_security_lake` api.operation=DeleteGroup status=Success 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_iam_successful_group_deletion_filter`"
ASL AWS Multi-Factor Authentication Disabled,"The following analytic detects attempts to disable multi-factor authentication (MFA) for an AWS IAM user. It leverages Amazon Security Lake logs, specifically monitoring for DeleteVirtualMFADevice or DeactivateMFADevice API operations. This activity is significant as disabling MFA can indicate an adversary attempting to weaken account security to maintain persistence using a compromised account. If confirmed malicious, this action could allow attackers to retain access to the AWS environment without detection, potentially leading to unauthorized access to sensitive resources and prolonged compromise.",AWS CloudTrail,"Persistence, Credential Access, Defense Evasion","T1556.006, T1586.003, T1621","`amazon_security_lake` (api.operation=DeleteVirtualMFADevice OR api.operation=DeactivateMFADevice) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_multi_factor_authentication_disabled_filter`"
ASL AWS Network Access Control List Created with All Open Ports,"The following analytic detects the creation of AWS Network Access Control Lists (ACLs) with all ports open to a specified CIDR. It leverages AWS CloudTrail events, specifically monitoring for CreateNetworkAclEntry or ReplaceNetworkAclEntry actions with rules allowing all traffic. This activity is significant because it can expose the network to unauthorized access, increasing the risk of data breaches and other malicious activities.",AWS CloudTrail,"Exfiltration, Defense Evasion",T1562.007,"`amazon_security_lake` api.operation=CreateNetworkAclEntry OR api.operation=ReplaceNetworkAclEntry status=Success 
| spath input=api.request.data path=ruleAction output=ruleAction 
| spath input=api.request.data path=egress output=egress 
| spath input=api.request.data path=aclProtocol output=aclProtocol 
| spath input=api.request.data path=cidrBlock output=cidrBlock 
| spath input=api.request.data path=networkAclId output=networkAclId 
| search ruleAction=allow AND egress=false AND aclProtocol=-1 AND cidrBlock=0.0.0.0/0 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region networkAclId cidrBlock 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_network_access_control_list_created_with_all_open_ports_filter`"
ASL AWS SAML Update identity provider,"The following analytic detects updates to the SAML provider in AWS. It leverages AWS CloudTrail logs to identify the UpdateSAMLProvider event, analyzing fields such as sAMLProviderArn, sourceIPAddress, and userIdentity details. Monitoring updates to the SAML provider is crucial as it may indicate a perimeter compromise of federated credentials or unauthorized backdoor access set by an attacker.",AWS CloudTrail,Defense Evasion,T1078,"`amazon_security_lake` api.operation=UpdateSAMLProvider 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `asl_aws_saml_update_identity_provider_filter`"
ASL AWS UpdateLoginProfile,"The following analytic detects an AWS CloudTrail event where a user with permissions updates the login profile of another user. It leverages CloudTrail logs to identify instances where the user making the change is different from the user whose profile is being updated. This activity is significant because it can indicate privilege escalation attempts, where an attacker uses a compromised account to gain higher privileges.",AWS CloudTrail,"Persistence, Privilege Escalation, Exfiltration",T1136.003,"`amazon_security_lake` api.operation=UpdateLoginProfile 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by actor.user.uid api.operation api.service.name http_request.user_agent src_endpoint.ip actor.user.account.uid cloud.provider cloud.region 
| rename actor.user.uid as user api.operation as action api.service.name as dest http_request.user_agent as user_agent src_endpoint.ip as src actor.user.account.uid as vendor_account cloud.provider as vendor_product cloud.region as vendor_region 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `asl_aws_updateloginprofile_filter`"
AWS AMI Attribute Modification for Exfiltration,"The following analytic detects suspicious modifications to AWS AMI attributes, such as sharing an AMI with another AWS account or making it publicly accessible. It leverages AWS CloudTrail logs to identify these changes by monitoring specific API calls. This activity is significant because adversaries can exploit these modifications to exfiltrate sensitive data stored in AWS resources.",AWS CloudTrail,Exfiltration,T1537,"`cloudtrail` eventName=ModifyImageAttribute (requestParameters.launchPermission.add.items{}.userId = * OR requestParameters.launchPermission.add.items{}.group = all) 
| rename requestParameters.launchPermission.add.items{}.group as group_added 
| rename requestParameters.launchPermission.add.items{}.userId as accounts_added 
| eval ami_status=if(match(group_added,""all"") ,""Public AMI"", ""Not Public"") 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(group_added) as group_added values(accounts_added) as accounts_added values(ami_status) as ami_status by signature dest user user_agent src vendor_account vendor_region vendor_product 
|  `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `aws_ami_attribute_modification_for_exfiltration_filter`"
AWS Bedrock Delete GuardRails,"The following analytic identifies attempts to delete AWS Bedrock GuardRails, which are security controls designed to prevent harmful, biased, or inappropriate AI outputs. It leverages AWS CloudTrail logs to detect when a user or service calls the DeleteGuardrail API. This activity is significant as it may indicate an adversary attempting to remove safety guardrails after compromising credentials, potentially to enable harmful or malicious model outputs.",AWS CloudTrail,"Exfiltration, Defense Evasion","T1562.008, T1562","`cloudtrail` eventSource=bedrock.amazonaws.com eventName=DeleteGuardrail  
| rename user_name as user  
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.guardrailIdentifier) as guardrailIds by src user user_agent vendor_account vendor_product dest signature vendor_region   
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `aws_bedrock_delete_guardrails_filter`"
AWS Bedrock Delete Knowledge Base,"The following analytic identifies attempts to delete AWS Bedrock Knowledge Bases, which are resources that store and manage domain-specific information for AI models. It monitors AWS CloudTrail logs for DeleteKnowledgeBase API calls. This activity could indicate an adversary attempting to remove knowledge bases after compromising credentials, potentially to disrupt business operations or remove traces of data access.",AWS CloudTrail,Impact,"T1562, T1485","`cloudtrail` eventSource=bedrock.amazonaws.com eventName=DeleteKnowledgeBase  
| rename user_name as user  
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.knowledgeBaseId) as knowledgeBaseIds by src user user_agent vendor_account vendor_product dest signature vendor_region  
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `aws_bedrock_delete_knowledge_base_filter`"
AWS Bedrock Delete Model Invocation Logging Configuration,"The following analytic identifies attempts to delete AWS Bedrock model invocation logging configurations. It leverages AWS CloudTrail logs to detect when a user or service calls the DeleteModelInvocationLogging API. This activity is significant as it may indicate an adversary attempting to remove audit trails of model interactions after compromising credentials. Deleting model invocation logs could allow attackers to interact with AI models without leaving traces, potentially enabling them to conduct data exfiltration, prompt injection attacks, or other malicious activities without detection.",AWS CloudTrail,"Exfiltration, Defense Evasion","T1562.008, T1562","`cloudtrail` eventSource=bedrock.amazonaws.com eventName=DeleteModelInvocationLoggingConfiguration  
| rename user_name as user  
| stats count min(_time) as firstTime max(_time) as lastTime by src user user_agent vendor_account vendor_product dest signature vendor_region  
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `aws_bedrock_delete_model_invocation_logging_configuration_filter`"
AWS Bedrock High Number List Foundation Model Failures,The following analytic identifies an high number of AccessDenied attempts to list AWS Bedrock foundation models. It leverages AWS CloudTrail logs to detect when a user or service experiences multiple failures when calling the ListFoundationModels API. This activity is significant as it may indicate an adversary performing reconnaissance of available AI models after compromising credentials with limited permissions.,AWS CloudTrail,Discovery,"T1595, T1580","`cloudtrail` eventSource=bedrock.amazonaws.com eventName=ListFoundationModels errorCode=AccessDenied  
| rename user_name as user  
| stats count min(_time) as firstTime max(_time) as lastTime values(errorCode) as errorCodes values(errorMessage) as errorMessages by src user user_agent vendor_account vendor_product dest signature vendor_region 
| where count > 9 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `aws_bedrock_high_number_list_foundation_model_failures_filter`"
AWS Bedrock Invoke Model Access Denied,The following analytic identifies access denied error when attempting to invoke AWS Bedrock models. It leverages AWS CloudTrail logs to detect when a user or service receives an AccessDenied error when calling the InvokeModel API. This activity is significant as it may indicate an adversary attempting to access Bedrock models with insufficient permissions after compromising credentials.,AWS CloudTrail,"Initial Access, Exfiltration, Privilege Escalation, Defense Evasion","T1550, T1595, T1078","`cloudtrail` eventSource=bedrock.amazonaws.com eventName=InvokeModel errorCode=AccessDenied  
| rename user_name as user  
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.modelId) as modelIds by src user user_agent vendor_account vendor_product dest signature vendor_region result result_id 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `aws_bedrock_invoke_model_access_denied_filter`"
AWS Console Login Failed During MFA Challenge,"The following analytic identifies failed authentication attempts to the AWS Console during the Multi-Factor Authentication (MFA) challenge. It leverages AWS CloudTrail logs, specifically the additionalEventData field, to detect when MFA was used but the login attempt still failed. This activity is significant as it may indicate an adversary attempting to access an account with compromised credentials but being thwarted by MFA.",AWS CloudTrail,Credential Access,"T1586.003, T1621","`cloudtrail` eventName= ConsoleLogin errorMessage=""Failed authentication"" additionalEventData.MFAUsed = ""Yes"" 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product additionalEventData.MFAUsed errorMessage 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_console_login_failed_during_mfa_challenge_filter`"
AWS Create Policy Version to allow all resources,"The following analytic identifies the creation of a new AWS IAM policy version that allows access to all resources. It detects this activity by analyzing AWS CloudTrail logs for the CreatePolicyVersion event with a policy document that grants broad permissions. This behavior is significant because it violates the principle of least privilege, potentially exposing the environment to misuse or abuse.",AWS CloudTrail,"Exfiltration, Privilege Escalation, Defense Evasion",T1078.004,"`cloudtrail` eventName=CreatePolicyVersion eventSource = iam.amazonaws.com errorCode = success 
| spath input=requestParameters.policyDocument output=key_policy_statements path=Statement{} 
| mvexpand key_policy_statements 
| spath input=key_policy_statements output=key_policy_action_1 path=Action 
| where key_policy_action_1 = ""*"" 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(key_policy_statements) as policy_added by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`aws_create_policy_version_to_allow_all_resources_filter`"
AWS CreateAccessKey,"The following analytic identifies the creation of AWS IAM access keys by a user for another user, which can indicate privilege escalation. It leverages AWS CloudTrail logs to detect instances where the user creating the access key is different from the user for whom the key is created. This activity is significant because unauthorized access key creation can allow attackers to establish persistence or exfiltrate data via AWS APIs.",AWS CloudTrail,"Persistence, Privilege Escalation, Exfiltration",T1136.003,"`cloudtrail` eventName = CreateAccessKey userAgent !=console.amazonaws.com errorCode = success 
| eval match=if(match(userIdentity.userName,requestParameters.userName),1,0) 
| search match=0 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`aws_createaccesskey_filter`"
AWS CreateLoginProfile,"The following analytic identifies the creation of a login profile for one AWS user by another, followed by a console login from the same source IP. It uses AWS CloudTrail logs to correlate the CreateLoginProfile and ConsoleLogin events based on the source IP and user identity. This activity is significant as it may indicate privilege escalation, where an attacker creates a new login profile to gain unauthorized access.",AWS CloudTrail,"Persistence, Credential Access, Privilege Escalation",T1136.003,"`cloudtrail` eventName = CreateLoginProfile 
| rename requestParameters.userName as new_login_profile 
| table src_ip eventName new_login_profile userIdentity.userName 
| join new_login_profile src_ip [
| search `cloudtrail` eventName = ConsoleLogin 
| rename userIdentity.userName  as new_login_profile 
| stats count values(eventName) min(_time) as firstTime max(_time) as lastTime by eventSource aws_account_id errorCode user_agent eventID awsRegion userIdentity.principalId user_arn new_login_profile src_ip dest vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`] 
| rename user_arn as user 
| `aws_createloginprofile_filter`"
AWS Credential Access Failed Login,The following analytic identifies unsuccessful login attempts to the AWS Management Console using a specific user identity. It leverages AWS CloudTrail logs to detect failed authentication events associated with the AWS ConsoleLogin action. This activity is significant for a SOC because repeated failed login attempts may indicate a brute force attack or unauthorized access attempts.,AWS CloudTrail,Credential Access,"T1586.003, T1110, T1110.001","`cloudtrail` eventName = ConsoleLogin errorMessage=""Failed authentication"" 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_credential_access_failed_login_filter`"
AWS Credential Access GetPasswordData,"The following analytic identifies more than 10 GetPasswordData API calls within a 5-minute window in your AWS account. It leverages AWS CloudTrail logs to detect this activity by counting the distinct instance IDs accessed. This behavior is significant as it may indicate an attempt to retrieve encrypted administrator passwords for running Windows instances, which is a critical security concern.",AWS CloudTrail,"Credential Access, Defense Evasion","T1586.003, T1552, T1110.001","`cloudtrail` eventName=GetPasswordData eventSource = ec2.amazonaws.com 
| bin _time span=5m 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime dc(requestParameters.instanceId) as distinct_instance_ids by signature dest user user_agent src vendor_account vendor_region vendor_product 
|  where distinct_instance_ids > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_credential_access_getpassworddata_filter`"
AWS Defense Evasion Delete Cloudtrail,"The following analytic detects the deletion of AWS CloudTrail logs by identifying DeleteTrail events within CloudTrail logs. This detection leverages CloudTrail data to monitor for successful DeleteTrail actions, excluding those initiated from the AWS console. This activity is significant because adversaries may delete CloudTrail logs to evade detection and operate stealthily within the compromised environment.",AWS CloudTrail,"Credential Access, Defense Evasion","T1562.008, T1562","`cloudtrail` eventName = DeleteTrail eventSource = cloudtrail.amazonaws.com userAgent !=console.amazonaws.com errorCode = success 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `aws_defense_evasion_delete_cloudtrail_filter`"
AWS Defense Evasion Delete CloudWatch Log Group,"The following analytic detects the deletion of CloudWatch log groups in AWS, identified through DeleteLogGroup events in CloudTrail logs. This detection leverages CloudTrail data to monitor for successful log group deletions, excluding console-based actions. This activity is significant as it indicates potential attempts to evade logging and monitoring, which is crucial for maintaining visibility into AWS activities.",AWS CloudTrail,Defense Evasion,"T1562.008, T1562","`cloudtrail` eventName = DeleteLogGroup eventSource = logs.amazonaws.com userAgent !=console.amazonaws.com errorCode = success 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `aws_defense_evasion_delete_cloudwatch_log_group_filter`"
AWS Defense Evasion PutBucketLifecycle,"The following analytic detects PutBucketLifecycle events in AWS CloudTrail logs where a user sets a lifecycle rule for an S3 bucket with an expiration period of fewer than three days. This detection leverages CloudTrail logs to identify suspicious lifecycle configurations. This activity is significant because attackers may use it to delete CloudTrail logs quickly, thereby evading detection and impairing forensic investigations.",AWS CloudTrail,"Impact, Defense Evasion","T1562.008, T1485.001","`cloudtrail` eventName=PutBucketLifecycle user_type=IAMUser errorCode=success 
| spath path=requestParameters{}.LifecycleConfiguration{}.Rule{}.Expiration{}.Days output=expiration_days 
| spath path=requestParameters{}.bucketName output=bucket_name 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product bucket_name expiration_days 
| `security_content_ctime(firstTime)` 
|  `security_content_ctime(lastTime)` 
| `aws_defense_evasion_putbucketlifecycle_filter`"
AWS Defense Evasion Stop Logging Cloudtrail,"The following analytic detects StopLogging events in AWS CloudTrail logs. It leverages CloudTrail event data to identify when logging is intentionally stopped, excluding console-based actions and focusing on successful attempts. This activity is significant because adversaries may stop logging to evade detection and operate stealthily within the compromised environment. If confirmed malicious, this action could allow attackers to perform further activities without being logged, hindering incident response and forensic investigations, and potentially leading to unauthorized access or data exfiltration.",AWS CloudTrail,"Exfiltration, Defense Evasion","T1562.008, T1562","`cloudtrail` eventName = StopLogging eventSource = cloudtrail.amazonaws.com userAgent!=console.amazonaws.com errorCode = success 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_defense_evasion_stop_logging_cloudtrail_filter`"
AWS Defense Evasion Update Cloudtrail,"The following analytic detects UpdateTrail events in AWS CloudTrail logs. It identifies attempts to modify CloudTrail settings, potentially to evade logging. The detection leverages CloudTrail logs, focusing on UpdateTrail events where the user agent is not the AWS console and the operation is successful. This activity is significant because altering CloudTrail settings can disable or limit logging, hindering visibility into AWS account activities.",AWS CloudTrail,Defense Evasion,"T1562.008, T1562","`cloudtrail` eventName = UpdateTrail eventSource = cloudtrail.amazonaws.com userAgent !=console.amazonaws.com errorCode = success 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `aws_defense_evasion_update_cloudtrail_filter`"
AWS Detect Users with KMS keys performing encryption S3,"The following analytic identifies users with KMS keys performing encryption operations on S3 buckets. It leverages AWS CloudTrail logs to detect the CopyObject event where server-side encryption with AWS KMS is specified. This activity is significant as it may indicate unauthorized or suspicious encryption of data, potentially masking exfiltration or tampering efforts.",AWS CloudTrail,"Exfiltration, Impact, Defense Evasion",T1486,"`cloudtrail` eventName=CopyObject requestParameters.x-amz-server-side-encryption=""aws:kms"" 
| rename requestParameters.bucketName AS bucketName, requestParameters.x-amz-copy-source AS src_file, requestParameters.key AS dest_file 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product bucketName src_file dest_file 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `aws_detect_users_with_kms_keys_performing_encryption_s3_filter`"
AWS Disable Bucket Versioning,"The following analytic detects when AWS S3 bucket versioning is suspended by a user. It leverages AWS CloudTrail logs to identify PutBucketVersioning events with the VersioningConfiguration.Status set to Suspended. This activity is significant because disabling versioning can prevent recovery of deleted or modified data, which is a common tactic in ransomware attacks. If confirmed malicious, this action could lead to data loss and hinder recovery efforts, severely impacting data integrity and availability.",AWS CloudTrail,"Impact, Exfiltration",T1490,"`cloudtrail` eventName= PutBucketVersioning ""requestParameters.VersioningConfiguration.Status""=Suspended 
| rename user_name as user, requestParameters.bucketName as bucket_name 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product bucket_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_disable_bucket_versioning_filter`"
AWS EC2 Snapshot Shared Externally,"The following analytic detects when an EC2 snapshot is shared with an external AWS account by analyzing AWS CloudTrail events. This detection method leverages CloudTrail logs to identify modifications in snapshot permissions, specifically when the snapshot is shared outside the originating AWS account. This activity is significant as it may indicate an attempt to exfiltrate sensitive data stored in the snapshot.",AWS CloudTrail,Exfiltration,T1537,"`cloudtrail` eventName=ModifySnapshotAttribute 
| rename requestParameters.createVolumePermission.add.items{}.userId as requested_account_id 
| search requested_account_id != NULL 
| eval match=if(requested_account_id==aws_account_id,""Match"",""No Match"") 
| where match = ""No Match"" 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product requested_account_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ec2_snapshot_shared_externally_filter`"
AWS ECR Container Upload Outside Business Hours,"The following analytic detects the upload of a new container image to AWS Elastic Container Registry (ECR) outside of standard business hours. It leverages AWS CloudTrail logs to identify PutImage events occurring between 8 PM and 8 AM or on weekends. This activity is significant because container uploads outside business hours can indicate unauthorized or suspicious activity, potentially pointing to a compromised account or insider threat.",AWS CloudTrail,Execution,"T1204.003, T1204","`cloudtrail` eventSource=ecr.amazonaws.com eventName=PutImage date_hour>=20 OR date_hour<8 OR date_wday=saturday OR date_wday=sunday 
| rename requestParameters.* as * 
| rename repositoryName AS repository 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature user user_agent src vendor_account vendor_region vendor_product repository 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_ecr_container_upload_outside_business_hours_filter`"
AWS Excessive Security Scanning,"The following analytic identifies excessive security scanning activities in AWS by detecting a high number of Describe, List, or Get API calls from a single user. It leverages AWS CloudTrail logs to count distinct event names and flags users with more than 50 such events. This behavior is significant as it may indicate reconnaissance activities by an attacker attempting to map out your AWS environment.",AWS CloudTrail,"Discovery, Exfiltration",T1526,"`cloudtrail` eventName=Describe* OR eventName=List* OR eventName=Get* 
| fillnull 
| rename user_name as user 
| stats dc(signature) as dc_events min(_time) as firstTime max(_time) as lastTime values(signature) as signature values(dest) as dest values(user_agent) as user_agent values(src) as src values(vendor_account) as vendor_account values(vendor_region) as vendor_region by user 
| where dc_events > 50 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
|`aws_excessive_security_scanning_filter`"
AWS Exfiltration via Anomalous GetObject API Activity,"The following analytic identifies anomalous GetObject API activity in AWS, indicating potential data exfiltration attempts. It leverages AWS CloudTrail logs and uses the anomalydetection command to detect unusual patterns in the frequency of GetObject API calls by analyzing fields such as &quot;count,&quot; &quot;user_type,&quot; and &quot;user_arn&quot; within a 10-minute window. This activity is significant as it may indicate unauthorized data access or exfiltration from S3 buckets.",AWS CloudTrail,"Collection, Exfiltration",T1119,"`cloudtrail` eventName=GetObject 
| bin _time span=10m 
| rename user_name as user 
| stats count values(requestParameters.bucketName) as bucketName by signature dest user user_agent src vendor_account vendor_region vendor_product 
| anomalydetection ""count"" ""user"" action=annotate 
| search probable_cause=* 
|`aws_exfiltration_via_anomalous_getobject_api_activity_filter`"
AWS Exfiltration via Batch Service,"The following analytic identifies the creation of AWS Batch jobs that could potentially abuse the AWS Bucket Replication feature on S3 buckets. It leverages AWS CloudTrail logs to detect the JobCreated event, analyzing job details and their status. This activity is significant because attackers can exploit this feature to exfiltrate data by creating malicious batch jobs.",AWS CloudTrail,"Collection, Exfiltration",T1119,"`cloudtrail` eventName = JobCreated 
| fillnull 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_exfiltration_via_batch_service_filter`"
AWS Exfiltration via Bucket Replication,"The following analytic detects API calls to enable S3 bucket replication services. It leverages AWS CloudTrail logs to identify PutBucketReplication events, focusing on fields like bucketName, ReplicationConfiguration.Rule.Destination.Bucket, and user details. This activity is significant as it can indicate unauthorized data replication, potentially leading to data exfiltration. If confirmed malicious, attackers could replicate sensitive data to external accounts, leading to data breaches and compliance violations.",AWS CloudTrail,Exfiltration,T1537,"`cloudtrail`  eventName = PutBucketReplication eventSource = s3.amazonaws.com 
| rename user_name as user, requestParameters.ReplicationConfiguration.Rule.Destination.Bucket as bucket_name 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product bucket_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_exfiltration_via_bucket_replication_filter`"
AWS Exfiltration via EC2 Snapshot,"The following analytic detects a series of AWS API calls related to EC2 snapshots within a short time window, indicating potential exfiltration via EC2 Snapshot modifications. It leverages AWS CloudTrail logs to identify actions such as creating, describing, and modifying snapshot attributes. This activity is significant as it may indicate an attacker attempting to exfiltrate data by sharing EC2 snapshots externally.",AWS CloudTrail,Exfiltration,T1537,"`cloudtrail` eventName IN (""CreateSnapshot"", ""DescribeSnapshotAttribute"", ""ModifySnapshotAttribute"", ""DeleteSnapshot"") src_ip !=""guardduty.amazonaws.com"" 
|  bin _time span=5m 
| rename user_name as user 
|  stats count dc(signature) as distinct_api_calls values(signature) as signature values(dest) as dest values(requestParameters.attributeType) as attributeType values(requestParameters.createVolumePermission.add.items{}.userId) as aws_account_id_added values(user_agent) as user_agent by _time user src vendor_account vendor_region vendor_product 
| where distinct_api_calls >= 2 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_exfiltration_via_ec2_snapshot_filter`"
AWS High Number Of Failed Authentications For User,"The following analytic detects an AWS account experiencing more than 20 failed authentication attempts within a 5-minute window. It leverages AWS CloudTrail logs to identify multiple failed ConsoleLogin events. This behavior is significant as it may indicate a brute force attack targeting the account. If confirmed malicious, the attacker could potentially gain unauthorized access, leading to data breaches or further exploitation of the AWS environment.",AWS CloudTrail,"Discovery, Exfiltration",T1201,"`cloudtrail` eventName=ConsoleLogin action=failure 
| bucket span=10m _time 
| rename user_name as user 
| stats dc(_raw) AS failed_attempts values(src) as src values(user_agent) as user_agent by _time, user, signature, dest, vendor_account vendor_region, vendor_product 
| where failed_attempts > 20 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_high_number_of_failed_authentications_for_user_filter`"
AWS High Number Of Failed Authentications From Ip,"The following analytic detects an IP address with 20 or more failed authentication attempts to the AWS Web Console within a 5-minute window. This detection leverages CloudTrail logs, aggregating failed login events by IP address and time span. This activity is significant as it may indicate a brute force attack aimed at gaining unauthorized access or escalating privileges within an AWS environment.",AWS CloudTrail,"Credential Access, Discovery","T1110.004, T1110.003, T1110","`cloudtrail` eventName=ConsoleLogin action=failure 
| bucket span=10m _time 
| rename user_name as user 
| stats dc(_raw) AS failed_attempts values(user) as user values(user_agent) as user_agent by _time, src, signature, dest, vendor_account vendor_region, vendor_product 
| where failed_attempts > 20 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_high_number_of_failed_authentications_from_ip_filter`"
AWS IAM AccessDenied Discovery Events,The following analytic identifies excessive AccessDenied events within an hour timeframe for IAM users in AWS. It leverages AWS CloudTrail logs to detect multiple failed access attempts from the same source IP and user identity. This activity is significant as it may indicate that an access key has been compromised and is being misused for unauthorized discovery actions.,AWS CloudTrail,"Discovery, Privilege Escalation",T1580,"`cloudtrail` (errorCode = ""AccessDenied"") user_type=IAMUser (userAgent!=*.amazonaws.com) 
| bucket _time span=1h 
| rename user_name as user 
| stats count as failures min(_time) as firstTime max(_time) as lastTime, dc(signature) as methods, dc(dest) as sources values(signature) as signature values(dest) as dest by src, user, vendor_account vendor_region, vendor_product 
| where failures >= 5 and methods >= 1 and sources >= 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_iam_accessdenied_discovery_events_filter`"
AWS IAM Assume Role Policy Brute Force,"The following analytic detects multiple failed attempts to assume an AWS IAM role, indicating a potential brute force attack. It leverages AWS CloudTrail logs to identify MalformedPolicyDocumentException errors with a status of failure and filters out legitimate AWS services. This activity is significant as repeated failures to assume roles can indicate an adversary attempting to guess role names, which is a precursor to unauthorized access.",AWS CloudTrail,"Discovery, Credential Access, Privilege Escalation","T1110, T1580","`cloudtrail` (errorCode=MalformedPolicyDocumentException) status=failure (userAgent!=*.amazonaws.com) 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.policyName) as policy_name by src, user, vendor_account vendor_region, vendor_product, signature, dest, errorCode 
| where count >= 2 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_iam_assume_role_policy_brute_force_filter`"
AWS IAM Delete Policy,"The following analytic detects the deletion of an IAM policy in AWS. It leverages AWS CloudTrail logs to identify DeletePolicy events, excluding those from AWS internal services. This activity is significant as unauthorized policy deletions can disrupt access controls and weaken security postures. If confirmed malicious, an attacker could remove critical security policies, potentially leading to privilege escalation, unauthorized access, or data exfiltration.",AWS CloudTrail,"Persistence, Privilege Escalation, Exfiltration",T1098,"`cloudtrail` eventName=DeletePolicy (userAgent!=*.amazonaws.com) 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_iam_delete_policy_filter`"
AWS IAM Failure Group Deletion,"The following analytic identifies failed attempts to delete AWS IAM groups. It leverages AWS CloudTrail logs to detect events where the DeleteGroup action fails due to errors like NoSuchEntityException, DeleteConflictException, or AccessDenied. This activity is significant as it may indicate unauthorized attempts to modify IAM group configurations, which could be a precursor to privilege escalation or other malicious actions.",AWS CloudTrail,"Persistence, Privilege Escalation",T1098,"`cloudtrail` eventSource=iam.amazonaws.com eventName=DeleteGroup errorCode IN (NoSuchEntityException,DeleteConflictException, AccessDenied) (userAgent!=*.amazonaws.com) 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_iam_failure_group_deletion_filter`"
AWS IAM Successful Group Deletion,"The following analytic identifies the successful deletion of an IAM group in AWS. It leverages CloudTrail logs to detect DeleteGroup events with a success status. This activity is significant as it could indicate potential changes in user permissions or access controls, which may be a precursor to further unauthorized actions. If confirmed malicious, an attacker could disrupt access management, potentially leading to privilege escalation or unauthorized access to sensitive resources.",AWS CloudTrail,"Discovery, Persistence, Privilege Escalation","T1069.003, T1098","`cloudtrail` eventSource=iam.amazonaws.com eventName=DeleteGroup errorCode=success (userAgent!=*.amazonaws.com) 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_iam_successful_group_deletion_filter`"
AWS Lambda UpdateFunctionCode,"The following analytic identifies IAM users attempting to update or modify AWS Lambda code via the AWS CLI. It leverages CloudTrail logs to detect successful UpdateFunctionCode events initiated by IAM users. This activity is significant as it may indicate an attempt to gain persistence, further access, or plant backdoors within your AWS environment. If confirmed malicious, an attacker could upload and execute malicious code automatically when the Lambda function is triggered, potentially compromising the integrity and security of your AWS infrastructure.",AWS CloudTrail,"Execution, Persistence",T1204,"`cloudtrail` eventSource=lambda.amazonaws.com eventName=UpdateFunctionCode*  errorCode = success  user_type=IAMUser 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`aws_lambda_updatefunctioncode_filter`"
AWS Multiple Failed MFA Requests For User,"The following analytic identifies multiple failed multi-factor authentication (MFA) requests to an AWS Console for a single user. It leverages AWS CloudTrail logs, specifically the additionalEventData field, to detect more than 10 failed MFA prompts within 5 minutes. This activity is significant as it may indicate an adversary attempting to bypass MFA by bombarding the user with repeated authentication requests.",AWS CloudTrail,Credential Access,"T1586.003, T1621","`cloudtrail` eventName= ConsoleLogin ""additionalEventData.MFAUsed""=Yes errorMessage=""Failed authentication"" 
| bucket span=5m _time 
| rename user_name as user 
| stats dc(_raw) as mfa_prompts min(_time) as firstTime max(_time) as lastTime values(user_agent) as user_agent values(src) as src values(dest) as dest by _time user signature vendor_account vendor_region vendor_product errorMessage 
| where mfa_prompts > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_multiple_failed_mfa_requests_for_user_filter`"
AWS Multiple Users Failing To Authenticate From Ip,"The following analytic identifies a single source IP failing to authenticate into the AWS Console with 30 unique valid users within 10 minutes. It leverages CloudTrail logs to detect multiple failed login attempts from the same IP address. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain unauthorized access or elevate privileges by trying common passwords across many accounts.",AWS CloudTrail,Credential Access,"T1110.004, T1110.003, T1110","`cloudtrail` eventName=ConsoleLogin action=failure 
| bucket span=10m _time 
| rename user_name as user 
| stats  dc(user) AS unique_accounts values(user) as user values(user_agent) as user_agent by _time, src, signature, dest, vendor_account, vendor_region, vendor_product 
| where unique_accounts>30 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_multiple_users_failing_to_authenticate_from_ip_filter`"
AWS Network Access Control List Created with All Open Ports,"The following analytic detects the creation of AWS Network Access Control Lists (ACLs) with all ports open to a specified CIDR. It leverages AWS CloudTrail events, specifically monitoring for CreateNetworkAclEntry or ReplaceNetworkAclEntry actions with rules allowing all traffic. This activity is significant because it can expose the network to unauthorized access, increasing the risk of data breaches and other malicious activities.",AWS CloudTrail,"Exfiltration, Defense Evasion",T1562.007,"`cloudtrail` eventName=CreateNetworkAclEntry OR eventName=ReplaceNetworkAclEntry requestParameters.ruleAction=allow requestParameters.egress=false requestParameters.aclProtocol=-1 
| append [search `cloudtrail` eventName=CreateNetworkAclEntry OR eventName=ReplaceNetworkAclEntry requestParameters.ruleAction=allow requestParameters.egress=false requestParameters.aclProtocol!=-1 
| eval port_range='requestParameters.portRange.to' - 'requestParameters.portRange.from' 
| where port_range>1024] 
| fillnull 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product requestParameters.ruleAction requestParameters.egress requestParameters.aclProtocol requestParameters.portRange.to requestParameters.portRange.from requestParameters.cidrBlock 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `aws_network_access_control_list_created_with_all_open_ports_filter`"
AWS Network Access Control List Deleted,"The following analytic detects the deletion of AWS Network Access Control Lists (ACLs). It leverages AWS CloudTrail logs to identify events where a user deletes a network ACL entry. This activity is significant because deleting a network ACL can remove critical access restrictions, potentially allowing unauthorized access to cloud instances. If confirmed malicious, this action could enable attackers to bypass network security controls, leading to unauthorized access, data exfiltration, or further compromise of the cloud environment.",AWS CloudTrail,"Exfiltration, Defense Evasion",T1562.007,"`cloudtrail` eventName=DeleteNetworkAclEntry requestParameters.egress=false 
| fillnull 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_network_access_control_list_deleted_filter`"
AWS New MFA Method Registered For User,"The following analytic detects the registration of a new Multi-Factor Authentication (MFA) method for an AWS account. It leverages AWS CloudTrail logs to identify the CreateVirtualMFADevice event. This activity is significant because adversaries who gain unauthorized access to an AWS account may register a new MFA method to maintain persistence. If confirmed malicious, this could allow attackers to secure their access, making it difficult to detect and remove their presence, potentially leading to further unauthorized activities and data breaches.",AWS CloudTrail,"Persistence, Credential Access","T1556.006, T1556","`cloudtrail` eventName=CreateVirtualMFADevice 
| rename userName as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_new_mfa_method_registered_for_user_filter`"
AWS Password Policy Changes,"The following analytic detects successful API calls to view, update, or delete the password policy in an AWS organization. It leverages AWS CloudTrail logs to identify events such as &quot;UpdateAccountPasswordPolicy,&quot; &quot;GetAccountPasswordPolicy,&quot; and &quot;DeleteAccountPasswordPolicy.&quot; This activity is significant because it is uncommon for regular users to perform these actions, and such changes can indicate an adversary attempting to understand or weaken password defenses.",AWS CloudTrail,"Discovery, Privilege Escalation, Exfiltration",T1201,"`cloudtrail` eventName IN (""UpdateAccountPasswordPolicy"",""GetAccountPasswordPolicy"",""DeleteAccountPasswordPolicy"") errorCode=success 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`  
| `aws_password_policy_changes_filter`"
AWS S3 Exfiltration Behavior Identified,"The following analytic identifies potential AWS S3 exfiltration behavior by correlating multiple risk events related to Collection and Exfiltration techniques. It leverages risk events from AWS sources, focusing on instances where two or more unique analytics and distinct MITRE ATT&amp;CK IDs are triggered for a specific risk object. This activity is significant as it may indicate an ongoing data exfiltration attempt, which is critical for security teams to monitor.",AWS CloudTrail,"Collection, Exfiltration",T1537,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count values(All_Risk.risk_message) as risk_message  from datamodel=Risk.All_Risk where All_Risk.annotations.mitre_attack.mitre_tactic = ""collection"" OR All_Risk.annotations.mitre_attack.mitre_tactic = ""exfiltration"" source = *AWS*  by All_Risk.risk_object 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 2 and mitre_tactic_id_count>=2 
| `aws_s3_exfiltration_behavior_identified_filter`"
AWS SAML Update identity provider,"The following analytic detects updates to the SAML provider in AWS. It leverages AWS CloudTrail logs to identify the UpdateSAMLProvider event, analyzing fields such as sAMLProviderArn, sourceIPAddress, and userIdentity details. Monitoring updates to the SAML provider is crucial as it may indicate a perimeter compromise of federated credentials or unauthorized backdoor access set by an attacker.",AWS CloudTrail,"Exfiltration, Defense Evasion",T1078,"`cloudtrail` eventName=UpdateSAMLProvider 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime values(requestParameters.sAMLProviderArn) as request_parameters by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
|`aws_saml_update_identity_provider_filter`"
AWS SetDefaultPolicyVersion,"The following analytic detects when a user sets a default policy version in AWS. It leverages AWS CloudTrail logs to identify the SetDefaultPolicyVersion event from the IAM service. This activity is significant because attackers may exploit this technique for privilege escalation, especially if previous policy versions grant more extensive permissions than the current one.",AWS CloudTrail,"Privilege Escalation, Defense Evasion",T1078.004,"`cloudtrail` eventName=SetDefaultPolicyVersion eventSource = iam.amazonaws.com 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_setdefaultpolicyversion_filter`"
AWS Successful Console Authentication From Multiple IPs,"The following analytic detects an AWS account successfully authenticating from multiple unique IP addresses within a 5-minute window. It leverages AWS CloudTrail logs, specifically monitoring ConsoleLogin events and counting distinct source IPs. This behavior is significant as it may indicate compromised credentials, potentially from a phishing attack, being used concurrently by an adversary and a legitimate user.",AWS CloudTrail,Defense Evasion,"T1586, T1535","`cloudtrail` eventName = ConsoleLogin 
| bin span=5m _time 
| rename user_name as user 
| stats  dc(src) as distinct_ip_count values(src) as src values(user_agent) as user_agent values(dest) as dest by _time, user, signature, vendor_account, vendor_region, vendor_product 
| where distinct_ip_count>1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_successful_console_authentication_from_multiple_ips_filter`"
AWS Successful Single-Factor Authentication,"The following analytic identifies a successful Console Login authentication event for an AWS IAM user account without Multi-Factor Authentication (MFA) enabled. It leverages AWS CloudTrail logs to detect instances where MFA was not used during login. This activity is significant as it may indicate a misconfiguration, policy violation, or potential account takeover attempt. If confirmed malicious, an attacker could gain unauthorized access to the AWS environment, potentially leading to data exfiltration, resource manipulation, or further privilege escalation.",AWS CloudTrail,"Initial Access, Exfiltration, Privilege Escalation, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`cloudtrail` eventName= ConsoleLogin errorCode=success ""additionalEventData.MFAUsed""=No 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_successful_single_factor_authentication_filter`"
AWS Unusual Number of Failed Authentications From Ip,"The following analytic identifies a single source IP failing to authenticate into the AWS Console with multiple valid users. It uses CloudTrail logs and calculates the standard deviation for source IP, leveraging the 3-sigma rule to detect unusual numbers of failed authentication attempts. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",AWS CloudTrail,"Initial Access, Credential Access","T1586.003, T1110.004, T1110.003, T1110","`cloudtrail` eventName=ConsoleLogin action=failure 
| rename eventName as action, eventSource as dest, userName as user, userAgent as user_agent, sourceIPAddress as src, userIdentity.accountId as vendor_account, awsRegion as vendor_region 
| bucket span=10m _time 
| stats  dc(_raw) AS distinct_attempts values(user_name) as tried_accounts values(action) as action values(dest) as dest values(vendor_account) as vendor_account values(vendor_region) as vendor_region values(vendor_product) as vendor_product values(user_agent) as user_agent by _time, src 
| eventstats avg(distinct_attempts) as avg_attempts , stdev(distinct_attempts) as ip_std by _time 
| eval upperBound=(avg_attempts+ip_std*3) 
| eval  isOutlier=if(distinct_attempts > 10 and distinct_attempts >= upperBound, 1, 0) 
| where isOutlier = 1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_unusual_number_of_failed_authentications_from_ip_filter`"
AWS UpdateLoginProfile,"The following analytic detects an AWS CloudTrail event where a user with permissions updates the login profile of another user. It leverages CloudTrail logs to identify instances where the user making the change is different from the user whose profile is being updated. This activity is significant because it can indicate privilege escalation attempts, where an attacker uses a compromised account to gain higher privileges.",AWS CloudTrail,"Persistence, Privilege Escalation",T1136.003,"`cloudtrail` eventName = UpdateLoginProfile userAgent !=console.amazonaws.com errorCode = success 
| eval match=if(match(userIdentity.userName,requestParameters.userName), 1,0) 
| search match=0 
| rename user_name as user 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user user_agent src vendor_account vendor_region vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `aws_updateloginprofile_filter`"
Azure Active Directory High Risk Sign-in,"The following analytic detects high-risk sign-in attempts against Azure Active Directory, identified by Azure Identity Protection. It leverages the RiskyUsers and UserRiskEvents log categories from Azure AD events ingested via EventHub. This activity is significant as it indicates potentially compromised accounts, flagged by heuristics and machine learning. If confirmed malicious, attackers could gain unauthorized access to sensitive resources, leading to data breaches or further exploitation within the environment.",Azure AD (Microsoft Entra ID),Credential Access,"T1586.003, T1110.003, T1110","`azure_monitor_aad` `azure_monitor_aad` category=UserRiskEvents properties.riskLevel=high 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product category 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_active_directory_high_risk_sign_in_filter`"
Azure AD Admin Consent Bypassed by Service Principal,"The following analytic identifies instances where a service principal in Azure Active Directory assigns app roles without standard admin consent. It uses Entra ID logs from the azure_monitor_aad data source, focusing on the &quot;Add app role assignment to service principal&quot; operation. This detection is significant as it highlights potential bypasses of critical administrative consent processes, which could lead to unauthorized privileges being granted.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation","T1098, T1098.003","`azure_monitor_aad` (operationName=""Add app role assignment to service principal"" OR operationName=""Add member to role*"") src_user_type=servicePrincipal 
| rename properties.* as * 
| eval roleId = mvindex('targetResources{}.modifiedProperties{}.newValue',0) 
| eval roleValue = mvindex('targetResources{}.modifiedProperties{}.newValue',1) 
| eval roleDescription = mvindex('targetResources{}.modifiedProperties{}.newValue',2) 
| eval user_id = mvindex('targetResources{}.id', 0), user=coalesce(user,mvindex('targetResources{}.displayName',0)) 
| rename initiatedBy.app.displayName as src_user, userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product src_user user_id roleId roleValue roleDescription user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_admin_consent_bypassed_by_service_principal_filter`"
Azure AD Authentication Failed During MFA Challenge,"The following analytic identifies failed authentication attempts against an Azure AD tenant during the Multi-Factor Authentication (MFA) challenge, specifically flagged by error code 500121. It leverages Azure AD SignInLogs to detect these events. This activity is significant as it may indicate an adversary attempting to authenticate using compromised credentials on an account with MFA enabled.",Azure AD (Microsoft Entra ID),"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`azure_monitor_aad` category=SignInLogs properties.status.errorCode=500121 
| rename properties.* as *, authenticationDetails{}.* as * 
| eval time=strptime(authenticationStepDateTime,""%Y-%m-%dT%H:%M:%S"") 
| eval auth_detail=mvzip(strftime(time, ""%Y-%m-%dT%H:%M:%S""),authenticationStepResultDetail,"" - ""), auth_msg=mvappend('status.additionalDetails', authenticationStepResultDetail) 
| eval auth_method=mvmap(authenticationMethod, if(isnull(mvfind('mfaDetail.authMethod',authenticationMethod)), authenticationMethod, null())) 
| search NOT auth_msg=""MFA successfully completed"" 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product auth_method auth_msg user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_authentication_failed_during_mfa_challenge_filter`"
Azure AD Block User Consent For Risky Apps Disabled,"The following analytic detects when the risk-based step-up consent security setting in Azure AD is disabled. It monitors Azure Active Directory logs for the &quot;Update authorization policy&quot; operation, specifically changes to the &quot;AllowUserConsentForRiskyApps&quot; setting. This activity is significant because disabling this feature can expose the organization to OAuth phishing threats by allowing users to grant consent to potentially malicious applications.",Azure AD (Microsoft Entra ID),Defense Evasion,T1562,"`azure_monitor_aad` operationName=""Update authorization policy"" 
| rename properties.* as * 
| eval index_number = if(mvfind('targetResources{}.modifiedProperties{}.displayName',""AllowUserConsentForRiskyApps"") >= 0, mvfind('targetResources{}.modifiedProperties{}.displayName',""AllowUserConsentForRiskyApps""), -1) 
| search index_number >= 0 
| eval AllowUserConsentForRiskyApps = mvindex('targetResources{}.modifiedProperties{}.newValue',index_number) 
| search AllowUserConsentForRiskyApps = ""[true]"" 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_block_user_consent_for_risky_apps_disabled_filter`"
Azure AD Device Code Authentication,"The following analytic identifies Azure Device Code Phishing attacks, which can lead to Azure Account Take-Over (ATO). It leverages Azure AD SignInLogs to detect suspicious authentication requests using the device code authentication protocol. This activity is significant as it indicates potential bypassing of Multi-Factor Authentication (MFA) and Conditional Access Policies (CAPs) through phishing emails.",Azure AD (Microsoft Entra ID),"Initial Access, Credential Access","T1528, T1566.002","`azure_monitor_aad` category=SignInLogs ""properties.authenticationProtocol""=deviceCode 
| rename properties.* as * 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent category 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_device_code_authentication_filter`"
Azure AD External Guest User Invited,"The following analytic detects the invitation of an external guest user within Azure AD. It leverages Azure AD AuditLogs to identify events where an external user is invited, using fields such as operationName and initiatedBy. Monitoring these invitations is crucial as they can lead to unauthorized access if abused. If confirmed malicious, this activity could allow attackers to gain access to internal resources, potentially leading to data breaches or further exploitation of the environment.",Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_monitor_aad` operationName=""Invite external user"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename targetResources{}.type as type 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent initiatedBy type signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_external_guest_user_invited_filter`"
Azure AD FullAccessAsApp Permission Assigned,"The following analytic detects the assignment of the 'full_access_as_app' permission to an application within Office 365 Exchange Online. This is identified by the GUID 'dc890d15-9560-4a4c-9b7f-a736ec74ec40' and the ResourceAppId '00000002-0000-0ff1-ce00-000000000000'. The detection leverages the azure_monitor_aad data source, focusing on AuditLogs with the operation name 'Update application'. This activity is significant as it grants broad control over Office 365 operations, including full access to all mailboxes and the ability to send emails as any user.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation, Exfiltration","T1098.003, T1098, T1098.002","`azure_monitor_aad` category=AuditLogs operationName=""Update application"" 
| eval newvalue = mvindex('properties.targetResources{}.modifiedProperties{}.newValue',0) 
| spath input=newvalue 
| search ""{}.ResourceAppId""=""00000002-0000-0ff1-ce00-000000000000"" ""{}.RequiredAppPermissions{}.EntitlementId""=""dc890d15-9560-4a4c-9b7f-a736ec74ec40"" 
| eval Permissions = '{}.RequiredAppPermissions{}.EntitlementId' 
| rename properties.userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent Permissions object signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_fullaccessasapp_permission_assigned_filter`"
Azure AD Multiple AppIDs and UserAgents Authentication Spike,"The following analytic detects unusual authentication activity in Azure AD, specifically when a single user account has over 8 authentication attempts using 3+ unique application IDs and 5+ unique user agents within a short period. It leverages Azure AD audit logs, focusing on authentication events and using statistical thresholds. This behavior is significant as it may indicate an adversary probing for MFA requirements.",Azure AD (Microsoft Entra ID),"Lateral Movement, Exfiltration, Defense Evasion",T1078,"`azure_monitor_aad` category=SignInLogs operationName=""Sign-in activity"" (properties.authenticationRequirement=""multiFactorAuthentication"" properties.status.additionalDetails=""MFA required in Azure AD"") OR (properties.authenticationRequirement=singleFactorAuthentication ""properties.authenticationDetails{}.succeeded""=true) 
| bucket span=5m _time 
| rename properties.* as * 
| rename userAgent as user_agent 
| fillnull 
| stats count dc(appId) as unique_app_ids dc(user_agent) as unique_user_agents min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(user_agent) as user_agent by user src vendor_account vendor_product signature 
| where count > 5 and unique_app_ids > 2 and unique_user_agents > 5 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_appids_and_useragents_authentication_spike_filter`"
Azure AD Multiple Failed MFA Requests For User,"The following analytic identifies multiple failed multi-factor authentication (MFA) requests for a single user within an Azure AD tenant. It leverages Azure AD Sign-in Logs, specifically error code 500121, to detect more than 10 failed MFA attempts within 10 minutes. This behavior is significant as it may indicate an adversary attempting to bypass MFA by bombarding the user with repeated authentication prompts.",Azure AD (Microsoft Entra ID),"Initial Access, Persistence, Defense Evasion","T1586.003, T1078.004, T1621, T1078","`azure_monitor_aad` category=SignInLogs operationName=""Sign-in activity"" properties.status.errorCode=500121 properties.status.additionalDetails!=""MFA denied; user declined the authentication"" 
| rename properties.* as * 
| bucket span=10m _time 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(dest) as dest values(src) as src by user, status.additionalDetails, appDisplayName, user_agent, vendor_account, vendor_product, signature 
| where count > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_failed_mfa_requests_for_user_filter`"
Azure AD Multiple Service Principals Created by SP,"The following analytic detects when a single service principal in Azure AD creates more than three unique OAuth applications within a 10-minute span. It leverages Azure AD audit logs, specifically monitoring the 'Add service principal' operation initiated by service principals. This behavior is significant as it may indicate an attacker using a compromised or malicious service principal to rapidly establish multiple service principals, potentially staging an attack.",Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_monitor_aad` operationName=""Add service principal"" properties.initiatedBy.app.appId=* 
| rename properties.* as * 
| bucket span=10m _time 
| rename targetResources{}.displayName as displayName 
| rename targetResources{}.type as type 
| rename initiatedBy.app.displayName as src_user 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(displayName) as unique_apps values(displayName) as displayName values(dest) as dest values(src) as src values(user) as user values(user_agent) as user_agent by src_user vendor_account vendor_product signature 
| where unique_apps > 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_service_principals_created_by_sp_filter`"
Azure AD Multiple Service Principals Created by User,The following analytic identifies instances where a single user creates more than three unique OAuth applications within a 10-minute timeframe in Azure AD. It detects this activity by monitoring the 'Add service principal' operation and aggregating data in 10-minute intervals. This behavior is significant as it may indicate an adversary rapidly creating multiple service principals to stage an attack or expand their foothold within the network.,Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_monitor_aad` operationName=""Add service principal"" properties.initiatedBy.user.id=* 
| rename properties.* as * 
| bucket span=10m _time 
| rename targetResources{}.displayName as displayName 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(displayName) as unique_apps values(displayName) as displayName values(dest) as dest values(src) as src values(user) as user values(user_agent) as user_agent by src_user vendor_account vendor_product signature 
| where unique_apps > 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_service_principals_created_by_user_filter`"
Azure AD Multiple Users Failing To Authenticate From Ip,"The following analytic detects a single source IP failing to authenticate with 30 unique valid users within 5 minutes in Azure Active Directory. It leverages Azure AD SignInLogs with error code 50126, indicating invalid passwords. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges by trying common passwords across many accounts.",Azure AD (Microsoft Entra ID),"Initial Access, Credential Access, Privilege Escalation","T1586.003, T1110.004, T1110.003, T1110","`azure_monitor_aad` category=SignInLogs properties.status.errorCode=50126 properties.authenticationDetails{}.succeeded=false 
| rename properties.* as * 
| bucket span=5m _time 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(user) as unique_user values(dest) as dest values(user) as user values(user_agent) as user_agent values(vendor_account) as vendor_account values(vendor_product) as vendor_product by src signature 
| where unique_user > 30 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_multiple_users_failing_to_authenticate_from_ip_filter`"
Azure AD New Custom Domain Added,"The following analytic detects the addition of a new custom domain within an Azure Active Directory (AD) tenant. It leverages Azure AD AuditLogs to identify successful &quot;Add unverified domain&quot; operations. This activity is significant as it may indicate an adversary attempting to establish persistence by setting up identity federation backdoors, allowing them to impersonate users and bypass authentication mechanisms.",Azure AD (Microsoft Entra ID),"Persistence, Defense Evasion","T1484.002, T1484","`azure_monitor_aad` operationName=""Add unverified domain"" properties.result=success 
| rename properties.* as * 
| rename targetResources{}.displayName as domain 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent domain signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_new_custom_domain_added_filter`"
Azure AD OAuth Application Consent Granted By User,"The following analytic detects when a user in an Azure AD environment grants consent to an OAuth application. It leverages Azure AD audit logs to identify events where users approve application consents. This activity is significant as it can expose organizational data to third-party applications, a common tactic used by malicious actors to gain unauthorized access.",Azure AD (Microsoft Entra ID),Credential Access,T1528,"`azure_monitor_aad` operationName=""Consent to application"" properties.result=success 
| rename properties.* as * 
| eval permissions_index = if(mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Permissions"") >= 0, mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Permissions""), -1) 
| eval permissions = mvindex('targetResources{}.modifiedProperties{}.newValue',permissions_index) 
| rex field=permissions ""Scope: (?<Scope> [ ^,]+)"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product Scope signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_oauth_application_consent_granted_by_user_filter`"
Azure AD Privileged Graph API Permission Assigned,"The following analytic detects the assignment of high-risk Graph API permissions in Azure AD, specifically Application.ReadWrite.All, AppRoleAssignment.ReadWrite.All, and RoleManagement.ReadWrite.Directory. It uses azure_monitor_aad data to scan AuditLogs for 'Update application' operations, identifying when these permissions are assigned. This activity is significant as it grants broad control over Azure AD, including application and directory settings. If confirmed malicious, it could lead to unauthorized modifications and potential security breaches, compromising the integrity and security of the Azure AD environment.",Azure AD (Microsoft Entra ID),"Persistence, Credential Access",T1003.002,"`azure_monitor_aad` category=AuditLogs operationName=""Update application"" 
| eval newvalue = mvindex('properties.targetResources{}.modifiedProperties{}.newValue',0) 
| spath input=newvalue 
| search ""{}.RequiredAppPermissions{}.EntitlementId""="" 1bfefb4e-e0b5-418b-a88f-73c46d2cc8e9"" OR ""{}.RequiredAppPermissions{}.EntitlementId"" =""06b708a9-e830-4db3-a914-8e69da51d44f"" OR ""{}.RequiredAppPermissions{}.EntitlementId"" =""9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8"" 
| eval Permissions = '{}.RequiredAppPermissions{}.EntitlementId' 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product Permissions signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_privileged_graph_api_permission_assigned_filter`"
Azure AD Service Principal Authentication,"The following analytic identifies authentication events of service principals in Azure Active Directory. It leverages the azure_monitor_aad data source, specifically targeting &quot;Sign-in activity&quot; within ServicePrincipalSignInLogs. This detection gathers details such as sign-in frequency, timing, source IPs, and accessed resources. Monitoring these events is significant for SOC teams to distinguish between normal application authentication and potential anomalies, which could indicate compromised credentials or malicious activities.",Azure AD (Microsoft Entra ID),Defense Evasion,"T1078.004, T1078","`azure_monitor_aad` operationName=""Sign-in activity"" category=ServicePrincipalSignInLogs 
| rename properties.* as * 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product resourceDisplayName resourceId signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_service_principal_authentication_filter`"
Azure AD Service Principal Created,"The following analytic detects the creation of a Service Principal in an Azure AD environment. It leverages Azure Active Directory events ingested through EventHub, specifically monitoring the &quot;Add service principal&quot; operation. This activity is significant because Service Principals can be used by adversaries to establish persistence and bypass multi-factor authentication and conditional access policies.",Azure AD (Microsoft Entra ID),Persistence,"T1136.003, T1136","`azure_monitor_aad` operationName=""Add service principal"" properties.initiatedBy.user.id=* 
| rename properties.* as * 
| rename targetResources{}.displayName as displayName 
| rename targetResources{}.type as type 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product displayName result signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_service_principal_created_filter`"
Azure AD Service Principal Owner Added,"The following analytic detects the addition of a new owner to a Service Principal within an Azure AD tenant. It leverages Azure Active Directory events from the AuditLog log category to identify this activity. This behavior is significant because Service Principals do not support multi-factor authentication or conditional access policies, making them a target for adversaries seeking persistence or privilege escalation.",Azure AD (Microsoft Entra ID),"Persistence, Privilege Escalation",T1098,"`azure_monitor_aad` operationName=""Add owner to application"" 
| rename properties.* as * 
| rename initiatedBy.user.userPrincipalName as initiatedBy 
| rename targetResources{}.userPrincipalName as newOwner 
| rename targetResources{}.modifiedProperties{}.newValue as displayName 
| eval displayName = mvindex(displayName,1) 
| where initiatedBy!=newOwner 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product initiatedBy result newOwner displayName signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_service_principal_owner_added_filter`"
Azure AD Successful Authentication From Different Ips,"The following analytic detects an Azure AD account successfully authenticating from multiple unique IP addresses within a 30-minute window. It leverages Azure AD SignInLogs to identify instances where the same user logs in from different IPs in a short time frame. This behavior is significant as it may indicate compromised credentials being used by an adversary, potentially following a phishing attack.",Azure AD (Microsoft Entra ID),Credential Access,"T1110.003, T1110.001, T1110","`azure_monitor_aad` properties.authenticationDetails{}.succeeded=true category=SignInLogs 
| rename properties.* as * 
| bucket span=30m _time 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime dc(src) AS unique_ips values(dest) as dest values(src) as src by user vendor_account vendor_product signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where unique_ips > 1 
| `azure_ad_successful_authentication_from_different_ips_filter`"
Azure AD Successful PowerShell Authentication,"The following analytic identifies a successful authentication event against an Azure AD tenant using PowerShell cmdlets. This detection leverages Azure AD SignInLogs to identify successful logins where the appDisplayName is &quot;Microsoft Azure PowerShell.&quot; This activity is significant because it is uncommon for regular, non-administrative users to authenticate using PowerShell, and it may indicate enumeration and discovery techniques by an attacker.",Azure AD (Microsoft Entra ID),"Initial Access, Discovery, Privilege Escalation, Defense Evasion","T1586.003, T1078.004, T1078","`azure_monitor_aad` category=SignInLogs properties.authenticationDetails{}.succeeded=true properties.appDisplayName=""Microsoft Azure PowerShell"" 
| rename properties.* as * 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_successful_powershell_authentication_filter`"
Azure AD Successful Single-Factor Authentication,"The following analytic identifies a successful single-factor authentication event against Azure Active Directory. It leverages Azure SignInLogs data, specifically focusing on events where single-factor authentication succeeded. This activity is significant as it may indicate a misconfiguration, policy violation, or potential account takeover attempt. If confirmed malicious, an attacker could gain unauthorized access to the account, potentially leading to data breaches, privilege escalation, or further exploitation within the environment.",Azure AD (Microsoft Entra ID),"Initial Access, Privilege Escalation, Defense Evasion","T1586.003, T1078.004, T1078","`azure_monitor_aad` category=SignInLogs properties.authenticationRequirement=singleFactorAuthentication properties.authenticationDetails{}.succeeded=true 
| rename properties.* as * 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product user_agent signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_successful_single_factor_authentication_filter`"
Azure AD Tenant Wide Admin Consent Granted,"The following analytic identifies instances where admin consent is granted to an application within an Azure AD tenant. It leverages Azure AD audit logs, specifically events related to the admin consent action within the ApplicationManagement category. This activity is significant because admin consent allows applications to access data across the entire tenant, potentially exposing vast amounts of organizational data.",Azure AD (Microsoft Entra ID),"Persistence, Exfiltration","T1098, T1098.003","`azure_monitor_aad` operationName=""Consent to application"" 
| eval new_field=mvindex('properties.targetResources{}.modifiedProperties{}.newValue',4) 
| rename properties.* as * 
| rex field=new_field ""ConsentType:(?<ConsentType> [^\,]+)"" 
| rex field=new_field ""Scope:(?<Scope> [^\,]+)"" 
| search ConsentType = ""*AllPrincipals*"" 
| rename userAgent as user_agent 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product ConsentType Scope signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_tenant_wide_admin_consent_granted_filter`"
Azure AD Unusual Number of Failed Authentications From Ip,"The following analytic identifies a single source IP failing to authenticate with multiple valid users, potentially indicating a Password Spraying attack against an Azure Active Directory tenant. It uses Azure SignInLogs data and calculates the standard deviation for source IPs, applying the 3-sigma rule to detect unusual numbers of failed authentication attempts.",Azure AD (Microsoft Entra ID),"Initial Access, Credential Access, Privilege Escalation","T1586.003, T1110.004, T1110.003, T1110","`azure_monitor_aad` category=SignInLogs properties.status.errorCode=50126 properties.authenticationDetails{}.succeeded=false 
| rename properties.* as * 
| bucket span=5m _time 
| stats dc(userPrincipalName) AS unique_accounts values(userPrincipalName) as userPrincipalName values(dest) as dest  values(user) as user by _time, src, vendor_account, vendor_product 
| eventstats avg(unique_accounts) as ip_avg, stdev(unique_accounts) as ip_std by src 
| eval upperBound=(ip_avg+ip_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1,0) 
| where isOutlier = 1 
| `azure_ad_unusual_number_of_failed_authentications_from_ip_filter`"
Azure AD User Consent Blocked for Risky Application,"The following analytic detects instances where Azure AD has blocked a user's attempt to grant consent to a risky or potentially malicious application. This detection leverages Azure AD audit logs, focusing on user consent actions and system-driven blocks. Monitoring these blocked consent attempts is crucial as it highlights potential threats early on, indicating that a user might be targeted or that malicious applications are attempting to infiltrate the organization.",Azure AD (Microsoft Entra ID),Credential Access,T1528,"`azure_monitor_aad` operationName=""Consent to application"" properties.result=failure 
| rename properties.* as * 
| eval reason_index = if(mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Reason"") >= 0, mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Reason""), -1) 
| eval permissions_index = if(mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Permissions"") >= 0, mvfind('targetResources{}.modifiedProperties{}.displayName', ""ConsentAction.Permissions""), -1) 
| search reason_index >= 0 
| eval reason = mvindex('targetResources{}.modifiedProperties{}.newValue',reason_index) 
| eval permissions = mvindex('targetResources{}.modifiedProperties{}.newValue',permissions_index) 
| search reason = ""\""Risky application detected\"""" 
| rex field=permissions ""Scope: (?<Scope> [ ^,]+)"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product reason Scope signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_user_consent_blocked_for_risky_application_filter`"
Azure AD User Consent Denied for OAuth Application,"The following analytic identifies instances where a user has denied consent to an OAuth application seeking permissions within the Azure AD environment. This detection leverages Azure AD's audit logs, specifically focusing on user consent actions with error code 65004. Monitoring denied consent actions is significant as it can indicate users recognizing potentially suspicious or untrusted applications.",Azure AD (Microsoft Entra ID),Credential Access,T1528,"`azure_monitor_aad` operationName=""Sign-in activity"" properties.status.errorCode=65004 
| rename properties.* as * 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product appDisplayName status.failureReason signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `azure_ad_user_consent_denied_for_oauth_application_filter`"
Cloud Provisioning Activity From Previously Unseen City,The following analytic detects cloud provisioning activities originating from previously unseen cities. It leverages cloud infrastructure logs and compares the geographic location of the source IP address against a baseline of known locations. This activity is significant as it may indicate unauthorized access or misuse of cloud resources from an unexpected location.,Windows Events,"Exfiltration, Defense Evasion",T1078,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Change where (All_Changes.action=started OR All_Changes.action=created) All_Changes.status=success by All_Changes.src, All_Changes.user, All_Changes.object, All_Changes.command 
| `drop_dm_object_name(""All_Changes"")` 
| iplocation src 
| where isnotnull(City) 
| lookup previously_seen_cloud_provisioning_activity_sources City as City OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenCity=min(firstTimeSeen) 
| where isnull(firstTimeSeenCity) OR firstTimeSeenCity > relative_time(now(), `previously_unseen_cloud_provisioning_activity_window`) 
| `security_content_ctime(firstTime)` 
| table firstTime, src, City, user, object, command 
| `cloud_provisioning_activity_from_previously_unseen_city_filter`"
Cloud Provisioning Activity From Previously Unseen Country,"The following analytic detects cloud provisioning activities originating from previously unseen countries. It leverages cloud infrastructure logs and compares the geographic location of the source IP address against a baseline of known locations. This activity is significant as it may indicate unauthorized access or potential compromise of cloud resources. If confirmed malicious, an attacker could gain control over cloud assets, leading to data breaches, service disruptions, or further infiltration into the network.",Windows Events,Defense Evasion,T1078,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Change where (All_Changes.action=started OR All_Changes.action=created) All_Changes.status=success by All_Changes.src, All_Changes.user, All_Changes.object, All_Changes.command 
| `drop_dm_object_name(""All_Changes"")` 
| iplocation src 
| where isnotnull(Country) 
| lookup previously_seen_cloud_provisioning_activity_sources Country as Country OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenCountry=min(firstTimeSeen) 
| where isnull(firstTimeSeenCountry) OR firstTimeSeenCountry > relative_time(now(), ""-24h@h"") 
| `security_content_ctime(firstTime)` 
| table firstTime, src, Country, user, object, command 
| `cloud_provisioning_activity_from_previously_unseen_country_filter`"
Cloud Provisioning Activity From Previously Unseen IP Address,"The following analytic detects cloud provisioning activities originating from previously unseen IP addresses. It leverages cloud infrastructure logs to identify events where resources are created or started, and cross-references these with a baseline of known IP addresses. This activity is significant as it may indicate unauthorized access or potential misuse of cloud resources. If confirmed malicious, an attacker could gain unauthorized control over cloud resources, leading to data breaches, service disruptions, or increased operational costs.",Windows Events,Defense Evasion,T1078,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime, values(All_Changes.object_id) as object_id from datamodel=Change where (All_Changes.action=started OR All_Changes.action=created) All_Changes.status=success by All_Changes.src, All_Changes.user, All_Changes.command 
| `drop_dm_object_name(""All_Changes"")` 
| lookup previously_seen_cloud_provisioning_activity_sources src as src OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenSrc=min(firstTimeSeen) 
| where isnull(firstTimeSeenSrc) OR firstTimeSeenSrc > relative_time(now(), `previously_unseen_cloud_provisioning_activity_window`) 
| `security_content_ctime(firstTime)` 
| table firstTime, src, user, object_id, command 
| `cloud_provisioning_activity_from_previously_unseen_ip_address_filter`"
Cloud Provisioning Activity From Previously Unseen Region,"The following analytic detects cloud provisioning activities originating from previously unseen regions. It leverages cloud infrastructure logs to identify events where resources are started or created, and cross-references these with a baseline of known regions. This activity is significant as it may indicate unauthorized access or misuse of cloud resources from unfamiliar locations.",Windows Events,"Exfiltration, Defense Evasion",T1078,"| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Change where (All_Changes.action=started OR All_Changes.action=created) All_Changes.status=success by All_Changes.src, All_Changes.user, All_Changes.object, All_Changes.command 
| `drop_dm_object_name(""All_Changes"")` 
| iplocation src 
| where isnotnull(Region) 
| lookup previously_seen_cloud_provisioning_activity_sources Region as Region OUTPUT firstTimeSeen, enough_data 
| eventstats max(enough_data) as enough_data 
| where enough_data=1 
| eval firstTimeSeenRegion=min(firstTimeSeen) 
| where isnull(firstTimeSeenRegion) OR firstTimeSeenRegion > relative_time(now(), `previously_unseen_cloud_provisioning_activity_window`) 
| `security_content_ctime(firstTime)` 
| table firstTime, src, Region, user, object, command 
| `cloud_provisioning_activity_from_previously_unseen_region_filter`"
Cloud Security Groups Modifications by User,"The following analytic identifies unusual modifications to security groups in your cloud environment by users, focusing on actions such as modifications, deletions, or creations over 30-minute intervals. It leverages cloud infrastructure logs and calculates the standard deviation for each user, using the 3-sigma rule to detect anomalies. This activity is significant as it may indicate a compromised account or insider threat.",Windows Events,Defense Evasion,"T1578.005, T1578","| tstats dc(All_Changes.object) as unique_security_groups values(All_Changes.src) as src values(All_Changes.user_type) as user_type values(All_Changes.object_category) as object_category values(All_Changes.object) as objects values(All_Changes.action) as action  values(All_Changes.user_agent) as user_agent values(All_Changes.command) as command from datamodel=Change WHERE All_Changes.object_category = ""security_group"" (All_Changes.action = modified OR All_Changes.action = deleted OR All_Changes.action = created)  by All_Changes.user  _time span=30m 
|  `drop_dm_object_name(""All_Changes"")` 
| eventstats avg(unique_security_groups) as avg_changes , stdev(unique_security_groups) as std_changes by user 
| eval upperBound=(avg_changes+std_changes*3) 
| eval isOutlier=if(unique_security_groups > 2 and unique_security_groups >= upperBound, 1, 0) 
| where isOutlier=1
| `cloud_security_groups_modifications_by_user_filter`"
Detect AWS Console Login by User from New City,"The following analytic identifies AWS console login events by users from a new city within the last hour. It leverages AWS CloudTrail events and compares them against a lookup file of previously seen user locations. This activity is significant for a SOC as it may indicate unauthorized access or credential compromise, especially if the login originates from an unusual location.",Azure AD (Microsoft Entra ID),"Exfiltration, Defense Evasion","T1586.003, T1535","| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src 
| iplocation Authentication.src 
| `drop_dm_object_name(Authentication)` 
| rename City as justSeenCity 
| table firstTime lastTime user justSeenCity 
| join user type=outer [
| inputlookup previously_seen_users_console_logins 
| rename City as previouslySeenCity 
| stats min(firstTime) AS earliestseen by user previouslySeenCity 
| fields earliestseen user previouslySeenCity] 
| eval userCity=if(firstTime >= relative_time(now(), ""-24h@h""), ""New City"",""Previously Seen City"") 
| where userCity = ""New City"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime lastTime user previouslySeenCity justSeenCity userCity 
| `detect_aws_console_login_by_user_from_new_city_filter`"
Detect AWS Console Login by User from New Country,"The following analytic identifies AWS console login events by users from a new country. It leverages AWS CloudTrail events and compares them against a lookup file of previously seen users and their login locations. This activity is significant because logins from new countries can indicate potential unauthorized access or compromised accounts. If confirmed malicious, this could lead to unauthorized access to AWS resources, data exfiltration, or further exploitation within the AWS environment.",Azure AD (Microsoft Entra ID),"Exfiltration, Defense Evasion","T1586.003, T1535","| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src 
| iplocation Authentication.src 
| `drop_dm_object_name(Authentication)` 
| rename Country as justSeenCountry 
| table firstTime lastTime user justSeenCountry 
| join user type=outer [
| inputlookup previously_seen_users_console_logins 
| rename Country as previouslySeenCountry 
| stats min(firstTime) AS earliestseen by user previouslySeenCountry 
| fields earliestseen user previouslySeenCountry] 
| eval userCountry=if(firstTime >= relative_time(now(), ""-24h@h""), ""New Country"",""Previously Seen Country"") 
| where userCountry = ""New Country"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime lastTime user previouslySeenCountry justSeenCountry userCountry 
| `detect_aws_console_login_by_user_from_new_country_filter`"
Detect AWS Console Login by User from New Region,"The following analytic identifies AWS console login attempts by users from a new region. It leverages AWS CloudTrail events and compares current login regions against a baseline of previously seen regions for each user. This activity is significant as it may indicate unauthorized access attempts or compromised credentials. If confirmed malicious, an attacker could gain unauthorized access to AWS resources, potentially leading to data breaches, resource manipulation, or further lateral movement within the cloud environment.",Azure AD (Microsoft Entra ID),"Lateral Movement, Defense Evasion","T1586.003, T1535","| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src 
| iplocation Authentication.src 
| `drop_dm_object_name(Authentication)` 
| rename Region as justSeenRegion 
| table firstTime lastTime user justSeenRegion 
| join user type=outer [
| inputlookup previously_seen_users_console_logins 
| rename Region as previouslySeenRegion 
| stats min(firstTime) AS earliestseen by user previouslySeenRegion 
| fields earliestseen user previouslySeenRegion] 
| eval userRegion=if(firstTime >= relative_time(now(), ""-24h@h""), ""New Region"",""Previously Seen Region"") 
| where userRegion= ""New Region"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime lastTime user previouslySeenRegion justSeenRegion userRegion 
| `detect_aws_console_login_by_user_from_new_region_filter`"
Detect GCP Storage access from a new IP,The following analytic identifies access to GCP Storage buckets from new or previously unseen remote IP addresses.,GCP,"Collection, Exfiltration",T1530,"`google_gcp_pubsub_message` 
| multikv 
| rename sc_status_ as status 
| rename cs_object_ as bucket_name 
| rename c_ip_ as remote_ip 
| rename cs_uri_ as request_uri 
| rename cs_method_ as operation 
| search status=""\""200\"""" 
| stats earliest(_time) as firstTime latest(_time) as lastTime by bucket_name remote_ip operation request_uri 
| table firstTime, lastTime, bucket_name, remote_ip, operation, request_uri 
| inputlookup append=t previously_seen_gcp_storage_access_from_remote_ip 
| stats min(firstTime) as firstTime, max(lastTime) as lastTime by bucket_name remote_ip operation request_uri 
| outputlookup previously_seen_gcp_storage_access_from_remote_ip 
| eval newIP=if(firstTime >= relative_time(now(),""-70m@m""), 1, 0) 
| where newIP=1 
| eval first_time=strftime(firstTime,""%m/%d/%y %H:%M:%S"") 
| eval last_time=strftime(lastTime,""%m/%d/%y %H:%M:%S"") 
| table  first_time last_time bucket_name remote_ip operation request_uri 
| `detect_gcp_storage_access_from_a_new_ip_filter`"
Detect New Open GCP Storage Buckets,The following analytic identifies the creation of new open/public GCP Storage buckets.,GCP,Collection,T1530,"`google_gcp_pubsub_message` data.resource.type=gcs_bucket data.protoPayload.methodName=storage.setIamPermissions 
| spath output=action path=data.protoPayload.serviceData.policyDelta.bindingDeltas{}.action 
| spath output=user path=data.protoPayload.authenticationInfo.principalEmail 
| spath output=location path=data.protoPayload.resourceLocation.currentLocations{} 
| spath output=src path=data.protoPayload.requestMetadata.callerIp 
| spath output=bucketName path=data.protoPayload.resourceName 
| spath output=role path=data.protoPayload.serviceData.policyDelta.bindingDeltas{}.role 
| spath output=member path=data.protoPayload.serviceData.policyDelta.bindingDeltas{}.member 
| search (member=allUsers AND action=ADD) 
| table  _time, bucketName, src, user, location, action, role, member 
| search `detect_new_open_gcp_storage_buckets_filter`"
Detect New Open S3 buckets,"The following analytic identifies the creation of open/public S3 buckets in AWS. It detects this activity by analyzing AWS CloudTrail events for PutBucketAcl actions where the access control list (ACL) grants permissions to all users or authenticated users. This activity is significant because open S3 buckets can expose sensitive data to unauthorized access, leading to data breaches.",AWS CloudTrail,"Collection, Exfiltration",T1530,"`cloudtrail` eventSource=s3.amazonaws.com eventName=PutBucketAcl 
| rex field=_raw ""(?<json_field>{.+})"" 
| spath input=json_field output=grantees path=requestParameters.AccessControlPolicy.AccessControlList.Grant{} 
| search grantees=* 
| mvexpand grantees 
| spath input=grantees output=uri path=Grantee.URI 
| spath input=grantees output=permission path=Permission 
| search uri IN (""http://acs.amazonaws.com/groups/global/AllUsers"",""http://acs.amazonaws.com/groups/global/AuthenticatedUsers"") 
| search permission IN (""READ"",""READ_ACP"",""WRITE"",""WRITE_ACP"",""FULL_CONTROL"") 
| rename requestParameters.bucketName AS bucketName 
| stats count min(_time) as firstTime max(_time) as lastTime by user_arn userIdentity.principalId userAgent uri permission bucketName 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_new_open_s3_buckets_filter`"
Detect New Open S3 Buckets over AWS CLI,"The following analytic detects the creation of open/public S3 buckets via the AWS CLI. It leverages AWS CloudTrail logs to identify events where a user has set bucket permissions to allow access to &quot;AuthenticatedUsers&quot; or &quot;AllUsers.&quot; This activity is significant because open S3 buckets can expose sensitive data to unauthorized users, leading to data breaches.",AWS CloudTrail,Collection,T1530,"`cloudtrail` eventSource=""s3.amazonaws.com"" (userAgent=""[aws-cli*"" OR userAgent=aws-cli* ) eventName=PutBucketAcl OR requestParameters.accessControlList.x-amz-grant-read-acp IN (""*AuthenticatedUsers"",""*AllUsers"") OR requestParameters.accessControlList.x-amz-grant-write IN (""*AuthenticatedUsers"",""*AllUsers"") OR requestParameters.accessControlList.x-amz-grant-write-acp IN (""*AuthenticatedUsers"",""*AllUsers"") OR requestParameters.accessControlList.x-amz-grant-full-control IN (""*AuthenticatedUsers"",""*AllUsers"") 
| rename requestParameters.bucketName AS bucketName 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by userIdentity.userName userIdentity.principalId userAgent bucketName requestParameters.accessControlList.x-amz-grant-read requestParameters.accessControlList.x-amz-grant-read-acp requestParameters.accessControlList.x-amz-grant-write requestParameters.accessControlList.x-amz-grant-write-acp requestParameters.accessControlList.x-amz-grant-full-control 
| rename userIdentity.userName as user 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_new_open_s3_buckets_over_aws_cli_filter`"
Detect S3 access from a new IP,The following analytic identifies access to an S3 bucket from a new or previously unseen remote IP address.,AWS CloudTrail,"Collection, Exfiltration",T1530,"`aws_s3_accesslogs` http_status=200  [search `aws_s3_accesslogs` http_status=200 
| stats earliest(_time) as firstTime latest(_time) as lastTime by bucket_name remote_ip 
| inputlookup append=t previously_seen_S3_access_from_remote_ip 
| stats min(firstTime) as firstTime, max(lastTime) as lastTime by bucket_name remote_ip 
| outputlookup previously_seen_S3_access_from_remote_ip 
| eval newIP=if(firstTime >= relative_time(now(), ""-70m@m""), 1, 0) 
| where newIP=1 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| table bucket_name remote_ip]
| iplocation remote_ip 
|rename remote_ip as src_ip 
| table _time bucket_name src_ip City Country operation request_uri 
| `detect_s3_access_from_a_new_ip_filter`"
Detect Spike in blocked Outbound Traffic from your AWS,The following analytic identifies spikes in blocked outbound network connections originating from within your AWS environment.,AWS CloudTrail,"Command And Control, Exfiltration",,"`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  [search  `cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  
| stats count as numberOfBlockedConnections by src_ip 
| inputlookup baseline_blocked_outbound_connections append=t 
| fields - latestCount 
| stats values(*) as * by src_ip 
| rename numberOfBlockedConnections as latestCount 
| eval newAvgBlockedConnections=avgBlockedConnections + (latestCount-avgBlockedConnections)/720 
| eval newStdevBlockedConnections=sqrt(((pow(stdevBlockedConnections, 2)*719 + (latestCount-newAvgBlockedConnections)*(latestCount-avgBlockedConnections))/720)) 
| eval avgBlockedConnections=coalesce(newAvgBlockedConnections, avgBlockedConnections), stdevBlockedConnections=coalesce(newStdevBlockedConnections, stdevBlockedConnections), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) 
| table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections 
| outputlookup baseline_blocked_outbound_connections 
| eval dataPointThreshold = 5, deviationThreshold = 3 
| eval isSpike=if((latestCount > avgBlockedConnections+deviationThreshold*stdevBlockedConnections) AND numDataPoints > dataPointThreshold, 1, 0) 
| where isSpike=1 
| table src_ip] 
| stats values(dest_ip) as dest_ip, values(interface_id) as ""resourceId"" count as numberOfBlockedConnections, dc(dest_ip) as uniqueDestConnections by src_ip 
| `detect_spike_in_blocked_outbound_traffic_from_your_aws_filter`"
Detect Spike in S3 Bucket deletion,The following analytic identifies a spike in API activity related to the deletion of S3 buckets in your AWS environment.,AWS CloudTrail,"Collection, Exfiltration",T1530,"`cloudtrail` eventName=DeleteBucket [search `cloudtrail` eventName=DeleteBucket 
| spath output=arn path=userIdentity.arn 
| stats count as apiCalls by arn 
| inputlookup s3_deletion_baseline append=t 
| fields - latestCount 
| stats values(*) as * by arn 
| rename apiCalls as latestCount 
| eval newAvgApiCalls=avgApiCalls + (latestCount-avgApiCalls)/720 
| eval newStdevApiCalls=sqrt(((pow(stdevApiCalls, 2)*719 + (latestCount-newAvgApiCalls)*(latestCount-avgApiCalls))/720)) 
| eval avgApiCalls=coalesce(newAvgApiCalls, avgApiCalls), stdevApiCalls=coalesce(newStdevApiCalls, stdevApiCalls), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) 
| table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls 
| outputlookup s3_deletion_baseline 
| eval dataPointThreshold = 15, deviationThreshold = 3 
| eval isSpike=if((latestCount > avgApiCalls+deviationThreshold*stdevApiCalls) AND numDataPoints > dataPointThreshold, 1, 0) 
| where isSpike=1 
| rename arn as userIdentity.arn 
| table userIdentity.arn] 
| spath output=user userIdentity.arn 
| spath output=bucketName path=requestParameters.bucketName 
| stats values(bucketName) as bucketName, count as numberOfApiCalls, dc(eventName) as uniqueApisCalled by user 
| `detect_spike_in_s3_bucket_deletion_filter`"
GCP Detect gcploit framework,The following analytic identifies the use of the GCPloit exploitation framework within Google Cloud Platform (GCP).,GCP,"Lateral Movement, Defense Evasion",T1078,"`google_gcp_pubsub_message` data.protoPayload.request.function.timeout=539s 
| table src src_user data.resource.labels.project_id data.protoPayload.request.function.serviceAccountEmail data.protoPayload.authorizationInfo{}.permission data.protoPayload.request.location http_user_agent 
| `gcp_detect_gcploit_framework_filter`"
GCP Multiple Users Failing To Authenticate From Ip,The following analytic detects a single source IP address failing to authenticate into more than 20 unique Google Workspace user accounts within a 5-minute window. It leverages Google Workspace login failure events to identify potential password spraying attacks. This activity is significant as it may indicate an adversary attempting to gain unauthorized access or elevate privileges within the Google Cloud Platform.,GCP,Credential Access,"T1586.003, T1110.004, T1110.003, T1110","`gws_reports_login` event.type = login event.name = login_failure 
| bucket span=5m _time 
| stats count dc(user) AS unique_accounts values(user) as tried_accounts values(authentication_method) AS authentication_method earliest(_time) as firstTime latest(_time) as lastTime by _time event.name src app id.applicationName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|  where unique_accounts > 20 
| `gcp_multiple_users_failing_to_authenticate_from_ip_filter`"
GCP Unusual Number of Failed Authentications From Ip,"The following analytic identifies a single source IP failing to authenticate into Google Workspace with multiple valid users, potentially indicating a Password Spraying attack. It uses Google Workspace login failure events and calculates the standard deviation for source IPs, applying the 3-sigma rule to detect unusual failed authentication attempts. This activity is significant as it may signal an adversary attempting to gain initial access or elevate privileges.",GCP,"Initial Access, Credential Access","T1586.003, T1110.004, T1110.003, T1110","`gws_reports_login` event.type = login event.name = login_failure
| bucket span=5m _time 
| stats  dc(user_name) AS unique_accounts values(user_name) as tried_accounts values(authentication_method) AS authentication_method by _time, src 
| eventstats  avg(unique_accounts) as ip_avg , stdev(unique_accounts) as ip_std by _time 
| eval  upperBound=(ip_avg+ip_std*3) 
| eval  isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| where isOutlier =1
| `gcp_unusual_number_of_failed_authentications_from_ip_filter`"
GSuite Email Suspicious Attachment,"The following analytic detects suspicious attachment file extensions in GSuite emails, potentially indicating a spear-phishing attack. It leverages GSuite Gmail logs to identify emails with attachments having file extensions commonly associated with malware, such as .exe, .bat, and .js. This activity is significant as these file types are often used to deliver malicious payloads, posing a risk of compromising targeted machines.",Google Workspace,"Initial Access, Execution",T1566.001,"`gsuite_gmail` ""attachment{}.file_extension_type"" IN (""pl"", ""py"", ""rb"", ""sh"", ""bat"", ""exe"", ""dll"", ""cpl"", ""com"", ""js"", ""vbs"", ""ps1"", ""reg"",""swf"", ""cmd"", ""go"") 
| eval phase=""plan"" 
| eval severity=""medium"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(attachment{}.file_extension_type) as email_attachments, values(attachment{}.sha256) as attachment_sha256, values(payload_size) as payload_size by destination{}.service num_message_attachments  subject destination{}.address source.address phase severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `gsuite_email_suspicious_attachment_filter`"
Gsuite Email Suspicious Subject With Attachment,"The following analytic identifies Gsuite emails with suspicious subjects and attachments commonly used in spear phishing attacks. It leverages Gsuite email logs, focusing on specific keywords in the subject line and known malicious file types in attachments. This activity is significant for a SOC as spear phishing is a prevalent method for initial compromise, often leading to further malicious actions.",Google Workspace,"Initial Access, Exfiltration",T1566.001,"`gsuite_gmail` num_message_attachments > 0 subject IN (""*dhl*"", ""* ups *"", ""*delivery*"", ""*parcel*"", ""*label*"", ""*invoice*"", ""*postal*"", ""* fedex *"", ""* usps *"", ""* express *"", ""*shipment*"", ""*Banking/Tax*"",""*shipment*"", ""*new order*"") attachment{}.file_extension_type IN (""doc"", ""docx"", ""xls"", ""xlsx"", ""ppt"", ""pptx"", ""pdf"", ""zip"", ""rar"", ""html"",""htm"",""hta"") 
| rex field=source.from_header_address ""[^@]+@(?<source_domain>[^@]+)"" 
| rex field=destination{}.address ""[^@]+@(?<dest_domain>[^@]+)"" 
| where not source_domain=""internal_test_email.com"" and dest_domain=""internal_test_email.com"" 
| eval phase=""plan"" 
| eval severity=""medium"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(attachment{}.file_extension_type) as email_attachments, values(attachment{}.sha256) as attachment_sha256, values(payload_size) as payload_size by destination{}.service num_message_attachments  subject destination{}.address source.address phase severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `gsuite_email_suspicious_subject_with_attachment_filter`"
Gsuite Email With Known Abuse Web Service Link,"The following analytic detects emails in Gsuite containing links to known abuse web services such as Pastebin, Telegram, and Discord. It leverages Gsuite Gmail logs to identify emails with these specific domains in their links. This activity is significant because these services are commonly used by attackers to deliver malicious payloads. If confirmed malicious, this could lead to the delivery of malware, phishing attacks, or other harmful activities, potentially compromising sensitive information or systems within the organization.",Google Workspace,Initial Access,T1566.001,"`gsuite_gmail` ""link_domain{}"" IN (""*pastebin.com*"", ""*discord*"", ""*telegram*"",""t.me"") 
| rex field=source.from_header_address ""[^@]+@(?<source_domain>[^@]+)"" 
| rex field=destination{}.address ""[^@]+@(?<dest_domain>[^@]+)"" 
| where not source_domain=""internal_test_email.com"" and dest_domain=""internal_test_email.com"" 
| eval phase=""plan"" 
| eval severity=""low"" 
|stats values(link_domain{}) as link_domains min(_time) as firstTime max(_time) as lastTime count by is_spam source.address source.from_header_address subject destination{}.address phase severity 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `gsuite_email_with_known_abuse_web_service_link_filter`"
Gsuite Outbound Email With Attachment To External Domain,"The following analytic detects outbound emails with attachments sent from an internal email domain to an external domain. It leverages Gsuite Gmail logs, parsing the source and destination email domains, and flags emails with fewer than 20 outbound instances. This activity is significant as it may indicate potential data exfiltration or insider threats.",Google Workspace,Exfiltration,T1048.003,"`gsuite_gmail` num_message_attachments > 0 
| rex field=source.from_header_address ""[^@]+@(?<source_domain>[^@]+)"" 
| rex field=destination{}.address ""[^@]+@(?<dest_domain>[^@]+)"" 
| where source_domain=""internal_test_email.com"" and not dest_domain=""internal_test_email.com"" 
| eval phase=""plan"" 
| eval severity=""low"" 
| stats values(subject) as subject, values(source.from_header_address) as src_domain_list, count as numEvents, dc(source.from_header_address) as numSrcAddresses, min(_time) as firstTime max(_time) as lastTime by dest_domain phase severity 
| where numSrcAddresses < 20 
|sort - numSrcAddresses 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `gsuite_outbound_email_with_attachment_to_external_domain_filter`"
Gsuite suspicious calendar invite,"The following analytic detects suspicious calendar invites sent via GSuite, potentially indicating compromised accounts or malicious internal activity.",Google Workspace,Initial Access,T1566,"`gsuite_calendar` 
|bin span=5m _time 
|rename parameters.* as * 
|search target_calendar_id!=null email=""*yourdomain.com""
| stats  count values(target_calendar_id) values(event_title) values(event_guest) by email _time 
| where count >100
| `gsuite_suspicious_calendar_invite_filter`"
High Number of Login Failures from a single source,"The following analytic detects multiple failed login attempts in Office365 Azure Active Directory from a single source IP address. It leverages Office365 management activity logs, specifically AzureActiveDirectoryStsLogon records, aggregating these logs in 5-minute intervals to count failed login attempts. This activity is significant as it may indicate brute-force attacks or password spraying, which are critical to monitor.",Office 365 (Microsoft 365),"Lateral Movement, Credential Access","T1110, T1110.001","`o365_management_activity` Workload=AzureActiveDirectory Operation=UserLoginFailed record_type=AzureActiveDirectoryStsLogon 
| bucket span=5m _time 
| stats dc(_raw) AS failed_attempts values(user) as user values(LogonError) as LogonError values(signature) as signature values(UserAgent) as UserAgent values(dest) as dest values(vendor_account) as vendor_account values(vendor_product) as vendor_product by _time, src_ip 
| where failed_attempts > 10 
| `high_number_of_login_failures_from_a_single_source_filter`"
Kubernetes AWS detect suspicious kubectl calls,The following analytic detects anonymous and unauthenticated requests to a Kubernetes cluster.,Kubernetes,,,"`kube_audit` user.username=""system:anonymous"" user.groups{} IN (""system:unauthenticated"") 
| fillnull 
| stats count by objectRef.name objectRef.namespace objectRef.resource requestReceivedTimestamp requestURI responseStatus.code sourceIPs{} stage user.groups{} user.uid user.username userAgent verb 
| rename sourceIPs{} as src_ip, user.username as user 
|`kubernetes_aws_detect_suspicious_kubectl_calls_filter`"
Microsoft Intune Device Health Scripts,"Microsoft Intune device remediation scripts are a tool administrators can use to remotely manage devices, this functionality can also be abused for SYSTEM level code execution and lateral movement to intune managed devices. This detection identifies when a new device health script has been added, updated or deleted.
Search 1`azure_monitor_activity` operationName=&#34;*DeviceHealthScript*&#34; 2| rename identity as user, properties.",Microsoft Intune (Azure Monitor),"Lateral Movement, Execution, Command And Control, Defense Evasion","T1072, T1021.007, T1202, T1105","`azure_monitor_activity` operationName=""*DeviceHealthScript*""  
| rename identity as user, properties.TargetObjectIds{} as TargetObjectId, properties.TargetDisplayNames{} as TargetDisplayName, properties.Actor.IsDelegatedAdmin as user_isDelegatedAdmin 
| rex field=""operationName"" ""^(?P<action>\w+?)DeviceHealthScript"" 
| replace ""patch"" with ""updated"", ""create"" with ""created"", ""delete"", with ""deleted"", ""assign"", with ""assigned"" IN action 
| table _time operationName action user user_type user_isDelegatedAdmin TargetDisplayName TargetObjectId status tenantId correlationId 
| `microsoft_intune_device_health_scripts_filter`"
Microsoft Intune DeviceManagementConfigurationPolicies,"Microsoft Intune device management configuration policies are a tool administrators can use to remotely manage policies and settings on intune managed devices. This functionality can also be abused to disable defences &amp; evade detection. This detection identifies when a new device management configuration policy has been created.
Search 1`azure_monitor_activity` operationName=&#34;* DeviceManagementConfigurationPolicy*&#34; 2| rename identity as user, properties.",Microsoft Intune (Azure Monitor),"Lateral Movement, Execution, Privilege Escalation, Defense Evasion","T1484, T1562.004, T1072, T1562.001, T1021.007","`azure_monitor_activity` operationName=""* DeviceManagementConfigurationPolicy*"" 
| rename identity as user, properties.TargetObjectIds{} as TargetObjectId, properties.TargetDisplayNames{} as TargetDisplayName, properties.Actor.IsDelegatedAdmin as user_isDelegatedAdmin 
| eval details=mvzip('properties.Targets{}.ModifiedProperties{}.Name','properties.Targets{}.ModifiedProperties{}.New',"": "") 
| rex field=""operationName"" ""^(?P<action>\w+)\s"" 
| replace ""Patch"" with ""updated"", ""Create"" with ""created"", ""Delete"", with ""deleted"", ""assign"", with ""assigned"" IN action 
| eval action=if(match(operationName ,""Assignment$""),""assigned"",'action') 
| table _time operationName action user user_type user_isDelegatedAdmin TargetDisplayName TargetObjectId details status tenantId correlationId 
| `microsoft_intune_devicemanagementconfigurationpolicies_filter`"
Microsoft Intune Manual Device Management,"Microsoft Intune device management configuration policies, scripts &amp; apps are a all tools administrators can use to remotely manage intune managed devices. Instead of waiting for the devices to poll for changes to polciies, the policies can be manually pushed to expidite delivery. This may be useful in a pinch, it may also be a sign of an impatient attacker trying to speed up the delivery of their payload.",Microsoft Intune (Azure Monitor),"Lateral Movement, Execution","T1021.007, T1072, T1529","`azure_monitor_activity` operationName=""*ManagedDevice*""  
| rename identity as user, properties.TargetObjectIds{} as TargetObjectId, properties.TargetDisplayNames{} as TargetDisplayName, properties.Actor.IsDelegatedAdmin as user_isDelegatedAdmin 
| rex field=""operationName"" ""^(?P<action>\w+)\s"" 
| table _time operationName action user user_type user_isDelegatedAdmin TargetDisplayName TargetObjectId status tenantId correlationId 
| `microsoft_intune_manual_device_management_filter`"
O365 Add App Role Assignment Grant User,"The following analytic detects the addition of an application role assignment grant to a user in Office 365. It leverages data from the o365_management_activity dataset, specifically monitoring the &quot;Add app role assignment grant to user&quot; operation. This activity is significant as it can indicate unauthorized privilege escalation or the assignment of sensitive roles to users.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation",T1136.003,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Add app role assignment grant to user."" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_add_app_role_assignment_grant_user_filter`"
O365 Added Service Principal,"The following analytic detects the addition of new service principal accounts in O365 tenants. It leverages data from the o365_management_activity dataset, specifically monitoring for operations related to adding or creating service principals. This activity is significant because attackers can exploit service principals to gain unauthorized access and perform malicious actions within an organization's environment.",Office 365 (Microsoft 365),Persistence,T1136.003,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""*Add service principal*"" OR (Operation = ""*principal*"" AND action = ""created"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_added_service_principal_filter`"
O365 Admin Consent Bypassed by Service Principal,"The following analytic identifies instances where a service principal in Office 365 Azure Active Directory assigns app roles without standard admin consent. It leverages o365_management_activity logs, specifically focusing on the 'Add app role assignment to service principal' operation. This activity is significant for SOCs as it may indicate a bypass of critical administrative controls, potentially leading to unauthorized access or privilege escalation.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation","T1098, T1098.003","`o365_management_activity` Workload=AzureActiveDirectory Operation=""Add app role assignment to service principal."" 
| eval len=mvcount('Actor{}.ID') 
| eval userType = mvindex('Actor{}.ID',len-1) 
| eval roleId = mvindex('ModifiedProperties{}.NewValue', 0) 
| eval roleValue = mvindex('ModifiedProperties{}.NewValue', 1) 
| eval roleDescription = mvindex('ModifiedProperties{}.NewValue', 2) 
| eval dest_user = mvindex('Target{}.ID', 0) 
| search userType = ""ServicePrincipal"" 
| eval src_user = user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product dest_user roleId roleValue roleDescription 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_admin_consent_bypassed_by_service_principal_filter`"
O365 Advanced Audit Disabled,"The following analytic detects instances where the O365 advanced audit is disabled for a specific user within the Office 365 tenant. It uses O365 audit logs, focusing on events related to audit license changes in AzureActiveDirectory workloads. This activity is significant because the O365 advanced audit provides critical logging and insights into user and administrator activities.",Office 365 (Microsoft 365),"Persistence, Exfiltration, Defense Evasion","T1562.008, T1562","`o365_management_activity` Operation=""Change user license."" 
| eval property_name = mvindex ('ExtendedProperties{}.Name', 1) 
| search property_name = ""extendedAuditEventCategory"" 
| eval additionalDetails = mvindex('ExtendedProperties{}.Value',0) 
| eval split_value=split(additionalDetails,""NewValue"") 
| eval possible_plan=mvindex(split_value, 1) 
| rex field=""possible_plan"" ""DisabledPlans=\[(?P<DisabledPlans>[^\]]+)\]"" 
| search DisabledPlans IN (""*M365_ADVANCED_AUDITING*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product DisabledPlans object 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_advanced_audit_disabled_filter`"
O365 Application Available To Other Tenants,"The following analytic identifies the configuration of Azure Active Directory Applications in a manner that allows authentication from external tenants or personal accounts. This configuration can lead to inappropriate or malicious access of any data or capabilities the application is allowed to access. This detection leverages the O365 Universal Audit Log data source.
Search 1`o365_management_activity` Workload=AzureActiveDirectory Operation IN (&#34;Add application.",Office 365 (Microsoft 365),"Persistence, Exfiltration","T1098, T1098.003","`o365_management_activity` Workload=AzureActiveDirectory Operation IN (""Add application."",""Update application."") ModifiedProperties{}.Name=AvailableToOtherTenants 
| eval result = case(match(mvindex('ModifiedProperties{}.NewValue',mvfind('ModifiedProperties{}.Name',""AvailableToOtherTenants"")),""false""),""removed"",true(),""added""), object_name=mvindex('Target{}.ID', 3), signature=Operation, object_attrs = ""AvailableToOtherTenants"", user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)) 
| search result = ""added"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product object_attrs object_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_application_available_to_other_tenants_filter`"
O365 Application Registration Owner Added,"The following analytic identifies instances where a new owner is assigned to an application registration within an Azure AD and Office 365 tenant. It leverages O365 audit logs, specifically events related to changes in owner assignments within the AzureActiveDirectory workload. This activity is significant because assigning a new owner to an application registration can grant significant control over the application's configuration, permissions, and behavior.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation",T1098,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Add owner to application."" 
| eval app_id=mvindex('ModifiedProperties{}.NewValue', 0) 
| eval app_displayName=mvindex('ModifiedProperties{}.NewValue', 1) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product app_id app_displayName object 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_application_registration_owner_added_filter`"
O365 ApplicationImpersonation Role Assigned,"The following analytic detects the assignment of the ApplicationImpersonation role in Office 365 to a user or application. It uses the Office 365 Management Activity API to monitor Azure Active Directory audit logs for role assignment events. This activity is significant because the ApplicationImpersonation role allows impersonation of any user, enabling access to and modification of their mailbox.",Office 365 (Microsoft 365),"Collection, Persistence","T1098, T1098.002","`o365_management_activity` Workload=Exchange Operation=""New-ManagementRoleAssignment"" Role=ApplicationImpersonation 
| rename User as target_user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product target_user 
| `security_content_ctime(lastTime)` 
| `o365_applicationimpersonation_role_assigned_filter`"
O365 Block User Consent For Risky Apps Disabled,"The following analytic detects when the &quot;risk-based step-up consent&quot; security setting in Microsoft 365 is disabled. It monitors Azure Active Directory logs for the &quot;Update authorization policy&quot; operation, specifically changes to the &quot;AllowUserConsentForRiskyApps&quot; setting. This activity is significant because disabling this feature can expose the organization to OAuth phishing threats, allowing users to grant consent to malicious applications.",Office 365 (Microsoft 365),Defense Evasion,T1562,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Update authorization policy."" 
| eval index_number = if(mvfind('ModifiedProperties{}.Name',""AllowUserConsentForRiskyApps"") >= 0, mvfind('ModifiedProperties{}.Name',""AllowUserConsentForRiskyApps""), -1) 
| search index_number >= 0 
| eval AllowUserConsentForRiskyApps = mvindex('ModifiedProperties{}.NewValue',index_number) 
| where AllowUserConsentForRiskyApps like ""%true%"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product AllowUserConsentForRiskyApps 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_block_user_consent_for_risky_apps_disabled_filter`"
O365 Bypass MFA via Trusted IP,"The following analytic identifies instances where new IP addresses are added to the trusted IPs list in Office 365, potentially allowing users from these IPs to bypass Multi-Factor Authentication (MFA) during login. It leverages O365 audit logs, specifically focusing on events related to the modification of trusted IP settings. This activity is significant because adding trusted IPs can weaken the security posture by bypassing MFA, which is a critical security control.",Office 365 (Microsoft 365),"Persistence, Defense Evasion","T1562.007, T1562","`o365_management_activity` Operation=""Set Company Information."" ModifiedProperties{}.Name=StrongAuthenticationPolicy 
| rex max_match=100 field=ModifiedProperties{}.NewValue ""(?<ip_addresses_new_added>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d{1,2})"" 
| rex max_match=100 field=ModifiedProperties{}.OldValue ""(?<ip_addresses_old>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d{1,2})"" 
| eval ip_addresses_old=if(isnotnull(ip_addresses_old),ip_addresses_old,""0"") 
| mvexpand ip_addresses_new_added 
| where isnull(mvfind(ip_addresses_old,ip_addresses_new_added)) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(ip_addresses_old) as ip_addresses_old by signature dest user src vendor_account vendor_product ip_addresses_new_added 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_bypass_mfa_via_trusted_ip_filter`"
O365 Compliance Content Search Exported,"The following analytic identifies when the results of a content search within the Office 365 Security and Compliance Center are exported. It uses the SearchExported operation from the SecurityComplianceCenter workload in the o365_management_activity data source. This activity is significant because exporting search results can involve sensitive or critical organizational data, potentially leading to data exfiltration.",Office 365 (Microsoft 365),"Collection, Discovery, Exfiltration","T1114, T1114.002","`o365_management_activity` Workload=SecurityComplianceCenter Operation=""SearchExported"" 
| rename user_id as user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product ExchangeLocations Query 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_compliance_content_search_exported_filter`"
O365 Compliance Content Search Started,"The following analytic detects when a content search is initiated within the Office 365 Security and Compliance Center. It leverages the SearchCreated operation from the o365_management_activity logs under the SecurityComplianceCenter workload. This activity is significant as it may indicate an attempt to access sensitive organizational data, including emails and documents. If confirmed malicious, this could lead to unauthorized data access, potential data exfiltration, and compliance violations.",Office 365 (Microsoft 365),"Collection, Discovery, Exfiltration","T1114, T1114.002","`o365_management_activity` Workload=SecurityComplianceCenter Operation=SearchCreated 
| rename user_id as user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product ExchangeLocations Query 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_compliance_content_search_started_filter`"
O365 Cross-Tenant Access Change,"The following analytic identifies when cross-tenant access/synchronization policies are changed in an Azure tenant. Adversaries have been observed altering victim cross-tenant policies as a method of lateral movement or maintaining persistent access to compromised environments. These policies should be considered sensitive and monitored for changes and/or loose configuration.
Search 1`o365_management_activity` Workload=AzureActiveDirectory Operation IN (&#34;Add a partner to cross-tenant access setting.",Office 365 (Microsoft 365),"Lateral Movement, Persistence, Defense Evasion","T1484.002, T1484","`o365_management_activity` Workload=AzureActiveDirectory Operation IN (""Add a partner to cross-tenant access setting."",""Delete partner specific cross-tenant access setting."") 
| eval user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature signature_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_cross_tenant_access_change_filter`"
O365 Disable MFA,"The following analytic identifies instances where Multi-Factor Authentication (MFA) is disabled for a user within the Office 365 environment. It leverages O365 audit logs, specifically focusing on events related to MFA settings. Disabling MFA removes a critical security layer, making accounts more vulnerable to unauthorized access. If confirmed malicious, this activity could indicate an attacker attempting to maintain persistence or an insider threat, significantly increasing the risk of unauthorized access.",Office 365 (Microsoft 365),"Persistence, Credential Access",T1556,"`o365_management_activity` Operation=""Disable Strong Authentication."" 
| rename UserId as user object as src_user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product src_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_disable_mfa_filter`"
O365 DLP Rule Triggered,"The following analytic detects when Microsoft Office 365 Data Loss Prevention (DLP) rules have been triggered. DLP rules can be configured for any number of security, regulatory, or business compliance reasons, as such this analytic will only be as accurate as the upstream DLP configuration. Detections from this analytic should be evaluated thoroughly to de termine what, if any, security relevance the underlying DLP events contain.",Office 365 (Microsoft 365),Exfiltration,"T1048, T1567","`o365_management_activity` Operation=DLPRuleMatch 
| eval recipient = 'ExchangeMetaData.To{}', signature_id = 'ExchangeMetaData.UniqueID', signature = 'PolicyDetails{}.Rules{}.RuleName' , src_user = UserId, reason ='PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.SensitiveInformationTypeName', result='PolicyDetails{}.Rules{}.Actions{}', file_name=case(NOT match('PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.Location',""Message Body""),'PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.Location') 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(signature) as signature values(file_name) as file_name values(ExchangeMetaData.Subject) AS subject values(Workload) as app values(result) as result by action dest user src vendor_account vendor_product src_user recipient signature_id reason 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_dlp_rule_triggered_filter`"
O365 Email Access By Security Administrator,"The following analytic identifies when a user with sufficient access to O365 Security &amp; Compliance portal uses premium investigation features (Threat Explorer) to directly view email. Adversaries may exploit privileged access with this premium feature to enumerate or exfiltrate sensitive data.
Search 1`o365_management_activity` Workload=SecurityComplianceCenter Operation=AdminMailAccess 2| rename InternetMessageId as signature_id, UserId as src_user 3| fillnull 4| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product src_user signature_id 5| `security_content_ctime(firstTime)` 6| `security_content_ctime(lastTime)` 7| `o365_email_access_by_security_administrator_filter` Data Source Name Platform Sourcetype Source Office 365 Universal Audit Log Other 'o365:management:activity' 'o365' Macros Used Name Value o365_management_activity sourcetype=o365:management:activity o365_email_access_by_security_administrator_filter search * o365_email_access_by_security_administrator_filter is an empty macro by default.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114.002, T1567","`o365_management_activity` Workload=SecurityComplianceCenter Operation=AdminMailAccess 
| rename InternetMessageId as signature_id, UserId as src_user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product src_user signature_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_access_by_security_administrator_filter`"
O365 Email Hard Delete Excessive Volume,The following analytic identifies when an O365 email account hard deletes an excessive number of emails within a short period (within 1 hour). This behavior may indicate a compromised account where the threat actor is attempting to permanently purge a large amount of items from the mailbox. Threat actors may attempt to remove evidence of their activity by purging items from the compromised mailbox.,Office 365 (Microsoft 365),"Impact, Defense Evasion","T1114, T1070.008, T1485","`o365_management_activity` Workload=Exchange (Operation IN (""HardDelete"") AND Folder.Path IN (""\\Sent Items"",""\\Recoverable Items\\Deletions""))
| eval user = lower(UserId), sender = lower(CASE(isnotnull(SendAsUserSmtp),SendAsUserSmtp,isnotnull(SendOnBehalfOfUserSmtp),SendOnBehalfOfUserSmtp,true(),MailboxOwnerUPN)), subject = trim(CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),'Item.Subject',Operation IN (""SoftDelete"",""HardDelete""),'AffectedItems{}.Subject')), -time = _time,file_name = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),split('Item.Attachments',""; ""),Operation IN (""SoftDelete"",""HardDelete""),split('AffectedItems{}.Attachments',""; "")), file_size = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),round(tonumber('Item.SizeInBytes')/1024/1024,2),true(),round(tonumber(replace(file_name, ""(.+)\s\((\d+)(b\)$)"", ""\2""))/1024/1024,2))
| bin _time span=1hr
| stats values(sender) as sender, values(ClientIPAddress) as src, values(ClientInfoString) as http_user_agent, values(Operation) as signature, latest(file_name) as file_name, sum(file_size) as file_size, values(Folder.Path) as file_path, min(-time) as firstTime, max(-time) as lastTime, dc(subject) as count by _time,user
| where count > 50 OR file_size > 10
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_hard_delete_excessive_volume_filter`"
O365 Email New Inbox Rule Created,"The following analytic identifies the creation of new email inbox rules in an Office 365 environment. It detects events logged under New-InboxRule and Set-InboxRule operations within the o365_management_activity data source, focusing on parameters that may indicate mail forwarding, removal, or obfuscation. Inbox rule creation is a typical end-user activity however attackers also leverage this technique for multiple reasons.",Office 365 (Microsoft 365),"Collection, Defense Evasion","T1114.003, T1114, T1564.008","`o365_management_activity` Workload=Exchange AND (Operation=New-InboxRule OR Operation=Set-InboxRule) Parameters{}.Name IN (SoftDeleteMessage,DeleteMessage,ForwardTo,ForwardAsAttachmentTo,RedirectTo,MoveToFolder,CopyToFolder)
| eval file_path = mvappend(MoveToFolder,CopyToFolder), recipient=mvappend(ForwardTo, ForwardAsAttachmentTo, RedirectTo), user = lower(UserId), signature = Operation, src = if(match(ClientIP, ""^\[""), ltrim(mvindex(split(ClientIP, ""]:""), 0), ""[""), mvindex(split(ClientIP,"":""),0)), desc = Name, action = 'Parameters{}.Name'
| stats values(action) as action, values(src) as src, values(recipient) as recipient, values(file_path) as file_path, count, min(_time) as firstTime, max(_time) as lastTime by user, signature, desc
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_new_inbox_rule_created_filter`"
O365 Email Receive and Hard Delete Takeover Behavior,"The following analytic identifies when an O365 email recipient receives and then deletes emails related to password or banking/payroll changes within a short period. This behavior may indicate a compromised account where the threat actor is attempting to redirect the victims payroll to an attacker controlled bank account.
Search 1`o365_messagetrace` subject IN (&#34;*banking*&#34;,&#34;*direct deposit*&#34;,&#34;*pay-to*&#34;,&#34;*password *&#34;,&#34;*passcode *&#34;,&#34;*OTP *&#34;,&#34;*MFA *&#34;,&#34;*Account Recovery*&#34;) 2 3| eval mailtime = _time 4 5| bin _time span=4hr 6 7| eval user = lower(RecipientAddress) 8 9| eval InternetMessageId = lower(MessageId) 10 11| join InternetMessageId, user max=0 12 [ 13 14| search `o365_management_activity` Workload=Exchange Operation IN (&#34;HardDelete&#34;) AND Folder.",Office 365 (Microsoft 365),"Collection, Impact, Defense Evasion","T1114.001, T1114, T1070.008, T1485","`o365_messagetrace` subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"")
| eval mailtime = _time
| bin _time span=4hr
| eval user = lower(RecipientAddress)
| eval InternetMessageId = lower(MessageId)
| join InternetMessageId, user max=0
[
| search `o365_management_activity` Workload=Exchange Operation IN (""HardDelete"") AND Folder.Path IN (""\\Sent Items"",""\\Recoverable Items\\Deletions"")
| spath path=AffectedItems{}  output=AffectedItemSplit
| fields _time,ClientProcessName,ClientIPAddress,ClientInfoString,UserId,Operation,ResultStatus,MailboxOwnerUPN,AffectedItemSplit,Folder.Path 
| mvexpand AffectedItemSplit 
| spath input=AffectedItemSplit
| search Subject IN (""*banking*"",""*direct deposit*"",""*pay-to*"",""*password *"",""*passcode *"",""*OTP *"",""*MFA *"",""*Account Recovery*"") 
| eval deltime = _time
| bin _time span=4hr
| eval InternetMessageId = lower(InternetMessageId), user = lower(UserId), subject = Subject
]
| stats values(ClientIPAddress) as src, values(ClientInfoString) as http_user_agent, values(Folder.Path) as file_path, values(Operation) as signature, values(ResultStatus) as result, values(InternetMessageId) as signature_id, count, min(mailtime) as firstTime, max(deltime) as lastTime by user,subject
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_receive_and_hard_delete_takeover_behavior_filter`"
O365 Email Reported By Admin Found Malicious,The following analytic detects when an email manually submitted to Microsoft through the Security &amp; Compliance portal is found to be malicious. This capability is an enhanced protection feature that can be used within o365 tenants by administrative users to report potentially malicious emails. This correlation looks for any submission that returns a Phish or Malware verdict upon submission.,Office 365 (Microsoft 365),Initial Access,"T1566.001, T1566.002","`o365_management_activity` Workload=SecurityComplianceCenter Operation=AdminSubmission 
| search RescanVerdict IN (Phish,Malware) 
| rename Id as signature_id, SenderIP as src, Recipients{} as dest_user, P1Sender as src_user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature signature_id dest_user src_user Subject SubmissionContent 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_reported_by_admin_found_malicious_filter`"
O365 Email Security Feature Changed,"The following analytic identifies when specific O365 advanced security settings are altered within the Office 365 tenant. If an attacker successfully disables O365 security settings, they can operate within the tenant with reduced risk of detection. This can lead to unauthorized data access, data exfiltration, account compromise, or other malicious activities without leaving a detailed audit trail.",Office 365 (Microsoft 365),"Persistence, Exfiltration, Defense Evasion","T1562.008, T1562.001, T1562","`o365_management_activity` Workload=Exchange AND Operation IN (""Set-*"",""Disable-*"",""New-*"",""Remove-*"") Operation IN (""*AntiPhish*"",""*SafeLink*"",""*SafeAttachment*"",""*Malware*"") 
| rename Id as object_id, UserId as user, Operation as signature, ObjectId as object 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature object_id object 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_security_feature_changed_filter`"
O365 Email Send and Hard Delete Exfiltration Behavior,The following analytic identifies when an O365 email account sends and then hard deletes an email to an external recipient within a short period (within 1 hour). This behavior may indicate a compromised account where the threat actor is attempting to remove forensic artifacts or evidence of exfiltration activity. This behavior is often seen when threat actors want to reduce the probability of detection by the compromised account owner.,Office 365 (Microsoft 365),"Collection, Exfiltration, Impact, Defense Evasion","T1114.001, T1114, T1070.008, T1485","`o365_messagetrace` Status=Delivered
| eval mailtime = _time
| bin _time span=1hr
| eval user = lower(SenderAddress), recipient = lower(RecipientAddress)
| eval InternetMessageId = lower(MessageId)
| join InternetMessageId, user, max=0
[
| search `o365_management_activity` Workload=Exchange (Operation IN (""Send*"")) OR (Operation IN (""HardDelete"") AND Folder.Path IN (""\\Sent Items"",""\\Recoverable Items\\Deletions""))
| eval user = lower(UserId), sender = lower(CASE(isnotnull(SendAsUserSmtp),SendAsUserSmtp,isnotnull(SendOnBehalfOfUserSmtp),SendOnBehalfOfUserSmtp,true(),MailboxOwnerUPN)), subject = trim(CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),'Item.Subject',Operation IN (""SoftDelete"",""HardDelete""),'AffectedItems{}.Subject')), -time = _time,file_name = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),split('Item.Attachments',""; ""),Operation IN (""SoftDelete"",""HardDelete""),split('AffectedItems{}.Attachments',""; "")), file_size = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),round(tonumber('Item.SizeInBytes')/1024/1024,2),true(),round(tonumber(replace(file_name, ""(.+)\s\((\d+)(b\)$)"", ""\2""))/1024/1024,2)), InternetMessageId = lower('Item.InternetMessageId')
| eval sendtime = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),_time)
| eval deltime = CASE(Operation IN (""SoftDelete"",""HardDelete""),_time)
| bin _time span=1hr
| stats values(sender) as sender, values(ClientInfoString) as http_user_agent, values(InternetMessageId) as InternetMessageId, values(file_name) as file_name, sum(file_size) as file_size, values(sendtime) as firstTime, values(deltime) as lastTime values(Operation) as signature, dc(Operation) as opcount, count by _time,subject,user
| where opcount > 1 AND firstTime < lastTime
]
| stats values(sender) as sender, values(http_user_agent) as http_user_agent, values(signature) as signature, values(file_name) as file_name, sum(file_size) as file_size, min(firstTime) as firstTime, max(lastTime) as lastTime  count by subject,user,recipient,Organization
| eval externalRecipient = if(match(lower(recipient),mvindex(split(lower(Organization),"".""),0)),0,1)
| where externalRecipient = 1
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_send_and_hard_delete_exfiltration_behavior_filter`"
O365 Email Send and Hard Delete Suspicious Behavior,The following analytic identifies when an O365 email account sends and then hard deletes email with within a short period (within 1 hour). This behavior may indicate a compromised account where the threat actor is attempting to remove forensic artifacts or evidence of activity. Threat actors often use this technique to prevent defenders and victims from knowing the account has been compromised.,Office 365 (Microsoft 365),"Collection, Exfiltration, Impact, Defense Evasion","T1114.001, T1114, T1070.008, T1485","`o365_management_activity` Workload=Exchange (Operation IN (""Send*"")) OR (Operation IN (""HardDelete"") AND Folder.Path IN (""\\Sent Items"",""\\Recoverable Items\\Deletions""))
| eval user = lower(UserId), sender = lower(CASE(isnotnull(SendAsUserSmtp),SendAsUserSmtp,isnotnull(SendOnBehalfOfUserSmtp),SendOnBehalfOfUserSmtp,true(),MailboxOwnerUPN)), subject = trim(CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),'Item.Subject',Operation IN (""SoftDelete"",""HardDelete""),'AffectedItems{}.Subject')), -time = _time,file_name = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),split('Item.Attachments',""; ""),Operation IN (""SoftDelete"",""HardDelete""),split('AffectedItems{}.Attachments',""; "")), file_size = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),round(tonumber('Item.SizeInBytes')/1024/1024,2),true(),round(tonumber(replace(file_name, ""(.+)\s\((\d+)(b\)$)"", ""\2""))/1024/1024,2))
| eval sendtime = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),_time)
| eval deltime = CASE(Operation IN (""SoftDelete"",""HardDelete""),_time)
| stats values(sender) as sender, values(ClientIPAddress) as src, values(ClientInfoString) as http_user_agent, values(Operation) as signature, values(file_name) as file_name, sum(file_size) as file_size, values(Folder.Path) as file_path, min(sendtime) as firstTime, max(deltime) as lastTime, dc(Operation) as opcount, count by subject,user
| eval timediff = tonumber(lastTime) - tonumber(firstTime)
| where opcount > 1 AND firstTime < lastTime  AND timediff < 3600
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_send_and_hard_delete_suspicious_behavior_filter`"
O365 Email Send Attachments Excessive Volume,The following analytic identifies when an O365 email account sends an excessive number of email attachments to external recipients within a short period (within 1 hour). This behavior may indicate a compromised account where the threat actor is attempting to exfiltrate data from the mailbox. Threat actors may attempt to transfer data through email as a simple means of exfiltration from the compromised mailbox.,Office 365 (Microsoft 365),"Exfiltration, Impact, Defense Evasion","T1114, T1070.008, T1485","`o365_messagetrace` Status=Delivered
| eval mailtime = _time
| bin _time span=1hr
| eval user = lower(SenderAddress), recipient = lower(RecipientAddress)
| eval InternetMessageId = lower(MessageId)
| join InternetMessageId, user, _time max=0
[
| search `o365_management_activity` Workload=Exchange Operation IN (""Send"",""SendAs"",""SendOnBehalf"") 
| eval user = lower(UserId), sender = lower(CASE(isnotnull(SendAsUserSmtp),SendAsUserSmtp,isnotnull(SendOnBehalfOfUserSmtp),SendOnBehalfOfUserSmtp,true(),MailboxOwnerUPN)), subject = trim(CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),'Item.Subject',Operation IN (""SoftDelete"",""HardDelete""),'AffectedItems{}.Subject')), -time = _time,file_name = trim(CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),split('Item.Attachments',""; ""),Operation IN (""SoftDelete"",""HardDelete""),split('AffectedItems{}.Attachments',""; ""))), file_size = CASE(Operation IN (""Send"",""SendAs"",""SendOnBehalf""),round(tonumber('Item.SizeInBytes')/1024/1024,2),true(),round(tonumber(replace(file_name, ""(.+)\s\((\d+)(b\)$)"", ""\2""))/1024/1024,2)), InternetMessageId = lower('Item.InternetMessageId')
| bin _time span=1hr
| eval file_name = mvfilter(NOT match(file_name, ""\.jpg 
|\.png 
|\.jpeg 
|\.gif ""))
| search file_name=*
| stats values(sender) as sender, values(ClientIPAddress) as src, values(ClientInfoString) as http_user_agent, values(Operation) as signature, values(file_name) as file_name, sum(file_size) as file_size, values(Folder.Path) as file_path, min(-time) as firstTime, max(-time) as lastTime, dc(file_name) as count by _time,user,InternetMessageId
| where count > 25
| eval file_name = mvjoin(file_name,""
|
|"")
]
| eval file_name = split(file_name,""
|
|"")
| stats values(sender) as sender, values(recipient) as recipient, values(http_user_agent) as http_user_agent, values(signature) as signature, values(file_name) as file_name, max(file_size) as file_size, min(firstTime) as firstTime, max(lastTime) as lastTime max(count) as count by subject,user,Organization,InternetMessageId
| eval recipient = mvmap(recipient, if(match(mvindex(split(lower(recipient),""@""),1),mvindex(split(lower(user),""@""),1)), null(),recipient))
| search recipient = *
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_send_attachments_excessive_volume_filter`"
O365 Email Suspicious Behavior Alert,The following analytic identifies when one of O365 the built-in security detections for suspicious email behaviors are triggered. These alerts often indicate that an attacker may have compromised a mailbox within the environment. Any detections from built-in Office 365 capabilities should be monitored and responded to appropriately. Certain premium Office 365 capabilities further enhance these detection and response functions.,Office 365 (Microsoft 365),Collection,T1114.003,"`o365_management_activity` Workload=SecurityComplianceCenter Operation=AlertEntityGenerated Name IN (""Suspicious email sending patterns detected"",""User restricted from sending email"",""Suspicious Email Forwarding Activity"",""Email sending limit exceeded"") 
| fromjson Data 
| rename Name as signature, AlertId as signature_id, ObjectId as user 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature signature_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_email_suspicious_behavior_alert_filter`"
O365 Email Transport Rule Changed,"The following analytic identifies when a user with sufficient access to Exchange Online alters the mail flow/transport rule configuration of the organization. Transport rules are a set of rules that can be used by attackers to modify or delete emails based on specific conditions, this activity could indicate an attacker hiding or exfiltrated data.",Office 365 (Microsoft 365),"Collection, Exfiltration, Defense Evasion","T1114.003, T1114, T1564.008","`o365_management_activity` Workload=Exchange AND Operation IN (""Set-*"",""Disable-*"",""New-*"",""Remove-*"") AND Operation=""*TransportRule"" 
| eval object_name = case('Parameters{}.Name'==""Name"",mvindex('Parameters{}.Value',mvfind('Parameters{}.Name',""^Name$"")),true(),ObjectId), object_id = case('Parameters{}.Name'==""Identity"",mvindex('Parameters{}.Value',mvfind('Parameters{}.Name',""^Identity$"")),true(),Id)
| stats values(object_name) as object_name, min(_time) as firstTime, max(_time) as lastTime, count by object_id, UserId, Operation, signature
| rename UserId as user
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_email_transport_rule_changed_filter`"
O365 Excessive Authentication Failures Alert,"The following analytic identifies an excessive number of authentication failures, including failed attempts against MFA prompt codes. It uses data from the o365_management_activity dataset, focusing on events where the authentication status is marked as failure. This behavior is significant as it may indicate a brute force attack or an attempt to compromise user accounts.",Office 365 (Microsoft 365),Credential Access,T1110,"`o365_management_activity` Workload=AzureActiveDirectory UserAuthenticationMethod=* status=failure 
| stats count earliest(_time) AS firstTime latest(_time) AS lastTime values(UserAuthenticationMethod) AS UserAuthenticationMethod values(UserAgent) AS user_agent values(status) AS status values(src_ip) AS src values(signature) as signature by user vendor_account vendor_product dest 
| where count > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_excessive_authentication_failures_alert_filter`"
O365 Excessive SSO logon errors,"The following analytic detects accounts experiencing a high number of Single Sign-On (SSO) logon errors. It leverages data from the o365_management_activity dataset, focusing on failed user login attempts with SSO errors. This activity is significant as it may indicate brute-force attempts or the hijacking/reuse of SSO tokens. If confirmed malicious, attackers could potentially gain unauthorized access to user accounts, leading to data breaches, privilege escalation, or further lateral movement within the organization.",Office 365 (Microsoft 365),"Lateral Movement, Credential Access, Privilege Escalation, Exfiltration",T1556,"`o365_management_activity` Workload=AzureActiveDirectory LogonError=*Sso* Operation=UserLoginFailed 
| stats count min(_time) as firstTime max(_time) as lastTime values(user) as user by src vendor_account vendor_product dest signature user_agent 
| where count >= 5 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_excessive_sso_logon_errors_filter`"
O365 Exfiltration via File Access,The following analytic detects when an excessive number of files are access from o365 by the same user over a short period of time. A malicious actor may abuse the &quot;open in app&quot; functionality of SharePoint through scripted or Graph API based access to evade triggering the FileDownloaded Event. This behavior may indicate an attacker staging data for exfiltration or an insider threat removing organizational data.,Office 365 (Microsoft 365),"Collection, Exfiltration","T1530, T1567","`o365_management_activity` Operation IN (""fileaccessed"") UserId!=app@sharepoint NOT SourceFileExtension IN (bmp,png,jpeg,jpg)
| eval user = replace(mvindex(split(lower(UserId),""#ext#""),0),""_"",""@""), user_flat = replace(UserId, ""[^A-Za-z0-9]"",""_"")
| where NOT match(SiteUrl,user_flat)
| stats values(user) as user, latest(ClientIP) as src values(ZipFileName) as file_name, values(Operation) as signature, values(UserAgent) as http_user_agent, dc(SourceFileName) as count, min(_time) as firstTime, max(_time) as lastTime by Workload,UserId,SiteUrl
| eventstats avg(count) as avg stdev(count) as stdev by Workload
| rename SiteUrl as file_path,Workload as app
| where count > 50 AND count > (avg + (3*(stdev))) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_exfiltration_via_file_access_filter`"
O365 Exfiltration via File Download,"The following analytic detects when an excessive number of files are downloaded from o365 by the same user over a short period of time. O365 may bundle these files together as a ZIP file, however each file will have it's own download event. This behavior may indicate an attacker staging data for exfiltration or an insider threat removing organizational data.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1530, T1567","`o365_management_activity` Operation IN (""filedownloaded"") 
| eval user = replace(mvindex(split(lower(UserId),""#ext#""),0),""_"",""@""), user_flat = replace(UserId, ""[^A-Za-z0-9]"",""_"")
| stats values(user) as user, latest(ClientIP) as src values(ZipFileName) as file_name, values(Operation) as signature, values(UserAgent) as http_user_agent, dc(SourceFileName) as count, min(_time) as firstTime, max(_time) as lastTime by Workload,UserId,SiteUrl
| rename SiteUrl as file_path,Workload as app
| where count > 50
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_exfiltration_via_file_download_filter`"
O365 Exfiltration via File Sync Download,The following analytic detects when an excessive number of files are sync from o365 by the same user over a short period of time. A malicious actor abuse the user-agent string through GUI or API access to evade triggering the FileDownloaded event. This behavior may indicate an attacker staging data for exfiltration or an insider threat removing organizational data.,Office 365 (Microsoft 365),"Collection, Exfiltration","T1530, T1567","`o365_management_activity` Operation IN (""filesyncdownload*"") UserAgent=""*SkyDriveSync*""
| eval user = replace(mvindex(split(lower(UserId),""#ext#""),0),""_"",""@""), user_flat = replace(UserId, ""[^A-Za-z0-9]"",""_"")
| where NOT match(SiteUrl,user_flat)
| stats values(user) as user, latest(ClientIP) as src values(ZipFileName) as file_name, values(Operation) as signature, values(UserAgent) as http_user_agent, dc(SourceFileName) as count, min(_time) as firstTime, max(_time) as lastTime by Workload,UserId,SiteUrl
| rename SiteUrl as file_path,Workload as app
| where count > 50
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `o365_exfiltration_via_file_sync_download_filter`"
O365 External Guest User Invited,"The following analytic identifies the invitation of an external guest user within Azure AD. With Azure AD B2B collaboration, users and administrators can invite external users to collaborate with internal users. External guest account invitations should be monitored by security teams as they could potentially lead to unauthorized access. An example of this attack vector was described at BlackHat 2022 by security researcher Dirk-Jan during his tall Backdooring and Hijacking Azure AD Accounts by Abusing External Identities.",Office 365 (Microsoft 365),"Persistence, Exfiltration","T1136.003, T1136","`o365_management_activity` Workload=AzureActiveDirectory AND Operation=""Add user*"" AND ModifiedProperties{}.NewValue=""[*Guest*]"" AND ModifiedProperties{}.NewValue=""[*Invitation*]"" 
| eval user = (mvindex('ModifiedProperties{}.NewValue',5)), src_user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)) 
| rex field=user ""(?<user> [ \w\.-]+@ [ \w-]+\. [ \w-]{2,4})"" 
| rename Operation as signature, Id as signature_id 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product signature signature_id src_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_external_guest_user_invited_filter`"
O365 External Identity Policy Changed,"The following analytic identifies when changes are made to the external guest policies within Azure AD. With Azure AD B2B collaboration, users and administrators can invite external users to collaborate with internal users. This detection also attempts to highlight what may have changed. External guest account invitations should be monitored by security teams as they could potentially lead to unauthorized access.",Office 365 (Microsoft 365),Persistence,T1136.003,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Update policy."" Target{}.ID=""B2BManagementPolicy"" 
| eval object_attrs = mvindex('ModifiedProperties{}.NewValue',0), object_attrs_old = mvindex('ModifiedProperties{}.OldValue',0), object_name = mvindex('Target{}.ID',3), signature=Operation, user = case(match(mvindex('Actor{}.ID',-1),""User""),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),""ServicePrincipal""), mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0)) 
| spath input=object_attrs_old output=B2BOld path={} 
| spath input=B2BOld 
| rename B2BManagementPolicy.* as B2BManagementPolicyOld.* 
| spath input=object_attrs output=B2BNew path={} 
| spath input=B2BNew 
| eval object_attrs = 'B2BManagementPolicy.InvitationsAllowedAndBlockedDomainsPolicy.AllowedDomains{}' , object_attrs_old = 'B2BManagementPolicyOld.InvitationsAllowedAndBlockedDomainsPolicy.AllowedDomains{}' 
| eval diff_add=mvmap(object_attrs,if(isnull(mvfind(object_attrs_old,object_attrs)),object_attrs,null)) 
| eval diff_remove=mvmap(object_attrs_old,if(isnull(mvfind(object_attrs,object_attrs_old)),object_attrs_old,null)) 
| eval result = case(isnotnull(diff_add),""Added "".mvjoin(diff_add,"",""),isnotnull(diff_remove),""Removed "".mvjoin(diff_remove,"","")), action = case(isnotnull(diff_add),""created"",isnotnull(diff_remove),""deleted"") 
| stats values(object_attrs) as object_attrs, values(action) as action, values(result) as result, values(B2BManagementPolicy*) as B2BManagementPolicy*, count, min(_time) as firstTime, max(_time) as lastTime by user signature object_name dest vendor_account vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_external_identity_policy_changed_filter`"
O365 File Permissioned Application Consent Granted by User,"The following analytic identifies instances where a user in the Office 365 environment grants consent to an application requesting file permissions for OneDrive or SharePoint. It leverages O365 audit logs, focusing on OAuth application consent events. This activity is significant because granting such permissions can allow applications to access, modify, or delete files, posing a risk if the application is malicious or overly permissive.",Office 365 (Microsoft 365),Credential Access,T1528,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Consent to application."" ResultStatus=Success 
| eval admin_consent =mvindex('ModifiedProperties{}.NewValue',0) 
| search admin_consent=False 
| eval permissions =mvindex('ModifiedProperties{}.NewValue',4) 
| rex field=permissions ""Scope:(?<Scope>[^,]+)"" 
| makemv delim="" "" Scope 
| search Scope IN (""Files.Read"", ""Files.Read.All"", ""Files.ReadWrite"", ""Files.ReadWrite.All"", ""Files.ReadWrite.AppFolder"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(Scope) as Scope by signature dest user src vendor_account vendor_product object ObjectId 
| `security_content_ctime(lastTime)` 
| `o365_file_permissioned_application_consent_granted_by_user_filter`"
O365 FullAccessAsApp Permission Assigned,"The following analytic detects the assignment of the 'full_access_as_app' permission to an application registration in Office 365 Exchange Online. This detection leverages Office 365 management activity logs and filters Azure Active Directory workload events to identify when the specific permission, identified by GUID 'dc890d15-9560-4a4c-9b7f-a736ec74ec40', is granted. This activity is significant because it provides extensive control over Office 365 operations, including access to all mailboxes and the ability to send mail as any user.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation, Exfiltration","T1098.003, T1098, T1098.002","`o365_management_activity` Workload=AzureActiveDirectory Operation=""Update application."" 
| eval newvalue = mvindex('ModifiedProperties{}.NewValue',0) 
| spath input=newvalue 
| search ""{}.ResourceAppId""=""00000002-0000-0ff1-ce00-000000000000""""{}.RequiredAppPermissions{}.EntitlementId""=""dc890d15-9560-4a4c-9b7f-a736ec74ec40"" 
| eval Permissions = '{}.RequiredAppPermissions{}.EntitlementId' 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(Scope) as Scope by signature dest user src vendor_account vendor_product object user_agent 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_fullaccessasapp_permission_assigned_filter`"
O365 High Number Of Failed Authentications for User,"The following analytic identifies an O365 account experiencing more than 20 failed authentication attempts within 5 minutes. It uses O365 Unified Audit Logs, specifically &quot;UserLoginFailed&quot; events, to monitor and flag accounts exceeding this threshold. This activity is significant as it may indicate a brute force attack or password guessing attempt. If confirmed malicious, an attacker could gain unauthorized access to the O365 environment, potentially compromising sensitive emails, documents, and other data.",Office 365 (Microsoft 365),Credential Access,"T1110, T1110.001","`o365_management_activity` Operation=UserLoginFailed record_type=AzureActiveDirectoryStsLogon Workload=AzureActiveDirectory 
| bucket span=5m _time 
| fillnull 
| stats dc(_raw) AS failed_attempts values(src_ip) as src by signature user _time dest vendor_account vendor_product 
| where failed_attempts > 10 
| `o365_high_number_of_failed_authentications_for_user_filter`"
O365 High Privilege Role Granted,"The following analytic detects when high-privilege roles such as &quot;Exchange Administrator,&quot; &quot;SharePoint Administrator,&quot; or &quot;Global Administrator&quot; are granted within Office 365. It leverages O365 audit logs to identify events where these roles are assigned to any user or service account. This activity is significant for SOCs as these roles provide extensive permissions, allowing broad access and control over critical resources and data.",Office 365 (Microsoft 365),Persistence,"T1098, T1098.003","`o365_management_activity` Operation=""Add member to role."" Workload=AzureActiveDirectory 
| eval role_id = mvindex('ModifiedProperties{}.NewValue',2) 
| eval role_name = mvindex('ModifiedProperties{}.NewValue',1) 
| where role_id IN (""29232cdf-9323-42fd-ade2-1d097af3e4de"", ""f28a1f50-f6e7-4571-818b-6a12f2af6b6c"", ""62e90394-69f5-4237-9190-012177145e10"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by signature dest user src vendor_account vendor_product ObjectId role_name role_id 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_high_privilege_role_granted_filter`"
O365 Mail Permissioned Application Consent Granted by User,"The following analytic identifies instances where a user grants consent to an application requesting mail-related permissions within the Office 365 environment. It leverages O365 audit logs, specifically focusing on events related to application permissions and user consent actions. This activity is significant as it can indicate potential security risks, such as data exfiltration or spear phishing, if malicious applications gain access.",Office 365 (Microsoft 365),"Credential Access, Exfiltration",T1528,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Consent to application."" ResultStatus=Success 
| eval admin_consent =mvindex('ModifiedProperties{}.NewValue',0) 
| search admin_consent=False 
| eval permissions =mvindex('ModifiedProperties{}.NewValue',4) 
| rex field=permissions ""Scope:(?<Scope>[^,]+)"" 
| makemv delim="" "" Scope 
| search Scope IN (""Mail.Read"", ""Mail.ReadBasic"", ""Mail.ReadWrite"", ""Mail.Read.Shared"", ""Mail.ReadWrite.Shared"", ""Mail.Send"", ""Mail.Send.Shared"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(Scope) as Scope by signature dest user src vendor_account vendor_product object ObjectId 
| `security_content_ctime(lastTime)` 
| `o365_mail_permissioned_application_consent_granted_by_user_filter`"
O365 Mailbox Email Forwarding Enabled,"The following analytic identifies instances where email forwarding has been enabled on mailboxes within an Office 365 environment. It detects this activity by monitoring the Set-Mailbox operation within the o365_management_activity logs, specifically looking for changes to the ForwardingAddress or ForwardingSmtpAddress parameters. This activity is significant as unauthorized email forwarding can lead to data exfiltration and unauthorized access to sensitive information.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114.003, T1114","`o365_management_activity` Operation=Set-Mailbox 
| eval match1=mvfind('Parameters{}.Name',""ForwardingAddress"") 
| eval match2=mvfind('Parameters{}.Name', ""ForwardingSmtpAddress"") 
| where match1>= 0 OR match2>= 0 
| eval ForwardTo=coalesce(ForwardingAddress,ForwardingSmtpAddress) 
| search ForwardTo!="""" 
| rename user_id as user 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(ForwardTo) as ForwardTo by signature dest user src vendor_account vendor_product object ObjectId 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_mailbox_email_forwarding_enabled_filter`"
O365 Mailbox Inbox Folder Shared with All Users,"The following analytic detects instances where the inbox folder of an Office 365 mailbox is shared with all users within the tenant. It leverages Office 365 management activity events to identify when the 'Inbox' folder permissions are modified to include 'Everyone' with read rights. This activity is significant as it represents a potential security risk, allowing unauthorized access to sensitive emails.",Office 365 (Microsoft 365),"Collection, Persistence, Exfiltration","T1114, T1114.002","`o365_management_activity` Operation=ModifyFolderPermissions Workload=Exchange object=Inbox Item.ParentFolder.MemberUpn=Everyone 
| eval isReadRole=if(match('Item.ParentFolder.MemberRights',""(ReadAny)""), ""true"", ""false"") 
| search isReadRole = ""true"" 
| rename UserId as user 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime by signature, user, dest, vendor_account, vendor_product, object, MailboxOwnerUPN, Item.ParentFolder.MemberUpn, Item.ParentFolder.MemberRights, src 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_mailbox_inbox_folder_shared_with_all_users_filter`"
O365 Mailbox Read Access Granted to Application,"The following analytic identifies instances where the Mail.Read Graph API permissions are granted to an application registration within an Office 365 tenant. It leverages O365 audit logs, specifically events related to changes in application permissions within the AzureActiveDirectory workload. This activity is significant because the Mail.Read permission allows applications to access and read all emails within a user's mailbox, which often contain sensitive or confidential information.",Office 365 (Microsoft 365),"Collection, Persistence, Privilege Escalation, Exfiltration","T1114, T1114.002, T1098, T1098.003","`o365_management_activity` Operation=""Update application."" 
| eval json_data=mvindex('ModifiedProperties{}.NewValue',0) 
| eval json_data=replace(json_data,""^\[\s*"","""") 
| eval json_data=replace(json_data,""\s*\]$"","""") 
| spath input=json_data path=RequiredAppPermissions{}.EntitlementId output=EntitlementIds 
| eval match_found=mvfind(EntitlementIds, ""810c84a8-4a9e-49e6-bf7d-12d183f40d01"") 
| where isnotnull(match_found) 
| fillnull 
| stats count earliest(_time) as firstTime max(_time) as lastTime values(EntitlementIds) as EntitlementIds by signature, user, dest, vendor_account, vendor_product, object, src 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_mailbox_read_access_granted_to_application_filter`"
O365 Multi-Source Failed Authentications Spike,"The following analytic identifies a spike in failed authentication attempts within an Office 365 environment, indicative of a potential distributed password spraying attack. It leverages UserLoginFailed events from O365 Management Activity logs, focusing on ErrorNumber 50126. This detection is significant as it highlights attempts to bypass security controls using multiple IP addresses and user agents.",Office 365 (Microsoft 365),"Lateral Movement, Credential Access, Privilege Escalation","T1586.003, T1110.004, T1110.003, T1110","`o365_management_activity` Workload=AzureActiveDirectory Operation=UserLoginFailed ErrorNumber=50126 
| bucket span=5m _time 
| eval uniqueIPUserCombo = src_ip . ""-"" . user 
| fillnull 
| stats earliest(_time) as firstTime max(_time) as lastTime dc(uniqueIPUserCombo) as uniqueIpUserCombinations, dc(user) as uniqueUsers, dc(src_ip) as uniqueIPs, values(user) as user, values(src_ip) as ips, values(user_agent) as user_agents values(signature) as signature values(src) as src values(dest) as dest by _time vendor_account vendor_product 
| where uniqueIpUserCombinations > 20 AND uniqueUsers > 20 AND uniqueIPs > 20 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_multi_source_failed_authentications_spike_filter`"
O365 Multiple AppIDs and UserAgents Authentication Spike,"The following analytic identifies unusual authentication activity in an O365 environment, where a single user account experiences more than 8 authentication attempts using 3 or more unique application IDs and over 5 unique user agents within a short timeframe. It leverages O365 audit logs, focusing on authentication events and applying statistical thresholds. This behavior is significant as it may indicate an adversary probing for multi-factor authentication weaknesses.",Office 365 (Microsoft 365),"Exfiltration, Privilege Escalation, Defense Evasion",T1078,"`o365_management_activity` Workload=AzureActiveDirectory (Operation=UserLoggedIn OR Operation=UserLoginFailed) 
| bucket span=5m _time 
| stats dc(_raw) as failed_attempts dc(ApplicationId) as unique_app_ids dc(UserAgent) as unique_user_agents values(ApplicationId) values(OS) values(signature) as signature by _time user src vendor_account vendor_product dest 
| where failed_attempts > 5 and unique_user_agents > 5 and unique_app_ids > 2 
| `o365_multiple_appids_and_useragents_authentication_spike_filter`"
O365 Multiple Mailboxes Accessed via API,"The following analytic detects when a high number of Office 365 Exchange mailboxes are accessed via API (Microsoft Graph API or Exchange Web Services) within a short timeframe. It leverages 'MailItemsAccessed' operations in Exchange, using AppId and regex to identify API interactions. This activity is significant as it may indicate unauthorized mass email access, potentially signaling data exfiltration or account compromise.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114, T1114.002","`o365_management_activity` Workload=Exchange Operation=MailItemsAccessed AppId=* ClientAppId=* 
| bucket span=10m _time 
| eval matchRegex=if(match(ClientInfoString,""^Client=WebServices;ExchangeWebServices""), 1, 0) 
| search (AppId=""00000003-0000-0000-c000-000000000000"" OR matchRegex=1) 
| fillnull 
| stats values(ClientIPAddress) as src dc(user) as unique_mailboxes values(user) as user by _time ClientAppId ClientInfoString vendor_account vendor_product dest signature 
| where unique_mailboxes > 5 
| `o365_multiple_mailboxes_accessed_via_api_filter`"
O365 Multiple OS Vendors Authenticating From User,The following analytic identifies when multiple operating systems are used to authenticate to Azure/EntraID/Office 365 by the same user account over a short period of time. This activity could be indicative of attackers enumerating various logon capabilities of Azure/EntraID/Office 365 and attempting to discover weaknesses in the organizational MFA or conditional access configurations. Usage of the tools like &quot;MFASweep&quot; will trigger this detection.,Office 365 (Microsoft 365),Credential Access,T1110,"`o365_management_activity` Operation IN (UserLoginFailed,UserLoggedIn) 
| eval -time = _time 
| bin _time span=15m 
| fillnull 
| stats values(Operation) as signature, values(ErrorNumber) as signature_id, values(OS) as os_name, dc(OS) as os_count, count, min(-time) as firstTime, max(-time) as lastTime by ClientIP, UserId, _time, dest, vendor_account, vendor_product
| where os_count >= 4 
| eval src = ClientIP, user = UserId 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_multiple_os_vendors_authenticating_from_user_filter`"
O365 Multiple Service Principals Created by SP,"The following analytic identifies instances where a single service principal creates more than three unique OAuth applications within a 10-minute timeframe. It leverages O365 logs from the Unified Audit Log, focusing on the 'Add service principal' operation in the Office 365 Azure Active Directory environment. This activity is significant as it may indicate a compromised or malicious service principal attempting to expand control or access within the network.",Office 365 (Microsoft 365),"Lateral Movement, Persistence","T1136.003, T1136","`o365_management_activity` Workload=AzureActiveDirectory Operation=""Add service principal."" 
| bucket span=10m _time 
| eval len=mvcount('Actor{}.ID') 
| eval userType = mvindex('Actor{}.ID',len-1) 
| search userType = ""ServicePrincipal"" 
| eval displayName = object 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(displayName) as displayName dc(displayName) as unique_apps values(user) as user values(src) as src by src_user vendor_account vendor_product dest signature 
| where unique_apps > 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_multiple_service_principals_created_by_sp_filter`"
O365 Multiple Service Principals Created by User,"The following analytic identifies instances where a single user creates more than three unique OAuth applications within a 10-minute window in the Office 365 environment. It leverages O365 logs from the Unified Audit Log, focusing on the 'Add service principal' operation in Azure Active Directory. This activity is significant as it may indicate a compromised user account or unauthorized actions, potentially leading to broader network infiltration or privilege escalation.",Office 365 (Microsoft 365),"Persistence, Privilege Escalation","T1136.003, T1136","`o365_management_activity` Workload=AzureActiveDirectory Operation=""Add service principal."" 
| bucket span=10m _time 
| eval len=mvcount('Actor{}.ID') 
| eval userType = mvindex('Actor{}.ID',len-1) 
| search userType = ""User"" 
| eval displayName = object 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(displayName) as displayName dc(displayName) as unique_apps values(user) as user values(src) as src by src_user vendor_account vendor_product dest signature 
| where unique_apps > 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_multiple_service_principals_created_by_user_filter`"
O365 Multiple Users Failing To Authenticate From Ip,"The following analytic identifies instances where more than 10 unique user accounts fail to authenticate from a single IP address within a 5-minute window. This detection leverages O365 audit logs, specifically Azure Active Directory login failures (AzureActiveDirectoryStsLogon). Such activity is significant as it may indicate brute-force attacks or password spraying attempts. If confirmed malicious, this behavior suggests an external entity is attempting to breach security by targeting multiple accounts, potentially leading to unauthorized access.",Office 365 (Microsoft 365),Credential Access,"T1586.003, T1110.004, T1110.003, T1110","`o365_management_activity` Workload=AzureActiveDirectory Operation=UserLoginFailed ErrorNumber=50126 
| bucket span=5m _time 
| fillnull 
| stats dc(user) as unique_accounts values(user) as user values(LogonError) as LogonError values(signature) as signature values(UserAgent) as user_agent values(dest) as dest by _time src vendor_account vendor_product 
| where unique_accounts > 10 
| `o365_multiple_users_failing_to_authenticate_from_ip_filter`"
O365 New Email Forwarding Rule Created,"The following analytic identifies the creation of new email forwarding rules in an Office 365 environment. It detects events logged under New-InboxRule and Set-InboxRule operations within the o365_management_activity data source, focusing on parameters like ForwardTo, ForwardAsAttachmentTo, and RedirectTo. This activity is significant as unauthorized email forwarding can lead to data exfiltration and unauthorized access to sensitive information.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114.003, T1114","`o365_management_activity` (Operation=New-InboxRule OR Operation=set-InboxRule) 
| eval match1=mvfind('Parameters{}.Name', ""ForwardTo"") 
| eval match2=mvfind('Parameters{}.Name', ""ForwardAsAttachmentTo"") 
| eval match3=mvfind('Parameters{}.Name', ""RedirectTo"") 
| where match1>= 0 OR match2>= 0 OR match3>= 0 
| eval ForwardTo=coalesce(ForwardTo, ForwardAsAttachmentTo, RedirectTo) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(Name) as Name by signature dest user src vendor_account vendor_product ForwardTo 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_new_email_forwarding_rule_created_filter`"
O365 New Email Forwarding Rule Enabled,"The following analytic identifies the creation of new email forwarding rules in an Office 365 environment via the UpdateInboxRules operation. It leverages Office 365 management activity events to detect rules that forward emails to external recipients by examining the OperationProperties for specific forwarding actions. This activity is significant as it may indicate unauthorized email redirection, potentially leading to data exfiltration.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114.003, T1114","`o365_management_activity` Workload=Exchange Operation=UpdateInboxRules 
| eval match1=mvfind('OperationProperties{}.Value', ""ForwardToRecipientsAction"") 
| eval match2=mvfind('OperationProperties{}.Value', ""ForwardAsAttachmentToRecipientsAction"") 
| eval match3=mvfind('OperationProperties{}.Value', ""RedirectToRecipientsAction"") 
| eval index = mvfind('OperationProperties{}.Name', ""ServerRule"") 
| where match1>=0 OR match2>= 0 OR match3>= 0 
| eval ServerRule = mvindex('OperationProperties{}.Value',index-1) 
| spath input=ServerRule path=Actions{}.Recipients{}.Values{}.Value output=valueExtracted 
| mvexpand valueExtracted 
| search valueExtracted=""*@*.*"" 
| eval ForwardTo=if(match(valueExtracted,""^[^@]+@[^@]+\\.[^@]+$""), valueExtracted, null) 
| dedup ForwardTo 
| where isnotnull(ForwardTo) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(Name) as Name by signature dest user src vendor_account vendor_product ForwardTo 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_new_email_forwarding_rule_enabled_filter`"
O365 New Federated Domain Added,"The following analytic identifies the addition of a new federated domain in an Office 365 environment. This behavior is detected by analyzing Office 365 management activity logs, specifically filtering for Workload=Exchange and Operation=&quot;Add-FederatedDomain&quot;. The addition of a new federated domain is significant as it may indicate unauthorized changes or potential compromises. If confirmed malicious, attackers could establish a backdoor, bypass security measures, or exfiltrate data, leading to data breaches and unauthorized access to sensitive information.",Office 365 (Microsoft 365),Persistence,T1136.003,"`o365_management_activity` Operation IN (""*add*"", ""*new*"") AND Operation=""*domain*"" 
| eval src=""NA"" 
| fillnull 
| stats count values(ModifiedProperties{}.NewValue) as new_value by user user_agent authentication_service signature Workload src vendor_account vendor_product dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_new_federated_domain_added_filter`"
O365 New Forwarding Mailflow Rule Created,"The following analytic detects the creation of new mail flow rules in Office 365 that may redirect or copy emails to unauthorized or external addresses. It leverages Office 365 Management Activity logs, specifically querying for the &quot;New-TransportRule&quot; operation and parameters like &quot;BlindCopyTo&quot;, &quot;CopyTo&quot;, and &quot;RedirectMessageTo&quot;. This activity is significant as it can indicate potential data exfiltration or unauthorized access to sensitive information.",Office 365 (Microsoft 365),"Collection, Exfiltration",T1114,"`o365_management_activity` Workload=Exchange Operation=""New-TransportRule"" 
| eval match1=mvfind('Parameters{}.Name',""BlindCopyTo"") 
| eval match2=mvfind('Parameters{}.Name',""CopyTo"") 
| eval match3=mvfind('Parameters{}.Name', ""RedirectMessageTo"") 
| where match1>= 0 OR match2>= 0 OR match3>=0 
| eval ForwardTo=coalesce(BlindCopyTo, CopyTo, RedirectMessageTo) 
| search ForwardTo!="""" 
| rename UserId as user 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime by user, Name, ForwardTo, vendor_account, vendor_product, dest, signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_new_forwarding_mailflow_rule_created_filter`"
O365 OAuth App Mailbox Access via EWS,"The following analytic detects when emails are accessed in Office 365 Exchange via Exchange Web Services (EWS) using OAuth-authenticated applications. It leverages the ClientInfoString field to identify EWS interactions and aggregates metrics such as access counts, timing, and client IP addresses, categorized by user, ClientAppId, OperationCount, and AppId. Monitoring OAuth applications accessing emails through EWS is crucial for identifying potential abuse or unauthorized data access.",Office 365 (Microsoft 365),"Collection, Exfiltration","T1114, T1114.002","`o365_management_activity` Workload=Exchange Operation=MailItemsAccessed AppId=* ClientAppId=* 
| regex ClientInfoString=""^Client=WebServices;ExchangeWebServices"" 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(ClientIPAddress) as src by user ClientAppId OperationCount AppId vendor_account vendor_product dest signature ClientInfoString 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_oauth_app_mailbox_access_via_ews_filter`"
O365 OAuth App Mailbox Access via Graph API,"The following analytic detects when emails are accessed in Office 365 Exchange via the Microsoft Graph API using the client ID '00000003-0000-0000-c000-000000000000'. It leverages the 'MailItemsAccessed' operation within the Exchange workload, focusing on OAuth-authenticated applications. This activity is significant as unauthorized access to emails can lead to data breaches and information theft. If confirmed malicious, attackers could exfiltrate sensitive information, compromise user accounts, and further infiltrate the organization's network.",Office 365 (Microsoft 365),Collection,"T1114, T1114.002","`o365_management_activity` Workload=Exchange Operation=MailItemsAccessed AppId=* AppId=00000003-0000-0000-c000-000000000000 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(ClientIPAddress) as src by user ClientAppId OperationCount AppId vendor_account vendor_product dest signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_oauth_app_mailbox_access_via_graph_api_filter`"
O365 Privileged Graph API Permission Assigned,"The following analytic detects the assignment of critical Graph API permissions in Azure AD using the O365 Unified Audit Log. It focuses on permissions such as Application.ReadWrite.All, AppRoleAssignment.ReadWrite.All, and RoleManagement.ReadWrite.Directory. The detection method leverages Azure Active Directory workload events, specifically 'Update application' operations. This activity is significant as these permissions provide extensive control over Azure AD settings, posing a high risk if misused.",Office 365 (Microsoft 365),"Persistence, Credential Access, Privilege Escalation",T1003.002,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Update application."" 
| eval newvalue = mvindex('ModifiedProperties{}.NewValue',0) 
| spath input=newvalue 
| search ""{}.RequiredAppPermissions{}.EntitlementId""=""1bfefb4e-e0b5-418b-a88f-73c46d2cc8e9"" OR ""{}.RequiredAppPermissions{}.EntitlementId""=""06b708a9-e830-4db3-a914-8e69da51d44f"" OR ""{}.RequiredAppPermissions{}.EntitlementId""=""9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8"" 
| eval Permissions = '{}.RequiredAppPermissions{}.EntitlementId' 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime values(Permissions) by user src object user_agent signature vendor_account vendor_product dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_privileged_graph_api_permission_assigned_filter`"
O365 PST export alert,"The following analytic detects instances where a user has initiated an eDiscovery search or exported a PST file in an Office 365 environment. It leverages Office 365 management activity logs, specifically filtering for events under ThreatManagement with the name &quot;eDiscovery search started or exported.&quot; This activity is significant as it may indicate data exfiltration attempts or unauthorized access to sensitive information.",Office 365 (Microsoft 365),"Collection, Discovery, Exfiltration",T1114,"`o365_management_activity` Category=ThreatManagement Name=""eDiscovery search started or exported"" 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime by Source Severity AlertEntityId Name user src vendor_account vendor_product dest signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_pst_export_alert_filter`"
O365 Safe Links Detection,"The following analytic detects when any Microsoft Safe Links alerting is triggered. This behavior may indicate when user has interacted with a phishing or otherwise malicious link within the Microsoft Office ecosystem.
Search 1`o365_management_activity` Name=&#34;*a potentially malicious URL*&#34; Operation=AlertEntityGenerated 2| fromjson Data 3| fillnull 4| stats count min(_time) as firstTime max(_time) as lastTime values(ObjectId) as url values(od) as desc by AlertId, trc, Name, ot, dest, vendor_account, vendor_product, src 5| rename Name as signature, AlertId as signature_id, trc as user, ot as action 6| eval action = CASE(action == &#34;Allowed&#34;, &#34;allowed&#34;, action==&#34;BlockPageOverride&#34;, &#34;allowed&#34;, true(),&#34;blocked&#34;) 7| `security_content_ctime(firstTime)` 8| `security_content_ctime(lastTime)` 9| `o365_safe_links_detection_filter` Data Source Name Platform Sourcetype Source Office 365 Universal Audit Log Other 'o365:management:activity' 'o365' Macros Used Name Value o365_management_activity sourcetype=o365:management:activity o365_safe_links_detection_filter search * o365_safe_links_detection_filter is an empty macro by default.",Office 365 (Microsoft 365),Initial Access,"T1566.001, T1566","`o365_management_activity` Name=""*a potentially malicious URL*"" Operation=AlertEntityGenerated 
| fromjson Data 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime values(ObjectId) as url values(od) as desc by AlertId, trc, Name, ot, dest, vendor_account, vendor_product, src 
| rename Name as signature, AlertId as signature_id, trc as user, ot as action 
| eval action = CASE(action == ""Allowed"", ""allowed"", action==""BlockPageOverride"", ""allowed"", true(),""blocked"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_safe_links_detection_filter`"
O365 Security And Compliance Alert Triggered,"The following analytic identifies alerts triggered by the Office 365 Security and Compliance Center, indicating potential threats or policy violations. It leverages data from the o365_management_activity dataset, focusing on events where the workload is SecurityComplianceCenter and the operation is AlertTriggered. This activity is significant as it highlights security and compliance issues within the O365 environment, which are crucial for maintaining organizational security.",Office 365 (Microsoft 365),"Exfiltration, Defense Evasion","T1078.004, T1078","`o365_management_activity` Workload=SecurityComplianceCenter Category=ThreatManagement Operation=AlertTriggered 
| spath input=Data path=f3u output=user 
| spath input=Data path=op output=operation 
| spath input=_raw path=wl 
| spath input=Data path=rid output=rule_id 
| spath input=Data path=ad output=alert_description 
| spath input=Data path=lon output=operation_name 
| spath input=Data path=an output=alert_name 
| spath input=Data path=sev output=severity 
| fillnull 
| stats count earliest(_time) as firstTime latest(_time) as lastTime by user, Name, rule_id, alert_description, alert_name, severity, dest, src, vendor_account, vendor_product, signature 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_security_and_compliance_alert_triggered_filter`"
O365 Service Principal New Client Credentials,"The following analytic detects the addition of new credentials for Service Principals within an Office 365 tenant. It uses O365 audit logs, focusing on events related to credential modifications or additions in the AzureActiveDirectory workload. This activity is significant because Service Principals represent application identities, and their credentials allow applications to authenticate and access resources.",Office 365 (Microsoft 365),"Persistence, Exfiltration","T1098.001, T1098","`o365_management_activity` Workload=AzureActiveDirectory Operation=""Update application*Certificates and secrets management "" 
| fillnull 
| stats earliest(_time) as firstTime latest(_time) as lastTime by user ModifiedProperties{}.NewValue object ObjectId dest signature src vendor_account vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_service_principal_new_client_credentials_filter`"
O365 SharePoint Allowed Domains Policy Changed,"The following analytic identifies when the allowed domain settings for O365 SharePoint have been changed. With Azure AD B2B collaboration, users and administrators can invite external users to collaborate with internal users. External guest account invitations may also need access to OneDrive/SharePoint resources. These changed should be monitored by security teams as they could potentially lead to unauthorized access.",Office 365 (Microsoft 365),Persistence,T1136.003,"`o365_management_activity` Workload=SharePoint Operation=SharingPolicyChanged ""ModifiedProperties{}.Name""=AllowDomainList 
| eval signature_id = CorrelationId, signature=Operation, src = ClientIP, user = UserId, object_name='ModifiedProperties{}.Name', object_attrs_new = split(replace('ModifiedProperties{}.NewValue',""\.\.\."",""""),"",""), object_attrs_old = split(replace('ModifiedProperties{}.OldValue',""\.\.\."",""""),"","") 
| fillnull 
| stats values(object_attrs_new) as object_attrs_new, values(object_attrs_old) as object_attrs_old, values(src) as src, count, min(_time) as firstTime, max(_time) as lastTime by user,signature,signature_id,object_name,dest,action,vendor_account,vendor_product 
| eval diff_add=mvmap(object_attrs_new,if(isnull(mvfind(object_attrs_old,object_attrs_new)),object_attrs_new,null)) 
| eval diff_remove=mvmap(object_attrs_old,if(isnull(mvfind(object_attrs_new,object_attrs_old)),object_attrs_old,null)) 
| eval result = case(isnotnull(diff_add),""Added "".mvjoin(diff_add,"",""),isnotnull(diff_remove),""Removed "".mvjoin(diff_remove,"","")), action = case(isnotnull(diff_add),""created"",isnotnull(diff_remove),""deleted"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_sharepoint_allowed_domains_policy_changed_filter`"
O365 Tenant Wide Admin Consent Granted,"The following analytic identifies instances where admin consent is granted to an application within an Azure AD and Office 365 tenant. It leverages O365 audit logs, specifically events related to the admin consent action within the AzureActiveDirectory workload. This activity is significant because admin consent allows applications to access data across the entire tenant, potentially exposing vast amounts of organizational data.",Office 365 (Microsoft 365),"Persistence, Exfiltration","T1098, T1098.003","`o365_management_activity` Operation=""Consent to application."" 
| eval new_field=mvindex('ModifiedProperties{}.NewValue', 4) 
| rex field=new_field ""ConsentType: (?<ConsentType>[^\,]+)"" 
| rex field=new_field ""Scope: (?<Scope>[^\,]+)"" 
| search ConsentType = ""AllPrincipals"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by user, object, ObjectId, ConsentType, Scope, dest, vendor_account, vendor_product, signature, src 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_tenant_wide_admin_consent_granted_filter`"
O365 User Consent Blocked for Risky Application,"The following analytic identifies instances where Office 365 has blocked a user's attempt to grant consent to an application deemed risky or potentially malicious. This detection leverages O365 audit logs, specifically focusing on failed user consent actions due to system-driven blocks. Monitoring these blocked consent attempts is crucial as it highlights potential threats early on, indicating that a user might be targeted or that malicious applications are attempting to infiltrate the organization.",Office 365 (Microsoft 365),Credential Access,T1528,"`o365_management_activity` Workload=AzureActiveDirectory Operation=""Consent to application."" ResultStatus=Failure 
| eval permissions =mvindex('ModifiedProperties{}.NewValue', 4) 
| eval reason =mvindex('ModifiedProperties{}.NewValue', 5) 
| search reason = ""Risky application detected"" 
| rex field=permissions ""Scope: (?<Scope>[^,]+)"" 
| fillnull 
| stats max(_time) as lastTime by user, reason, object, Scope, dest, src, vendor_account, vendor_product, signature 
| `security_content_ctime(lastTime)` 
| `o365_user_consent_blocked_for_risky_application_filter`"
O365 User Consent Denied for OAuth Application,"The following analytic identifies instances where a user has denied consent to an OAuth application seeking permissions within the Office 365 environment. This detection leverages O365 audit logs, focusing on events related to user consent actions. By filtering for denied consent actions associated with OAuth applications, it captures instances where users have actively rejected permission requests.",Office 365 (Microsoft 365),Credential Access,T1528,"`o365_graph` status.errorCode=65004 
| rename userPrincipalName as user 
| rename ipAddress as src_ip 
| stats min(_time) as firstTime max(_time) as lastTime by user src_ip appDisplayName status.failureReason 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `o365_user_consent_denied_for_oauth_application_filter`"
Active Directory Lateral Movement Identified,"The following analytic identifies potential lateral movement activities within an organization's Active Directory (AD) environment. It detects this activity by correlating multiple analytics from the Active Directory Lateral Movement analytic story within a specified time frame. This is significant for a SOC as lateral movement is a common tactic used by attackers to expand their access within a network, posing a substantial risk.",Splunk Risk Rule (Multiple Sources),Lateral Movement,T1210,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Active Directory Lateral Movement"" All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 4 
| `active_directory_lateral_movement_identified_filter`"
Active Setup Registry Autostart,"The following analytic detects suspicious modifications to the Active Setup registry for persistence and privilege escalation. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;StubPath&quot; value within the &quot;SOFTWARE\Microsoft\Active Setup\Installed Components&quot; path. This activity is significant as it is commonly used by malware, adware, and APTs to maintain persistence on compromised machines.",Windows Events,"Lateral Movement, Persistence, Privilege Escalation","T1547, T1547.014","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_value_name= ""StubPath"" Registry.registry_path = ""*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `active_setup_registry_autostart_filter`"
Allow Inbound Traffic By Firewall Rule Registry,"The following analytic detects suspicious modifications to firewall rule registry settings that allow inbound traffic on specific ports with a public profile. It leverages data from the Endpoint.Registry data model, focusing on registry paths and values indicative of such changes. This activity is significant as it may indicate an adversary attempting to grant remote access to a machine by modifying firewall rules.",Windows Events,"Lateral Movement, Exfiltration",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\FirewallRules\\*"" Registry.registry_value_data = ""*
|Action=Allow
|*"" Registry.registry_value_data = ""*
|Dir=In
|*""  Registry.registry_value_data = ""*
|LPort=*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `allow_inbound_traffic_by_firewall_rule_registry_filter`"
Anomalous usage of 7zip,"The following analytic detects the execution of 7z.exe, a 7-Zip utility, spawned from rundll32.exe or dllhost.exe. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process names and parent processes. This activity is significant as it may indicate an adversary attempting to use 7-Zip for data exfiltration, often by renaming the executable to evade detection.",Windows Events,"Collection, Execution, Credential Access, Exfiltration","T1560, T1560.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""rundll32.exe"", ""dllhost.exe"") Processes.process_name=*7z* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `anomalous_usage_of_7zip_filter`"
Batch File Write to System32,"The following analytic detects the creation of a batch file (.bat) within the Windows system directory tree, specifically in the System32 or SysWOW64 folders. It leverages data from the Endpoint datamodel, focusing on process and filesystem events to identify this behavior. This activity is significant because writing batch files to system directories can be indicative of malicious intent, such as persistence mechanisms or system manipulation.",Windows Events,"Execution, Persistence",T1204.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\system32\\*"",""*\\syswow64\\*"") Filesystem.file_name=""*.bat"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `batch_file_write_to_system32_filter`"
BCDEdit Failure Recovery Modification,"The following analytic detects modifications to the Windows error recovery boot configurations using bcdedit.exe with flags such as &quot;recoveryenabled&quot; and &quot;no&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant because ransomware often disables recovery options to prevent system restoration, making it crucial for SOC analysts to investigate.",Windows Events,"Execution, Impact, Persistence",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = bcdedit.exe Processes.process=""*recoveryenabled*"" (Processes.process=""* no*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `bcdedit_failure_recovery_modification_filter`"
BITS Job Persistence,"The following analytic detects the use of bitsadmin.exe to schedule a BITS job for persistence on an endpoint. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line parameters such as create, addfile, and resume. This activity is significant because BITS jobs can be used by attackers to maintain persistence, download malicious payloads, or exfiltrate data.",Windows Events,"Execution, Persistence, Defense Evasion",T1197,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_bitsadmin` Processes.process IN (*create*, *addfile*, *setnotifyflags*, *setnotifycmdline*, *setminretrydelay*, *setcustomheaders*, *resume* ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `bits_job_persistence_filter`"
Certutil exe certificate extraction,"The following analytic identifies the use of certutil.exe with arguments indicating the manipulation or extraction of certificates. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because extracting certificates can allow attackers to sign new authentication tokens, particularly in federated environments like Windows ADFS.",Windows Events,"Execution, Persistence, Privilege Escalation",,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process = ""*-exportPFX*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `certutil_exe_certificate_extraction_filter`"
Check Elevated CMD using whoami,"The following analytic identifies the execution of the &quot;whoami&quot; command with the &quot;/group&quot; flag, where the results are passed to the &quot;find&quot; command in order to look for a the string &quot;12288&quot;. This string represents the SID of the group &quot;Mandatory Label\High Mandatory Level&quot; effectively checking if the current process is running as a &quot;High&quot; integrity process or with Administrator privileges.",Windows Events,"Discovery, Execution, Persistence, Privilege Escalation",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process = ""*whoami*"" Processes.process = ""*/group*"" Processes.process = ""* find *"" Processes.process = ""*12288*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `check_elevated_cmd_using_whoami_filter`"
Child Processes of Spoolsv exe,The following analytic identifies child processes spawned by spoolsv.,Windows Events,"Execution, Privilege Escalation",T1068,"| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=spoolsv.exe AND Processes.process_name!=regsvr32.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `child_processes_of_spoolsv_exe_filter`"
Clop Common Exec Parameter,"The following analytic identifies the execution of CLOP ransomware variants using specific arguments (&quot;runrun&quot; or &quot;temp.dat&quot;) to trigger their malicious activities. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Monitoring this activity is crucial as it indicates potential ransomware behavior, which can lead to file encryption on network shares or local machines.",Windows Events,Execution,T1204,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name != ""*temp.dat*"" Processes.process = ""*runrun*"" OR Processes.process = ""*temp.dat*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `clop_common_exec_parameter_filter`"
CMLUA Or CMSTPLUA UAC Bypass,"The following analytic detects the use of COM objects like CMLUA or CMSTPLUA to bypass User Account Control (UAC). It leverages Sysmon EventCode 7 to identify the loading of specific DLLs (CMLUA.dll, CMSTPLUA.dll, CMLUAUTIL.dll) by processes not typically associated with these libraries. This activity is significant as it indicates an attempt to gain elevated privileges, a common tactic used by ransomware adversaries.",Windows Events,"Execution, Defense Evasion","T1218.003, T1218","`sysmon` EventCode=7  ImageLoaded IN (""*\\CMLUA.dll"", ""*\\CMSTPLUA.dll"", ""*\\CMLUAUTIL.dll"") NOT(process_name IN(""CMSTP.exe"", ""CMMGR32.exe"")) NOT(Image IN(""*\\windows\\*"", ""*\\program files*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `cmlua_or_cmstplua_uac_bypass_filter`"
ConnectWise ScreenConnect Path Traversal,"The following analytic detects attempts to exploit the ConnectWise ScreenConnect CVE-2024-1708 vulnerability, which allows path traversal attacks by manipulating file_path and file_name parameters in the URL. It leverages the Endpoint datamodel Filesystem node to identify suspicious file system events, specifically targeting paths and filenames associated with ScreenConnect. This activity is significant as it can lead to unauthorized access to sensitive files and directories, potentially resulting in data exfiltration or arbitrary code execution.",Windows Events,"Initial Access, Execution, Exfiltration",T1190,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\ScreenConnect\\App_Extensions\\*"") Filesystem.file_name IN (""*.aspx"",""*.ashx"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `connectwise_screenconnect_path_traversal_filter`"
ConnectWise ScreenConnect Path Traversal Windows SACL,"The following analytic detects attempts to exploit the ConnectWise ScreenConnect CVE-2024-1708 vulnerability using Windows SACL EventCode 4663. It identifies path traversal attacks by monitoring file system events related to the ScreenConnect service. This activity is significant as it allows unauthorized access to sensitive files and directories, potentially leading to data exfiltration or arbitrary code execution.",Windows Events,"Initial Access, Execution, Exfiltration",T1190,"`wineventlog_security` EventCode=4663  ProcessName=*\\ScreenConnect.Service.exe file_path IN (""*\\ScreenConnect\\App_Extensions\\*"") file_name IN (""*.aspx"",""*.ashx"") 
| stats count min(_time) as firstTime max(_time) as lastTime by  ObjectName ObjectType ProcessName AccessMask process_id EventCode Computer Caller_User_Name 
| rename Computer as dest Caller_User_Name as user ProcessName as process_name 
|  `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `connectwise_screenconnect_path_traversal_windows_sacl_filter`"
Control Loading from World Writable Directory,"The following analytic identifies instances of control.exe loading a .cpl or .inf file from a writable directory, which is related to CVE-2021-40444. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions mapped to the Processes node of the Endpoint data model. This activity is significant as it may indicate an attempt to exploit a known vulnerability, potentially leading to unauthorized code execution.",Windows Events,"Execution, Defense Evasion","T1218.002, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=control.exe OR Processes.original_file_name=CONTROL.EXE) AND Processes.process IN (""*\\appdata\\*"", ""*\\windows\\temp\\*"", ""*\\programdata\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `control_loading_from_world_writable_directory_filter`"
Create or delete windows shares using net exe,"The following analytic detects the creation or deletion of Windows shares using the net.exe command. It leverages Endpoint Detection and Response (EDR) data to identify processes involving net.exe with actions related to share management. This activity is significant because it may indicate an attacker attempting to manipulate network shares for malicious purposes, such as data exfiltration, malware distribution, or establishing persistence.",Windows Events,"Execution, Exfiltration, Persistence, Defense Evasion","T1070, T1070.005","| tstats `security_content_summariesonly` count values(Processes.user) as user values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| search process IN (""*share* /delete*"", ""*share* /REMARK:*"", ""*share* /CACHE:*"") 
| `create_or_delete_windows_shares_using_net_exe_filter`"
Creation of Shadow Copy,"The following analytic detects the creation of shadow copies using Vssadmin or Wmic. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because creating shadow copies can be a precursor to ransomware attacks or data exfiltration, allowing attackers to bypass file locks and access sensitive data.",Windows Events,"Execution, Credential Access, Persistence, Exfiltration",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=vssadmin.exe Processes.process=*create* Processes.process=*shadow*) OR (Processes.process_name=wmic.exe Processes.process=*shadowcopy* Processes.process=*create*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `creation_of_shadow_copy_filter`"
Creation of Shadow Copy with wmic and powershell,"The following analytic detects the creation of shadow copies using &quot;wmic&quot; or &quot;Powershell&quot; commands. It leverages the Endpoint.Processes data model in Splunk to identify processes where the command includes &quot;shadowcopy&quot; and &quot;create&quot;. This activity is significant because it may indicate an attacker attempting to manipulate or access data in an unauthorized manner, potentially leading to data theft or manipulation.",Windows Events,"Execution, Credential Access",T1003.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` OR `process_powershell` Processes.process=*shadowcopy* Processes.process=*create* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `creation_of_shadow_copy_with_wmic_and_powershell_filter`"
Deleting Shadow Copies,"The following analytic detects the deletion of shadow copies using the vssadmin.exe or wmic.exe utilities. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because deleting shadow copies is a common tactic used by attackers to prevent recovery and hide their tracks.",Windows Events,"Execution, Impact, Persistence",T1490,"| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=vssadmin.exe OR Processes.process_name=wmic.exe) Processes.process=*delete* Processes.process=*shadow* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `deleting_shadow_copies_filter`"
Detect AzureHound File Modifications,"The following analytic detects the creation of specific AzureHound-related files, such as *-azurecollection.zip and various .json files, on disk. It leverages data from the Endpoint.Filesystem datamodel, focusing on file creation events with specific filenames. This activity is significant because AzureHound is a tool used to gather information about Azure environments, similar to SharpHound for on-premises Active Directory.",Windows Events,"Collection, Discovery, Privilege Escalation","T1069.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*-azurecollection.zip"", ""*-azprivroleadminrights.json"", ""*-azglobaladminrights.json"", ""*-azcloudappadmins.json"", ""*-azapplicationadmins.json"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_azurehound_file_modifications_filter`"
Detect Baron Samedit CVE-2021-3156 Segfault,The following analytic identifies a heap-based buffer overflow in sudoedit by detecting Linux logs containing both &quot;sudoedit&quot; and &quot;segfault&quot; terms.,Linux,Privilege Escalation,T1068,"`linux_hosts` TERM(sudoedit) TERM(segfault) 
| stats count min(_time) as firstTime max(_time) as lastTime by host 
| where count > 5 
| `detect_baron_samedit_cve_2021_3156_segfault_filter`"
Detect Excessive Account Lockouts From Endpoint,"The following analytic detects endpoints causing a high number of account lockouts within a short period. It leverages the Windows security event logs ingested into the Change datamodel, specifically under the Account_Management node, to identify and count lockout events. This activity is significant as it may indicate a brute-force attack or misconfigured system causing repeated authentication failures.",Windows Events,Defense Evasion,T1078.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(All_Changes.user) as user from datamodel=Change.All_Changes where All_Changes.result=""*lock*"" by All_Changes.dest All_Changes.result 
|`drop_dm_object_name(""All_Changes"")` 
|`drop_dm_object_name(""Account_Management"")`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| search count > 5 
| `detect_excessive_account_lockouts_from_endpoint_filter`"
Detect Regasm Spawning a Process,"The following analytic detects regasm.exe spawning a child process. This behavior is identified using data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where regasm.exe is the parent process. This activity is significant because regasm.exe spawning a process is rare and can indicate an attempt to bypass application control mechanisms.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1218.009, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=regasm.exe NOT (Processes.process_name IN (""conhost.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_regasm_spawning_a_process_filter`"
Detect Regsvcs Spawning a Process,"The following analytic identifies regsvcs.exe spawning a child process. This behavior is detected using Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where the parent process is regsvcs.exe. This activity is significant because regsvcs.exe rarely spawns child processes, and such behavior can indicate an attempt to bypass application control mechanisms. If confirmed malicious, this could allow an attacker to execute arbitrary code, potentially leading to privilege escalation or persistent access within the environment.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1218.009, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=regsvcs.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_regsvcs_spawning_a_process_filter`"
Detect Regsvr32 Application Control Bypass,"The following analytic identifies the abuse of Regsvr32.exe to proxy execution of malicious code, specifically detecting the loading of &quot;scrobj.dll&quot; by Regsvr32.exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line executions. This activity is significant because Regsvr32.exe is a trusted, signed Microsoft binary, often used in &quot;Squiblydoo&quot; attacks to bypass application control mechanisms.",Windows Events,"Execution, Defense Evasion","T1218.010, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_regsvr32` Processes.process=*scrobj* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_regsvr32_application_control_bypass_filter`"
Detect Renamed PSExec,"The following analytic identifies instances where PsExec.exe has been renamed and executed on an endpoint. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names. This activity is significant because renaming PsExec.exe is a common tactic to evade detection. If confirmed malicious, this could allow an attacker to execute commands remotely, potentially leading to unauthorized access, lateral movement, or further compromise of the network.",Windows Events,"Lateral Movement, Execution",T1569.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name!=psexec.exe AND Processes.process_name!=psexec64.exe) AND Processes.original_file_name=psexec.c by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_renamed_psexec_filter`"
Detect Renamed RClone,"The following analytic detects the execution of a renamed rclone.exe process, which is commonly used for data exfiltration to remote destinations. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process names and original file names that do not match. This activity is significant because ransomware groups often use RClone to exfiltrate sensitive data.",Windows Events,"Execution, Exfiltration",T1020,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.original_file_name=rclone.exe AND Processes.process_name!=rclone.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_renamed_rclone_filter`"
Detect RTLO In Process,"The following analytic identifies the abuse of the right-to-left override (RTLO) character (U+202E) in process names. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line data. This activity is significant because adversaries use the RTLO character to disguise malicious files or commands, making them appear benign. If confirmed malicious, this technique can allow attackers to execute harmful code undetected, potentially leading to unauthorized access, data exfiltration, or further system compromise.",Windows Events,"Execution, Exfiltration, Defense Evasion","T1036, T1036.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process!=unknown AND Processes.action=allowed by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| regex process=""\\x{202E}"" 
| rex field=process ""(?<RTLO_command_1>.+)(?<RTLO_exist_process>\\x{202E})(?<RTLO_command_2>.+)"" 
| eval process_with_RTLO=process 
| eval process=RTLO_command_1.RTLO_command_2 
| fields - RTLO* 
| `detect_rtlo_in_process_filter`"
Detect SharpHound Command-Line Arguments,"The following analytic detects the execution of SharpHound command-line arguments, specifically -collectionMethod and invoke-bloodhound. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as SharpHound is commonly used for Active Directory enumeration, which can be a precursor to lateral movement or privilege escalation.",Windows Events,"Execution, Collection, Lateral Movement, Privilege Escalation, Discovery","T1069.001, T1059.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN (""*-collectionMethod*"",""*invoke-bloodhound*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_sharphound_command_line_arguments_filter`"
Detect SharpHound File Modifications,"The following analytic detects the creation of files typically associated with SharpHound, a reconnaissance tool used for gathering domain and trust data. It leverages file modification events from the Endpoint.Filesystem data model, focusing on default file naming patterns like *_BloodHound.zip and various JSON files. This activity is significant as it indicates potential domain enumeration, which is a precursor to more targeted attacks.",Windows Events,"Lateral Movement, Discovery, Privilege Escalation","T1069.001, T1059.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*bloodhound.zip"", ""*_computers.json"", ""*_gpos.json"", ""*_domains.json"", ""*_users.json"", ""*_groups.json"", ""*_ous.json"", ""*_containers.json"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_sharphound_file_modifications_filter`"
Detect SharpHound Usage,"The following analytic detects the usage of the SharpHound binary by identifying its original filename, SharpHound.exe, and the process name. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process metadata and command-line executions. SharpHound is a tool used for Active Directory enumeration, often by attackers during the reconnaissance phase.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069.001, T1059.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sharphound.exe OR Processes.original_file_name=SharpHound.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_sharphound_usage_filter`"
Detect suspicious processnames using pretrained model in DSDL,The following analytic identifies suspicious process names using a pre-trained Deep Learning model.,Windows Events,Execution,T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| rename process_name as text 
| fields text, parent_process_name, process, user, dest 
| apply detect_suspicious_processnames_using_pretrained_model_in_dsdl 
| rename predicted_label as is_suspicious_score 
| rename text as process_name 
| where is_suspicious_score > 0.5 
| `detect_suspicious_processnames_using_pretrained_model_in_dsdl_filter`"
Detect Use of cmd exe to Launch Script Interpreters,"The following analytic detects the execution of cscript.exe or wscript.exe processes initiated by cmd.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent processes within the Endpoint data model. This activity is significant as it may indicate script-based attacks or administrative actions that could be leveraged for malicious purposes.",Windows Events,"Execution, Persistence, Privilege Escalation","T1059, T1059.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=""cmd.exe"" (Processes.process_name=cscript.exe OR Processes.process_name =wscript.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)`
|`security_content_ctime(lastTime)` 
| `detect_use_of_cmd_exe_to_launch_script_interpreters_filter`"
Detection of tools built by NirSoft,The following analytic identifies the execution of tools built by NirSoft by detecting specific command-line arguments such as &quot;/stext&quot; and &quot;/scomma&quot;.,Windows Events,"Execution, Exfiltration",T1072,"| tstats `security_content_summariesonly` count min(_time) values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=""* /stext *"" OR Processes.process=""* /scomma *"" ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `detection_of_tools_built_by_nirsoft_filter`"
Disable AMSI Through Registry,"The following analytic detects modifications to the Windows registry that disable the Antimalware Scan Interface (AMSI) by setting the &quot;AmsiEnable&quot; value to &quot;0x00000000&quot;. This detection leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows Script\Settings\AmsiEnable&quot;. Disabling AMSI is significant as it is a common technique used by ransomware, Remote Access Trojans (RATs), and Advanced Persistent Threats (APTs) to evade detection and impair defenses.",Windows Events,"Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows Script\\Settings\\AmsiEnable"" Registry.registry_value_data = ""0x00000000"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_amsi_through_registry_filter`"
Disable Defender AntiVirus Registry,"The following analytic detects the modification of Windows Defender registry settings to disable antivirus and antispyware protections. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with Windows Defender policies. This activity is significant because disabling antivirus protections is a common tactic used by adversaries to evade detection and maintain persistence on compromised systems.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Policies\\Microsoft\\Windows Defender*"" Registry.registry_value_name IN (""DisableAntiSpyware"",""DisableAntiVirus"") Registry.registry_value_data = 0x00000001) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_antivirus_registry_filter`"
Disable Defender BlockAtFirstSeen Feature,"The following analytic detects the modification of the Windows registry to disable the Windows Defender BlockAtFirstSeen feature. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path associated with Windows Defender SpyNet and the DisableBlockAtFirstSeen value. This activity is significant because disabling this feature can allow malicious files to bypass initial detection by Windows Defender, increasing the risk of malware infection.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Microsoft\\Windows Defender\\SpyNet*"" Registry.registry_value_name = DisableBlockAtFirstSeen Registry.registry_value_data = 0x00000001) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_blockatfirstseen_feature_filter`"
Disable Defender MpEngine Registry,"The following analytic detects the modification of the Windows Defender MpEngine registry value, specifically setting MpEnablePus to 0x00000000. This detection leverages endpoint registry logs, focusing on changes within the path &quot;\Policies\Microsoft\Windows Defender\MpEngine&quot;. This activity is significant as it indicates an attempt to disable key Windows Defender features, potentially allowing malware to evade detection.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Policies\\Microsoft\\Windows Defender\\MpEngine*"" Registry.registry_value_name = MpEnablePus Registry.registry_value_data = 0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_mpengine_registry_filter`"
Disable Defender Spynet Reporting,"The following analytic detects the modification of the registry to disable Windows Defender SpyNet reporting. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path associated with Windows Defender SpyNet settings. This activity is significant because disabling SpyNet reporting can prevent Windows Defender from sending telemetry data, potentially allowing malicious activities to go undetected.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Microsoft\\Windows Defender\\SpyNet*"" Registry.registry_value_name = SpynetReporting Registry.registry_value_data = 0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_spynet_reporting_filter`"
Disable Defender Submit Samples Consent Feature,"The following analytic detects the modification of the Windows registry to disable the Windows Defender Submit Samples Consent feature. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path associated with Windows Defender SpyNet and the SubmitSamplesConsent value set to 0x00000000. This activity is significant as it indicates an attempt to bypass or evade detection by preventing Windows Defender from submitting samples for further analysis.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\Microsoft\\Windows Defender\\SpyNet*"" Registry.registry_value_name = SubmitSamplesConsent Registry.registry_value_data = 0x00000000) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_defender_submit_samples_consent_feature_filter`"
Disable ETW Through Registry,"The following analytic detects modifications to the registry that disable the Event Tracing for Windows (ETW) feature. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\.NETFramework\ETWEnabled&quot; with a value set to &quot;0x00000000&quot;. This activity is significant because disabling ETW can allow attackers to evade detection mechanisms, making it harder for security tools to monitor malicious activities.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\.NETFramework\\ETWEnabled"" Registry.registry_value_data = ""0x00000000"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_etw_through_registry_filter`"
Disable Logs Using WevtUtil,"The following analytic detects the execution of &quot;wevtutil.exe&quot; with parameters to disable event logs. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because disabling event logs is a common tactic used by ransomware to evade detection and hinder forensic investigations. If confirmed malicious, this action could allow attackers to operate undetected, making it difficult to trace their activities and respond effectively to the incident.",Windows Events,"Execution, Defense Evasion",T1070.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""wevtutil.exe"" AND (Processes.process = ""*sl*"" OR Processes.process = ""*set-log*"" ) Processes.process = ""*/e:false*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_logs_using_wevtutil_filter`"
Disable Registry Tool,"The following analytic detects modifications to the Windows registry aimed at disabling the Registry Editor (regedit). It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\DisableRegistryTools&quot; with a value of &quot;0x00000001&quot;. This activity is significant because malware, such as RATs or trojans, often disable registry tools to prevent the removal of their entries, aiding in persistence and defense evasion.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableRegistryTools"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_registry_tool_filter`"
Disable Schedule Task,"The following analytic detects the execution of a command to disable an existing scheduled task using 'schtasks.exe' with the '/change' and '/disable' parameters. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Disabling scheduled tasks is significant as it is a common tactic used by adversaries, including malware like IcedID, to disable security applications and evade detection.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe Processes.process=*/change*  Processes.process=*/disable* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_schedule_task_filter`"
Disable UAC Remote Restriction,"The following analytic detects the modification of the registry to disable UAC remote restriction by setting the &quot;LocalAccountTokenFilterPolicy&quot; value to &quot;0x00000001&quot;. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;\CurrentVersion\Policies\System&quot;. This activity is significant because disabling UAC remote restriction can allow an attacker to bypass User Account Control (UAC) protections, potentially leading to privilege escalation.",Windows Events,"Privilege Escalation, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\CurrentVersion\\Policies\\System*"" Registry.registry_value_name=""LocalAccountTokenFilterPolicy"" Registry.registry_value_data=""0x00000001""  ) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_uac_remote_restriction_filter`"
Disable Windows SmartScreen Protection,"The following analytic detects modifications to the Windows registry that disable SmartScreen protection. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with SmartScreen settings. This activity is significant because SmartScreen provides an early warning system against phishing and malware. Disabling it can indicate malicious intent, often seen in Remote Access Trojans (RATs) to evade detection while downloading additional payloads.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path IN (""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\SmartScreenEnabled"", ""*\\Microsoft\\Windows\\System\\EnableSmartScreen"") Registry.registry_value_data  IN (""Off"", ""0"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disable_windows_smartscreen_protection_filter`"
Disabling CMD Application,"The following analytic detects modifications to the registry that disable the CMD prompt application. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the &quot;DisableCMD&quot; registry value. This activity is significant because disabling CMD can hinder an analyst's ability to investigate and remediate threats, a tactic often used by malware such as RATs, Trojans, or Worms.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\DisableCMD"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_cmd_application_filter`"
Disabling ControlPanel,"The following analytic detects registry modifications that disable the Control Panel on Windows systems. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\NoControlPanel&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it is commonly used by malware to prevent users from accessing the Control Panel, thereby hindering the removal of malicious artifacts and persistence mechanisms.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoControlPanel"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_controlpanel_filter`"
Disabling Defender Services,"The following analytic detects the disabling of Windows Defender services by monitoring registry modifications. It leverages registry event data to identify changes to specific registry paths associated with Defender services, where the 'Start' value is set to '0x00000004'. This activity is significant because disabling Defender services can indicate an attempt by an adversary to evade detection and maintain persistence on the endpoint.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path = ""*\\System\\CurrentControlSet\\Services\\*"" AND (Registry.registry_path IN(""*WdBoot*"", ""*WdFilter*"", ""*WdNisDrv*"", ""*WdNisSvc*"",""*WinDefend*"", ""*SecurityHealthService*"")) AND Registry.registry_value_name = Start Registry.registry_value_data = 0x00000004) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_defender_services_filter`"
Disabling Firewall with Netsh,"The following analytic identifies the disabling of the firewall using the netsh application. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include keywords like &quot;firewall,&quot; &quot;off,&quot; or &quot;disable.&quot; This activity is significant because disabling the firewall can expose the system to external threats, allowing malware to communicate with its command and control (C2) server.",Windows Events,"Command And Control, Execution, Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` Processes.process= ""*firewall*"" (Processes.process= ""*off*"" OR  Processes.process= ""*disable*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_firewall_with_netsh_filter`"
Disabling FolderOptions Windows Feature,"The following analytic detects the modification of the Windows registry to disable the Folder Options feature, which prevents users from showing hidden files and file extensions. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\NoFolderOptions&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it is commonly used by malware to conceal malicious files and deceive users with fake file extensions.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoFolderOptions"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_folderoptions_windows_feature_filter`"
Disabling NoRun Windows App,"The following analytic detects the modification of the Windows registry to disable the Run application in the Start menu. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\NoRun&quot; with a value of &quot;0x00000001&quot;. This activity is significant because the Run application is a useful shortcut for executing known applications and scripts.",Windows Events,"Persistence, Defense Evasion","T1562.001, T1112","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoRun"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_norun_windows_app_filter`"
Disabling Remote User Account Control,"The following analytic identifies modifications to the registry key that controls the enforcement of Windows User Account Control (UAC). It detects changes to the registry path HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA where the value is set to 0x00000000. This activity is significant because disabling UAC can allow unauthorized changes to the system without user consent, potentially leading to privilege escalation.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path=*\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA* Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `disabling_remote_user_account_control_filter`"
Disabling SystemRestore In Registry,"The following analytic detects the modification of registry keys to disable System Restore on a machine. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with System Restore settings. This activity is significant because disabling System Restore can hinder recovery efforts and is a tactic often used by Remote Access Trojans (RATs) to maintain persistence on an infected system.",Windows Events,"Persistence, Impact, Defense Evasion",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\\DisableSR"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\\DisableConfig"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\\DisableSR"" OR Registry.registry_path= ""*\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\\DisableConfig"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)`
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_systemrestore_in_registry_filter`"
Disabling Task Manager,"The following analytic identifies modifications to the Windows registry that disable Task Manager. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\DisableTaskMgr&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it is commonly associated with malware such as RATs, Trojans, and worms, which disable Task Manager to prevent users from terminating malicious processes.",Windows Events,"Persistence, Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableTaskMgr"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `disabling_task_manager_filter`"
DNS Exfiltration Using Nslookup App,"The following analytic identifies potential DNS exfiltration using the nslookup application. It detects specific command-line parameters such as query type (TXT, A, AAAA) and retry options, which are commonly used by attackers to exfiltrate data. The detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process execution logs. This activity is significant as it may indicate an attempt to communicate with a Command and Control (C2) server or exfiltrate sensitive data.",Windows Events,"Command And Control, Execution, Discovery, Exfiltration",T1048,"| tstats `security_content_summariesonly` values(Processes.process) as process values(Processes.process_id) as process_id values(Processes.parent_process) as parent_process count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""nslookup.exe"" Processes.process = ""*-querytype=*"" OR Processes.process=""*-qt=*"" OR Processes.process=""*-q=*"" OR Processes.process=""*-type=*"" OR Processes.process=""*-retry=*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `dns_exfiltration_using_nslookup_app_filter`"
Domain Controller Discovery with Wmic,"The following analytic identifies the execution of wmic.exe with command-line arguments used to discover domain controllers in a Windows domain. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because it is commonly used by adversaries and Red Teams for situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""wmic.exe"") (Processes.process="""" OR Processes.process=""*DomainControllerAddress*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_controller_discovery_with_wmic_filter`"
Domain Group Discovery With Wmic,"The following analytic identifies the execution of wmic.exe with command-line arguments used to query for domain groups. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to gain situational awareness and map out Active Directory structures.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=*/NAMESPACE:\\\\root\\directory\\ldap* AND Processes.process=*ds_group* AND Processes.process=""*GET ds_samaccountname*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `domain_group_discovery_with_wmic_filter`"
DSQuery Domain Discovery,"The following analytic detects the execution of &quot;dsquery.exe&quot; with arguments targeting TrustedDomain queries directly from the command line. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process names and command-line arguments. This activity is significant as it often indicates domain trust discovery, a common step in lateral movement or privilege escalation by adversaries.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1482,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=dsquery.exe Processes.process=*trustedDomain* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `dsquery_domain_discovery_filter`"
Elevated Group Discovery With Wmic,The following analytic detects the execution of wmic.exe with command-line arguments querying specific elevated domain groups. It leverages Endpoint Detection and Response (EDR) telemetry to identify processes that access the LDAP namespace and search for groups like &quot;Domain Admins&quot; or &quot;Enterprise Admins.&quot; This activity is significant as it indicates potential reconnaissance efforts by adversaries to identify high-privilege accounts within Active Directory.,Windows Events,"Discovery, Execution, Privilege Escalation","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""wmic.exe"") (Processes.process=*/NAMESPACE:\\\\root\\directory\\ldap*) (Processes.process=""*Domain Admins*"" OR Processes.process=""*Enterprise Admins*"" OR Processes.process=""*Schema Admins*"" OR Processes.process=""*Account Operators*"" OR Processes.process=""*Server Operators*"" OR Processes.process=""*Protected Users*"" OR Processes.process=""*Dns Admins*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `elevated_group_discovery_with_wmic_filter`"
Eventvwr UAC Bypass,"The following analytic detects an Eventvwr UAC bypass by identifying suspicious registry modifications in the path that Eventvwr.msc references upon execution. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry changes and process execution details. This activity is significant because it indicates a potential privilege escalation attempt, allowing an attacker to execute arbitrary commands with elevated privileges.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1548, T1548.002","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*mscfile\\shell\\open\\command\\*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `eventvwr_uac_bypass_filter`"
Excessive distinct processes from Windows Temp,"The following analytic identifies an excessive number of distinct processes executing from the Windows\Temp directory. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process paths and counts within a 20-minute window. This behavior is significant as it often indicates the presence of post-exploit frameworks like Koadic and Meterpreter, which use this technique to execute malicious actions.",Windows Events,"Execution, Persistence",T1059,"| tstats `security_content_summariesonly` distinct_count(Processes.process) as distinct_process_count min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product from datamodel=Endpoint.Processes where Processes.process_path = ""*\\Windows\\Temp\\*"" by Processes.dest Processes.user _time span=20m 
|  where distinct_process_count > 37 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_distinct_processes_from_windows_temp_filter`"
Excessive File Deletion In WinDefender Folder,"The following analytic detects excessive file deletion events in the Windows Defender folder. It leverages Sysmon EventCodes 23 and 26 to identify processes deleting multiple files within this directory. This behavior is significant as it may indicate an attempt to corrupt or disable Windows Defender, a key security component. If confirmed malicious, this activity could allow an attacker to disable endpoint protection, facilitating further malicious actions without detection.",Windows Events,"Execution, Impact",T1485,"`sysmon` EventCode IN (""23"",""26"") TargetFilename = ""*\\ProgramData\\Microsoft\\Windows Defender\\*"" 
| stats count min(_time) as firstTime, max(_time) as lastTime values(file_path) as file_path values(file_hash) as file_hash values(file_name) as file_name values(file_modify_time) as file_modify_time values(process_name) as process_name values(process_path) as process_path values(process_guid) as process_guid values(process_id) as process_id values(process_exec) as process_exec by action dest dvc signature signature_id user user_id vendor_product 
| where count >=50 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_file_deletion_in_windefender_folder_filter`"
Excessive number of service control start as disabled,"The following analytic detects an excessive number of sc.exe processes launched with the command line argument start= disabled within a short period. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line executions, and process GUIDs. This activity is significant as it may indicate an attempt to disable critical services, potentially impairing system defenses.",Windows Events,"Execution, Defense Evasion","T1562.001, T1562","| tstats `security_content_summariesonly` distinct_count(Processes.process) as distinct_cmdlines values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes WHERE Processes.process_name = ""sc.exe"" AND Processes.process=""*start= disabled*"" by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.parent_process_id, _time span=30m 
| where distinct_cmdlines >= 8 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_number_of_service_control_start_as_disabled_filter`"
Excessive number of taskhost processes,"The following analytic identifies an excessive number of taskhost.exe and taskhostex.exe processes running within a short time frame. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and their counts. This behavior is significant as it is commonly associated with post-exploitation tools like Meterpreter and Koadic, which use multiple instances of these processes for actions such as discovery and lateral movement.",Windows Events,"Lateral Movement, Execution, Discovery",T1059,"| tstats `security_content_summariesonly` values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process) as parent_process values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.user) as user values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes WHERE Processes.process_name = ""taskhost.exe"" OR Processes.process_name = ""taskhostex.exe"" BY Processes.dest Processes.process_name _time span=1h 
| `drop_dm_object_name(Processes)` 
| eval pid_count=mvcount(process_id) 
| eval taskhost_count_=if(process_name == ""taskhost.exe"", pid_count, 0) 
| eval taskhostex_count_=if(process_name == ""taskhostex.exe"", pid_count, 0) 
| stats sum(taskhost_count_) as taskhost_count, sum(taskhostex_count_) as taskhostex_count values(action) as action values(original_file_name) as original_file_name values(parent_process) as parent_process values(parent_process_exec) as parent_process_exec values(parent_process_guid) as parent_process_guid values(parent_process_id) as parent_process_id values(parent_process_name) as parent_process_name values(parent_process_path) as parent_process_path values(process) as process values(process_exec) as process_exec values(process_guid) as process_guid values(process_hash) as process_hash values(process_id) as process_id values(process_integrity_level) as process_integrity_level values(user) as user values(process_path) as process_path values(user_id) as user_id values(vendor_product) as vendor_product values(process_name) as process_name by _time, dest, firstTime, lastTime 
| where taskhost_count > 10 or taskhostex_count > 10 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_number_of_taskhost_processes_filter`"
Excessive Usage Of SC Service Utility,"The following analytic detects excessive usage of the sc.exe service utility on a host machine. It leverages Sysmon EventCode 1 logs to identify instances where sc.exe is executed more frequently than normal within a 15-minute window. This behavior is significant as it is commonly associated with ransomware, cryptocurrency miners, and other malware attempting to create, modify, delete, or disable services, potentially related to security applications or for privilege escalation.",Windows Events,"Execution, Privilege Escalation",T1569.002,"| tstats `security_content_summariesonly` count as numScExe min(_time) as firstTime max(_time) as lastTime values(Processes.action) as action values(Processes.original_file_name) as original_file_name values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_path) as parent_process_path values(Processes.process) as process values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_path) as process_path values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product values(Processes.parent_process) as parent_process values(Processes.process_name) as process_name values(Processes.parent_process_id) as parent_process_id values(Processes.user) as user from datamodel=Endpoint.Processes where Processes.process_name = ""sc.exe"" by Processes.dest _time span=15m 
| `drop_dm_object_name(Processes)` 
| eventstats avg(numScExe) as avgScExe, stdev(numScExe) as stdScExe, count as numSlots by dest 
| eval upperThreshold=(avgScExe + stdScExe *3) 
| eval isOutlier=if(avgScExe > 5 and avgScExe >= upperThreshold, 1, 0) 
| search isOutlier=1 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `excessive_usage_of_sc_service_utility_filter`"
Exchange PowerShell Abuse via SSRF,The following analytic detects suspicious behavior indicative of ProxyShell exploitation against on-premise Microsoft Exchange servers.,Windows Events,"Initial Access, Privilege Escalation","T1190, T1133","`windows_exchange_iis` c_uri=""*//autodiscover*"" cs_uri_query=""*PowerShell*"" cs_method=""POST"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, cs_uri_query, cs_method, c_uri 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `exchange_powershell_abuse_via_ssrf_filter`"
Executable File Written in Administrative SMB Share,"The following analytic detects executable files (.exe or .dll) being written to Windows administrative SMB shares (Admin$, IPC$, C$). It leverages Windows Security Event Logs with EventCode 5145 to identify this activity. This behavior is significant as it is commonly used by tools like PsExec/PaExec for staging binaries before creating and starting services on remote endpoints, a technique often employed for lateral movement and remote code execution.",Windows Events,"Lateral Movement, Execution","T1021.002, T1021","`wineventlog_security` EventCode=5145 RelativeTargetName IN (""*.exe"",""*.dll"") ObjectType=File ShareName IN (""\\\\*\\C$"",""\\\\*\\IPC$"",""\\\\*\\admin$"") AccessMask= ""0x2"" 
| stats min(_time) as firstTime max(_time) as lastTime count by EventCode ShareName RelativeTargetName ObjectType AccessMask src_user src_port IpAddress dest 
| `security_content_ctime(firstTime)`  
| `executable_file_written_in_administrative_smb_share_filter`"
Firewall Allowed Program Enable,"The following analytic detects the modification of a firewall rule to allow the execution of a specific application. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events with command-line arguments related to firewall rule changes. This activity is significant as it may indicate an attempt to bypass firewall restrictions, potentially allowing unauthorized applications to communicate over the network.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*firewall*"" Processes.process = ""*allow*"" Processes.process = ""*add*"" Processes.process = ""*ENABLE*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `firewall_allowed_program_enable_filter`"
First Time Seen Running Windows Service,The following analytic detects the first occurrence of a Windows service running in your environment.,Windows Events,"Execution, Persistence",T1569.002,"`wineventlog_system` EventCode=7036 
| rex field=Message ""The (?<service>[-\(\)\s\w]+) service entered the (?<state>\w+) state"" 
| where state=""running"" 
| lookup previously_seen_running_windows_services service as service OUTPUT firstTimeSeen 
| where isnull(firstTimeSeen) OR firstTimeSeen > relative_time(now(), `previously_seen_windows_services_window`) 
| table _time dest service 
| `first_time_seen_running_windows_service_filter`"
FodHelper UAC Bypass,"The following analytic detects the execution of fodhelper.exe, which is known to exploit a User Account Control (UAC) bypass by leveraging specific registry keys. The detection method uses Endpoint Detection and Response (EDR) telemetry to identify when fodhelper.exe spawns a child process and accesses the registry keys. This activity is significant because it indicates a potential privilege escalation attempt by an attacker.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1548, T1112, T1548.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=fodhelper.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `fodhelper_uac_bypass_filter`"
Get ADDefaultDomainPasswordPolicy with Powershell,"The following analytic detects the execution of powershell.exe running the Get-ADDefaultDomainPasswordPolicy cmdlet, which is used to retrieve the password policy in a Windows domain. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. Monitoring this activity is crucial as it can indicate attempts by adversaries to gather information about domain policies for situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery",T1201,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-ADDefaultDomainPasswordPolicy*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_addefaultdomainpasswordpolicy_with_powershell_filter`"
Get ADDefaultDomainPasswordPolicy with Powershell Script Block,"The following analytic detects the execution of the Get-ADDefaultDomainPasswordPolicy PowerShell cmdlet, which is used to retrieve the password policy in a Windows domain. This detection leverages PowerShell Script Block Logging (EventCode=4104) to identify the specific command execution. Monitoring this activity is significant as it can indicate an attempt to gather domain policy information, which is often a precursor to further malicious actions.",Windows Events,"Execution, Discovery",T1201,"`powershell` EventCode=4104 ScriptBlockText =""*Get-ADDefaultDomainPasswordPolicy*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
|  `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_addefaultdomainpasswordpolicy_with_powershell_script_block_filter`"
Get ADUser with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments used to enumerate domain users via the Get-ADUser cmdlet. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an attempt by adversaries to gather information about domain users for situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery","T1087.002, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-ADUser*"" AND Processes.process = ""*-filter*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_aduser_with_powershell_filter`"
Get ADUser with PowerShell Script Block,"The following analytic detects the execution of the Get-AdUser PowerShell cmdlet, which is used to enumerate all domain users. It leverages PowerShell Script Block Logging (EventCode=4104) to identify instances where this command is executed with a filter. This activity is significant as it may indicate an attempt by adversaries or Red Teams to gather information about domain users for situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery","T1087.002, T1087","`powershell` EventCode=4104 ScriptBlockText = ""*get-aduser*"" ScriptBlockText = ""*-filter*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_aduser_with_powershell_script_block_filter`"
Get ADUserResultantPasswordPolicy with Powershell,"The following analytic detects the execution of powershell.exe running the Get-ADUserResultantPasswordPolicy cmdlet, which is used to obtain the password policy in a Windows domain. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential enumeration of domain policies, a common tactic for situational awareness and Active Directory discovery by adversaries.",Windows Events,"Execution, Discovery",T1201,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-ADUserResultantPasswordPolicy*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_aduserresultantpasswordpolicy_with_powershell_filter`"
Get ADUserResultantPasswordPolicy with Powershell Script Block,"The following analytic detects the execution of the Get-ADUserResultantPasswordPolicy PowerShell cmdlet, which is used to obtain the password policy in a Windows domain. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity. Monitoring this behavior is significant as it may indicate an attempt to enumerate domain policies, a common tactic used by adversaries for situational awareness and Active Directory discovery.",Windows Events,"Execution, Discovery",T1201,"`powershell` EventCode=4104 ScriptBlockText=""*Get-ADUserResultantPasswordPolicy*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_aduserresultantpasswordpolicy_with_powershell_script_block_filter`"
Get DomainPolicy with Powershell,"The following analytic detects the execution of powershell.exe running the Get-DomainPolicy cmdlet, which is used to retrieve password policies in a Windows domain. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to gather domain policy information, which is crucial for planning further attacks.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1201,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-DomainPolicy*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domainpolicy_with_powershell_filter`"
Get DomainPolicy with Powershell Script Block,"The following analytic detects the execution of the Get-DomainPolicy cmdlet using PowerShell Script Block Logging (EventCode=4104). It leverages logs capturing script block text to identify attempts to obtain the password policy in a Windows domain. This activity is significant as it indicates potential reconnaissance efforts by adversaries or Red Teams to gather domain policy information, which is crucial for planning further attacks.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1201,"`powershell` EventCode=4104 ScriptBlockText =""*Get-DomainPolicy*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domainpolicy_with_powershell_script_block_filter`"
Get-DomainTrust with PowerShell,"The following analytic identifies the execution of the Get-DomainTrust command from PowerView using PowerShell, which is used to gather domain trust information. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. This activity is significant as it indicates potential reconnaissance efforts by an adversary to understand domain trust relationships, which can inform lateral movement strategies.",Windows Events,"Lateral Movement, Execution, Discovery",T1482,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=*get-domaintrust* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domaintrust_with_powershell_filter`"
Get DomainUser with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments used to enumerate domain users via the Get-DomainUser command. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions mapped to the Processes node of the Endpoint data model. This activity is significant as it indicates potential reconnaissance efforts by adversaries or Red Teams using PowerView for Active Directory discovery.",Windows Events,"Execution, Discovery",T1087.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*Get-DomainUser*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domainuser_with_powershell_filter`"
Get DomainUser with PowerShell Script Block,"The following analytic detects the execution of the Get-DomainUser cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet is part of PowerView, a tool often used for domain enumeration. The detection leverages PowerShell operational logs to identify instances where this command is executed. Monitoring this activity is crucial as it may indicate an adversary's attempt to gather information about domain users, which is a common step in Active Directory Discovery.",Windows Events,"Execution, Discovery",T1087.002,"`powershell` EventCode=4104 ScriptBlockText = ""*Get-DomainUser*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_domainuser_with_powershell_script_block_filter`"
Get-ForestTrust with PowerShell,"The following analytic detects the execution of the Get-ForestTrust command via PowerShell, commonly used by adversaries to gather domain trust information. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. Identifying this activity is crucial as it indicates potential reconnaissance efforts to map out domain trusts, which can inform further attacks.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1482,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe OR Processes.process_name=cmd.exe Processes.process=*get-foresttrust* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `get_foresttrust_with_powershell_filter`"
Get WMIObject Group Discovery,"The following analytic detects the use of the Get-WMIObject Win32_Group command executed via PowerShell to enumerate local groups on an endpoint. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. Identifying local groups can be a precursor to privilege escalation or lateral movement. If confirmed malicious, this activity could allow an attacker to map out group memberships, aiding in further exploitation or unauthorized access to sensitive resources.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069, T1069.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=powershell.exe OR processes.process_name=cmd.exe) (Processes.process=""*Get-WMIObject*"" AND Processes.process=""*Win32_Group*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`  
| `get_wmiobject_group_discovery_filter`"
GetAdComputer with PowerShell,"The following analytic detects the execution of powershell.exe with the Get-AdComputer commandlet, which is used to discover remote systems within a domain. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because it indicates potential reconnaissance efforts by adversaries to map out domain computers, which is a common step in the attack lifecycle.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-AdComputer*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getadcomputer_with_powershell_filter`"
GetAdGroup with PowerShell,"The following analytic detects the execution of powershell.exe with the Get-AdGroup commandlet, which is used to query domain groups in a Windows Domain. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Monitoring this activity is crucial as it may indicate an adversary or Red Team enumerating domain groups for situational awareness and Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-AdGroup*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getadgroup_with_powershell_filter`"
GetCurrent User with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments invoking the GetCurrent method of the WindowsIdentity .NET class. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries may use this method to identify the logged-in user on a compromised endpoint, aiding in situational awareness and Active Directory discovery.",Windows Events,"Lateral Movement, Execution, Discovery",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*System.Security.Principal.WindowsIdentity* OR Processes.process=*GetCurrent()*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getcurrent_user_with_powershell_filter`"
GetDomainComputer with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments that utilize Get-DomainComputer to discover remote systems. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as Get-DomainComputer is part of PowerView, a tool often used by adversaries for domain enumeration and situational awareness.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-DomainComputer*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getdomaincomputer_with_powershell_filter`"
GetDomainController with PowerShell,"The following analytic detects the execution of powershell.exe with the Get-DomainController command, which is used to discover remote systems within a Windows domain. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Monitoring this activity is crucial as it may indicate an attempt to enumerate domain controllers, a common tactic in Active Directory discovery.",Windows Events,"Lateral Movement, Execution, Discovery",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-DomainController*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getdomaincontroller_with_powershell_filter`"
GetDomainGroup with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments that query for domain groups using Get-DomainGroup. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions mapped to the Processes node of the Endpoint data model. Monitoring this activity is crucial as Get-DomainGroup is part of PowerView, a tool often used by adversaries for domain enumeration and situational awareness.",Windows Events,"Discovery, Execution, Privilege Escalation","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-DomainGroup*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getdomaingroup_with_powershell_filter`"
GetLocalUser with PowerShell,"The following analytic detects the execution of powershell.exe with the Get-LocalUser commandlet, which is used to query local user accounts. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Monitoring this activity is significant because adversaries and Red Teams may use it to enumerate local users for situational awareness and Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation","T1087.001, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-LocalUser*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getlocaluser_with_powershell_filter`"
GetNetTcpconnection with PowerShell,"The following analytic identifies the execution of powershell.exe with the Get-NetTcpConnection command, which lists current TCP connections on a system. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. Monitoring this activity is significant as it may indicate an adversary or Red Team performing network reconnaissance or situational awareness.",Windows Events,"Lateral Movement, Execution, Discovery",T1049,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-NetTcpConnection*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getnettcpconnection_with_powershell_filter`"
GetWmiObject Ds Computer with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments that utilize the Get-WmiObject cmdlet to discover remote systems, specifically targeting the DS_Computer parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate domain computers and gather situational awareness within Active Directory.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-WmiObject* AND Processes.process=""*namespace root\\directory\\ldap*"" AND Processes.process=""*class ds_computer*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_ds_computer_with_powershell_filter`"
GetWmiObject Ds Group with PowerShell,"The following analytic identifies the execution of powershell.exe with command-line arguments used to query domain groups via the Get-WmiObject cmdlet and the -class ds_group parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate domain groups, which is a common step in Active Directory Discovery.",Windows Events,"Discovery, Execution, Privilege Escalation","T1069.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-WmiObject* AND Processes.process=""*namespace root\\directory\\ldap*"" AND Processes.process=""*class ds_group*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_ds_group_with_powershell_filter`"
GetWmiObject DS User with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments used to query domain users via the Get-WmiObject cmdlet and -class ds_user parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate domain users, which is a common step in Active Directory Discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1087.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""cmd.exe"" OR Processes.process_name=""powershell*"") AND Processes.process = ""*get-wmiobject*"" AND Processes.process = ""*ds_user*"" AND Processes.process = ""*root\\directory\\ldap*"" AND Processes.process = ""*-namespace*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_ds_user_with_powershell_filter`"
GetWmiObject DS User with PowerShell Script Block,The following analytic detects the execution of the Get-WmiObject cmdlet with the DS_User class parameter via PowerShell Script Block Logging (EventCode=4104). It leverages logs to identify attempts to query all domain users using WMI. This activity is significant as it may indicate an adversary or Red Team operation attempting to enumerate domain users for situational awareness and Active Directory discovery.,Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1087.002,"`powershell` EventCode=4104 ScriptBlockText = ""*get-wmiobject*"" ScriptBlockText = ""*ds_user*"" ScriptBlockText = ""*-namespace*"" ScriptBlockText = ""*root\\directory\\ldap*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_ds_user_with_powershell_script_block_filter`"
GetWmiObject User Account with PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments that utilize the Get-WmiObject cmdlet and the Win32_UserAccount parameter to query local user accounts. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an attempt by adversaries to enumerate user accounts for situational awareness or Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.001, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=*Get-WmiObject* AND Processes.process=*Win32_UserAccount*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `getwmiobject_user_account_with_powershell_filter`"
Hunting 3CXDesktopApp Software,"The following analytic detects the presence of any version of the 3CXDesktopApp, also known as the 3CX Desktop App, on Mac or Windows systems. It leverages the Endpoint data model's Processes node to identify instances of the application running, although it does not provide file version information. This activity is significant because 3CX has identified vulnerabilities in versions 18.",Windows Events,"Initial Access, Execution, Exfiltration",T1195.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=3CXDesktopApp.exe OR Processes.process_name=""3CX Desktop App"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `hunting_3cxdesktopapp_software_filter`"
Impacket Lateral Movement smbexec CommandLine Parameters,"The following analytic identifies suspicious command-line parameters associated with the use of Impacket's smbexec.py for lateral movement. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns indicative of Impacket tool usage. This activity is significant as both Red Teams and adversaries use Impacket for remote code execution and lateral movement.",Windows Events,"Lateral Movement, Execution, Persistence, Exfiltration","T1021.002, T1543.003, T1053, T1021.003, T1047, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| where match(process, ""(?i)cmd\.exe\s+\/Q\s+\/c"") AND match(process,""(?i)echo\s+cd"") AND match(process, ""(?i)\\__output"") AND  match(process, ""(?i)C:\\\\Windows\\\\[a-zA-Z]{1,8}\\.bat"")  AND match(process, ""\\\\127\.0\.0\.1\\.*"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `impacket_lateral_movement_smbexec_commandline_parameters_filter`"
Java Writing JSP File,"The following analytic detects the Java process writing a .jsp file to disk, which may indicate a web shell being deployed. It leverages data from the Endpoint datamodel, specifically monitoring process and filesystem activities. This activity is significant because web shells can provide attackers with remote control over the compromised server, leading to further exploitation.",Windows Events,"Initial Access, Execution, Exfiltration","T1190, T1133","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name IN (""java"",""java.exe"", ""javaw.exe"") by _time Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| join process_guid [
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.file_name=""*.jsp*"" by _time Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| fields _time process_guid file_path file_name file_create_time user dest process_name] 
| stats count min(_time) as firstTime max(_time) as lastTime by dest process_name process_guid file_name file_path file_create_time user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `java_writing_jsp_file_filter`"
Kerberoasting spn request with RC4 encryption,"The following analytic detects potential Kerberoasting attacks by identifying Kerberos service ticket requests with RC4 encryption through Event ID 4769. It leverages specific Ticket_Options values commonly used by Kerberoasting tools. This activity is significant as Kerberoasting allows attackers to request service tickets for domain accounts, typically service accounts, and crack them offline to gain privileged access.",Windows Events,"Execution, Credential Access, Privilege Escalation","T1208, T1558.003","`wineventlog_security` EventCode=4769 ServiceName!=""*$"" (TicketOptions=0x40810000 OR TicketOptions=0x40800000 OR TicketOptions=0x40810010) TicketEncryptionType=0x17 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, user, service_id, service, TicketEncryptionType, TicketOptions 
| rename Computer as dest 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `kerberoasting_spn_request_with_rc4_encryption_filter`"
Kerberos User Enumeration,"The following analytic detects an unusual number of Kerberos Ticket Granting Ticket (TGT) requests for non-existing users from a single source endpoint. It leverages Event ID 4768 and identifies anomalies using the 3-sigma statistical rule. This behavior is significant as it may indicate an adversary performing a user enumeration attack against Active Directory. If confirmed malicious, the attacker could validate a list of usernames, potentially leading to further attacks such as brute force or credential stuffing, compromising the security of the environment.",Windows Events,,"T1589.002, T1589","`wineventlog_security` EventCode=4768 Status=0x6 TargetUserName!=""*$"" 
| bucket span=2m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest by _time, src_ip 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by src_ip 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1
| `kerberos_user_enumeration_filter`"
Linux Add Files In Known Crontab Directories,"The following analytic detects unauthorized file creation in known crontab directories on Unix-based systems. It leverages filesystem data to identify new files in directories such as /etc/cron* and /var/spool/cron/*. This activity is significant as it may indicate an attempt by threat actors or malware to establish persistence on a compromised host. If confirmed malicious, this could allow attackers to execute arbitrary code at scheduled intervals, potentially leading to further system compromise and unauthorized access to sensitive information.",Linux,"Execution, Persistence, Privilege Escalation",T1053.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/etc/cron*"", ""*/var/spool/cron/*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_add_files_in_known_crontab_directories_filter`"
Linux Add User Account,"The following analytic detects the creation of new user accounts on Linux systems using commands like &quot;useradd&quot; or &quot;adduser.&quot; It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries often create new user accounts to establish persistence on compromised hosts.",Linux,"Execution, Persistence, Privilege Escalation",T1136.001,"| tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Processes.process_name IN (""useradd"", ""adduser"") OR Processes.process IN (""*useradd *"", ""*adduser *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_add_user_account_filter`"
Linux APT Privilege Escalation,"The following analytic detects the use of the Advanced Package Tool (APT) with elevated privileges via sudo on Linux systems. It leverages Endpoint Detection and Response (EDR) telemetry to identify processes where APT commands are executed with sudo rights. This activity is significant because it indicates a user can run system commands as root, potentially leading to unauthorized root shell access.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*apt*"" AND Processes.process=""*APT::Update::Pre-Invoke::*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_apt_privilege_escalation_filter`"
Linux At Allow Config File Creation,The following analytic detects the creation of the /etc/at.allow or /etc/at.deny configuration files in Linux. It leverages file creation events from the Endpoint datamodel to identify when these files are created. This activity is significant as these files control user permissions for the &quot;at&quot; scheduling application and can be abused by attackers to establish persistence.,Linux,"Execution, Persistence, Privilege Escalation",T1053.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/etc/at.allow"", ""*/etc/at.deny"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_at_allow_config_file_creation_filter`"
Linux At Application Execution,"The following analytic detects the execution of the &quot;At&quot; application in Linux, which can be used by attackers to create persistence entries on a compromised host. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent process names associated with &quot;at&quot; or &quot;atd&quot;. This activity is significant because the &quot;At&quot; application can be exploited to maintain unauthorized access or deliver additional malicious payloads.",Linux,"Execution, Persistence, Privilege Escalation","T1053.002, T1053","| tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where  Processes.process_name IN (""at"", ""atd"") OR Processes.parent_process_name IN (""at"", ""atd"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_at_application_execution_filter`"
Linux Auditd Add User Account,"The following analytic detects the creation of new user accounts on Linux systems using commands like &quot;useradd&quot; or &quot;adduser.&quot; It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries often create new user accounts to establish persistence on compromised hosts. If confirmed malicious, this could allow attackers to maintain access, escalate privileges, and further compromise the system, posing a severe security risk.",Linux,"Execution, Persistence, Privilege Escalation",T1136.001,"`linux_auditd` proctitle IN (""*useradd*"", ""*adduser*"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`linux_auditd_add_user_account_filter`"
Linux Auditd At Application Execution,"The following analytic detects the execution of the &quot;At&quot; application in Linux, which can be used by attackers to create persistence entries on a compromised host. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and parent process names associated with &quot;at&quot; or &quot;atd&quot;. This activity is significant because the &quot;At&quot; application can be exploited to maintain unauthorized access or deliver additional malicious payloads.",Linux,"Execution, Persistence, Privilege Escalation","T1053.002, T1053","`linux_auditd` type=SYSCALL comm IN (""at"", ""atd"") OR exe IN (""/usr/bin/at"",""/usr/bin/atd"") AND NOT (uid IN (""daemon"")) 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_at_application_execution_filter`"
Linux Auditd Base64 Decode Files,"The following analytic detects suspicious Base64 decode operations that may indicate malicious activity, such as data exfiltration or execution of encoded commands. Base64 is commonly used to encode data for safe transmission, but attackers may abuse it to conceal malicious payloads. This detection focuses on identifying unusual or unexpected Base64 decoding processes, particularly when associated with critical files or directories.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Exfiltration",T1140,"`linux_auditd` execve_command = ""*base64*"" AND execve_command IN (""*-d*"", ""* --d*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`linux_auditd_base64_decode_files_filter`"
Linux Auditd Change File Owner To Root,"The following analytic detects the use of the 'chown' command to change a file owner to 'root' on a Linux system. It leverages Linux Auditd telemetry, specifically monitoring command-line executions and process details. This activity is significant as it may indicate an attempt to escalate privileges by adversaries, malware, or red teamers. If confirmed malicious, this action could allow an attacker to gain root-level access, leading to full control over the compromised host and potential persistence within the environment.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1222.002,"`linux_auditd` proctitle = ""*chown *root*"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_change_file_owner_to_root_filter`"
Linux Auditd Clipboard Data Copy,"The following analytic detects the use of the Linux 'xclip' command to copy data from the clipboard. It leverages Linux Auditd telemetry, focusing on process names and command-line arguments related to clipboard operations. This activity is significant because adversaries can exploit clipboard data to capture sensitive information such as passwords or IP addresses. If confirmed malicious, this technique could lead to unauthorized data exfiltration, compromising sensitive information and potentially aiding further attacks within the environment.",Linux,"Collection, Execution, Exfiltration",T1115,"`linux_auditd` execve_command IN (""*xclip*"", ""*clipboard*"") AND execve_command IN (""*-o*"", ""*-selection *"", ""*-sel *"" ) 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_clipboard_data_copy_filter`"
Linux Auditd Data Transfer Size Limits Via Split Syscall,"The following analytic detects suspicious data transfer activities that involve the use of the split syscall, potentially indicating an attempt to evade detection by breaking large files into smaller parts. Attackers may use this technique to bypass size-based security controls, facilitating the covert exfiltration of sensitive data. By monitoring for unusual or unauthorized use of the split syscall, this analytic helps identify potential data exfiltration attempts, allowing security teams to intervene and prevent the unauthorized transfer of critical information from the network.",Linux,"Execution, Persistence, Privilege Escalation, Discovery, Exfiltration",T1030,"`linux_auditd` type=SYSCALL comm=split OR exe= ""*/split"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_data_transfer_size_limits_via_split_syscall_filter`"
Linux Auditd Database File And Directory Discovery,"The following analytic detects suspicious database file and directory discovery activities, which may signal an attacker attempt to locate and assess critical database assets on a compromised system. This behavior is often a precursor to data theft, unauthorized access, or privilege escalation, as attackers seek to identify valuable information stored in databases. By monitoring for unusual or unauthorized attempts to locate database files and directories, this analytic aids in early detection of potential reconnaissance or data breach efforts, enabling security teams to respond swiftly and mitigate the risk of further compromise.",Linux,"Discovery, Execution, Persistence, Privilege Escalation",T1083,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"") AND execve_command IN(""*.db*"", ""*.sql*"", ""*.sqlite*"", ""*.mdb*"", ""*.accdb*"", ""*.mdf*"", ""*.ndf*"", ""*.ldf*"", ""*.frm*"", ""*.myd*"", ""*.myi*"", ""*.dbf*"", ""*.db2*"", ""*.dbc*"", ""*.fpt*"", ""*.ora*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_database_file_and_directory_discovery_filter`"
Linux Auditd Dd File Overwrite,"The following analytic detects the use of the 'dd' command to overwrite files on a Linux system. It leverages data from Linux Auditd telemetry, focusing on process execution logs that include command-line details. This activity is significant because adversaries often use the 'dd' command to destroy or irreversibly overwrite files, disrupting system availability and services.",Linux,"Execution, Impact, Discovery",T1485,"`linux_auditd` proctitle = ""*dd *"" AND proctitle = ""*of=*"" AND proctitle = ""*if=/dev/zero*"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
|`linux_auditd_dd_file_overwrite_filter`"
Linux Auditd Doas Tool Execution,"The following analytic detects the execution of the 'doas' tool on a Linux host. This tool allows standard users to perform tasks with root privileges, similar to 'sudo'. The detection leverages data from Linux Auditd, focusing on process names and command-line executions. This activity is significant as 'doas' can be exploited by adversaries to gain elevated privileges on a compromised host.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"`linux_auditd` type=SYSCALL comm=doas 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_doas_tool_execution_filter`"
Linux Auditd Edit Cron Table Parameter,"The following analytic detects the suspicious editing of cron jobs in Linux using the crontab command-line parameter (-e). It identifies this activity by monitoring command-line executions involving 'crontab' and the edit parameter. This behavior is significant for a SOC as cron job manipulations can indicate unauthorized persistence attempts or scheduled malicious actions. If confirmed malicious, this activity could lead to system compromise, unauthorized access, or broader network compromise.",Linux,"Discovery, Execution, Persistence, Privilege Escalation","T1053, T1053.003","`linux_auditd` type=SYSCALL syscall IN (""rename"", ""execve"") (comm IN (""crontab"") OR exe IN (""*/crontab"")) success=yes AND NOT (UID IN(""daemon"")) 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_edit_cron_table_parameter_filter`"
Linux Auditd File And Directory Discovery,"The following analytic detects suspicious file and directory discovery activities, which may indicate an attacker's effort to locate sensitive documents and files on a compromised system. This behavior often precedes data exfiltration, as adversaries seek to identify valuable or confidential information for theft. By identifying unusual or unauthorized attempts to browse or enumerate files and directories, this analytic helps security teams detect potential reconnaissance or preparatory actions by an attacker, enabling timely intervention to prevent data breaches or unauthorized access.",Linux,"Execution, Persistence, Privilege Escalation, Discovery, Exfiltration",T1083,"`linux_auditd`  execve_command IN (""*grep*"", ""*find*"") AND execve_command IN (""*.tif*"", ""*.tiff*"", ""*.gif*"", ""*.jpeg*"", ""*.jpg*"", ""*.jif*"", ""*.jfif*"", ""*.jp2*"", ""*.jpx*"", ""*.j2k*"", ""*.j2c*"", ""*.fpx*"", ""*.pcd*"", ""*.png*"", ""*.flv*"", ""*.pdf*"", ""*.mp4*"", ""*.mp3*"", ""*.gifv*"", ""*.avi*"", ""*.mov*"", ""*.mpeg*"", ""*.wav*"", ""*.doc*"", ""*.docx*"", ""*.xls*"", ""*.xlsx*"", ""*.svg*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_file_and_directory_discovery_filter`"
Linux Auditd File Permission Modification Via Chmod,"The following analytic detects suspicious file permission modifications using the chmod command, which may indicate an attacker attempting to alter access controls on critical files or directories. Such modifications can be used to grant unauthorized users elevated privileges or to conceal malicious activities by restricting legitimate access. By monitoring for unusual or unauthorized chmod usage, this analytic helps identify potential security breaches, allowing security teams to respond promptly to prevent privilege escalation, data tampering, or other unauthorized actions on the system.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery",T1222.002,"`linux_auditd` proctitle=""*chmod*"" AND proctitle IN (""* 777 *"", ""* 755 *"", ""*+*x*"", ""* 754 *"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_file_permission_modification_via_chmod_filter`"
Linux Auditd File Permissions Modification Via Chattr,"The following analytic detects suspicious file permissions modifications using the chattr command, which may indicate an attacker attempting to manipulate file attributes to evade detection or prevent alteration. The chattr command can be used to make files immutable or restrict deletion, which can be leveraged to protect malicious files or disrupt system operations. By monitoring for unusual or unauthorized chattr usage, this analytic helps identify potential tampering with critical files, enabling security teams to quickly respond to and mitigate threats associated with unauthorized file attribute changes.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1222.002,"`linux_auditd` proctitle = ""*chattr *"" AND proctitle = ""* -i*"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|`linux_auditd_file_permissions_modification_via_chattr_filter`"
Linux Auditd Hidden Files And Directories Creation,"The following analytic detects suspicious creation of hidden files and directories, which may indicate an attacker's attempt to conceal malicious activities or unauthorized data. Hidden files and directories are often used to evade detection by security tools and administrators, providing a stealthy means for storing malware, logs, or sensitive information. By monitoring for unusual or unauthorized creation of hidden files and directories, this analytic helps identify potential attempts to hide or unauthorized creation of hidden files and directories, this analytic helps identify potential attempts to hide malicious operations, enabling security teams to uncover and address hidden threats effectively.",Linux,"Discovery, Execution, Persistence, Privilege Escalation",T1083,"`linux_auditd` execve_command IN (""*touch *"", ""*mkdir *"", ""*vim *"", ""*vi *"", ""*nano *"") AND execve_command IN (""* ./.*"", ""* .*"", ""*/.*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_hidden_files_and_directories_creation_filter`"
Linux Auditd Insert Kernel Module Using Insmod Utility,"The following analytic detects the insertion of a Linux kernel module using the insmod utility. It leverages data from Linux Auditd, focusing on process execution logs that include process names and command-line details. This activity is significant as it may indicate the installation of a rootkit or malicious kernel module, potentially allowing an attacker to gain elevated privileges and bypass security detections.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"`linux_auditd` type=SYSCALL comm=insmod 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_insert_kernel_module_using_insmod_utility_filter`"
Linux Auditd Kernel Module Enumeration,"The following analytic identifies the use of the 'kmod' process to list kernel modules on a Linux system. This detection leverages data from Linux Auditd, focusing on process names and command-line executions. While listing kernel modules is not inherently malicious, it can be a precursor to loading unauthorized modules using 'insmod'. If confirmed malicious, this activity could allow an attacker to load kernel modules, potentially leading to privilege escalation, persistence, or other malicious actions within the system.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery","T1014, T1082","`linux_auditd` type=SYSCALL comm=lsmod 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_kernel_module_enumeration_filter`"
Linux Auditd Kernel Module Using Rmmod Utility,"The following analytic detects suspicious use of the rmmod utility for kernel module removal, which may indicate an attacker attempt to unload critical or security-related kernel modules. The rmmod command is used to remove modules from the Linux kernel, and unauthorized use can be a tactic to disable security features, conceal malicious activities, or disrupt system operations.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"`linux_auditd` type=SYSCALL comm=rmmod 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid success dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_kernel_module_using_rmmod_utility_filter`"
Linux Auditd Nopasswd Entry In Sudoers File,"The following analytic detects the addition of NOPASSWD entries to the /etc/sudoers file on Linux systems. It leverages Linux Auditd data to identify command lines containing &quot;NOPASSWD:&quot;. This activity is significant because it allows users to execute commands with elevated privileges without requiring a password, which can be exploited by adversaries to maintain persistent, privileged access.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"`linux_auditd` proctitle = ""*NOPASSWD*"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `linux_auditd_nopasswd_entry_in_sudoers_file_filter`"
Linux Auditd Possible Access To Credential Files,"The following analytic detects attempts to access or dump the contents of /etc/passwd and /etc/shadow files on Linux systems. It leverages data from Linux Auditd, focusing on processes like 'cat', 'nano', 'vim', and 'vi' accessing these files. This activity is significant as it may indicate credential dumping, a technique used by adversaries to gain persistence or escalate privileges.",Linux,"Execution, Credential Access, Persistence, Privilege Escalation","T1003, T1003.008","`linux_auditd`  proctitle IN (""*shadow*"", ""*passwd*"") AND proctitle IN (""*cat *"", ""*nano *"", ""*vim *"", ""*vi *"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by proctitle  dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_possible_access_to_credential_files_filter`"
Linux Auditd Preload Hijack Library Calls,"The following analytic detects the use of the LD_PRELOAD environment variable to hijack or hook library functions on a Linux platform. It leverages data from Linux Auditd, focusing on process execution logs that include command-line details. This activity is significant because adversaries, malware authors, and red teamers commonly use this technique to gain elevated privileges and establish persistence on a compromised machine.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1574.006,"`linux_auditd` execve_command = ""*LD_PRELOAD*"" 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `linux_auditd_preload_hijack_library_calls_filter`"
Linux Auditd Private Keys and Certificate Enumeration,"The following analytic detects suspicious attempts to find private keys, which may indicate an attacker's effort to access sensitive cryptographic information. Private keys are crucial for securing encrypted communications and data, and unauthorized access to them can lead to severe security breaches, including data decryption and identity theft. By monitoring for unusual or unauthorized searches for private keys, this analytic helps identify potential threats to cryptographic security, enabling security teams to take swift action to protect the integrity and confidentiality of encrypted information.",Linux,"Execution, Credential Access, Persistence, Privilege Escalation",T1552.004,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"") AND execve_command IN (""*.pem*"", ""*.cer*"", ""*.crt*"", ""*.pgp*"", ""*.key*"", ""*.gpg*"", ""*.ppk*"", ""*.p12*"", ""*.pfx*"", ""*.p7b*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_private_keys_and_certificate_enumeration_filter`"
Linux Auditd Service Restarted,"The following analytic detects the restarting or re-enabling of services on Linux systems using the systemctl or service commands. It leverages data from Linux Auditd, focusing on process and command-line execution logs. This activity is significant as adversaries may use it to maintain persistence or execute unauthorized actions. If confirmed malicious, this behavior could lead to repeated execution of malicious payloads, unauthorized access, or data destruction.",Linux,"Execution, Persistence, Privilege Escalation","T1543, T1053.006","`linux_auditd`  proctitle IN (""*systemctl *"", ""*service *"") AND proctitle IN (""*restart*"", ""*reenable*"", ""*reload*"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle  dest 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `linux_auditd_service_restarted_filter`"
Linux Auditd Setuid Using Chmod Utility,"The following analytic detects the execution of the chmod utility to set the SUID or SGID bit on files, which can allow users to temporarily gain root or group-level access. This detection leverages data from Linux Auditd, focusing on process names and command-line arguments related to chmod. This activity is significant as it can indicate an attempt to escalate privileges or maintain persistence on a system.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.001,"`linux_auditd`  proctitle IN (""*chmod *"")  AND proctitle IN (""* u+s *"", ""* g+s *"", ""* 4777 *"", ""* 4577 *"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle  dest 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `linux_auditd_setuid_using_chmod_utility_filter`"
Linux Auditd Setuid Using Setcap Utility,"The following analytic detects the execution of the 'setcap' utility to enable the SUID bit on Linux systems. It leverages Linux Auditd data, focusing on process names and command-line arguments that indicate the use of 'setcap' with specific capabilities. This activity is significant because setting the SUID bit allows a user to temporarily gain root access, posing a substantial security risk.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.001,"`linux_auditd` execve_command IN (""*setcap *"")  AND execve_command IN (""*cap_setuid+ep*"", ""*cap_setuid=ep*"", ""*cap_net_bind_service+p*"", ""*cap_net_raw+ep*"", ""*cap_dac_read_search+ep*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_setuid_using_setcap_utility_filter`"
Linux Auditd Shred Overwrite Command,"The following analytic detects the execution of the 'shred' command on a Linux machine, which is used to overwrite files to make them unrecoverable. It leverages data from Linux Auditd, focusing on process names and command-line arguments. This activity is significant because the 'shred' command can be used in destructive attacks, such as those seen in the Industroyer2 malware targeting energy facilities.",Linux,"Execution, Impact, Persistence, Privilege Escalation",T1485,"`linux_auditd`  proctitle IN (""*shred*"")  AND proctitle IN (""*-n*"", ""*-z*"", ""*-u*"", ""*-s*"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle  dest 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `linux_auditd_shred_overwrite_command_filter`"
Linux Auditd Sudo Or Su Execution,"The following analytic detects the execution of the &quot;sudo&quot; or &quot;su&quot; command on a Linux operating system. It leverages data from Linux Auditd, focusing on process names and parent process names. This activity is significant because &quot;sudo&quot; and &quot;su&quot; commands are commonly used by adversaries to elevate privileges, potentially leading to unauthorized access or control over the system.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery, Exfiltration","T1548.003, T1548","`linux_auditd`  proctitle IN (""*sudo *"", ""*su *"") 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by  proctitle  dest 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `linux_auditd_sudo_or_su_execution_filter`"
Linux Auditd System Network Configuration Discovery,"The following analytic detects suspicious system network configuration discovery activities, which may indicate an adversary's attempt to gather information about the network environment. Such actions typically involve commands or tools used to identify network interfaces, routing tables, and active connections. Detecting these activities is crucial, as they often precede more targeted attacks like lateral movement or data exfiltration.",Linux,"Execution, Lateral Movement, Persistence, Privilege Escalation, Discovery, Exfiltration",T1016,"`linux_auditd` type=SYSCALL comm IN (""arp"", ""ifconfig"", ""ip"", ""netstat"", ""firewall-cmd"", ""ufw"", ""iptables"", ""ss"", ""route"") 
| bucket _time span=15m 
| rename host as dest 
| stats dc(comm) as unique_commands, values(comm) as comm, values(exe) as exe, values(syscall) as syscall, values(uid) as uid, values(ppid) as ppid, values(pid) as pid, count, min(_time) as firstTime, max(_time) as lastTime by success dest 
| where unique_commands >= 4 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_system_network_configuration_discovery_filter`"
Linux Auditd Unload Module Via Modprobe,"The following analytic detects suspicious use of the modprobe command to unload kernel modules, which may indicate an attempt to disable critical system components or evade detection. The modprobe utility manages kernel modules, and unauthorized unloading of modules can disrupt system security features, remove logging capabilities, or conceal malicious activities. By monitoring for unusual or unauthorized modprobe operations involving module unloading, this analytic helps identify potential tampering with kernel functionality, enabling security teams to investigate and address possible threats to system integrity.",Linux,"Discovery, Execution, Persistence, Privilege Escalation",T1547.006,"`linux_auditd` execve_command = ""*modprobe*"" AND execve_command = ""*-r *"" 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `linux_auditd_unload_module_via_modprobe_filter`"
Linux Auditd Virtual Disk File And Directory Discovery,"The following analytic detects suspicious discovery of virtual disk files and directories, which may indicate an attacker's attempt to locate and access virtualized storage environments. Virtual disks can contain sensitive data or critical system configurations, and unauthorized discovery attempts could signify preparatory actions for data exfiltration or further compromise. By monitoring for unusual or unauthorized searches for virtual disk files and directories, this analytic helps identify potential reconnaissance activities, enabling security teams to respond promptly and safeguard against unauthorized access and data breaches.",Linux,"Execution, Persistence, Privilege Escalation, Discovery, Exfiltration",T1083,"`linux_auditd` execve_command IN (""*find*"", ""*grep*"")  AND execve_command IN (""*.vhd*"", ""*.vhdx*"", ""*.vmdk*"") 
| rename host as dest 
| rename comm as process_name 
| rename exe as process 
| stats count min(_time) as firstTime max(_time) as lastTime by argc execve_command dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `linux_auditd_virtual_disk_file_and_directory_discovery_filter`"
Linux Auditd Whoami User Discovery,"The following analytic detects the suspicious use of the whoami command, which may indicate an attacker trying to gather information about the current user account on a compromised system. The whoami command is commonly used to verify user privileges and identity, especially during initial stages of an attack to assess the level of access.",Linux,"Discovery, Execution, Persistence, Privilege Escalation",T1033,"`linux_auditd` type=SYSCALL comm=whoami OR exe= ""*/whoami"" 
| rename host as dest 
| stats count min(_time) as firstTime max(_time) as lastTime by comm exe  syscall uid ppid pid dest success 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_auditd_whoami_user_discovery_filter`"
Linux AWK Privilege Escalation,"The following analytic detects the use of the AWK command with elevated privileges to execute system commands. It leverages Endpoint Detection and Response (EDR) telemetry, specifically monitoring processes that include &quot;sudo,&quot; &quot;awk,&quot; and &quot;BEGIN*system&quot; in their command lines. This activity is significant because it indicates a potential privilege escalation attempt, where a user could gain root access by executing commands as the root user.",Linux,"Discovery, Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*sudo*"" AND Processes.process=""*awk*""  AND Processes.process=""*BEGIN*system*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_awk_privilege_escalation_filter`"
Linux Busybox Privilege Escalation,"The following analytic detects the execution of BusyBox with sudo privileges, which can lead to privilege escalation on Linux systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where BusyBox is executed with both 'sh' and 'sudo' commands. This activity is significant because it indicates a user may be attempting to gain root access, bypassing standard security controls.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*busybox*"" AND Processes.process=""*sh*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_busybox_privilege_escalation_filter`"
Linux c89 Privilege Escalation,"The following analytic detects the execution of the 'c89' command with elevated privileges, which can be used to compile and execute C programs as root. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events that include command-line arguments. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute arbitrary commands as root.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*c89*"" AND Processes.process=""*-wrapper*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_c89_privilege_escalation_filter`"
Linux c99 Privilege Escalation,"The following analytic detects the execution of the c99 utility with sudo privileges, which can lead to privilege escalation on Linux systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a potential misuse of the c99 utility to gain root access, which is critical for maintaining system security.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*c99*"" AND Processes.process=""*-wrapper*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_c99_privilege_escalation_filter`"
Linux Change File Owner To Root,"The following analytic detects the use of the 'chown' command to change a file owner to 'root' on a Linux system. It leverages Endpoint Detection and Response (EDR) telemetry, specifically monitoring command-line executions and process details. This activity is significant as it may indicate an attempt to escalate privileges by adversaries, malware, or red teamers.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1222.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = chown OR Processes.process = ""*chown *"") AND Processes.process = ""* root *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_change_file_owner_to_root_filter`"
Linux Clipboard Data Copy,"The following analytic detects the use of the Linux 'xclip' command to copy data from the clipboard. It leverages Endpoint Detection and Response (EDR) telemetry, focusing on process names and command-line arguments related to clipboard operations. This activity is significant because adversaries can exploit clipboard data to capture sensitive information such as passwords or IP addresses.",Linux,"Collection, Execution, Exfiltration",T1115,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=xclip Processes.process IN (""*-o *"", ""*-sel *"", ""*-selection *"", ""*clip *"",""*clipboard*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_clipboard_data_copy_filter`"
Linux Common Process For Elevation Control,"The following analytic identifies the execution of common Linux processes used for elevation control, such as chmod, chown, and setuid. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because these processes are often abused by adversaries to gain persistence or escalate privileges on compromised hosts.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1548, T1548.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""chmod"", ""chown"", ""fchmod"", ""fchmodat"", ""fchown"", ""fchownat"", ""fremovexattr"", ""fsetxattr"", ""lchown"", ""lremovexattr"", ""lsetxattr"", ""removexattr"", ""setuid"", ""setgid"", ""setreuid"", ""setregid"", ""chattr"") OR Processes.process IN (""*chmod *"", ""*chown *"", ""*fchmod *"", ""*fchmodat *"", ""*fchown *"", ""*fchownat *"", ""*fremovexattr *"", ""*fsetxattr *"", ""*lchown *"", ""*lremovexattr *"", ""*lsetxattr *"", ""*removexattr *"", ""*setuid *"", ""*setgid *"", ""*setreuid *"", ""*setregid *"", ""*setcap *"", ""*chattr *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_common_process_for_elevation_control_filter`"
Linux Composer Privilege Escalation,"The following analytic detects the execution of the Composer tool with elevated privileges on a Linux system. It identifies instances where Composer is run with the 'sudo' command, allowing the user to execute system commands as root. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*composer*"" AND Processes.process=""*run-script*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_composer_privilege_escalation_filter`"
Linux Cpulimit Privilege Escalation,"The following analytic detects the use of the 'cpulimit' command with specific flags ('-l', '-f') executed with 'sudo' privileges. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments and execution details. This activity is significant because if 'cpulimit' is granted sudo rights, a user can potentially execute system commands as root, leading to privilege escalation.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*cpulimit*"" AND Processes.process=""*-l*"" AND Processes.process=""*-f*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_cpulimit_privilege_escalation_filter`"
Linux Csvtool Privilege Escalation,"The following analytic detects the execution of the 'csvtool' command with 'sudo' privileges, which can allow a user to run system commands as root. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a potential privilege escalation attempt, where a user could gain unauthorized root access.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*csvtool*"" AND Processes.process=""*call*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_csvtool_privilege_escalation_filter`"
Linux DD File Overwrite,"The following analytic detects the use of the 'dd' command to overwrite files on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because adversaries often use the 'dd' command to destroy or irreversibly overwrite files, disrupting system availability and services.",Linux,"Execution, Impact, Privilege Escalation",T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""dd"" AND Processes.process = ""*of=*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_dd_file_overwrite_filter`"
Linux Deleting Critical Directory Using RM Command,"The following analytic detects the deletion of critical directories on a Linux machine using the rm command with argument rf. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions targeting directories like /boot, /var/log, /etc, and /dev. This activity is significant because deleting these directories can severely disrupt system operations and is often associated with destructive campaigns like Industroyer2.",Linux,"Execution, Impact",T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name =rm AND Processes.process= ""* -rf *"" AND Processes.process IN (""*/boot/*"", ""*/var/log/*"", ""*/etc/*"", ""*/dev/*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_deleting_critical_directory_using_rm_command_filter`"
Linux Deletion Of Cron Jobs,"The following analytic detects the deletion of cron jobs on a Linux machine. It leverages filesystem event logs to identify when files within the &quot;/etc/cron.*&quot; directory are deleted. This activity is significant because attackers or malware may delete cron jobs to disable scheduled security tasks or evade detection mechanisms. If confirmed malicious, this action could allow an attacker to disrupt system operations, evade security measures, or facilitate further malicious activities such as data wiping, as seen with the acidrain malware.",Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path=""/etc/cron.*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_deletion_of_cron_jobs_filter`"
Linux Deletion Of Init Daemon Script,"The following analytic detects the deletion of init daemon scripts on a Linux machine. It leverages filesystem event logs to identify when files within the /etc/init.d/ directory are deleted. This activity is significant because init daemon scripts control the start and stop of critical services, and their deletion can indicate an attempt to impair security features or evade defenses.",Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path IN ( ""/etc/init.d/*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_deletion_of_init_daemon_script_filter`"
Linux Deletion Of Services,"The following analytic detects the deletion of services on a Linux machine. It leverages filesystem event logs to identify when service files within system directories (e.g., /etc/systemd/, /lib/systemd/, /run/systemd/) are deleted. This activity is significant because attackers may delete or modify services to disable security features or evade defenses. If confirmed malicious, this behavior could indicate an attempt to impair system functionality or execute a destructive payload, potentially leading to system instability or data loss.",Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path IN ( ""/etc/systemd/*"", ""*/lib/systemd/*"", ""*/run/systemd/*"") Filesystem.file_path = ""*.service"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_deletion_of_services_filter`"
Linux Deletion of SSL Certificate,The following analytic detects the deletion of SSL certificates on a Linux machine. It leverages filesystem event logs to identify when files with extensions .pem or .crt are deleted from the /etc/ssl/certs/ directory. This activity is significant because attackers may delete or modify SSL certificates to disable security features or evade defenses on a compromised system.,Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path = ""/etc/ssl/certs/*"" Filesystem.file_path IN (""*.pem"", ""*.crt"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `linux_deletion_of_ssl_certificate_filter`"
Linux Disable Services,"The following analytic detects attempts to disable a service on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes like &quot;systemctl,&quot; &quot;service,&quot; and &quot;svcadm&quot; with commands containing &quot;disable.&quot; This activity is significant as adversaries may disable security or critical services to evade detection and facilitate further malicious actions, such as deploying destructive payloads.",Linux,"Execution, Impact",T1489,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""systemctl"", ""service"", ""svcadm"")  Processes.process = ""* disable*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_disable_services_filter`"
Linux Doas Conf File Creation,"The following analytic detects the creation of the doas.conf file on a Linux host. This file is used by the doas utility to allow standard users to perform tasks as root, similar to sudo. The detection leverages filesystem data from the Endpoint data model, focusing on the creation of the doas.conf file. This activity is significant because it can indicate an attempt to gain elevated privileges, potentially by an adversary.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/etc/doas.conf"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_doas_conf_file_creation_filter`"
Linux Doas Tool Execution,"The following analytic detects the execution of the 'doas' tool on a Linux host. This tool allows standard users to perform tasks with root privileges, similar to 'sudo'. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as 'doas' can be exploited by adversaries to gain elevated privileges on a compromised host.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""doas"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_doas_tool_execution_filter`"
Linux Docker Privilege Escalation,"The following analytic detects attempts to escalate privileges on a Linux system using Docker. It identifies processes where Docker commands are used to mount the root directory or execute shell commands within a container. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process names, command-line arguments, and parent processes. This activity is significant because it can allow an attacker with Docker privileges to modify critical system files, such as /etc/passwd, to create a superuser.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN(""*docker*-v*/*:*"",""*docker*--volume*/*:*"") OR Processes.process IN(""*docker*exec*sh*"",""*docker*exec*bash*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_docker_privilege_escalation_filter`"
Linux Edit Cron Table Parameter,"The following analytic detects the suspicious editing of cron jobs in Linux using the crontab command-line parameter (-e). It identifies this activity by monitoring command-line executions involving 'crontab' and the edit parameter. This behavior is significant for a SOC as cron job manipulations can indicate unauthorized persistence attempts or scheduled malicious actions. If confirmed malicious, this activity could lead to system compromise, unauthorized access, or broader network compromise.",Linux,"Execution, Persistence, Privilege Escalation","T1053, T1053.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = crontab Processes.process = ""*crontab *"" Processes.process = ""* -e*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_edit_cron_table_parameter_filter`"
Linux Emacs Privilege Escalation,"The following analytic detects the execution of Emacs with elevated privileges using the sudo command and the --eval option. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line arguments. This activity is significant because it indicates a potential privilege escalation attempt, where a user could gain root access by running Emacs with elevated permissions.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*emacs*"" AND Processes.process=""*--eval*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_emacs_privilege_escalation_filter`"
Linux File Created In Kernel Driver Directory,"The following analytic detects the creation of files in the Linux kernel/driver directory. It leverages filesystem data to identify new files in this critical directory. This activity is significant because the kernel/driver directory is typically reserved for kernel modules, and unauthorized file creation here can indicate a rootkit installation. If confirmed malicious, this could allow an attacker to gain high-level privileges, potentially compromising the entire system by executing code at the kernel level.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/kernel/drivers/*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_file_created_in_kernel_driver_directory_filter`"
Linux File Creation In Init Boot Directory,"The following analytic detects the creation of files in Linux init boot directories, which are used for automatic execution upon system startup. It leverages file system logs to identify new files in directories such as /etc/init.d/ and /etc/rc.d/. This activity is significant as it is a common persistence technique used by adversaries, malware authors, and red teamers.",Linux,"Execution, Persistence, Privilege Escalation",T1037.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/etc/init.d/*"", ""*/etc/rc.d/*"", ""*/sbin/init.d/*"", ""*/etc/rc.local*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_file_creation_in_init_boot_directory_filter`"
Linux File Creation In Profile Directory,"The following analytic detects the creation of files in the /etc/profile.d directory on Linux systems. It leverages filesystem data to identify new files in this directory, which is often used by adversaries for persistence by executing scripts upon system boot. This activity is significant as it may indicate an attempt to maintain long-term access to the compromised host.",Linux,"Execution, Exfiltration, Persistence, Privilege Escalation","T1546.004, T1546","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*/etc/profile.d/*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_file_creation_in_profile_directory_filter`"
Linux Find Privilege Escalation,"The following analytic detects the use of the 'find' command with 'sudo' and '-exec' options, which can indicate an attempt to escalate privileges on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line arguments. This activity is significant because it can allow a user to execute system commands as root, potentially leading to a root shell.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*find*"" AND Processes.process=""*-exec*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_find_privilege_escalation_filter`"
Linux GDB Privilege Escalation,"The following analytic detects the execution of the GNU Debugger (GDB) with specific flags that indicate an attempt to escalate privileges on a Linux system. It leverages Endpoint Detection and Response (EDR) telemetry to identify processes where GDB is run with the -nx, -ex, and sudo flags. This activity is significant because it can allow a user to execute system commands as root, potentially leading to a root shell.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*gdb*"" AND Processes.process=""*-nx*"" AND Processes.process=""*-ex*!*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_gdb_privilege_escalation_filter`"
Linux Gem Privilege Escalation,"The following analytic detects the execution of the RubyGems utility with elevated privileges, specifically when it is used to run system commands as root. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include &quot;gem open -e&quot; and &quot;sudo&quot;. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute commands as the root user.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*gem*open*-e*"" AND Processes.process=""*-c*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_gem_privilege_escalation_filter`"
Linux GNU Awk Privilege Escalation,"The following analytic detects the execution of the 'gawk' command with elevated privileges on a Linux system. It leverages Endpoint Detection and Response (EDR) telemetry to identify command-line executions where 'gawk' is used with 'sudo' and 'BEGIN{system' patterns. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute system commands as root.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*gawk*"" AND Processes.process=""*BEGIN*{system*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_gnu_awk_privilege_escalation_filter`"
Linux High Frequency Of File Deletion In Boot Folder,"The following analytic detects a high frequency of file deletions in the /boot/ folder on Linux systems. It leverages filesystem event logs to identify when 200 or more files are deleted within an hour by the same process. This behavior is significant as it may indicate the presence of wiper malware, such as Industroyer2, which targets critical system directories.",Linux,"Execution, Impact, Privilege Escalation, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` values(Filesystem.file_access_time) as file_access_time values(Filesystem.file_create_time) as file_create_time values(Filesystem.file_hash) as file_hash values(Filesystem.file_modify_time) as file_modify_time values(Filesystem.file_name) as file_name values(Filesystem.file_path) as file_path  values(Filesystem.file_acl) as file_acl values(Filesystem.file_size) as file_size values(Filesystem.process_id) as process_id values(Filesystem.user) as user values(Filesystem.vendor_product) as vendor_product dc(Filesystem.file_path) as numOfDelFilePath count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path = ""/boot/*"" by _time span=1h  Filesystem.dest Filesystem.process_guid Filesystem.action 
| `drop_dm_object_name(Filesystem)` 
| where  numOfDelFilePath >= 200 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_high_frequency_of_file_deletion_in_boot_folder_filter`"
Linux High Frequency Of File Deletion In Etc Folder,"The following analytic detects a high frequency of file deletions in the /etc/ folder on Linux systems. It leverages the Endpoint.Filesystem data model to identify instances where 200 or more files are deleted within an hour, grouped by process name and process ID. This behavior is significant as it may indicate the presence of wiper malware, such as AcidRain, which aims to delete critical system files.",Linux,"Execution, Impact, Defense Evasion","T1485, T1070.004","| tstats `security_content_summariesonly` values(Filesystem.file_access_time) as file_access_time values(Filesystem.file_create_time) as file_create_time values(Filesystem.file_hash) as file_hash values(Filesystem.file_modify_time) as file_modify_time values(Filesystem.file_name) as file_name values(Filesystem.file_path) as file_path  values(Filesystem.file_acl) as file_acl values(Filesystem.file_size) as file_size values(Filesystem.process_id) as process_id values(Filesystem.user) as user dc(Filesystem.file_path) as numOfDelFilePath count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=deleted Filesystem.file_path = ""/etc/*"" by _time span=1h  Filesystem.dest Filesystem.process_guid Filesystem.action Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| where  numOfDelFilePath >= 200 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_high_frequency_of_file_deletion_in_etc_folder_filter`"
Linux Indicator Removal Service File Deletion,"The following analytic detects the deletion of Linux service unit configuration files by suspicious processes. It leverages Endpoint Detection and Response (EDR) telemetry, focusing on processes executing the 'rm' command targeting '.service' files. This activity is significant as it may indicate malware attempting to disable critical services or security products, a common defense evasion tactic.",Linux,"Execution, Impact, Defense Evasion",T1070.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""rm""  AND Processes.process = ""*rm *""  AND Processes.process = ""*.service"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `linux_indicator_removal_service_file_deletion_filter`"
Linux Insert Kernel Module Using Insmod Utility,"The following analytic detects the insertion of a Linux kernel module using the insmod utility. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include process names and command-line details. This activity is significant as it may indicate the installation of a rootkit or malicious kernel module, potentially allowing an attacker to gain elevated privileges and bypass security detections.",Linux,"Execution, Persistence, Privilege Escalation",T1547.006,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN(""kmod"", ""sudo"") AND Processes.process = *insmod* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_insert_kernel_module_using_insmod_utility_filter`"
Linux Iptables Firewall Modification,"The following analytic detects suspicious command-line activity that modifies the iptables firewall settings on a Linux machine. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command patterns that alter firewall rules to accept traffic on certain TCP ports. This activity is significant as it can indicate malware, such as CyclopsBlink, modifying firewall settings to allow communication with a Command and Control (C2) server.",Linux,"Command And Control, Execution, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*iptables *"" AND Processes.process = ""* --dport *"" AND Processes.process = ""* ACCEPT*"" AND Processes.process = ""*&amp;&gt;/dev/null*"" AND Processes.process = ""* tcp *"" AND NOT(Processes.parent_process_path IN(""/bin/*"", ""/lib/*"", ""/usr/bin/*"", ""/sbin/*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| rex field=Processes.process ""--dport (?<port>3269
|636
|989
|994
|995
|8443)"" 
| stats values(Processes.process) as processes_exec values(port) as ports values(Processes.process_guid) as guids values(Processes.process_id) as pids dc(port) as port_count count by Processes.process_name Processes.parent_process_name Processes.parent_process_id Processes.dest Processes.user Processes.parent_process_path Processes.process_path 
| where port_count >=3 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_iptables_firewall_modification_filter`"
Linux Kernel Module Enumeration,"The following analytic identifies the use of the 'kmod' process to list kernel modules on a Linux system. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. While listing kernel modules is not inherently malicious, it can be a precursor to loading unauthorized modules using 'insmod'.",Linux,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery","T1014, T1082","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=kmod Processes.process IN (""*lsmod*"", ""*list*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_kernel_module_enumeration_filter`"
Linux Make Privilege Escalation,"The following analytic detects the use of the 'make' command with elevated privileges to execute system commands as root, potentially leading to a root shell. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include 'make', '--eval', and 'sudo'. This activity is significant because it indicates a possible privilege escalation attempt, allowing a user to gain root access.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*make*-s*"" AND Processes.process=""*--eval*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_make_privilege_escalation_filter`"
Linux MySQL Privilege Escalation,"The following analytic detects the execution of MySQL commands with elevated privileges using sudo, which can lead to privilege escalation. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a potential misuse of MySQL to execute system commands as root, which could allow an attacker to gain root shell access.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*mysql*-e*"" AND Processes.process=""*\!**"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_mysql_privilege_escalation_filter`"
Linux Ngrok Reverse Proxy Usage,"The following analytic detects the use of Ngrok on a Linux operating system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments associated with Ngrok. This activity is significant because Ngrok can be used by adversaries to establish reverse proxies, potentially bypassing network defenses. If confirmed malicious, this could allow attackers to create persistent, unauthorized access channels, facilitating data exfiltration or further exploitation of the compromised system.",Linux,"Command And Control, Execution, Privilege Escalation, Exfiltration","T1102, T1572, T1090","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=ngrok Processes.process IN (""*start*"", ""*--config*"",""*http*"",""*authtoken*"", ""*http*"", ""*tcp*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_ngrok_reverse_proxy_usage_filter`"
Linux Node Privilege Escalation,"The following analytic identifies the execution of Node.js with elevated privileges using sudo, specifically when spawning child processes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include specific Node.js commands. This activity is significant because running Node.js as a superuser without dropping privileges can allow unauthorized access to the file system and potential privilege escalation.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*sudo*node*"" AND Processes.process=""*-e*"" AND Processes.process=""*child_process.spawn*"" AND Processes.process=""*stdio*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_node_privilege_escalation_filter`"
Linux NOPASSWD Entry In Sudoers File,"The following analytic detects the addition of NOPASSWD entries to the /etc/sudoers file on Linux systems. It leverages Endpoint Detection and Response (EDR) telemetry to identify command lines containing &quot;NOPASSWD:&quot;. This activity is significant because it allows users to execute commands with elevated privileges without requiring a password, which can be exploited by adversaries to maintain persistent, privileged access.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*NOPASSWD:*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_nopasswd_entry_in_sudoers_file_filter`"
Linux Obfuscated Files or Information Base64 Decode,"The following analytic detects the use of the base64 decode command on Linux systems, which is often used to deobfuscate files. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include &quot;base64 -d&quot; or &quot;base64 --decode&quot;. This activity is significant as it may indicate an attempt to hide malicious payloads or scripts.",Linux,"Execution, Exfiltration, Privilege Escalation, Defense Evasion",T1027,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_path=""*/base64"" Processes.process=""*-d*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_obfuscated_files_or_information_base64_decode_filter`"
Linux Octave Privilege Escalation,"The following analytic detects the execution of GNU Octave with elevated privileges, specifically when it runs system commands via sudo. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments that include &quot;octave-cli,&quot; &quot;--eval,&quot; &quot;system,&quot; and &quot;sudo.&quot; This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute commands as root.",Linux,"Execution, Impact, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*octave-cli*"" AND Processes.process=""*--eval*"" AND Processes.process=""*system*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_octave_privilege_escalation_filter`"
Linux OpenVPN Privilege Escalation,"The following analytic detects the execution of OpenVPN with elevated privileges, specifically when combined with the --dev, --script-security, --up, and sudo options. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments and execution details. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute system commands as root.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*openvpn*"" AND Processes.process=""*--dev*"" AND Processes.process=""*--script-security*"" AND Processes.process=""*--up*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_openvpn_privilege_escalation_filter`"
Linux Persistence and Privilege Escalation Risk Behavior,"The following analytic identifies potential Linux persistence and privilege escalation activities. It leverages risk scores and event counts from various Linux-related data sources, focusing on tactics associated with persistence and privilege escalation. This activity is significant for a SOC because it highlights behaviors that could allow an attacker to maintain access or gain elevated privileges on a Linux system.",Linux,"Persistence, Privilege Escalation, Defense Evasion",T1548,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where (All_Risk.analyticstories IN (""Linux Privilege Escalation"", ""Linux Persistence Techniques"") OR source = ""*Linux*"") All_Risk.annotations.mitre_attack.mitre_tactic IN (""persistence"", ""privilege-escalation"") All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 4 
| `linux_persistence_and_privilege_escalation_risk_behavior_filter`"
Linux PHP Privilege Escalation,"The following analytic detects the execution of PHP commands with elevated privileges on a Linux system. It identifies instances where PHP is used in conjunction with 'sudo' and 'system' commands, indicating an attempt to run system commands as the root user. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*php*-r*"" AND Processes.process=""*system*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_php_privilege_escalation_filter`"
Linux pkexec Privilege Escalation,"The following analytic detects the execution of pkexec without any command-line arguments. This behavior leverages data from Endpoint Detection and Response (EDR) agents, focusing on process telemetry. The significance lies in the fact that this pattern is associated with the exploitation of CVE-2021-4034 (PwnKit), a critical vulnerability in Polkit's pkexec component. If confirmed malicious, this activity could allow an attacker to gain full root privileges on the affected Linux system, leading to complete system compromise and potential unauthorized access to sensitive information.",Linux,"Execution, Privilege Escalation",T1068,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=pkexec by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| regex process=""(^.{1}$)"" 
| `linux_pkexec_privilege_escalation_filter`"
Linux Possible Access Or Modification Of sshd Config File,"The following analytic detects suspicious access or modification of the sshd_config file on Linux systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving processes like &quot;cat,&quot; &quot;nano,&quot; &quot;vim,&quot; and &quot;vi&quot; accessing the sshd_config file. This activity is significant because unauthorized changes to sshd_config can allow threat actors to redirect port connections or use unauthorized keys, potentially compromising the system.",Linux,"Execution, Persistence, Privilege Escalation","T1098.004, T1098","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN(""cat"", ""nano*"",""vim*"", ""vi*"")  AND Processes.process IN(""*/etc/ssh/sshd_config"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_access_or_modification_of_sshd_config_file_filter`"
Linux Possible Access To Credential Files,"The following analytic detects attempts to access or dump the contents of /etc/passwd and /etc/shadow files on Linux systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes like 'cat', 'nano', 'vim', and 'vi' accessing these files. This activity is significant as it may indicate credential dumping, a technique used by adversaries to gain persistence or escalate privileges.",Linux,"Execution, Credential Access, Persistence, Privilege Escalation","T1003, T1003.008","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN(""cat"", ""nano*"",""vim*"", ""vi*"")  AND Processes.process IN(""*/etc/shadow*"", ""*/etc/passwd*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_access_to_credential_files_filter`"
Linux Possible Access To Sudoers File,"The following analytic detects potential access or modification of the /etc/sudoers file on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes like &quot;cat,&quot; &quot;nano,&quot; &quot;vim,&quot; and &quot;vi&quot; accessing the /etc/sudoers file. This activity is significant because the sudoers file controls user permissions for executing commands with elevated privileges.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1548.003, T1548","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN(""cat"", ""nano*"",""vim*"", ""vi*"")  AND Processes.process IN(""*/etc/sudoers*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_access_to_sudoers_file_filter`"
Linux Possible Append Command To At Allow Config File,"The following analytic detects suspicious command lines that append user entries to /etc/at.allow or /etc/at.deny files. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving these files. This activity is significant because altering these configuration files can allow attackers to schedule tasks with elevated permissions, facilitating persistence on a compromised Linux host.",Linux,"Execution, Persistence, Privilege Escalation","T1053.002, T1053","| tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Processes.process = ""*echo*"" AND Processes.process IN(""*/etc/at.allow"", ""*/etc/at.deny"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_append_command_to_at_allow_config_file_filter`"
Linux Possible Append Command To Profile Config File,"The following analytic detects suspicious command-lines that modify user profile files to automatically execute scripts or executables upon system reboot. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving profile files like ~/.bashrc and /etc/profile. This activity is significant as it indicates potential persistence mechanisms used by adversaries to maintain access to compromised hosts.",Linux,"Execution, Persistence, Privilege Escalation","T1546.004, T1546","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*echo*"" AND Processes.process IN(""*~/.bashrc"", ""*~/.bash_profile"", ""*/etc/profile"", ""~/.bash_login"", ""*~/.profile"", ""~/.bash_logout"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_append_command_to_profile_config_file_filter`"
Linux Possible Append Cronjob Entry on Existing Cronjob File,"The following analytic detects potential tampering with cronjob files on a Linux system by identifying 'echo' commands that append code to existing cronjob files. It leverages logs from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant because adversaries often use it for persistence or privilege escalation.",Linux,"Execution, Impact, Persistence, Privilege Escalation","T1053, T1053.003","| tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Processes.process = ""*echo*"" AND Processes.process IN(""*/etc/cron*"", ""*/var/spool/cron/*"", ""*/etc/anacrontab*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_append_cronjob_entry_on_existing_cronjob_file_filter`"
Linux Possible Cronjob Modification With Editor,"The following analytic detects potential unauthorized modifications to Linux cronjobs using text editors like &quot;nano,&quot; &quot;vi,&quot; or &quot;vim.&quot; It identifies this activity by monitoring command-line executions that interact with cronjob configuration paths. This behavior is significant for a SOC as it may indicate attempts at privilege escalation or establishing persistent access. If confirmed malicious, the impact could be severe, allowing attackers to execute damaging actions such as data theft, system sabotage, or further network penetration.",Linux,"Execution, Impact, Persistence, Privilege Escalation","T1053, T1053.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name IN(""nano"",""vim.basic"") OR Processes.process IN (""*nano *"", ""*vi *"", ""*vim *"")) AND Processes.process IN(""*/etc/cron*"", ""*/var/spool/cron/*"", ""*/etc/anacrontab*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_possible_cronjob_modification_with_editor_filter`"
Linux Proxy Socks Curl,"The following analytic detects the use of the curl command with proxy-related arguments such as -x, socks, --preproxy, and --proxy. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it may indicate an adversary attempting to use a proxy to evade network monitoring and obscure their actions.",Linux,"Command And Control, Execution, Privilege Escalation, Exfiltration","T1095, T1090","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=curl Processes.process IN (""*-x *"", ""*socks4a://*"", ""*socks5h://*"", ""*socks4://*"",""*socks5://*"", ""*--preproxy *"", ""--proxy*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process, ""-x\s"") OR match(process, ""(?i)socks\d\w?:\/\/
|--(pre)?proxy"") 
| `linux_proxy_socks_curl_filter`"
Linux Puppet Privilege Escalation,"The following analytic detects the execution of Puppet commands with elevated privileges, specifically when Puppet is used to apply configurations with sudo rights. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that include command-line details. This activity is significant because it indicates a potential privilege escalation attempt, where a user could gain root access and execute system commands as the root user.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*puppet*"" AND Processes.process=""*apply*"" AND Processes.process=""*-e*"" AND Processes.process=""*exec*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_puppet_privilege_escalation_filter`"
Linux RPM Privilege Escalation,"The following analytic detects the execution of the RPM Package Manager with elevated privileges, specifically when it is used to run system commands as root via the --eval and lua:os.execute options. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process metadata. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to gain root access.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*rpm*--eval*"" AND Processes.process=""*lua:os.execute*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_rpm_privilege_escalation_filter`"
Linux Ruby Privilege Escalation,"The following analytic detects the execution of Ruby commands with elevated privileges on a Linux system. It identifies processes where Ruby is used with the -e flag to execute commands via sudo, leveraging Endpoint Detection and Response (EDR) telemetry. This activity is significant because it indicates a potential privilege escalation attempt, allowing a user to execute commands as root.",Linux,"Execution, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*ruby*-e*"" AND Processes.process=""*exec*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_ruby_privilege_escalation_filter`"
Linux Service Restarted,"The following analytic detects the restarting or re-enabling of services on Linux systems using the systemctl or service commands. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line execution logs. This activity is significant as adversaries may use it to maintain persistence or execute unauthorized actions. If confirmed malicious, this behavior could lead to repeated execution of malicious payloads, unauthorized access, or data destruction.",Linux,"Execution, Persistence, Privilege Escalation","T1543, T1053.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name IN (""systemctl"", ""service"") OR Processes.process IN (""*systemctl *"", ""*service *"")) Processes.process IN (""*restart*"", ""*reload*"", ""*reenable*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_service_restarted_filter`"
Linux Setuid Using Chmod Utility,"The following analytic detects the execution of the chmod utility to set the SUID or SGID bit on files, which can allow users to temporarily gain root or group-level access. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments related to chmod. This activity is significant as it can indicate an attempt to escalate privileges or maintain persistence on a system.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes WHERE (Processes.process_name = chmod OR Processes.process = ""*chmod *"") AND Processes.process IN(""* g+s *"", ""* u+s *"", ""* 4777 *"", ""* 4577 *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_setuid_using_chmod_utility_filter`"
Linux Setuid Using Setcap Utility,"The following analytic detects the execution of the 'setcap' utility to enable the SUID bit on Linux systems. It leverages Endpoint Detection and Response (EDR) data, focusing on process names and command-line arguments that indicate the use of 'setcap' with specific capabilities. This activity is significant because setting the SUID bit allows a user to temporarily gain root access, posing a substantial security risk.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = setcap OR Processes.process = ""*setcap *"") AND Processes.process IN (""* cap_setuid=ep *"", ""* cap_setuid+ep *"", ""* cap_net_bind_service+p *"", ""* cap_net_raw+ep *"", ""* cap_dac_read_search+ep *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_setuid_using_setcap_utility_filter`"
Linux Shred Overwrite Command,"The following analytic detects the execution of the 'shred' command on a Linux machine, which is used to overwrite files to make them unrecoverable. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because the 'shred' command can be used in destructive attacks, such as those seen in the Industroyer2 malware targeting energy facilities.",Linux,"Execution, Impact, Persistence, Privilege Escalation",T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name =shred AND Processes.process IN (""*-n*"", ""*-u*"", ""*-z*"", ""*-s*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_shred_overwrite_command_filter`"
Linux Sqlite3 Privilege Escalation,"The following analytic detects the execution of the sqlite3 command with elevated privileges, which can be exploited for privilege escalation. It leverages Endpoint Detection and Response (EDR) telemetry to identify instances where sqlite3 is used in conjunction with shell commands and sudo. This activity is significant because it indicates a potential attempt to gain root access, which could lead to full system compromise.",Linux,"Execution, Lateral Movement, Privilege Escalation, Defense Evasion, Exfiltration",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*sqlite3*"" AND Processes.process=""*.shell*"" AND Processes.process=""*sudo*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_sqlite3_privilege_escalation_filter`"
Linux Stop Services,"The following analytic detects attempts to stop or clear a service on Linux systems. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on processes like &quot;systemctl,&quot; &quot;service,&quot; and &quot;svcadm&quot; executing stop commands. This activity is significant as adversaries often terminate security or critical services to disable defenses or disrupt operations, as seen in malware like Industroyer2.",Linux,"Execution, Impact, Privilege Escalation",T1489,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""systemctl"", ""service"", ""svcadm"")  Processes.process =""*stop*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_stop_services_filter`"
Linux Sudoers Tmp File Creation,"The following analytic detects the creation of the &quot;sudoers.tmp&quot; file, which occurs when editing the /etc/sudoers file using visudo or another editor on a Linux platform. This detection leverages filesystem data to identify the presence of &quot;sudoers.tmp&quot; files. Monitoring this activity is crucial as adversaries may exploit it to gain elevated privileges on a compromised host.",Linux,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*sudoers.tmp*"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `linux_sudoers_tmp_file_creation_filter`"
Linux Visudo Utility Execution,"The following analytic detects the execution of the 'visudo' utility to modify the /etc/sudoers file on a Linux system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. This activity is significant because unauthorized changes to the /etc/sudoers file can grant elevated privileges to users, potentially allowing adversaries to execute commands as root.",Linux,"Execution, Persistence, Impact, Privilege Escalation, Defense Evasion",T1548.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = visudo by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `linux_visudo_utility_execution_filter`"
Loading Of Dynwrapx Module,"The following analytic detects the loading of the dynwrapx.dll module, which is associated with the DynamicWrapperX ActiveX component. This detection leverages Sysmon EventCode 7 to identify processes that load or register dynwrapx.dll. This activity is significant because DynamicWrapperX can be used to call Windows API functions in scripts, making it a potential tool for malicious actions.",Windows Events,"Execution, Persistence, Defense Evasion",T1055.001,"`sysmon` EventCode=7 (ImageLoaded = ""*\\dynwrapx.dll"" OR OriginalFileName = ""dynwrapx.dll"" OR  Product = ""DynamicWrapperX"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `loading_of_dynwrapx_module_filter`"
Log4Shell CVE-2021-44228 Exploitation,The following analytic identifies potential exploitation of Log4Shell CVE-2021-44228 by correlating multiple MITRE ATT&amp;CK tactics detected in risk events. It leverages Splunk's risk data model to calculate the distinct count of MITRE ATT&amp;CK tactics from Log4Shell-related detections. This activity is significant because it indicates a high probability of exploitation if two or more distinct tactics are observed.,Splunk Risk Rule (Multiple Sources),"Initial Access, Execution, Command And Control, Lateral Movement","T1190, T1133, T1105, T1059","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Log4Shell CVE-2021-44228"" All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 2 
| `log4shell_cve_2021_44228_exploitation_filter`"
MacOS plutil,"The following analytic detects the usage of the plutil command to modify plist files on macOS systems. It leverages osquery to monitor process events, specifically looking for executions of /usr/bin/plutil. This activity is significant because adversaries can use plutil to alter plist files, potentially adding malicious binaries or command-line arguments that execute upon user logon or system startup.",MacOS (OSQuery),"Execution, Persistence, Defense Evasion",T1647,"`osquery_macro` name=es_process_events columns.path=/usr/bin/plutil 
| rename columns.* as * 
| stats count  min(_time) as firstTime max(_time) as lastTime by username host cmdline pid path parent signing_id 
| rename username as user, cmdline as process, path as process_path, host as dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `macos_plutil_filter`"
Malicious InProcServer32 Modification,"The following analytic detects a process modifying the registry with a known malicious CLSID under InProcServer32. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on registry modifications within the HKLM or HKCU Software Classes CLSID paths. This activity is significant as it may indicate an attempt to load a malicious DLL, potentially leading to code execution.",Windows Events,"Execution, Defense Evasion","T1218.010, T1112","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\CLSID\\{89565275-A714-4a43-912E-978B935EDCCC}\\InProcServer32\\(Default)"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `malicious_inprocserver32_modification_filter`"
Malicious Powershell Executed As A Service,"The following analytic identifies the execution of malicious PowerShell commands or payloads via the Windows SC.exe utility. It detects this activity by analyzing Windows System logs (EventCode 7045) and filtering for specific PowerShell-related patterns in the ImagePath field. This behavior is significant because it indicates potential abuse of the Windows Service Control Manager to run unauthorized or harmful scripts, which could lead to system compromise.",Windows Events,"Execution, Persistence",T1569.002,"`wineventlog_system` EventCode=7045 
| eval l_ImagePath=lower(ImagePath) 
| regex l_ImagePath=""powershell[.\s]
|powershell_ise[.\s]
|pwsh[.\s]
|psexec[.\s]"" 
| regex l_ImagePath=""-nop[rofile\s]+
|-w[indowstyle]*\s+hid[den]*
|-noe[xit\s]+
|-enc[odedcommand\s]+"" 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath ServiceName StartType ServiceType AccountName UserID dest 
| rename UserID as user
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `malicious_powershell_executed_as_a_service_filter`"
Microsoft Defender ATP Alerts,"The following analytic is to leverage alerts from Microsoft Defender ATP Alerts. This query aggregates and summarizes all alerts from Microsoft Defender ATP Alerts, providing details such as the source, file name, severity, process command line, ip address, registry key, signature, description, unique id, and timestamps. This detection is not intended to detect new activity from raw data, but leverages Microsoft provided alerts to be correlated with other data as part of risk based alerting.",Microsoft Defender,,,"`ms_defender_atp_alerts` (dest=* OR user=*)
| eval tmp_evidence=json_extract(_raw, ""evidence""), tmp_evidencemv=json_array_to_mv(tmp_evidence), entityType = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""entityType"")), filePath = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""filePath"")), processCommandLine = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""processCommandLine"")), ipAddress = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""ipAddress"")), registryKey = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""registryKey"")), url = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""url"")), fileName = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""fileName"")) 
| eval tmp_evidencemv=mvfilter(json_extract(tmp_evidencemv, ""entityType"") = ""File""), fileName = mvmap(tmp_evidencemv, spath(tmp_evidencemv, ""fileName"")) 
| eval risk_score=case(severity=""informational"", 5, severity=""low"", 15, severity=""medium"", 25, severity=""high"", 50 , true(), 2) 
| eval processCommandLine=if(processCommandLine=""null"", """", processCommandLine), ipAddress=if(ipAddress=""null"", """", ipAddress), registryKey=if(registryKey=""null"", """", registryKey), url=if(url=""null"", """", url) 
| stats count min(_time) as firstTime max(_time) as lastTime values(fileName) as file_name values(severity) as severity values(processCommandLine) as process values(ipAddress) as ip_address values(registryKey) as registry_key values(url) as url values(mitreTechniques{}) as annotations.mitre_attack.mitre_technique_id values(signature) as signature values(user) as user values(risk_score) as risk_score by id description src 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `microsoft_defender_atp_alerts_filter`"
Mmc LOLBAS Execution Process Spawn,"The following analytic identifies mmc.exe spawning a LOLBAS execution process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where mmc.exe is the parent process. This activity is significant because adversaries can abuse the DCOM protocol and MMC20 COM object to execute malicious code, using Windows native binaries documented by the LOLBAS project.",Windows Events,"Lateral Movement, Execution, Persistence, Defense Evasion","T1218.014, T1021.003, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=mmc.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Dllhost.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Mmc.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Rundll32.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Explorer.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `mmc_lolbas_execution_process_spawn_filter`"
Modification Of Wallpaper,"The following analytic detects the modification of registry keys related to the desktop wallpaper settings. It leverages Sysmon EventCode 13 to identify changes to the &quot;Control Panel\Desktop\Wallpaper&quot; and &quot;Control Panel\Desktop\WallpaperStyle&quot; registry keys, especially when the modifying process is not explorer.exe or involves suspicious file paths like temp or public directories. This activity is significant as it can indicate ransomware behavior, such as the REVIL ransomware, which changes the wallpaper to display a ransom note.",Windows Events,"Execution, Impact",T1491,"`sysmon` EventCode =13  (TargetObject IN (""*\\Control Panel\\Desktop\\Wallpaper"",""*\\Control Panel\\Desktop\\WallpaperStyle"") AND Image != ""*\\explorer.exe"") OR (TargetObject IN (""*\\Control Panel\\Desktop\\Wallpaper"",""*\\Control Panel\\Desktop\\WallpaperStyle"") AND Details IN (""*\\temp\\*"", ""*\\users\\public\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest process_guid process_id registry_hive registry_path registry_key_name registry_value_data registry_value_name status user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `modification_of_wallpaper_filter`"
Monitor Registry Keys for Print Monitors,"The following analytic detects modifications to the registry key HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors. It leverages data from the Endpoint.Registry data model, focusing on events where the registry path is modified. This activity is significant because attackers can exploit this registry key to load arbitrary .dll files, which will execute with elevated SYSTEM permissions and persist after a reboot.",Windows Events,Persistence,T1547.010,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.action=modified AND Registry.registry_path=""*CurrentControlSet\\Control\\Print\\Monitors*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `monitor_registry_keys_for_print_monitors_filter`"
MOVEit Certificate Store Access Failure,"This detection identifies potential exploitation attempts of the CVE-2024-5806 vulnerability in Progress MOVEit Transfer. It looks for log entries indicating failures to access the certificate store, which can occur when an attacker attempts to exploit the authentication bypass vulnerability. This behavior is a key indicator of attempts to impersonate valid users without proper credentials.",MOVEit,Initial Access,T1190,"`moveit_sftp_logs` ""IpWorksKeyService: Caught exception of type IPWorksSSHException: The certificate store could not be opened""
| stats count by source _raw 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `moveit_certificate_store_access_failure_filter`"
MS Exchange Mailbox Replication service writing Active Server Pages,The following analytic identifies the creation of suspicious .,Windows Events,"Initial Access, Persistence","T1190, T1505.003, T1133","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=MSExchangeMailboxReplication.exe  by _time span=1h Processes.process_id Processes.process_name Processes.process_guid Processes.dest 
| `drop_dm_object_name(Processes)` 
| join process_guid, _time [
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\HttpProxy\\owa\\auth\\*"", ""*\\inetpub\\wwwroot\\aspnet_client\\*"", ""*\\HttpProxy\\OAB\\*"") Filesystem.file_name=""*.aspx"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path 
| `drop_dm_object_name(Filesystem)` 
| fields _time dest file_create_time file_name file_path process_name process_path process process_guid] 
| dedup file_create_time 
| table dest file_create_time, file_name, file_path, process_name 
| `ms_exchange_mailbox_replication_service_writing_active_server_pages_filter`"
MS Scripting Process Loading Ldap Module,"The following analytic detects the execution of MS scripting processes (wscript.exe or cscript.exe) loading LDAP-related modules (Wldap32.dll, adsldp.dll, adsldpc.dll). It leverages Sysmon EventCode 7 to identify these specific DLL loads. This activity is significant as it may indicate an attempt to query LDAP for host information, a behavior observed in FIN7 implants. If confirmed malicious, this could allow attackers to gather detailed Active Directory information, potentially leading to further exploitation or data exfiltration.",Windows Events,"Execution, Exfiltration",T1059.007,"`sysmon` EventCode =7 Image IN (""*\\wscript.exe"", ""*\\cscript.exe"") ImageLoaded IN (""*\\Wldap32.dll"", ""*\\adsldp.dll"", ""*\\adsldpc.dll"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ms_scripting_process_loading_ldap_module_filter`"
MS Scripting Process Loading WMI Module,"The following analytic detects the loading of WMI modules by Microsoft scripting processes like wscript.exe or cscript.exe. It leverages Sysmon EventCode 7 to identify instances where these scripting engines load specific WMI-related DLLs. This activity is significant because it can indicate the presence of malware, such as the FIN7 implant, which uses JavaScript to execute WMI queries for gathering host information to send to a C2 server.",Windows Events,"Execution, Persistence",T1059.007,"`sysmon` EventCode =7 Image IN (""*\\wscript.exe"", ""*\\cscript.exe"") ImageLoaded IN (""*\\fastprox.dll"", ""*\\wbemdisp.dll"", ""*\\wbemprox.dll"", ""*\\wbemsvc.dll"" , ""*\\wmiutils.dll"", ""*\\wbemcomn.dll"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ms_scripting_process_loading_wmi_module_filter`"
MSBuild Suspicious Spawned By Script Process,"The following analytic detects the suspicious spawning of MSBuild.exe by Windows Script Host processes (cscript.exe or wscript.exe). This behavior is often associated with malware or adversaries executing malicious MSBuild processes via scripts on compromised hosts. The detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where MSBuild is a child of script hosts.",Windows Events,"Execution, Defense Evasion",T1127.001,"| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""wscript.exe"", ""cscript.exe"") AND `process_msbuild` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `msbuild_suspicious_spawned_by_script_process_filter`"
MSI Module Loaded by Non-System Binary,"The following analytic detects the loading of msi.dll by a binary not located in system32, syswow64, winsxs, or windows directories. This is identified using Sysmon EventCode 7, which logs DLL loads, and filters out legitimate system paths. This activity is significant as it may indicate exploitation of CVE-2021-41379 or DLL side-loading attacks, both of which can lead to unauthorized system modifications.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1574.001,"`sysmon` EventCode=7 ImageLoaded=""*\\msi.dll"" NOT (Image IN (""*\\System32\\*"",""*\\syswow64\\*"",""*\\windows\\*"", ""*\\winsxs\\*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `msi_module_loaded_by_non_system_binary_filter`"
Msmpeng Application DLL Side Loading,"The following analytic detects the suspicious creation of msmpeng.exe or mpsvc.dll in non-default Windows Defender folders. It leverages the Endpoint.Filesystem datamodel to identify instances where these files are created outside their expected directories. This activity is significant because it is associated with the REvil ransomware, which uses DLL side-loading to execute malicious payloads.",Windows Events,Defense Evasion,T1574.001,"|tstats `security_content_summariesonly` values(Filesystem.file_path) as file_path count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where (Filesystem.file_name = ""msmpeng.exe"" OR Filesystem.file_name = ""mpsvc.dll"")  AND NOT (Filesystem.file_path IN (""*\\Program Files\\windows defender\\*"",""*\\WinSxS\\*defender-service*"",""*\\WinSxS\\Temp\\*defender-service*"")) by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `msmpeng_application_dll_side_loading_filter`"
NET Profiler UAC bypass,"The following analytic detects modifications to the registry aimed at bypassing the User Account Control (UAC) feature in Windows. It identifies changes to the .NET COR_PROFILER_PATH registry key, which can be exploited to load a malicious DLL via mmc.exe. This detection leverages data from the Endpoint.Registry datamodel, focusing on specific registry paths and values.",Windows Events,"Discovery, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Environment\\COR_PROFILER_PATH"" Registry.registry_value_data = ""*.dll"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `net_profiler_uac_bypass_filter`"
Network Connection Discovery With Netstat,"The following analytic detects the execution of netstat.exe with command-line arguments to list network connections on a system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line executions, and parent processes. This activity is significant as both Red Teams and adversaries use netstat.exe for situational awareness and Active Directory discovery.",Windows Events,"Lateral Movement, Execution, Discovery, Exfiltration",T1049,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""netstat.exe"") (Processes.process=*-a*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `network_connection_discovery_with_netstat_filter`"
Network Share Discovery Via Dir Command,"The following analytic detects access to Windows administrative SMB shares (Admin$, IPC$, C$) using the 'dir' command. It leverages Windows Security Event Logs with EventCode 5140 to identify this activity. This behavior is significant as it is commonly used by tools like PsExec/PaExec for staging binaries before creating and starting services on remote endpoints, a technique often employed by adversaries for lateral movement and remote code execution.",Windows Events,"Lateral Movement, Execution, Discovery",T1135,"`wineventlog_security` EventCode=5140 ShareName IN(""\\\\*\\ADMIN$"",""\\\\*\\C$"",""*\\\\*\\IPC$"") AccessMask= 0x1 
| stats min(_time) as firstTime max(_time) as lastTime count by ShareName IpAddress ObjectType SubjectUserName SubjectDomainName IpPort AccessMask Computer 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `network_share_discovery_via_dir_command_filter`"
Nishang PowershellTCPOneLine,"The following analytic detects the use of the Nishang Invoke-PowerShellTCPOneLine utility, which initiates a callback to a remote Command and Control (C2) server. It leverages Endpoint Detection and Response (EDR) data, focusing on PowerShell processes that include specific .NET classes like Net.Sockets.TCPClient and System.Text.ASCIIEncoding. This activity is significant as it indicates potential remote control or data exfiltration attempts by an attacker.",Windows Events,"Command And Control, Execution, Exfiltration",T1059.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` (Processes.process=*Net.Sockets.TCPClient* AND Processes.process=*System.Text.ASCIIEncoding*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `nishang_powershelltcponeline_filter`"
Notepad with no Command Line Arguments,"The following analytic identifies instances where Notepad.exe is launched without any command line arguments, a behavior commonly associated with the SliverC2 framework. This detection leverages process creation events from Endpoint Detection and Response (EDR) agents, focusing on processes initiated by Notepad.exe within a short time frame. This activity is significant as it may indicate an attempt to inject malicious code into Notepad.",Windows Events,"Execution, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_name=notepad.exe AND Processes.action!=""blocked"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| regex process=""(?i)(notepad\.exe.{0,4}$)"" 
| `notepad_with_no_command_line_arguments_filter`"
Outbound Network Connection from Java Using Default Ports,"The following analytic detects outbound network connections from Java processes to default ports used by LDAP and RMI protocols, which may indicate exploitation of the CVE-2021-44228-Log4j vulnerability. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and network traffic logs. Monitoring this activity is crucial as it can signify an attackerâ€™s attempt to perform JNDI lookups and retrieve malicious payloads.",Windows Events,"Initial Access, Execution","T1190, T1133","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where (Processes.process_name=""java.exe"" OR Processes.process_name=javaw.exe OR Processes.process_name=javaw.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| join process_id [
| tstats `security_content_summariesonly` count FROM datamodel=Network_Traffic.All_Traffic where (All_Traffic.dest_port= 389 OR All_Traffic.dest_port= 636 OR All_Traffic.dest_port = 1389 OR All_Traffic.dest_port = 1099 ) by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction All_Traffic.process_id 
| `drop_dm_object_name(All_Traffic)` 
| rename dest as connection_to_CNC] 
| table _time dest parent_process_name process_name process_path process dest_port 
| `outbound_network_connection_from_java_using_default_ports_filter`"
Overwriting Accessibility Binaries,"The following analytic detects modifications to Windows accessibility binaries such as sethc.exe, utilman.exe, osk.exe, Magnify.exe, Narrator.exe, DisplaySwitch.exe, and AtBroker.exe. It leverages filesystem activity data from the Endpoint.Filesystem data model to identify changes to these specific files. This activity is significant because adversaries can exploit these binaries to gain unauthorized access or execute commands without logging in.",Windows Events,"Persistence, Privilege Escalation",T1546.008,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem where (Filesystem.file_path=*\\Windows\\System32\\sethc.exe* OR Filesystem.file_path=*\\Windows\\System32\\utilman.exe* OR Filesystem.file_path=*\\Windows\\System32\\osk.exe* OR Filesystem.file_path=*\\Windows\\System32\\Magnify.exe* OR Filesystem.file_path=*\\Windows\\System32\\Narrator.exe* OR Filesystem.file_path=*\\Windows\\System32\\DisplaySwitch.exe* OR Filesystem.file_path=*\\Windows\\System32\\AtBroker.exe*) by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `overwriting_accessibility_binaries_filter`"
PetitPotam Network Share Access Request,"The following analytic detects network share access requests indicative of the PetitPotam attack (CVE-2021-36942). It leverages Windows Event Code 5145, which logs attempts to access network share objects. This detection is significant as PetitPotam can coerce authentication from domain controllers, potentially leading to unauthorized access. If confirmed malicious, this activity could allow attackers to escalate privileges or move laterally within the network, posing a severe security risk.",Windows Events,Credential Access,T1187,"`wineventlog_security` SubjectUserName=""ANONYMOUS LOGON"" EventCode=5145 RelativeTargetName=lsarpc 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, SubjectUserSid, ShareName, src, AccessMask, AccessReason 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `petitpotam_network_share_access_request_filter`"
PetitPotam Suspicious Kerberos TGT Request,"The following analytic detects a suspicious Kerberos Ticket Granting Ticket (TGT) request, identified by Event Code 4768. This detection leverages Windows Security Event Logs to identify TGT requests with unusual fields, which may indicate the use of tools like Rubeus following the exploitation of CVE-2021-36942 (PetitPotam). This activity is significant as it can signal an attacker leveraging a compromised certificate to request Kerberos tickets, potentially leading to unauthorized access.",Windows Events,Credential Access,T1003,"`wineventlog_security` EventCode=4768 src!=""::1"" TargetUserName=*$ CertThumbprint!="""" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, TargetUserName, src, action 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `petitpotam_suspicious_kerberos_tgt_request_filter`"
Possible Browser Pass View Parameter,"The following analytic identifies processes with command-line parameters associated with web browser credential dumping tools, specifically targeting behaviors used by Remcos RAT malware. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and specific file paths. This activity is significant as it indicates potential credential theft, a common tactic in broader cyber-espionage campaigns.",Windows Events,"Execution, Credential Access",T1555.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process  IN (""*/stext *"", ""*/shtml *"", ""*/LoadPasswordsIE*"", ""*/LoadPasswordsFirefox*"", ""*/LoadPasswordsChrome*"", ""*/LoadPasswordsOpera*"", ""*/LoadPasswordsSafari*"" , ""*/UseOperaPasswordFile*"", ""*/OperaPasswordFile*"",""*/stab*"", ""*/scomma*"", ""*/stabular*"", ""*/shtml*"", ""*/sverhtml*"", ""*/sxml*"", ""*/skeepass*"" ) AND Processes.process IN (""*\\temp\\*"", ""*\\users\\public\\*"", ""*\\programdata\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `possible_browser_pass_view_parameter_filter`"
Potentially malicious code on commandline,"The following analytic detects potentially malicious command lines using a pretrained machine learning text classifier. It identifies unusual keyword combinations in command lines, such as &quot;streamreader,&quot; &quot;webclient,&quot; &quot;mutex,&quot; &quot;function,&quot; and &quot;computehash,&quot; which are often associated with adversarial PowerShell code execution for C2 communication. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command lines longer than 200 characters.",Windows Events,"Execution, Exfiltration","T1059.001, T1059, T1059.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.original_file_name) as original_file_name values(Processes.action) as action values(Processes.parent_process_exec) as parent_process_exec values(Processes.parent_process_guid) as parent_process_guid values(Processes.parent_process_id) as parent_process_id values(Processes.parent_process_path) as parent_process_path values(Processes.process_exec) as process_exec values(Processes.process_guid) as process_guid values(Processes.process_hash) as process_hash values(Processes.process_id) as process_id values(Processes.process_integrity_level) as process_integrity_level values(Processes.process_name) as process_name values(Processes.process_path) as process_path values(Processes.user) as user  values(Processes.user_id) as user_id values(Processes.vendor_product) as vendor_product from datamodel=""Endpoint.Processes"" by Processes.parent_process_name Processes.process_name Processes.process Processes.user Processes.dest 
| `drop_dm_object_name(Processes)` 
| where len(process) > 200 
| `potentially_malicious_code_on_cmdline_tokenize_score` 
| apply unusual_commandline_detection 
| eval score='predicted(unusual_cmdline_logits)', process=orig_process 
| fields - unusual_cmdline* predicted(unusual_cmdline_logits) orig_process 
| where score > 0.5 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `potentially_malicious_code_on_commandline_filter`"
PowerShell - Connect To Internet With Hidden Window,"The following analytic detects PowerShell commands using the WindowStyle parameter to hide the window while connecting to the Internet. This behavior is identified through Endpoint Detection and Response (EDR) telemetry, focusing on command-line executions that include variations of the WindowStyle parameter. This activity is significant because it attempts to bypass default PowerShell execution policies and conceal its actions, which is often indicative of malicious intent.",Windows Events,"Execution, Exfiltration",T1059.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process,""(?i)[\-
|\/
|â€“ 
|â€”
|â€•]w(in*d*o*w*s*t*y*l*e*)*\s+[^-]"") 
| `powershell___connect_to_internet_with_hidden_window_filter`"
Powershell COM Hijacking InprocServer32 Modification,The following analytic detects attempts to modify or add a Component Object Model (COM) entry to the InProcServer32 path within the registry using PowerShell. It leverages PowerShell ScriptBlock Logging (EventCode 4104) to identify suspicious script blocks that target the InProcServer32 registry path. This activity is significant because modifying COM objects can be used for persistence or privilege escalation by attackers.,Windows Events,"Execution, Persistence, Privilege Escalation","T1059.001, T1546.015, T1546","`powershell` EventCode=4104 ScriptBlockText = ""*Software\\Classes\\CLSID\\*\\InProcServer32*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_com_hijacking_inprocserver32_modification_filter`"
Powershell Enable SMB1Protocol Feature,"The following analytic detects the enabling of the SMB1 protocol via powershell.exe. It leverages PowerShell script block logging (EventCode 4104) to identify the execution of the Enable-WindowsOptionalFeature cmdlet with the SMB1Protocol parameter. This activity is significant because enabling SMB1 can facilitate lateral movement and file encryption by ransomware, such as RedDot. If confirmed malicious, this action could allow an attacker to propagate through the network, encrypt files, and potentially disrupt business operations.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1027.005,"`powershell` EventCode=4104 ScriptBlockText = ""*Enable-WindowsOptionalFeature*"" ScriptBlockText = ""*SMB1Protocol*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_enable_smb1protocol_feature_filter`"
Powershell Execute COM Object,"The following analytic detects the execution of a COM CLSID through PowerShell. It leverages EventCode 4104 and searches for specific script block text indicating the creation of a COM object. This activity is significant as it is commonly used by adversaries and malware, such as the Conti ransomware, to execute commands, potentially for privilege escalation or bypassing User Account Control (UAC).",Windows Events,"Discovery, Execution, Persistence, Privilege Escalation","T1059.001, T1546.015","`powershell` EventCode=4104 ScriptBlockText = ""*CreateInstance([type]::GetTypeFromCLSID*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_execute_com_object_filter`"
PowerShell Get LocalGroup Discovery,"The following analytic identifies the use of the get-localgroup command executed via PowerShell or cmd.exe to enumerate local groups on an endpoint. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. Monitoring this activity is significant as it may indicate an attacker attempting to gather information about local group memberships, which can be a precursor to privilege escalation.",Windows Events,"Discovery, Execution, Privilege Escalation","T1069, T1069.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=powershell.exe OR Processes.process_name=cmd.exe) (Processes.process=""*get-localgroup*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `powershell_get_localgroup_discovery_filter`"
Powershell Load Module in Meterpreter,"The following analytic detects the execution of suspicious PowerShell commands associated with Meterpreter modules, such as &quot;MSF.Powershell&quot; and &quot;MSF.Powershell.Meterpreter&quot;. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command sent to PowerShell. This activity is significant as it indicates potential post-exploitation actions, including credential dumping and persistence mechanisms. If confirmed malicious, an attacker could gain extensive control over the compromised system, escalate privileges, and maintain long-term access, posing a severe threat to the environment.",Windows Events,"Discovery, Execution, Persistence",T1059.001,"`powershell` EventCode=4104 ScriptBlockText IN (""*MSF.Powershell*"",""*MSF.Powershell.Meterpreter*"",""*MSF.Powershell.Meterpreter.Kiwi*"",""*MSF.Powershell.Meterpreter.Transport*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_load_module_in_meterpreter_filter`"
PowerShell Start-BitsTransfer,"The following analytic detects the execution of the PowerShell command Start-BitsTransfer, which can be used for file transfers, including potential data exfiltration. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line arguments. This activity is significant because Start-BitsTransfer can be abused by adversaries to upload sensitive files to remote locations, posing a risk of data loss.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1197,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` Processes.process=*start-bitstransfer* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `powershell_start_bitstransfer_filter`"
Prevent Automatic Repair Mode using Bcdedit,"The following analytic detects the execution of &quot;bcdedit.exe&quot; with parameters to set the boot status policy to ignore all failures. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because it can indicate an attempt by ransomware to prevent a compromised machine from booting into automatic repair mode, thereby hindering recovery efforts.",Windows Events,"Execution, Impact",T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""bcdedit.exe"" Processes.process = ""*bootstatuspolicy*""  Processes.process = ""*ignoreallfailures*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `prevent_automatic_repair_mode_using_bcdedit_filter`"
Print Spooler Failed to Load a Plug-in,"The following analytic detects driver load errors in the Windows PrintService Admin logs, specifically identifying issues related to CVE-2021-34527 (PrintNightmare). It triggers on error messages indicating the print spooler failed to load a plug-in module, such as &quot;meterpreter.dll,&quot; with error code 0x45A. This detection method leverages specific event codes and error messages.",Windows Events,"Execution, Persistence",T1547.012,"`printservice` ((ErrorCode=""0x45A"" (EventCode=""808"" OR EventCode=""4909"")) OR (""The print spooler failed to load a plug-in module"" OR ""\\drivers\\x64\\"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by OpCode EventCode ComputerName Message 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `print_spooler_failed_to_load_a_plug_in_filter`"
Process Execution via WMI,"The following analytic detects the execution of a process by WmiPrvSE.exe, indicating potential use of WMI (Windows Management Instrumentation) for process creation. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. This activity is significant as WMI can be used for lateral movement, remote code execution, or persistence by attackers.",Windows Events,"Lateral Movement, Execution, Persistence",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=WmiPrvSE.exe NOT (Processes.process IN (""*\\dismhost.exe*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `process_execution_via_wmi_filter`"
Process Writing DynamicWrapperX,"The following analytic detects a process writing the dynwrapx.dll file to disk and registering it in the registry. It leverages data from the Endpoint datamodel, specifically monitoring process and filesystem events. This activity is significant because DynamicWrapperX is an ActiveX component often used in scripts to call Windows API functions, and its presence in non-standard locations is highly suspicious.",Windows Events,"Execution, Persistence","T1559.001, T1059","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.file_name=""dynwrapx.dll"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `process_writing_dynamicwrapperx_filter`"
Randomly Generated Windows Service Name,"The following analytic detects the installation of a Windows Service with a suspicious, high-entropy name, indicating potential malicious activity.",Windows Events,"Lateral Movement, Execution, Persistence","T1543.003, T1543","`wineventlog_system` EventCode=7045 
| lookup ut_shannon_lookup word as Service_Name 
| where ut_shannon > 3 
| table EventCode ComputerName Service_Name ut_shannon Service_Start_Type Service_Type Service_File_Name 
| `randomly_generated_windows_service_name_filter`"
Reg exe Manipulating Windows Services Registry Keys,"The following analytic detects the use of reg.exe to modify registry keys associated with Windows services and their configurations. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant because unauthorized changes to service registry keys can indicate an attempt to establish persistence or escalate privileges.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name values(Processes.user) as user FROM datamodel=Endpoint.Processes where Processes.process_name=reg.exe Processes.process=*reg* Processes.process=*add* Processes.process=*Services* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `reg_exe_manipulating_windows_services_registry_keys_filter`"
Registry Keys for Creating SHIM Databases,"The following analytic detects registry activity related to the creation of application compatibility shims. It leverages data from the Endpoint.Registry data model, specifically monitoring registry paths associated with AppCompatFlags. This activity is significant because attackers can use shims to bypass security controls, achieve persistence, or escalate privileges. If confirmed malicious, this could allow an attacker to maintain long-term access, execute arbitrary code, or manipulate application behavior, posing a severe risk to the integrity and security of the affected systems.",Windows Events,"Persistence, Privilege Escalation",T1546.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=*CurrentVersion\\AppCompatFlags\\Custom* OR Registry.registry_path=*CurrentVersion\\AppCompatFlags\\InstalledSDB*) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `registry_keys_for_creating_shim_databases_filter`"
Registry Keys Used For Privilege Escalation,"The following analytic detects modifications to registry keys under &quot;Image File Execution Options&quot; that can be used for privilege escalation. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths and values like GlobalFlag and Debugger. This activity is significant because attackers can use these modifications to intercept executable calls and attach malicious binaries to legitimate system binaries.",Windows Events,"Execution, Persistence, Privilege Escalation",T1546.012,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE ((Registry.registry_path=""*Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options*"") AND (Registry.registry_value_name=GlobalFlag OR Registry.registry_value_name=Debugger)) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `registry_keys_used_for_privilege_escalation_filter`"
Regsvr32 Silent and Install Param Dll Loading,"The following analytic detects the loading of a DLL using the regsvr32 application with the silent parameter and DLLInstall execution. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line arguments and parent process details. This activity is significant as it is commonly used by RAT malware like Remcos and njRAT to load malicious DLLs on compromised machines.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1218.010, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_regsvr32` AND Processes.process=""*/i*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process,""(?i)[\-
|\/][Ss]{1}"") 
| `regsvr32_silent_and_install_param_dll_loading_filter`"
Regsvr32 with Known Silent Switch Cmdline,"The following analytic detects the execution of Regsvr32.exe with the silent switch to load DLLs. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on command-line executions containing the -s or /s switches. This activity is significant as it is commonly used in malware campaigns, such as IcedID, to stealthily load malicious DLLs.",Windows Events,"Execution, Defense Evasion",T1218.010,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_regsvr32` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process,""(?i)[\-
|\/][Ss]{1}"") 
| `regsvr32_with_known_silent_switch_cmdline_filter`"
Remote Process Instantiation via DCOM and PowerShell,"The following analytic detects the execution of powershell.exe with arguments used to start a process on a remote endpoint by abusing the DCOM protocol, specifically targeting ShellExecute and ExecuteShellCommand. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant as it indicates potential lateral movement and remote code execution attempts by adversaries.",Windows Events,"Lateral Movement, Execution","T1021.003, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` (Processes.process=""*Document.ActiveView.ExecuteShellCommand*"" OR Processes.process=""*Document.Application.ShellExecute*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_dcom_and_powershell_filter`"
Remote Process Instantiation via WinRM and PowerShell,"The following analytic detects the execution of powershell.exe with arguments used to start a process on a remote endpoint via the WinRM protocol, specifically targeting the Invoke-Command cmdlet. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process telemetry. This activity is significant as it may indicate lateral movement or remote code execution attempts by adversaries.",Windows Events,"Lateral Movement, Execution","T1021.006, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` (Processes.process=""*Invoke-Command*"" AND Processes.process=""*-ComputerName*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_winrm_and_powershell_filter`"
Remote Process Instantiation via WinRM and Winrs,"The following analytic detects the execution of winrs.exe with command-line arguments used to start a process on a remote endpoint. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions mapped to the Processes node of the Endpoint data model. This activity is significant as it may indicate lateral movement or remote code execution attempts by adversaries.",Windows Events,"Lateral Movement, Execution","T1021.006, T1021","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=winrs.exe OR Processes.original_file_name=winrs.exe) (Processes.process=""*-r:*"" OR Processes.process=""*-remote:*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_winrm_and_winrs_filter`"
Remote Process Instantiation via WMI,"The following analytic detects the execution of wmic.exe with parameters to spawn a process on a remote system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process telemetry mapped to the Processes node of the Endpoint data model. This activity is significant as WMI can be abused for lateral movement and remote code execution, often used by adversaries and Red Teams.",Windows Events,"Lateral Movement, Execution",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` (Processes.process=""*/node:*"" AND Processes.process=""*process*"" AND Processes.process=""*call*"" AND  Processes.process=""*create*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_wmi_filter`"
Remote Process Instantiation via WMI and PowerShell,"The following analytic detects the execution of powershell.exe using the Invoke-WmiMethod cmdlet to start a process on a remote endpoint via WMI. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process telemetry. This activity is significant as it indicates potential lateral movement or remote code execution attempts by adversaries.",Windows Events,"Discovery, Execution, Persistence, Lateral Movement",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` (Processes.process=""*Invoke-WmiMethod*"" AND Processes.process=""*-CN*"" AND Processes.process=""*-Class Win32_Process*"" AND  Processes.process=""*-Name create*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `remote_process_instantiation_via_wmi_and_powershell_filter`"
Remote System Discovery with Wmic,"The following analytic detects the execution of wmic.exe with specific command-line arguments used to discover remote systems within a domain. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to map out network resources and Active Directory structures.",Windows Events,"Execution, Discovery, Exfiltration",T1018,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""wmic.exe"") (Processes.process=*/NAMESPACE:\\\\root\\directory\\ldap* AND Processes.process=*ds_computer* AND Processes.process=""*GET ds_samaccountname*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_system_discovery_with_wmic_filter`"
Remote WMI Command Attempt,"The following analytic detects the execution of wmic.exe with the node switch, indicating an attempt to spawn a local or remote process. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line arguments. This activity is significant as it may indicate lateral movement or remote code execution attempts by an attacker.",Windows Events,"Lateral Movement, Execution, Discovery",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` Processes.process=*node* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `remote_wmi_command_attempt_filter`"
Resize ShadowStorage volume,"The following analytic identifies the resizing of shadow storage volumes, a technique used by ransomware like CLOP to prevent the recreation of shadow volumes. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;vssadmin.exe&quot; with parameters related to resizing shadow storage. This activity is significant as it indicates an attempt to hinder recovery efforts by manipulating shadow copies.",Windows Events,"Execution, Impact",T1490,"| tstats `security_content_summariesonly` values(Processes.process) as cmdline values(Processes.parent_process_name) as parent_process values(Processes.process_name) as process_name min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = ""cmd.exe"" OR Processes.parent_process_name = ""powershell.exe"" OR Processes.parent_process_name = ""powershell_ise.exe"" OR Processes.parent_process_name =  ""wmic.exe"" Processes.process_name = ""vssadmin.exe"" Processes.process=""*resize*"" Processes.process=""*shadowstorage*"" Processes.process=""*/maxsize*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `resize_shadowstorage_volume_filter`"
Revil Common Exec Parameter,"The following analytic detects the execution of command-line parameters commonly associated with REVIL ransomware, such as &quot;-nolan&quot;, &quot;-nolocal&quot;, &quot;-fast&quot;, and &quot;-full&quot;. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs mapped to the Processes node of the Endpoint data model. This activity is significant because these parameters are indicative of ransomware attempting to encrypt files on a compromised machine.",Windows Events,Execution,T1204,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""* -nolan *"" OR Processes.process = ""* -nolocal *"" OR Processes.process = ""* -fast *"" OR Processes.process = ""* -full *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `revil_common_exec_parameter_filter`"
Rundll32 Control RunDLL Hunt,"The following analytic identifies instances of rundll32.exe executing with Control_RunDLL in the command line, which is indicative of loading a .cpl or other file types. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant as rundll32.exe can be exploited to execute malicious Control Panel Item files, potentially linked to CVE-2021-40444.",Windows Events,"Execution, Persistence, Defense Evasion","T1218.002, T1218, T1218.011","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*Control_RunDLL* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_control_rundll_hunt_filter`"
Rundll32 Control RunDLL World Writable Directory,"The following analytic detects the execution of rundll32.exe with the Control_RunDLL command, loading files from world-writable directories such as windows\temp, programdata, or appdata. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process command-line data and specific directory paths. This activity is significant as it may indicate an attempt to exploit CVE-2021-40444 or similar vulnerabilities, allowing attackers to execute arbitrary code.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1218.002, T1218, T1218.011","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*Control_RunDLL* AND Processes.process IN (""*\\appdata\\*"", ""*\\windows\\temp\\*"", ""*\\programdata\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `rundll32_control_rundll_world_writable_directory_filter`"
RunDLL Loading DLL By Ordinal,"The following analytic detects rundll32.exe loading a DLL export function by ordinal value. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line executions. This behavior is significant because adversaries may use rundll32.exe to execute malicious code while evading security tools that do not monitor this process. If confirmed malicious, this activity could allow attackers to execute arbitrary code, potentially leading to system compromise, privilege escalation, or persistent access within the environment.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where match(process,""rundll32.+\#\d+"") 
| `rundll_loading_dll_by_ordinal_filter`"
Ryuk Test Files Detected,"The following analytic identifies the presence of files containing the keyword &quot;Ryuk&quot; in any folder on the C drive, indicative of Ryuk ransomware activity. It leverages the Endpoint Filesystem data model to detect file paths matching this pattern. This activity is significant as Ryuk ransomware is known for its destructive impact, encrypting critical files and demanding ransom.",Windows Events,Impact,T1486,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem WHERE ""Filesystem.file_path""=C:\\*Ryuk* by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `ryuk_test_files_detected_filter`"
SAM Database File Access Attempt,"The following analytic detects attempts to access the SAM, SYSTEM, or SECURITY database files within the windows\system32\config directory using Windows Security EventCode 4663. This detection leverages Windows Security Event logs to identify unauthorized access attempts. Monitoring this activity is crucial as it indicates potential credential access attempts, possibly exploiting vulnerabilities like CVE-2021-36934.",Windows Events,"Credential Access, Privilege Escalation",T1003.002,"`wineventlog_security` (EventCode=4663)  ProcessName!=*\\dllhost.exe ObjectName IN (""*\\Windows\\System32\\config\\SAM*"",""*\\Windows\\System32\\config\\SYSTEM*"",""*\\Windows\\System32\\config\\SECURITY*"") 
| stats values(AccessList) count by ProcessName ObjectName dest src_user 
| rename ProcessName as process_name 
| `sam_database_file_access_attempt_filter`"
Samsam Test File Write,"The following analytic detects the creation of a file named &quot;test.txt&quot; within the Windows system directory, indicative of Samsam ransomware propagation. It leverages file-system activity data from the Endpoint data model, specifically monitoring file paths within the Windows System32 directory. This activity is significant as it aligns with known Samsam ransomware behavior, which uses such files for propagation and execution.",Windows Events,"Execution, Impact",T1486,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_name) as file_name from datamodel=Endpoint.Filesystem where Filesystem.file_path=*\\windows\\system32\\test.txt by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `samsam_test_file_write_filter`"
SchCache Change By App Connect And Create ADSI Object,"The following analytic detects an application attempting to connect and create an ADSI object to perform an LDAP query. It leverages Sysmon EventCode 11 to identify changes in the Active Directory Schema cache files located in %LOCALAPPDATA%\Microsoft\Windows\SchCache or %systemroot%\SchCache. This activity is significant as it can indicate the presence of suspicious applications, such as ransomware, using ADSI object APIs for LDAP queries.",Windows Events,"Lateral Movement, Execution, Discovery",T1087.002,"`sysmon` EventCode=11 TargetFilename = ""*\\Windows\\SchCache\\*"" TargetFilename
= ""*.sch*"" NOT (Image IN (""*\\Windows\\system32\\mmc.exe"")) 
| stats count min(_time)
as firstTime max(_time) as lastTime by action dest file_name file_path process_guid
process_id user_id vendor_product process_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `schcache_change_by_app_connect_and_create_adsi_object_filter`"
Scheduled Task Initiation on Remote Endpoint,"The following analytic detects the use of 'schtasks.exe' to start a Scheduled Task on a remote endpoint. This detection leverages Endpoint Detection and Response (EDR) data, focusing on process details such as process name, parent process, and command-line executions. This activity is significant as adversaries often abuse Task Scheduler for lateral movement and remote code execution.",Windows Events,"Lateral Movement, Execution","T1053.005, T1053","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=schtasks.exe OR Processes.original_file_name=schtasks.exe) (Processes.process= ""* /S *"" AND Processes.process=*/run*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `scheduled_task_initiation_on_remote_endpoint_filter`"
Schtasks Run Task On Demand,"The following analytic detects the execution of a Windows Scheduled Task on demand via the shell or command line. It leverages process-related data, including process name, parent process, and command-line executions, sourced from endpoint logs. The detection focuses on 'schtasks.exe' with an associated 'run' command. This activity is significant as adversaries often use it to force the execution of their created Scheduled Tasks for persistent access or lateral movement within a compromised machine.",Windows Events,"Lateral Movement, Execution, Persistence",T1053,"| tstats `security_content_summariesonly` values(Processes.process) as process values(Processes.process_id) as process_id count min(_time) as firstTime max(_time) as lastTime  from datamodel=Endpoint.Processes where Processes.process_name = ""schtasks.exe"" Processes.process = ""*/run*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `schtasks_run_task_on_demand_filter`"
Schtasks used for forcing a reboot,The following analytic detects the use of 'schtasks.exe' to schedule forced system reboots using the 'shutdown' and '/create' flags. It leverages endpoint process data to identify instances where these specific command-line arguments are used. This activity is significant because it may indicate an adversary attempting to disrupt operations or force a reboot to execute further malicious actions.,Windows Events,"Execution, Persistence",T1053.005,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe Processes.process=""*shutdown*"" Processes.process=""*/create *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `schtasks_used_for_forcing_a_reboot_filter`"
Sdclt UAC Bypass,"The following analytic detects suspicious modifications to the sdclt.exe registry, a technique often used to bypass User Account Control (UAC). It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific registry paths and values associated with sdclt.exe. This activity is significant because UAC bypasses can allow attackers to execute payloads with elevated privileges without user consent.",Windows Events,"Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery",T1548.002,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE ((Registry.registry_path= ""*\\Windows\\CurrentVersion\\App Paths\\control.exe*"" OR Registry.registry_path= ""*\\exefile\\shell\\runas\\command\\*"") (Registry.registry_value_name = ""(Default)"" OR Registry.registry_value_name = ""IsolatedCommand"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `sdclt_uac_bypass_filter`"
ServicePrincipalNames Discovery with SetSPN,"The following analytic detects the use of setspn.exe to query the domain for Service Principal Names (SPNs). This detection leverages Endpoint Detection and Response (EDR) data, focusing on specific command-line arguments associated with setspn.exe. Monitoring this activity is crucial as it often precedes Kerberoasting or Silver Ticket attacks, which can lead to credential theft.",Windows Events,"Discovery, Execution, Credential Access, Privilege Escalation","T1558.003, T1558","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_setspn` (Processes.process=""*-t*"" AND Processes.process=""*-f*"") OR (Processes.process=""*-q*"" AND Processes.process=""**/**"") OR (Processes.process=""*-q*"") OR (Processes.process=""*-s*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `serviceprincipalnames_discovery_with_setspn_filter`"
Services Escalate Exe,"The following analytic identifies the execution of a randomly named binary via services.exe, indicative of privilege escalation using Cobalt Strike's svc-exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process lineage and command-line executions. This activity is significant as it often follows initial access, allowing adversaries to escalate privileges and establish persistence.",Windows Events,"Initial Access, Execution, Persistence, Privilege Escalation, Defense Evasion, Discovery",T1548,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=services.exe Processes.process_path=*admin$* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `services_escalate_exe_filter`"
Shim Database File Creation,"The following analytic detects the creation of shim database files (.sdb) in default directories using the sdbinst.exe application. It leverages filesystem activity data from the Endpoint.Filesystem data model to identify file writes to the Windows\AppPatch\Custom directory. This activity is significant because shims can intercept and alter API calls, potentially allowing attackers to bypass security controls or execute malicious code.",Windows Events,"Execution, Persistence, Privilege Escalation",T1546.011,"| tstats `security_content_summariesonly` count values(Filesystem.action) values(Filesystem.file_hash) as file_hash values(Filesystem.file_path) as file_path  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path=*Windows\\AppPatch\\Custom* by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
|`drop_dm_object_name(Filesystem)` 
| `shim_database_file_creation_filter`"
Short Lived Scheduled Task,The following analytic detects the creation and deletion of scheduled tasks within a short time frame (less than 30 seconds) using Windows Security EventCodes 4698 and 4699. This behavior is identified by analyzing Windows Security Event Logs and leveraging the Windows TA for parsing. Such activity is significant as it may indicate lateral movement or remote code execution attempts by adversaries.,Windows Events,"Lateral Movement, Execution, Exfiltration","T1053.005, T1053","`wineventlog_security` EventCode=4698 OR EventCode=4699 
| xmlkv Message 
| transaction Task_Name  startswith=(EventCode=4698) endswith=(EventCode=4699) 
| eval short_lived=case((duration<30),""TRUE"") 
| search  short_lived = TRUE 
| rename ComputerName as dest
| table _time, dest, Account_Name, Command, Task_Name, short_lived 
| `short_lived_scheduled_task_filter`"
SLUI RunAs Elevated,"The following analytic detects the execution of the Microsoft Software Licensing User Interface Tool (slui.exe) with elevated privileges using the -verb runas function. This activity is identified through logs from Endpoint Detection and Response (EDR) agents, focusing on specific registry keys and command-line parameters. This behavior is significant as it indicates a potential privilege escalation attempt, which could allow an attacker to gain elevated access and execute malicious actions with higher privileges.",Windows Events,"Execution, Exfiltration, Privilege Escalation, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=slui.exe (Processes.process=*-verb* Processes.process=*runas*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `slui_runas_elevated_filter`"
SLUI Spawning a Process,"The following analytic detects the Microsoft Software Licensing User Interface Tool (slui.exe) spawning a child process. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where slui.exe is the parent process. This activity is significant because slui.exe should not typically spawn child processes, and doing so may indicate a UAC bypass attempt, leading to elevated privileges.",Windows Events,"Execution, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=slui.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `slui_spawning_a_process_filter`"
Spike in File Writes,The following analytic detects a sharp increase in the number of files written to a specific host.,Windows Events,Exfiltration,,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.action=created by _time span=1h, Filesystem.dest 
| `drop_dm_object_name(Filesystem)` 
| eventstats max(_time) as maxtime 
| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), count, null))) as ""count"" avg(eval(if(_time<relative_time(maxtime, ""-1d@d""), count,null))) as avg stdev(eval(if(_time<relative_time(maxtime, ""-1d@d""), count, null))) as stdev by ""dest"" 
| eval upperBound=(avg+stdev*4), isOutlier=if((count > upperBound) AND num_data_samples >=20, 1, 0) 
| search isOutlier=1 
| `spike_in_file_writes_filter`"
Spoolsv Spawning Rundll32,"The following analytic detects the spawning of rundll32.exe without command-line arguments by spoolsv.exe, which is unusual and potentially indicative of exploitation attempts like CVE-2021-34527 (PrintNightmare). This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where spoolsv.exe is the parent process. This activity is significant as spoolsv.exe typically does not spawn other processes, and such behavior could indicate an active exploitation attempt.",Windows Events,"Execution, Persistence, Privilege Escalation",T1547.012,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=spoolsv.exe `process_rundll32` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `spoolsv_spawning_rundll32_filter`"
Spoolsv Writing a DLL - Sysmon,"The following analytic detects spoolsv.exe writing a .dll file, which is unusual behavior and may indicate exploitation of vulnerabilities like CVE-2021-34527 (PrintNightmare). This detection leverages Sysmon EventID 11 to monitor file creation events in the \spool\drivers\x64\ directory. This activity is significant because spoolsv.exe typically does not write DLL files, and such behavior could signify an ongoing attack.",Windows Events,"Execution, Persistence",T1547.012,"`sysmon` EventID=11 process_name=spoolsv.exe file_path=""*\\spool\\drivers\\x64\\*"" file_name=*.dll 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest file_name file_path  process_guid process_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `spoolsv_writing_a_dll___sysmon_filter`"
Steal or Forge Authentication Certificates Behavior Identified,The following analytic identifies potential threats related to the theft or forgery of authentication certificates. It detects when five or more analytics from the Windows Certificate Services story trigger within a specified timeframe. This detection leverages aggregated risk scores and event counts from the Risk data model. This activity is significant as it may indicate an ongoing attack aimed at compromising authentication mechanisms.,Splunk Risk Rule (Multiple Sources),Credential Access,T1649,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories=""Windows Certificate Services"" All_Risk.risk_object_type=""system"" by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 5 
| `steal_or_forge_authentication_certificates_behavior_identified_filter`"
Suspicious IcedID Rundll32 Cmdline,"The following analytic detects a suspicious rundll32.exe command line used to execute a DLL file, a technique associated with IcedID malware. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions containing the pattern */i:*. This activity is significant as it indicates potential malware attempting to load an encrypted DLL payload, often named license.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*/i:* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_icedid_rundll32_cmdline_filter`"
Suspicious Kerberos Service Ticket Request,"The following analytic detects suspicious Kerberos Service Ticket (TGS) requests where the requesting account name matches the service name, potentially indicating an exploitation attempt of CVE-2021-42278 and CVE-2021-42287. This detection leverages Event ID 4769 from Domain Controller and Kerberos events. Such activity is significant as it may represent an adversary attempting to escalate privileges by impersonating a domain controller.",Windows Events,"Privilege Escalation, Defense Evasion",T1078.002,"`wineventlog_security` EventCode=4769 
| eval isSuspicious = if(lower(ServiceName) = lower(mvindex(split(TargetUserName,""@""),0)),1,0) 
| where isSuspicious = 1 
| rename Computer as dest
| rename TargetUserName as user 
| table _time, dest, src_ip, user, ServiceName, Error_Code, isSuspicious 
| `suspicious_kerberos_service_ticket_request_filter`"
Suspicious microsoft workflow compiler rename,"The following analytic detects the renaming of microsoft.workflow.compiler.exe, a rarely used executable typically located in C:\Windows\Microsoft.NET\Framework64\v4.0.30319. This detection leverages Endpoint Detection and Response (EDR) data, focusing on process names and original file names. This activity is significant because renaming this executable can indicate an attempt to evade security controls. If confirmed malicious, an attacker could use this renamed executable to execute arbitrary code, potentially leading to privilege escalation or persistent access within the environment.",Windows Events,"Execution, Privilege Escalation, Defense Evasion","T1036.003, T1218, T1127","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name!=microsoft.workflow.compiler.exe AND Processes.original_file_name=Microsoft.Workflow.Compiler.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_microsoft_workflow_compiler_rename_filter`"
Suspicious msbuild path,"The following analytic detects the execution of msbuild.exe from a non-standard path. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs that deviate from typical msbuild.exe locations. This activity is significant because msbuild.exe is commonly abused by attackers to execute malicious code, and running it from an unusual path can indicate an attempt to evade detection.",Windows Events,"Execution, Defense Evasion","T1036.003, T1127.001","| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_msbuild` AND (Processes.process_path!=*\\framework*\\v*\\*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `suspicious_msbuild_path_filter`"
Suspicious MSBuild Rename,"The following analytic detects the execution of renamed instances of msbuild.exe. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names within the Endpoint data model. This activity is significant because msbuild.exe is a legitimate tool often abused by attackers to execute malicious code while evading detection.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion","T1036.003, T1127.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name!=msbuild.exe AND Processes.original_file_name=MSBuild.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_msbuild_rename_filter`"
Suspicious MSBuild Spawn,"The following analytic identifies instances where wmiprvse.exe spawns msbuild.exe, which is unusual and indicative of potential misuse of a COM object. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process relationships and command-line executions. This activity is significant because msbuild.exe is typically spawned by devenv.exe during legitimate Visual Studio use, not by wmiprvse.",Windows Events,"Execution, Defense Evasion",T1127.001,"| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=wmiprvse.exe AND `process_msbuild` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_msbuild_spawn_filter`"
Suspicious PlistBuddy Usage,"The following analytic identifies the use of the native macOS utility, PlistBuddy, to create or modify property list (.",Windows Events,"Execution, Persistence",T1543.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=PlistBuddy (Processes.process=*LaunchAgents* OR Processes.process=*RunAtLoad* OR Processes.process=*true*) by Processes.dest Processes.user Processes.parent_process Processes.process_name Processes.process Processes.process_id Processes.parent_process_id 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
|  `suspicious_plistbuddy_usage_filter`"
Suspicious Reg exe Process,"The following analytic identifies instances of reg.exe being launched from a command prompt (cmd.exe) that was not initiated by the user, as indicated by a parent process other than explorer.exe. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process names. This activity is significant because reg.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.parent_process_name != explorer.exe Processes.process_name =cmd.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| search [
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.parent_process_name=cmd.exe Processes.process_name= reg.exe by Processes.parent_process_id Processes.dest Processes.process_name 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| rename parent_process_id as process_id 
|dedup process_id
| table process_id dest] 
| `suspicious_reg_exe_process_filter`"
Suspicious Regsvr32 Register Suspicious Path,"The following analytic detects the use of Regsvr32.exe to register DLLs from suspicious paths such as AppData, ProgramData, or Windows Temp directories. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant because Regsvr32.exe can be abused to proxy execution of malicious code, bypassing traditional security controls.",Windows Events,"Lateral Movement, Execution, Exfiltration, Defense Evasion","T1218.010, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_regsvr32` Processes.process IN (""*\\appdata\\*"", ""*\\programdata\\*"",""*\\windows\\temp\\*"") NOT (Processes.process IN (""*.dll*"", ""*.ax*"", ""*.ocx*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `suspicious_regsvr32_register_suspicious_path_filter`"
Suspicious Rundll32 dllregisterserver,"The following analytic detects the execution of rundll32.exe with the DllRegisterServer command to load a DLL. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process details. This activity is significant as it may indicate an attempt to register a malicious DLL, which can be a method for code execution or persistence.",Windows Events,"Execution, Persistence, Defense Evasion","T1218, T1218.011","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*dllregisterserver* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_rundll32_dllregisterserver_filter`"
Suspicious Rundll32 PluginInit,"The following analytic identifies the execution of the rundll32.exe process with the &quot;plugininit&quot; parameter. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line arguments. This activity is significant because the &quot;plugininit&quot; parameter is commonly associated with IcedID malware, which uses it to execute an initial DLL stager to download additional payloads.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_rundll32` Processes.process=*PluginInit* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_rundll32_plugininit_filter`"
Suspicious Ticket Granting Ticket Request,The following analytic detects suspicious Kerberos Ticket Granting Ticket (TGT) requests that may indicate exploitation of CVE-2021-42278 and CVE-2021-42287. It leverages Event ID 4781 (account name change) and Event ID 4768 (TGT request) to identify sequences where a newly renamed computer account requests a TGT. This behavior is significant as it could represent an attempt to escalate privileges by impersonating a Domain Controller.,Windows Events,"Privilege Escalation, Defense Evasion",T1078.002,"`wineventlog_security` (EventCode=4781 OldTargetUserName=""*$"" NewTargetUserName!=""*$"") OR (EventCode=4768 TargetUserName!=""*$"") 
| eval RenamedComputerAccount = coalesce(NewTargetUserName, TargetUserName) 
| transaction RenamedComputerAccount startswith=(EventCode=4781) endswith=(EventCode=4768) 
| eval short_lived=case((duration<2),""TRUE"") 
| search short_lived = TRUE 
| table _time, Computer, EventCode, TargetUserName, RenamedComputerAccount, short_lived 
| rename Computer as dest 
| `suspicious_ticket_granting_ticket_request_filter`"
Suspicious writes to windows Recycle Bin,"The following analytic detects when a process other than explorer.exe writes to the Windows Recycle Bin. It leverages the Endpoint.Filesystem and Endpoint.Processes data models in Splunk to identify any process writing to the &quot;$Recycle.Bin&quot; file path, excluding explorer.exe. This activity is significant because it may indicate an attacker attempting to hide their actions, potentially leading to data theft, ransomware, or other malicious outcomes.",Windows Events,"Collection, Discovery, Defense Evasion",T1036,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.file_path) as file_path values(Filesystem.file_name) as file_name FROM datamodel=Endpoint.Filesystem where Filesystem.file_path = ""*$Recycle.Bin*"" by Filesystem.process_name Filesystem.process_id Filesystem.dest 
| `drop_dm_object_name(""Filesystem"")` 
| join  process_id [
| tstats `security_content_summariesonly` values(Processes.user) as user values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name FROM datamodel=Endpoint.Processes where Processes.process_name != ""explorer.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| table user process_name process_id dest] 
| `suspicious_writes_to_windows_recycle_bin_filter`"
System User Discovery With Query,"The following analytic detects the execution of query.exe with command-line arguments aimed at discovering logged-in users. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries may use query.exe to gain situational awareness and perform Active Directory discovery on compromised endpoints.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""query.exe"" OR Processes.original_file_name=""query.exe"") AND Processes.process=""*user*"" AND ((NOT Processes.process=""*/server*"") OR Processes.process IN (""*/server:localhost*"", ""*/server:127.0.0.1*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `system_user_discovery_with_query_filter`"
UAC Bypass With Colorui COM Object,"The following analytic detects a potential UAC bypass using the colorui.dll COM Object. It leverages Sysmon EventCode 7 to identify instances where colorui.dll is loaded by a process other than colorcpl.exe, excluding common system directories. This activity is significant because UAC bypass techniques are often used by malware, such as LockBit ransomware, to gain elevated privileges without user consent.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.003,"`sysmon` EventCode=7 ImageLoaded=""*\\colorui.dll"" process_name != ""colorcpl.exe"" NOT(Image IN(""*\\windows\\*"", ""*\\program files*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `uac_bypass_with_colorui_com_object_filter`"
Unknown Process Using The Kerberos Protocol,"The following analytic identifies a non-lsass.exe process making an outbound connection on port 88, which is typically used by the Kerberos authentication protocol. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and network traffic logs. This activity is significant because, under normal circumstances, only the lsass.exe process should interact with the Kerberos Distribution Center.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1550,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name!=lsass.exe by _time Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| join  process_id dest [
| tstats `security_content_summariesonly` count FROM datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port = 88 by All_Traffic.action All_Traffic.app All_Traffic.bytes All_Traffic.bytes_in All_Traffic.bytes_out All_Traffic.dest  All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product All_Traffic.direction All_Traffic.process_id 
| `drop_dm_object_name(All_Traffic)` 
| rename src as dest ] 
|  table _time dest parent_process_name process_name process_path process process_id dest_port 
| `unknown_process_using_the_kerberos_protocol_filter`"
Unusual Number of Kerberos Service Tickets Requested,"The following analytic identifies an unusual number of Kerberos service ticket requests, potentially indicating a kerberoasting attack. It leverages Kerberos Event 4769 and calculates the standard deviation for each host, using the 3-sigma rule to detect anomalies. This activity is significant as kerberoasting allows adversaries to request service tickets and crack them offline, potentially gaining privileged access to the domain.",Windows Events,Credential Access,"T1558.003, T1558","`wineventlog_security` EventCode=4769 ServiceName!=""*$"" TicketEncryptionType=0x17 
| bucket span=2m _time  
| stats dc(ServiceName) AS unique_services values(ServiceName) as requested_services values(user_category) as user_category values(src_category) as src_category values(dest) as dest by _time, user, src 
| eventstats avg(unique_services) as comp_avg , stdev(unique_services) as comp_std by user, src 
| eval upperBound=(comp_avg+comp_std*3)  
| eval isOutlier=if(unique_services > 2 and unique_services >= upperBound, 1, 0)  
| search isOutlier=1 
| `unusual_number_of_kerberos_service_tickets_requested_filter`"
Unusual Number of Remote Endpoint Authentication Events,"The following analytic identifies an unusual number of remote authentication attempts from a single source by leveraging Windows Event ID 4624, which logs successful account logons.",Windows Events,"Lateral Movement, Privilege Escalation, Defense Evasion",T1078,"`wineventlog_security` EventCode=4624 Logon_Type=3 Account_Name!=""*$"" 
| eval Source_Account = mvindex(Account_Name, 1) 
| bucket span=2m _time 
| stats dc(ComputerName) AS unique_targets values(ComputerName) as target_hosts by _time, Source_Network_Address, Source_Account 
| eventstats avg(unique_targets) as comp_avg , stdev(unique_targets) as comp_std by Source_Network_Address, Source_Account 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_targets >10 and unique_targets >= upperBound, 1, 0) 
| `unusual_number_of_remote_endpoint_authentication_events_filter`"
Unusually Long Command Line - MLTK,"The following analytic identifies unusually long command lines executed on hosts, which may indicate malicious activity.",Windows Events,"Execution, Exfiltration",,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| eval processlen=len(process) 
| search user!=unknown 
| apply cmdline_pdfmodel threshold=0.01 
| rename ""IsOutlier(processlen)"" as isOutlier 
| search isOutlier > 0 
| table firstTime lastTime user dest process_name process processlen count 
| `unusually_long_command_line___mltk_filter`"
User Discovery With Env Vars PowerShell,"The following analytic detects the execution of powershell.exe with command-line arguments that use PowerShell environment variables to identify the current logged user. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries may use it for situational awareness and Active Directory discovery on compromised endpoints.",Windows Events,"Lateral Movement, Execution, Discovery",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""powershell.exe"") (Processes.process=""*$env:UserName*"" OR Processes.process=""*[System.Environment]::UserName*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `user_discovery_with_env_vars_powershell_filter`"
Wbemprox COM Object Execution,"The following analytic detects a suspicious process loading a COM object from wbemprox.dll, fastprox.dll, or wbemcomn.dll. It leverages Sysmon EventCode 7 to identify instances where these DLLs are loaded by processes not typically associated with them, excluding known legitimate processes and directories. This activity is significant as it may indicate an attempt by threat actors to abuse COM objects for privilege escalation or evasion of detection mechanisms.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1218.003,"`sysmon` EventCode=7  ImageLoaded IN (""*\\fastprox.dll"", ""*\\wbemprox.dll"", ""*\\wbemcomn.dll"") NOT (process_name IN (""wmiprvse.exe"", ""WmiApSrv.exe"", ""unsecapp.exe"")) NOT(Image IN(""*\\windows\\*"",""*\\program files*"", ""*\\wbem\\*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wbemprox_com_object_execution_filter`"
Web Servers Executing Suspicious Processes,The following analytic detects the execution of suspicious processes on systems identified as web servers.,Windows Events,"Discovery, Execution, Persistence, Exfiltration",T1082,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.dest_category=""web_server"" AND (Processes.process=""*whoami*"" OR Processes.process=""*ping*"" OR Processes.process=""*iptables*"" OR Processes.process=""*wget*"" OR Processes.process=""*service*"" OR Processes.process=""*curl*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `web_servers_executing_suspicious_processes_filter`"
Windows Access Token Manipulation Winlogon Duplicate Token Handle,"The following analytic detects a process attempting to access winlogon.exe to duplicate its handle. This is identified using Sysmon EventCode 10, focusing on processes targeting winlogon.exe with specific access rights. This activity is significant because it is a common technique used by adversaries to escalate privileges by leveraging the high privileges and security tokens associated with winlogon.",Windows Events,Defense Evasion,"T1134, T1134.001","`sysmon` EventCode=10 TargetImage IN(""*\\system32\\winlogon.exe*"", ""*\\SysWOW64\\winlogon.exe*"") GrantedAccess = 0x1040 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_access_token_manipulation_winlogon_duplicate_token_handle_filter`"
Windows Account Access Removal via Logoff Exec,"The following analytic detects the process of logging off a user through the use of the quser and logoff commands. By monitoring for these commands, the analytic identifies actions where a user session is forcibly terminated, which could be part of an administrative task or a potentially unauthorized access attempt. This detection helps identify potential misuse or malicious activity where a userâ€™s access is revoked without proper authorization, providing insight into potential security incidents involving account management or session manipulation.",Windows Events,"Execution, Impact","T1059.001, T1531","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = logoff.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_account_access_removal_via_logoff_exec_filter`"
Windows AD Abnormal Object Access Activity,"The following analytic identifies a statistically significant increase in access to Active Directory objects, which may indicate attacker enumeration. It leverages Windows Security Event Code 4662 to monitor and analyze access patterns, comparing them against historical averages to detect anomalies. This activity is significant for a SOC because abnormal access to AD objects can be an early indicator of reconnaissance efforts by an attacker.",Windows Events,"Discovery, Privilege Escalation",T1087.002,"`wineventlog_security` EventCode=4662 
| stats min(_time) AS firstTime, max(_time) AS lastTime, dc(ObjectName) AS ObjectName_count, values(ObjectType) AS ObjectType, latest(Computer) AS dest count BY SubjectUserName 
| eventstats avg(ObjectName_count) AS average stdev(ObjectName_count) AS standarddev 
| eval limit = round((average+(standarddev*3)),0), user = SubjectUserName 
| where ObjectName_count > limit 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_ad_abnormal_object_access_activity_filter`"
Windows AD AdminSDHolder ACL Modified,"The following analytic detects modifications to the Access Control List (ACL) of the AdminSDHolder object in a Windows domain, specifically the addition of new rules. It leverages EventCode 5136 from the Security Event Log, focusing on changes to the nTSecurityDescriptor attribute. This activity is significant because the AdminSDHolder object secures privileged group members, and unauthorized changes can allow attackers to establish persistence and escalate privileges.",Windows Events,"Execution, Persistence",T1546,"`wineventlog_security` EventCode=5136 ObjectClass=container ObjectDN=""CN=AdminSDHolder,CN=System*""  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace 
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);(?P<aceInheritedTypeGuid>.*?);(?P<aceSid>.*?)$"" 
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUTNEW builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats min(_time) as _time values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(SubjectLogonId) as SubjectLogonId by ObjectClass ObjectDN src_user user 
| eval aceControlAccessRights=if(mvcount(aceControlAccessRights)=1 AND aceControlAccessRights="""",""All rights"",'aceControlAccessRights') 
| search NOT aceType IN (*denied*,D,OD,XD) AND aceAccessRights IN (""Full control"",""All extended rights"",""All validated writes"",""Create all child objects"",""Delete all child objects"",""Delete subtree"",""Delete"",""Modify permissions"",""Modify owner"",""Write all properties"",CC,CR,DC,DT,SD,SW,WD,WO,WP) 
| `windows_ad_adminsdholder_acl_modified_filter`"
Windows AD Cross Domain SID History Addition,"The following analytic detects changes to the sIDHistory attribute of user or computer objects across different domains. It leverages Windows Security Event Codes 4738 and 4742 to identify when the sIDHistory attribute is modified. This activity is significant because the sIDHistory attribute allows users to inherit permissions from other AD accounts, which can be exploited by adversaries for inter-domain privilege escalation and persistence.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion",T1134.005,"`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory IN (""%%1793"", -) 
| rex field=SidHistory ""(^%{
|^)(?P<SidHistoryMatch>.*)(\-
|\\\)"" 
| rex field=TargetSid ""^(?P<TargetSidmatch>.*)(\-
|\\\)"" 
| where SidHistoryMatch!=TargetSidmatch AND SidHistoryMatch!=TargetDomainName 
| rename TargetSid as userSid 
| table _time action status host user userSid SidHistory Logon_ID src_user dest 
| `windows_ad_cross_domain_sid_history_addition_filter`"
Windows AD Domain Replication ACL Addition,"The following analytic detects the addition of permissions required for a DCSync attack, specifically DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, and DS-Replication-Get-Changes-In-Filtered-Set. It leverages EventCode 5136 from the Windows Security Event Log to identify when these permissions are granted. This activity is significant because it indicates potential preparation for a DCSync attack, which can be used to replicate AD objects and exfiltrate sensitive data.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion",T1484,"`wineventlog_security` EventCode=5136 ObjectClass=domainDNS  
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId  
| rex field=old_value max_match=10000 ""\((?P<old_values>.*?)\)""  
| rex field=new_value max_match=10000 ""\((?P<new_ace>.*?)\)""  
| mvexpand new_ace 
| where NOT new_ace IN (old_values)  
| rex field=new_ace ""(?P<aceType>.*?);(?P<aceFlags>.*?);(?P<aceAccessRights>.*?);(?P<aceObjectGuid>.*?);;(?P<aceSid>.*?)$"" 
| search aceObjectGuid IN (""1131f6aa-9c07-11d1-f79f-00c04fc2dcd2"",""1131f6ad-9c07-11d1-f79f-00c04fc2dcd2"",""89e95b76-444d-4c62-991a-0facbeda640c"") 
| rex max_match=100 field=aceAccessRights ""(?P<AccessRights>[A-Z]{2})""  
| rex max_match=100 field=aceFlags ""(?P<aceFlags>[A-Z]{2})""  
| lookup msad_guid_lookup guid as aceObjectGuid OUTPUT displayName as ControlAccessRights 
| lookup ace_access_rights_lookup access_rights_string as AccessRights OUTPUT access_rights_value  
| lookup ace_type_lookup ace_type_string as aceType OUTPUT ace_type_value  
| lookup ace_flag_lookup flag_string as aceFlags OUTPUT flag_value as ace_flag_value ``` Optional SID resolution lookups 
| lookup identity_lookup_expanded objectSid as aceSid OUTPUT downLevelDomainName as user  
| lookup admon_groups_def objectSid as aceSid OUTPUT cn as group ``` 
| lookup builtin_groups_lookup builtin_group_string  as aceSid OUTPUT builtin_group_name as builtin_group 
| eval aceType=coalesce(ace_type_value,aceType), aceFlags=coalesce(ace_flag_value,""This object only""), aceAccessRights=if(aceAccessRights=""CCDCLCSWRPWPDTLOCRSDRCWDWO"",""Full control"",coalesce(access_rights_value,AccessRights)), aceControlAccessRights=coalesce(ControlAccessRights,aceObjectGuid), user=coalesce(user, group, builtin_group, aceSid) 
| stats min(_time) as _time values(aceType) as aceType values(aceFlags) as aceFlags(inheritance) values(aceControlAccessRights) as aceControlAccessRights values(aceAccessRights) as aceAccessRights values(new_ace) as new_ace values(SubjectLogonId) as SubjectLogonId by ObjectClass ObjectDN src_user user dest 
| search (aceControlAccessRights=""DS-Replication-Get-Changes"" AND aceControlAccessRights=""DS-Replication-Get-Changes-All"") OR (aceControlAccessRights=""1131f6aa-9c07-11d1-f79f-00c04fc2dcd2"" AND aceControlAccessRights=""1131f6ad-9c07-11d1-f79f-00c04fc2dcd2"") 
| `windows_ad_domain_replication_acl_addition_filter`"
Windows AD GPO New CSE Addition,"This detection identifies when a a new client side extension is added to an Active Directory Group Policy using the Group Policy Management Console.
Search 1`wineventlog_security` EventCode=5136 ObjectClass=groupPolicyContainer AttributeLDAPDisplayName=gPCMachineExtensionNames 2| stats min(_time) as _time values(eval(if(OperationType==&#34;%%14675&#34;,AttributeValue,null))) as old_value values(eval(if(OperationType==&#34;%%14674&#34;,AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 3| rex field=old_value max_match=10000 &#34;(?",Windows Events,"Persistence, Defense Evasion","T1484.001, T1222.001","`wineventlog_security` EventCode=5136 ObjectClass=groupPolicyContainer AttributeLDAPDisplayName=gPCMachineExtensionNames 
| stats min(_time) as _time values(eval(if(OperationType==""%%14675"",AttributeValue,null))) as old_value values(eval(if(OperationType==""%%14674"",AttributeValue,null))) as new_value values(OperationType) as OperationType values(dest) as dest by ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId 
| rex field=old_value max_match=10000 ""(?P<old_values>\{.*?\})"" 
| rex field=new_value max_match=10000 ""(?P<new_values>\{.*?\})"" 
| rex field=ObjectDN max_match=10000 ""CN=(?P<policy_guid>\{.*?\})"" 
| mvexpand new_values 
| where NOT new_values IN (old_values,""{00000000-0000-0000-0000-000000000000}"",policy_guid) AND match(new_values, ""^\{[A-Z
|\d]+\-[A-Z
|\d]+\-[A-Z
|\d]+\-[A-Z
|\d]+\-[A-Z
|\d]+\}"") 
| lookup msad_guid_lookup guid as new_values OUTPUTNEW displayName as policyType 
| eval newPolicy=if(policyType like ""%"",policyType,new_values) 
| join ObjectDN  [
| search `admon` objectCategory=""CN=Group-Policy-Container*"" admonEventType=Update 
| stats latest(displayName) as displayName by distinguishedName 
| eval ObjectDN=upper(distinguishedName)] 
| stats values(OpCorrelationID) as OpCorrelationID values(src_user) as src_user values(SubjectLogonId) as SubjectLogonId values(newPolicy) as newPolicy values(displayName) as policyName by ObjectDN 
| `windows_ad_gpo_new_cse_addition_filter`"
Windows AD Privileged Account SID History Addition,"The following analytic identifies when the SID of a privileged user is added to the SID History attribute of another user. It leverages Windows Security Event Codes 4742 and 4738, combined with identity lookups, to detect this activity. This behavior is significant as it may indicate an attempt to abuse SID history for unauthorized access across multiple domains.",Windows Events,"Persistence, Defense Evasion",T1134.005,"`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory IN (""%%1793"", -) 
| rex field=SidHistory ""(^%{
|^)(?P<SidHistory>.*?)(}$
|$)"" 
| eval category=""privileged"" 
| lookup identity_lookup_expanded category, identity as SidHistory OUTPUT identity_tag as match 
| where isnotnull(match) 
| rename TargetSid as userSid 
| table _time action status host user userSid SidHistory Logon_ID src_user dest 
| `windows_ad_privileged_account_sid_history_addition_filter`"
Windows AD Privileged Object Access Activity,"The following analytic detects access attempts to privileged Active Directory objects, such as Domain Admins or Enterprise Admins. It leverages Windows Security Event Code 4662 to identify when these sensitive objects are accessed. This activity is significant because such objects should rarely be accessed by normal users or processes, and unauthorized access attempts may indicate attacker enumeration or lateral movement within the domain.",Windows Events,"Lateral Movement, Discovery",T1087.002,"`wineventlog_security` EventCode=4662 ObjectName IN ( ""CN=Account Operators,*"", ""CN=Administrators,*"", ""CN=Backup Operators,*"", ""CN=Cert Publishers,*"", ""CN=Certificate Service DCOM Access,*"", ""CN=Domain Admins,*"", ""CN=Domain Controllers,*"", ""CN=Enterprise Admins,*"", ""CN=Enterprise Read-only Domain Controllers,*"", ""CN=Group Policy Creator Owners,*"", ""CN=Incoming Forest Trust Builders,*"", ""CN=Microsoft Exchange Servers,*"", ""CN=Network Configuration Operators,*"", ""CN=Power Users,*"", ""CN=Print Operators,*"", ""CN=Read-only Domain Controllers,*"", ""CN=Replicators,*"", ""CN=Schema Admins,*"", ""CN=Server Operators,*"", ""CN=Exchange Trusted Subsystem,*"", ""CN=Exchange Windows Permission,*"", ""CN=Organization Management,*"") 
| rex field=ObjectName ""CN\=(?<object_name>[^,]+)"" 
| stats values(Computer) as dest, values(object_name) as object_name, dc(ObjectName) as object_count, min(_time) as firstTime, max(_time) as lastTime, count by SubjectUserName 
| rename SubjectUserName as user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_ad_privileged_object_access_activity_filter`"
Windows AD Short Lived Server Object,"The following analytic identifies the creation and quick deletion of a Domain Controller (DC) object within 30 seconds in an Active Directory environment, indicative of a potential DCShadow attack. This detection leverages Windows Security Event Codes 5137 and 5141, analyzing the duration between these events. This activity is significant as DCShadow allows attackers with privileged access to register a rogue DC, enabling unauthorized changes to AD objects, including credentials.",Windows Events,"Persistence, Defense Evasion",T1207,"`wineventlog_security` EventCode=5137 OR EventCode=5141 ObjectDN=""*CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration*"" 
| transaction ObjectDN startswith=(EventCode=5137) endswith=(EventCode=5141) 
| eval short_lived=case((duration<30),""TRUE"") 
| search short_lived = TRUE 
| stats values(ObjectDN) values(signature) values(EventCode) by _time, Computer, SubjectUserName, dest 
| `windows_ad_short_lived_server_object_filter`"
Windows AD SID History Attribute Modified,"The following analytic detects modifications to the SID History attribute in Active Directory by leveraging event code 5136. This detection uses logs from the wineventlog_security data source to identify changes to the sIDHistory attribute. Monitoring this activity is crucial as the SID History attribute can be exploited by adversaries to inherit permissions from other accounts, potentially granting unauthorized access.",Windows Events,"Persistence, Defense Evasion",T1134.005,"`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=sIDHistory OperationType=""%%14674"" 
| stats values(ObjectDN) as ObjectDN by _time, Computer, SubjectUserName, AttributeValue 
| rename Computer as dest 
| `windows_ad_sid_history_attribute_modified_filter`"
Windows AD Suspicious Attribute Modification,"This detection monitors changes to the following Active Directory attributes: &quot;msDS-AllowedToDelegateTo&quot;, &quot;msDS-AllowedToActOnBehalfOfOtherIdentity&quot;, &quot;msDS-KeyCredentialLink&quot;, &quot;scriptPath&quot;, and &quot;msTSInitialProgram&quot;. Modifications to these attributes can indicate potential malicious activity or privilege escalation attempts. Immediate investigation is recommended upon alert.
Search 1`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName IN (&#34;msDS-AllowedToDelegateTo&#34;,&#34;msDS-AllowedToActOnBehalfOfOtherIdentity&#34;,&#34;scriptPath&#34;,&#34;msTSInitialProgram&#34;) OperationType=%%14674 ```Changes to the attribute &#34;msDS-KeyCredentialLink&#34; are also worth moniroting, however tuning will need to be applied``` 2| table _time ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId DSName AttributeValue AttributeLDAPDisplayName 3| rename SubjectLogonId as TargetLogonId, src_user as initiator, _time as eventTime 4| appendpipe [ 5| map search=&#34;search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$&#34;] 6| stats min(eventTime) as _time values(initiator) as src_user, values(DSName) as targetDomain, values(ObjectDN) as ObjectDN, values(ObjectClass) as ObjectClass, values(src_category) as src_category, values(src_ip) as src_ip values(LogonType) as LogonType values(AttributeValue) as AttributeValue values(AttributeLDAPDisplayName) as AttributeLDAPDisplayName by TargetLogonId 7| rex field=ObjectDN &#34;^CN=(?",Windows Events,"Discovery, Persistence, Privilege Escalation, Defense Evasion","T1550, T1222.001","`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName IN (""msDS-AllowedToDelegateTo"",""msDS-AllowedToActOnBehalfOfOtherIdentity"",""scriptPath"",""msTSInitialProgram"") OperationType=%%14674  ```Changes to the attribute ""msDS-KeyCredentialLink"" are also worth moniroting, however tuning will need to be applied``` 
| table _time ObjectClass ObjectDN OpCorrelationID src_user SubjectLogonId DSName AttributeValue AttributeLDAPDisplayName  
| rename SubjectLogonId as TargetLogonId, src_user as initiator, _time as eventTime  
| appendpipe [
| map search=""search `wineventlog_security` EventCode=4624 TargetLogonId=$TargetLogonId$""]  
| stats min(eventTime) as _time values(initiator) as src_user, values(DSName) as targetDomain, values(ObjectDN) as ObjectDN, values(ObjectClass) as ObjectClass, values(src_category) as src_category, values(src_ip) as src_ip values(LogonType) as LogonType values(AttributeValue) as AttributeValue values(AttributeLDAPDisplayName) as AttributeLDAPDisplayName by TargetLogonId  
| rex field=ObjectDN ""^CN=(?P<cn>.*?),[A-Z]{2}\=""  
| eval dest=if(ObjectClass=""computer"",cn,null), user=if(ObjectClass=""user"",cn,null) 
| fields - cn 
| `windows_ad_suspicious_attribute_modification_filter`"
Windows Admin Permission Discovery,"The following analytic identifies the creation of a suspicious file named 'win.dat' in the root directory (C:). It leverages data from the Endpoint.Filesystem datamodel to detect this activity. This behavior is significant as it is commonly used by malware like NjRAT to check for administrative privileges on a compromised host. If confirmed malicious, this activity could indicate that the malware has administrative access, allowing it to perform high-privilege actions, potentially leading to further system compromise and persistence.",Windows Events,"Persistence, Discovery",T1069.001,"|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.exe"", ""*.dll"", ""*.sys"", ""*.com"", ""*.vbs"", ""*.vbe"", ""*.js"", ""*.bat"", ""*.cmd"", ""*.pif"", ""*.lnk"", ""*.dat"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| eval dropped_file_path = split(file_path, ""\\"") 
| eval dropped_file_path_split_count = mvcount(dropped_file_path) 
| eval root_drive = mvindex(dropped_file_path,0) 
| where LIKE(root_drive, ""C:"") AND dropped_file_path_split_count = 2 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_admin_permission_discovery_filter`"
Windows Administrative Shares Accessed On Multiple Hosts,"The following analytic detects a source computer accessing Windows administrative shares (C$, Admin$, IPC$) on 30 or more remote endpoints within a 5-minute window. It leverages Event IDs 5140 and 5145 from file share events. This behavior is significant as it may indicate an adversary enumerating network shares to locate sensitive files, a common tactic used by threat actors.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1135,"`wineventlog_security` EventCode=5140 OR EventCode=5145 (ShareName=""\\\\*\\ADMIN$"" OR ShareName=""\\\\*\\IPC$"" OR ShareName=""\\\\*\\C$"") 
| bucket span=5m _time 
| stats dc(Computer) AS unique_targets values(Computer) as host_targets values(ShareName) as shares values(dest) as dest by _time, IpAddress, SubjectUserName, EventCode 
| where unique_targets > 30 
| `windows_administrative_shares_accessed_on_multiple_hosts_filter`"
Windows Alternate DataStream - Process Execution,"The following analytic detects when a process attempts to execute a file from within an NTFS file system alternate data stream. This detection leverages process execution data from sources like Windows process monitoring or Sysmon Event ID 1, focusing on specific processes known for such behavior. This activity is significant because alternate data streams can be used by threat actors to hide malicious code, making it difficult to detect.",Windows Events,"Execution, Defense Evasion",T1564.004,"| tstats count min(_time) as firstTime max(_time) as lastTime values(Processes.process_current_directory) as directory from datamodel=Endpoint.Processes where Processes.parent_process_name != ""unknown"" Processes.process_name IN (""appvlp.exe"",""bitsadmin.exe"",""control.exe"",""cscript.exe"",""forfiles.exe"",""ftp.exe"",""mavinject.exe"",""mshta.exe"",""powershell.exe"",""powershell_ise.exe"",""pwsh.exe"",""regini.exe"",""regscr32.exe"",""rundll32.exe"",""sc.exe"",""wmic.exe"",""wscript.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| regex process=""(\b)\w+(\.\w+)?:\w+(\.\w{2,4})(?!\.)(\b
|\s
|&)"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_alternate_datastream___process_execution_filter`"
Windows Apache Benchmark Binary,"The following analytic detects the execution of the Apache Benchmark binary (ab.exe), commonly used by MetaSploit payloads. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where the original file name is ab.exe. This activity is significant as it may indicate the presence of a MetaSploit attack, which uses Apache Benchmark to generate malicious payloads.",Windows Events,"Execution, Exfiltration",T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.original_file_name=ab.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_apache_benchmark_binary_filter`"
Windows Application Layer Protocol RMS Radmin Tool Namedpipe,The following analytic detects the use of default or publicly known named pipes associated with the RMX remote admin tool. It leverages Sysmon EventCodes 17 and 18 to identify named pipe creation and connection events. This activity is significant as the RMX tool has been abused by adversaries and malware like Azorult to collect data from targeted hosts.,Windows Events,"Command And Control, Execution, Exfiltration",T1071,"`sysmon` EventCode IN (17, 18) EventType IN ( ""CreatePipe"", ""ConnectPipe"") PipeName IN (""\\RManFUSServerNotify32"", ""\\RManFUSCallbackNotify32"", ""\\RMSPrint*"") 
| stats  min(_time) as firstTime max(_time) as lastTime count by dest dvc pipe_name process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product Image PipeName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_application_layer_protocol_rms_radmin_tool_namedpipe_filter`"
Windows AppLocker Block Events,"The following analytic detects attempts to bypass application restrictions by identifying Windows AppLocker policy violations. It leverages Windows AppLocker event logs, specifically EventCodes 8007, 8004, 8022, 8025, 8029, and 8040, to pinpoint blocked actions. This activity is significant for a SOC as it highlights potential unauthorized application executions, which could indicate malicious intent or policy circumvention.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218,"`applocker`  EventCode IN (8007, 8004, 8022, 8025, 8029, 8040) 
| spath input=UserData_Xml 
| rename RuleAndFileData.* as *, TargetUser as user, Computer as dest  
| stats count min(_time) as firstTime max(_time) as lastTime by dest, PolicyName, RuleId, user, TargetProcessId, FilePath, FullFilePath, EventCode 
| lookup applockereventcodes EventCode OUTPUT Description 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_applocker_block_events_filter`"
Windows AppLocker Execution from Uncommon Locations,"The following analytic identifies the execution of applications or scripts from uncommon or suspicious file paths, potentially indicating malware or unauthorized activity. It leverages Windows AppLocker event logs and uses statistical analysis to detect anomalies. By calculating the average and standard deviation of execution counts per file path, it flags paths with execution counts significantly higher than expected.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1218,"`applocker` 
| spath input=UserData_Xml 
| rename RuleAndFileData.* as *, Computer as dest, TargetUser AS user 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, PolicyName, RuleId, user, TargetProcessId, FilePath, FullFilePath 
| eventstats avg(count) as avg, stdev(count) as stdev 
| eval upperBound=(avg+stdev*2), anomaly=if(count > upperBound, ""Yes"", ""No"") 
| where anomaly=""Yes"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_applocker_execution_from_uncommon_locations_filter`"
Windows AppLocker Privilege Escalation via Unauthorized Bypass,"The following analytic utilizes Windows AppLocker event logs to identify attempts to bypass application restrictions. AppLocker is a feature that allows administrators to specify which applications are permitted to run on a system. This analytic is designed to identify attempts to bypass these restrictions, which could be indicative of an attacker attempting to escalate privileges.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1218,"`applocker` EventCode IN (8007, 8004, 8022, 8025, 8029, 8040) 
| spath input=UserData_Xml 
| rename RuleAndFileData.* as *, Computer as dest, TargetUser AS user 
| stats count AS attempt_count min(_time) as firstTime max(_time) as lastTime by dest, PolicyName, RuleId, user, TargetProcessId, FilePath, FullFilePath, EventCode 
| where attempt_count > 5 
| sort - attempt_count 
| lookup applockereventcodes EventCode OUTPUT Description 
| `windows_applocker_privilege_escalation_via_unauthorized_bypass_filter`"
Windows AppLocker Rare Application Launch Detection,"The following analytic detects the launch of rarely used applications within the environment, which may indicate the use of potentially malicious software or tools by attackers. It leverages Windows AppLocker event logs, aggregating application launch counts over time and flagging those that significantly deviate from the norm. This behavior is significant as it helps identify unusual application activity that could signal a security threat.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1218,"`applocker` 
| spath input=UserData_Xml 
| rename RuleAndFileData.* as *, Computer as dest, TargetUser AS user 
| stats dc(_time) as days, count by FullFilePath dest user 
| eventstats avg(count) as avg, stdev(count) as stdev 
| eval upperBound=(avg+stdev*3), lowerBound=(avg-stdev*3) 
| where count > upperBound OR count < lowerBound 
| `windows_applocker_rare_application_launch_detection_filter`"
Windows Audit Policy Disabled via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/set&quot; command-line argument in order to disable a specific category or sub-category from the audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1562.002, T1562","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/set*"" Processes.process IN (""*/success:*"", ""*/failure:*"") Processes.process=""*disable*"" AND NOT Processes.process IN (""*/?*"", ""*/exclude*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_disabled_via_auditpol_filter`"
Windows Audit Policy Disabled via Legacy Auditpol,"The following analytic identifies the execution of the legacy auditpol.exe included with the Windows 2000 Resource Kit Tools, with the &quot;/disable&quot; command-line argument or one of the allowed category flags and the &quot;none&quot; option, in order to disable a specific logging category from the audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1562.002, T1562","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (`process_auditpol` Processes.process=""*/disable"") OR Processes.process IN (""*/system:none*"", ""*/logon:none*"", ""*/object:none*"", ""*/privilege:none*"", ""*/process:none*"", ""*/policy:none*"", ""*/sam:none*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_disabled_via_legacy_auditpol_filter`"
Windows Audit Policy Excluded Category via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/set&quot; and &quot;/exclude&quot; command-line arguments which indicates that the user's per-user policy will cause audit to be suppressed regardless of the system audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to exclude specific users events from log data.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1562.002, T1562","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/set*"" Processes.process=""*/exclude*"" AND NOT Processes.process=""*/?*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_excluded_category_via_auditpol_filter`"
Windows Audit Policy Restored via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/restore&quot; command-line argument used to restore the audit policy from a file. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Defense Evasion","T1562.002, T1562","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/restore*"" Processes.process=""*/file*"" AND NOT Processes.process=""*/?*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_restored_via_auditpol_filter`"
Windows Audit Policy Security Descriptor Tampering via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/set&quot; flag, and &quot;/sd&quot; command-line arguments used to modify the security descriptor of the audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1562.002,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/set*"" Processes.process=""*/sd:*"" AND NOT Processes.process=""*/?*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_audit_policy_security_descriptor_tampering_via_auditpol_filter`"
Windows Autostart Execution LSASS Driver Registry Modification,"The following analytic detects modifications to undocumented registry keys that allow a DLL to load into lsass.exe, potentially capturing credentials. It leverages the Endpoint.Registry data model to identify changes to \CurrentControlSet\Services\NTDS\DirectoryServiceExtPt or \CurrentControlSet\Services\NTDS\LsaDbExtPt. This activity is significant as it indicates a possible attempt to inject malicious code into the Local Security Authority Subsystem Service (LSASS), which can lead to credential theft.",Windows Events,"Execution, Persistence",T1547.008,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\CurrentControlSet\\Services\\NTDS\\DirectoryServiceExtPt"",""*\\CurrentControlSet\\Services\\NTDS\\LsaDbExtPt"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_autostart_execution_lsass_driver_registry_modification_filter`"
Windows Binary Proxy Execution Mavinject DLL Injection,"The following analytic detects the use of mavinject.exe for DLL injection into running processes, identified by specific command-line parameters such as /INJECTRUNNING and /HMODULE. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because it indicates potential arbitrary code execution, a common tactic for malware deployment and persistence.",Windows Events,"Execution, Persistence, Defense Evasion","T1218, T1218.013","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=mavinject.exe Processes.process IN (""*injectrunning*"", ""*hmodule=0x*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_binary_proxy_execution_mavinject_dll_injection_filter`"
Windows BitLocker Suspicious Command Usage,"This analytic is developed to detect the usage of BitLocker commands used to disable or impact boot settings. The malware ShrinkLocker uses various commands change how BitLocker handles encryption, potentially bypassing TPM requirements, enabling BitLocker without TPM, and enforcing specific startup key and PIN configurations. Such modifications can weaken system security, making it easier for unauthorized access and data breaches.",Windows Events,"Execution, Impact","T1490, T1486","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes 
where Processes.process_name = manage-bde.exe AND Processes.process IN (""* -protectors -disable *"",""* -protectors -delete *"",""* -forcerecovery *"",""* -lock *"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name 
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash 
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path 
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_bitlocker_suspicious_command_usage_filter`"
Windows BitLockerToGo Process Execution,"The following analytic detects BitLockerToGo.exe execution, which has been observed being abused by Lumma stealer malware. The malware leverages this legitimate Windows utility to manipulate registry keys, search for cryptocurrency wallets and credentials, and exfiltrate sensitive data. This activity is significant because BitLockerToGo.exe provides functionality for viewing, copying, and writing files as well as modifying registry branches - capabilities that the Lumma stealer exploits.",Windows Events,"Execution, Defense Evasion",T1218,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=bitlockertogo.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_bitlockertogo_process_execution_filter`"
Windows BootLoader Inventory,The following analytic identifies the bootloader paths on Windows endpoints.,Windows Events,"Execution, Persistence, Defense Evasion",T1542.001,"`bootloader_inventory` 
| stats count min(_time) as firstTime max(_time) as lastTime values(_raw) by host 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_bootloader_inventory_filter`"
Windows Bypass UAC via Pkgmgr Tool,"The following analytic detects the execution of the deprecated 'pkgmgr.exe' process with an XML input file, which is unusual and potentially suspicious. This detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process execution details and command-line arguments. The significance lies in the deprecated status of 'pkgmgr.exe' and the use of XML files, which could indicate an attempt to bypass User Account Control (UAC).",Windows Events,"Execution, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where  Processes.process_name = pkgmgr.exe Processes.process = ""*.xml*"" NOT(Processes.parent_process_path IN(""*:\\windows\\system32\\*"", ""*:\\windows\\syswow64\\*"", ""*:\\Program Files*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_bypass_uac_via_pkgmgr_tool_filter`"
Windows Cisco Secure Endpoint Stop Immunet Service Via Sfc,"The following analytic detects the use of the sfc.exe utility, in order to stop the Immunet Protect service. The Sfc.exe utility is part of Cisco Secure Endpoint installation. This detection leverages telemetry from the endpoint, focusing on command-line executions involving the -k parameter. This activity is significant as it indicates potential tampering with defensive mechanisms.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""sfc.exe"" Processes.process=""* -k*"" AND NOT Processes.process_path IN (""*:\\Windows\\System32\\*"", ""*:\\Windows\\SysWOW64\\*"", "":\\Windows\\WinSxS\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cisco_secure_endpoint_stop_immunet_service_via_sfc_filter`"
Windows Cisco Secure Endpoint Unblock File Via Sfc,"The following analytic detects the use of the sfc.exe utility with the &quot;-unblock&quot; parameter, a feature within Cisco Secure Endpoint. The &quot;-unblock&quot; flag is used to remove system blocks imposed by the endpoint protection. This detection focuses on command-line activity that includes the &quot;-unblock&quot; parameter, as it may indicate an attempt to restore access to files or processes previously blocked by the security software.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""sfc.exe"" Processes.process=""* -unblock *"" AND NOT Processes.process_path IN (""*:\\Windows\\System32\\*"", ""*:\\Windows\\SysWOW64\\*"", "":\\Windows\\WinSxS\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cisco_secure_endpoint_unblock_file_via_sfc_filter`"
Windows Cisco Secure Endpoint Uninstall Immunet Service Via Sfc,"The following analytic detects the use of the sfc.exe utility with the &quot;-u&quot; parameter, which is part of the Cisco Secure Endpoint installation. The &quot;-u&quot; flag allows the uninstallation of Cisco Secure Endpoint components. This detection leverages endpoint telemetry to monitor command-line executions that include the &quot;-u&quot; parameter. The use of this flag is significant as it could indicate an attempt to disable or remove endpoint protection, potentially leaving the system vulnerable to further exploitation.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""sfc.exe"" Processes.process=""* -u*"" NOT Processes.process=""* -unblock *"" AND NOT Processes.process_path IN (""*:\\Windows\\System32\\*"", ""*:\\Windows\\SysWOW64\\*"", "":\\Windows\\WinSxS\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_cisco_secure_endpoint_uninstall_immunet_service_via_sfc_filter`"
Windows COM Hijacking InprocServer32 Modification,"The following analytic detects the modification of the InProcServer32 registry key by reg.exe, indicative of potential COM hijacking. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line execution logs. COM hijacking is significant as it allows adversaries to insert malicious code that executes in place of legitimate software, providing a means for persistence.",Windows Events,"Execution, Persistence","T1546.015, T1546","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` Processes.process=*inprocserver32* by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_com_hijacking_inprocserver32_modification_filter`"
Windows Command and Scripting Interpreter Path Traversal Exec,"The following analytic detects path traversal command-line execution, often used in malicious documents to execute code via msdt.exe for defense evasion. It leverages Endpoint Detection and Response (EDR) data, focusing on specific patterns in process paths. This activity is significant as it can indicate an attempt to bypass security controls and execute unauthorized code.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where NOT Processes.os=""Linux"" Processes.process=""*\/..\/..\/..\/*"" OR Processes.process=""*\\..\\..\\..\\*"" OR Processes.process=""*\/\/..\/\/..\/\/..\/\/*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_command_and_scripting_interpreter_path_traversal_exec_filter`"
Windows Computer Account Created by Computer Account,"The following analytic identifies a computer account creating a new computer account with a specific Service Principal Name (SPN) &quot;RestrictedKrbHost&quot;. This detection leverages Windows Security Event Logs, specifically EventCode 4741, to identify such activities. This behavior is significant as it may indicate an attempt to establish unauthorized Kerberos authentication channels, potentially leading to lateral movement or privilege escalation.",Windows Events,"Lateral Movement, Persistence, Credential Access, Privilege Escalation",T1558,"`wineventlog_security` EventCode=4741 user_type=computer SubjectDomainName!=""NT AUTHORITY"" ServicePrincipalNames=*RestrictedKrbHost* 
| stats  count min(_time) as firstTime max(_time) as lastTime by dest, subject, action ,src_user, user, user_type, SubjectUserName,SubjectDomainName 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_computer_account_created_by_computer_account_filter`"
Windows Computer Account Requesting Kerberos Ticket,"The following analytic detects a computer account requesting a Kerberos ticket, which is unusual as typically user accounts request these tickets. This detection leverages Windows Security Event Logs, specifically EventCode 4768, to identify instances where the TargetUserName ends with a dollar sign ($), indicating a computer account. This activity is significant because it may indicate the use of tools like KrbUpRelay or other Kerberos-based attacks.",Windows Events,"Lateral Movement, Credential Access, Privilege Escalation",T1558,"`wineventlog_security`  EventCode=4768 TargetUserName=""*$""  src_ip!=""::1"" 
| stats  count min(_time) as firstTime max(_time) as lastTime by dest, subject, action, user, TargetUserName, src_ip 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_computer_account_requesting_kerberos_ticket_filter`"
Windows Computer Account With SPN,"The following analytic detects the addition of Service Principal Names (SPNs) HOST and RestrictedKrbHost to a computer account, indicative of KrbRelayUp behavior. This detection leverages Windows Security Event Logs, specifically EventCode 4741, to identify changes in SPNs. This activity is significant as it is commonly associated with Kerberos-based attacks, which can be used to escalate privileges or perform lateral movement within a network.",Windows Events,"Lateral Movement, Credential Access, Privilege Escalation",T1558,"`wineventlog_security` EventCode=4741 NewUacValue=""0x80"" ServicePrincipalNames IN (""*HOST/*"",""*RestrictedKrbHost/*"") 
| stats count min(_time) as firstTime max(_time) as lastTime values(EventCode),values(TargetDomainName),values(PrimaryGroupId), values(OldUacValue), values(NewUacValue),values(SamAccountName),values(DnsHostName),values(ServicePrincipalNames) by dest Logon_ID subject 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_computer_account_with_spn_filter`"
Windows ConHost with Headless Argument,"The following analytic detects the unusual invocation of the Windows Console Host process (conhost.exe) with the undocumented --headless parameter. This detection leverages Endpoint Detection and Response (EDR) telemetry, specifically monitoring for command-line executions where conhost.exe is executed with the --headless argument. This activity is significant for a SOC as it is not commonly used in legitimate operations and may indicate an attacker's attempt to execute commands stealthily.",Windows Events,"Execution, Lateral Movement, Persistence, Defense Evasion, Exfiltration","T1564.006, T1564.003","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=conhost.exe Processes.process=""*--headless *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_conhost_with_headless_argument_filter`"
Windows ConsoleHost History File Deletion,"The following analytic detects the deletion of the ConsoleHost_history.txt file, which stores command history for PowerShell sessions. Attackers may attempt to remove this file to cover their tracks and evade detection during post-exploitation activities. This detection focuses on file deletion commands executed via PowerShell, Command Prompt, or scripting languages that specifically target ConsoleHost_history.txt, typically located at %APPDATA%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.",Windows Events,Defense Evasion,T1070.003,"`sysmon` EventCode IN (""23"",""26"") TargetFilename = ""*\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt"" 
| stats count min(_time) as firstTime, max(_time) as lastTime by action dest dvc file_path file_hash file_name file_modify_time process_name process_exec process_id process_path user_id vendor_product process_guid signature signature_id user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_consolehost_history_file_deletion_filter`"
Windows Defacement Modify Transcodedwallpaper File,"The following analytic identifies modifications to the TranscodedWallpaper file in the wallpaper theme directory, excluding changes made by explorer.exe. This detection leverages the Endpoint.Processes and Endpoint.Filesystem data models to correlate process activity with file modifications. This activity is significant as it may indicate an adversary attempting to deface or change the desktop wallpaper of a targeted host, a tactic often used to signal compromise or deliver a message.",Windows Events,"Impact, Exfiltration",T1491,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_path !=""*\\Windows\\Explorer.EXE"" by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
|rename process_guid as proc_guid 
| join proc_guid, _time [ 
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.file_path = ""*\\AppData\\Roaming\\Microsoft\\Windows\\Themes\\TranscodedWallpaper"" by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.file_path Filesystem.process_guid 
| `drop_dm_object_name(Filesystem)` 
|rename process_guid as proc_guid 
| fields file_name file_path process_name process_path process dest file_create_time _time proc_guid] 
| `windows_defacement_modify_transcodedwallpaper_file_filter`"
Windows Default Group Policy Object Modified,"The following analytic detects modifications to default Group Policy Objects (GPOs) using Event ID 5136. It monitors changes to the Default Domain Controllers Policy and Default Domain Policy, which are critical for enforcing security settings across domain controllers and all users/computers, respectively. This activity is significant because unauthorized changes to these GPOs can indicate an adversary with privileged access attempting to deploy persistence mechanisms or execute malware across the network.",Windows Events,"Persistence, Privilege Escalation, Defense Evasion","T1484, T1484.001","`wineventlog_security` EventCode=5136 ObjectClass=groupPolicyContainer AttributeLDAPDisplayName=versionNumber (ObjectDN=""CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=POLICIES,CN=SYSTEM,DC=*"" OR ObjectDN=""CN={6AC1786C-016F-11D2-945F-00C04fB984F9},CN=POLICIES,CN=SYSTEM,DC=*"") 
| stats min(_time) as firstTime max(_time) as lastTime by ObjectDN SubjectUserSid AttributeValue Computer DSName dest 
| rename AttributeValue as versionNumber 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_default_group_policy_object_modified_filter`"
Windows Default Group Policy Object Modified with GPME,"The following analytic detects modifications to default Group Policy Objects (GPOs) using the Group Policy Management Editor (GPME). It leverages the Endpoint data model to identify processes where mmc.exe executes gpme.msc with specific GUIDs related to default GPOs. This activity is significant because default GPOs, such as the Default Domain Controllers Policy and Default Domain Policy, are critical for enforcing security policies across the domain.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation","T1484, T1484.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=mmc.exe (Processes.process =*gpme.msc*) AND (Processes.process = ""*31B2F340-016D-11D2-945F-00C04FB984F9*"" OR Processes.process = ""*6AC1786C-016F-11D2-945F-00C04fB984F9*""  ) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_default_group_policy_object_modified_with_gpme_filter`"
Windows Defender ASR Audit Events,"This detection searches for Windows Defender ASR audit events. ASR is a feature of Windows Defender Exploit Guard that prevents actions and apps that are typically used by exploit-seeking malware to infect machines. ASR rules are applied to processes and applications. When a process or application attempts to perform an action that is blocked by an ASR rule, an event is generated.",Microsoft Defender,"Initial Access, Execution, Collection","T1566.002, T1566.001, T1059","`ms_defender` EventCode IN (1122, 1125, 1126, 1132, 1134) 
| stats count min(_time) as firstTime max(_time) as lastTime by host, Process_Name, Target_Commandline, Path, ID, EventCode 
| lookup asr_rules ID OUTPUT ASR_Rule 
| fillnull value=NULL 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| rename host as dest 
| `windows_defender_asr_audit_events_filter`"
Windows Defender ASR Block Events,"This detection searches for Windows Defender ASR block events. ASR is a feature of Windows Defender Exploit Guard that prevents actions and apps that are typically used by exploit-seeking malware to infect machines. ASR rules are applied to processes and applications. When a process or application attempts to perform an action that is blocked by an ASR rule, an event is generated.",Microsoft Defender,"Initial Access, Execution, Collection","T1566.002, T1566.001, T1059","`ms_defender` EventCode IN (1121, 1126, 1129, 1131, 1133) 
| stats count min(_time) as firstTime max(_time) as lastTime by host, Path, Parent_Commandline, Process_Name, ID, EventCode 
| lookup asr_rules ID OUTPUT ASR_Rule 
| fillnull value=NULL 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| rename host as dest 
| `windows_defender_asr_block_events_filter`"
Windows Defender ASR Registry Modification,"The following analytic detects modifications to Windows Defender Attack Surface Reduction (ASR) registry settings. It leverages Windows Defender Operational logs, specifically EventCode 5007, to identify changes in ASR rules. This activity is significant because ASR rules are designed to block actions commonly used by malware to exploit systems. Unauthorized modifications to these settings could indicate an attempt to weaken system defenses.",Microsoft Defender,"Collection, Defense Evasion",T1112,"`ms_defender` EventCode IN (5007) 
| rex field=New_Value ""0x(?<New_Registry_Value>\\d+)$"" 
| rex field=Old_Value ""0x(?<Old_Registry_Value>\\d+)$"" 
| rex field=New_Value ""Rules\\\\(?<ASR_ID>[A-Fa-f0-9\\-]+)\\s*="" 
| eval New_Registry_Value=case(New_Registry_Value==""0"", ""Disabled"", New_Registry_Value==""1"", ""Block"", New_Registry_Value==""2"", ""Audit"", New_Registry_Value==""6"", ""Warn"") 
| eval Old_Registry_Value=case(Old_Registry_Value==""0"", ""Disabled"", Old_Registry_Value==""1"", ""Block"", Old_Registry_Value==""2"", ""Audit"", Old_Registry_Value==""6"", ""Warn"") 
| stats count min(_time) as firstTime max(_time) as lastTime by host, New_Value, Old_Value, Old_Registry_Value, New_Registry_Value, ASR_ID 
| lookup asr_rules ID AS ASR_ID OUTPUT ASR_Rule 
| `security_content_ctime(firstTime)`
| rename host as dest 
| `security_content_ctime(lastTime)` 
| `windows_defender_asr_registry_modification_filter`"
Windows Defender ASR Rule Disabled,"The following analytic identifies when a Windows Defender ASR rule disabled events. ASR is a feature of Windows Defender Exploit Guard that prevents actions and apps that are typically used by exploit-seeking malware to infect machines. ASR rules are applied to processes and applications. When a process or application attempts to perform an action that is blocked by an ASR rule, an event is generated.",Microsoft Defender,"Collection, Defense Evasion",T1112,"`ms_defender` EventCode IN (5007) 
| rex field=New_Value ""0x(?<New_Registry_Value>\\d+)$"" 
| rex field=Old_Value ""0x(?<Old_Registry_Value>\\d+)$"" 
| rex field=New_Value ""Rules\\\\(?<ASR_ID>[A-Fa-f0-9\\-]+)\\s*="" 
| eval New_Registry_Value=case(New_Registry_Value==""0"", ""Disabled"", New_Registry_Value==""1"", ""Block"", New_Registry_Value==""2"", ""Audit"", New_Registry_Value==""6"", ""Warn"") 
| eval Old_Registry_Value=case(Old_Registry_Value==""0"", ""Disabled"", Old_Registry_Value==""1"", ""Block"", Old_Registry_Value==""2"", ""Audit"", Old_Registry_Value==""6"", ""Warn"") 
| search New_Registry_Value=""Disabled"" 
| stats count min(_time) as firstTime max(_time) as lastTime by host, New_Value, Old_Value, Old_Registry_Value, New_Registry_Value, ASR_ID 
| lookup asr_rules ID AS ASR_ID OUTPUT ASR_Rule 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| rename host as dest 
| `windows_defender_asr_rule_disabled_filter`"
Windows Defender ASR Rules Stacking,"The following analytic identifies security events from Microsoft Defender, focusing on Exploit Guard and Attack Surface Reduction (ASR) features. It detects Event IDs 1121, 1126, 1131, and 1133 for blocked operations, and Event IDs 1122, 1125, 1132, and 1134 for audit logs. Event ID 1129 indicates user overrides, while Event ID 5007 signals configuration changes.",Microsoft Defender,"Initial Access, Execution, Collection","T1566.001, T1059, T1566.002","`ms_defender` EventCode IN (1121, 1122, 1125, 1126, 1129, 1131, 1132, 1133, 1134, 5007) 
| stats count min(_time) as firstTime max(_time) as lastTime by host Parent_Commandline, Process_Name, Path, ID, EventCode 
| lookup asr_rules ID OUTPUT ASR_Rule 
| fillnull value=NULL 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| rename host as dest 
| `windows_defender_asr_rules_stacking_filter`"
Windows Delete or Modify System Firewall,"The following analytic identifies 'netsh' processes that delete or modify firewall configurations. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions containing specific keywords. This activity is significant because it can indicate malware, such as NJRAT, attempting to alter firewall settings to evade detection or remove traces. If confirmed malicious, this behavior could allow an attacker to disable security measures, facilitating further compromise and persistence within the network.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` Processes.process = ""* firewall *"" Processes.process = ""* del*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_delete_or_modify_system_firewall_filter`"
Windows Deleted Registry By A Non Critical Process File Path,"The following analytic detects the deletion of registry keys by non-critical processes. It leverages Endpoint Detection and Response (EDR) data, focusing on registry deletion events and correlating them with processes not typically associated with system or program files. This activity is significant as it may indicate malware, such as the Double Zero wiper, attempting to evade defenses or cause destructive payload impacts.",Windows Events,"Execution, Impact, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count from datamodel=Endpoint.Registry WHERE Registry.action=deleted BY _time span=1h Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| join process_guid [
| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes WHERE NOT (Processes.process_path IN (""*\\windows\\*"", ""*\\program files*"")) by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)`] 
| fields _time parent_process_name parent_process process_name process_path process process_guid registry_path registry_value_name registry_value_data registry_key_name action dest user 
| `windows_deleted_registry_by_a_non_critical_process_file_path_filter`"
Windows Detect Network Scanner Behavior,"The following analytic detects when an application is used to connect a large number of unique ports/targets within a short time frame. Network enumeration may be used by adversaries as a method of discovery, lateral movement, or remote execution. This analytic may require significant tuning depending on the organization and applications being actively used, highly recommended to pre-populate the filter macro prior to activation.",Windows Events,"Lateral Movement, Execution, Discovery","T1595.001, T1595, T1595.002","| tstats `security_content_summariesonly` count values(All_Traffic.action) as action values(All_Traffic.dest) as dest values(All_Traffic.dest_port) as dest_port values(All_Traffic.dest_ip) as dest_ip values(All_Traffic.dvc) as dvc values(All_Traffic.direction) as direction values(All_Traffic.protocol) as protocol values(All_Traffic.protocol_version) as protocol_version values(All_Traffic.src_port) as src_port values(All_Traffic.transport) as transport dc(All_Traffic.dest_port) as port_count dc(All_Traffic.dest) as dest_count min(_time) as firstTime max(_time) as lastTime values(All_Traffic.process_id) as process_id from datamodel=Network_Traffic.All_Traffic where sourcetype=XmlWinEventLog All_Traffic.app = ""*\\*"" All_Traffic.dest_port < 32000 NOT All_Traffic.dest_port IN (8443,8080,5353,3268,443,389,88,80,53,25) by All_Traffic.app All_Traffic.src All_Traffic.src_ip All_Traffic.user All_Traffic.vendor_product _time span=5m 
| `drop_dm_object_name(All_Traffic)` 
| rex field=app "".*\\\(?<process_name>.*)$"" 
| where port_count > 10 OR dest_count > 10 
| stats latest(src) as src, latest(src_ip) as src_ip, max(dest_count) as dest_count, max(port_count) as port_count, latest(dest_port) as dest_port, min(firstTime) as firstTime, max(lastTime) as lastTime, max(count) as count by user,app,process_name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_detect_network_scanner_behavior_filter`"
Windows Disable Change Password Through Registry,"The following analytic detects a suspicious registry modification that disables the Change Password feature on a Windows host. It identifies changes to the registry path &quot;*\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\DisableChangePassword&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it can prevent users from changing their passwords, a tactic often used by ransomware to maintain control over compromised systems.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableChangePassword"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_change_password_through_registry_filter`"
Windows Disable LogOff Button Through Registry,The following analytic detects a suspicious registry modification that disables the logoff feature on a Windows host. It leverages data from the Endpoint.Registry data model to identify changes to specific registry values associated with logoff functionality. This activity is significant because it can indicate ransomware attempting to make the compromised host unusable and hinder remediation efforts.,Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\*"" Registry.registry_value_name IN (""NoLogOff"", ""StartMenuLogOff"") Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_logoff_button_through_registry_filter`"
Windows Disable Notification Center,"The following analytic detects the modification of the Windows registry to disable the Notification Center on a host machine. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the &quot;DisableNotificationCenter&quot; registry value set to &quot;0x00000001.&quot; This activity is significant because disabling the Notification Center can be a tactic used by RAT malware to hide its presence and subsequent actions.",Windows Events,"Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_value_name= ""DisableNotificationCenter"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_notification_center_filter`"
Windows Disable or Modify Tools Via Taskkill,"The following analytic identifies the use of taskkill.exe to forcibly terminate processes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include specific taskkill parameters. This activity is significant because it can indicate attempts to disable security tools or disrupt legitimate applications, a common tactic in malware operations.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""taskkill.exe"" Processes.process IN (""* /f*"", ""* /t*"") Processes.process IN (""* /im*"", ""* /pid*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_or_modify_tools_via_taskkill_filter`"
Windows Disable Shutdown Button Through Registry,"The following analytic detects suspicious registry modifications that disable the shutdown button on a user's logon screen. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to registry paths associated with shutdown policies. This activity is significant because it is a tactic used by malware, particularly ransomware like KillDisk, to hinder system usability and prevent the removal of malicious changes.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE ((Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\shutdownwithoutlogon"" Registry.registry_value_data = ""0x00000000"") OR (Registry.registry_path=""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoClose"" Registry.registry_value_data = ""0x00000001"")) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_shutdown_button_through_registry_filter`"
Windows Disable Windows Event Logging Disable HTTP Logging,"The following analytic detects the use of AppCmd.exe to disable HTTP logging on IIS servers. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution events where AppCmd.exe is used with specific parameters to alter logging settings. This activity is significant because disabling HTTP logging can help adversaries hide their tracks and avoid detection by removing evidence of their actions.",Windows Events,"Execution, Persistence, Defense Evasion","T1562.002, T1505.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where NOT (Processes.parent_process_name  IN (""msiexec.exe"", ""iissetup.exe"")) Processes.process_name=appcmd.exe Processes.process IN (""*set config*"", ""*httplogging*"",""*dontlog:true*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_windows_event_logging_disable_http_logging_filter`"
Windows Disable Windows Group Policy Features Through Registry,"The following analytic detects suspicious registry modifications aimed at disabling Windows Group Policy features. It leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values associated with disabling key Windows functionalities. This activity is significant because it is commonly used by ransomware to hinder mitigation and forensic response efforts.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\*"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\*"" Registry.registry_value_name IN (""NoDesktop"", ""NoFind"", ""NoControlPanel"", ""NoFileMenu"", ""NoSetTaskbar"", ""NoTrayContextMenu"", ""TaskbarLockAll"", ""NoThemesTab"",""NoPropertiesMyDocuments"",""NoVisualStyleChoice"",""NoColorChoice"",""NoPropertiesMyDocuments"") Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_disable_windows_group_policy_features_through_registry_filter`"
Windows DisableAntiSpyware Registry,"The following analytic detects the modification of the Windows Registry key &quot;DisableAntiSpyware&quot; being set to disable. This detection leverages data from the Endpoint.Registry datamodel, specifically looking for the registry value name &quot;DisableAntiSpyware&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it is commonly associated with Ryuk ransomware infections, indicating potential malicious intent to disable Windows Defender.",Windows Events,"Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_value_name=""DisableAntiSpyware"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_disableantispyware_registry_filter`"
Windows DiskCryptor Usage,"The following analytic detects the execution of DiskCryptor, identified by the process names &quot;dcrypt.exe&quot; or &quot;dcinst.exe&quot;. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and original file names. DiskCryptor is significant because adversaries use it to manually encrypt disks during an operation, potentially leading to data inaccessibility.",Windows Events,"Execution, Impact",T1486,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""dcrypt.exe"" OR Processes.original_file_name=dcinst.exe) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_diskcryptor_usage_filter`"
Windows DISM Install PowerShell Web Access,"The following analytic detects the installation of PowerShell Web Access using the Deployment Image Servicing and Management (DISM) tool. It leverages Sysmon EventID 1 to identify the execution of dism.exe with specific parameters related to enabling the WindowsPowerShellWebAccess feature. This activity is significant because enabling PowerShell Web Access can facilitate remote execution of PowerShell commands, potentially allowing an attacker to gain unauthorized access to systems and networks.",Windows Events,"Execution, Defense Evasion",T1548.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=dism.exe (Processes.process=""*WindowsPowerShellWebAccess*"" AND Processes.process=""*/online*"" AND Processes.process=""*/enable-feature*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dism_install_powershell_web_access_filter`"
Windows DISM Remove Defender,"The following analytic detects the use of dism.exe to remove Windows Defender. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions that include specific parameters for disabling and removing Windows Defender. This activity is significant because adversaries may disable Defender to evade detection and carry out further malicious actions undetected.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=dism.exe (Processes.process=""*/online*"" AND Processes.process=""*/disable-feature*"" AND Processes.process=""*Windows-Defender*"" AND Processes.process=""*/remove*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dism_remove_defender_filter`"
Windows DLL Search Order Hijacking with iscsicpl,"The following analytic detects DLL search order hijacking involving iscsicpl.exe. It identifies when iscsicpl.exe loads a malicious DLL from a new path, triggering the payload execution. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on child processes spawned by iscsicpl.exe. This activity is significant as it indicates a potential attempt to execute unauthorized code via DLL hijacking.",Windows Events,"Execution, Persistence, Defense Evasion",T1574.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=iscsicpl.exe `windows_shells` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_dll_search_order_hijacking_with_iscsicpl_filter`"
Windows DNS Gather Network Info,"The following analytic detects the use of the dnscmd.exe command to enumerate DNS records. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line executions. This activity is significant as it may indicate an adversary gathering network information, a common precursor to more targeted attacks. If confirmed malicious, this behavior could enable attackers to map the network, identify critical assets, and plan subsequent actions, potentially leading to data exfiltration or further compromise of the network.",Windows Events,"Execution, Exfiltration",T1590.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""dnscmd.exe"" Processes.process = ""* /enumrecords *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dns_gather_network_info_filter`"
Windows DnsAdmins New Member Added,"The following analytic detects the addition of a new member to the DnsAdmins group in Active Directory by leveraging Event ID 4732. This detection uses security event logs to identify changes to this high-privilege group. Monitoring this activity is crucial because members of the DnsAdmins group can manage the DNS service, often running on Domain Controllers, and potentially execute malicious code with SYSTEM privileges.",Windows Events,"Persistence, Privilege Escalation",T1098,"`wineventlog_security` EventCode=4732 TargetUserName=DnsAdmins 
| stats min(_time) as firstTime max(_time) as lastTime values(TargetUserName) as target_users_added values(user) as user by  dest src_user 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_dnsadmins_new_member_added_filter`"
Windows Domain Admin Impersonation Indicator,"The following analytic identifies potential Kerberos ticket forging attacks, specifically the Diamond Ticket attack. This is detected when a user logs into a host and the GroupMembership field in event 4627 indicates a privileged group (e.g., Domain Admins), but the user does not actually belong to that group in the directory service. The detection leverages Windows Security Event Log 4627, which logs account logon events.",Windows Events,"Credential Access, Privilege Escalation",T1558,"`wineventlog_security` EventCode=4627 LogonType=3 NOT TargetUserName IN (""*$"", ""SYSTEM"", ""DWM-*"",""LOCAL SERVICE"",""NETWORK SERVICE"", ""ANONYMOUS LOGON"", ""UMFD-*"") 
| where match(GroupMembership, ""Domain Admins"") 
| stats count by _time TargetUserName GroupMembership action app dest signature_id user vendor_product 
| lookup domain_admins username as TargetUserName OUTPUT username 
| fillnull value=NotDA username 
| search username = ""NotDA"" 
| `windows_domain_admin_impersonation_indicator_filter`"
Windows Drivers Loaded by Signature,"The following analytic identifies all drivers being loaded on Windows systems using Sysmon EventCode 6 (Driver Load). It leverages fields such as driver path, signature status, and hash to detect potentially suspicious drivers. This activity is significant for a SOC as malicious drivers can be used to gain kernel-level access, bypass security controls, or persist in the environment.",Windows Events,"Execution, Exfiltration, Privilege Escalation, Defense Evasion","T1068, T1014","`sysmon` EventCode=6 
| stats count min(_time) as firstTime max(_time) as lastTime by ImageLoaded dest dvc process_hash process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_drivers_loaded_by_signature_filter`"
Windows Enable Win32 ScheduledJob via Registry,"The following analytic detects the creation of a new DWORD value named &quot;EnableAt&quot; in the registry path &quot;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\Configuration&quot;. This modification enables the use of the at.exe or wmi Win32_ScheduledJob commands to add scheduled tasks on a Windows endpoint. The detection leverages registry event data from the Endpoint datamodel. This activity is significant because it may indicate that an attacker is enabling the ability to schedule tasks, potentially to execute malicious code at specific times or intervals.",Windows Events,"Lateral Movement, Execution",T1053.005,"| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\CurrentVersion\\Schedule\\Configuration*"" Registry.registry_value_name=EnableAt by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_enable_win32_scheduledjob_via_registry_filter`"
Windows ESX Admins Group Creation Security Event,"This analytic detects creation, deletion, or modification of the &quot;ESX Admins&quot; group in Active Directory. These events may indicate attempts to exploit the VMware ESXi Active Directory Integration Authentication Bypass vulnerability (CVE-2024-37085).
Search 1`wineventlog_security` EventCode IN (4727, 4730, 4737) (TargetUserName=&#34;ESX Admins&#34; OR TargetUserName=&#34;*ESX Admins*&#34;) 2| stats count min(_time) as firstTime max(_time) as lastTime by EventCode TargetUserName TargetDomainName SubjectUserName SubjectDomainName Computer 3| rename Computer as dest 4| eval EventCodeDescription=case( EventCode=4727, &#34;Security Enabled Global Group Created&#34;, EventCode=4730, &#34;Security Enabled Global Group Deleted&#34;, EventCode=4737, &#34;Security Enabled Global Group Modified&#34; ) 5| `security_content_ctime(firstTime)` 6| `security_content_ctime(lastTime)` 7| `windows_esx_admins_group_creation_security_event_filter` Data Source Name Platform Sourcetype Source Windows Event Log Security 4727 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Windows Event Log Security 4730 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Windows Event Log Security 4737 Windows 'XmlWinEventLog' 'XmlWinEventLog:Security' Macros Used Name Value security_content_ctime convert timeformat=&quot;%Y-%m-%dT%H:%M:%S&quot; ctime($field$) windows_esx_admins_group_creation_security_event_filter search * windows_esx_admins_group_creation_security_event_filter is an empty macro by default.",Windows Events,Persistence,"T1136.001, T1136.002","`wineventlog_security` EventCode IN (4727, 4730, 4737) (TargetUserName=""ESX Admins"" OR TargetUserName=""*ESX Admins*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by EventCode TargetUserName TargetDomainName SubjectUserName SubjectDomainName Computer 
| rename Computer as dest 
| eval EventCodeDescription=case( EventCode=4727, ""Security Enabled Global Group Created"", EventCode=4730, ""Security Enabled Global Group Deleted"", EventCode=4737, ""Security Enabled Global Group Modified"" ) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_esx_admins_group_creation_security_event_filter`"
Windows ESX Admins Group Creation via Net,This analytic detects attempts to create an &quot;ESX Admins&quot; group using the Windows net.exe or net1.exe commands. This activity may indicate an attempt to exploit the VMware ESXi Active Directory Integration Authentication Bypass vulnerability (CVE-2024-37085). Attackers can use this method to gain unauthorized access to ESXi hosts by recreating the &quot;ESX Admins&quot; group after its deletion from Active Directory.,Windows Events,Persistence,"T1136.001, T1136.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` Processes.process=""*group*"" Processes.process=""*ESX Admins*"" AND Processes.process=""*/add*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_esx_admins_group_creation_via_net_filter`"
Windows ESX Admins Group Creation via PowerShell,This analytic detects attempts to create an &quot;ESX Admins&quot; group using PowerShell commands. This activity may indicate an attempt to exploit the VMware ESXi Active Directory Integration Authentication Bypass vulnerability (CVE-2024-37085). Attackers can use this method to gain unauthorized access to ESXi hosts by recreating the 'ESX Admins' group after its deletion from Active Directory.,Windows Events,Persistence,"T1136.001, T1136.002","`powershell` EventCode=4104 (ScriptBlockText=""*New-ADGroup*"" OR ScriptBlockText=""*New-LocalGroup*"") ScriptBlockText=""*ESX Admins*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_esx_admins_group_creation_via_powershell_filter`"
Windows Event For Service Disabled,"The following analytic detects when a Windows service is modified from a start type to disabled. It leverages system event logs, specifically EventCode 7040, to identify this change. This activity is significant because adversaries often disable security or other critical services to evade detection and maintain control over a compromised host. If confirmed malicious, this action could allow attackers to bypass security defenses, leading to further exploitation and persistence within the environment.",Windows Events,"Persistence, Defense Evasion",T1562.001,"`wineventlog_system` EventCode=7040  EventData_Xml=""*disabled*"" 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer EventCode Name UserID service ServiceName 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_event_for_service_disabled_filter`"
Windows Event Log Cleared,"The following analytic detects the clearing of Windows event logs by identifying Windows Security Event ID 1102 or System log event 104. This detection leverages Windows event logs to monitor for log clearing activities. Such behavior is significant as it may indicate an attempt to cover tracks after malicious activities. If confirmed malicious, this action could hinder forensic investigations and allow attackers to persist undetected, making it crucial to investigate further and correlate with other alerts and data sources.",Windows Events,Defense Evasion,"T1070, T1070.001","(`wineventlog_security` EventCode=1102) OR (`wineventlog_system` EventCode=104) 
| stats count min(_time) as firstTime max(_time) as lastTime by action app change_type dest dvc name object_attrs object_category signature signature_id src_user status subject user vendor_product object EventCode 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_event_log_cleared_filter`"
Windows Eventlog Cleared Via Wevtutil,"The following analytic detects the usage of wevtutil.exe with the &quot;clear-log&quot; parameter in order to clear the contents of logs. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because clearing event logs can be an attempt to cover tracks after malicious actions, hindering forensic investigations.",Windows Events,"Execution, Defense Evasion",T1070.001,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wevtutil.exe Processes.process IN (""* cl *"", ""*clear-log*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_eventlog_cleared_via_wevtutil_filter`"
Windows Execute Arbitrary Commands with MSDT,"The following analytic detects arbitrary command execution using Windows msdt.exe, a Diagnostics Troubleshooting Wizard. It leverages Endpoint Detection and Response (EDR) data to identify instances where msdt.exe is invoked via the ms-msdt:/ protocol handler to retrieve a remote payload. This activity is significant as it can indicate an exploitation attempt leveraging msdt.",Windows Events,"Execution, Defense Evasion",T1218,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=msdt.exe Processes.process IN (""*msdt*"",""*ms-msdt:*"",""*ms-msdt:/id*"",""*ms-msdt:-id*"",""*/id*"") AND (Processes.process=""*IT_BrowseForFile=*"" OR Processes.process=""*IT_RebrowseForFile=*"" OR Processes.process=""*.xml*"") AND Processes.process=""*PCWDiagnostic*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_execute_arbitrary_commands_with_msdt_filter`"
Windows Explorer.exe Spawning PowerShell or Cmd,"This detection identifies instances where Windows Explorer.exe spawns PowerShell or cmd.exe processes, particularly focusing on executions initiated by LNK files. This behavior is associated with the ZDI-CAN-25373 Windows shortcut zero-day vulnerability, where specially crafted LNK files are used to trigger malicious code execution through cmd.exe or powershell.",Windows Events,Execution,"T1059.001, T1204.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_path=""*\\explorer.exe"" `process_powershell` OR `process_cmd`  by  Processes.dest Processes.process_current_directory Processes.process_path Processes.process Processes.original_file_name Processes.parent_process Processes.parent_process_name Processes.parent_process_path Processes.parent_process_guid Processes.parent_process_id Processes.process_guid Processes.process_id Processes.user 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_explorer_exe_spawning_powershell_or_cmd_filter`"
Windows Explorer LNK Exploit Process Launch With Padding,"This detection identifies instances where Windows Explorer.exe spawns PowerShell or cmd.exe processes with abnormally large padding (50 or more spaces) in the command line. This specific pattern is a key indicator of the ZDI-CAN-25373 Windows shortcut zero-day vulnerability exploitation, where threat actors craft malicious LNK files containing padded content to trigger code execution.",Windows Events,Execution,"T1059.001, T1204.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_path=""*\\explorer.exe"" (Processes.process_path=""*\\cmd.exe"" OR Processes.process_path=""*\\powershell.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| regex process="".*?\s{50,}.*"" 
| `windows_explorer_lnk_exploit_process_launch_with_padding_filter`"
Windows Export Certificate,"The following analytic detects the export of a certificate from the Windows Certificate Store. It leverages the Certificates Lifecycle log channel, specifically event ID 1007, to identify this activity. Monitoring certificate exports is crucial as certificates can be used for authentication to VPNs or private resources. If malicious actors export certificates, they could potentially gain unauthorized access to sensitive systems or data, leading to significant security breaches.",Windows Events,Credential Access,"T1552.004, T1553.004, T1649","`certificateservices_lifecycle` EventCode=1007 
| xmlkv UserData_Xml 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, SubjectName, UserData_Xml 
| rename Computer as dest 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_export_certificate_filter`"
Windows File and Directory Permissions Remove Inheritance,"The following analytic detects the removal of permission inheritance using ICACLS. This analytic identifies instances where ICACLS is used to remove permission inheritance from files or directories. The /inheritance:r flag, which strips inherited permissions while optionally preserving or altering explicit permissions, is monitored to detect changes that may restrict access or establish isolated permission configurations.",Windows Events,"Execution, Defense Evasion",T1222.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN( ""icacls.exe"", ""cacls.exe"", ""xcacls.exe"")  AND Processes.process = ""*/inheritance:r*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_file_and_directory_permissions_remove_inheritance_filter`"
Windows Find Domain Organizational Units with GetDomainOU,"The following analytic detects the execution of the Get-DomainOU cmdlet, a part of the PowerView toolkit used for Windows domain enumeration. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity. Detecting Get-DomainOU usage is significant as adversaries may use it to gather information about organizational units within Active Directory, which can facilitate lateral movement or privilege escalation.",Windows Events,"Execution, Lateral Movement, Persistence, Privilege Escalation, Discovery","T1087.002, T1087","`powershell` EventCode=4104 ScriptBlockText = ""*Get-DomainOU*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_find_domain_organizational_units_with_getdomainou_filter`"
Windows Find Interesting ACL with FindInterestingDomainAcl,"The following analytic detects the execution of the Find-InterestingDomainAcl cmdlet, part of the PowerView toolkit, using PowerShell Script Block Logging (EventCode=4104). This detection leverages logs to identify when this command is run, which is significant as adversaries may use it to find misconfigured or unusual Access Control Lists (ACLs) within a domain.",Windows Events,"Discovery, Execution, Privilege Escalation","T1087.002, T1087","`powershell` EventCode=4104 ScriptBlockText = ""*Find-InterestingDomainAcl*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_find_interesting_acl_with_findinterestingdomainacl_filter`"
Windows Findstr GPP Discovery,"The following analytic detects the use of the findstr command to search for unsecured credentials in Group Policy Preferences (GPP). It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving findstr.exe with references to SYSVOL and cpassword. This activity is significant because it indicates an attempt to locate and potentially decrypt embedded credentials in GPP, which could lead to unauthorized access.",Windows Events,"Discovery, Execution, Credential Access, Privilege Escalation","T1552, T1552.006","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=findstr.exe AND Processes.process=*sysvol* AND Processes.process=*cpassword*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_findstr_gpp_discovery_filter`"
Windows Forest Discovery with GetForestDomain,"The following analytic detects the execution of the Get-ForestDomain cmdlet, a component of the PowerView toolkit used for Windows domain enumeration. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity. Detecting Get-ForestDomain is significant because adversaries and Red Teams use it to gather detailed information about Active Directory forest and domain configurations.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.002, T1087","`powershell` EventCode=4104 ScriptBlockText = ""*Get-ForestDomain*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_forest_discovery_with_getforestdomain_filter`"
Windows Gather Victim Identity SAM Info,"The following analytic detects processes loading the samlib.dll or samcli.dll modules, which are often abused to access Security Account Manager (SAM) objects or credentials on domain controllers. This detection leverages Sysmon EventCode 7 to identify these DLLs being loaded outside typical system directories. Monitoring this activity is crucial as it may indicate attempts to gather sensitive identity information.",Windows Events,Discovery,T1589.001,"`sysmon` EventCode=7  (ImageLoaded = ""*\\samlib.dll"" AND OriginalFileName = ""samlib.dll"") OR (ImageLoaded = ""*\\samcli.dll"" AND OriginalFileName = ""SAMCLI.DLL"") AND NOT (Image IN(""C:\\Windows\\*"", ""C:\\Program File*"", ""%systemroot%\\*"")) 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_gather_victim_identity_sam_info_filter`"
Windows Get-AdComputer Unconstrained Delegation Discovery,The following analytic detects the use of the Get-ADComputer cmdlet with parameters indicating a search for Windows endpoints with Kerberos Unconstrained Delegation. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this specific activity. This behavior is significant as it may indicate an attempt by adversaries or Red Teams to gain situational awareness and perform Active Directory discovery.,Windows Events,"Lateral Movement, Discovery, Privilege Escalation",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-ADComputer*"" AND ScriptBlockText = ""*TrustedForDelegation*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_get_adcomputer_unconstrained_delegation_discovery_filter`"
Windows Get Local Admin with FindLocalAdminAccess,"The following analytic detects the execution of the Find-LocalAdminAccess cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet is part of PowerView, a toolkit for Windows domain enumeration. Identifying the use of Find-LocalAdminAccess is crucial as adversaries may use it to find machines where the current user has local administrator access, facilitating lateral movement or privilege escalation.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.002, T1087","`powershell` EventCode=4104 ScriptBlockText = ""*Find-LocalAdminAccess*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_get_local_admin_with_findlocaladminaccess_filter`"
Windows Global Object Access Audit List Cleared Via Auditpol,"The following analytic identifies the execution of auditpol.exe with the &quot;/resourceSACL&quot; flag, and either the &quot;/clear&quot; or &quot;/remove&quot; command-line arguments used to remove or clear the global object access audit policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential defense evasion by adversaries or Red Teams, aiming to limit data that can be leveraged for detections and audits.",Windows Events,"Lateral Movement, Execution, Discovery, Defense Evasion",T1562.002,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_auditpol` Processes.process=""*/resourceSACL*"" Processes.process IN (""*/clear*"", ""*/remove*"") AND NOT Processes.process=""*/?*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_global_object_access_audit_list_cleared_via_auditpol_filter`"
Windows Group Policy Object Created,The following analytic detects the creation of a new Group Policy Object (GPO) by leveraging Event IDs 5136 and 5137. This detection uses directory service change events to identify when a new GPO is created. Monitoring GPO creation is crucial as adversaries can exploit GPOs to escalate privileges or deploy malware across an Active Directory network.,Windows Events,"Initial Access, Persistence, Privilege Escalation, Defense Evasion","T1484.001, T1484, T1078.002","`wineventlog_security` EventCode=5137 OR (EventCode=5136 AttributeValue!=""New Group Policy Object"" AND (AttributeLDAPDisplayName=displayName OR AttributeLDAPDisplayName=gPCFileSysPath) ) ObjectClass=groupPolicyContainer 
| stats values(AttributeValue) as details values(SubjectUserSid) as User values(ObjectDN) as ObjectDN by ObjectGUID Computer dest 
| eval GPO_Name = mvindex(details, 0) 
| eval GPO_Path = mvindex(details, 1) 
| fields - details 
| `windows_group_policy_object_created_filter`"
Windows Identify PowerShell Web Access IIS Pool,"This analytic detects and analyzes PowerShell Web Access (PSWA) usage in Windows environments. It tracks both connection attempts (EventID 4648) and successful logons (EventID 4624) associated with PSWA, providing a comprehensive view of access patterns. The analytic identifies PSWA's operational status, host servers, processes, and connection metrics. It highlights unique target accounts, domains accessed, and verifies logon types.",Windows Events,"Initial Access, Lateral Movement",T1190,"`wineventlog_security` (EventCode=4648 OR EventCode=4624 OR EventCode=4625) SubjectUserName=""pswa_pool"" 
| fields EventCode, SubjectUserName, TargetUserName, Computer, TargetDomainName, ProcessName, LogonType 
| rename Computer as dest 
| stats count(eval(EventCode=4648)) as ""Connection Attempts"", count(eval(EventCode=4624)) as ""Successful Logons"", count(eval(EventCode=4625)) as ""Unsuccessful Logons"", dc(TargetUserName) as ""Unique Target Accounts"", values(dest) as ""PSWA Host"", dc(TargetDomainName) as ""Unique Target Domains"", values(ProcessName) as ""PSWA Process"", values(TargetUserName) as ""Target Users List"", values(TargetServerName) as ""Target Servers List"", values(LogonType) as ""Logon Types"" 
| eval PSWA_Running = ""Yes"", ""PSWA Process"" = mvindex(split(mvindex(""PSWA Process"", 0), ""\\""), -1) 
| fields PSWA_Running, ""PSWA Host"", ""PSWA Process"", ""Connection Attempts"", ""Successful Logons"",""Unsuccessful Logons"", ""Unique Target Accounts"", ""Unique Target Domains"", ""Target Users List"",""Target Servers List"", ""Logon Types"" 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_identify_powershell_web_access_iis_pool_filter`"
Windows Identify Protocol Handlers,"The following analytic identifies the use of protocol handlers executed via the command line. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. This activity is significant because protocol handlers can be exploited to execute arbitrary commands or launch applications, potentially leading to unauthorized actions. If confirmed malicious, an attacker could use this technique to gain code execution, escalate privileges, or maintain persistence within the environment, posing a significant security risk.",Windows Events,"Execution, Persistence","T1218, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process) as process values(Processes.parent_process) as parent_process from datamodel=Endpoint.Processes by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(Processes)` 
| lookup windows_protocol_handlers handler AS process OUTPUT handler ishandler 
| where ishandler=""TRUE"" 
| `windows_identify_protocol_handlers_filter`"
Windows IIS Components Module Failed to Load,"The following analytic detects when an IIS Module DLL fails to load due to a configuration problem, identified by EventCode 2282. This detection leverages Windows Application event logs to identify repeated failures in loading IIS modules. Such failures can indicate misconfigurations or potential tampering with IIS components. If confirmed malicious, this activity could lead to service disruptions or provide an attacker with opportunities to exploit vulnerabilities within the IIS environment.",Windows Events,Persistence,T1505.004,"`wineventlog_application` EventCode=2282 
| stats  count min(_time) as firstTime max(_time) as lastTime by  EventCode dest Name ModuleDll 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iis_components_module_failed_to_load_filter`"
Windows Impair Defense Add Xml Applocker Rules,"The following analytic detects the use of a PowerShell commandlet to import an AppLocker XML policy. This behavior is identified by monitoring processes that execute the &quot;Import-Module Applocker&quot; and &quot;Set-AppLockerPolicy&quot; commands with the &quot;-XMLPolicy&quot; parameter. This activity is significant because it can indicate an attempt to disable or bypass security controls, as seen in the Azorult malware.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` AND Processes.process=""*Import-Module Applocker*"" AND Processes.process=""*Set-AppLockerPolicy *""  AND Processes.process=""* -XMLPolicy *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_add_xml_applocker_rules_filter`"
Windows Impair Defense Change Win Defender Health Check Intervals,"The following analytic detects modifications to the Windows registry that change the health check interval of Windows Defender. It leverages data from the Endpoint datamodel, specifically monitoring changes to the &quot;ServiceKeepAlive&quot; registry path with a value of &quot;0x00000001&quot;. This activity is significant because altering Windows Defender settings can impair its ability to perform timely health checks, potentially leaving the system vulnerable.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\ServiceKeepAlive"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_change_win_defender_health_check_intervals_filter`"
Windows Impair Defense Change Win Defender Quick Scan Interval,"The following analytic detects modifications to the Windows registry that change the Windows Defender Quick Scan Interval. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;QuickScanInterval&quot; registry path. This activity is significant because altering the scan interval can impair Windows Defender's ability to detect malware promptly, potentially allowing threats to persist undetected.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Scan\\QuickScanInterval"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_change_win_defender_quick_scan_interval_filter`"
Windows Impair Defense Change Win Defender Throttle Rate,"The following analytic detects modifications to the ThrottleDetectionEventsRate registry setting in Windows Defender. It leverages data from the Endpoint.Registry datamodel to identify changes in the registry path related to Windows Defender's event logging rate. This activity is significant because altering the ThrottleDetectionEventsRate can reduce the frequency of logged detection events, potentially masking malicious activities.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\NIS\\Consumers\\IPS\\ThrottleDetectionEventsRate"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_change_win_defender_throttle_rate_filter`"
Windows Impair Defense Change Win Defender Tracing Level,"The following analytic detects modifications to the Windows registry specifically targeting the &quot;WppTracingLevel&quot; setting within Windows Defender. This detection leverages data from the Endpoint.Registry data model to identify changes in the registry path associated with Windows Defender tracing levels. Such modifications are significant as they can impair the diagnostic capabilities of Windows Defender, potentially hiding malicious activities.",Windows Events,"Persistence, Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Reporting\\WppTracingLevel"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_change_win_defender_tracing_level_filter`"
Windows Impair Defense Configure App Install Control,"The following analytic detects modifications to the Windows registry that disable the Windows Defender SmartScreen App Install Control feature. It leverages data from the Endpoint.Registry data model to identify changes to specific registry values. This activity is significant because disabling App Install Control can allow users to install potentially malicious web-based applications without restrictions, increasing the risk of security vulnerabilities.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Microsoft\\Windows Defender\\SmartScreen\\ConfigureAppInstallControl"" Registry.registry_value_data= ""Anywhere"") OR (Registry.registry_path= ""*\\Microsoft\\Windows Defender\\SmartScreen\\ConfigureAppInstallControlEnabled"" Registry.registry_value_data= ""0x00000000"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_configure_app_install_control_filter`"
Windows Impair Defense Define Win Defender Threat Action,"The following analytic detects modifications to the Windows Defender ThreatSeverityDefaultAction registry setting. It leverages data from the Endpoint.Registry datamodel to identify changes in registry values that define how Windows Defender responds to threats. This activity is significant because altering these settings can impair the system's defense mechanisms, potentially allowing threats to go unaddressed. If confirmed malicious, this could enable attackers to bypass antivirus protections, leading to persistent threats and increased risk of data compromise or further system exploitation.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Threats\\ThreatSeverityDefaultAction*"" Registry.registry_value_data IN (""0x00000001"", ""9"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_define_win_defender_threat_action_filter`"
Windows Impair Defense Delete Win Defender Context Menu,"The following analytic detects the deletion of the Windows Defender context menu entry from the registry. It leverages data from the Endpoint datamodel, specifically monitoring registry actions where the path includes &quot;*\shellex\ContextMenuHandlers\EPP&quot; and the action is 'deleted'. This activity is significant as it is commonly associated with Remote Access Trojan (RAT) malware attempting to disable security features.",Windows Events,"Persistence, Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\shellex\\ContextMenuHandlers\\EPP"" Registry.action = deleted by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_delete_win_defender_context_menu_filter`"
Windows Impair Defense Delete Win Defender Profile Registry,"The following analytic detects the deletion of the Windows Defender main profile registry key. It leverages data from the Endpoint.Registry datamodel, specifically monitoring for deleted actions within the Windows Defender registry path. This activity is significant as it indicates potential tampering with security defenses, often associated with Remote Access Trojans (RATs) and other malware.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Policies\\Microsoft\\Windows Defender"" Registry.action = deleted by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_delete_win_defender_profile_registry_filter`"
Windows Impair Defense Disable Controlled Folder Access,"The following analytic detects a modification in the Windows registry that disables the Windows Defender Controlled Folder Access feature. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the EnableControlledFolderAccess registry setting. This activity is significant because Controlled Folder Access is designed to protect critical folders from unauthorized access, including ransomware attacks.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\EnableControlledFolderAccess"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_controlled_folder_access_filter`"
Windows Impair Defense Disable Realtime Signature Delivery,"The following analytic detects modifications to the Windows registry that disable the Windows Defender real-time signature delivery feature. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the registry path associated with Windows Defender signature updates. This activity is significant because disabling real-time signature delivery can prevent Windows Defender from receiving timely malware definitions, reducing its effectiveness.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Signature Updates\\RealtimeSignatureDelivery"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_realtime_signature_delivery_filter`"
Windows Impair Defense Disable Web Evaluation,"The following analytic detects modifications to the Windows registry entry &quot;EnableWebContentEvaluation&quot; to disable Windows Defender web content evaluation. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes where the registry value is set to &quot;0x00000000&quot;. This activity is significant as it indicates an attempt to impair browser security features, potentially allowing malicious web content to bypass security checks.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\Windows\\CurrentVersion\\AppHost\\EnableWebContentEvaluation""  Registry.registry_value_data= ""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_web_evaluation_filter`"
Windows Impair Defense Disable Win Defender App Guard,"The following analytic detects modifications to the Windows registry that disable Windows Defender Application Guard auditing. It leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values. This activity is significant because disabling auditing can hinder security monitoring and threat detection within the isolated environment, making it easier for malicious activities to go unnoticed.",Windows Events,"Exfiltration, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Policies\\Microsoft\\AppHVSI\\AuditApplicationGuard"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_app_guard_filter`"
Windows Impair Defense Disable Win Defender Compute File Hashes,"The following analytic detects modifications to the Windows registry that disable Windows Defender's file hash computation by setting the EnableFileHashComputation value to 0. This detection leverages data from the Endpoint.Registry data model, focusing on changes to the specific registry path associated with Windows Defender. Disabling file hash computation can significantly impair Windows Defender's ability to detect and scan for malware, making it a critical behavior to monitor.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\MpEngine\\EnableFileHashComputation"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_compute_file_hashes_filter`"
Windows Impair Defense Disable Win Defender Gen reports,"The following analytic detects modifications in the Windows registry to disable Windows Defender generic reports. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the &quot;DisableGenericRePorts&quot; registry value. This activity is significant as it can prevent the transmission of error reports to Microsoft's Windows Error Reporting service, potentially hiding malicious activities.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Reporting\\DisableGenericRePorts"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_gen_reports_filter`"
Windows Impair Defense Disable Win Defender Report Infection,"The following analytic detects modifications to the Windows registry that disable Windows Defender's infection reporting. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the &quot;DontReportInfectionInformation&quot; registry key. This activity is significant because it can prevent Windows Defender from reporting detailed threat information to Microsoft, potentially allowing malware to evade detection. If confirmed malicious, this action could enable attackers to bypass security measures, maintain persistence, and avoid detection, leading to prolonged unauthorized access and potential data breaches.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Microsoft\\MRT\\DontReportInfectionInformation"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_report_infection_filter`"
Windows Impair Defense Disable Win Defender Scan On Update,"The following analytic detects modifications to the Windows registry that disable the Windows Defender Scan On Update feature. It leverages data from the Endpoint.Registry datamodel, specifically looking for changes to the &quot;DisableScanOnUpdate&quot; registry setting with a value of &quot;0x00000001&quot;. This activity is significant because disabling automatic scans can leave systems vulnerable to malware and other threats.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Signature Updates\\DisableScanOnUpdate"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_disable_win_defender_scan_on_update_filter`"
Windows Impair Defense Override SmartScreen Prompt,"The following analytic detects modifications to the Windows registry that override the Windows Defender SmartScreen prompt. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the &quot;PreventSmartScreenPromptOverride&quot; registry setting. This activity is significant because it indicates an attempt to disable the prevention of user overrides for SmartScreen prompts, potentially allowing users to bypass security warnings.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path= ""*\\Microsoft\\Edge\\PreventSmartScreenPromptOverride"" Registry.registry_value_data= ""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_override_smartscreen_prompt_filter`"
Windows Impair Defense Set Win Defender Smart Screen Level To Warn,"The following analytic detects modifications to the Windows registry that set the Windows Defender SmartScreen level to &quot;warn.&quot; This detection leverages data from the Endpoint.Registry data model, specifically monitoring changes to the ShellSmartScreenLevel registry value. This activity is significant because altering SmartScreen settings to &quot;warn&quot; can reduce immediate suspicion from users, allowing potentially malicious executables to run with just a warning prompt.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Microsoft\\Windows\\System\\ShellSmartScreenLevel"" Registry.registry_value_data=""Warn"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defense_set_win_defender_smart_screen_level_to_warn_filter`"
Windows Impair Defenses Disable Auto Logger Session,"The following analytic detects the disabling of an AutoLogger session or one of its providers, by identifying changes to the Registry values &quot;Start&quot; and &quot;Enabled&quot; part of the &quot;\WMI\Autologger&quot; key path. It leverages data from the Endpoint.Registry datamodel to monitor specific registry paths and values. This activity is significant as attackers and adversaries can leverage this in order to evade defense and blind EDRs and log ingest tooling.",Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\WMI\\Autologger\\*"" (Registry.registry_value_name=""Start"" OR Registry.registry_value_name=""Enabled"") Registry.registry_value_data =""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defenses_disable_auto_logger_session_filter`"
Windows Impair Defenses Disable HVCI,"The following analytic detects the disabling of Hypervisor-protected Code Integrity (HVCI) by monitoring changes in the Windows registry. It leverages data from the Endpoint datamodel, specifically focusing on registry paths and values related to HVCI settings. This activity is significant because HVCI helps protect the kernel and system processes from tampering by malicious code.",Windows Events,Defense Evasion,T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\\Enabled"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defenses_disable_hvci_filter`"
Windows Impair Defenses Disable Win Defender Auto Logging,The following analytic detects the disabling of Windows Defender logging by identifying changes to the Registry keys DefenderApiLogger or DefenderAuditLogger set to disable. It leverages data from the Endpoint.Registry datamodel to monitor specific registry paths and values. This activity is significant as it is commonly associated with Remote Access Trojan (RAT) malware attempting to evade detection.,Windows Events,"Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where (Registry.registry_path = ""*WMI\\Autologger\\DefenderApiLogger\\Start"" OR Registry.registry_path = ""*WMI\\Autologger\\DefenderAuditLogger\\Start"")  Registry.registry_value_data =""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_impair_defenses_disable_win_defender_auto_logging_filter`"
Windows Increase in User Modification Activity,"This analytic detects an increase in modifications to AD user objects. A large volume of changes to user objects can indicate potential security risks, such as unauthorized access attempts, impairing defences or establishing persistence. By monitoring AD logs for unusual modification patterns, this detection helps identify suspicious behavior that could compromise the integrity and security of the AD environment.",Windows Events,"Execution, Persistence, Privilege Escalation","T1098, T1562","`wineventlog_security` EventCode IN (4720,4722,4723,4724,4725,4726,4728,4732,4733,4738,4743,4780) 
| bucket span=5m _time  
| stats values(TargetDomainName) as TargetDomainName, values(user) as user, dc(user) as userCount, values(user_category) as user_category, values(src_user_category) as src_user_category, values(dest) as dest, values(dest_category) as dest_category by _time, src_user, signature, status 
| eventstats avg(userCount) as comp_avg , stdev(userCount) as comp_std by src_user, signature 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(userCount > 10 and userCount >= upperBound, 1, 0)  
| search isOutlier=1 
| stats values(TargetDomainName) as TargetDomainName, values(user) as user, dc(user) as userCount, values(user_category) as user_category, values(src_user_category) as src_user_category, values(dest) as dest, values(dest_category) as dest_category values(signature) as signature  by _time, src_user, status 
| `windows_increase_in_user_modification_activity_filter`"
Windows Indirect Command Execution Via forfiles,"The following analytic detects the execution of programs initiated by forfiles.exe. This command is typically used to run commands on multiple files, often within batch scripts. The detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where forfiles.exe is the parent process. This activity is significant because forfiles.",Windows Events,"Execution, Defense Evasion",T1202,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process=""*forfiles* /c *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_indirect_command_execution_via_forfiles_filter`"
Windows Indirect Command Execution Via pcalua,"The following analytic detects programs initiated by pcalua.exe, the Microsoft Windows Program Compatibility Assistant. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process information. While pcalua.exe can start legitimate programs, it is significant because attackers may use it to bypass command line execution protections. If confirmed malicious, this activity could allow attackers to execute arbitrary commands, potentially leading to unauthorized actions, privilege escalation, or persistence within the environment.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1202,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process=""*pcalua* -a*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_indirect_command_execution_via_pcalua_filter`"
Windows InProcServer32 New Outlook Form,"The following analytic detects the creation or modification of registry keys associated with new Outlook form installations, potentially indicating exploitation of CVE-2024-21378. It leverages data from the Endpoint.Registry datamodel, focusing on registry paths involving InProcServer32 keys linked to Outlook forms. This activity is significant as it may signify an attempt to achieve authenticated remote code execution via malicious form objects.",Windows Events,"Initial Access, Execution, Defense Evasion","T1112, T1566","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\InProcServer32\\*"" Registry.registry_value_data=*\\FORMS\\* by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
|`security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_inprocserver32_new_outlook_form_filter`"
Windows InstallUtil Credential Theft,"The following analytic detects instances where the Windows InstallUtil.exe binary loads vaultcli.dll and Samlib.dll. This detection leverages Sysmon EventCode 7 to identify these specific DLL loads. This activity is significant because it can indicate an attempt to execute code that bypasses application control and captures credentials using tools like Mimikatz. If confirmed malicious, this behavior could allow an attacker to steal credentials, potentially leading to unauthorized access and further compromise of the system.",Windows Events,"Execution, Defense Evasion",T1218.004,"`sysmon` EventCode=7 process_name=installutil.exe loaded_file_path IN (""*\\samlib.dll"", ""*\\vaultcli.dll"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_installutil_credential_theft_filter`"
Windows InstallUtil in Non Standard Path,"The following analytic detects the execution of InstallUtil.exe from non-standard paths. It leverages Endpoint Detection and Response (EDR) data, focusing on process names and original file names outside typical directories. This activity is significant because InstallUtil.exe is often used by attackers to execute malicious code or scripts. If confirmed malicious, this behavior could allow an attacker to bypass security controls, execute arbitrary code, and potentially gain unauthorized access or persist within the environment.",Windows Events,"Execution, Defense Evasion","T1036.003, T1218.004, T1036","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where `process_installutil` NOT (Processes.process_path IN (""*\\Windows\\ADWS\\*"",""*\\Windows\\SysWOW64*"", ""*\\Windows\\system32*"", ""*\\Windows\\NetworkController\\*"", ""*\\Windows\\SystemApps\\*"", ""*\\WinSxS\\*"", ""*\\Windows\\Microsoft.NET\\*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_installutil_in_non_standard_path_filter`"
Windows InstallUtil Uninstall Option,"The following analytic detects the use of the Windows InstallUtil.exe binary with the /u (uninstall) switch, which can execute code while bypassing application control. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line executions. This activity is significant because it can indicate an attempt to execute malicious code without administrative privileges.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_installutil` Processes.process IN (""*/u*"", ""*uninstall*"") NOT (Processes.process IN (""*C:\\WINDOWS\\CCM\\*"")) NOT (Processes.parent_process_name IN (""Microsoft.SharePoint.Migration.ClientInstaller.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_installutil_uninstall_option_filter`"
Windows Known Abused DLL Created,"The following analytic identifies the creation of Dynamic Link Libraries (DLLs) with a known history of exploitation in atypical locations. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and filesystem events. This activity is significant as it may indicate DLL search order hijacking or sideloading, techniques used by attackers to execute arbitrary code, maintain persistence, or escalate privileges.",Windows Events,"Execution, Persistence, Defense Evasion","T1574.001, T1574","| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (""*\\users\\*"",""*\\Windows\Temp\\*"",""*\\programdata\\*"") Filesystem.file_name=""*.dll"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| lookup hijacklibs_loaded library AS file_name OUTPUT islibrary, ttp, comment as desc 
| lookup hijacklibs_loaded library AS file_name excludes as file_path OUTPUT islibrary as excluded 
| search islibrary = TRUE AND excluded != TRUE 
| where isnotnull(file_name) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
|  `windows_known_abused_dll_created_filter`"
Windows Known Abused DLL Loaded Suspiciously,The following analytic detects when DLLs with known abuse history are loaded from an unusual location. This activity may represent an attacker performing a DLL search order or sideload hijacking technique. These techniques are used to gain persistence as well as elevate privileges on the target system. This detection relies on Sysmon EID7 and is compatible with all Officla Sysmon TA versions.,Windows Events,"Persistence, Defense Evasion","T1574.001, T1574","`sysmon` ImageLoaded EventCode=7 NOT ImageLoaded IN (""*\\Program Files*"",""*\\system32\\*"", ""*\\syswow64\\*"",""*\\winsxs\\*"",""*\\wbem\\*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest process_exec process_guid process_hash process_id process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product loaded_file 
| rename Image as process 
| eval process_name = case(isnotnull(process),replace(process,""(.*\\\)(?=.*(\.\w*)$
|(\w+)$)"","""")), loaded_file_path = case(isnotnull(loaded_file), replace(loaded_file, ""(:[\w\. ]+)"", """")), loaded_file = case(isnotnull(loaded_file),replace(loaded_file,""(.*\\\)(?=.*(\.\w*)$
|(\w+)$)"","""")), user = case(NOT user IN (""-""), replace(user, ""(.*)\\\(.+)$"",""\2"")) 
| lookup hijacklibs_loaded library AS loaded_file OUTPUT islibrary comment as desc 
| lookup hijacklibs_loaded library AS loaded_file excludes as loaded_file_path OUTPUT islibrary as excluded 
| search islibrary = TRUE AND excluded = false 
| stats count min(_time) as firstTime max(_time) as lastTime by dest loaded_file loaded_file_path process process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_known_abused_dll_loaded_suspiciously_filter`"
Windows KrbRelayUp Service Creation,"The following analytic detects the creation of a service with the default name &quot;KrbSCM&quot; associated with the KrbRelayUp tool. It leverages Windows System Event Logs, specifically EventCode 7045, to identify this activity. This behavior is significant as KrbRelayUp is a known tool used for privilege escalation attacks. If confirmed malicious, this activity could allow an attacker to escalate privileges, potentially gaining unauthorized access to sensitive systems and data.",Windows Events,"Persistence, Privilege Escalation",T1543.003,"`wineventlog_system` EventCode=7045 ServiceName IN (""KrbSCM"") 
| stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode ImagePath ServiceName StartType ServiceType 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_krbrelayup_service_creation_filter`"
Windows Large Number of Computer Service Tickets Requested,"The following analytic detects a high volume of Kerberos service ticket requests, specifically more than 30, from a single source within a 5-minute window. It leverages Event ID 4769, which logs when a Kerberos service ticket is requested, focusing on requests with computer names as the Service Name. This behavior is significant as it may indicate malicious activities such as lateral movement, malware staging, or reconnaissance.",Windows Events,"Lateral Movement, Discovery, Privilege Escalation, Defense Evasion","T1135, T1078","`wineventlog_security` EventCode=4769 ServiceName=""*$"" TargetUserName!=""*$"" 
| bucket span=5m _time 
| stats dc(ServiceName) AS unique_targets values(ServiceName) as host_targets values(dest) as dest by _time, IpAddress, TargetUserName 
| where unique_targets > 30 
| `windows_large_number_of_computer_service_tickets_requested_filter`"
Windows Ldifde Directory Object Behavior,"The following analytic identifies the use of Ldifde.exe, a command-line utility for creating, modifying, or deleting LDAP directory objects. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution and command-line arguments. Monitoring Ldifde.exe is significant because it can be used by attackers to manipulate directory objects, potentially leading to unauthorized changes or data exfiltration.",Windows Events,"Command And Control, Execution, Discovery, Exfiltration","T1069.002, T1105","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=ldifde.exe Processes.process IN (""*-i *"", ""*-f *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_ldifde_directory_object_behavior_filter`"
Windows Linked Policies In ADSI Discovery,"The following analytic detects the use of the [Adsisearcher] type accelerator in PowerShell Script Block Logging (EventCode=4104) to query Active Directory for domain organizational units. This detection leverages PowerShell operational logs to identify script blocks containing [adsisearcher], objectcategory=organizationalunit, and findAll(). This activity is significant as it indicates potential reconnaissance efforts by adversaries to gain situational awareness of the domain structure.",Windows Events,"Lateral Movement, Discovery, Privilege Escalation",T1087.002,[Adsisearcher]
Windows List ENV Variables Via SET Command From Uncommon Parent,"The following analytic identifies a suspicious process command line fetching environment variables using the cmd.exe &quot;set&quot; command, with a non-shell parent process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and parent process names. This activity could be significant as it is commonly associated with malware like Qakbot, which uses this technique to gather system information.",Windows Events,"Execution, Discovery, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""cmd.exe"" Processes.process IN (""*/c set"", ""*/c \""set"") AND NOT Processes.parent_process_name IN (""cmd.exe"", ""explorer.exe"", ""powershell*"" ""pwsh.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_list_env_variables_via_set_command_from_uncommon_parent_filter`"
Windows LOLBAS Executed As Renamed File,The following analytic identifies a LOLBAS process being executed where it's process name does not match it's original file name attribute. Processes that have been renamed and executed may be an indicator that an adversary is attempting to evade defenses or execute malicious code. The LOLBAS project documents Windows native binaries that can be abused by threat actors to perform tasks like executing malicious code.,Windows Events,"Execution, Defense Evasion","T1036.003, T1218.011, T1036","|  tstats `security_content_summariesonly` latest(Processes.parent_process) as parent_process, latest(Processes.process) as process, latest(Processes.process_guid) as process_guid count, min(_time) AS firstTime, max(_time) AS lastTime FROM datamodel=Endpoint.Processes where NOT Processes.original_file_name IN(""-"",""unknown"") AND NOT Processes.process_path IN (""*\\Program Files*"",""*\\PROGRA~*"",""*\\Windows\\System32\\*"",""*\\Windows\\Syswow64\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| where NOT match(process_name, ""(?i)"".original_file_name) 
| lookup lolbas_file_path lolbas_file_name as original_file_name OUTPUT description as desc 
| search desc!=""false"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_lolbas_executed_as_renamed_file_filter`"
Windows Mimikatz Crypto Export File Extensions,"The following analytic detects the creation of files with extensions commonly associated with the Mimikatz Crypto module. It leverages the Endpoint.Filesystem data model to identify specific file names indicative of certificate export activities. This behavior is significant as it may indicate the use of Mimikatz to export cryptographic keys, which is a common tactic for credential theft.",Windows Events,Credential Access,T1649,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.keyx.rsa.pvk"",""*sign.rsa.pvk"",""*sign.dsa.pvk"",""*dsa.ec.p8k"",""*dh.ec.p8k"", ""*.pfx"", ""*.der"") by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Filesystem)` 
| `windows_mimikatz_crypto_export_file_extensions_filter`"
Windows Modify Registry AuthenticationLevelOverride,"The following analytic detects modifications to the Windows registry key &quot;AuthenticationLevelOverride&quot; within the Terminal Server Client settings. It leverages data from the Endpoint.Registry datamodel to identify changes where the registry value is set to 0x00000000. This activity is significant as it may indicate an attempt to override authentication levels for remote connections, a tactic used by DarkGate malware for malicious installations.",Windows Events,"Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Terminal Server Client\\AuthenticationLevelOverride""  Registry.registry_value_data = 0x00000000 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_authenticationleveloverride_filter`"
Windows Modify Registry Auto Minor Updates,"The following analytic identifies a suspicious modification to the Windows auto update configuration registry. It detects changes to the registry path &quot;*\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU\AutoInstallMinorUpdates&quot; with a value of &quot;0x00000000&quot;. This activity is significant as it is commonly used by adversaries, including malware like RedLine Stealer, to bypass detection and deploy additional payloads. If confirmed malicious, this modification could allow attackers to evade defenses, potentially leading to further system compromise and exploitation of zero-day vulnerabilities.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\AutoInstallMinorUpdates"" AND Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_auto_minor_updates_filter`"
Windows Modify Registry Auto Update Notif,"The following analytic detects a suspicious modification to the Windows registry that changes the auto-update notification setting to &quot;Notify before download.&quot; This detection leverages data from the Endpoint.Registry data model, focusing on specific registry paths and values. This activity is significant because it is a known technique used by adversaries, including malware like RedLine Stealer, to evade detection and potentially deploy additional payloads.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\AUOptions"" AND Registry.registry_value_data=""0x00000002"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_auto_update_notif_filter`"
Windows Modify Registry Configure BitLocker,"This analytic is developed to detect suspicious registry modifications targeting BitLocker settings. The malware ShrinkLocker alters various registry keys to change how BitLocker handles encryption, potentially bypassing TPM requirements, enabling BitLocker without TPM, and enforcing specific startup key and PIN configurations. Such modifications can weaken system security, making it easier for unauthorized access and data breaches.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path= ""*\\Policies\\Microsoft\\FVE\\*"" Registry.registry_value_name IN(""EnableBDEWithNoTPM"", ""EnableNonTPM"", ""UseAdvancedStartup"") Registry.registry_value_data = 0x00000001) OR (Registry.registry_path= ""*\\Policies\\Microsoft\\FVE\\*"" Registry.registry_value_name IN(""UsePIN"", ""UsePartialEncryptionKey"", ""UseTPM"", ""UseTPMKey"", ""UseTPMKeyPIN"", ""UseTPMPIN"") Registry.registry_value_data = 0x00000002) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_configure_bitlocker_filter`"
Windows Modify Registry Disable Toast Notifications,"The following analytic detects modifications to the Windows registry that disable toast notifications. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the registry path &quot;\SOFTWARE\Microsoft\Windows\CurrentVersion\PushNotifications\ToastEnabled&quot; with a value set to &quot;0x00000000&quot;. This activity is significant because disabling toast notifications can prevent users from receiving critical system and application updates, which adversaries like Azorult exploit for defense evasion.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PushNotifications\\ToastEnabled*"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disable_toast_notifications_filter`"
Windows Modify Registry Disable Win Defender Raw Write Notif,"The following analytic detects modifications to the Windows registry that disable the Windows Defender raw write notification feature. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the registry path associated with Windows Defender's real-time protection settings. This activity is significant because disabling raw write notifications can allow malware, such as Azorult, to bypass Windows Defender's behavior monitoring, potentially leading to undetected malicious activities.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\Real-Time Protection\\DisableRawWriteNotification*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disable_win_defender_raw_write_notif_filter`"
Windows Modify Registry Disable WinDefender Notifications,"The following analytic detects a suspicious registry modification aimed at disabling Windows Defender notifications. It leverages data from the Endpoint.Registry data model, specifically looking for changes to the registry path &quot;*\SOFTWARE\Policies\Microsoft\Windows Defender Security Center\Notifications\DisableNotifications&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it indicates an attempt to evade detection by disabling security alerts, a technique used by adversaries and malware like RedLine Stealer.",Windows Events,"Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications\\DisableNotifications"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_disable_windefender_notifications_filter`"
Windows Modify Registry Disable Windows Security Center Notif,"The following analytic detects modifications to the Windows registry aimed at disabling Windows Security Center notifications. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the registry path &quot;\Windows\CurrentVersion\ImmersiveShell\UseActionCenterExperience&quot; with a value of &quot;0x00000000&quot;. This activity is significant as it can indicate an attempt by adversaries or malware, such as Azorult, to evade defenses by suppressing critical update notifications.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows\\CurrentVersion\\ImmersiveShell\\UseActionCenterExperience*"" Registry.registry_value_data=""0x00000000"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disable_windows_security_center_notif_filter`"
Windows Modify Registry DisableRemoteDesktopAntiAlias,"The following analytic detects modifications to the Windows registry key &quot;DisableRemoteDesktopAntiAlias&quot; with a value set to 0x00000001. This detection leverages data from the Endpoint datamodel, specifically monitoring changes in the Registry node. This activity is significant as it may indicate the presence of DarkGate malware, which alters this registry setting to enhance its remote desktop capabilities.",Windows Events,"Persistence, Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Terminal Services\\DisableRemoteDesktopAntiAlias""  Registry.registry_value_data = 0x00000001 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disableremotedesktopantialias_filter`"
Windows Modify Registry DisableSecuritySettings,"The following analytic detects modifications to the Windows registry that disable security settings for Terminal Services. It leverages the Endpoint data model, specifically monitoring changes to the registry path associated with Terminal Services security settings. This activity is significant because altering these settings can weaken the security posture of Remote Desktop Services, potentially allowing unauthorized remote access.",Windows Events,"Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Terminal Services\\DisableSecuritySettings""  Registry.registry_value_data = 0x00000001 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disablesecuritysettings_filter`"
Windows Modify Registry Disabling WER Settings,"The following analytic detects modifications in the Windows registry to disable Windows Error Reporting (WER) settings. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to registry paths related to WER with a value set to &quot;0x00000001&quot;. This activity is significant as adversaries may disable WER to suppress error notifications, hiding the presence of malicious activities.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\disable*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disabling_wer_settings_filter`"
Windows Modify Registry DisAllow Windows App,"The following analytic detects modifications to the Windows registry aimed at preventing the execution of specific computer programs. It leverages data from the Endpoint.Registry datamodel, focusing on changes to the registry path &quot;\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\DisallowRun&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it can indicate an attempt to disable security tools, a tactic used by malware like Azorult.",Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\DisallowRun*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_disallow_windows_app_filter`"
Windows Modify Registry Do Not Connect To Win Update,"The following analytic detects a suspicious modification to the Windows registry that disables automatic updates. It leverages data from the Endpoint datamodel, specifically monitoring changes to the registry path &quot;*\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\DoNotConnectToWindowsUpdateInternetLocations&quot; with a value of &quot;0x00000001&quot;. This activity is significant as it can be used by adversaries, including malware like RedLine Stealer, to evade detection and prevent the system from receiving critical updates.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\DoNotConnectToWindowsUpdateInternetLocations"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_do_not_connect_to_win_update_filter`"
Windows Modify Registry DontShowUI,"The following analytic detects modifications to the Windows Error Reporting registry key &quot;DontShowUI&quot; to suppress error reporting dialogs. It leverages data from the Endpoint datamodel's Registry node to identify changes where the registry value is set to 0x00000001. This activity is significant as it is commonly associated with DarkGate malware, which uses this modification to avoid detection during its installation.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\DontShowUI""  Registry.registry_value_data = 0x00000001 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_dontshowui_filter`"
Windows Modify Registry EnableLinkedConnections,"The following analytic detects a suspicious modification to the Windows registry setting for EnableLinkedConnections. It leverages data from the Endpoint.Registry datamodel to identify changes where the registry path is &quot;*\Microsoft\Windows\CurrentVersion\Policies\System\EnableLinkedConnections&quot; and the value is set to &quot;0x00000001&quot;. This activity is significant because enabling linked connections can allow network shares to be accessed with both standard and administrator-level privileges, a technique often abused by malware like BlackByte ransomware.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLinkedConnections"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_enablelinkedconnections_filter`"
Windows Modify Registry LongPathsEnabled,"The following analytic detects a modification to the Windows registry setting &quot;LongPathsEnabled,&quot; which allows file paths longer than 260 characters. This detection leverages data from the Endpoint.Registry datamodel, focusing on changes to the specific registry path and value. This activity is significant because adversaries, including malware like BlackByte, exploit this setting to bypass file path limitations, potentially aiding in evasion techniques.",Windows Events,"Execution, Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\CurrentControlSet\\Control\\FileSystem\\LongPathsEnabled"" Registry.registry_value_data = ""0x00000001"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_longpathsenabled_filter`"
Windows Modify Registry MaxConnectionPerServer,"The following analytic identifies a suspicious modification of the Windows registry setting for max connections per server. It detects changes to specific registry paths using data from the Endpoint.Registry datamodel. This activity is significant because altering this setting can be exploited by attackers to increase the number of concurrent connections to a remote server, potentially facilitating DDoS attacks or enabling more effective lateral movement within a compromised network.",Windows Events,"Lateral Movement, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\MaxConnectionsPerServer*"" OR Registry.registry_path= ""*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\MaxConnectionsPer1_0Server*"") Registry.registry_value_data = ""0x0000000a"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_maxconnectionperserver_filter`"
Windows Modify Registry No Auto Reboot With Logon User,"The following analytic detects a suspicious modification to the Windows registry that disables automatic reboot with a logged-on user. This detection leverages the Endpoint data model to identify changes to the registry path SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU\NoAutoRebootWithLoggedOnUsers with a value of 0x00000001. This activity is significant as it is commonly used by adversaries, including malware like RedLine Stealer, to evade detection and maintain persistence.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\NoAutoRebootWithLoggedOnUsers"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_no_auto_reboot_with_logon_user_filter`"
Windows Modify Registry No Auto Update,"The following analytic identifies a suspicious modification to the Windows registry that disables automatic updates. It detects changes to the registry path SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU\NoAutoUpdate with a value of 0x00000001. This activity is significant as it is commonly used by adversaries, including malware like RedLine Stealer, to evade detection and maintain persistence. If confirmed malicious, this could allow attackers to bypass security updates, leaving the system vulnerable to further exploitation and potential zero-day attacks.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\NoAutoUpdate"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_no_auto_update_filter`"
Windows Modify Registry NoChangingWallPaper,"The following analytic detects modifications to the Windows registry aimed at preventing wallpaper changes. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the &quot;NoChangingWallPaper&quot; registry value. This activity is significant as it is a known tactic used by Rhysida ransomware to enforce a malicious wallpaper, thereby limiting user control over system settings.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path= ""*\\Windows\\CurrentVersion\\Policies\\ActiveDesktop\\NoChangingWallPaper"" Registry.registry_value_data = 1) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_nochangingwallpaper_filter`"
Windows Modify Registry on Smart Card Group Policy,"This analytic is developed to detect suspicious registry modifications targeting the &quot;scforceoption&quot; key. Altering this key enforces smart card login for all users, potentially disrupting normal access methods. Unauthorized changes to this setting could indicate an attempt to restrict access or force a specific authentication method, possibly signifying malicious intent to manipulate system security protocols.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows\\CurrentVersion\\Policies\\System\\scforceoption*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_on_smart_card_group_policy_filter`"
Windows Modify Registry ProxyEnable,"The following analytic detects modifications to the Windows registry key &quot;ProxyEnable&quot; to enable proxy settings. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the &quot;Internet Settings\ProxyEnable&quot; registry path. This activity is significant as it is commonly exploited by malware and adversaries to establish proxy communication, potentially connecting to malicious Command and Control (C2) servers.",Windows Events,"Command And Control, Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Internet Settings\\ProxyEnable""  Registry.registry_value_data = 0x00000001 by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_proxyenable_filter`"
Windows Modify Registry ProxyServer,"The following analytic detects modifications to the Windows registry key for setting up a proxy server. It leverages data from the Endpoint.Registry datamodel, focusing on changes to the &quot;Internet Settings\ProxyServer&quot; registry path. This activity is significant as it can indicate malware or adversaries configuring a proxy to facilitate unauthorized communication with Command and Control (C2) servers.",Windows Events,"Command And Control, Exfiltration, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path = ""*\\Internet Settings\\ProxyServer"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_proxyserver_filter`"
Windows Modify Registry Regedit Silent Reg Import,"The following analytic detects the modification of the Windows registry using the regedit.exe application with the silent mode parameter. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because the silent mode allows registry changes without user confirmation, which can be exploited by adversaries to import malicious registry settings.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=""regedit.exe"" OR Processes.original_file_name=""regedit.exe"") AND Processes.process=""* /s *"" AND Processes.process=""*.reg*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_regedit_silent_reg_import_filter`"
Windows Modify Registry Risk Behavior,"The following analytic identifies instances where three or more distinct registry modification events associated with MITRE ATT&amp;CK Technique T1112 are detected. It leverages data from the Risk data model in Splunk, focusing on registry-related sources and MITRE technique annotations. This activity is significant because multiple registry modifications can indicate an attempt to persist, hide malicious configurations, or erase forensic evidence.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where source IN (""*registry*"") All_Risk.annotations.mitre_attack.mitre_technique_id IN (""*T1112*"") by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 3 
| `windows_modify_registry_risk_behavior_filter`"
Windows Modify Registry Suppress Win Defender Notif,"The following analytic detects modifications in the Windows registry to suppress Windows Defender notifications. It leverages data from the Endpoint.Registry datamodel, specifically targeting changes to the &quot;Notification_Suppress&quot; registry value. This activity is significant because adversaries, including those deploying Azorult malware, use this technique to bypass Windows Defender and disable critical notifications. If confirmed malicious, this behavior could allow attackers to evade detection, maintain persistence, and execute further malicious activities without alerting the user or security tools.",Windows Events,"Persistence, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Windows Defender\\UX Configuration\\Notification_Suppress*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_registry_suppress_win_defender_notif_filter`"
Windows Modify Registry UpdateServiceUrlAlternate,"The following analytic detects a suspicious modification to the Windows Update configuration registry key, specifically targeting the UpdateServiceUrlAlternate setting. It leverages data from the Endpoint.Registry datamodel to identify changes to this registry path. This activity is significant because adversaries, including malware like RedLine Stealer, exploit this technique to bypass detection and deploy additional payloads.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\UpdateServiceUrlAlternate"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_updateserviceurlalternate_filter`"
Windows Modify Registry USeWuServer,"The following analytic detects a suspicious modification to the Windows Update configuration registry key &quot;UseWUServer.&quot; It leverages data from the Endpoint.Registry data model to identify changes where the registry value is set to &quot;0x00000001.&quot; This activity is significant because it is commonly used by adversaries, including malware like RedLine Stealer, to bypass detection mechanisms and potentially exploit zero-day vulnerabilities.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\\UseWUServer"" AND Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_usewuserver_filter`"
Windows Modify Registry WuServer,"The following analytic detects suspicious modifications to the Windows Update Server (WUServer) registry settings. It leverages data from the Endpoint.Registry data model to identify changes in the registry path associated with Windows Update configurations. This activity is significant because adversaries, including malware like RedLine Stealer, exploit this technique to bypass detection and deploy additional payloads.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\WUServer"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_wuserver_filter`"
Windows Modify Registry wuStatusServer,"The following analytic identifies suspicious modifications to the Windows Update configuration registry, specifically targeting the WUStatusServer key. It leverages data from the Endpoint datamodel to detect changes in the registry path associated with Windows Update settings. This activity is significant as it is commonly used by adversaries, including malware like RedLine Stealer, to bypass detection and deploy additional payloads.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\WUStatusServer"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `windows_modify_registry_wustatusserver_filter`"
Windows Modify System Firewall with Notable Process Path,"The following analytic detects suspicious modifications to system firewall rules, specifically allowing execution of applications from notable and potentially malicious file paths. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving firewall rule changes. This activity is significant as it may indicate an adversary attempting to bypass firewall restrictions to execute malicious files.",Windows Events,"Execution, Exfiltration, Persistence, Defense Evasion",T1562.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*firewall*"" Processes.process = ""*allow*"" Processes.process = ""*add*"" Processes.process = ""*ENABLE*"" Processes.process IN (""*\\windows\\fonts\\*"", ""*\\windows\\temp\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"", ""*\\Users\\Administrator\\Music\\*"", ""*\\Windows\\servicing\\*"", ""*\\Users\\Default\\*"",""*Recycle.bin*"", ""*\\Windows\\Media\\*"", ""\\Windows\\repair\\*"", ""*\\temp\\*"", ""*\\PerfLogs\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_modify_system_firewall_with_notable_process_path_filter`"
Windows MOF Event Triggered Execution via WMI,"The following analytic detects the execution of MOFComp.exe loading a MOF file, often triggered by cmd.exe or powershell.exe, or from unusual paths like User Profile directories. It leverages Endpoint Detection and Response (EDR) data, focusing on process names, parent processes, and command-line executions. This activity is significant as it may indicate an attacker using WMI for persistence or lateral movement.",Windows Events,"Lateral Movement, Execution, Persistence","T1546.003, T1546","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name IN (""cmd.exe"", ""powershell.exe"") Processes.process_name=mofcomp.exe) OR (Processes.process_name=mofcomp.exe Processes.process IN (""*\\AppData\\Local\\*"",""*\\Users\\Public\\*"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_mof_event_triggered_execution_via_wmi_filter`"
Windows MSC EvilTwin Directory Path Manipulation,"The following analytic detects potential MSC EvilTwin loader exploitation, which manipulates directory paths with spaces to bypass security controls. The technique, described as CVE-2025-26633, involves crafting malicious MSC files that leverage MUIPath parameter manipulation. This detection focuses on suspicious MSC file execution patterns with unconventional command-line parameters, particularly those containing unusual spaces in Windows System32 paths or suspicious additional parameters after the MSC file.",Windows Events,"Execution, Defense Evasion","T1218, T1203, T1036.005","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""mmc.exe"" by Processes.dest Processes.user Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_id Processes.process_name Processes.process_path Processes.action Processes.original_file_name Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_integrity_level Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| regex process=""(?i).*mmc\.exe.*((Windows\s+\\\\System32)
|(Windows\s+System32)
|(\\\\Windows\s+\\\\System32)
|(Program\s+Files\s+\\\\)
|(Program\s+Files\s+\(\\w+\)\s+\\\\)
|(Progra~1\s+\\\\))"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msc_eviltwin_directory_path_manipulation_filter`"
Windows MsiExec HideWindow Rundll32 Execution,"The following analytic detects the execution of the msiexec.exe process with the /HideWindow and rundll32 command-line parameters. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events and command-line arguments. This activity is significant because it is a known tactic used by malware like QakBot to mask malicious operations under legitimate system processes.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name = msiexec.exe  Processes.process = ""* /HideWindow *"" Processes.process = ""* rundll32*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msiexec_hidewindow_rundll32_execution_filter`"
Windows MSIExec Spawn WinDBG,"The following analytic identifies the unusual behavior of MSIExec spawning WinDBG. It detects this activity by analyzing endpoint telemetry data, specifically looking for instances where 'msiexec.exe' is the parent process of 'windbg.exe'. This behavior is significant as it may indicate an attempt to debug or tamper with system processes, which is uncommon in typical user activity and could signify malicious intent.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=msiexec.exe Processes.process_name=windbg.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_msiexec_spawn_windbg_filter`"
Windows MSIExec Unregister DLLRegisterServer,"The following analytic detects the use of msiexec.exe with the /z switch parameter, which is used to unload DLLRegisterServer. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs, including command-line arguments. This activity is significant because unloading DLLRegisterServer can be indicative of an attempt to deregister a DLL, potentially disrupting legitimate services or hiding malicious activity.",Windows Events,"Execution, Exfiltration, Defense Evasion",T1218.007,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_msiexec` Processes.process IN (""*/z*"", ""*-z*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_msiexec_unregister_dllregisterserver_filter`"
Windows Multiple Account Passwords Changed,"The following analytic detects instances where more than five unique Windows account passwords are changed within a 10-minute interval. It leverages Event Code 4724 from the Windows Security Event Log, using the wineventlog_security dataset to monitor and count distinct TargetUserName values. This behavior is significant as rapid password changes across multiple accounts are unusual and may indicate unauthorized access or internal compromise.",Windows Events,"Persistence, Privilege Escalation","T1098, T1078","`wineventlog_security` EventCode=4724 status=success 
| bucket span=10m _time 
| stats count dc(user) as unique_users values(user) as user values(dest) as dest by EventCode signature _time src_user SubjectDomainName TargetDomainName Logon_ID 
| where unique_users > 5 
| `windows_multiple_account_passwords_changed_filter`"
Windows Multiple Accounts Deleted,"The following analytic detects the deletion of more than five unique Windows accounts within a 10-minute period, using Event Code 4726 from the Windows Security Event Log. It leverages the wineventlog_security dataset, segmenting data into 10-minute intervals to identify suspicious account deletions. This activity is significant as it may indicate an attacker attempting to erase traces of their actions.",Windows Events,"Persistence, Privilege Escalation","T1098, T1078","`wineventlog_security` EventCode=4726 status=success 
| bucket span=10m _time 
| stats count dc(user) as unique_users values(user) as user values(dest) as dest by EventCode signature _time src_user SubjectDomainName TargetDomainName Logon_ID 
| where unique_users > 5 
| `windows_multiple_accounts_deleted_filter`"
Windows Multiple Accounts Disabled,"The following analytic identifies instances where more than five unique Windows accounts are disabled within a 10-minute window, as indicated by Event Code 4725 in the Windows Security Event Log. It leverages the wineventlog_security dataset, grouping data into 10-minute segments and tracking the count and distinct count of TargetUserName. This behavior is significant as it may indicate internal policy breaches or an external attacker's attempt to disrupt operations.",Windows Events,"Persistence, Privilege Escalation","T1098, T1078","`wineventlog_security` EventCode=4725 status=success 
| bucket span=10m _time 
| stats count dc(user) as unique_users values(user) as user values(dest) as dest by EventCode signature _time src_user SubjectDomainName TargetDomainName Logon_ID 
| where unique_users > 5 
| `windows_multiple_accounts_disabled_filter`"
Windows Multiple Disabled Users Failed To Authenticate Wth Kerberos,"The following analytic detects a single source endpoint failing to authenticate with 30 unique disabled domain users using the Kerberos protocol within 5 minutes. It leverages Windows Security Event 4768, focusing on failure code 0x12, indicating revoked credentials. This activity is significant as it may indicate a Password Spraying attack targeting disabled accounts, a tactic used by adversaries to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4768 TargetUserName!=*$ Status=0x12 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| where unique_accounts > 30 
| `windows_multiple_disabled_users_failed_to_authenticate_wth_kerberos_filter`"
Windows Multiple Invalid Users Fail To Authenticate Using Kerberos,"The following analytic identifies a source endpoint failing to authenticate with 30 unique invalid domain users using the Kerberos protocol. This detection leverages EventCode 4768, specifically looking for failure code 0x6, indicating the user is not found in the Kerberos database. This activity is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4768 TargetUserName!=*$ Status=0x6 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| where unique_accounts > 30 
| `windows_multiple_invalid_users_fail_to_authenticate_using_kerberos_filter`"
Windows Multiple Invalid Users Failed To Authenticate Using NTLM,"The following analytic detects a single source endpoint failing to authenticate with 30 unique invalid users using the NTLM protocol. It leverages EventCode 4776 from Domain Controller logs, focusing on error code 0xC0000064, which indicates non-existent usernames. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4776 TargetUserName!=*$ Status=0xc0000064 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest by _time, Workstation 
| where unique_accounts > 30 
| `windows_multiple_invalid_users_failed_to_authenticate_using_ntlm_filter`"
Windows Multiple Users Fail To Authenticate Wth ExplicitCredentials,"The following analytic identifies a source user failing to authenticate with 30 unique users using explicit credentials on a host. It leverages Windows Event 4648, which is generated when a process attempts an account logon by explicitly specifying account credentials. This detection is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges within an Active Directory environment.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4648 Caller_User_Name!=*$ Target_User_Name!=*$ 
| bucket span=5m _time 
| stats dc(Target_User_Name) AS unique_accounts values(Target_User_Name) as tried_account values(dest) as dest values(src_ip) as src_ip values(user) as user by _time, Computer, Caller_User_Name 
| where unique_accounts > 30 
| `windows_multiple_users_fail_to_authenticate_wth_explicitcredentials_filter`"
Windows Multiple Users Failed To Authenticate From Host Using NTLM,"The following analytic identifies a single source endpoint failing to authenticate with 30 unique valid users using the NTLM protocol. It leverages EventCode 4776 from Domain Controller logs, focusing on error code 0xC000006A, which indicates a bad password. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access","T1110.003, T1110","`wineventlog_security` EventCode=4776 TargetUserName!=*$ Status=0xC000006A 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest by _time, Workstation 
| where unique_accounts > 30 
| `windows_multiple_users_failed_to_authenticate_from_host_using_ntlm_filter`"
Windows Multiple Users Failed To Authenticate From Process,"The following analytic detects a source process failing to authenticate with 30 unique users, indicating a potential Password Spraying attack. It leverages Windows Event 4625 with Logon Type 2, collected from domain controllers, member servers, and workstations. This activity is significant as it may represent an adversary attempting to gain initial access or elevate privileges within an Active Directory environment.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4625 Logon_Type=2 ProcessName!=""-"" 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest values(src) as src values(user) as user by _time, ProcessName, SubjectUserName, Computer, action, app, authentication_method, signature, signature_id 
| rename Computer as dest 
| where unique_accounts > 30 
| `windows_multiple_users_failed_to_authenticate_from_process_filter`"
Windows Multiple Users Failed To Authenticate Using Kerberos,"The following analytic identifies a single source endpoint failing to authenticate with 30 unique users using the Kerberos protocol. It leverages EventCode 4771 with Status 0x18, indicating wrong password attempts, and aggregates these events over a 5-minute window. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges in an Active Directory environment.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4771 TargetUserName!=""*$"" Status=0x18 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| where unique_accounts > 30 
| `windows_multiple_users_failed_to_authenticate_using_kerberos_filter`"
Windows Multiple Users Remotely Failed To Authenticate From Host,"The following analytic identifies a source host failing to authenticate against a remote host with 30 unique users. It leverages Windows Event 4625 with Logon Type 3, indicating remote authentication attempts. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges in an Active Directory environment.",Windows Events,"Initial Access, Discovery, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4625 Logon_Type=3 IpAddress!=""-"" 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest values(src) as src values(user) as user by _time, IpAddress, Computer, action, app, authentication_method, signature, signature_id 
| rename Computer as dest 
| where unique_accounts > 30 
| `windows_multiple_users_remotely_failed_to_authenticate_from_host_filter`"
Windows Network Connection Discovery Via Net,"The following analytic identifies the execution of net.exe with command-line arguments used to list or display information about computer connections. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity can be significant as it indicates potential network reconnaissance by adversaries or Red Teams, aiming to gather situational awareness and Active Directory information.",Windows Events,"Lateral Movement, Execution, Discovery, Exfiltration",T1049,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (`process_net` OR (Processes.process_name=""net.exe"" OR Processes.original_file_name=""net.exe"")) AND (Processes.process=*use) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_network_connection_discovery_via_net_filter`"
Windows Network Share Interaction Via Net,"The following analytic identifies network share discovery and collection activities performed on Windows systems using the Net command. Attackers often use network share discovery to identify accessible shared resources within a network, which can be a precursor to privilege escalation or data exfiltration. By monitoring Windows Event Logs for the usage of the Net command to list and interact with network shares, this detection helps identify potential reconnaissance and collection activities.",Windows Events,"Execution, Collection, Privilege Escalation, Discovery, Exfiltration","T1135, T1039","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes WHERE (`process_net` OR (Processes.process_name=""net.exe"" OR Processes.original_file_name=""net.exe"")) AND Processes.process IN (""*use *"", ""*view*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_network_share_interaction_via_net_filter`"
Windows New Default File Association Value Set,"The following analytic detects registry changes to the default file association value. It leverages data from the Endpoint data model, specifically monitoring registry paths under &quot;HKCR\\shell\open\command\&quot;. This activity can be significant because, attackers might alter the default file associations in order to execute arbitrary scripts or payloads when a user opens a file, leading to potential code execution.",Windows Events,"Execution, Persistence, Privilege Escalation",T1546.001,"| tstats `security_content_summariesonly` count  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path=""*\\shell\\open\\command\\*"" Registry.registry_path IN (""*HKCR\\*"", ""*HKEY_CLASSES_ROOT\\*"") by Registry.dest  Registry.user Registry.registry_path Registry.registry_key_name Registry.registry_value_name Registry.registry_value_data 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_new_default_file_association_value_set_filter`"
Windows New EventLog ChannelAccess Registry Value Set,"The following analytic detects suspicious modifications to the EventLog security descriptor registry value for defense evasion. It leverages data from the Endpoint.Registry data model, focusing on changes to the &quot;CustomSD&quot; value within the &quot;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Eventlog&lt;Channel&gt;\CustomSD&quot; path. This activity is significant as changes to the access permissions of the event log could blind security products and help attackers evade defenses.",Windows Events,Defense Evasion,"T1562.002, T1562","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path IN (""*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\*"", ""*\Microsoft\Windows\EventLog\*"") AND Registry.registry_value_name=ChannelAccess by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_new_eventlog_channelaccess_registry_value_set_filter`"
Windows Ngrok Reverse Proxy Usage,"The following analytic detects the execution of ngrok.exe on a Windows operating system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant because while ngrok is a legitimate tool for creating secure tunnels, it is increasingly used by adversaries to bypass network defenses and establish reverse proxies.",Windows Events,"Command And Control, Execution, Persistence","T1102, T1572, T1090","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=ngrok.exe Processes.process IN (""*start*"", ""*--config*"",""*http*"",""*authtoken*"", ""*http*"", ""*tcp*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_ngrok_reverse_proxy_usage_filter`"
Windows NirSoft AdvancedRun,"The following analytic detects the execution of AdvancedRun.exe, a tool with capabilities similar to remote administration programs like PsExec. It identifies the process by its name or original file name and flags common command-line arguments. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line telemetry. Monitoring this activity is crucial as AdvancedRun can be used for remote code execution and configuration-based automation.",Windows Events,"Execution, Persistence",T1588.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=advancedrun.exe OR Processes.original_file_name=advancedrun.exe) Processes.process IN (""*EXEFilename*"",""*/cfg*"",""*RunAs*"", ""*WindowState*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_nirsoft_advancedrun_filter`"
Windows Odbcconf Hunting,"The following analytic identifies the execution of Odbcconf.exe within the environment. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where the process name is Odbcconf.exe. This activity is significant because Odbcconf.exe can be used by attackers to execute arbitrary commands or load malicious DLLs, potentially leading to code execution or persistence.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.008,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=odbcconf.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_odbcconf_hunting_filter`"
Windows Odbcconf Load DLL,"The following analytic detects the execution of odbcconf.exe with the regsvr action to load a DLL. This is identified by monitoring command-line arguments in process creation logs from Endpoint Detection and Response (EDR) agents. This activity is significant as it may indicate an attempt to execute arbitrary code via DLL loading, a common technique used in various attack vectors.",Windows Events,"Lateral Movement, Execution, Defense Evasion",T1218.008,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=odbcconf.exe Processes.process IN (""*/a *"",  ""*-a*"") Processes.process=""*regsvr*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_odbcconf_load_dll_filter`"
Windows Odbcconf Load Response File,"The following analytic detects the execution of odbcconf.exe with a response file, which may contain commands to load a DLL (REGSVR) or other instructions. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as it may indicate an attempt to execute arbitrary code or load malicious DLLs, potentially leading to unauthorized actions.",Windows Events,"Execution, Persistence, Defense Evasion",T1218.008,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=odbcconf.exe Processes.process IN (""*-f *"",""*/f *"") Processes.process=""*.rsp*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_odbcconf_load_response_file_filter`"
Windows Office Product Dropped Uncommon File,"The following analytic detects Microsoft Office applications dropping or creating executables or scripts on a Windows OS. It leverages process creation and file system events from the Endpoint data model to identify Office applications like Word or Excel generating files with extensions such as &quot;.exe&quot;, &quot;.dll&quot;, or &quot;.ps1&quot;. This behavior is significant as it is often associated with spear-phishing attacks where malicious files are dropped to compromise the host.",Windows Events,"Initial Access, Execution, Privilege Escalation",T1566.001,"| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where `process_office_products` by _time span=1h Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| join process_guid, _time [
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name IN (""*.dll"", ""*.exe"", ""*.js"", ""*.pif"", ""*.ps1"", ""*.scr"", ""*.vbe"", ""*.vbs"") by _time span=1h Filesystem.dest Filesystem.file_create_time Filesystem.file_name Filesystem.process_guid Filesystem.file_path 
| `drop_dm_object_name(Filesystem)` 
| fields _time dest file_create_time file_name file_path process_name process_path process process_guid] 
| dedup file_create_time 
| table dest, process_name, process, file_create_time, file_name, file_path, process_guid 
| `windows_office_product_dropped_uncommon_file_filter`"
Windows Office Product Loaded MSHTML Module,"The following analytic detects the loading of the mshtml.dll module into an Office product, which is indicative of CVE-2021-40444 exploitation. It leverages Sysmon EventID 7 to monitor image loads by specific Office processes. This activity is significant because it can indicate an attempt to exploit a vulnerability in the MSHTML component via a malicious document.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"`sysmon` EventID=7 process_name IN (""EQNEDT32.exe"", ""excel.exe"", ""Graph.exe"", ""msaccess.exe"", ""mspub.exe"", ""onenote.exe"", ""onenoteim.exe"", ""onenotem.exe"", ""outlook.exe"", ""powerpnt.exe"", ""visio.exe"", ""winproj.exe"", ""winword.exe"", ""wordpad.exe"", ""wordview.exe"") loaded_file_path IN (""*\\mshtml.dll"", ""*\\Microsoft.mshtml.dll"",""*\\IE.Interop.MSHTML.dll"",""*\\MshtmlDac.dll"",""*\\MshtmlDed.dll"",""*\\MshtmlDer.dll"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_office_product_loaded_mshtml_module_filter`"
Windows Office Product Loading Taskschd DLL,"The following analytic detects an Office document creating a scheduled task, either through a macro VBA API or by loading taskschd.dll. This detection leverages Sysmon EventCode 7 to identify when Office applications load the taskschd.dll file. This activity is significant as it is a common technique used by malicious macro malware to establish persistence or initiate beaconing.",Windows Events,"Initial Access, Persistence",T1566.001,"`sysmon` EventCode=7 process_name IN (""EQNEDT32.exe"", ""excel.exe"", ""Graph.exe"", ""msaccess.exe"", ""mspub.exe"", ""onenote.exe"", ""onenoteim.exe"", ""onenotem.exe"", ""outlook.exe"", ""powerpnt.exe"", ""visio.exe"", ""winproj.exe"", ""winword.exe"") loaded_file_path = ""*\\taskschd.dll"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_office_product_loading_taskschd_dll_filter`"
Windows Office Product Loading VBE7 DLL,"The following analytic identifies office documents executing macro code. It leverages Sysmon EventCode 7 to detect when processes like WINWORD.EXE or EXCEL.EXE load specific DLLs associated with macros (e.g., VBE7.DLL). This activity is significant because macros are a common attack vector for delivering malicious payloads, such as malware. If confirmed malicious, this could lead to unauthorized code execution, data exfiltration, or further compromise of the system.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"`sysmon` EventCode=7 process_name IN (""EQNEDT32.exe"", ""excel.exe"", ""Graph.exe"", ""msaccess.exe"", ""mspub.exe"", ""onenote.exe"", ""onenoteim.exe"", ""onenotem.exe"", ""outlook.exe"", ""powerpnt.exe"", ""visio.exe"", ""winproj.exe"", ""winword.exe"") loaded_file_path IN (""*\\VBE7INTL.DLL"", ""*\\VBE7.DLL"", ""*\\VBEUI.DLL"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_office_product_loading_vbe7_dll_filter`"
Windows Office Product Spawned Control,"The following analytic identifies instances where control.exe is spawned by a Microsoft Office product. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. This activity is significant because it can indicate exploitation attempts related to CVE-2021-40444, where control.exe is used to execute malicious .cpl or .",Windows Events,"Initial Access, Execution, Exfiltration, Lateral Movement","T1218.002, T1566.001, T1218","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_office_products_parent` Processes.process_name=control.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_office_product_spawned_control_filter`"
Windows Office Product Spawned MSDT,"The following analytic detects a Microsoft Office product spawning the Windows msdt.exe process. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where Office applications are the parent process. This activity is significant as it may indicate an attempt to exploit protocol handlers to bypass security controls, even if macros are disabled.",Windows Events,"Initial Access, Execution, Exfiltration, Lateral Movement",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_office_products_parent` Processes.process_name=msdt.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_office_product_spawned_msdt_filter`"
Windows Office Product Spawned Rundll32 With No DLL,"The following analytic detects any Windows Office Product spawning rundll32.exe without a .dll file extension. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process and parent process relationships. This activity is significant as it is a known tactic of the IcedID malware family, which can lead to unauthorized code execution.",Windows Events,"Initial Access, Execution, Exfiltration",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_office_products_parent` `process_rundll32` (Processes.process!=*.dll*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_office_product_spawned_rundll32_with_no_dll_filter`"
Windows Outlook WebView Registry Modification,"The following analytic identifies modifications to specific Outlook registry values related to WebView and Today features. It detects when a URL is set in these registry locations, which could indicate attempts to manipulate Outlook's web-based components. The analytic focuses on changes to the &quot;URL&quot; value within Outlook's WebView and Today registry paths. This activity is significant as it may represent an attacker's effort to redirect Outlook's web content or inject malicious URLs.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count values(Registry.registry_value_name) as registry_value_name values(Registry.registry_value_data) as registry_value_data min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where (Registry.registry_path=""*\\Software\\Microsoft\\Office\\*\\Outlook\\WebView\\*"" OR Registry.registry_path=""*\\Software\\Microsoft\\Office\\*\\Outlook\\Today"") AND Registry.registry_value_name=""URL"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_outlook_webview_registry_modification_filter`"
Windows PaperCut NG Spawn Shell,"The following analytic detects instances where the PaperCut NG application (pc-app.exe) spawns a Windows shell, such as cmd.exe or PowerShell. This behavior is identified using Endpoint Detection and Response (EDR) telemetry, focusing on process creation events where the parent process is pc-app.exe. This activity is significant as it may indicate an attacker attempting to gain unauthorized access or execute malicious commands on the system.",Windows Events,"Initial Access, Execution, Discovery, Privilege Escalation","T1190, T1133, T1059","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=pc-app.exe `process_cmd` OR `process_powershell` OR Processes.process_name=java.exe by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_papercut_ng_spawn_shell_filter`"
Windows Password Policy Discovery with Net,"The following analytic identifies the execution of net.exe with command line arguments aimed at obtaining the computer or domain password policy. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to gather information about Active Directory password policies.",Windows Events,"Execution, Discovery",T1201,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process = ""*accounts*"" AND NOT Processes.process IN (""*/FORCELOGOFF*"", ""*/MINPWLEN*"", ""*/MAXPWAGE*"", ""*/MINPWAGE*"", ""*/UNIQUEPW*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_password_policy_discovery_with_net_filter`"
Windows Phishing PDF File Executes URL Link,"The following analytic detects suspicious PDF viewer processes spawning browser application child processes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process names. This activity is significant as it may indicate a PDF spear-phishing attempt where a malicious URL link is executed, leading to potential payload download.",Windows Events,"Initial Access, Execution, Discovery",T1566.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name  IN (""AcroRd32.exe"", ""FoxitPDFReader.exe"") Processes.process_name IN (""firefox.exe"", ""chrome.exe"", ""iexplore.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_phishing_pdf_file_executes_url_link_filter`"
Windows Post Exploitation Risk Behavior,"The following analytic identifies four or more distinct post-exploitation behaviors on a Windows system. It leverages data from the Risk data model in Splunk Enterprise Security, focusing on multiple risk events and their associated MITRE ATT&amp;CK tactics and techniques. This activity is significant as it indicates potential malicious actions following an initial compromise, such as persistence, privilege escalation, or data exfiltration.",Windows Events,"Credential Access, Collection, Persistence, Privilege Escalation, Discovery, Exfiltration","T1016, T1115, T1049, T1552, T1082, T1012, T1003, T1069","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count from datamodel=Risk.All_Risk where All_Risk.analyticstories IN (""*Windows Post-Exploitation*"") by All_Risk.risk_object All_Risk.risk_object_type All_Risk.annotations.mitre_attack.mitre_tactic 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where source_count >= 4 
| `windows_post_exploitation_risk_behavior_filter`"
Windows Powershell Logoff User via Quser,"The following analytic detects the process of logging off a user through the use of the quser and logoff commands. By monitoring for these commands, the analytic identifies actions where a user session is forcibly terminated, which could be part of an administrative task or a potentially unauthorized access attempt. This detection helps identify potential misuse or malicious activity where a userâ€™s access is revoked without proper authorization, providing insight into potential security incidents involving account management or session manipulation.",Windows Events,"Execution, Impact","T1059.001, T1531","`powershell` EventCode=4104 ScriptBlockText = ""*quser*logoff*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_logoff_user_via_quser_filter`"
Windows Powershell RemoteSigned File,"The following analytic identifies the use of the &quot;remotesigned&quot; execution policy for PowerShell scripts. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions containing &quot;remotesigned&quot; and &quot;-File&quot;. This activity is significant because the &quot;remotesigned&quot; policy allows locally created scripts to run without restrictions, posing a potential security risk. If confirmed malicious, an attacker could execute unauthorized scripts, leading to code execution, privilege escalation, or persistence within the environment.",Windows Events,"Discovery, Execution, Persistence, Privilege Escalation",T1059.001,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_powershell` Processes.process=""* remotesigned *"" Processes.process=""* -File *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powershell_remotesigned_file_filter`"
Windows PowerView Constrained Delegation Discovery,The following analytic detects the use of PowerView commandlets to discover Windows endpoints with Kerberos Constrained Delegation. It leverages PowerShell Script Block Logging (EventCode=4104) to identify specific commandlets like Get-DomainComputer or Get-NetComputer with the -TrustedToAuth parameter. This activity is significant as it indicates potential reconnaissance efforts by adversaries or Red Teams to map out privileged delegation settings in Active Directory.,Windows Events,"Lateral Movement, Discovery, Privilege Escalation",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainComputer*"" OR ScriptBlockText = ""*Get-NetComputer*"") AND (ScriptBlockText = ""*-TrustedToAuth*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powerview_constrained_delegation_discovery_filter`"
Windows PowerView Kerberos Service Ticket Request,"The following analytic detects the execution of the Get-DomainSPNTicket commandlet, part of the PowerView tool, by leveraging PowerShell Script Block Logging (EventCode=4104). This commandlet requests Kerberos service tickets for specified service principal names (SPNs). Monitoring this activity is crucial as it can indicate attempts to perform Kerberoasting, a technique used to extract SPN account passwords via cracking tools like hashcat.",Windows Events,"Discovery, Execution, Credential Access, Privilege Escalation","T1558.003, T1558","`powershell` EventCode=4104 ScriptBlockText=*Get-DomainSPNTicket* 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powerview_kerberos_service_ticket_request_filter`"
Windows PowerView Unconstrained Delegation Discovery,The following analytic detects the use of PowerView commandlets to discover Windows endpoints with Kerberos Unconstrained Delegation. It leverages PowerShell Script Block Logging (EventCode=4104) to identify specific commands like Get-DomainComputer or Get-NetComputer with the -Unconstrained parameter. This activity is significant as it indicates potential reconnaissance efforts by adversaries or Red Teams to map out privileged delegation settings in Active Directory.,Windows Events,"Lateral Movement, Discovery, Privilege Escalation",T1018,"`powershell` EventCode=4104 (ScriptBlockText = ""*Get-DomainComputer*"" OR ScriptBlockText = ""*Get-NetComputer*"") AND (ScriptBlockText = ""*-Unconstrained*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_powerview_unconstrained_delegation_discovery_filter`"
Windows Process Injection With Public Source Path,"The following analytic detects a process from a non-standard file path on Windows attempting to create a remote thread in another process. This is identified using Sysmon EventCode 8, focusing on processes not originating from typical system directories. This behavior is significant as it often indicates process injection, a technique used by adversaries to evade detection or escalate privileges.",Windows Events,"Discovery, Defense Evasion",T1055.002,"`sysmon` EventCode=8 TargetImage = ""*.exe"" AND NOT(SourceImage IN(""C:\\Windows\\*"", ""C:\\Program File*"", ""%systemroot%\\*"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by EventID Guid NewThreadId ProcessID SecurityID SourceImage SourceProcessGuid SourceProcessId StartAddress StartFunction StartModule TargetImage TargetProcessGuid TargetProcessId UserID dest parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_injection_with_public_source_path_filter`"
Windows Process With NamedPipe CommandLine,"The following analytic detects processes with command lines containing named pipes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line executions. This behavior is significant as it is often used by adversaries, such as those behind the Olympic Destroyer malware, for inter-process communication post-injection, aiding in defense evasion and privilege escalation.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = ""*\\\\.\\pipe\\*"" NOT Processes.process_path IN (""C:\\Program Files\\*"", ""C:\\Program Files (x86)\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_with_namedpipe_commandline_filter`"
Windows Process With NetExec Command Line Parameters,"The following analytic detects the use of NetExec (formally CrackmapExec) a toolset used for post-exploitation enumeration and attack within Active Directory environments through command line parameters. It leverages Endpoint Detection and Response (EDR) data to identify specific command-line arguments associated with actions like ticket manipulation, kerberoasting, and password spraying. This activity is significant as NetExec is used by adversaries to exploit Kerberos for privilege escalation and lateral movement.",Windows Events,"Execution, Credential Access, Lateral Movement, Persistence, Privilege Escalation, Defense Evasion","T1550.003, T1558.003, T1558.004","| tstats `security_content_summariesonly` count min(_time) AS firstTime, max(_time) AS lastTime FROM datamodel=Endpoint.Processes where NOT Processes.os=""Linux"" Processes.process_name IN (""nxc.exe"") OR Processes.original_file_name IN (""nxc.exe"") OR (Processes.process IN (""* smb *"",""* ssh *"",""* ldap *"",""* ftp *"",""* wmi *"",""* winrm *"",""* rdp *"",""* vnc *"",""* mssql *"",""* nfs *"") AND ((Processes.process = ""* -p *"" AND Processes.process = ""* -u *"") OR Processes.process IN (""* -x *"",""* -M *"",""* --*""))) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_process_with_netexec_command_line_parameters_filter`"
Windows Processes Killed By Industroyer2 Malware,"The following analytic detects the termination of specific processes by the Industroyer2 malware. It leverages Sysmon EventCode 5 to identify when processes like &quot;PServiceControl.exe&quot; and &quot;PService_PPD.exe&quot; are killed. This activity is significant as it targets processes related to energy facility networks, indicating a potential attack on critical infrastructure. If confirmed malicious, this could lead to disruption of essential services, loss of control over energy systems, and significant operational impact.",Windows Events,Impact,T1489,"`sysmon` EventCode=5 process_name IN (""PServiceControl.exe"", ""PService_PPD.exe"") 
| stats min(_time) as firstTime max(_time) as lastTime count by dest process process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_processes_killed_by_industroyer2_malware_filter`"
Windows Protocol Tunneling with Plink,"This analytic detects the use of Plink (including renamed versions like pvhost.exe) for protocol tunneling, which may be used for egress or lateral movement within an organization. It identifies specific command-line options (-R, -L, -D, -l, -N, -P, -pw) commonly used for port forwarding and tunneling by analyzing process execution logs from Endpoint Detection and Response (EDR) agents.",Windows Events,"Lateral Movement, Execution, Command And Control, Exfiltration","T1572, T1021.004","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=plink.exe OR Processes.process_name=pvhost.exe OR Processes.original_file_name=Plink) AND Processes.process IN (""*-R *"", ""*-L *"", ""*-D *"", ""*-l *"", ""*-N *"", ""*-P *"", ""*-pw *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_protocol_tunneling_with_plink_filter`"
Windows Proxy Via Netsh,"The following analytic identifies the use of netsh.exe to configure a connection proxy, which can be leveraged for persistence by executing a helper DLL. It detects this activity by analyzing process creation events from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;portproxy&quot; and &quot;v4tov4&quot; parameters. This activity is significant because it indicates potential unauthorized network configuration changes, which could be used to maintain persistence or redirect network traffic.",Windows Events,"Command And Control, Execution, Persistence",T1090.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh` Processes.process = ""* portproxy *"" Processes.process = ""* v4tov4 *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
|`drop_dm_object_name(""Processes"")` 
|`security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_proxy_via_netsh_filter`"
Windows Query Registry Browser List Application,"The following analytic detects a suspicious process accessing the registry entries for default internet browsers. It leverages Windows Security Event logs, specifically event code 4663, to identify access attempts to these registry paths. This activity is significant because adversaries can exploit this registry key to gather information about installed browsers and their settings, potentially leading to the theft of sensitive data such as login credentials and browsing history.",Windows Events,Discovery,T1012,"`wineventlog_security` EventCode=4663 object_file_path IN (""*\\SOFTWARE\\Clients\\StartMenuInternet\\*"", ""*\\SOFTWARE\\Clients\\StartMenuInternet\\*"") AND NOT process_path IN (""*:\\Windows\\System32\\*"", ""*:\\Windows\\SysWow64\\*"", *:\\Windows\\WinSxS\\*, ""*:\\Program Files\\*"", ""*:\\Program Files (x86)\\*"") 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name process_path  process_id EventCode dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_query_registry_browser_list_application_filter`"
Windows Raccine Scheduled Task Deletion,"The following analytic identifies the deletion of the Raccine Rules Updater scheduled task using the schtasks.exe command. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because adversaries may delete this task to disable Raccine, a tool designed to prevent ransomware attacks.",Windows Events,"Execution, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe Processes.process=""*delete*"" AND Processes.process=""*Raccine*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_raccine_scheduled_task_deletion_filter`"
Windows Rapid Authentication On Multiple Hosts,The following analytic detects a source computer authenticating to 30 or more remote endpoints within a 5-minute timespan using Event ID 4624. This behavior is identified by analyzing Windows Event Logs for LogonType 3 events and counting unique target computers. Such activity is significant as it may indicate lateral movement or network share enumeration by an adversary.,Windows Events,"Lateral Movement, Credential Access, Privilege Escalation","T1135, T1003.002","`wineventlog_security` EventCode=4624 LogonType=3 TargetUserName!=""ANONYMOUS LOGON"" TargetUserName!=""*$"" 
| bucket span=5m _time 
| stats dc(Computer) AS unique_targets values(Computer) as host_targets values(dest) as dest values(src) as src values(user) as user by _time, IpAddress, TargetUserName, action, app, authentication_method, signature, signature_id 
| where unique_targets > 30 
| `windows_rapid_authentication_on_multiple_hosts_filter`"
Windows Registry BootExecute Modification,"The following analytic detects modifications to the BootExecute registry key, which manages applications and services executed during system boot. It leverages data from the Endpoint.Registry data model, focusing on changes to the registry path &quot;HKLM\System\CurrentControlSet\Control\Session Manager\BootExecute&quot;. This activity is significant because unauthorized changes to this key can indicate attempts to achieve persistence, load malicious code, or tamper with the boot process.",Windows Events,"Persistence, Defense Evasion","T1542, T1547.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\System\\CurrentControlSet\\Control\\Session Manager\\BootExecute"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_registry_bootexecute_modification_filter`"
Windows Registry Certificate Added,"The following analytic detects the installation of a root CA certificate by monitoring specific registry paths for SetValue events. It leverages data from the Endpoint datamodel, focusing on registry paths containing &quot;certificates&quot; and registry values named &quot;Blob.&quot; This activity is significant because unauthorized root CA certificates can compromise the integrity of encrypted communications and facilitate man-in-the-middle attacks.",Windows Events,Defense Evasion,T1553.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\certificates\\*"") AND Registry.registry_value_name=""Blob"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_certificate_added_filter`"
Windows Registry Dotnet ETW Disabled Via ENV Variable,"The following analytic detects a registry modification that disables the ETW for the .NET Framework. It leverages data from the Endpoint.Registry data model, specifically monitoring changes to the COMPlus_ETWEnabled registry value under the &quot;Environment&quot; registry key path for both user (HKCU\Environment) and machine (HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Environment) scopes. This activity is significant because disabling ETW can allow attackers to evade Endpoint Detection and Response (EDR) tools and hide their execution from audit logs.",Windows Events,"Execution, Defense Evasion","T1562.006, T1562","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path=""*\\Environment*"" Registry.registry_value_name=""COMPlus_ETWEnabled"" (Registry.registry_value_data=0x000000000 OR Registry.registry_value_data=0) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_dotnet_etw_disabled_via_env_variable_filter`"
Windows Registry Entries Exported Via Reg,"The following analytic detects the execution of the reg.exe process with either the &quot;save&quot; or &quot;export&quot; parameters. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant because threat actors often use the &quot;reg save&quot; or &quot;reg export&quot; command to dump credentials or test registry modification capabilities on compromised hosts.",Windows Events,"Execution, Impact, Discovery",T1012,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` AND Processes.process IN (""* save *"", ""* export *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_entries_exported_via_reg_filter`"
Windows Registry Entries Restored Via Reg,"The following analytic detects the execution of reg.exe with the &quot;restore&quot; parameter, indicating an attempt to restore registry backup data on a host. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant as it may indicate post-exploitation actions, such as those performed by tools like winpeas, which use &quot;reg save&quot; and &quot;reg restore&quot; to manipulate registry settings.",Windows Events,"Discovery, Execution, Impact, Persistence",T1012,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_reg` AND Processes.process = ""* restore *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_entries_restored_via_reg_filter`"
Windows Registry Modification for Safe Mode Persistence,"The following analytic identifies modifications to the SafeBoot registry keys, specifically within the Minimal and Network paths. This detection leverages registry activity logs from endpoint data sources like Sysmon or EDR tools. Monitoring these keys is crucial as adversaries can use them to persist drivers or services in Safe Mode, with Network allowing network connections.",Windows Events,Persistence,"T1112, T1547.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path IN (""*SYSTEM\\CurrentControlSet\\Control\\SafeBoot\\Minimal\\*"",""*SYSTEM\\CurrentControlSet\\Control\\SafeBoot\\Network\\*"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_registry_modification_for_safe_mode_persistence_filter`"
Windows Registry SIP Provider Modification,"The following analytic detects modifications to the Windows Registry SIP Provider. It leverages Sysmon EventID 7 to monitor registry changes in paths and values related to Cryptography Providers and OID Encoding Types. This activity is significant as it may indicate an attempt to subvert trust controls, a common tactic for bypassing security measures and maintaining persistence.",Windows Events,"Persistence, Defense Evasion","T1553, T1553.003","| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path IN (""*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\*"", ""*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType*"", ""*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\*"", ""*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType*"") Registry.registry_value_name IN (""Dll"",""$DLL"") by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)`
| `windows_registry_sip_provider_modification_filter`"
Windows Remote Access Software BRC4 Loaded Dll,"The following analytic identifies the loading of four specific Windows DLLs (credui.dll, dbghelp.dll, samcli.dll, winhttp.dll) by a non-standard process. This detection leverages Sysmon EventCode 7 to monitor DLL load events and flags when all four DLLs are loaded within a short time frame. This activity is significant as it may indicate the presence of Brute Ratel C4, a sophisticated remote access tool used for credential dumping and other malicious activities.",Windows Events,"Command And Control, Credential Access","T1219, T1003","`sysmon` EventCode=7 
| bin _time span=30s 
| eval BRC4_AnomalyLoadedDll=case(OriginalFileName==""credui.dll"", 1, OriginalFileName==""DBGHELP.DLL"", 1, OriginalFileName==""SAMCLI.DLL"", 1, OriginalFileName==""winhttp.dll"", 1, 1=1, 0) 
| eval BRC4_LoadedDllPath=case(match(ImageLoaded, ""credui.dll""), 1, match(ImageLoaded, ""dbghelp.dll""), 1, match(ImageLoaded, ""samcli.dll""), 1, match(ImageLoaded, ""winhttp.dll""), 1, 1=1, 0) 
| stats count min(_time) as firstTime max(_time) as lastTime values(ImageLoaded) as ImageLoaded values(OriginalFileName) as OriginalFileName dc(ImageLoaded) as ImageLoadedCount values(loaded_file) as loaded_file values(loaded_file_path) as loaded_file_path values(original_file_name) as original_file_name values(process_exec) as process_exec values(process_guid) as process_guid values(process_hash) as process_hash values(process_id) as process_id values(process_name) as process_name values(process_path) as process_path values(service_dll_signature_exists) as service_dll_signature_exists values(service_dll_signature_verified) as service_dll_signature_verified values(signature) as signature values(signature_id) as signature_id values(user_id) as user_id values(vendor_product) as vendor_product by Image BRC4_LoadedDllPath BRC4_AnomalyLoadedDll dest Signed 
| where ImageLoadedCount == 4 AND (BRC4_LoadedDllPath == 1 OR BRC4_AnomalyLoadedDll == 1) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_access_software_brc4_loaded_dll_filter`"
Windows Remote Access Software RMS Registry,"The following analytic detects the creation or modification of Windows registry entries related to the Remote Manipulator System (RMS) Remote Admin tool. It leverages data from the Endpoint.Registry datamodel, focusing on registry paths containing &quot;SYSTEM\Remote Manipulator System.&quot; This activity is significant because RMS, while legitimate, is often abused by adversaries, such as in the Azorult malware campaigns, to gain unauthorized remote access.",Windows Events,"Command And Control, Exfiltration",T1219,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SYSTEM\\Remote Manipulator System*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_access_software_rms_registry_filter`"
Windows Remote Assistance Spawning Process,"The following analytic detects Microsoft Remote Assistance (msra.exe) spawning PowerShell.exe or cmd.exe as a child process. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where msra.exe is the parent process. This activity is significant because msra.exe typically does not spawn command-line interfaces, indicating potential process injection or misuse.",Windows Events,"Execution, Persistence, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=msra.exe `windows_shells` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_assistance_spawning_process_filter`"
Windows Remote Create Service,"The following analytic identifies the creation of a new service on a remote endpoint using sc.exe. It leverages data from Endpoint Detection and Response (EDR) agents, specifically monitoring for EventCode 7045, which indicates a new service creation. This activity is significant as it may indicate lateral movement or remote code execution attempts by an attacker.",Windows Events,"Lateral Movement, Execution, Persistence","T1543.003, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=sc.exe Processes.process IN (""*create*"")  Processes.process=""*\\\\*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_create_service_filter`"
Windows Remote Host Computer Management Access,"The following analytic detects the use of mmc.exe to launch Computer Management (compmgmt.msc) and connect to a remote machine. This technique allows administrators to access system management tools, including Event Viewer, Services, Shared Folders, and Local Users &amp; Groups, without initiating a full remote desktop session. While commonly used for legitimate administrative purposes, adversaries may leverage this method for remote reconnaissance, privilege escalation, or persistence.",Windows Events,"Lateral Movement, Execution, Persistence, Privilege Escalation",T1021.006,"| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""mmc.exe"" AND Processes.process = ""*compmgmt.msc *"" AND Processes.process = ""*/computer:*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_host_computer_management_access_filter`"
Windows Remote Services Allow Remote Assistance,"The following analytic detects modifications in the Windows registry to enable remote desktop assistance on a targeted machine. It leverages data from the Endpoint.Registry datamodel, specifically monitoring changes to the &quot;Control\Terminal Server\fAllowToGetHelp&quot; registry path. This activity is significant because enabling remote assistance via registry is uncommon and often associated with adversaries or malware like Azorult.",Windows Events,"Lateral Movement, Discovery, Exfiltration",T1021.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\Control\\Terminal Server\\fAllowToGetHelp*"" Registry.registry_value_data=""0x00000001"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_remote_services_allow_remote_assistance_filter`"
Windows Root Domain linked policies Discovery,The following analytic detects the use of the [Adsisearcher] type accelerator in PowerShell to query Active Directory for root domain linked policies. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity. This behavior is significant as it may indicate an attempt by adversaries or Red Teams to gain situational awareness and perform Active Directory Discovery.,Windows Events,"Lateral Movement, Discovery",T1087.002,[Adsisearcher]
Windows Rundll32 WebDAV Request,"The following analytic identifies the execution of rundll32.exe with command-line arguments loading davclnt.dll and the davsetcookie function to access a remote WebDAV instance. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an attempt to exploit CVE-2023-23397, a known vulnerability.",Windows Events,"Execution, Discovery, Exfiltration",T1048.003,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=rundll32.exe Processes.process IN (""*\\windows\\system32\\davclnt.dll,*davsetcookie*"",""*\\windows\\syswow64\\davclnt.dll,*davsetcookie*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_rundll32_webdav_request_filter`"
Windows Scheduled Task DLL Module Loaded,"The following analytic detects instances where the taskschd.dll is loaded by processes running in suspicious or writable directories. This activity is unusual, as legitimate processes that load taskschd.dll typically reside in protected system locations. Malware or threat actors may attempt to load this DLL from writable or non-standard directories to manipulate the Task Scheduler and execute malicious tasks.",Windows Events,Execution,T1053,"`sysmon` EventCode=7 Image IN (""*\\windows\\fonts\\*"", ""*\\windows\\temp\\*"", ""*\\users\\public\\*"", ""*\\windows\\debug\\*"", ""*\\Users\\Administrator\\Music\\*"", ""*\\Windows\\servicing\\*"", ""*\\Users\\Default\\*"", ""*Recycle.bin*"", ""*\\Windows\\Media\\*"", ""\\Windows\\repair\\*"", ""*\\temp\\*"", ""*\\PerfLogs\\*"") ImageLoaded = ""*\\taskschd.dll"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_scheduled_task_dll_module_loaded_filter`"
Windows Server Software Component GACUtil Install to GAC,"The following analytic detects the use of GACUtil.exe to add a DLL into the Global Assembly Cache (GAC). It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because adding a DLL to the GAC allows it to be called by any application, potentially enabling widespread code execution.",Windows Events,"Execution, Persistence, Privilege Escalation",T1505.004,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=gacutil.exe Processes.process IN (""*-i *"",""*/i *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_server_software_component_gacutil_install_to_gac_filter`"
Windows Service Create RemComSvc,"The following analytic detects the creation of the RemComSvc service on a Windows endpoint, typically indicating lateral movement using RemCom.exe. It leverages Windows EventCode 7045 from the System event log, specifically looking for the &quot;RemCom Service&quot; name. This activity is significant as it often signifies unauthorized lateral movement within the network, which is a common tactic used by attackers to spread malware or gain further access.",Windows Events,"Lateral Movement, Persistence, Discovery, Exfiltration",T1543.003,"`wineventlog_system` EventCode=7045 ServiceName=""RemCom Service"" 
| stats count min(_time) as firstTime max(_time) as lastTime by dest ImagePath ServiceName ServiceType   
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_create_remcomsvc_filter`"
Windows Service Creation on Remote Endpoint,"The following analytic identifies the creation of a Windows Service on a remote endpoint using sc.exe. It detects this activity by analyzing process execution logs from Endpoint Detection and Response (EDR) agents, focusing on command-line arguments that include remote paths and service creation commands. This behavior is significant because adversaries often exploit the Service Control Manager for lateral movement and remote code execution.",Windows Events,"Lateral Movement, Execution, Persistence","T1543.003, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe) (Processes.process=*\\\\* AND Processes.process=*create* AND Processes.process=*binpath*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_service_creation_on_remote_endpoint_filter`"
Windows Service Creation Using Registry Entry,"The following analytic detects the modification of registry keys that define Windows services using reg.exe. This detection leverages Splunk to search for specific keywords in the registry path, value name, and value data fields. This activity is significant because it indicates potential unauthorized changes to service configurations, a common persistence technique used by attackers.",Windows Events,"Lateral Movement, Persistence, Defense Evasion",T1574.011,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path=""*\\SYSTEM\\CurrentControlSet\\Services*"" Registry.registry_value_name = ImagePath) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| where isnotnull(registry_value_data) 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_creation_using_registry_entry_filter`"
Windows Service Deletion In Registry,"The following analytic detects the deletion of a service from the Windows Registry under CurrentControlSet\Services. It leverages data from the Endpoint.Registry datamodel, specifically monitoring registry paths and actions related to service deletion. This activity is significant as adversaries may delete services to evade detection and hinder incident response efforts. If confirmed malicious, this action could disrupt legitimate services, impair system functionality, and potentially allow attackers to maintain a lower profile within the environment, complicating detection and remediation efforts.",Windows Events,"Execution, Impact",T1489,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path= ""*\\SYSTEM\\CurrentControlSet\\Services*"" AND (Registry.action = deleted OR (Registry.registry_value_name = DeleteFlag AND Registry.registry_value_data = 0x00000001 AND Registry.action=modified)) by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_deletion_in_registry_filter`"
Windows Service Execution RemCom,"The following analytic identifies the execution of RemCom.exe, an open-source alternative to PsExec, used for lateral movement and remote command execution. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, original file names, and command-line arguments. This activity is significant as it indicates potential lateral movement within the network.",Windows Events,"Lateral Movement, Execution, Discovery",T1569.002,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=remcom.exe OR Processes.original_file_name=RemCom.exe) Processes.process=""*\\*"" Processes.process IN (""*/user:*"", ""*/pwd:*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_execution_remcom_filter`"
Windows Service Initiation on Remote Endpoint,"The following analytic detects the execution of sc.exe with command-line arguments used to start a Windows Service on a remote endpoint. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant because adversaries may exploit the Service Control Manager for lateral movement and remote code execution.",Windows Events,"Lateral Movement, Execution, Persistence","T1543.003, T1543","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=sc.exe OR Processes.original_file_name=sc.exe) (Processes.process=*\\\\* AND Processes.process=*start*) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `windows_service_initiation_on_remote_endpoint_filter`"
Windows Service Stop By Deletion,"The following analytic detects the use of sc.exe to delete a Windows service. It leverages Endpoint Detection and Response (EDR) data, focusing on process execution logs that capture command-line arguments. This activity is significant because adversaries often delete services to disable security mechanisms or critical system functions, aiding in evasion and persistence. If confirmed malicious, this action could lead to the termination of essential security services, allowing attackers to operate undetected and potentially escalate their privileges or maintain long-term access to the compromised system.",Windows Events,"Execution, Impact, Persistence","T1489, T1543.003","| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = sc.exe OR Processes.original_file_name = sc.exe) Processes.process=""* delete *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_stop_by_deletion_filter`"
Windows Service Stop Win Updates,"The following analytic detects the disabling of Windows Update services, such as &quot;Update Orchestrator Service for Windows Update,&quot; &quot;WaaSMedicSvc,&quot; and &quot;Windows Update.&quot; It leverages Windows System Event ID 7040 logs to identify changes in service start modes to 'disabled.' This activity is significant as it can indicate an adversary's attempt to evade defenses by preventing critical updates, leaving the system vulnerable to exploits.",Windows Events,"Persistence, Impact",T1489,"`wineventlog_system` EventCode=7040 (service_name IN (""Update Orchestrator Service for Windows Update"", ""WaaSMedicSvc"", ""Windows Update"") OR param1 IN (""UsoSvc"", ""WaaSMedicSvc"", ""wuauserv"")) AND (param3=disabled OR start_mode = disabled) 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer Error_Code service_name start_mode param1 param2 param3 param4 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_service_stop_win_updates_filter`"
Windows Set Account Password Policy To Unlimited Via Net,"The following analytic detects the use of net.exe to update user account policies to set passwords as non-expiring. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions involving &quot;/maxpwage:unlimited&quot; or &quot;/maxpwage:49710&quot;, which achieve a similar outcome theoretically. This activity is significant as it can indicate an attempt to maintain persistence, escalate privileges, evade defenses, or facilitate lateral movement.",Windows Events,"Lateral Movement, Execution, Impact, Persistence",T1489,"| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process=""* accounts *"" AND (Processes.process=""* /maxpwage:unlimited"" OR Processes.process=""/maxpwage:49710"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_set_account_password_policy_to_unlimited_via_net_filter`"
Windows SIP Provider Inventory,"The following analytic identifies all SIP (Subject Interface Package) providers on a Windows system using PowerShell scripted inputs. It detects SIP providers by capturing DLL paths from relevant events. This activity is significant because malicious SIP providers can be used to bypass trust controls, potentially allowing unauthorized code execution. If confirmed malicious, this activity could enable attackers to subvert system integrity, leading to unauthorized access or persistent threats within the environment.",Windows Events,"Execution, Defense Evasion",T1553.003,"`subjectinterfacepackage` Dll=*\\*.dll 
| stats count min(_time) as firstTime max(_time) as lastTime values(Dll) by Path host
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_sip_provider_inventory_filter`"
Windows SIP WinVerifyTrust Failed Trust Validation,"The following analytic detects failed trust validation attempts using Windows Event Log - CAPI2 (CryptoAPI 2). It specifically triggers on EventID 81, which indicates that &quot;The digital signature of the object did not verify.&quot; This detection leverages the CAPI2 Operational log to identify instances where digital signatures fail to validate. Monitoring this activity is crucial as it can indicate attempts to execute untrusted or potentially malicious binaries.",Windows Events,Defense Evasion,"T1553, T1553.003","`capi2_operational` EventID=81 ""The digital signature of the object did not verify."" 
| xmlkv UserData_Xml 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, UserData_Xml 
| rename Computer as dest 
| `windows_sip_winverifytrust_failed_trust_validation_filter`"
Windows Snake Malware File Modification Crmlog,"The following analytic identifies the creation of a .crmlog file within the %windows%\Registration directory, typically with a format of &lt;RANDOM_GUID&gt;.&lt;RANDOM_GUID&gt;.crmlog. This detection leverages the Endpoint.Filesystem datamodel to monitor file creation events in the specified directory. This activity is significant as it is associated with the Snake malware, which uses this file for its operations.",Windows Events,"Exfiltration, Defense Evasion",T1027,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_path=""*\\windows\\registration\\*"" AND  Filesystem.file_name=""*.crmlog"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_snake_malware_file_modification_crmlog_filter`"
Windows Snake Malware Kernel Driver Comadmin,"The following analytic detects the creation of the comadmin.dat file in the %windows%\system32\Com directory, which is associated with Snake Malware. This detection leverages the Endpoint.Filesystem data model to identify file creation events matching the specified path and filename. This activity is significant because the comadmin.dat file is part of Snake Malware's installation process, which includes dropping a kernel driver and a custom DLL.",Windows Events,"Persistence, Privilege Escalation",T1547.006,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where Filesystem.file_path=""*\\windows\\system32\\com\\*"" AND Filesystem.file_name=""comadmin.dat"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_snake_malware_kernel_driver_comadmin_filter`"
Windows Snake Malware Registry Modification wav OpenWithProgIds,"The following analytic identifies modifications to the registry path .wav\OpenWithProgIds, associated with the Snake Malware campaign. It leverages data from the Endpoint.Registry datamodel to detect changes in this specific registry location. This activity is significant because Snake's WerFault.exe uses this registry path to decrypt an encrypted blob containing critical components like the AES key, IV, and paths for its kernel driver and loader.",Windows Events,Defense Evasion,T1112,"| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=""*\\.wav\\OpenWithProgIds\\*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `security_content_ctime(lastTime)` 
| `security_content_ctime(firstTime)` 
| `drop_dm_object_name(Registry)` 
| `windows_snake_malware_registry_modification_wav_openwithprogids_filter`"
Windows Snake Malware Service Create,"The following analytic detects the creation of a new service named WerFaultSvc with a binary path in the Windows WinSxS directory. It leverages Windows System logs, specifically EventCode 7045, to identify this activity. This behavior is significant because it indicates the presence of Snake malware, which uses this service to maintain persistence by blending in with legitimate Windows services.",Windows Events,"Execution, Exfiltration, Persistence, Privilege Escalation","T1547.006, T1569.002","`wineventlog_system` EventCode=7045  ImagePath=""*\\windows\\winSxS\\*"" ImagePath=""*\Werfault.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by Computer EventCode ImagePath ServiceName ServiceType 
| rename Computer as dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_snake_malware_service_create_filter`"
Windows SnappyBee Create Test Registry,"The following analytic detects modifications to the Windows registry under SOFTWARE\Microsoft\Test, a location rarely used by legitimate applications in a production environment. Monitoring this key is crucial, as adversaries may create or alter values here for monitoring update of itself file path, updated configuration file, or system mark compromised. The detection leverages Sysmon Event ID 13 (Registry Value Set) to identify unauthorized changes.",Windows Events,"Execution, Defense Evasion",T1112,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry WHERE Registry.registry_path = ""*\\SOFTWARE\\Microsoft\\Test\\*"" by Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path Registry.registry_key_name Registry.registry_value_data Registry.registry_value_name Registry.registry_value_type Registry.status Registry.user Registry.vendor_product 
| `drop_dm_object_name(Registry)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_snappybee_create_test_registry_filter`"
Windows SOAPHound Binary Execution,"The following analytic detects the execution of the SOAPHound binary (soaphound.exe) with specific command-line arguments. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, command-line arguments, and other process-related metadata. This activity is significant because SOAPHound is a known tool used for credential dumping and other malicious activities. If confirmed malicious, this behavior could allow an attacker to extract sensitive information, escalate privileges, or persist within the environment, posing a severe threat to organizational security.",Windows Events,"Execution, Discovery","T1069.001, T1087.001, T1069.002, T1482, T1087.002","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""soaphound.exe"" OR Processes.original_file_name=""soaphound.exe"" AND Processes.process IN (""*--buildcache *"", ""*--bhdump *"", ""*--certdump *"", ""*--dnsdump *"", ""*-c *"", ""*--cachefilename *"", ""*-o *"", ""*--outputdirectory *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_soaphound_binary_execution_filter`"
Windows Special Privileged Logon On Multiple Hosts,"The following analytic detects a user authenticating with special privileges on 30 or more remote endpoints within a 5-minute window. It leverages Event ID 4672 from Windows Security logs to identify this behavior. This activity is significant as it may indicate lateral movement or remote code execution by an adversary. If confirmed malicious, the attacker could gain extensive control over the network, potentially leading to privilege escalation, data exfiltration, or further compromise of the environment.",Windows Events,"Execution, Lateral Movement, Privilege Escalation, Discovery, Exfiltration","T1021.002, T1087, T1135","`wineventlog_security` EventCode=4672 AND NOT(Caller_User_Name IN (""DWM-1"",""DWM-2"",""DWM-3"",""LOCAL SERVICE"",""NETWORK SERVICE"",""SYSTEM"",""*$"")) 
| bucket span=5m _time 
| stats dc(Computer) AS unique_targets values(Computer) as dest values(PrivilegeList) as privileges by _time, Caller_User_Name 
| rename Caller_User_Name as user
| where unique_targets > 30 
| `windows_special_privileged_logon_on_multiple_hosts_filter`"
Windows SQL Server Extended Procedure DLL Loading Hunt,"This analytic detects when SQL Server loads DLLs to execute extended stored procedures. This is particularly important for security monitoring as it indicates the first-time use or version changes of potentially dangerous procedures like xp_cmdshell, sp_OACreate, and others. While this is a legitimate operation, adversaries may abuse these procedures for execution, discovery, or privilege escalation.",Windows Events,"Execution, Collection, Persistence, Privilege Escalation, Discovery","T1505.001, T1059.009","`wineventlog_application` EventCode=8128 
| rex field=EventData_Xml ""<Data>(?<dll_name>[^<]+)</Data><Data>(?<dll_version>[^<]+)</Data><Data>(?<procedure_name>[^<]+)</Data>"" 
| rename host as dest 
| eval dll_category=case( dll_name==""xpstar.dll"", ""Extended Procedures"", dll_name==""odsole70.dll"", ""OLE Automation"", dll_name==""xplog70.dll"", ""Logging Procedures"", true(), ""Other"") 
| stats count as execution_count, values(procedure_name) as procedures_used, latest(_time) as last_seen by dest dll_name dll_category dll_version 
| sort - execution_count 
| `windows_sql_server_extended_procedure_dll_loading_hunt_filter`"
Windows SQL Spawning CertUtil,"The following analytic detects the use of certutil to download software, specifically when spawned by SQL-related processes.",Windows Events,"Command And Control, Execution",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (""sqlservr.exe"", ""sqlagent.exe"", ""sqlps.exe"", ""launchpad.exe"", ""sqldumper.exe"") `process_certutil` (Processes.process=""*urlcache*"" OR Processes.process=""*verifyctl*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sql_spawning_certutil_filter`"
Windows Sqlservr Spawning Shell,"This analytic detects instances where the sqlservr.exe process spawns a command shell (cmd.exe) or PowerShell process. This behavior is often indicative of command execution initiated from within the SQL Server process, potentially due to exploitation of SQL injection vulnerabilities or the use of extended stored procedures like xp_cmdshell.
Search 1 2| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.",Windows Events,"Execution, Persistence","T1505, T1505.001","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=""sqlservr.exe"" `process_cmd` OR `process_powershell` by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_sqlservr_spawning_shell_filter`"
Windows SqlWriter SQLDumper DLL Sideload,"The following analytic detects the abuse of SqlWriter and SQLDumper executables to sideload the vcruntime140.dll library. It leverages Sysmon EventCode 7 logs, focusing on instances where SQLDumper.exe or SQLWriter.exe load vcruntime140.dll, excluding legitimate loads from the System32 directory. This activity is significant as it indicates potential DLL sideloading, a technique used by adversaries to execute malicious code within trusted processes.",Windows Events,"Persistence, Defense Evasion",T1574.001,"`sysmon` EventCode=7 (Image=""*\\SQLDumper.exe"" OR Image=""*\\SQLWriter.exe"") ImageLoaded=""*\\vcruntime140.dll"" NOT ImageLoaded=""C:\\Windows\\System32\\*"" 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_sqlwriter_sqldumper_dll_sideload_filter`"
Windows Steal Authentication Certificates - ESC1 Abuse,The following analytic detects when a new certificate is requested or granted against Active Directory Certificate Services (AD CS) using a Subject Alternative Name (SAN). It leverages Windows Security Event Codes 4886 and 4887 to identify these actions. This activity is significant because improperly configured certificate templates can be exploited for privilege escalation and environment compromise.,Windows Events,"Persistence, Credential Access, Privilege Escalation",T1649,"`wineventlog_security` EventCode IN (4886,4887) Attributes=""*SAN:*upn*"" Attributes=""*CertificateTemplate:*"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(name) as name values(status) as status values(Subject) as ssl_subject values(SubjectKeyIdentifier) as ssl_hash by Computer, EventCode, Requester, Attributes, RequestId 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)`
| fillnull 
| rex field=Attributes ""(?i)CertificateTemplate:(?<object>[^\r\n]+)"" 
| rex field=Attributes ""(?i)ccm:(?<req_src>[^\r\n]+)"" 
| rex max_match=10 field=Attributes ""(?i)(upn=(?<req_user_1>[^\r\n&]+))"" 
| rex max_match=10 field=Attributes ""(?i)(dns=(?<req_dest_1>[^\r\n&]+))"" 
| rex field=Requester ""(.+\\\\)?(?<src_user>[^\r\n]+)"" 
| eval flavor_text = case(EventCode==""4886"",""A suspicious certificate was requested using request ID: "".'RequestId',EventCode==""4887"", ""A suspicious certificate was issued using request ID: "".'RequestId'."". To revoke this certifacte use this request ID or the SSL fingerprint ["".'ssl_hash'.""]""), dest = upper(coalesce(req_dest_1,req_dest_2)), src = upper(coalesce(req_src,Computer)) 
| fields - req_* 
| rename Attributes as object_attrs, EventCode as signature_id, name as signature, RequestId as ssl_serial, Requester as ssl_subject_common_name
| `windows_steal_authentication_certificates___esc1_abuse_filter`"
Windows Steal Authentication Certificates - ESC1 Authentication,"The following analytic detects when a suspicious certificate with a Subject Alternative Name (SAN) is issued using Active Directory Certificate Services (AD CS) and then immediately used for authentication. This detection leverages Windows Security Event Logs, specifically EventCode 4887, to identify the issuance and subsequent use of the certificate. This activity is significant because improperly configured certificate templates can be exploited for privilege escalation and environment compromise.",Windows Events,"Persistence, Credential Access, Privilege Escalation, Defense Evasion","T1550, T1649","`wineventlog_security` EventCode IN (4887) Attributes=""*SAN:*upn*"" Attributes=""*CertificateTemplate:*"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(name) as name values(status) as status values(Subject) as ssl_subject values(SubjectKeyIdentifier) as ssl_hash by Computer, EventCode, Requester, Attributes, RequestId 
| rex field=Attributes ""(?i)CertificateTemplate:(?<object>[^\r\n]+)"" 
| rex field=Attributes ""(?i)ccm:(?<req_src>[^\r\n]+)"" 
| rex max_match=10 field=Attributes ""(?i)(upn=(?<req_user_1>[^\r\n&]+))"" 
| rex max_match=10 field=Attributes ""(?i)(dns=(?<req_dest_1>[^\r\n&]+))"" 
| rex field=Requester ""(.+\\\\)?(?<src_user>[^\r\n]+)"" 
| rename Attributes as object_attrs, EventCode as signature_id, name as signature, RequestId as ssl_serial, Requester as ssl_subject_common_name 
| eval user = lower(coalesce(req_user_1,req_user_2))  
| join user [ 
| search `wineventlog_security` EventCode=4768 CertThumbprint=* 
| rename TargetUserName as user, Computer as auth_dest, IpAddress as auth_src 
| fields auth_src,auth_dest,user ] 
| eval src = upper(coalesce(auth_src,req_src)), dest = upper(coalesce(auth_dest,req_dest_1,req_dest_2)), risk_score = 90 
| eval flavor_text = case(signature_id==""4887"", ""User account ["".'user'.""] authenticated after a suspicious certificate was issued for it by ["".'src_user'.""] using certificate request ID: "".'ssl_serial') 
| fields - req_* auth_* 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates___esc1_authentication_filter`"
Windows Steal Authentication Certificates Certificate Issued,"The following analytic identifies the issuance of a new certificate by Certificate Services - AD CS, detected via Event ID 4887. This event logs the requester user context, DNS hostname of the requesting machine, and the request time. Monitoring this activity is crucial as it can indicate potential misuse of authentication certificates. If confirmed malicious, an attacker could use the issued certificate to impersonate users, escalate privileges, or maintain persistence within the environment.",Windows Events,"Persistence, Credential Access",T1649,"`wineventlog_security`  EventCode=4887 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, name, Requester, action, Attributes, Subject 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_steal_authentication_certificates_certificate_issued_filter`"
Windows Steal Authentication Certificates Certificate Request,"The following analytic detects when a new certificate is requested from Certificate Services - AD CS. It leverages Event ID 4886, which indicates that a certificate request has been received. This activity is significant because unauthorized certificate requests can be part of credential theft or lateral movement tactics. If confirmed malicious, an attacker could use the certificate to impersonate users, gain unauthorized access to resources, or establish persistent access within the environment.",Windows Events,"Lateral Movement, Credential Access",T1649,"`wineventlog_security` EventCode=4886 
| stats count min(_time) as firstTime max(_time) as lastTime by dest, name, Requester, action, Attributes 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_certificate_request_filter`"
Windows Steal Authentication Certificates CertUtil Backup,"The following analytic detects CertUtil.exe performing a backup of the Certificate Store. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line executions involving CertUtil with backup parameters. This activity is significant because it may indicate an attempt to steal authentication certificates, which are critical for secure communications. If confirmed malicious, an attacker could use the stolen certificates to impersonate users, decrypt sensitive data, or gain unauthorized access to systems, leading to severe security breaches.",Windows Events,"Execution, Credential Access",T1649,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_certutil` Processes.process IN (""*-backupdb *"", ""*-backup *"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_certutil_backup_filter`"
Windows Steal Authentication Certificates CS Backup,"The following analytic identifies the backup of the Active Directory Certificate Services (AD CS) store, detected via Event ID 4876. This event is logged when a backup is performed using the CertSrv.msc UI or the CertUtil.exe -BackupDB command. Monitoring this activity is crucial as unauthorized backups can indicate an attempt to steal authentication certificates, which are critical for secure communications.",Windows Events,Credential Access,T1649,"`wineventlog_security` EventCode=4876
| stats count min(_time) as firstTime max(_time) as lastTime by dest, name, action, Caller_Domain ,Caller_User_Name 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_cs_backup_filter`"
Windows Steal Authentication Certificates Export Certificate,"The following analytic detects the use of the PowerShell cmdlet 'export-certificate' executed via the command line, indicating an attempt to export a certificate from the local Windows Certificate Store. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. Exporting certificates is significant as it may indicate credential theft or preparation for man-in-the-middle attacks.",Windows Events,"Execution, Credential Access",T1649,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*export-certificate*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_export_certificate_filter`"
Windows Steal Authentication Certificates Export PfxCertificate,"The following analytic detects the use of the PowerShell cmdlet export-pfxcertificate on the command line, indicating an attempt to export a certificate from the local Windows Certificate Store. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs and command-line arguments. This activity is significant as it may indicate an attempt to exfiltrate authentication certificates, which can be used to impersonate users or decrypt sensitive data.",Windows Events,"Execution, Credential Access",T1649,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=""*export-pfxcertificate*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_steal_authentication_certificates_export_pfxcertificate_filter`"
Windows Suspect Process With Authentication Traffic,"The following analytic detects executables running from public or temporary locations that are communicating over Windows domain authentication ports/protocols such as LDAP (389), LDAPS (636), and Kerberos (88). It leverages network traffic data to identify processes originating from user-controlled directories. This activity is significant because legitimate applications rarely run from these locations and attempt domain authentication, making it a potential indicator of compromise.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Lateral Movement, Execution, Discovery","T1087.002, T1204.002, T1069","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(All_Traffic.process_id) as process_id  from datamodel=Network_Traffic.All_Traffic where All_Traffic.dest_port IN (""88"",""389"",""636"")  AND All_Traffic.app IN (""*\\users\\*"", ""*\\programdata\\*"", ""*\\temp\\*"", ""*\\Windows\\Tasks\\*"", ""*\\appdata\\*"", ""*\\perflogs\\*"") by All_Traffic.action All_Traffic.app All_Traffic.dest All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.direction All_Traffic.dvc All_Traffic.protocol All_Traffic.protocol_version All_Traffic.src All_Traffic.src_ip All_Traffic.src_port All_Traffic.transport All_Traffic.user All_Traffic.vendor_product 
| `drop_dm_object_name(All_Traffic)`  
| rex field=app "".*\\\(?<process_name>.*)$"" 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| `windows_suspect_process_with_authentication_traffic_filter`"
Windows System Discovery Using ldap Nslookup,"The following analytic detects the execution of nslookup.exe to query domain information using LDAP. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. This activity is significant as nslookup.exe can be abused by malware like Qakbot to gather critical domain details, such as SRV records and server names.",Windows Events,"Lateral Movement, Execution, Discovery, Exfiltration",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = ""nslookup.exe"" OR Processes.original_file_name = ""nslookup.exe"") AND Processes.process = ""*_ldap._tcp.dc._msdcs*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_system_discovery_using_ldap_nslookup_filter`"
Windows System Discovery Using Qwinsta,"The following analytic detects the execution of &quot;qwinsta.exe&quot; on a Windows operating system. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. The &quot;qwinsta.exe&quot; tool is significant because it can display detailed session information on a remote desktop session host server. This behavior is noteworthy as it is commonly abused by Qakbot malware to gather system information and send it back to its Command and Control (C2) server.",Windows Events,"Command And Control, Execution, Discovery, Exfiltration",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = ""qwinsta.exe"" OR Processes.original_file_name = ""qwinsta.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(""Processes"")` 
| `security_content_ctime(firstTime)` 
|`security_content_ctime(lastTime)` 
| `windows_system_discovery_using_qwinsta_filter`"
Windows System File on Disk,"The following analytic detects the creation of new .sys files on disk. It leverages the Endpoint.Filesystem data model to identify and log instances where .sys files are written to the filesystem. This activity is significant because .sys files are often used as kernel mode drivers, and their unauthorized creation can indicate malicious activity such as rootkit installation.",Windows Events,"Discovery, Privilege Escalation",T1068,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name=""*.sys*"" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product 
| `drop_dm_object_name(Filesystem)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `windows_system_file_on_disk_filter`"
Windows System Network Connections Discovery Netsh,"The following analytic detects the execution of the Windows built-in tool netsh.exe to display the state, configuration, and profile of the host firewall. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and process metadata. Monitoring this activity is crucial as netsh.exe can be used by adversaries to bypass firewall rules or discover firewall settings.",Windows Events,"Execution, Impact, Discovery, Exfiltration",T1049,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_netsh`AND Processes.process = ""* show *"" Processes.process IN (""*state*"", ""*config*"", ""*wlan*"", ""*profile*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_network_connections_discovery_netsh_filter`"
Windows System Remote Discovery With Query,"The following analytic detects the execution of query.exe with command-line arguments aimed at discovering data on remote devices. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as adversaries may use query.exe to gain situational awareness and perform Active Directory discovery on compromised endpoints.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes 
where (Processes.process_name=""query.exe"" OR Processes.original_file_name=""query.exe"") AND (Processes.process=""*/server*"") AND NOT Processes.process IN (""*/server:localhost*"", ""*/server:127.0.0.1*"") 
by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec 
Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name 
Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash 
Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path 
Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_remote_discovery_with_query_filter`"
Windows System Script Proxy Execution Syncappvpublishingserver,"The following analytic detects the execution of Syncappvpublishingserver.vbs via wscript.exe or cscript.exe, which may indicate an attempt to download remote files or perform privilege escalation. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. Monitoring this activity is crucial as it can signify malicious use of a native Windows script for unauthorized actions.",Windows Events,"Discovery, Execution, Privilege Escalation, Defense Evasion","T1218, T1216","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name IN (""wscript.exe"",""cscript.exe"") Processes.process=""*syncappvpublishingserver.vbs*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_script_proxy_execution_syncappvpublishingserver_filter`"
Windows System User Discovery Via Quser,"The following analytic detects the execution of the Windows OS tool quser.exe, commonly used to gather information about user sessions on a Remote Desktop Session Host server. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process execution logs. Monitoring this activity is crucial as quser.exe is often abused by post-exploitation tools like winpeas, used in ransomware attacks to enumerate user sessions.",Windows Events,"Discovery, Execution, Impact, Persistence",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""quser.exe"" OR Processes.original_file_name = ""quser.exe"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_user_discovery_via_quser_filter`"
Windows System User Privilege Discovery,"The following analytic detects the execution of whoami.exe with the /priv parameter, which displays the privileges assigned to the current user account. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it may indicate an adversary attempting to enumerate user privileges, a common step in the reconnaissance phase of an attack.",Windows Events,"Discovery, Execution, Privilege Escalation",T1033,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=""whoami.exe"" Processes.process= ""*/priv*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_system_user_privilege_discovery_filter`"
Windows UAC Bypass Suspicious Escalation Behavior,"The following analytic detects when a process spawns an executable known for User Account Control (UAC) bypass exploitation and subsequently monitors for any child processes with a higher integrity level than the original process. This detection leverages Sysmon EventID 1 data, focusing on process integrity levels and known UAC bypass executables. This activity is significant as it may indicate an attacker has successfully used a UAC bypass exploit to escalate privileges.",Windows Events,"Discovery, Defense Evasion","T1548, T1548.002","| tstats `security_content_summariesonly` count max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""low"",""medium"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| eval original_integrity_level = CASE(match(process_integrity_level,""low""),1,match(process_integrity_level,""medium""),2,match(process_integrity_level,""high""),3,match(process_integrity_level,""system""),4,true(),0) 
| rename process_guid as join_guid_1, process* as parent_process* 
| join max=0 dest join_guid_1 [
| tstats `security_content_summariesonly` count min(_time) as firstTime from datamodel=Endpoint.Processes where Processes.process_integrity_level IN (""high"",""system"") AND Processes.process_name IN (`uacbypass_process_name`) by Processes.dest, Processes.parent_process_guid, Processes.process_name, Processes.process_guid 
| `drop_dm_object_name(Processes)` 
| rename parent_process_guid as join_guid_1, process_guid as join_guid_2, process_name as uac_process_name ] 
| join max=0 dest join_guid_2 [
| tstats `security_content_summariesonly` count min(_time) as firstTime from datamodel=Endpoint.Processes where Processes.parent_process_name IN (`uacbypass_process_name`) AND Processes.process_integrity_level IN (""high"",""system"") by Processes.dest, Processes.parent_process_guid, Processes.process_name, Processes.process, Processes.process_guid, Processes.process_path, Processes.process_integrity_level, Processes.process_current_directory 
| `drop_dm_object_name(Processes)` 
| rename parent_process_guid as join_guid_2 
| eval elevated_integrity_level = CASE(match(process_integrity_level,""low""),1,match(process_integrity_level,""medium""),2,match(process_integrity_level,""high""),3,match(process_integrity_level,""system""),4,true(),0)] 
| where elevated_integrity_level > original_integrity_level 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_uac_bypass_suspicious_escalation_behavior_filter`"
Windows Unsigned DLL Side-Loading,"The following analytic detects the creation of potentially malicious unsigned DLLs in the c:\windows\system32 or c:\windows\syswow64 folders. It leverages Sysmon EventCode 7 logs to identify unsigned DLLs with unavailable signatures loaded in these critical directories. This activity is significant as it may indicate a DLL hijacking attempt, a technique used by attackers to gain unauthorized access and execute malicious code.",Windows Events,"Execution, Privilege Escalation, Defense Evasion",T1574.001,"`sysmon` EventCode=7 Signed=false OriginalFileName = ""-"" SignatureStatus=""unavailable"" ImageLoaded IN (""*:\\windows\\system32\\*"", ""*:\\windows\\syswow64\\*"") 
| fillnull 
| stats count min(_time) as firstTime max(_time) as lastTime by Image ImageLoaded dest loaded_file loaded_file_path original_file_name process_exec process_guid process_hash process_id process_name process_path service_dll_signature_exists service_dll_signature_verified signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unsigned_dll_side_loading_filter`"
Windows Unusual Count Of Disabled Users Failed Auth Using Kerberos,"The following analytic identifies a source endpoint failing to authenticate with multiple disabled domain users using the Kerberos protocol. It leverages EventCode 4768, which is generated when the Key Distribution Center issues a Kerberos Ticket Granting Ticket (TGT) and detects failure code 0x12 (credentials revoked). This behavior is significant as it may indicate a Password Spraying attack targeting disabled accounts, potentially leading to initial access or privilege escalation.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4768 TargetUserName!=*$ Status=0x12 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by IpAddress 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_disabled_users_failed_auth_using_kerberos_filter`"
Windows Unusual Count Of Invalid Users Fail To Auth Using Kerberos,"The following analytic identifies a source endpoint failing to authenticate with multiple invalid domain users using the Kerberos protocol. It leverages Event ID 4768, which is generated when the Key Distribution Center issues a Kerberos Ticket Granting Ticket (TGT) and detects failure code 0x6, indicating the user is not found in the Kerberos database.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4768 TargetUserName!=*$ Status=0x6 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by IpAddress 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_invalid_users_fail_to_auth_using_kerberos_filter`"
Windows Unusual Count Of Invalid Users Failed To Auth Using NTLM,"The following analytic identifies a source endpoint failing to authenticate with multiple invalid users using the NTLM protocol. It leverages EventCode 4776 and calculates the standard deviation for each host, using the 3-sigma rule to detect anomalies. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4776 TargetUserName!=*$ Status=0xc0000064 
| bucket span=2m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, Workstation 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by Workstation 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| rename Workstation as src 
|`windows_unusual_count_of_invalid_users_failed_to_auth_using_ntlm_filter`"
Windows Unusual Count Of Users Fail To Auth Wth ExplicitCredentials,"The following analytic identifies a source user failing to authenticate with multiple users using explicit credentials on a host. It leverages Windows Event Code 4648 and calculates the standard deviation for each host, using the 3-sigma rule to detect anomalies. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security` EventCode=4648 Caller_User_Name!=*$ Target_User_Name!=*$ 
| bucket span=5m _time 
| stats dc(Target_User_Name) AS unique_accounts values(Target_User_Name) as user values(dest) as dest values(src_ip) as src_ip by _time, Computer, Caller_User_Name 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by Computer 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_users_fail_to_auth_wth_explicitcredentials_filter`"
Windows Unusual Count Of Users Failed To Auth Using Kerberos,"The following analytic identifies a source endpoint failing to authenticate multiple valid users using the Kerberos protocol, potentially indicating a Password Spraying attack. It leverages Event 4771, which is generated when the Key Distribution Center fails to issue a Kerberos Ticket Granting Ticket (TGT) due to a wrong password (failure code 0x18). This detection uses statistical analysis, specifically the 3-sigma rule, to identify unusual authentication failures.",Windows Events,"Initial Access, Credential Access","T1110.003, T1110","`wineventlog_security` EventCode=4771 TargetUserName!=""*$"" Status=0x18 
| bucket span=5m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, IpAddress 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by IpAddress 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_users_failed_to_auth_using_kerberos_filter`"
Windows Unusual Count Of Users Failed To Authenticate From Process,"The following analytic identifies a source process failing to authenticate multiple users, potentially indicating a Password Spraying attack. It leverages Windows Event 4625, which logs failed logon attempts, and uses statistical analysis to detect anomalies. This activity is significant as it may represent an adversary attempting to gain initial access or elevate privileges within an Active Directory environment.",Windows Events,"Initial Access, Credential Access, Exfiltration, Lateral Movement","T1110.003, T1110","`wineventlog_security`  EventCode=4625 Logon_Type=2 ProcessName!=""-"" 
| bucket span=2m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest values(src) as src by _time, ProcessName, SubjectUserName, Computer, action, app, authentication_method, signature, signature_id 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by ProcessName, SubjectUserName, Computer 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_users_failed_to_authenticate_from_process_filter`"
Windows Unusual Count Of Users Failed To Authenticate Using NTLM,"The following analytic identifies a source endpoint failing to authenticate multiple valid users using the NTLM protocol, potentially indicating a Password Spraying attack. It leverages Event 4776 from Domain Controllers, calculating the standard deviation for each host and applying the 3-sigma rule to detect anomalies. This activity is significant as it may represent an adversary attempting to gain initial access or elevate privileges.",Windows Events,"Initial Access, Credential Access, Lateral Movement","T1110.003, T1110","`wineventlog_security`  EventCode=4776 TargetUserName!=*$ Status=0xC000006A 
| bucket span=2m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest by _time, Workstation 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by Workstation 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_users_failed_to_authenticate_using_ntlm_filter`"
Windows Unusual Count Of Users Remotely Failed To Auth From Host,"The following analytic identifies a source host failing to authenticate against a remote host with multiple users, potentially indicating a Password Spraying attack. It leverages Windows Event 4625 (failed logon attempts) and Logon Type 3 (remote authentication) to detect this behavior. This activity is significant as it may represent an adversary attempting to gain initial access or elevate privileges within an Active Directory environment.",Windows Events,"Initial Access, Credential Access, Privilege Escalation","T1110.003, T1110","`wineventlog_security`  EventCode=4625 Logon_Type=3 IpAddress!=""-"" 
| bucket span=2m _time 
| stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as tried_accounts values(dest) as dest values(src) as src values(user) as user by _time, IpAddress, Computer, action, app, authentication_method, signature, signature_id 
| eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by IpAddress, Computer 
| eval upperBound=(comp_avg+comp_std*3) 
| eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) 
| search isOutlier=1 
| `windows_unusual_count_of_users_remotely_failed_to_auth_from_host_filter`"
Windows Unusual SysWOW64 Process Run System32 Executable,"The following analytic detects an unusual process execution pattern where a process running from C:\Windows\SysWOW64\ attempts to execute a binary from C:\Windows\System32. In a typical Windows environment, 32-bit processes under SysWOW64 should primarily interact with 32-bit binaries within the same directory. However, an execution flow where a 32-bit process spawns a 64-bit binary from System32 can indicate potential process injection, privilege escalation, evasion techniques, or unauthorized execution hijacking.",Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1036.009,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_path = ""*\\Windows\\SysWOW64\\*"" AND Processes.process = ""*windows\\system32\\*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_unusual_syswow64_process_run_system32_executable_filter`"
Windows User Deletion Via Net,"The following analytic detects the use of net.exe or net1.exe command-line to delete a user account on a system. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and command-line execution logs. This activity is significant as it may indicate an attempt to impair user accounts or cover tracks during lateral movement.",Windows Events,"Lateral Movement, Execution, Impact, Discovery",T1531,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` AND Processes.process=""*user*"" AND  Processes.process=""*/delete*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_user_deletion_via_net_filter`"
Windows User Discovery Via Net,"The following analytic detects the execution of net.exe or net1.exe with command-line arguments user or users to query local user accounts. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line executions. This activity is significant as it indicates potential reconnaissance efforts by adversaries to enumerate local users, which is a common step in situational awareness and Active Directory discovery.",Windows Events,"Discovery, Execution, Privilege Escalation, Lateral Movement","T1087.001, T1087","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_net` (Processes.process=""*user"" OR Processes.process=""*users"" OR Processes.process=""*users *"" OR Processes.process=""*user *"") AND NOT (Processes.process=""*/add"" OR Processes.process=""*/delete"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_user_discovery_via_net_filter`"
Windows Vulnerable 3CX Software,"The following analytic detects instances of the 3CXDesktopApp.exe with a FileVersion of 18.12.x, leveraging Sysmon logs. This detection focuses on identifying vulnerable versions 18.12.407 and 18.12.416 of the 3CX desktop app. Monitoring this activity is crucial as these specific versions have known vulnerabilities that could be exploited by attackers. If confirmed malicious, exploitation of this vulnerability could lead to unauthorized access, code execution, or further compromise of the affected system, posing significant security risks.",Windows Events,"Initial Access, Execution, Discovery",T1195.002,"`sysmon` (process_name=3CXDesktopApp.exe OR OriginalFileName=3CXDesktopApp.exe)  FileVersion=18.12.* 
| stats count min(_time) as firstTime max(_time) as lastTime by action dest original_file_name parent_process parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process process_exec process_guid process_hash process_id process_integrity_level process_name process_path user user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_vulnerable_3cx_software_filter`"
Windows Vulnerable Driver Installed,"The following analytic detects the loading of known vulnerable Windows drivers, which may indicate potential persistence or privilege escalation attempts. It leverages Windows System service install EventCode 7045 to identify driver loading events and cross-references them with a list of vulnerable drivers. This activity is significant as attackers often exploit vulnerable drivers to gain elevated privileges or maintain persistence on a system.",Windows Events,"Persistence, Privilege Escalation, Exfiltration",T1543.003,"`wineventlog_system` EventCode=7045 ServiceType=""kernel mode driver"" 
| table _time dest EventCode ImagePath ServiceName ServiceType 
| lookup loldrivers driver_name AS ImagePath OUTPUT is_driver driver_description 
| search is_driver = TRUE  
| `windows_vulnerable_driver_installed_filter`"
Windows WinDBG Spawning AutoIt3,"The following analytic identifies instances of the WinDBG process spawning AutoIt3. This behavior is detected by monitoring endpoint telemetry for processes where 'windbg.exe' is the parent process and 'autoit3.exe' or similar is the child process. This activity is significant because AutoIt3 is frequently used by threat actors for scripting malicious automation, potentially indicating an ongoing attack.",Windows Events,"Execution, Exfiltration",T1059,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes  where Processes.parent_process_name=windbg.exe  AND (Processes.process_name IN (""autoit3.exe"", ""autoit*.exe"") OR Processes.original_file_name IN (""autoit3.exe"", ""autoit*.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval matches_extension=if(match(process, ""\\.(au3
|a3x
|exe
|aut
|aup)$""), ""Yes"", ""No"") 
| search matches_extension=""Yes"" 
| `windows_windbg_spawning_autoit3_filter`"
Windows WMI Impersonate Token,The following analytic detects potential WMI token impersonation activities in a process or command. It leverages Sysmon EventCode 10 to identify instances where wmiprvse.exe has a duplicate handle or full granted access in a target process. This behavior is significant as it is commonly used by malware like Qakbot for privilege escalation or defense evasion.,Windows Events,"Defense Evasion, Execution, Persistence, Privilege Escalation",T1047,"`sysmon` EventCode=10 SourceImage = ""*\\wmiprvse.exe""  GrantedAccess IN (""0x1478"", ""0x1fffff"") 
| stats count min(_time) as firstTime max(_time) as lastTime by CallTrace EventID GrantedAccess Guid Opcode ProcessID SecurityID SourceImage SourceProcessGUID SourceProcessId TargetImage TargetProcessGUID TargetProcessId UserID dest granted_access parent_process_exec parent_process_guid parent_process_id parent_process_name parent_process_path process_exec process_guid process_id process_name process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmi_impersonate_token_filter`"
Windows WMI Process Call Create,"The following analytic detects the execution of WMI command lines used to create or execute processes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line events that include specific keywords like &quot;process,&quot; &quot;call,&quot; and &quot;create.&quot; This activity is significant because adversaries often use WMI to execute malicious payloads on local or remote hosts, potentially bypassing traditional security controls.",Windows Events,"Execution, Persistence",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where `process_wmic` Processes.process = ""* process *"" Processes.process = ""* call *"" Processes.process = ""* create *"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmi_process_call_create_filter`"
Windows WMIC Shadowcopy Delete,"This analytic detects the use of WMIC to delete volume shadow copies, which is a common technique used by ransomware actors to prevent system recovery. Ransomware like Cactus often delete shadow copies before encrypting files to ensure victims cannot recover their data without paying the ransom. This behavior is particularly concerning as it indicates potential ransomware activity or malicious actors attempting to prevent system recovery.",Windows Events,Impact,T1490,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wmic.exe Processes.process = ""*shadowcopy*"" Processes.process = ""*delete*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process
Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id
Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec
Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level
Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_wmic_shadowcopy_delete_filter`"
Winhlp32 Spawning a Process,"The following analytic detects winhlp32.exe spawning a child process that loads a file from appdata, programdata, or temp directories. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events. This activity is significant because winhlp32.exe has known vulnerabilities and can be exploited to execute malicious code. If confirmed malicious, an attacker could use this technique to execute arbitrary scripts, escalate privileges, or maintain persistence within the environment.",Windows Events,"Execution, Persistence, Defense Evasion",T1055,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=winhlp32.exe Processes.process IN (""*\\appdata\\*"",""*\\programdata\\*"", ""*\\temp\\*"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `winhlp32_spawning_a_process_filter`"
WinRAR Spawning Shell Application,"The following analytic detects the execution of Windows shell processes initiated by WinRAR, such as &quot;cmd.exe&quot;, &quot;powershell.exe&quot;, &quot;certutil.exe&quot;, &quot;mshta.exe&quot;, or &quot;bitsadmin.exe&quot;. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on process and parent process relationships. This activity is significant because it may indicate exploitation of the WinRAR CVE-2023-38831 vulnerability, where malicious scripts are executed from spoofed ZIP archives.",Windows Events,"Command And Control, Execution",T1105,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=winrar.exe `windows_shells` OR Processes.process_name IN (""certutil.exe"",""mshta.exe"",""bitsadmin.exe"") by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `winrar_spawning_shell_application_filter`"
WMI Permanent Event Subscription,The following analytic detects the creation of permanent event subscriptions using Windows Management Instrumentation (WMI).,Windows Events,"Execution, Impact, Persistence",T1047,"`wmi` EventCode=5861 Binding 
| rex field=Message ""Consumer =\s+(?<consumer>[^;
|^$]+)"" 
| search consumer!=""NTEventLogEventConsumer=\""SCM Event Log Consumer\"""" 
| stats count min(_time) as firstTime max(_time) as lastTime by ComputerName, consumer, Message 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| rename ComputerName as dest 
| `wmi_permanent_event_subscription_filter`"
WMI Permanent Event Subscription - Sysmon,"The following analytic identifies the creation of WMI permanent event subscriptions, which can be used to establish persistence or perform privilege escalation. It leverages Sysmon data, specifically EventCodes 19, 20, and 21, to detect the creation of WMI EventFilters, EventConsumers, and FilterToConsumerBindings. This activity is significant as it may indicate an attacker setting up mechanisms to execute code with elevated SYSTEM privileges when specific events occur.",Windows Events,"Persistence, Privilege Escalation",T1546.003,"`sysmon` EventCode=21 
| stats count min(_time) as firstTime max(_time) as lastTime by dest dvc object object_attrs object_category object_path signature signature_id src status user user_id vendor_product Consumer ConsumerNoQuotes Filter FilterNoQuotes 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `wmi_permanent_event_subscription___sysmon_filter`"
WMI Temporary Event Subscription,The following analytic detects the creation of WMI temporary event subscriptions.,Windows Events,"Execution, Persistence",T1047,"`wmi` EventCode=5860 Temporary 
| rex field=Message ""NotificationQuery =\s+(?<query>[^;
|^$]+)"" 
| search query!=""SELECT * FROM Win32_ProcessStartTrace WHERE ProcessName = 'wsmprovhost.exe'"" AND query!=""SELECT * FROM __InstanceOperationEvent WHERE TargetInstance ISA 'AntiVirusProduct' OR TargetInstance ISA 'FirewallProduct' OR TargetInstance ISA 'AntiSpywareProduct'"" 
| stats count min(_time) as firstTime max(_time) as lastTime by ComputerName, query  
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `wmi_temporary_event_subscription_filter`"
Wmic NonInteractive App Uninstallation,"The following analytic identifies the use of the WMIC command-line tool attempting to uninstall applications non-interactively. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on specific command-line patterns associated with WMIC. This activity is significant because it is uncommon and may indicate an attempt to evade detection by uninstalling security software, as seen in IcedID malware campaigns.",Windows Events,"Execution, Persistence, Defense Evasion",T1562.001,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wmic.exe Processes.process=""* product *"" Processes.process=""*where name*"" Processes.process=""*call uninstall*"" Processes.process=""*/nointeractive*"" by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wmic_noninteractive_app_uninstallation_filter`"
Wmiprvse LOLBAS Execution Process Spawn,"The following analytic detects wmiprvse.exe spawning a LOLBAS execution process. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process creation events where wmiprvse.exe is the parent process and the child process is a known LOLBAS binary. This activity is significant as it may indicate lateral movement or remote code execution by an adversary abusing Windows Management Instrumentation (WMI).",Windows Events,"Lateral Movement, Execution, Persistence",T1047,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process_name=wmiprvse.exe) (Processes.process_name IN (""Regsvcs.exe"", ""Ftp.exe"", ""OfflineScannerShell.exe"", ""Rasautou.exe"", ""Schtasks.exe"", ""Xwizard.exe"", ""Dllhost.exe"", ""Pnputil.exe"", ""Atbroker.exe"", ""Pcwrun.exe"", ""Ttdinject.exe"",""Mshta.exe"", ""Bitsadmin.exe"", ""Certoc.exe"", ""Ieexec.exe"", ""Microsoft.Workflow.Compiler.exe"", ""Runscripthelper.exe"", ""Forfiles.exe"", ""Msbuild.exe"", ""Register-cimprovider.exe"", ""Tttracer.exe"", ""Ie4uinit.exe"", ""Bash.exe"", ""Hh.exe"", ""SettingSyncHost.exe"", ""Cmstp.exe"", ""Mmc.exe"", ""Stordiag.exe"", ""Scriptrunner.exe"", ""Odbcconf.exe"", ""Extexport.exe"", ""Msdt.exe"", ""WorkFolders.exe"", ""Diskshadow.exe"", ""Mavinject.exe"", ""Regasm.exe"", ""Gpscript.exe"", ""Rundll32.exe"", ""Regsvr32.exe"", ""Msiexec.exe"", ""Wuauclt.exe"", ""Presentationhost.exe"", ""Wmic.exe"", ""Runonce.exe"", ""Syncappvpublishingserver.exe"", ""Verclsid.exe"", ""Infdefaultinstall.exe"", ""Explorer.exe"", ""Installutil.exe"", ""Netsh.exe"", ""Wab.exe"", ""Dnscmd.exe"", ""At.exe"", ""Pcalua.exe"", ""Msconfig.exe"")) by Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name Processes.process_path Processes.user Processes.user_id Processes.vendor_product 
| `drop_dm_object_name(Processes)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `wmiprvse_lolbas_execution_process_spawn_filter`"
XMRIG Driver Loaded,"The following analytic detects the installation of the XMRIG coinminer driver on a system. It identifies the loading of the WinRing0x64.sys driver, commonly associated with XMRIG, by analyzing Sysmon EventCode 6 logs for specific signatures and image loads. This activity is significant because XMRIG is an open-source CPU miner frequently exploited by adversaries to mine cryptocurrency illicitly.",Windows Events,"Execution, Persistence",T1543.003,"`sysmon` EventCode=6 Signature=""Noriyuki MIYAZAKI"" OR ImageLoaded= ""*\\WinRing0x64.sys"" 
|  stats  min(_time) as firstTime max(_time) as lastTime count by ImageLoaded dest dvc process_hash process_path signature signature_id user_id vendor_product 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `xmrig_driver_loaded_filter`"
Detect DGA domains using pretrained model in DSDL,The following analytic identifies Domain Generation Algorithm (DGA) generated domains using a pre-trained deep learning model.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration","T1568, T1568.002","| tstats `security_content_summariesonly` values(DNS.answer) as IPs min(_time) as firstTime  max(_time) as lastTime from datamodel=Network_Resolution by DNS.src, DNS.query 
| `drop_dm_object_name(DNS)` 
| rename query AS domain 
| fields IPs, src, domain, firstTime, lastTime 
| apply pretrained_dga_model_dsdl 
| rename pred_dga_proba AS dga_score 
| where dga_score>0.5 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)` 
| table src, domain, IPs, firstTime, lastTime, dga_score 
| `detect_dga_domains_using_pretrained_model_in_dsdl_filter`"
Detect DNS Query to Decommissioned S3 Bucket,This detection identifies DNS queries to domains that match previously decommissioned S3 buckets.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall",Impact,T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution where DNS.message_type=QUERY by DNS.answer DNS.answer_count DNS.query DNS.query_count DNS.reply_code_id DNS.src DNS.vendor_product 
| `drop_dm_object_name(""DNS"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval bucket_domain = lower(query) 
| lookup decommissioned_buckets bucketName as bucket_domain OUTPUT bucketName as match 
| where isnotnull(match) 
| `detect_dns_query_to_decommissioned_s3_bucket_filter`"
Detect Large ICMP Traffic,"The following analytic identifies ICMP traffic to external IP addresses with total bytes (sum of bytes in and bytes out) greater than 1,000 bytes. It leverages the Network_Traffic data model to detect large ICMP packet that aren't blocked and are directed toward external networks. We use All_Traffic.bytes in the detection to capture variations in inbound versus outbound traffic sizes, as significant discrepancies or unusually large ICMP exchanges can indicate information smuggling, covert communication, or command-and-control (C2) activities.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Command And Control,T1095,"| tstats `security_content_summariesonly` count earliest(_time) as firstTime latest(_time) as lastTime values(All_Traffic.action) as action
from datamodel=Network_Traffic where All_Traffic.bytes > 1000 AND All_Traffic.action != blocked AND (All_Traffic.protocol=icmp OR All_Traffic.transport=icmp) AND NOT All_Traffic.dest_ip IN (""10.0.0.0/8"",""172.16.0.0/12"",""192.168.0.0/16"")
by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.protocol, All_Traffic.bytes, All_Traffic.app, All_Traffic.bytes_in, All_Traffic.bytes_out, All_Traffic.dest_port, All_Traffic.dvc, All_Traffic.protocol_version, 
All_Traffic.src_port, All_Traffic.user, All_Traffic.vendor_product
| `drop_dm_object_name(""All_Traffic"")` 
| iplocation dest_ip 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_large_icmp_traffic_filter`"
Detect Software Download To Network Device,"The following analytic identifies unauthorized software downloads to network devices via TFTP, FTP, or SSH/SCP.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Exfiltration, Defense Evasion",T1542.005,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where (All_Traffic.transport=udp AND All_Traffic.dest_port=69) OR (All_Traffic.transport=tcp AND All_Traffic.dest_port=21) OR (All_Traffic.transport=tcp AND All_Traffic.dest_port=22) AND All_Traffic.dest_category!=common_software_repo_destination AND All_Traffic.src_category=network OR All_Traffic.src_category=router OR All_Traffic.src_category=switch by All_Traffic.src All_Traffic.dest All_Traffic.dest_port 
| `drop_dm_object_name(""All_Traffic"")` 
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)` 
| `detect_software_download_to_network_device_filter`"
Detect Unauthorized Assets by MAC address,The following analytic identifies unauthorized devices attempting to connect to the organization's network by inspecting DHCP request packets.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall",Exfiltration,,"| tstats `security_content_summariesonly` count from datamodel=Network_Sessions where nodename=All_Sessions.DHCP All_Sessions.tag=dhcp by All_Sessions.dest_ip All_Sessions.dest_mac 
| dedup All_Sessions.dest_mac
| `drop_dm_object_name(""Network_Sessions"")`
|`drop_dm_object_name(""All_Sessions"")` 
| search NOT [
| inputlookup asset_lookup_by_str 
|rename mac as dest_mac 
| fields + dest_mac] 
| `detect_unauthorized_assets_by_mac_address_filter`"
Excessive DNS Failures,"The following analytic identifies excessive DNS query failures by counting DNS responses that do not indicate success, triggering when there are more than 50 occurrences.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Exfiltration",T1071.004,"| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where nodename=DNS ""DNS.reply_code""!=""No Error"" ""DNS.reply_code""!=""NoError"" DNS.reply_code!=""unknown"" NOT ""DNS.query""=""*.arpa"" ""DNS.query""=""*.*"" by ""DNS.src"" ""DNS.query"" ""DNS.reply_code"" 
| `drop_dm_object_name(""DNS"")` 
| lookup cim_corporate_web_domain_lookup domain as query OUTPUT domain 
| where isnull(domain) 
| lookup update=true alexa_lookup_by_str domain as query OUTPUT rank 
| where isnull(rank) 
| eventstats max(count) as mc by src reply_code 
| eval mode_query=if(count=mc, query, null()) 
| stats sum(count) as count values(mode_query) as query values(mc) as max_query_count by src reply_code 
| where count>50 
| `get_asset(src)` 
| `excessive_dns_failures_filter`"
F5 BIG-IP iControl REST Vulnerability CVE-2022-1388,"The following analytic detects attempts to exploit the F5 BIG-IP iControl REST API vulnerability (CVE-2022-1388) for unauthenticated remote code execution. It identifies suspicious URI paths and POST HTTP methods, along with specific request headers containing potential commands in the utilcmdargs field and a random base64 encoded value in the X-F5-Auth-Token field. This activity is significant as it targets a critical vulnerability that can allow attackers to execute arbitrary commands on the affected system.",F5 BIG-IP,"Initial Access, Execution","T1190, T1133","| tstats count from datamodel=Web where Web.url=""*/mgmt/tm/util/bash*"" Web.http_method=""POST"" by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `f5_big_ip_icontrol_rest_vulnerability_cve_2022_1388_filter`"
Hosts receiving high volume of network traffic from email server,The following analytic identifies hosts receiving an unusually high volume of network traffic from an email server.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Collection, Impact, Exfiltration",T1114.002,"| tstats `security_content_summariesonly` sum(All_Traffic.bytes_in) as bytes_in from datamodel=Network_Traffic where All_Traffic.dest_category=email_server by All_Traffic.src_ip _time span=1d 
| `drop_dm_object_name(""All_Traffic"")` 
| eventstats avg(bytes_in) as avg_bytes_in stdev(bytes_in) as stdev_bytes_in 
| eventstats count as num_data_samples avg(eval(if(_time < relative_time(now(), ""@d""), bytes_in, null))) as per_source_avg_bytes_in stdev(eval(if(_time < relative_time(now(), ""@d""), bytes_in, null))) as per_source_stdev_bytes_in by src_ip 
| eval minimum_data_samples = 4, deviation_threshold = 3 
| where num_data_samples >= minimum_data_samples AND bytes_in > (avg_bytes_in + (deviation_threshold * stdev_bytes_in)) AND bytes_in > (per_source_avg_bytes_in + (deviation_threshold * per_source_stdev_bytes_in)) AND _time >= relative_time(now(), ""@d"") 
| eval num_standard_deviations_away_from_server_average = round(abs(bytes_in - avg_bytes_in) / stdev_bytes_in, 2), num_standard_deviations_away_from_client_average = round(abs(bytes_in - per_source_avg_bytes_in) / per_source_stdev_bytes_in, 2) 
| table src_ip, _time, bytes_in, avg_bytes_in, per_source_avg_bytes_in, num_standard_deviations_away_from_server_average, num_standard_deviations_away_from_client_average 
| `hosts_receiving_high_volume_of_network_traffic_from_email_server_filter`"
Large Volume of DNS ANY Queries,"The following analytic identifies a large volume of DNS ANY queries, which may indicate a DNS amplification attack.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Impact,T1498.002,"| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where nodename=DNS ""DNS.message_type""=""QUERY"" ""DNS.record_type""=""ANY"" by ""DNS.dest"" 
| `drop_dm_object_name(""DNS"")` 
| where count>200 
| `large_volume_of_dns_any_queries_filter`"
Ngrok Reverse Proxy on Network,"The following analytic detects DNS queries to common Ngrok domains, indicating potential use of the Ngrok reverse proxy tool. It leverages the Network Resolution datamodel to identify queries to domains such as &quot;.ngrok.com&quot; and &quot;.ngrok.io&quot;. While Ngrok usage is not inherently malicious, it has been increasingly adopted by adversaries for covert communication and data exfiltration.","Palo Alto Firewall, Cisco ASA, Check Point Firewall","Command And Control, Discovery, Exfiltration","T1102, T1572, T1090","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime  from datamodel=Network_Resolution where DNS.query IN (""*.ngrok.com"",""*.ngrok.io"", ""ngrok.*.tunnel.com"", ""korgn.*.lennut.com"") by DNS.answer DNS.answer_count DNS.query DNS.query_count DNS.reply_code_id DNS.src DNS.vendor_product 
|  `drop_dm_object_name(""DNS"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ngrok_reverse_proxy_on_network_filter`"
SMB Traffic Spike,"The following analytic detects spikes in Server Message Block (SMB) traffic connections, which are used for sharing files and resources between computers.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Lateral Movement,T1021.002,"| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src 
| `drop_dm_object_name(""All_Traffic"")` 
| eventstats max(_time) as maxtime 
| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-70m@m""), count, null))) as count avg(eval(if(_time<relative_time(maxtime, ""-70m@m""), count, null))) as avg stdev(eval(if(_time<relative_time(maxtime, ""-70m@m""), count, null))) as stdev by src 
| eval upperBound=(avg+stdev*2), isOutlier=if(count > upperBound AND num_data_samples >=50, 1, 0) 
| where isOutlier=1 
| table src count 
| `smb_traffic_spike_filter`"
SSL Certificates with Punycode,"The following analytic detects SSL certificates with Punycode domains in the SSL issuer email domain, identified by the prefix &quot;xn--&quot;.","Palo Alto Firewall, Cisco ASA, Check Point Firewall",Command And Control,T1573,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Certificates.All_Certificates by All_Certificates.SSL.ssl_issuer_email_domain All_Certificates.SSL.ssl_issuer All_Certificates.SSL.ssl_subject_email All_Certificates.SSL.dest All_Certificates.SSL.src All_Certificates.SSL.sourcetype All_Certificates.SSL.ssl_subject_email_domain 
| `drop_dm_object_name(""All_Certificates.SSL"")` 
| eval punycode=if(like(ssl_issuer_email_domain,""%xn--%""),1,0) 
| where punycode=1 
| cyberchef infield=""ssl_issuer_email_domain"" outfield=""convertedPuny"" jsonrecipe=""[{""op"":""From Punycode"",""args"":[true]}]"" 
| table ssl_issuer_email_domain convertedPuny ssl_issuer ssl_subject_email dest src sourcetype ssl_subject_email_domain 
| `ssl_certificates_with_punycode_filter`"
Suspicious Process With Discord DNS Query,"The following analytic identifies a process making a DNS query to Discord, excluding legitimate Discord application paths. It leverages Sysmon logs with Event ID 22 to detect DNS queries containing &quot;discord&quot; in the QueryName field. This activity is significant because Discord can be abused by adversaries to host and download malicious files, as seen in the WhisperGate campaign.",Windows Events,Execution,T1059.005,"`sysmon` EventCode=22 QueryName IN (""*discord*"") Image != ""*\\AppData\\Local\\Discord\\*"" AND Image != ""*\\Program Files*"" AND Image != ""discord.exe"" 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_process_with_discord_dns_query_filter`"
Windows AD Replication Service Traffic,The following analytic identifies unexpected Active Directory replication traffic from non-domain controller sources.,"Palo Alto Firewall, Cisco ASA, Check Point Firewall","Persistence, Credential Access, Defense Evasion","T1207, T1003.006, T1003","| tstats `security_content_summariesonly` count values(All_Traffic.transport) as transport values(All_Traffic.user) as user values(All_Traffic.src_category) as src_category values(All_Traffic.dest_category) as dest_category min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app IN (""ms-dc-replication"",""*drsr*"",""ad drs"") by All_Traffic.src All_Traffic.dest All_Traffic.app 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name(""All_Traffic"")` 
| `windows_ad_replication_service_traffic_filter`"
Windows Spearphishing Attachment Connect To None MS Office Domain,The following analytic identifies suspicious Office documents that connect to non-Microsoft Office domains. It leverages Sysmon EventCode 22 to detect processes like winword.exe or excel.exe making DNS queries to domains outside of *.office.com or *.office.net. This activity is significant as it may indicate a spearphishing attempt using malicious documents to download or connect to harmful content.,Windows Events,"Initial Access, Execution",T1566.001,"`sysmon` EventCode=22 Image IN (""*\\winword.exe"",""*\\excel.exe"",""*\\powerpnt.exe"",""*\\mspub.exe"",""*\\visio.exe"",""*\\wordpad.exe"",""*\\wordview.exe"",""*\\onenote.exe"", ""*\\onenotem.exe"",""*\\onenoteviewer.exe"",""*\\onenoteim.exe"", ""*\\msaccess.exe"") AND NOT(QueryName IN (""*.office.com"", ""*.office.net"")) 
| stats count min(_time) as firstTime max(_time) as lastTime by answer answer_count dvc process_exec process_guid process_name query query_count reply_code_id signature signature_id src user_id vendor_product QueryName QueryResults QueryStatus 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_spearphishing_attachment_connect_to_none_ms_office_domain_filter`"
Zeek x509 Certificate with Punycode,The following analytic detects the presence of punycode within x509 certificates using Zeek x509 logs.,Zeek,Command And Control,T1573,"`zeek_x509` 
| rex field=san.email{} ""\@(?<domain_detected>xn--.*)"" 
| rex field=san.other_fields{} ""\@(?<domain_detected>xn--.*)"" 
| stats values(domain_detected) by  basic_constraints.ca source host 
| `zeek_x509_certificate_with_punycode_filter`"
Access to Vulnerable Ivanti Connect Secure Bookmark Endpoint,"The following analytic identifies access to the /api/v1/configuration/users/user-roles/user-role/rest-userrole1/web/web-bookmarks/bookmark endpoint, which is associated with CVE-2023-46805 and CVE-2024-21887 vulnerabilities. It detects this activity by monitoring for GET requests that receive a 403 Forbidden response with an empty body. This behavior is significant as it indicates potential exploitation attempts against Ivanti Connect Secure systems. If confirmed malicious, attackers could exploit these vulnerabilities to gain unauthorized access or control over the affected systems, leading to potential data breaches or system compromise.",Zscaler Proxy,"Initial Access, Discovery, Lateral Movement",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/api/v1/configuration/users/user-roles/user-role/rest-userrole1/web/web-bookmarks/bookmark*"" Web.http_method=GET Web.status=403 by Web.src, Web.dest, Web.http_user_agent, Web.status, Web.url source 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `access_to_vulnerable_ivanti_connect_secure_bookmark_endpoint_filter`"
Adobe ColdFusion Access Control Bypass,"The following analytic detects potential exploitation attempts against Adobe ColdFusion vulnerabilities CVE-2023-29298 and CVE-2023-26360. It monitors requests to specific ColdFusion Administrator endpoints, especially those with an unexpected additional forward slash, using the Web datamodel. This activity is significant for a SOC as it indicates attempts to bypass access controls, which can lead to unauthorized access to ColdFusion administration endpoints.",Zscaler Proxy,"Initial Access, Execution",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""//restplay*"", ""//CFIDE/restplay*"", ""//CFIDE/administrator*"", ""//CFIDE/adminapi*"", ""//CFIDE/main*"", ""//CFIDE/componentutils*"", ""//CFIDE/wizards*"", ""//CFIDE/servermanager*"",""/restplay*"", ""/CFIDE/restplay*"", ""/CFIDE/administrator*"", ""/CFIDE/adminapi*"", ""/CFIDE/main*"", ""/CFIDE/componentutils*"", ""/CFIDE/wizards*"", ""/CFIDE/servermanager*"") Web.status=200 by Web.http_user_agent, Web.status, Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `adobe_coldfusion_access_control_bypass_filter`"
Adobe ColdFusion Unauthenticated Arbitrary File Read,"The following analytic detects potential exploitation of the Adobe ColdFusion vulnerability, CVE-2023-26360, which allows unauthenticated arbitrary file read. It monitors web requests to the &quot;/cf_scripts/scripts/ajax/ckeditor/*&quot; path using the Web datamodel, focusing on specific ColdFusion paths to differentiate malicious activity from normal traffic. This activity is significant due to the vulnerability's high CVSS score of 9.",Zscaler Proxy,"Initial Access, Execution, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/cf_scripts/scripts/ajax/ckeditor/*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `adobe_coldfusion_unauthenticated_arbitrary_file_read_filter`"
Cisco IOS XE Implant Access,"The following analytic identifies the potential exploitation of a vulnerability (CVE-2023-20198) in the Web User Interface of Cisco IOS XE software. It detects suspicious account creation and subsequent actions, including the deployment of a non-persistent implant configuration file. The detection leverages the Web datamodel, focusing on specific URL patterns and HTTP methods. This activity is significant as it indicates unauthorized administrative access, which can lead to full control of the device.",Cisco IOS,Initial Access,T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/webui/logoutconfirm.html?logon_hash=*"") Web.http_method=POST Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `cisco_ios_xe_implant_access_filter`"
Citrix ADC Exploitation CVE-2023-3519,"The following analytic identifies potential exploitation attempts against Citrix ADC related to CVE-2023-3519. It detects POST requests to specific web endpoints associated with this vulnerability by leveraging the Web datamodel. This activity is significant as CVE-2023-3519 involves a SAML processing overflow issue that can lead to memory corruption, posing a high risk. If confirmed malicious, attackers could exploit this to execute arbitrary code, escalate privileges, or disrupt services, making it crucial for SOC analysts to monitor and investigate these alerts promptly.",Zscaler Proxy,Initial Access,T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/saml/login"",""/cgi/samlauth"",""*/saml/activelogin"",""/cgi/samlart?samlart=*"",""*/cgi/logout"",""/gwtest/formssso?event=start&target=*"",""/netscaler/ns_gui/vpn/*"")  Web.http_method=POST by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `citrix_adc_exploitation_cve_2023_3519_filter`"
Citrix ShareFile Exploitation CVE-2023-24489,"The following analytic detects potentially malicious file upload attempts to Citrix ShareFile via specific suspicious URLs and the HTTP POST method. It leverages the Web datamodel to identify URL patterns such as &quot;/documentum/upload.aspx?parentid=&quot;, &quot;/documentum/upload.aspx?filename=&quot;, and &quot;/documentum/upload.aspx?uploadId=*&quot;, combined with the HTTP POST method. This activity is significant for a SOC as it may indicate an attempt to upload harmful scripts or content, potentially compromising the Documentum application.",Zscaler Proxy,Initial Access,T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""/documentum/upload.aspx?*"" AND Web.url IN (""*parentid=*"",""*filename=*"",""*uploadId=*"") AND Web.url IN (""*unzip=*"", ""*raw=*"") Web.http_method=POST by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `citrix_sharefile_exploitation_cve_2023_24489_filter`"
Confluence CVE-2023-22515 Trigger Vulnerability,"The following analytic identifies potential exploitation attempts of the Confluence CVE-2023-22515 vulnerability. It detects successful accesses (HTTP status 200) to specific vulnerable endpoints by analyzing web logs within the Splunk 'Web' Data Model. This activity is significant for a SOC as it indicates possible privilege escalation attempts in Confluence. If confirmed malicious, attackers could gain unauthorized access or create accounts with escalated privileges, leading to potential data breaches or further exploitation within the environment.",Zscaler Proxy,"Initial Access, Privilege Escalation",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false*"",""*/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=0&*"") Web.http_method=GET Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `confluence_cve_2023_22515_trigger_vulnerability_filter`"
Confluence Data Center and Server Privilege Escalation,"The following analytic identifies potential exploitation attempts on a known vulnerability in Atlassian Confluence, specifically targeting the /setup/.action URL pattern. It leverages web logs within the Splunk 'Web' Data Model, filtering for successful accesses (HTTP status 200) to these endpoints. This activity is significant as it suggests attackers might be exploiting a privilege escalation flaw in Confluence.",Zscaler Proxy,"Initial Access, Privilege Escalation",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/setup/setupadministrator.action*"", ""*/setup/finishsetup.action*"", ""*/json/setup-restore-local.action*"", ""*/json/setup-restore-progress.action*"", ""*/json/setup-restore.action*"", ""*/bootstrap/selectsetupstep.action*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `confluence_data_center_and_server_privilege_escalation_filter`"
Confluence Pre-Auth RCE via OGNL Injection CVE-2023-22527,"The following analytic identifies attempts to exploit a critical template injection vulnerability (CVE-2023-22527) in outdated Confluence Data Center and Server versions. It detects POST requests to the &quot;/template/aui/text-inline.vm&quot; endpoint with HTTP status codes 200 or 202, indicating potential OGNL injection attacks. This activity is significant as it allows unauthenticated attackers to execute arbitrary code remotely.",Zscaler Proxy,"Initial Access, Execution, Privilege Escalation",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/template/aui/text-inline.vm*"" Web.http_method=POST Web.status IN (200, 202) by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.status 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `confluence_pre_auth_rce_via_ognl_injection_cve_2023_22527_filter`"
Confluence Unauthenticated Remote Code Execution CVE-2022-26134,"The following analytic detects attempts to exploit CVE-2022-26134, an unauthenticated remote code execution vulnerability in Confluence. It leverages the Web datamodel to analyze network and CIM-compliant web logs, identifying suspicious URL patterns and parameters indicative of exploitation attempts. This activity is significant as it allows attackers to execute arbitrary code on the Confluence server without authentication, potentially leading to full system compromise.",Zscaler Proxy,"Initial Access, Execution, Lateral Movement, Persistence, Exfiltration","T1505, T1190, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*${*"", ""*%2F%7B*"") (Web.url=""*org.apache.commons.io.IOUtils*"" Web.url=""*java.lang.Runtime@getRuntime().exec*"") OR (Web.url=""*java.lang.Runtime%40getRuntime%28%29.exec*"") OR (Web.url=""*getEngineByName*"" AND Web.url=""*nashorn*"" AND Web.url=""*ProcessBuilder*"") by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `confluence_unauthenticated_remote_code_execution_cve_2022_26134_filter`"
ConnectWise ScreenConnect Authentication Bypass,"The following analytic detects attempts to exploit the ConnectWise ScreenConnect CVE-2024-1709 vulnerability, which allows attackers to bypass authentication via an alternate path or channel. It leverages web request logs to identify access to the SetupWizard.aspx page, indicating potential exploitation. This activity is significant as it can lead to unauthorized administrative access and remote code execution.",Zscaler Proxy,"Initial Access, Execution",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/SetupWizard.aspx/*"",""*/SetupWizard/"") Web.status=200 Web.http_method=POST by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.status, Web.http_method, sourcetype, source 
| rex field=Web.url ""/SetupWizard.aspx/(?<randomPath>.+)"" 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `connectwise_screenconnect_authentication_bypass_filter`"
CrushFTP Max Simultaneous Users From IP,"The following analytic identifies instances where CrushFTP has blocked access due to exceeding the maximum number of simultaneous connections from a single IP address. This activity may indicate brute force attempts, credential stuffing, or automated attacks against the CrushFTP server. This detection is particularly relevant following the discovery of CVE-2025-31161, an authentication bypass vulnerability in CrushFTP versions 10.",CrushFTP,"Credential Access, Discovery","T1110.004, T1110.001","`crushftp` ""*User access not allowed.  Max simultaneous users from your IP*"" 
| rex field=_raw ""SESSION\\
|\\d+\\/\\d+\\/\\d+ \\d+:\\d+:\\d+\\.\\d+\\
|\\[HTTP:[^:]+:(?<user>[^:]+):(?<src_ip>[0-9\\.]+)\\]"" 
| stats count min(_time) as firstTime max(_time) as lastTime values(user) as user by src_ip 
| where count >= 3 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `crushftp_max_simultaneous_users_from_ip_filter`"
Detect attackers scanning for vulnerable JBoss servers,The following analytic identifies specific GET or HEAD requests to web servers that indicate reconnaissance attempts to find vulnerable JBoss servers.,Zscaler Proxy,"Initial Access, Discovery","T1082, T1133","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=""GET"" OR Web.http_method=""HEAD"") AND (Web.url=""*/web-console/ServerInfo.jsp*"" OR Web.url=""*web-console*"" OR Web.url=""*jmx-console*"" OR Web.url = ""*invoker*"") by Web.http_method, Web.url, Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `detect_attackers_scanning_for_vulnerable_jboss_servers_filter`"
Detect malicious requests to exploit JBoss servers,The following analytic identifies malicious HTTP requests targeting the jmx-console in JBoss servers.,Zscaler Proxy,Execution,,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=""GET"" OR Web.http_method=""HEAD"") by Web.http_method, Web.url,Web.url_length Web.src, Web.dest 
| search Web.url=""*jmx-console/HtmlAdaptor?action=invokeOpByName&name=jboss.admin*import*"" AND Web.url_length > 200 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table src, dest_ip, http_method, url, firstTime, lastTime 
| `detect_malicious_requests_to_exploit_jboss_servers_filter`"
Detect Web Access to Decommissioned S3 Bucket,This detection identifies web requests to domains that match previously decommissioned S3 buckets through web proxy logs.,Zscaler Proxy,Impact,T1485,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Web.http_method) as http_method values(Web.http_user_agent) as http_user_agent values(Web.url) as url values(Web.user) as user from datamodel=Web where Web.url_domain!="""" by Web.src Web.url_domain 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| eval bucket_domain = lower(url_domain) 
| lookup decommissioned_buckets bucketName as bucket_domain OUTPUT bucketName as match 
| where isnotnull(match) 
| `detect_web_access_to_decommissioned_s3_bucket_filter`"
Exploit Public Facing Application via Apache Commons Text,"The following analytic detects attempts to exploit the CVE-2022-42889 vulnerability in the Apache Commons Text Library, known as Text4Shell. It leverages the Web datamodel to identify suspicious HTTP requests containing specific lookup keys (url, dns, script) that can lead to Remote Code Execution (RCE). This activity is significant as it targets a critical vulnerability that can allow attackers to execute arbitrary code on the server.",Zscaler Proxy,"Initial Access, Execution, Lateral Movement, Persistence, Exfiltration","T1190, T1505.003, T1133","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_method IN (POST, GET) by Web.src Web.status Web.uri_path Web.dest Web.http_method Web.uri_query Web.http_user_agent 
| `drop_dm_object_name(""Web"")` 
| eval utf=if(like(lower(uri_query),""%:utf-8:http%""),2,0) 
| eval lookup = if(like(lower(uri_query), ""%url%"") OR like(lower(uri_query), ""%dns%"") OR like(lower(uri_query), ""%script%""),2,0) 
| eval other_lookups = if(like(lower(uri_query), ""%env%"") OR like(lower(uri_query), ""%file%"") OR like(lower(uri_query), ""%getRuntime%"") OR like(lower(uri_query), ""%java%"") OR like(lower(uri_query), ""%localhost%"") OR like(lower(uri_query), ""%properties%"") OR like(lower(uri_query), ""%resource%"") OR like(lower(uri_query), ""%sys%"") OR like(lower(uri_query), ""%xml%"") OR like(lower(uri_query), ""%base%""),1,0) 
| addtotals fieldname=Score utf lookup other_lookups 
| fields Score, src, dest, status, uri_query, uri_path, http_method, http_user_agent firstTime lastTime 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| where Score >= 3 
| `exploit_public_facing_application_via_apache_commons_text_filter`"
F5 TMUI Authentication Bypass,"The following analytic detects attempts to exploit the CVE-2023-46747 vulnerability, an authentication bypass flaw in F5 BIG-IP's Configuration utility (TMUI). It identifies this activity by monitoring for specific URI paths such as &quot;/mgmt/tm/auth/user/&quot; with the PATCH method and a 200 status code. This behavior is significant for a SOC as it indicates potential unauthorized access attempts, leading to remote code execution.",F5 BIG-IP,"Execution, Discovery",,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/mgmt/tm/auth/user/*"") Web.http_method=PATCH Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `f5_tmui_authentication_bypass_filter`"
Fortinet Appliance Auth bypass,"The following analytic detects attempts to exploit CVE-2022-40684, a Fortinet appliance authentication bypass vulnerability. It identifies REST API requests to the /api/v2/ endpoint using various HTTP methods (GET, POST, PUT, DELETE) that may indicate unauthorized modifications, such as adding SSH keys or creating new users. This detection leverages the Web datamodel to monitor specific URL patterns and HTTP methods.",Zscaler Proxy,Initial Access,"T1190, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/api/v2/cmdb/system/admin*"")  Web.http_method IN (""GET"", ""PUT"") by Web.http_user_agent, Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `fortinet_appliance_auth_bypass_filter`"
Hunting for Log4Shell,"The following analytic detects potential exploitation attempts of the Log4Shell vulnerability (CVE-2021-44228) by analyzing HTTP headers for specific patterns. It leverages the Web Datamodel and evaluates various indicators such as the presence of {jndi:, environment variables, and common URI paths. This detection is significant as Log4Shell allows remote code execution, posing a severe threat to systems.",Zscaler Proxy,"Initial Access, Execution, Collection, Lateral Movement","T1190, T1133","| from datamodel Web.Web 
| eval jndi=if(match(_raw, ""(\{
|%7B)[jJnNdDiI]{4}:""),4,0) 
| eval jndi_fastmatch=if(match(_raw, ""[jJnNdDiI]{4}""),2,0) 
| eval jndi_proto=if(match(_raw,""(?i)jndi:(ldap[s]?
|rmi
|dns
|nis
|iiop
|corba
|nds
|http
|https):""),5,0) 
| eval all_match = if(match(_raw, ""(?i)(%(25){0,}20
|\s)*(%(25){0,}24
|\$)(%(25){0,}20
|\s)*(%(25){0,}7B
|{)(%(25){0,}20
|\s)*(%(25){0,}(6A
|4A)
|J)(%(25){0,}(6E
|4E)
|N)(%(25){0,}(64
|44)
|D)(%(25){0,}(69
|49)
|I)(%(25){0,}20
|\s)*(%(25){0,}3A
|:)[\w\%]+(%(25){1,}3A
|:)(%(25){1,}2F
|\/)[^\n]+""),5,0) 
| eval env_var = if(match(_raw, ""env:"") OR match(_raw, ""env:AWS_ACCESS_KEY_ID"") OR match(_raw, ""env:AWS_SECRET_ACCESS_KEY""),5,0) 
| eval uridetect = if(match(_raw, ""(?i)Basic\/Command\/Base64
|Basic\/ReverseShell
|Basic\/TomcatMemshell
|Basic\/JBossMemshell
|Basic\/WebsphereMemshell
|Basic\/SpringMemshell
|Basic\/Command
|Deserialization\/CommonsCollectionsK
|Deserialization\/CommonsBeanutils
|Deserialization\/Jre8u20\/TomcatMemshell
|Deserialization\/CVE_2020_2555\/WeblogicMemshell
|TomcatBypass
|GroovyBypass
|WebsphereBypass""),4,0) 
| eval keywords = if(match(_raw,""(?i)\$\{ctx\:loginId\}
|\$\{map\:type\}
|\$\{filename\}
|\$\{date\:MM-dd-yyyy\}
|\$\{docker\:containerId\}
|\$\{docker\:containerName\}
|\$\{docker\:imageName\}
|\$\{env\:USER\}
|\$\{event\:Marker\}
|\$\{mdc\:UserId\}
|\$\{java\:runtime\}
|\$\{java\:vm\}
|\$\{java\:os\}
|\$\{jndi\:logging/context-name\}
|\$\{hostName\}
|\$\{docker\:containerId\}
|\$\{k8s\:accountName\}
|\$\{k8s\:clusterName\}
|\$\{k8s\:containerId\}
|\$\{k8s\:containerName\}
|\$\{k8s\:host\}
|\$\{k8s\:labels.app\}
|\$\{k8s\:labels.podTemplateHash\}
|\$\{k8s\:masterUrl\}
|\$\{k8s\:namespaceId\}
|\$\{k8s\:namespaceName\}
|\$\{k8s\:podId\}
|\$\{k8s\:podIp\}
|\$\{k8s\:podName\}
|\$\{k8s\:imageId\}
|\$\{k8s\:imageName\}
|\$\{log4j\:configLocation\}
|\$\{log4j\:configParentLocation\}
|\$\{spring\:spring.application.name\}
|\$\{main\:myString\}
|\$\{main\:0\}
|\$\{main\:1\}
|\$\{main\:2\}
|\$\{main\:3\}
|\$\{main\:4\}
|\$\{main\:bar\}
|\$\{name\}
|\$\{marker\}
|\$\{marker\:name\}
|\$\{spring\:profiles.active[0]
|\$\{sys\:logPath\}
|\$\{web\:rootDir\}
|\$\{sys\:user.name\}""),4,0) 
| eval obf = if(match(_raw, ""(\$
|%24)[^ /]*({
|%7b)[^ /]*(j
|%6a)[^ /]*(n
|%6e)[^ /]*(d
|%64)[^ /]*(i
|%69)[^ /]*(:
|%3a)[^ /]*(:
|%3a)[^ /]*(/
|%2f)""),5,0) 
| eval lookups = if(match(_raw, ""(?i)({
|%7b)(main
|sys
|k8s
|spring
|lower
|upper
|env
|date
|sd)""),4,0)  
| addtotals fieldname=Score, jndi, jndi_proto, env_var, uridetect, all_match, jndi_fastmatch, keywords, obf, lookups 
| where Score > 2 
| stats values(Score) by  jndi, jndi_proto, env_var, uridetect, all_match, jndi_fastmatch, keywords, lookups, obf, dest, src, http_method, _raw 
| `hunting_for_log4shell_filter`"
Ivanti Connect Secure Command Injection Attempts,"The following analytic identifies attempts to exploit the CVE-2023-46805 and CVE-2024-21887 vulnerabilities in Ivanti Connect Secure. It detects POST requests to specific URIs that leverage command injection to execute arbitrary commands. The detection uses the Web datamodel to monitor for these requests and checks for a 200 OK response, indicating a successful exploit attempt.",Ivanti,"Initial Access, Execution, Discovery, Lateral Movement",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN(""*/api/v1/totp/user-backup-code/../../system/maintenance/archiving/cloud-server-test-connection*"",""*/api/v1/totp/user-backup-code/../../license/keys-status/*"") Web.http_method IN (""POST"", ""GET"") Web.status=200 by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.http_method, Web.status 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_connect_secure_command_injection_attempts_filter`"
Ivanti Connect Secure SSRF in SAML Component,"The following analytic identifies POST requests targeting endpoints vulnerable to the SSRF issue (CVE-2024-21893) in Ivanti's products. It leverages the Web data model, focusing on endpoints such as /dana-ws/saml20.ws, /dana-ws/saml.ws, /dana-ws/samlecp.ws, and /dana-na/auth/saml-logout.cgi. The detection filters for POST requests that received an HTTP 200 OK response, indicating successful execution. This activity is significant as it may indicate an attempt to exploit SSRF vulnerabilities, potentially allowing attackers to access internal services or sensitive data.",Ivanti,"Initial Access, Execution, Exfiltration",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/dana-ws/saml20.ws*"",""*/dana-ws/saml.ws*"",""*/dana-ws/samlecp.ws*"",""*/dana-na/auth/saml-logout.cgi/*"") Web.http_method=POST Web.status=200 by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.status, Web.http_method 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_connect_secure_ssrf_in_saml_component_filter`"
Ivanti Connect Secure System Information Access via Auth Bypass,"The following analytic identifies attempts to exploit the CVE-2023-46805 and CVE-2024-21887 vulnerabilities in Ivanti Connect Secure. It detects GET requests to the /api/v1/totp/user-backup-code/../../system/system-information URI, which leverage an authentication bypass to access system information. The detection uses the Web datamodel to identify requests with a 200 OK response, indicating a successful exploit attempt. This activity is significant as it reveals potential unauthorized access to sensitive system information.",Ivanti,"Initial Access, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url=""*/api/v1/totp/user-backup-code/../../system/system-information*"" Web.http_method=GET Web.status=200 by Web.src, Web.dest, Web.http_user_agent, Web.url 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_connect_secure_system_information_access_via_auth_bypass_filter`"
Ivanti EPMM Remote Unauthenticated API Access CVE-2023-35078,"The following analytic detects attempts to exploit CVE-2023-35078, a vulnerability in Ivanti Endpoint Manager Mobile (EPMM) versions up to 11.4. It identifies HTTP requests to the endpoint &quot;/mifs/aad/api/v2/authorized/users?*&quot; with a status code of 200 in web logs. This activity is significant as it indicates unauthorized remote access to restricted functionalities or resources. If confirmed malicious, this could lead to data theft, unauthorized modifications, or further system compromise, necessitating immediate action to mitigate potential severe impacts.",Ivanti,"Initial Access, Impact","T1190, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/mifs/aad/api/v2/authorized/users?*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_epmm_remote_unauthenticated_api_access_cve_2023_35078_filter`"
Ivanti EPMM Remote Unauthenticated API Access CVE-2023-35082,"The following analytic detects potential unauthorized access attempts exploiting CVE-2023-35082 within Ivanti's software products. It identifies access to the specific URI path /mifs/asfV3/api/v2/ with an HTTP 200 response code in web access logs, indicating successful unauthorized access. This activity is significant for a SOC as it highlights potential security breaches that could lead to unauthorized data access or system modifications.",Ivanti,Initial Access,"T1190, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/mifs/asfV3/api/v2/*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_epmm_remote_unauthenticated_api_access_cve_2023_35082_filter`"
Ivanti Sentry Authentication Bypass,"The following analytic identifies unauthenticated access attempts to the System Manager Portal in Ivanti Sentry, exploiting CVE-2023-38035. It detects this activity by monitoring HTTP requests to specific endpoints (&quot;/mics/services/configservice/&quot;, &quot;/mics/services/&quot;, &quot;/mics/services/MICSLogService*&quot;) with a status code of 200. This behavior is significant for a SOC as it indicates potential unauthorized access, which could lead to OS command execution as root.",Ivanti,"Initial Access, Execution",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/mics/services/configservice/*"", ""/mics/services/*"",""/mics/services/MICSLogService*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ivanti_sentry_authentication_bypass_filter`"
Java Class File download by Java User Agent,"The following analytic identifies a Java user agent performing a GET request for a .class file from a remote site. It leverages web or proxy logs within the Web Datamodel to detect this activity. This behavior is significant as it may indicate exploitation attempts, such as those related to CVE-2021-44228 (Log4Shell). If confirmed malicious, an attacker could exploit vulnerabilities in the Java application, potentially leading to remote code execution and further compromise of the affected system.",Zscaler Proxy,"Initial Access, Execution",T1190,"| tstats  `security_content_summariesonly` count from datamodel=Web where Web.http_user_agent=""*Java*"" Web.http_method=""GET"" Web.url=""*.class*"" by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `java_class_file_download_by_java_user_agent_filter`"
JetBrains TeamCity Authentication Bypass CVE-2024-27198,"The following analytic identifies attempts to exploit the JetBrains TeamCity Authentication Bypass vulnerability (CVE-2024-27198). It detects suspicious POST requests to the /app/rest/users and /app/rest/users/id:1/tokens endpoints, which are indicative of attempts to create new administrator users or generate admin access tokens without authentication. This detection leverages the Web datamodel and CIM-compliant log sources, such as Nginx or TeamCity logs.",Zscaler Proxy,"Initial Access, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where ((Web.url=""*?jsp=*"" AND Web.url=""*;.jsp*"") Web.status=200 Web.http_method=POST) OR (Web.url IN (""*jsp=/app/rest/users;.jsp"",""*?jsp=/app/rest/users;.jsp"",""*?jsp=.*/app/rest/users/id:*/tokens;*"") Web.status=200 Web.http_method=POST ) by Web.src, Web.dest, Web.http_user_agent, Web.url, Web.status, Web.http_method, sourcetype, source 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| `jetbrains_teamcity_authentication_bypass_cve_2024_27198_filter`"
JetBrains TeamCity Limited Auth Bypass Suricata CVE-2024-27199,"The following analytic identifies attempts to exploit CVE-2024-27199, a critical vulnerability in JetBrains TeamCity web server, allowing unauthenticated access to specific endpoints. It detects unusual access patterns to vulnerable paths such as /res/, /update/, and /.well-known/acme-challenge/ by monitoring HTTP traffic logs via Suricata. This activity is significant as it could indicate an attacker bypassing authentication to access or modify system settings.",Zscaler Proxy,"Initial Access, Discovery",T1190,"`suricata` http.url IN (""*../admin/diagnostic.jsp*"", ""*../app/https/settings/*"", ""*../app/pipeline*"", ""*../app/oauth/space/createBuild.html*"", ""*../res/*"", ""*../update/*"", ""*../.well-known/acme-challenge/*"", ""*../app/availableRunners*"", ""*../app/https/settings/setPort*"", ""*../app/https/settings/certificateInfo*"", ""*../app/https/settings/defaultHttpsPort*"", ""*../app/https/settings/fetchFromAcme*"", ""*../app/https/settings/removeCertificate*"", ""*../app/https/settings/uploadCertificate*"", ""*../app/https/settings/termsOfService*"", ""*../app/https/settings/triggerAcmeChallenge*"", ""*../app/https/settings/cancelAcmeChallenge*"", ""*../app/https/settings/getAcmeOrder*"", ""*../app/https/settings/setRedirectStrategy*"") http.status=200 http_method=GET 
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, http_user_agent, http.url, http.status, http_method 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `jetbrains_teamcity_limited_auth_bypass_suricata_cve_2024_27199_filter`"
JetBrains TeamCity RCE Attempt,"The following analytic detects attempts to exploit the CVE-2023-42793 vulnerability in JetBrains TeamCity On-Premises. It identifies suspicious POST requests to /app/rest/users/id:1/tokens/RPC2, leveraging the Web datamodel to monitor specific URL patterns and HTTP methods. This activity is significant as it may indicate an unauthenticated attacker attempting to gain administrative access via Remote Code Execution (RCE).",Zscaler Proxy,"Initial Access, Execution",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/app/rest/users/id:1/tokens/RPC2*"") Web.status=200 Web.http_method=POST by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `jetbrains_teamcity_rce_attempt_filter`"
Juniper Networks Remote Code Execution Exploit Detection,"The following analytic detects attempts to exploit a remote code execution vulnerability in Juniper Networks devices. It identifies requests to /webauth_operation.php?PHPRC=*, which are indicative of uploading and executing malicious PHP files. This detection leverages the Web data model, focusing on specific URL patterns and HTTP status codes. This activity is significant because it signals an attempt to gain unauthorized access and execute arbitrary code on the device.",Zscaler Proxy,"Initial Access, Execution, Command And Control, Discovery","T1190, T1105, T1059","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/webauth_operation.php?PHPRC=*"") Web.status=200 by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `juniper_networks_remote_code_execution_exploit_detection_filter`"
Log4Shell JNDI Payload Injection Attempt,"The following analytic identifies attempts to inject Log4Shell JNDI payloads via web calls. It leverages the Web datamodel and uses regex to detect patterns like ${jndi:ldap:// in raw web event data, including HTTP headers. This activity is significant because it targets vulnerabilities in Java web applications using Log4j, such as Apache Struts and Solr. If confirmed malicious, this could allow attackers to execute arbitrary code, potentially leading to full system compromise.",Zscaler Proxy,Initial Access,"T1190, T1133","| from datamodel Web.Web 
| regex _raw=""[jJnNdDiI]{4}(\:
|\%3A
|\/
|\%2F)\w+(\:\/\/
|\%3A\%2F\%2F)(\$\{.*?\}(\.)?)?"" 
| fillnull 
| stats count by action, category, dest, dest_port, http_content_type, http_method, http_referrer, http_user_agent, site, src, url, url_domain, user 
| `log4shell_jndi_payload_injection_attempt_filter`"
Log4Shell JNDI Payload Injection with Outbound Connection,"The following analytic detects Log4Shell JNDI payload injections via outbound connections. It identifies suspicious LDAP lookup functions in web logs, such as ${jndi:ldap://PAYLOAD_INJECTED}, and correlates them with network traffic to known malicious IP addresses. This detection leverages the Web and Network_Traffic data models in Splunk. Monitoring this activity is crucial as it targets vulnerabilities in Java web applications using log4j, potentially leading to remote code execution.",Zscaler Proxy,"Initial Access, Execution","T1190, T1133","| from datamodel Web.Web 
| rex field=_raw max_match=0 ""[jJnNdDiI]{4}(\:
|\%3A
|\/
|\%2F)(?<proto>\w+)(\:\/\/
|\%3A\%2F\%2F)(\$\{.*?\}(\.)?)?(?<affected_host>[a-zA-Z0-9\.\-\_\$]+)"" 
| join affected_host type=inner [
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic.All_Traffic by All_Traffic.dest 
| `drop_dm_object_name(All_Traffic)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| rename dest AS affected_host] 
| fillnull 
| stats count by action, category, dest, dest_port, http_content_type, http_method, http_referrer, http_user_agent, site, src, url, url_domain, user 
| `log4shell_jndi_payload_injection_with_outbound_connection_filter`"
Microsoft SharePoint Server Elevation of Privilege,The following analytic detects potential exploitation attempts against Microsoft SharePoint Server vulnerability CVE-2023-29357. It leverages the Web datamodel to monitor for specific API calls and HTTP methods indicative of privilege escalation attempts. This activity is significant as it may indicate an attacker is trying to gain unauthorized privileged access to the SharePoint environment.,Zscaler Proxy,"Execution, Impact, Privilege Escalation",T1068,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/_api/web/siteusers*"",""/_api/web/currentuser*"") Web.status=200 Web.http_method=GET by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `microsoft_sharepoint_server_elevation_of_privilege_filter`"
ProxyShell ProxyNotShell Behavior Detected,"The following analytic identifies potential exploitation of Windows Exchange servers via ProxyShell or ProxyNotShell vulnerabilities, followed by post-exploitation activities such as running nltest, Cobalt Strike, Mimikatz, and adding new users. It leverages data from multiple analytic stories, requiring at least five distinct sources to trigger, thus reducing noise. This activity is significant as it indicates a high likelihood of an active compromise, potentially leading to unauthorized access, privilege escalation, and persistent threats within the environment.",Splunk Risk Rule (Multiple Sources),"Initial Access, Privilege Escalation","T1190, T1133","| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime sum(All_Risk.calculated_risk_score) as risk_score, count(All_Risk.calculated_risk_score) as risk_event_count, values(All_Risk.annotations.mitre_attack.mitre_tactic_id) as annotations.mitre_attack.mitre_tactic_id, dc(All_Risk.annotations.mitre_attack.mitre_tactic_id) as mitre_tactic_id_count, values(All_Risk.analyticstories) as analyticstories values(All_Risk.annotations.mitre_attack.mitre_technique_id) as annotations.mitre_attack.mitre_technique_id, dc(All_Risk.annotations.mitre_attack.mitre_technique_id) as mitre_technique_id_count, values(All_Risk.tag) as tag, values(source) as source, dc(source) as source_count dc(All_Risk.analyticstories) as dc_analyticstories from datamodel=Risk.All_Risk where All_Risk.analyticstories IN (""ProxyNotShell"",""ProxyShell"") OR (All_Risk.analyticstories IN (""ProxyNotShell"",""ProxyShell"") AND All_Risk.analyticstories=""Cobalt Strike"") All_Risk.risk_object_type=""system"" by _time span=1h All_Risk.risk_object All_Risk.risk_object_type 
| `drop_dm_object_name(All_Risk)` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)`
| where source_count >=5 
| `proxyshell_proxynotshell_behavior_detected_filter`"
SAP NetWeaver Visual Composer Exploitation Attempt,"Detects potential exploitation attempts targeting CVE-2025-31324, a critical unauthenticated file upload vulnerability in SAP NetWeaver Visual Composer. This flaw allows remote attackers to send specially crafted POST requests to the /developmentserver/metadatauploader endpoint, enabling arbitrary file uploadsâ€”commonly webshellsâ€”resulting in full system compromise. The detection looks for HTTP HEAD or POST requests with a 200 OK status to sensitive Visual Composer endpoints, which may indicate reconnaissance or active exploitation.",Zscaler Proxy,"Initial Access, Impact",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web.Web where (Web.url IN (""/CTCWebService/CTCWebServiceBean"", ""/VisualComposer/services/DesignTimeService"", ""/ctc/CTCWebService/CTCWebServiceBean"")) AND Web.http_method IN (""HEAD"", ""POST"") AND Web.status=200 by Web.src, Web.dest, Web.http_method, Web.url, Web.http_user_agent, Web.url_length, sourcetype 
| `drop_dm_object_name(""Web"")` 
| eval action=case(http_method=""HEAD"", ""Recon/Probe"", http_method=""POST"", ""Possible Exploitation"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| table firstTime, lastTime, src, dest, http_method, action, url, user_agent, url_length, sourcetype 
| `sap_netweaver_visual_composer_exploitation_attempt_filter`"
Spring4Shell Payload URL Request,"The following analytic detects attempts to exploit the Spring4Shell vulnerability (CVE-2022-22963) by identifying specific URL patterns associated with web shell payloads. It leverages web traffic data, focusing on HTTP GET requests with URLs containing indicators like &quot;tomcatwar.jsp,&quot; &quot;poc.jsp,&quot; and &quot;shell.jsp.&quot; This activity is significant as it suggests an attacker is trying to deploy a web shell, which can lead to remote code execution.",Zscaler Proxy,"Initial Access, Execution, Persistence","T1190, T1505.003, T1133","| tstats count from datamodel=Web where Web.http_method IN (""GET"") Web.url IN (""*tomcatwar.jsp*"",""*poc.jsp*"",""*shell.jsp*"") by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `spring4shell_payload_url_request_filter`"
Tomcat Session Deserialization Attempt,"This detection identifies potential exploitation of CVE-2025-24813 in Apache Tomcat through the second stage of the attack. This phase occurs when an attacker attempts to trigger deserialization of a previously uploaded malicious session file by sending a GET request with a specially crafted JSESSIONID cookie. These requests typically have specific characteristics, including a JSESSIONID cookie with a leading dot that matches a previously uploaded filename, and typically result in a HTTP 500 error when the exploitation succeeds.",Zscaler Proxy,"Initial Access, Persistence, Discovery","T1190, T1505.003","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_method=GET AND Web.cookie=""*JSESSIONID=.*"" AND Web.status=500 by Web.src, Web.dest, Web.http_user_agent, Web.uri_path, Web.cookie, Web.status 
| `drop_dm_object_name(""Web"")` 
| where match(cookie, ""^JSESSIONID=\."") 
| rex field=cookie ""JSESSIONID=\.(?<cookie_path>[^;]+)"" 
| eval severity=""High"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `tomcat_session_deserialization_attempt_filter`"
Tomcat Session File Upload Attempt,"This detection identifies potential exploitation of CVE-2025-24813 in Apache Tomcat through the initial stage of the attack. This first phase occurs when an attacker attempts to upload a malicious serialized Java object with a .session file extension via an HTTP PUT request. When successful, these uploads typically result in HTTP status codes 201 (Created) or 409 (Conflict) and create the foundation for subsequent deserialization attacks by placing malicious content in a location where Tomcat's session management can access it.",Zscaler Proxy,"Initial Access, Persistence","T1190, T1505.003","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.http_method=PUT AND Web.uri_path=""*.session"" AND (Web.status=201 OR Web.status=409) by Web.src, Web.dest, Web.http_user_agent, Web.uri_path, Web.status 
| `drop_dm_object_name(""Web"")` 
| rex field=uri_path ""/(?<filename>[^/]+)\.session$"" 
| eval severity=""High"" 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `tomcat_session_file_upload_attempt_filter`"
Unusually Long Content-Type Length,The following analytic identifies unusually long strings in the Content-Type HTTP header sent by the client to the server.,Zscaler Proxy,Discovery,,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web by Web.src Web.dest Web.url Web.http_user_agent Web.http_content_type 
| `drop_dm_object_name(""Web"")`  
| eval http_content_type_length = len(http_content_type)  
| where http_content_type_length > 100 
| table firstTime lastTime src dest http_content_type_length http_content_type url http_user_agent 
| `security_content_ctime(firstTime)`  
| `security_content_ctime(lastTime)`  
| `unusually_long_content_type_length_filter`"
VMWare Aria Operations Exploit Attempt,"The following analytic detects potential exploitation attempts against VMWare vRealize Network Insight, specifically targeting the CVE-2023-20887 vulnerability. It monitors web traffic for HTTP POST requests directed at the vulnerable endpoint &quot;/saas./resttosaasservlet.&quot; This detection leverages web traffic data, focusing on specific URL patterns and HTTP methods. Identifying this behavior is crucial for a SOC as it indicates an active exploit attempt.",Zscaler Proxy,"Initial Access, Lateral Movement, Persistence, Privilege Escalation, Discovery","T1190, T1068, T1210, T1133","| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""*/saas./resttosaasservlet*"")  Web.http_method=POST Web.status IN (""unknown"", ""200"") by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `vmware_aria_operations_exploit_attempt_filter`"
VMware Server Side Template Injection Hunt,"The following analytic identifies potential server-side template injection attempts related to CVE-2022-22954. It detects suspicious URL patterns containing &quot;deviceudid&quot; and keywords like &quot;java.lang.ProcessBuilder&quot; or &quot;freemarker.template.utility.ObjectConstructor&quot; using web or proxy logs within the Web Datamodel. This activity is significant as it may indicate an attempt to exploit a known vulnerability in VMware, potentially leading to remote code execution.",Zscaler Proxy,"Initial Access, Execution, Privilege Escalation","T1190, T1133","| tstats count from datamodel=Web where Web.http_method IN (""GET"") Web.url=""*deviceudid=*"" AND Web.url IN (""*java.lang.ProcessBuilder*"",""*freemarker.template.utility.ObjectConstructor*"") by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `vmware_server_side_template_injection_hunt_filter`"
VMware Workspace ONE Freemarker Server-side Template Injection,"The following analytic detects server-side template injection attempts related to CVE-2022-22954 in VMware Workspace ONE. It leverages web or proxy logs to identify HTTP GET requests to the endpoint catalog-portal/ui/oauth/verify with the freemarker.template.utility.Execute command. This activity is significant as it indicates potential exploitation attempts that could lead to remote code execution. If confirmed malicious, an attacker could execute arbitrary commands on the server, leading to full system compromise, data exfiltration, or further lateral movement within the network.",Zscaler Proxy,"Initial Access, Execution, Lateral Movement, Privilege Escalation, Exfiltration","T1190, T1133","| tstats count from datamodel=Web where Web.http_method IN (""GET"") Web.url=""*/catalog-portal/ui/oauth/verify?error=&deviceudid=*"" AND Web.url=""*freemarker.template.utility.Execute*"" by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `vmware_workspace_one_freemarker_server_side_template_injection_filter`"
Web JSP Request via URL,"The following analytic identifies URL requests associated with CVE-2022-22965 (Spring4Shell) exploitation attempts, specifically targeting webshell access on a remote webserver. It detects HTTP GET requests with URLs containing &quot;.jsp?cmd=&quot; or &quot;j&amp;cmd=&quot; patterns. This activity is significant as it indicates potential webshell deployment, which can lead to unauthorized remote command execution. If confirmed malicious, attackers could gain control over the webserver, execute arbitrary commands, and potentially escalate privileges, leading to severe data breaches and system compromise.",Zscaler Proxy,"Initial Access, Execution, Persistence","T1190, T1505.003, T1133","| tstats count from datamodel=Web where Web.http_method IN (""GET"") Web.url IN (""*.jsp?cmd=*"",""*j&cmd=*"") by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `web_jsp_request_via_url_filter`"
Web Spring4Shell HTTP Request Class Module,"The following analytic detects HTTP requests containing payloads related to the Spring4Shell vulnerability (CVE-2022-22965). It leverages Splunk Stream HTTP data to inspect the HTTP request body and form data for specific fields such as &quot;class.module.classLoader.resources.context.parent.pipeline.first&quot;. This activity is significant as it indicates an attempt to exploit a critical vulnerability in Spring Framework, potentially leading to remote code execution.",Splunk Stream,"Initial Access, Execution","T1190, T1133","`stream_http` http_method IN (""POST"") 
| stats values(form_data) as http_request_body min(_time) as firstTime max(_time) as lastTime count by src dest http_method http_user_agent uri_path url bytes_in bytes_out 
| search http_request_body IN (""*class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=_*"", ""*class.module.classLoader.resources.context.parent.pipeline.first.pattern*"",""*suffix=.jsp*"") 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `web_spring4shell_http_request_class_module_filter`"
Web Spring Cloud Function FunctionRouter,"The following analytic identifies HTTP POST requests to the Spring Cloud Function endpoint containing &quot;functionRouter&quot; in the URL. It leverages the Web data model to detect these requests based on specific fields such as http_method, url, and http_user_agent. This activity is significant because it targets CVE-2022-22963, a known vulnerability in Spring Cloud Function, which has multiple proof-of-concept exploits available.",Zscaler Proxy,"Initial Access, Exfiltration","T1190, T1133","| tstats count from datamodel=Web where Web.http_method IN (""POST"") Web.url=""*/functionRouter*"" by Web.http_user_agent Web.http_method, Web.url,Web.url_length Web.src, Web.dest Web.status sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `web_spring_cloud_function_functionrouter_filter`"
Windows Exchange Autodiscover SSRF Abuse,"This analytic identifies potential exploitation attempts of ProxyShell (CVE-2021-34473, CVE-2021-34523, CVE-2021-31207) and ProxyNotShell (CVE-2022-41040, CVE-2022-41082) vulnerabilities in Microsoft Exchange Server. The detection focuses on identifying the SSRF attack patterns used in these exploit chains. The analytic monitors for suspicious POST requests to /autodiscover/autodiscover.json endpoints that may indicate attempts to enumerate LegacyDN attributes as part of initial reconnaissance.",Zscaler Proxy,"Initial Access, Execution","T1190, T1133","| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.status=200) AND Web.http_method=POST by Web.src Web.status Web.uri_path Web.dest Web.http_method Web.uri_query Web.http_user_agent 
| `drop_dm_object_name(""Web"")` 
| eval is_autodiscover=if(like(lower(uri_path),""%autodiscover/autodiscover.json%""),1,0) 
| eval has_rps_cat=if(like(lower(uri_query),""%x-rps-cat=%""),1,0) 
| eval exchange_backend=if(like(lower(uri_query),""%/powershell/?%""),1,0) 
| eval mapi=if(like(uri_query,""%/mapi/%""),1,0) 
| eval suspicious_agent=if(match(lower(http_user_agent), ""python
|urllib""),1,0) 
| addtotals fieldname=Score is_autodiscover, has_rps_cat, exchange_backend, mapi, suspicious_agent 
| where Score >= 3 
| fields Score, src, dest, status, uri_query, uri_path, http_method, http_user_agent 
| `windows_exchange_autodiscover_ssrf_abuse_filter`"
Windows IIS Server PSWA Console Access,"This analytic detects access attempts to the PowerShell Web Access (PSWA) console on Windows IIS servers. It monitors web traffic for requests to PSWA-related URIs, which could indicate legitimate administrative activity or potential unauthorized access attempts. By tracking source IP, HTTP status, URI path, and HTTP method, it helps identify suspicious patterns or brute-force attacks targeting PSWA.",Zscaler Proxy,Initial Access,T1190,"| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.dest IN (""/pswa/*"") by Web.src Web.status Web.uri_path Web.dest Web.http_method Web.uri_query 
| `drop_dm_object_name(""Web"")`
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `windows_iis_server_pswa_console_access_filter`"
WS FTP Remote Code Execution,"The following analytic detects potential Remote Code Execution (RCE) attempts exploiting CVE-2023-40044 in WS_FTP software. It identifies HTTP POST requests to the &quot;/AHT/AhtApiService.asmx/AuthUser&quot; URL with a status code of 200. This detection leverages the Web datamodel to monitor specific URL patterns and HTTP status codes. This activity is significant as it may indicate an exploitation attempt, potentially allowing an attacker to execute arbitrary code on the server.",Zscaler Proxy,"Initial Access, Execution, Discovery, Exfiltration",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where Web.url IN (""/AHT/AhtApiService.asmx/AuthUser"") Web.status=200 Web.http_method=POST by Web.http_user_agent, Web.status Web.http_method, Web.url, Web.url_length, Web.src, Web.dest, sourcetype 
| `drop_dm_object_name(""Web"")` 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `ws_ftp_remote_code_execution_filter`"
Zscaler Adware Activities Threat Blocked,"The following analytic identifies potential adware activity blocked by Zscaler. It leverages web proxy logs to detect blocked actions associated with adware threats. Key data points such as device owner, user, URL category, destination URL, and IP are analyzed. This activity is significant as adware can degrade system performance, lead to unwanted advertisements, and potentially expose users to further malicious content.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname=*adware* 
| stats count min(_time) as firstTime max(_time) as lastTime  by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_adware_activities_threat_blocked_filter`"
Zscaler Behavior Analysis Threat Blocked,"The following analytic identifies threats blocked by the Zscaler proxy based on behavior analysis. It leverages web proxy logs to detect entries where actions are blocked and threat names and classes are specified. This detection is significant as it highlights potential malicious activities that were intercepted by Zscaler's behavior analysis, providing early indicators of threats.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname!=""None"" threatclass=""Behavior Analysis"" 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user threatname url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_behavior_analysis_threat_blocked_filter`"
Zscaler CryptoMiner Downloaded Threat Blocked,"The following analytic identifies attempts to download cryptomining software that are blocked by Zscaler. It leverages web proxy logs to detect blocked actions associated with cryptominer threats, analyzing key data points such as device owner, user, URL category, destination URL, and IP. This activity is significant for a SOC as it helps in early identification and mitigation of cryptomining activities, which can compromise network integrity and resource availability.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname=*miner* 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_cryptominer_downloaded_threat_blocked_filter`"
Zscaler Employment Search Web Activity,"The following analytic identifies web activity related to employment searches within a network. It leverages Zscaler web proxy logs, focusing on entries categorized as 'Job/Employment Search'. Key data points such as device owner, user, URL category, destination URL, and IP are analyzed. This detection is significant for SOCs as it helps monitor potential insider threats by identifying users who may be seeking new employment.",Zscaler Proxy,"Initial Access, Exfiltration",T1566,"`zscaler_proxy` urlsupercategory=""Job/Employment Search"" 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_employment_search_web_activity_filter`"
Zscaler Exploit Threat Blocked,"The following analytic identifies potential exploit attempts involving command and script interpreters blocked by Zscaler. It leverages web proxy logs to detect incidents where actions are blocked due to exploit references. The detection compiles statistics by user, threat name, URL, hostname, file class, and filename. This activity is significant as it helps identify and mitigate exploit attempts, which are critical for maintaining security.",Zscaler Proxy,"Initial Access, Execution, Privilege Escalation",T1566,"`zscaler_proxy` action=blocked threatname=*exploit* 
| stats count min(_time) as firstTime max(_time) as lastTime  by user threatname src hostname fileclass filename url dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_exploit_threat_blocked_filter`"
Zscaler Legal Liability Threat Blocked,"The following analytic identifies significant legal liability threats blocked by the Zscaler web proxy. It uses web proxy logs to track destinations, device owners, users, URL categories, and actions associated with legal liability. By leveraging statistics on unique fields, it ensures a precise focus on these threats. This activity is significant for SOC as it helps enforce legal compliance and risk management.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` urlclass=""Legal Liability"" 
|  stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| dedup urlcategory 
| `zscaler_legal_liability_threat_blocked_filter`"
Zscaler Malware Activity Threat Blocked,"The following analytic identifies potential malware activities within a network that are blocked by Zscaler. It leverages web proxy logs to filter for blocked actions associated with malware, aggregating occurrences by user, URL, and threat category. This detection is significant for SOC as it highlights attempts to access malicious content, indicating potential compromise or targeted attacks.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname=*malware* threatcategory!=None 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_malware_activity_threat_blocked_filter`"
Zscaler Potentially Abused File Download,"The following analytic identifies the download of potentially malicious file types, such as .scr, .dll, .bat, and .lnk, within a network. It leverages web proxy logs from Zscaler, focusing on blocked actions and analyzing fields like deviceowner, user, urlcategory, url, dest, and filename. This activity is significant as these file types are often used to spread malware, posing a threat to network security.",Zscaler Proxy,"Initial Access, Execution",T1566,"`zscaler_proxy` url IN (""*.scr"", ""*.dll"", ""*.bat"", ""*.lnk"") 
| stats count min(_time) as firstTime max(_time) as lastTime by deviceowner user urlcategory url src filename dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_potentially_abused_file_download_filter`"
Zscaler Privacy Risk Destinations Threat Blocked,"The following analytic identifies blocked destinations within a network that are deemed privacy risks by Zscaler. It leverages web proxy logs, focusing on entries marked as &quot;Privacy Risk.&quot; Key data points such as device owner, user, URL category, destination URL, and IP are analyzed. This activity is significant for a SOC as it helps monitor and manage privacy risks, ensuring a secure network environment.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked urlclass=""Privacy Risk"" 
|  stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| dedup urlcategory 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_privacy_risk_destinations_threat_blocked_filter`"
Zscaler Scam Destinations Threat Blocked,"The following analytic identifies blocked scam-related activities detected by Zscaler within a network. It leverages web proxy logs to examine actions flagged as scam threats, focusing on data points such as device owner, user, URL category, destination URL, and IP. This detection is significant for SOC as it helps in the early identification and mitigation of scam activities, ensuring network safety.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname=*scam* 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_scam_destinations_threat_blocked_filter`"
Zscaler Virus Download threat blocked,"The following analytic identifies attempts to download viruses that were blocked by Zscaler within a network. It leverages web proxy logs to detect blocked actions indicative of virus download attempts. Key data points such as device owner, user, URL category, destination URL, and IP are analyzed. This activity is significant as it helps in early detection and remediation of potential virus threats, enhancing network security.",Zscaler Proxy,Initial Access,T1566,"`zscaler_proxy` action=blocked threatname!=""None"" threatclass=Virus 
| stats count min(_time) as firstTime max(_time) as lastTime by action deviceowner user urlcategory url src dest 
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `zscaler_virus_download_threat_blocked_filter`"
Citrix ADC and Gateway CitrixBleed 2 Memory Disclosure,"This detection identifies potential exploitation attempts of CVE-2025-5777 (CitrixBleed 2), a memory disclosure vulnerability in Citrix NetScaler ADC and Gateway. The vulnerability is triggered by sending POST requests with incomplete form data to the /p/u/doAuthentication.do endpoint, causing the device to leak memory contents including session tokens and authentication materials. This search looks for POST requests to the vulnerable endpoint that may indicate scanning or exploitation attempts.",Zscaler Proxy,"Initial Access, Discovery",T1190,"| tstats count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where
Web.url IN (""*/p/u/doAuthentication.do*"")
Web.http_method=""POST""
Web.status=200
by Web.http_user_agent, Web.status, Web.http_method,
Web.url, Web.url_length, Web.src, Web.dest, sourcetype
| `drop_dm_object_name(""Web"")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| `citrix_adc_and_gateway_citrixbleed_2_memory_disclosure_filter`"
